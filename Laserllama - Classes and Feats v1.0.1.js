/*  -WHAT IS THIS?-
    This file adds optional material to "MPMB's Character Record Sheet" found at https://www.flapkan.com/download#charactersheets
    Import this file using the "Add Extra Materials" bookmark.

    -KEEP IN MIND-
    It is recommended to enter the code in a fresh sheet before adding any other information (i.e. before making your character with it).
    This script requires importing the Common attributes first!
	
    -INFORMATION-
    Subject:    Classes and Feats Part 1 (Martials, Warlord, and Psion and their feat)

    Effect:     This script adds the Classes (and the Alternate versions) published by Laserllama in GM Binder under the Fan Content policy.
                By the links below are listed the classes added by this file
                REMINDER: The content in the links below may vary from what scripted in this file 'cause it may be changed with a new version release
        
            Laserllama GM Binder Profile: https://www.gmbinder.com/profile/laserllama
            Alternate Barbarian (Version 2.1.1): https://www.gmbinder.com/share/-N2gn3QXALCVqwAFJe5v
            Alternate Barbarian expanded (Version 2.1.1): https://www.gmbinder.com/share/-N7MhiHnBhzmgxFtkzBO
            Alternate Fighter (Version 4.3.1): https://www.gmbinder.com/share/-MSfA82gv8V69JAoqFVq
            Alternate Fighter expanded (Version 4.3.1): https://www.gmbinder.com/share/-MUkP55cdNMTFYMKlDUL
            Alternate Ranger (Version 4.2.0): https://www.gmbinder.com/share/-M7iu19Af89SH2G_5RGa
            Alternate Ranger expanded (Version 4.2.0): https://www.gmbinder.com/share/-MW4c30CbGMWLRNgJxgb
            Alternate Rogue (Version 2.2.1): https://www.gmbinder.com/share/-N8o6KduyOA2qhUGBQqA
            Alternate Rogue expanded (Version 2.2.1): https://www.gmbinder.com/share/-NJ8-9uVQcpeQLxLx5RS
            Warlord Class (Version 3.2.2): https://www.gmbinder.com/share/-MSfA82gv8V69JAoqFVq
            Warlord Class expanded (Version 3.2.2): https://www.gmbinder.com/share/-MUkP55cdNMTFYMKlDUL
            Psion Class (Version 2.3.0): https://www.gmbinder.com/share/-MPkCSxSj0OETiEd3Pyf


    Sheet:      v13.0.06 and newer
 
    Code by:    Original script by Valentino dell'Eco and CalypsoMoonlace
*/

// Meta information
var iFileName = "LaserLlama - Classes and Feats v1.1.0.js";
RequiredSheetVersion("13.0.6");

// Check that exploits are properly imported
try {
  var test = SpellsList["parry"].isExploit;
} catch (error) {
  throw new Error(
    "Please import the 'Laserllama - Common attributes_20251110.js' file before importing this file as otherwise it cannot function properly. You can get it on the github repository."
  );
}

// Edit official ranger regex to avoid conflict with laserllama ranger
if (ClassList["ranger"]) {
  ClassList["ranger"].regExpSearch = /^(?=.*ranger)(?!.*laserllama).*$/i;
}


[
  // 1st level 
  "absorb elements", "alarm", "animal friendship", "beast bond", "cure wounds", "detect magic",
  "detect poison and disease", "ensnaring strike", "entangle", "expeditious retreat", "fog cloud",
  "goodberry", "hail of thorns", "jump", "longstrider", "purify food and drink", "snare",
  "speak with animals", "zephyr strike",
  // 2nd level
  "aid", "animal messenger", "barkskin", "beast sense", "conjure beast", "continual flame",
  "cordon of arrows", "darkvision", "enhance ability", "find traps", "gust of wind",
  "healing spirit", "locate creature", "magic weapon", "pass without trace", "protection from poison",
  "restoration", "silence", "spike growth",
  // 3rd level
  "conjure elemental", "conjure fey", "conjure volley", "daylight", "dispel magic", "elemental weapon",
  "flame arrows", "grasping vine", "lightning arrow", "meld into stone", "nondetection",
  "plant growth", "revivify", "speak with plants", "leomund's tiny hut", "water breathing",
  "water walk", "wind wall",
  // 4th level
  "death ward", "divination", "dominate beast", "freedom of movement", "guardian of nature",
  "stoneskin",
  // 5th level
  "awaken", "commune with nature", "contagion", "steel wind strike", "swift quiver", "tree stride",
  "wrath of nature",
].forEach(function (s) { if (SpellsList[s] && SpellsList[s].classes && SpellsList[s].classes.indexOf("ranger(laserllama)") === -1) SpellsList[s].classes.push("ranger(laserllama)"); });
var PsionList = [
  // cantrips
  "blade ward",
  "friends",
  "guidance",
  "light",
  "mage hand",
  "magic stone",
  "message",
  "mind sliver",
  "mind thrust",
  "minor illusion",
  "mystic hammer",
  "psionic strike",
  "spare the dying",
  "sword burst",
  "thaumaturgy",
  "toll the dead",
  "true strike",

  // 1st level
  "catapult",
  "cause fear",
  "charm person",
  "command",
  "comprehend languages",
  "detect magic",
  "disguise self",
  "dissonant whispers",
  "ethereal anchor",
  "faerie fire",
  "tasha's hideous laughter",
  "id insinuation",
  "identify",
  "jump",
  "magic missile",
  "shield",
  "sleep",

  // 2nd level
  "blindness/deafness",
  "blur",
  "calm emotions",
  "crown of madness",
  "detect thoughts",
  "enlarge/reduce",
  "hold person",
  "invisibility",
  "levitate",
  "locate creature",
  "mind spike",
  "tasha's mind whip",
  "mirror image",
  "misty step",
  "mystic spear",
  "phantasmal force",
  "see invisibility",
  "suggestion",

  // 3rd level
  "blink",
  "cerebral blast",
  "clairvoyance",
  "enemies abound",
  "fear",
  "feign death",
  "fly",
  "haste",
  "hypnotic pattern",
  "intellect fortress",
  "life transference",
  "major image",
  "nondetection",
  "sending",
  "slow",
  "spectral passage",
  "tongues",
  "water walk",

  // 4th level
  "arcane eye",
  "charm monster",
  "compulsion",
  "confusion",
  "dimension door",
  "ego scourge",
  "freedom of movement",
  "greater invisibility",
  "phantasmal killer",
  "otiluke's resilient sphere",

  // 5th level
  "bigby's hand",
  "dominate person",
  "dream",
  "far step",
  "geas",
  "hold monster",
  "modify memory",
  "psychic crush",
  "scrying",
  "skill empowerment",
  "synaptic static",
  "telekinesis",
  "rary's telepathic bond",
  "wall of force",

  // 6th level
  "arcane gate",
  "eyebite",
  "globe of invulnerability",
  "mass suggestion",
  "mental prison",
  "psionic oppression",
  "scatter",
  "true seeing",

  // 7th level
  "etherealness",
  "forcecage",
  "plane shift",
  "project image",
  "reverse gravity",
  "sequester",
  "teleport",

  // 8th level
  "antimagic field",
  "antipathy/sympathy",
  "dominate monster",
  "feeblemind",
  "maddening darkness",
  "mind blank",
  "telepathy",

  // 9th level
  "astral projection",
  "foresight",
  "invulnerability",
  "psychic scream",
  "time stop",
  "weird"
];

for (var p = 0; p < PsionList.length; p++) {
  try {
    SpellsList[PsionList[p]].classes.push("psion(laserllama)");
  } catch (error) {
    throw new Error(PsionList[p]);
  }
}

// Edit official fighter regex to avoid conflict with astral warrior monk
if (ClassList["fighter"]) {
  ClassList["fighter"].regExpSearch = /^(?!.*(feral|tribal|dark|green|fey|horned|totem|spiritual|exalted|sacred|holy|divine|nature|odin|thor|nature|natural|green|beast|animal))(?=.*(fighter|militant|warlord|phalanx|gladiator|trooper)).*$/i
};

if (ClassSubList.paladin && ClassSubList.paladin["oath of vengeance"]) {
    ClassSubList.paladin["oath of vengeance"].regExpSearch = /^(((?=.*(vengeance|wrath|justice))((?=.*paladin)|((?=.*(exalted|sacred|holy|divine))(?=.*(knight|fighter|warrior|warlord|trooper)))))|((?=.*dark)(?=.*knight))).*$/i;
}
// Utility functions
function CreateMartialSpellsheet() {
  // This function is called by different eval attributes and is required before EACH USE OF spellcastingBonusElsewhere
  // The reason for that is an edge case: if the player has the sheet created by picking exploits, then removes those picks, the spellsheet is entirely removed

  // Defining the Fighter spell sheet - also known as Martial exploits
  if (!CurrentSpells["martial exploits"]) {
    CurrentSpells["martial exploits"] = {
      name: "Martial Exploits",
      shortname: "Martial Exploits",
      ability: 1,
      bonus: {},
      typeSp: "known",
      refType: "feat",
    };
  }
}
function CreateSavageSpellsheet() {
  // This function is called by different eval attributes and is required before EACH USE OF spellcastingBonusElsewhere
  // The reason for that is an edge case: if the player has the sheet created by picking exploits, then removes those picks, the spellsheet is entirely removed

  // Defining the Barbarian spell sheet - also known as Savage exploits
  if (!CurrentSpells["savage exploits"]) {
    CurrentSpells["savage exploits"] = {
      name: "Savage Exploits",
      shortname: "Savage Exploits",
      ability: 1,
      bonus: {},
      typeSp: "known",
      refType: "feat",
    };
  }
}
function CreateDeviousSpellsheet() {
  // This function is called by different eval attributes and is required before EACH USE OF spellcastingBonusElsewhere
  // The reason for that is an edge case: if the player has the sheet created by picking exploits, then removes those picks, the spellsheet is entirely removed

  // Defining the Rogue spell sheet - also known as Devious exploits
  if (!CurrentSpells["devious exploits"]) {
    CurrentSpells["devious exploits"] = {
      name: "Devious Exploits",
      shortname: "Devious Exploits",
      ability: 2,
      bonus: {},
      typeSp: "known",
      refType: "feat",
    };
  }
}
function CreateTacticalSpellsheet() {
  // This function is called by different eval attributes and is required before EACH USE OF spellcastingBonusElsewhere
  // The reason for that is an edge case: if the player has the sheet created by picking exploits, then removes those picks, the spellsheet is entirely removed

  // Defining the Warlord spell sheet - also known as Martial exploits
  if (!CurrentSpells["tactical exploits"]) {
    CurrentSpells["tactical exploits"] = {
      name: "Tactical Exploits",
      shortname: "Tactical Exploits",
      ability: 1,
      bonus: {},
      typeSp: "known",
      refType: "feat",
    };
  }
}

function GetSubclassTechniques(subclass_name, techniques_list) {
  /* pre: subclass_name is a string
      techniques_list is an array of length 3
      1st technique is unlocked at lvl 3
      2nd technique is unlocked at lvl 5
      3rd technique is unlocked at lvl 9

    post: returns the subclassfeature that contains all the subclass techniques
  */

  // Create subclassfeature
  // app.alert("Create subclassfeature: " + subclass_name);
  const SubclassTechniques = {
    name: subclass_name + " Techniques",
    source: [["GMB:LL", 0]],
    minlevel: 3,
    description: desc(["I learn additional Techniques who don't count against my total and can't be switched"]),
    autoSelectExtrachoices: [{
      extrachoice: techniques_list[0],
      minlevel: 3
    }, {
      extrachoice: techniques_list[1],
      minlevel: 5
    }, {
      extrachoice: techniques_list[2],
      minlevel: 9
    }]
  };

  // app.alert("Copy techniques from the main class");
  // Copy techniques from the main class
  SubclassTechniques[techniques_list[0]] = newObj(ClassList["monk(laserllama)"].features["mystic techniques"][techniques_list[0]]);
  SubclassTechniques[techniques_list[1]] = newObj(ClassList["monk(laserllama)"].features["mystic techniques"][techniques_list[1]]);
  SubclassTechniques[techniques_list[2]] = newObj(ClassList["monk(laserllama)"].features["mystic techniques"][techniques_list[2]]);

  return SubclassTechniques;
}
function GetFighterSubclassExploits(subclass_name, exploit_list) {
  /* pre: subclass_name is a string
      exploit_list is an array of length 5
      1st and 2nd elements are the 1st degree exploits
      3rd and 4th elements are the 2nd degree exploits
      5th element is the 3rd degree exploit

    post: returns the subclassfeature that contains all the subclass exploits

    note: All exploits have to first be defined through SpellsList, otherwise it *will* crash
  */
  SubclassExploits = {
    name: subclass_name + " Exploits",
    source: [["GMB:LL", 0]],
    minlevel: 3,
    description: desc([
      "I learn additional Exploits who don't count against my total and can't be switched",
    ]),
    toNotesPage: [
      {
        name: subclass_name + " Exploits",
        note: desc([
          "Below are my " +
          subclass_name +
          " exploits. The 3rd level exploit can only be used per short rest.",
        ]),
      },
    ],
    autoSelectExtrachoices: [
      {
        extrachoice: exploit_list[0],
        minlevel: 3,
      },
      {
        extrachoice: exploit_list[1],
        minlevel: 3,
      },
      {
        extrachoice: exploit_list[2],
        minlevel: 5,
      },
      {
        extrachoice: exploit_list[3],
        minlevel: 5,
      },
      {
        extrachoice: exploit_list[4],
        minlevel: 9,
      },
    ],
  };

  for (var i = 0; i < SubclassExploits.autoSelectExtrachoices.length; i++) {
    var NewSpellKey = SubclassExploits.autoSelectExtrachoices[i].extrachoice;

    SubclassExploits[NewSpellKey] = {
      name: SpellsList[NewSpellKey].name,
      toNotesPage: [
        {
          // What is added to the notes page
          name:
            SpellsList[NewSpellKey].name +
            " Exploit [" +
            (SpellsList[NewSpellKey].level == 1
              ? "1st"
              : SpellsList[NewSpellKey].level == 2
                ? "2nd"
                : SpellsList[NewSpellKey].level == 3
                  ? "3rd"
                  : SpellsList[NewSpellKey].level + "th") +
            " degree]",
          note: desc(SpellsList[NewSpellKey].descriptionFull),
          amendTo: SubclassExploits.name,
        },
      ],
      source: SpellsList[NewSpellKey].source,
      addMod: SpellsList[NewSpellKey].addMod,
      submenu: SpellsList[NewSpellKey].submenu,
      eval: CreateMartialSpellsheet,
      spellcastingBonusElsewhere: {
        addTo: "martial exploits",
        spellcastingBonus: {
          name: subclass_name + " Exploits",
          spellcastingAbility: 1,
          spells: [NewSpellKey],
          selection: [NewSpellKey],
          //prepared : true // enabling this puts a star on the column, which, while it is cool, is incompatible with stuff that edits it to "at will"
        },
      },
    };
  }

  return SubclassExploits;
}
function GetBarbarianSubclassExploits(subclass_name, exploit_list) {
  /* pre: subclass_name is a string
      exploit_list is an array of length 5
      1st and 2nd elements are the 1st degree exploits
      3rd and 4th elements are the 2nd degree exploits
      5th element is the 3rd degree exploit

    post: returns the subclassfeature that contains all the subclass exploits

    note: All exploits have to first be defined through SpellsList, otherwise it *will* crash
  */
  SubclassExploits = {
    name: subclass_name + " Exploits",
    source: [["GMB:LL", 0]],
    minlevel: 3,
    description: desc([
      "I learn additional Exploits who don't count against my total and can't be switched",
    ]),
    toNotesPage: [
      {
        name: subclass_name + " Exploits",
        note: desc([
          "Below are my " +
          subclass_name +
          " exploits. The 3rd level exploit can only be used per short rest.",
        ]),
      },
    ],
    autoSelectExtrachoices: [
      {
        extrachoice: exploit_list[0],
        minlevel: 3,
      },
      {
        extrachoice: exploit_list[1],
        minlevel: 3,
      },
      {
        extrachoice: exploit_list[2],
        minlevel: 5,
      },
      {
        extrachoice: exploit_list[3],
        minlevel: 5,
      },
      {
        extrachoice: exploit_list[4],
        minlevel: 9,
      },
    ],
  };

  for (var i = 0; i < SubclassExploits.autoSelectExtrachoices.length; i++) {
    var NewSpellKey = SubclassExploits.autoSelectExtrachoices[i].extrachoice;

    SubclassExploits[NewSpellKey] = {
      name: SpellsList[NewSpellKey].name,
      toNotesPage: [
        {
          // What is added to the notes page
          name:
            SpellsList[NewSpellKey].name +
            " Exploit [" +
            (SpellsList[NewSpellKey].level == 1
              ? "1st"
              : SpellsList[NewSpellKey].level == 2
                ? "2nd"
                : SpellsList[NewSpellKey].level == 3
                  ? "3rd"
                  : SpellsList[NewSpellKey].level + "th") +
            " degree]",
          note: desc(SpellsList[NewSpellKey].descriptionFull),
          amendTo: SubclassExploits.name,
        },
      ],
      source: SpellsList[NewSpellKey].source,
      addMod: SpellsList[NewSpellKey].addMod,
      submenu: SpellsList[NewSpellKey].submenu,
      eval: CreateSavageSpellsheet,
      spellcastingBonusElsewhere: {
        addTo: "savage exploits",
        spellcastingBonus: {
          name: subclass_name + " Exploits",
          spellcastingAbility: 1,
          spells: [NewSpellKey],
          selection: [NewSpellKey],
          //prepared : true // enabling this puts a star on the column, which, while it is cool, is incompatible with stuff that edits it to "at will"
        },
      },
    };
  }

  return SubclassExploits;
}
function GetRogueSubclassExploits(subclass_name, exploit_list) {
  /* pre: subclass_name is a string
      exploit_list is an array of length 5
      1st and 2nd elements are the 1st degree exploits
      3rd and 4th elements are the 2nd degree exploits
      5th element is the 3rd degree exploit

    post: returns the subclassfeature that contains all the subclass exploits

    note: All exploits have to first be defined through SpellsList, otherwise it *will* crash
  */
  SubclassExploits = {
    name: subclass_name + " Exploits",
    source: [["GMB:LL", 0]],
    minlevel: 3,
    description: desc([
      "I learn additional Exploits who don't count against my total and can't be switched",
    ]),
    toNotesPage: [
      {
        name: subclass_name + " Exploits",
        note: desc([
          "Below are my " +
          subclass_name +
          " exploits. The 3rd level exploit can only be used per short rest.",
        ]),
      },
    ],
    autoSelectExtrachoices: [
      {
        extrachoice: exploit_list[0],
        minlevel: 3,
      },
      {
        extrachoice: exploit_list[1],
        minlevel: 3,
      },
      {
        extrachoice: exploit_list[2],
        minlevel: 5,
      },
      {
        extrachoice: exploit_list[3],
        minlevel: 5,
      },
      {
        extrachoice: exploit_list[4],
        minlevel: 9,
      },
    ],
  };

  for (var i = 0; i < SubclassExploits.autoSelectExtrachoices.length; i++) {
    var NewSpellKey = SubclassExploits.autoSelectExtrachoices[i].extrachoice;

    SubclassExploits[NewSpellKey] = {
      name: SpellsList[NewSpellKey].name,
      toNotesPage: [
        {
          // What is added to the notes page
          name:
            SpellsList[NewSpellKey].name +
            " Exploit [" +
            (SpellsList[NewSpellKey].level == 1
              ? "1st"
              : SpellsList[NewSpellKey].level == 2
                ? "2nd"
                : SpellsList[NewSpellKey].level == 3
                  ? "3rd"
                  : SpellsList[NewSpellKey].level + "th") +
            " degree]",
          note: desc(SpellsList[NewSpellKey].descriptionFull),
          amendTo: SubclassExploits.name,
        },
      ],
      source: SpellsList[NewSpellKey].source,
      addMod: SpellsList[NewSpellKey].addMod,
      submenu: SpellsList[NewSpellKey].submenu,
      eval: CreateDeviousSpellsheet,
      spellcastingBonusElsewhere: {
        addTo: "devious exploits",
        spellcastingBonus: {
          name: subclass_name + " Exploits",
          spellcastingAbility: 1,
          spells: [NewSpellKey],
          selection: [NewSpellKey],
          //prepared : true // enabling this puts a star on the column, which, while it is cool, is incompatible with stuff that edits it to "at will"
        },
      },
    };
  }

  return SubclassExploits;
}
function GetWarlordSubclassExploits(subclass_name, exploit_list) {
  /* pre: subclass_name is a string
      exploit_list is an array of length 5
      1st and 2nd elements are the 1st degree exploits
      3rd and 4th elements are the 2nd degree exploits
      5th element is the 3rd degree exploit

    post: returns the subclassfeature that contains all the subclass exploits

    note: All exploits have to first be defined through SpellsList, otherwise it *will* crash
  */
  SubclassExploits = {
    name: subclass_name + " Exploits",
    source: [["GMB:LL", 0]],
    minlevel: 3,
    description: desc([
      "I learn additional Exploits who don't count against my total and can't be switched",
    ]),
    toNotesPage: [
      {
        name: subclass_name + " Exploits",
        note: desc([
          "Below are my " +
          subclass_name +
          " exploits. The 3rd level exploit can only be used per short rest.",
        ]),
      },
    ],
    autoSelectExtrachoices: [
      {
        extrachoice: exploit_list[0],
        minlevel: 3,
      },
      {
        extrachoice: exploit_list[1],
        minlevel: 3,
      },
      {
        extrachoice: exploit_list[2],
        minlevel: 5,
      },
      {
        extrachoice: exploit_list[3],
        minlevel: 5,
      },
      {
        extrachoice: exploit_list[4],
        minlevel: 9,
      },
    ],
  };

  for (var i = 0; i < SubclassExploits.autoSelectExtrachoices.length; i++) {
    var NewSpellKey = SubclassExploits.autoSelectExtrachoices[i].extrachoice;

    SubclassExploits[NewSpellKey] = {
      name: SpellsList[NewSpellKey].name,
      toNotesPage: [
        {
          // What is added to the notes page
          name:
            SpellsList[NewSpellKey].name +
            " Exploit [" +
            (SpellsList[NewSpellKey].level == 1
              ? "1st"
              : SpellsList[NewSpellKey].level == 2
                ? "2nd"
                : SpellsList[NewSpellKey].level == 3
                  ? "3rd"
                  : SpellsList[NewSpellKey].level + "th") +
            " degree]",
          note: desc(SpellsList[NewSpellKey].descriptionFull),
          amendTo: SubclassExploits.name,
        },
      ],
      source: SpellsList[NewSpellKey].source,
      addMod: SpellsList[NewSpellKey].addMod,
      submenu: SpellsList[NewSpellKey].submenu,
      eval: CreateTacticalSpellsheet,
      spellcastingBonusElsewhere: {
        addTo: "tactical exploits",
        spellcastingBonus: {
          name: subclass_name + " Exploits",
          spellcastingAbility: 1,
          spells: [NewSpellKey],
          selection: [NewSpellKey],
          //prepared : true // enabling this puts a star on the column, which, while it is cool, is incompatible with stuff that edits it to "at will"
        },
      },
    };
  }

  return SubclassExploits;
}

function ExploitPrereqFactory(tempSpell, class_name) {
  // pre: tempSpell is the key of an item from SpellsList, class_name is a class name (daring today aren't we) eg "fighter(laserllama)"
  // post: returns a prereqeval() function

  // spell has its own prereq
  if (SpellsList[tempSpell].prereqeval) {
    return function (v) {
      const DegreeToMinLevel = [0, 0, 5, 9, 13, 17];
      return (
        classes.known[class_name].level >=
        DegreeToMinLevel[SpellsList[tempSpell].level] &&
        SpellsList[tempSpell].prereqeval(v)
      );
    };
  }

  return function (v) {
    const DegreeToMinLevel = [0, 0, 5, 9, 13, 17];
    return (
      classes.known[class_name].level >=
      DegreeToMinLevel[SpellsList[tempSpell].level]
    );
  };
}
function ExploitPrereqFactoryBountyHunter(tempSpell, class_name) {
  // pre: tempSpell is the key of an item from SpellsList, class_name is a class name (daring today aren't we) eg "fighter(laserllama)"
  // post: returns a prereqeval() function

  // spell has its own prereq
  if (SpellsList[tempSpell].prereqeval) {
    return function (v) {
      const DegreeToMinLevel = [0, 0, 7, 15];
      return (
        classes.known[class_name].level >=
        DegreeToMinLevel[SpellsList[tempSpell].level] &&
        SpellsList[tempSpell].prereqeval(v)
      );
    };
  }

  return function (v) {
    const DegreeToMinLevel = [0, 0, 7, 15];
    return (
      classes.known[class_name].level >=
      DegreeToMinLevel[SpellsList[tempSpell].level]
    );
  };
}
function ExploitPrereqFactoryReaver(tempSpell, class_name) {
  // NOTE: Same as ExploitPrereqFactory but for the Reaver subclass with an additional check for barb lvl > 3

  // spell has its own prereq
  if (SpellsList[tempSpell].prereqeval) {
    return function (v) {
      const DegreeToMinLevel = [0, 0, 5, 9, 13, 17];
      return (
        classes.known[class_name].level >=
        DegreeToMinLevel[SpellsList[tempSpell].level] &&
        classes.known[class_name].level >= 3 &&
        SpellsList[tempSpell].prereqeval(v)
      );
    };
  }

  return function (v) {
    const DegreeToMinLevel = [0, 0, 5, 9, 13, 17];
    return (
      classes.known[class_name].level >=
      DegreeToMinLevel[SpellsList[tempSpell].level] &&
      classes.known[class_name].level >= 3
    );
  };
}
function ExploitPrereqFactoryBrawler(tempSpell, class_name) {
  // pre: tempSpell is the key of an item from SpellsList, class_name is a class name (daring today aren't we) eg "monk(laserllama)"
  // post: returns a prereqeval() function

  // spell has its own prereq
  if (SpellsList[tempSpell].prereqeval) {
    return function (v) {
      const DegreeToMinLevel = [0, 3, 7, 15];
      return (classes.known[class_name].level >= DegreeToMinLevel[SpellsList[tempSpell].level]) && SpellsList[tempSpell].prereqeval(v);
    }
  }

  return function (v) {
    const DegreeToMinLevel = [0, 3, 7, 15];
    return classes.known[class_name].level >= DegreeToMinLevel[SpellsList[tempSpell].level];
  }

}

function MysticTalentsPrereqFactory(tempTalent, class_name, minLevel) {
  // pre: tempTalent is the key of an item from MysticTalentsLL, class_name is a class name (daring today aren't we) eg "monk(laserllama)"
  // post: returns a prereqeval() function
  if (!classes.known[class_name]) return;
  const tlvl = MysticTalentsLL[tempTalent].talentLevel ? MysticTalentsLL[tempTalent].talentLevel : minLevel;
  // spell has its own prereq

  if (MysticTalentsLL[tempTalent] && MysticTalentsLL[tempTalent].prereqeval) {
    return function (v) {
      return (classes.known[class_name].level >= tlvl) && MysticTalentsLL[tempTalent].prereqeval(v);
    }
  }

  return function (v) {
    return classes.known[class_name].level >= tlvl;
  }

}

// Alternate Barbarian class
ClassList["barbarian(laserllama)"] = {
  name: "Barbarian(LaserLlama)",
  regExpSearch: /^(?=.*barbarian)(?=.*laserllama).*$/i,
  source: ["GMB:LL", 0],
  primaryAbility: "Strength",
  prereqs: "Strength 13",
  die: 12,
  improvements: [0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 5, 5],
  saves: ["Str", "Con"],
  skillstxt: {
    primary:
      "Choose two from Animal Handling, Athletics, Intimidation, Nature, Perception, and Survival.",
  },
  armorProfs: {
    // the 4 entries are for: ["light", "medium", "heavy", "shields"]
    primary: [true, true, false, true], // the armor proficiencies if this is the first or only class
    secondary: [false, false, false, true], // the armor proficiencies if this class is multiclassed with (so not taken at level 1, but later)
  },
  weaponProfs: {
    primary: [true, true],
    secondary: [true, true],
  },
  equipment:
    "Barbarian starting equipment:" +
    "\n \u2022 greataxe -or- greatsword -or- maul;" +
    "\n \u2022 two handaxes -or- any simple weapon;" +
    "\n \u2022 hide armor -or- leather armor;" +
    "\n \u2022 a dagger, an explorer's pack, and four javelins;" +
    "\n\nAlternatively, choose 2d4 x 10 gp worth of starting equipment instead of both the class' and the background's starting equipment.",
  subclasses: ["Primal Path", []],
  attacks: [1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
  abilitySave: 1, // Alt Barbarian uses Strength or Dex for foes' saving throws
  abilitySaveAlt: 2,
  spellcastingFactor: "warlock99", // Required for the "create a complete spell sheet" option; using the warlock option ensures it doesn't clash with multiclassing
  features: {
    rage: {
      name: "Rage",
      source: [["GMB:LL", 0]],
      minlevel: 1,
      description: levels.map(function (n) {
        if (n < 2) {
          return desc([
            "Start as bonus action; bonus damage to weapon attacks using Str; can last up to 10 min",
            "I regain one use per short rest and all uses per long rest",
            "Adv. on Con checks, Str checks/saves (not attacks); resistance to bludg/piercing/slashing",
            "Bonus damage equal to d4",
            "I cannot cast spells or concentrate on spells or effects",
            "Lasts until the end of my next turn unless I extend it by doing one of the following before:",
            "Attack a creature, make a Strength check, take damage, or use my bonus action to extend it",
          ]);
        }

        if (n < 7) {
          return desc([
            "Start as bonus action; bonus damage to weapon attacks using Str; can last up to 10 min",
            "I regain one use per short rest and all uses per long rest",
            "Adv. on Con checks, Str checks/saves (not attacks); resistance to bludg/piercing/slashing",
            "Bonus damage equal to my Exploit Die",
            "I cannot cast spells or concentrate on spells or effects",
            "Lasts until the end of my next turn unless I extend it by doing one of the following before:",
            "Attack a creature, make a Strength check, take damage, or use my bonus action to extend it",
          ]);
        }

        if (n < 15) {
          return desc([
            "Start as bonus action; bonus damage to weapon attacks using Str; can last up to 10 min",
            "I regain one use per short rest and all uses per long rest",
            "Adv. on Con checks, Str checks/saves (not attacks); resistance to bludg/piercing/slashing",
            "Bonus damage equal to my Exploit Die",
            "I cannot cast spells or concentrate on spells or effects",
            "Stops early if I choose to end it or fall unconscious",
          ]);
        }
        if (n < 20) {
          return desc([
            "Start as bonus action; bonus damage to weapon attacks using Str; can last up to 1 h",
            "I regain one use per short rest and all uses per long rest",
            "Adv. on Con checks, Str checks/saves (not attacks); resistance to bludg/piercing/slashing",
            "Bonus damage equal to my Exploit Die",
            "I cannot cast spells or concentrate on spells or effects",
            "Stops early if I choose to end it or fall unconscious",
          ]);
        }
        return desc([
          "Start as bonus action; bonus damage to weapon attacks using Str; can last up to 1 h",
          "I have now unlimited uses of my rage",
          "Adv. on Con checks, Str checks/saves (not attacks); resistance to bludg/piercing/slashing",
          "Bonus damage equal to my Exploit Die",
          "I cannot cast spells or concentrate on spells or effects",
          "Stops early if I choose to end it or fall unconscious",
        ]);
      }),
      usages: [
        2,
        2,
        2,
        3,
        3,
        3,
        3,
        4,
        4,
        4,
        4,
        5,
        5,
        5,
        5,
        5,
        6,
        6,
        6,
        "\u221E\xD7 per ",
      ],
      recovery: "long rest",
      action: ["bonus action", ""],
      dmgres: [
        ["Bludgeoning", "Bludgeon. (in rage)"],
        ["Piercing", "Piercing (in rage)"],
        ["Slashing", "Slashing (in rage)"],
      ],
      savetxt: { text: ["Adv. on Str saves in rage"] },
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            var ExplDieRange = [
              "d4",
              "d4",
              "d4",
              "d4",
              "d6",
              "d6",
              "d6",
              "d6",
              "d6",
              "d6",
              "d8",
              "d8",
              "d8",
              "d8",
              "d8",
              "d8",
              "d10",
              "d10",
              "d10",
              "d10",
            ];

            if (
              v.isMeleeWeapon &&
              fields.Mod === 1 &&
              classes.known["barbarian(laserllama)"] &&
              classes.known["barbarian(laserllama)"].level
            ) {
              var ExplDie =
                ExplDieRange[classes.known["barbarian(laserllama)"].level - 1];
              fields.Description +=
                (fields.Description ? "; " : "") +
                "+1" +
                ExplDie +
                " dmg in Rage";
            }
          },
          "I deal additional damage with Strength based attacks while in Rage",
          20,
        ],
      },
    },

    "unarmored defense": {
      name: "Unarmored Defense",
      source: [["GMB:LL", 0]],
      minlevel: 1,
      description: desc(
        "Without armor, my AC is 10 + Dexterity modifier + Constitution modifier + shield"
      ),
      armorOptions: [
        {
          regExpSearch: /justToAddToDropDown/,
          name: "Unarmored Defense (Con)",
          source: [["GMB:LL", 0]],
          ac: "10+Con",
          affectsWildShape: true,
        },
      ],
      armorAdd: "Unarmored Defense (Con)",
    },

    "reckless attack": {
      name: "Reckless Attack",
      source: [["GMB:LL", 0]],
      minlevel: 2,
      description: desc([
        "I can choose to have advantage on all Strength-based attacks on my turn",
        "When doing so, other creatures have advantage against me for until my next turn",
      ]),
    },

    "savage exploits": (function () {
      // Fixed attributes
      SavageExploits = {
        name: "Savage Exploits",
        minlevel: 2,
        source: [["GMB:LL", 0]],
        description: desc([
          "I gain Exploit Dice, which are used to fuel my Savage Exploits",
          'Use the "Choose Feature" button above to choose Savage Exploits',
        ]),
        toNotesPage: [
          {
            name: "Savage Exploits",
            note: desc([
              "Below are all Savage Exploits I know. Each 3rd and 4th degree exploits can only be used once per short rest. Each 5th degree exploit can only be used once per long rest.",
            ]),
          },
        ],

        // Savage Exploits
        extraname: "Savage Exploits",
        extrachoices: [],
        extraTimes: [
          "",
          2,
          2,
          2,
          3,
          3,
          4,
          4,
          5,
          5,
          6,
          6,
          7,
          7,
          7,
          7,
          8,
          8,
          8,
          8,
        ],

        // Exploit dice
        // limfeaname: "Exploit Dice",
        // usages: ["", 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5],
        // additional: [
        //   "",
        //   "d4",
        //   "d4",
        //   "d4",
        //   "d6",
        //   "d6",
        //   "d6",
        //   "d6",
        //   "d6",
        //   "d6",
        //   "d8",
        //   "d8",
        //   "d8",
        //   "d8",
        //   "d8",
        //   "d8",
        //   "d10",
        //   "d10",
        //   "d10",
        //   "d10",
        // ],
        // recovery: "short rest",
      };

      // Make a filtered spell list that contains only barbarian(laserllama) "spells"
      const BarbarianSpells = Object.keys(SpellsList)
        .filter((key) => SpellsList[key].isExploit)
        .filter((key) => {
          for (var i = 0; i < SpellsList[key].classes.length; i++) {
            if (SpellsList[key].classes[i] == "barbarian(laserllama)")
              return true;
          }
          return false;
          // NOTE: this is literally a SpellsList[key].classes.includes("barbarian(laserllama)") but for some cursed reason I can't use that function
        });

      // Iterate over all barbarian(laserllama) "spells"
      for (var i = 0; i < BarbarianSpells.length; i++) {
        var NewSpell = SpellsList[BarbarianSpells[i]];
        var tempSpell = BarbarianSpells[i];

        SavageExploits.extrachoices.push(NewSpell.name); // Add "spell" name to menu options

        SavageExploits[BarbarianSpells[i]] = {
          // Add "spell" to the main item (when it is picked through the menu)
          name: NewSpell.name,
          toNotesPage: [
            {
              // What is added to the notes page
              name:
                NewSpell.name +
                " Exploit [" +
                (NewSpell.level == 1
                  ? "1st"
                  : NewSpell.level == 2
                    ? "2nd"
                    : NewSpell.level == 3
                      ? "3rd"
                      : NewSpell.level + "th") +
                " degree]",
              note: desc(NewSpell.descriptionFull),
              amendTo: "Savage Exploits",
            },
          ],
          source: NewSpell.source,
          addMod: NewSpell.addMod,
          submenu: NewSpell.submenu,
          prereqeval: ExploitPrereqFactory(
            BarbarianSpells[i],
            "barbarian(laserllama)"
          ),
          eval: CreateSavageSpellsheet, // in case the user removes all exploits
          spellcastingBonusElsewhere: {
            addTo: "savage exploits",
            spellcastingBonus: {
              name: "Savage Exploits",
              spellcastingAbility: 1,
              spells: [BarbarianSpells[i]],
              selection: [BarbarianSpells[i]],
            },
          },
        };
      }

      return SavageExploits;
    })(),

    "exploit dice": {
      name: "Exploit Dice",
      description: "I have a pool of dice to fuels my Exploits. They may change in size and number with a multiclass",
      minlevel: 2,
      eval: function () {
        var barbarianEDs = calcExploitDice();
        AddFeature("Exploit Dice", barbarianEDs.usages, " (" + barbarianEDs.additional + ")", "short rest", "Barbarian(Laserllama)");
      },
      changeeval: function () {
        var barbarianEDs = calcExploitDice();
        AddFeature("Exploit Dice", barbarianEDs.usages, " (" + barbarianEDs.additional + ")", "short rest", "Barbarian(Laserllama)");
      },
      eval: function () {
        var barbarianEDs = calcExploitDice();
        AddFeature("Exploit Dice", barbarianEDs.usages, " (" + barbarianEDs.additional + ")", "short rest", "Barbarian(Laserllama)");
      },
    },

    subclassfeature3: {
      name: "Primal Path",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        'Choose a path that best represents my combat and rage style and put it in the "Class" field',
      ]),
    },

    "extra attack": {
      name: "Extra Attack",
      source: [["GMB:LL", 0]],
      minlevel: 5,
      description: desc(
        "I can attack twice with an Attack action. Also if I Dash or Disengage while raging, I can make one weapon attack as a bonus action"
      ),
      action: ["bonus action", "Weapon Attack (aft. Dash/Dis.)"],
    },

    "danger sense": {
      name: "Danger Sense",
      source: [["GMB:LL", 0]],
      minlevel: 5,
      description: desc([
        "I have advan. on initiative rolls, and on initiative rolls I can choose to go to Rage (no action required)",
        "Moreover, if I am suprised when I roll initiative, I can act normally so long I Rage as part of rolling initiative"
      ]),
      advantages: [["Initiative", true]],
    },

    "feral instincts": {
      name: "Feral Instincts",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "I have adv. on Dex saves against effects I can see unless I'm blinded/deafened/incapacitated",
        "Moreover, my rage improved (see rage)",
      ]),
      savetxt: { text: ["Adv. on Dex saves vs. seen effects"] },
    },

    "improved critical": {
      name: "Improved Critical",
      source: [["GMB:LL", 0]],
      minlevel: 9,
      description: levels.map(function (n) {
        var CritRange = n < 9 ? 20 : n < 13 ? 19 : n < 17 ? 18 : 17;

        return desc(
          "My Strength-based attacks crit on rolling a " +
          CritRange +
          " or higher on the d20"
        );
      }),
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (
              !v.isSpell &&
              fields.Mod === 1 &&
              classes.known["barbarian(laserllama)"] &&
              classes.known["barbarian(laserllama)"].level
            ) {
              if (
                !v.CritChance &&
                classes.known["barbarian(laserllama)"].level < 13
              ) {
                fields.Description +=
                  (fields.Description ? "; " : "") + "Crit on 19-20";
                v.CritChance = 19;
              }

              if (
                (!v.CritChance || v.CritChance >= 19) &&
                classes.known["barbarian(laserllama)"].level >= 13 &&
                classes.known["barbarian(laserllama)"].level < 17
              ) {
                fields.Description +=
                  (fields.Description ? "; " : "") + "Crit on 18-20";
                v.CritChance = 18;
              }

              if (
                (!v.CritChance || v.CritChance >= 18) &&
                classes.known["barbarian(laserllama)"].level >= 17
              ) {
                fields.Description +=
                  (fields.Description ? "; " : "") + "Crit on 17-20";
                v.CritChance = 17;
              }
            }
          },
          "My weapon attacks score a critical hit on 19-20 (if barbarian lvl < 13) or 18-20 (if barbarian lvl < 17) or 17-20 (if barbarian lvl >= 17)",
          17,
        ],
      },
    },

    "critical strike": {
      name: "Critical Strike",
      source: [["GMB:LL", 0]],
      minlevel: 11,
      description: desc([
        "When I crit while raging, I can use an Exploit I know without expending a Die",
      ]),
    },

    unstoppable: {
      name: "Unstoppable",
      source: [["GMB:LL", 0]],
      minlevel: 11,
      description: desc([
        "If I drop to 0 HP while raging, but not killed outright, I can end my rage to drop to 1 HP instead",
        "Whenever I make an Int, Wis or Cha save, I add my Con mod (min of +1)",
      ]),
      addMod: [
        {
          type: "save",
          field: "Int",
          mod: "Con",
          text: "Unstoppable class feature",
        },
        {
          type: "save",
          field: "Wis",
          mod: "Con",
          text: "Unstoppable class feature",
        },
        {
          type: "save",
          field: "Cha",
          mod: "Con",
          text: "Unstoppable class feature",
        },
      ],
    },

    "persistent rage": {
      name: "Persistent Rage",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc(["My rage improved (see rage)"]),
    },

    "indomitable might": {
      name: "Indomitable Might",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc(
        "If a Str or Con check is lower than my Strength score, I can use my Strength score instead"
      ),
    },

    "primal champion": {
      name: "Primal Champion",
      source: [["GMB:LL", 0]],
      minlevel: 20,
      description: desc(
        "I add +4 to both my Strength and Constitution, and their maximums increase to 24"
      ),
      scores: [4, 0, 4, 0, 0, 0],
      scoresMaximum: [24, 0, 24, 0, 0, 0],
    },
  },
};

// Alternate Fighter class
ClassList["fighter(laserllama)"] = {
  name: "Fighter(LaserLlama)",
  regExpSearch: /^(?=.*fighter)(?=.*laserllama).*$/i,
  source: ["GMB:LL", 0],
  primaryAbility: "Strength or Dexterity",
  prereqs: "Strength 13 or Dexterity 13",
  die: 10,
  improvements: [0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 4, 4, 5, 5, 5, 6, 6],
  saves: ["Str", "Con"],
  skillstxt: {
    primary:
      "Choose two from Acrobatics, Athletics, History, Intimidation, Perception, Stealth and Survival.",
  },
  toolProfs: {
    primary: [["Artisan's tool", 1]],
  },
  armorProfs: {
    // the 4 entries are for: ["light", "medium", "heavy", "shields"]
    primary: [true, true, true, true], // the armor proficiencies if this is the first or only class
    secondary: [true, true, false, true], // the armor proficiencies if this class is multiclassed with (so not taken at level 1, but later)
  },
  weaponProfs: {
    primary: [true, true],
    secondary: [true, true],
  },
  equipment:
    "Fighter starting equipment:" +
    "\n \u2022 chain mail -or- leather armor, a longbow, 20 arrows;" +
    "\n \u2022 martial weapon and shield -or- two martial weapons;" +
    "\n \u2022 light crossbow and 20 bolts -or- two handaxes;" +
    "\n \u2022 a dungeoneer’s pack -or- an explorer’s pack;" +
    "\n\nAlternatively, choose 5d4 x 10 gp worth of starting equipment instead of both the class' and the background's starting equipment.",
  subclasses: [
    "Warrior Archetype", []
  ],
  attacks: [1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4],
  abilitySave: 1, // Alt Fighter uses Strength or Dex for foes' saving throws
  abilitySaveAlt: 2,
  spellcastingFactor: "warlock99", // Required for the "create a complete spell sheet" option; using the warlock option ensures it doesn't clash with multiclassing
  features: {
    "fighting style": {
      name: "Fighting Style",
      source: [["GMB:LL", 0]],
      minlevel: 1,
      description: levels.map(function (n) {
        const numStyles = n < 6 ? 1 : n < 12 ? 2 : n < 18 ? 3 : 4;
        return desc([
          "Choose " +
          numStyles +
          " Fighting Style" +
          (numStyles > 1 ? "s" : "") +
          ' for the fighter using the "Choose Feature" button above',
        ]);
      }),
      extraTimes: levels.map(function (n) {
        if (n < 6) return 1; // Livello 1: 1 stile
        if (n < 12) return 2; // Livello 6: 2 stili
        if (n < 18) return 3; // Livello 12: 3 stili
        return 4; // Livello 18: 4 stili
      }),
      extraname: "Fighter Fighting Styles",
      extrachoices: [
        "Archery",
        "Archery Expert",
        "Balanced",
        "Balanced Expert",
        "Brawling",
        "Brawling Expert",
        "Classical Swordplay",
        "Classical Swordplay Expert",
        "Defensive",
        "Defensive Expert",
        "Dual Wielding",
        "Dual Wielding Expert",
        "Polearm Fighting",
        "Polearm Fighting Expert",
        "Featherweight Fighting",
        "Featherweight Expert",
        "Great Weapon Fighting",
        "Great Weapon Expert",
        "Improvised Fighting",
        "Melee Marksman",
        "Mounted Warrior",
        "Mounted Expert",
        "Protection",
        "Protection Expert",
        "Strongbow",
        "Hurler",
        "Versatile Fighting",
        "Blind Warrior",
        "Exotic Warrior",
        "Heavyweight Fighting",
        "Heavyweight Expert",
        "Mariner",
        "Mountaineer",
        "Shield Warrior",
        "Shield Expert",
        "Standard Bearer",
        "Superior Technique",
      ],
      archery: FightingStylesLL.archery,
      "archery expert": FightingStylesLL.archery_expert,
      balanced: FightingStylesLL.balanced,
      "balanced expert": FightingStylesLL.balanced_expert,
      brawling: FightingStylesLL.brawling,
      "brawling expert": FightingStylesLL.brawling_expert,
      "classical swordplay": FightingStylesLL.classical,
      "classical swordplay expert": FightingStylesLL.classical_expert,
      defensive: FightingStylesLL.defensive,
      "defensive expert": FightingStylesLL.defensive_expert,
      "dual wielding": FightingStylesLL.dual_wielding,
      "dual wielding expert": FightingStylesLL.dual_wielding_expert,
      "polearm fighting": FightingStylesLL.polearm,
      "polearm fighting expert": FightingStylesLL.polearm_expert,
      protection: FightingStylesLL.protection,
      "protection expert": FightingStylesLL.protection_expert,
      "featherweight fighting": FightingStylesLL.featherweight,
      "featherweight expert": FightingStylesLL.featherweight_expert,
      "great weapon fighting": FightingStylesLL.great_weapon,
      "great weapon expert": FightingStylesLL.great_weapon_expert,
      "improvised fighting": FightingStylesLL.improvised,
      "exotic warrior": FightingStylesLL.exotic,
      "melee marksman": FightingStylesLL.marksman,
      "mounted warrior": FightingStylesLL.mounted,
      "mounted expert": FightingStylesLL.mounted_expert,
      strongbow: FightingStylesLL.strongbow,
      hurler: FightingStylesLL.hurler,
      "versatile fighting": FightingStylesLL.versatile,
      "blind warrior": FightingStylesLL.blind,
      "heavyweight fighting": FightingStylesLL.heavyweight,
      "heavyweight expert": FightingStylesLL.heavyweight_expert,
      mariner: FightingStylesLL.mariner,
      mountaineer: FightingStylesLL.mountaineer,
      "shield warrior": FightingStylesLL.shieldwarrior,
      "shield expert": FightingStylesLL.shieldwarrior_expert,
      "superior technique": FightingStylesLL.superior_technique,
      "standard bearer": FightingStylesLL.standardbearer,
    },

    "second wind": {
      name: "Second Wind",
      source: [["GMB:LL", 0]],
      minlevel: 1,
      description:
        "As a bonus action, I can regain hit points equal to 1d10 + fighter level",
      usages: levels.map(function (n) {
        return n < 1 ? "" : n < 14 ? 1 : 2;
      }),
      recovery: "short rest",
      action: [["bonus action", ""]],
    },

    "martial exploits": (function () {
      // Fixed attributes
      MartialExploits = {
        name: "Martial Exploits",
        minlevel: 2,
        source: [["GMB:LL", 0]],
        description: desc([
          "I gain Exploit Dice, which are used to fuel my Martial Exploits",
          'Use the "Choose Feature" button above to choose Martial Exploits',
        ]),
        toNotesPage: [
          {
            name: "Martial Exploits",
            note: desc([
              "Below are all Martial Exploits I know. Each 3rd and 4th degree exploits can only be used once per short rest. Each 5th degree exploit can only be used once per long rest.",
            ]),
          },
        ],

        // Martial Exploits
        extraname: "Martial Exploits",
        extraTimes: [
          "",
          2,
          3,
          3,
          4,
          4,
          5,
          5,
          6,
          6,
          7,
          7,
          8,
          8,
          9,
          9,
          10,
          10,
          11,
          11,
        ],
        extrachoices: [],

        // Exploit dice
        // limfeaname: "Exploit Dice",
        // usages: ["", 2, 2, 3, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 5, 6, 6, 6, 6, 6],
        // additional: [
        //   "",
        //   "d6",
        //   "d6",
        //   "d6",
        //   "d8",
        //   "d8",
        //   "d8",
        //   "d8",
        //   "d8",
        //   "d8",
        //   "d10",
        //   "d10",
        //   "d10",
        //   "d10",
        //   "d10",
        //   "d10",
        //   "d12",
        //   "d12",
        //   "d12",
        //   "d12",
        // ],
        // recovery: "short rest",
      };

      // Make a filtered spell list that contains only Fighter(laserllama) "spells"
      const FighterSpells = Object.keys(SpellsList)
        .filter((key) => SpellsList[key].isExploit)
        .filter((key) => {
          for (var i = 0; i < SpellsList[key].classes.length; i++) {
            if (SpellsList[key].classes[i] == "fighter(laserllama)")
              return true;
          }
          return false;
          // NOTE: this is literally a SpellsList[key].classes.includes("fighter(laserllama)") but for some cursed reason I can't use that function
        });

      // Iterate over all Fighter(laserllama) "spells"
      for (var i = 0; i < FighterSpells.length; i++) {
        var NewSpell = SpellsList[FighterSpells[i]];
        var tempSpell = FighterSpells[i];

        MartialExploits.extrachoices.push(NewSpell.name); // Add "spell" name to menu options

        MartialExploits[FighterSpells[i]] = {
          // Add "spell" to the main item (when it is picked through the menu)
          name: NewSpell.name,
          toNotesPage: [
            {
              // What is added to the notes page
              name:
                NewSpell.name +
                " Exploit [" +
                (NewSpell.level == 1
                  ? "1st"
                  : NewSpell.level == 2
                    ? "2nd"
                    : NewSpell.level == 3
                      ? "3rd"
                      : NewSpell.level + "th") +
                " degree]",
              note: desc(NewSpell.descriptionFull),
              amendTo: "Martial Exploits",
            },
          ],
          source: NewSpell.source,
          addMod: NewSpell.addMod,
          submenu: NewSpell.submenu,
          prereqeval: ExploitPrereqFactory(
            FighterSpells[i],
            "fighter(laserllama)"
          ),
          eval: CreateMartialSpellsheet,
          spellcastingBonusElsewhere: {
            addTo: "martial exploits",
            spellcastingBonus: {
              name: "Martial Exploits",
              spellcastingAbility: 1,
              spells: [FighterSpells[i]],
              selection: [FighterSpells[i]],
            },
          },
        };
      }

      return MartialExploits;
    })(),

    "exploit dice": {
      name: "Exploit Dice",
      description: "I have a pool of dice to fuels my Exploits. They may change in size and number with a multiclass",
      minlevel: 2,
      eval: function () {
        var fighterEDs = calcExploitDice();
        AddFeature("Exploit Dice", fighterEDs.usages, " (" + fighterEDs.additional + ")", "short rest", "Fighter(Laserllama)");
      },
      changeeval: function () {
        var fighterEDs = calcExploitDice();
        AddFeature("Exploit Dice", fighterEDs.usages, " (" + fighterEDs.additional + ")", "short rest", "Fighter(Laserllama)");
      },
      removeeval: function () {
        var fighterEDs = calcExploitDice();
        AddFeature("Exploit Dice", fighterEDs.usages, " (" + fighterEDs.additional + ")", "short rest", "Fighter(Laserllama)");
      },
    },

    "eye for talent": {
      name: "Eye for Talent",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "If I spend a bonus action studying someone (up to 30 ft, DC = 8 + CR), the DM will tell me info about them (my choice)",
        "If I hit the creature with a weapon attack before studying it, I have a bonus equal to my fighter level to the check",
        "I cannot use this twice on the same creature before hit it with a weapon attack",
      ]),
      action: [["bonus action", ""]],
    },

    subclassfeature3: {
      name: "Warrior Archetype",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        'Choose a Warrior Archetype you strive to emulate and put it in the "Class" field',
      ]),
    },

    "extra attack": {
      name: "Extra Attack",
      source: [["GMB:LL", 0]],
      minlevel: 5,
      description: desc([
        "In addition to more attacks per action, if I Dash or Disengage, I can attack once with bonus action",
      ]),
      action: ["bonus action", "Single attack (after Dash/Disengage action)"],
    },

    "action surge": {
      name: "Action Surge",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "I can take one additional action on my turn on top of my normally allowed actions",
      ]),
      usages: levels.map(function (n) {
        return n < 6 ? 0 : n < 20 ? 1 : 2;
      }),
      recovery: "short rest",
    },

    indomitable: {
      name: "Indomitable",
      source: [["GMB:LL", 0]],
      minlevel: 9,
      description: desc([
        "When I fail a saving throw, I can choose to succeed instead",
      ]),
      usages: levels.map(function (n) {
        return n < 9 ? 0 : n < 13 ? 1 : n < 17 ? 2 : 3;
      }),
      recovery: "long rest",
    },

    "martial superiority": {
      name: "Martial Superiority",
      source: [["GMB:LL", 0]],
      minlevel: 11,
      description: desc(
        "Once per round I do not spend a Exploit Die for my 1st or 2nd degree Exploits"
      ),
    },

    relentless: {
      name: "Relentless",
      source: [["GMB:LL", 0]],
      minlevel: 20,
      description: desc([
        "When I roll initiative, I regain all expended exploit die",
        "Also, I can use any 3rd-degree Exploit I know any number of times between each rest",
      ]),
    },
  },
};

// Edit official eldritch knight regex to avoid conflict with arcane knight
if (ClassSubList["fighter-eldritch knight"]) {
  ClassSubList["fighter-eldritch knight"].regExpSearch =
    /^(?!.*(exalted|sacred|holy|divine|nature|natural|purple.*dragon|green|arcane archer))(?=.*(knight|fighter|warrior|militant|warlord|phalanx|gladiator|trooper))(?=.*\b(eldritch|magic|mage)\b).*$/i;
}
// Edit official oath of vengeance regex to avoid conflict with avanger rogue
if (ClassSubList["paladin-oath of vengeance"]) {
  ClassSubList["paladin-oath of vengeance"].regExpSearch =
    /^(((?=.*(vengeance|wrath|justice))((?=.*paladin)|((?=.*(exalted|sacred|holy|divine))(?=.*(knight|fighter|warrior|warlord|trooper)))))|((?=.*dark)(?=.*knight))).*$/i;
}

// Alternate Ranger class
ClassList["ranger(laserllama)"] = {
  name: "Ranger(Laserllama)",
  regExpSearch: /^(?=.*ranger)(?=.*laserllama).*$/i,
  source: ["GMB:LL", 0],
  primaryAbility: "Ranger: Dexterity/Strength and Wisdom",
  prereqs: "Strength or Dexterity 13; Wisdom 13",
  improvements: [0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 5, 5],
  die: 10,
  abilitySave: 5,
  spellcastingFactor: 2,
  spellcastingFactorRoundupMulti: false,
  spellcastingTable: [
    [0, 0, 0, 0, 0, 0, 0, 0, 0], // lvl 0
    [0, 0, 0, 0, 0, 0, 0, 0, 0], // lvl 1
    [2, 0, 0, 0, 0, 0, 0, 0, 0], // lvl 2
    [3, 0, 0, 0, 0, 0, 0, 0, 0], // lvl 3
    [3, 0, 0, 0, 0, 0, 0, 0, 0], // lvl 4
    [4, 2, 0, 0, 0, 0, 0, 0, 0], // lvl 5
    [4, 2, 0, 0, 0, 0, 0, 0, 0], // lvl 6
    [4, 3, 0, 0, 0, 0, 0, 0, 0], // lvl 7
    [4, 3, 0, 0, 0, 0, 0, 0, 0], // lvl 8
    [4, 3, 2, 0, 0, 0, 0, 0, 0], // lvl 9
    [4, 3, 2, 0, 0, 0, 0, 0, 0], // lvl 10
    [4, 3, 3, 0, 0, 0, 0, 0, 0], // lvl 11
    [4, 3, 3, 0, 0, 0, 0, 0, 0], // lvl 12
    [4, 3, 3, 1, 0, 0, 0, 0, 0], // lvl 13
    [4, 3, 3, 1, 0, 0, 0, 0, 0], // lvl 14
    [4, 3, 3, 2, 0, 0, 0, 0, 0], // lvl 15
    [4, 3, 3, 2, 0, 0, 0, 0, 0], // lvl 16
    [4, 3, 3, 3, 1, 0, 0, 0, 0], // lvl 17
    [4, 3, 3, 3, 1, 0, 0, 0, 0], // lvl 18
    [4, 3, 3, 3, 2, 0, 0, 0, 0], // lvl 19
    [4, 3, 3, 3, 2, 0, 0, 0, 0]  // lvl 20
  ],
  spellcastingKnown: {
    spells: "list",
    prepared: true
  },// Required for the "create a complete spell sheet" option; using the warlock option ensures it doesn't clash with multiclassing
  saves: ["Str", "Dex"],
  skillstxt: {
    primary:
      "Choose three from Animal Handling, Athletics, Insight, Investigation, Medicine, Nature, Perception, Sleight of Hand, Stealth and Survival",
    secondary:
      "Choose one from Animal Handling, Athletics, Insight, Investigation, Medicine, Nature, Perception, Sleight of Hand, Stealth and Survival",
  },
  armorProfs: {
    primary: [true, true, false, true],
    secondary: [true, true, false, true],
  },
  weaponProfs: {
    primary: [
      true,
      true,
    ],
    secondary: [
      true,
      true,
    ],
  },
  equipment:
    "Ranger starting equipment:" +
    "\n \u2022 A chain shirt and shield -or- a leather armor;" +
    "\n \u2022 Two shortsword -or- two simple melee weapons;" +
    "\n \u2022 A longbow and 20 arrows -or- martila weapon" +
    "\n \u2022 A dungeoneer's pack -or- an explorer's pack" +
    "\n\nAlternatively, choose 5d4 \xD7 10 gp worth of starting equipment instead of both the class' and the background's starting equipment.",
  subclasses: ["Ranger Conclave", []],
  attacks: [1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
  features: {
    knacks: (function () {
      // Fixed attributes
      ClassKnackFeature = {
        name: "Knacks",
        minlevel: 1,
        source: [["GMB:LL", 0]],
        description: desc([
          "I learn Knacks that gives me additional features",
          'Use the "Choose Feature" button above to choose Knacks',
          "They are added to the note page"
        ]),
        toNotesPage: [
          {
            name: "Knacks Known",
            note: desc([
              "Below are all Knacks I know. Whenever I gain a Ranger level, I can replace a knack I know with a knack where I meet the prerequites",
            ]),
          },
        ],
        extraname: "Ranger Knacks",
        extraTimes: [
          1,
          2,
          3,
          3,
          3,
          4,
          4,
          4,
          5,
          5,
          5,
          6,
          6,
          7,
          7,
          8,
          8,
          9,
          9,
          10,
        ],
        extrachoices: [],
        additional: [
          "1 Knack known",
          "2 Knacks known",
          "3 Knacks known",
          "3 Knacks known",
          "3 Knacks known",
          "4 Knacks known",
          "4 Knacks known",
          "4 Knacks known",
          "5 Knacks known",
          "5 Knacks known",
          "5 Knacks known",
          "6 Knacks known",
          "6 Knacks known",
          "7 Knacks known",
          "7 Knacks known",
          "8 Knacks known",
          "8 Knacks known",
          "9 Knacks known",
          "9 Knacks known",
          "10 Knacks known",
        ],
      };


      // Iterate over all knacks available to this class
      var KnacksKeys = Object.keys(KnacksLL);

      for (var i = 0; i < KnacksKeys.length; i++) {
        var NewKnack = KnacksLL[KnacksKeys[i]];

        ClassKnackFeature.extrachoices.push(KnacksKeys[i]); // Add "spell" name to menu options

        ClassKnackFeature[KnacksKeys[i]] = {
          // Add "spell" to the main item (when it is picked through the menu)
          name: NewKnack.name,
          toNotesPage: [
            {
              // What is added to the notes page
              name:
                NewKnack.name,
              note: NewKnack.description,
              amendTo: "Knacks Known",
            },
          ],
          source: NewKnack.source,
          addMod: NewKnack.addMod,
          speed: NewKnack.speed,
          toolProfs: NewKnack.toolProfs,
          action: NewKnack.action,
          prereqeval: NewKnack.prereqeval,
          usages: NewKnack.usages,
          recovery: NewKnack.recovery,
          savetxt: NewKnack.savetxt,
          dmgres: NewKnack.dmgres,
          armorProfs: NewKnack.armorProfs,
          submenu: NewKnack.submenu,
          extraname: NewKnack.extraname,
          extraTimes: NewKnack.extraTimes,
          choices: NewKnack.choices,
          vision: NewKnack.vision,
        };;

      }
      return ClassKnackFeature;
    })(),
    "fighting style": {
      name: "Fighting Style",
      source: [["GMB:LL", 0]],
      minlevel: 1,
      description: levels.map(function (n) {
        const numStyles = n < 6 ? 1 : n < 12 ? 2 : n < 18 ? 3 : 4;
        return desc([
          "Choose a Fighting Style" +
          ' for the ranger using the "Choose Feature" button above',
        ]);
      }),
      extraname: "Ranger Fighting Styles",
      choices: [
        "Archery",
        "Defensive",
        "Dual Wielding",
        "Classical Swordplay",
        "Featherweight Fighting",
        "Hurler",
        "Mariner",
        "Mountaineer",
        "Strongbow",
        "Versatile Fighting",
        "Blind Warrior",
        "Brawling",
        "Druidic Warrior",
        "Melee Marksman",
        "Mounted Warrior"
      ],
      archery: FightingStylesLL.archery,
      defensive: FightingStylesLL.defensive,
      "dual wielding": FightingStylesLL.dual_wielding,
      "classical swordplay": FightingStylesLL.classical,
      "featherweight fighting": FightingStylesLL.featherweight,
      "hurler": FightingStylesLL.hurler,
      mariner: FightingStylesLL.mariner,
      mountaineer: FightingStylesLL.mountaineer,
      strongbow: FightingStylesLL.strongbow,
      "versatile fighting": FightingStylesLL.versatile,
      "blind warrior": FightingStylesLL.blind,
      brawling: FightingStylesLL.brawling,
      "druidic warrior": FightingStylesLL.druidic_warrior,
      "melee marksman": FightingStylesLL.marksman,
      "mounted warrior": FightingStylesLL.mounted
    },
    "wild expertise": (function () {
      var a = {
        name: "Wild Expertise",
        source: ["GMB:LL", 0],
        minlevel: 1,
        description: levels.map((n) => {
          if (n < 9) return desc(
            " I gain expertise with skills I am proficient with",
            "  Also I learn an additional language"
          );
          return desc(
            " I gain expertise with skills I am proficient with",
            "  Also I learn two additional languages"
          );
        }),
        skillstxt:
          "Expertise with any skill proficiencies (see lvl1 ranger feature)",
        additional: levels.map(function (n) {
          return (
            "with " +
            (n < 9 ? "1 skill" : "2 skills")
          );
        }),

        extraname: "Wild Expertise",
        autoSelectExtrachoices: [
          { extrachoice: "first language", minlevel: 1 },
          { extrachoice: "second language", minlevel: 9 },
        ],
        "first language": { languageProfs: [["Any language 1", 1]], },
        "second language": { languageProfs: [["Any language 2", 1]], },
        extrachoices: [
          "Animal Handling",
          "Athletics",
          "Insight",
          "Investigation",
          "Medicine",
          "Nature",
          "Perception",
          "Sleight of Hand",
          "Stealth",
          "Survival",
        ],
        extraTimes: levels.map(function (n) {
          return n < 9 ? 1 : 2;
        }),
      };
      for (var i = 0; i < a.extrachoices.length; i++) {
        var attr = a.extrachoices[i].toLowerCase();
        if (a[attr]) continue;
        a[attr] = {
          name: a.extrachoices[i] + " Expertise",
          description: "",
          source: a.source,
          skills: [[a.extrachoices[i], "only"]],
          prereqeval: function (v) {
            return v.skillProfsLC.indexOf(v.choice) === -1
              ? false
              : v.skillExpertiseLC.indexOf(v.choice) === -1
                ? true
                : "markButDisable";
          },
        };
      }
      return a;
    })(),
    "spellcasting": {
      name: "Spellcasting",
      source: [["GMB:LL", 0]],
      minlevel: 2,
      description: desc([
        "I can cast known Ranger spells, using my Wisdom modifier as my spellcasting ability",
        "I can prepare spells equal to my Wis mod + half ranger level (rounded down)",
        "I can use a druidic focus as spellcasting focus"
      ]),
    },
    "ranger quarry": {
      name: "Ranger's Quarry",
      source: ["GMB:LL", 0],
      minlevel: 2,
      description: desc([
        "As a bonus action I can mark a creature as my Quarry, gaining the following benefits for the duration:",
        "Whenever I damage it with an attack, I deal extra Quarry Die damage",
        "Whenever I make a check to track or locate it, I can add my Quarry Die to the roll",
      ]),
      additional: [
        "",
        "d4; 1 hour;",
        "d4; 1 hour;",
        "d4; 1 hour;",
        "d4; 1 hour;",
        "d6; 8 hours;",
        "d6; 8 hours;",
        "d6; 8 hours;",
        "d6; 8 hours;",
        "d8; 24 hours;",
        "d8; 24 hours;",
        "d8; 24 hours;",
        "d8; 24 hours;",
        "d10; 1 week;",
        "d10; 1 week;",
        "d10; 1 week;",
        "d10; 1 week;",
        "d12; indefinite;",
        "d12; indefinite;",
        "d12; indefinite;",
      ],
      usages: "Wis mod per",
      usagescalc: "event.value = Math.max(1, What('Wis Mod'));",
      recovery: levels.map((n) => { return n < 11 ? "long rest" : "short rest" }),
      action: [["bonus action", ""]]
    },
    subclassfeature3: {
      name: "Ranger Conclave",
      source: ["GMB:LL", 0],
      minlevel: 3,
      description: desc(
        'Choose a Ranger Conclave you strive to emulate and put it in the "Class" field '
      ),
    },
    "feral senses": {
      name: "Feral Senses",
      source: ["GMB:LL", 0],
      minlevel: 5,
      description: levels.map(function (n) {
        if (n < 18)
          return desc(
            "I cannot have disadvan. on attack rolls against my Quarry"
          );
        return desc(
          "I cannot have disadvan. on attack rolls against my Quarry, and any target within 30 feet of me"
        );
      }),
    },
    tireless: {
      name: "Tireless",
      source: ["GMB:LL", 0],
      minlevel: 11,
      description: desc([
        "I regain all of my expended uses of Ranger's Quarry whenever I finish a short/long rest",
      ]),
    },
    "foe slayer": {
      name: "Foe Slayer",
      source: ["GMB:LL", 0],
      minlevel: 20,
      description: desc(
        "Whenever I hit my QUarry, I can immediately end the mark and cause that attack to deal mazimum damage instead of rolling",
        "\n If the attack reduce the crea to 50 or fewer HP, it must succeed a Con save against my Spell DC or be reduced to 0 HP"
      ),
    },
  },
};

// Alternate Rogue class
ClassList["rogue(laserllama)"] = {
  name: "Rogue(Laserllama)",
  regExpSearch: /^(?=.*rogue)(?=.*laserllama).*$/i,
  source: ["GMB:LL", 0],
  primaryAbility: "Rogue: Dexterity",
  prereqs: "Dexterity 13",
  improvements: [0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 5, 5],
  die: 8,
  abilitySave: 2, // for devious exploits
  abilitySaveAlt: 1,
  spellcastingFactor: "warlock99", // Required for the "create a complete spell sheet" option; using the warlock option ensures it doesn't clash with multiclassing
  saves: ["Int", "Dex"],
  skillstxt: {
    primary:
      "Choose four from Acrobatics, Athletics, Deception, Insight, Intimidation, Investigation, Perception, Performance, Persuasion, Sleight of Hand, and Stealth",
    secondary:
      "Choose one from Acrobatics, Athletics, Deception, Insight, Intimidation, Investigation, Perception, Performance, Persuasion, Sleight of Hand, or Stealth",
  },
  toolProfs: {
    primary: [["Any tool", 1]],
    secondary: [["Any tool", 1]],
  },
  armorProfs: {
    primary: [true, false, false, false],
    secondary: [true, false, false, false],
  },
  weaponProfs: {
    // Simple weapons, blowguns, hand crossbows, scimitars, shortswords, rapiers, and whips
    primary: [
      true,
      false,
      ["blowgun", "hand crossbow", "scimitar", "shortsword", "rapier", "whip"],
    ],
  },
  equipment:
    "Rogue starting equipment:" +
    "\n \u2022 A rapier -or- a scimitar -or- a shortsword;" +
    "\n \u2022 A shortbow and a quiver of 20 arrows -or- a shortsword;" +
    "\n \u2022 A burglar's pack -or- dungeoneer's pack" +
    "\n \u2022 Leather armor, two daggers, and a set of tools of your choice." +
    "\n\nAlternatively, choose 4d4 \xD7 10 gp worth of starting equipment instead of both the class' and the background's starting equipment.",
  subclasses: ["Roguish Archetype", []],
  attacks: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
  features: {
    expertise: (function () {
      var a = {
        name: "Expertise",
        source: ["GMB:LL", 0],
        minlevel: 1,
        description: desc(
          "I gain expertise with skills/tools I am proficient with"
        ),
        skillstxt:
          "Expertise with any skill proficiencies and/or tools (see lvl1 rogue feature)",
        additional: levels.map(function (n) {
          return (
            "with " +
            (n < 6 ? 2 : n < 11 ? 3 : n < 15 ? 4 : n < 20 ? 5 : 6) +
            " skills"
          );
        }),
        extraname: "Expertise",
        extrachoices: [
          "Acrobatics",
          "Animal Handling",
          "Arcana",
          "Athletics",
          "Deception",
          "History",
          "Insight",
          "Intimidation",
          "Investigation",
          "Medicine",
          "Nature",
          "Perception",
          "Performance",
          "Persuasion",
          "Religion",
          "Sleight of Hand",
          "Stealth",
          "Survival",
          "Thieves' Tools",
        ],
        extraTimes: levels.map(function (n) {
          return n < 6 ? 2 : n < 11 ? 3 : n < 15 ? 4 : n < 20 ? 5 : 6;
        }),
        "thieves' tools": {
          name: "Thieves' Tools Expertise",
          description: "",
          source: [
            ["SRD", 39],
            ["P", 96],
          ],
          prereqeval: function (v) {
            if (
              /thieve.?s.*tools/i.test(What("Too Text")) &&
              tDoc.getField("Too Prof").isBoxChecked(0)
            ) {
              return tDoc.getField("Too Exp").isBoxChecked(0)
                ? "markButDisable"
                : true;
            } else {
              return (
                CurrentProfs.tool["thieves' tools"] ||
                /thieve.?s.{1,3}tools/i.test(v.toolProfs.toString())
              );
            }
          },
          eval: function () {
            if (/thieve.?s.*tools/i.test(What("Too Text"))) {
              Checkbox("Too Exp", true);
            }
          },
          removeeval: function () {
            if (/thieve.?s.*tools/i.test(What("Too Text"))) {
              Checkbox("Too Exp", false);
            }
          },
        },
      };
      for (var i = 0; i < a.extrachoices.length; i++) {
        var attr = a.extrachoices[i].toLowerCase();
        if (a[attr]) continue;
        a[attr] = {
          name: a.extrachoices[i] + " Expertise",
          description: "",
          source: a.source,
          skills: [[a.extrachoices[i], "only"]],
          prereqeval: function (v) {
            return v.skillProfsLC.indexOf(v.choice) === -1
              ? false
              : v.skillExpertiseLC.indexOf(v.choice) === -1
                ? true
                : "markButDisable";
          },
        };
      }
      return a;
    })(),
    "sneak attack": {
      name: "Sneak Attack",
      source: ["GMB:LL", 0],
      minlevel: 1,
      description: desc([
        "Once per turn, I can add damage to a finesse/ranged weapon attack if I have advantage",
        "I don't need adv. if the target has a conscious enemy within 5 ft and I don't have disadv.",
      ]),
      additional: levels.map(function (n) {
        return Math.ceil(n / 2) + "d6";
      }),
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (
              classes.known["rogue(laserllama)"] &&
              classes.known["rogue(laserllama)"].level &&
              !v.isSpell &&
              !v.isDC &&
              (v.isRangedWeapon || /\bfinesse\b/i.test(fields.Description))
            ) {
              v.sneakAtk = Math.ceil(
                classes.known["rogue(laserllama)"].level / 2
              );
              fields.Description +=
                (fields.Description ? "; " : "") +
                "Sneak attack " +
                v.sneakAtk +
                "d6";
            }
          },
          "Once per turn, when I attack with a ranged or finesse weapon while I have advantage or an conscious ally is within 5 ft of the target, I can add my sneak attack damage to the attack.",
          700,
        ],
      },
    },
    "thieves cant": {
      name: "Thieves' Cant",
      source: ["GMB:LL", 0],
      minlevel: 1,
      description: desc([
        "I learn Thieves Cant or two languages of my choice",
        'Use the "Choose Feature" button above to choose',
      ]),
      choices: ["thieves cant", "two languages"],
      "thieves cant": {
        name: "Thieves Cant",
        description: "I learn Thieves' Cant",
        languageProfs: ["Thieves' Cant"],
      },
      "two languages": {
        name: "Thieves Cant",
        description: "I learn two languages of my choice",
        languageProfs: [2],
      },
    },
    "cunning action": {
      name: "Cunning Action",
      source: ["GMB:LL", 0],
      minlevel: 2,
      description: levels.map(function (n) {
        if (n < 11)
          return desc(
            "I can use a bonus action to take the Dash, Disengage, Hide or Use an Object action"
          );
        return desc(
          "I can use a bonus action to take the Dash, Disengage, Hide or Use an Object action",
          "Also I can take a second bonus action each turn but cannot use the same bonus action twice"
        );
      }),
      action: [["bonus action", ""]],
    },
    "devious exploits": (function () {
      // Fixed attributes
      ClassExploitFeature = {
        name: "Devious Exploits",
        minlevel: 2,
        source: [["GMB:LL", 0]],
        description: desc([
          "I gain Exploit Dice, which are used to fuel my Devious Exploits",
          'Use the "Choose Feature" button above to choose Devious Exploits',
        ]),
        toNotesPage: [
          {
            name: "Devious Exploits",
            note: desc([
              "Below are all Devious Exploits I know. Each 3rd and 4th degree exploits can only be used once per short rest. Each 5th degree exploit can only be used once per long rest.",
            ]),
          },
        ],

        // Devious Exploits
        extraname: "Devious Exploits",
        extraTimes: [
          "",
          2,
          2,
          2,
          3,
          3,
          4,
          4,
          5,
          5,
          6,
          6,
          7,
          7,
          7,
          7,
          8,
          8,
          8,
          8,
        ],
        extrachoices: [],
        // limfeaname: "Exploit Dice",

        // // Exploit dice
        // usages: ["", 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5],
        // additional: [
        //   "",
        //   "d4",
        //   "d4",
        //   "d4",
        //   "d6",
        //   "d6",
        //   "d6",
        //   "d6",
        //   "d6",
        //   "d6",
        //   "d8",
        //   "d8",
        //   "d8",
        //   "d8",
        //   "d8",
        //   "d8",
        //   "d10",
        //   "d10",
        //   "d10",
        //   "d10",
        // ],
        // recovery: "short rest",

        // Eval
        eval: CreateDeviousSpellsheet,
      };

      // Make a filtered spell list that contains only "spells" for this class
      const ClassExploits = Object.keys(SpellsList)
        .filter((key) => SpellsList[key].isExploit)
        .filter((key) => {
          for (var i = 0; i < SpellsList[key].classes.length; i++) {
            if (SpellsList[key].classes[i] == "rogue(laserllama)") return true;
          }
          return false;
          // NOTE: this is literally a SpellsList[key].classes.includes(...) but for some cursed reason I can't use that function
        });

      // Iterate over all exploits available to this class
      for (var i = 0; i < ClassExploits.length; i++) {
        var NewSpell = SpellsList[ClassExploits[i]];

        ClassExploitFeature.extrachoices.push(NewSpell.name); // Add "spell" name to menu options

        ClassExploitFeature[ClassExploits[i]] = {
          // Add "spell" to the main item (when it is picked through the menu)
          name: NewSpell.name,
          toNotesPage: [
            {
              // What is added to the notes page
              name:
                NewSpell.name +
                " Exploit [" +
                (NewSpell.level == 1
                  ? "1st"
                  : NewSpell.level == 2
                    ? "2nd"
                    : NewSpell.level == 3
                      ? "3rd"
                      : NewSpell.level + "th") +
                " degree]",
              note: desc(NewSpell.descriptionFull),
              amendTo: "Devious Exploits",
            },
          ],
          source: NewSpell.source,
          addMod: NewSpell.addMod,
          submenu: NewSpell.submenu,
          prereqeval: ExploitPrereqFactory(
            ClassExploits[i],
            "rogue(laserllama)"
          ),
          eval: CreateDeviousSpellsheet,
          spellcastingBonusElsewhere: {
            addTo: "devious exploits",
            spellcastingBonus: {
              name: "Devious Exploits",
              spellcastingAbility: 4,
              spells: [ClassExploits[i]],
              selection: [ClassExploits[i]],
            },
          },
        };
      }

      return ClassExploitFeature;
    })(),
    "exploit dice": {
      name: "Exploit Dice",
      description: "I have a pool of dice to fuels my Exploits. They may change in size and number with a multiclass",
      minlevel: 2,
      eval: function () {
        var rogueEDs = calcExploitDice();
        AddFeature("Exploit Dice", rogueEDs.usages, " (" + rogueEDs.additional + ")", "short rest", "Rogue(Laserllama)");
      },
      changeeval: function () {
        var rogueEDs = calcExploitDice();
        AddFeature("Exploit Dice", rogueEDs.usages, " (" + rogueEDs.additional + ")", "short rest", "Rogue(Laserllama)");
      },
      removeeval: function () {
        var rogueEDs = calcExploitDice();
        AddFeature("Exploit Dice", rogueEDs.usages, " (" + rogueEDs.additional + ")", "short rest", "Rogue(Laserllama)");
      },
    },
    subclassfeature3: {
      name: "Roguish Archetype",
      source: ["GMB:LL", 0],
      minlevel: 3,
      description: desc(
        'Choose a Roguish Archetype you strive to emulate and put it in the "Class" field '
      ),
    },
    "uncanny dodge": {
      name: "Uncanny Dodge",
      source: ["GMB:LL", 0],
      minlevel: 6,
      description: levels.map(function (n) {
        if (n < 14)
          return desc(
            "As a reaction, I can halve the damage of an attack from an attacker that I can see"
          );
        return desc(
          "As a reaction, I can halve the damage of an attack from an attacker that I can see and move half my speed without provoking opportunity attacks"
        );
      }),
      action: ["reaction", ""],
    },
    "cunning strike": {
      name: "Cunning Strike",
      source: ["GMB:LL", 0],
      minlevel: 5,
      description: desc([
        "When I add my Sneak Attack bonus to a damage roll, I can forgo some of the bonus to use a Devious Exploit I know without expending an Exploit Die, with the following rules:",
        "\u2022 It must be a Devious Exploit that I know that can be used as part of a weapon attack",
        "\u2022 I reduce my Sneak Attack bonus damage by a number of d6s equal to the Exploit's degree",
        "\u2022 If the Exploit normally deals additional damage, it does not deal any additional damage when used in this way",
      ]),
    },
    evasion: {
      name: "Evasion",
      source: ["GMB:LL", 0],
      minlevel: 9,
      description: desc(
        "My Dexterity saves negate damage on success and halve it on failure"
      ),
      savetxt: {
        text: ["Dex save: fail \u2015 half dmg, success \u2015 no dmg"],
      },
    },
    "reliable talent": {
      name: "Reliable Talent",
      source: ["GMB:LL", 0],
      minlevel: 10,
      description: desc(
        "If I make an ability check where I add my Proficiency Bonus or add my Exploit Die, I can treat a roll of 9 or lower on the d20 as a 10"
      ),
    },
    blindsense: {
      name: "Blindsense",
      source: ["GMB:LL", 0],
      minlevel: 14,
      description: levels.map(function (n) {
        if (n < 14) return "";
        if (n < 17)
          return desc(
            "With my hearing, I can locate hidden or invisible creatures that are within 10 ft of me"
          );
        if (n < 20)
          return desc(
            "With my hearing, I can locate hidden or invisible creatures that are within 20 ft of me"
          );
        return desc(
          "With my hearing, I can locate hidden or invisible creatures that are within 30 ft of me"
        );
      }),
      vision: levels.map(function (n) {
        if (n < 17) return [["Blindsense", 10]];
        return [["Blindsense", 20]];
      }),
    },
    ruthless: {
      name: "Ruthless",
      source: ["GMB:LL", 0],
      minlevel: 11,
      description: desc([
        "When I use a Devious Exploit as a part of an attack that includes my Sneak Attack bonus damage, I can reduce the bonus of another 2d6",
        "If I do, I force my target to make its saving throw with disadvantage",
        "I can use this feature and Cunning Strike as part of the same attack",
      ]),
    },
    "slippery mind": {
      name: "Slippery Mind",
      source: ["GMB:LL", 0],
      minlevel: 15,
      description: desc(
        "I can add one roll of my Exploit Die to any Intelligence, Wisdom or Charisma saving throw"
      ),
      savetxt: { text: ["Add Expl Die to Int, Wis, and Cha saves"] },
    },
    elusive: {
      name: "Elusive",
      source: ["GMB:LL", 0],
      minlevel: 18,
      description: desc(
        "Attackers cannot gain advantage on attacks vs. me, unless I am incapacitated"
      ),
    },
    "stroke of luck": {
      name: "Stroke of Luck",
      source: ["GMB:LL", 0],
      minlevel: 20,
      description: desc(
        "I can turn any roll on the d20 into a natural 20. I can do so after I know the result of my roll and whether I succeed or fail."
      ),
      recovery: "short rest",
      usages: 1,
      vision: [["Blindsense", 30]],
    },
  },
};

// Alternate Monk class
ClassList["monk(laserllama)"] = {
  name: "Monk(Laserllama)",
  regExpSearch: /^(?=.*monk)(?=.*laserllama).*$/i,
  source: ["GMB:LL", 0],
  primaryAbility: "Dexterity and Wisdom",
  abilitySave: 5,
  prereqs: "Dexterity 13 and Wisdom 13",
  die: 10,
  improvements: [0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 5, 5],
  saves: ["Str", "Dex"],
  toolProfs: {
    primary: [["Artisan's tool or musical instrument", 1]]
  },
  skillstxt: {
    primary: "Choose two from Acrobatics, Athletics, History, Insight, Nature, Religion, and Stealth"
  },
  armorProfs: {
    primary: [false, false, false, false],
  },
  weaponProfs: {
    primary: [true, false, ["shortsword"]],
    secondary: [true, false, ["shortsword"]]
  },
  equipment: "Monk starting equipment:" +
    "\n \u2022 A shortsword -or- any simple weapon;" +
    "\n \u2022 A shortbow and 20 arrows -or- 20 darts;" +
    "\n \u2022 A dungeoneer's pack -or- an explorer's pack;" +
    "\n \u2022 A holy symbol -or- a musical instrument." +
    "\n\nAlternatively, choose 5d4 gp worth of starting equipment instead of both the class' and the background's starting equipment.",
  subclasses: ["Monastic Tradition", []],
  attacks: [1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
  features: {
    "unarmored defense": {
      name: "Unarmored Defense",
      source: ["GMB:LL"],
      minlevel: 1,
      description: desc("Without armor and no shield, my AC is 10 + Dexterity modifier + Wisdom modifier"),
      armorOptions: [{
        regExpSearch: /justToAddToDropDown/,
        name: "Unarmored Defense (Wis)",
        source: ["GMB:LL"],
        ac: "10+Wis",
        affectsWildShape: true
      }],
      armorAdd: "Unarmored Defense (Wis)"
    },
    "martial arts": {
      name: "Martial Arts",
      source: ["GMB:LL"],
      minlevel: 1,
      description: desc([
        "Monk weapons: any melee weapon (not special/heavy) or unarmed strike",
        "With monk weapons, I can use Dex instead of Str and use the Martial Arts damage die",
        "When taking an Attack action with these, I get one unarmed strike as a bonus action",
        "I can replace Strength (Athletics) checks to grapple/shove with Dexterity (Athletics) checks"
      ]),
      weaponsAdd: ["Unarmed Strike"],
      addMod: [
        { type: "skill", field: "Athletics", mod: "max(Dex-Str|0)", text: "I can replace Strength (Athletics) checks to grapple/shove with Dexterity (Athletics) checks" }
      ],
      additional: levels.map(function (n) {
        return "1d" + (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);
      }),
      action: [["bonus action", "Unarmed Strike (with Attack action)"]],
      eval: function () {
        AddString('Extra.Notes', 'Monk features:\n\u25C6 If I wear armor/shield, I lose Unarmored Defense, Martial Arts, and Unarmored Movement');
        show3rdPageNotes();
      },
      removeeval: function () {
        RemoveString('Extra.Notes', 'Monk features:\n\u25C6 If I wear armor/shield, I lose Unarmored Defense, Martial Arts, and Unarmored Movement');
      },
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (classes.known["monk(laserllama)"] && classes.known["monk(laserllama)"].level && (v.theWea.monkweapon || v.baseWeaponName == "unarmed strike" || (v.isMeleeWeapon && (/simple|martial/i).test(v.theWea.type) && !(/heavy|special/i).test(fields.Description)))) {
              v.theWea.monkweapon = true;
              var aMonkDie = function (n) { return n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12; }(classes.known["monk(laserllama)"].level);
              try {
                var curDie = eval_ish(fields.Damage_Die.replace('d', '*'));
              } catch (e) {
                var curDie = 'x';
              };
              if (isNaN(curDie) || curDie < aMonkDie) {
                fields.Damage_Die = '1d' + aMonkDie;
              };
              if (fields.Mod === 1 || fields.Mod === 2 || What(AbilityScores.abbreviations[fields.Mod - 1] + " Mod") < What(AbilityScores.abbreviations[v.StrDex - 1] + " Mod")) {
                fields.Mod = v.StrDex;
              }
            };
          },
          "I can use either Strength or Dexterity and my Martial Arts damage die in place of the normal damage die for any 'Monk Weapons', which include unarmed strikes and any melee weapon that is not heavy or has the 'special' property.",
          5
        ]
      }
    },
    "mystic techniques": {
      name: "Mystic Techniques",
      source: ["GMB:LL"],
      minlevel: 2,
      description: desc([
        "I can spend ki points to fuel special actions (see third page)",
        "I need to meditate for at least 30 min of a short rest for that short rest to restore ki",
        "I also learn techniques and can replace them when I gain a monk level (use \"Choose Feature\")",
        "I can only use one Technique per each attack, ability check, or saving throw"
      ]),
      extraname: "Mystic Techniques",
      extraTimes: ['', 3, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9, 9, 10, 10, 10],
      extrachoices: [
        // No prereq - Level 1+ techniques
        "Arresting Strike", "Dazing Strike", "Deflect Strike", "Empowered Strike",
        "Crippling Strike", "Enhanced Grip", "Improvised Strikes", "Mystic Regeneration",
        "Patient Defense", "Slow Fall", "Step of the Wind", "Probing Strike", "Spiritual Armor",
        "Divine Light", "Typhoon Strike",

        // prereq: monk level 5+
        "Deflect Missile", "Gentling Touch", "Seeking Strike", "Slowing Strike", "Stunning Strike",

        // prereq: monk level 5+ & max one from this list
        "Warrior Adept (Archery)", "Warrior Adept (Blind Warrior)", "Warrior Adept (Defense)",
        "Warrior Adept (Dueling)", "Warrior Adept (Featherweight)", "Warrior Adept (Thrown)",
        "Warrior Adept (Wrestler)",

        // prereq: monk level 5+
        "Burning Blade", "Crushing Strike", "Envenomed Strike", "Gale Rush", "Impairing Strike",

        // prereq: monk level 9+
        "Aura Sight", "Heavenly Step", "Indomitable Spirit", "Mantle of Courtesy",

        // prereq: monk level 9+  
        "Commune with Self", "Friend of Beast and Leaf", "Befuddling Strike", "Tremor Strike",

        // prereq: monk level 13+
        "Armor of the Ascetic", "Mystical Integrity", "Tongue of Sun and Moon",

        // prereq: monk level 13+
        "Banishing Strike", "Conjure Previous Life", "Severing Strike",

        // prereq: monk level 18+
        "Empty Body", "Quivering Palm", "Awaken the Third Eye", "Word of Creation"
      ],
      limfeaname: "Ki Points",
      usages: "Monk level + Wisdom modifier per ",
      // kiwarriorfeat = CurrentFeats.known.includes("ki warrior") ? 2 : 0
      // See for reference: https://canary.discord.com/channels/533350585706217494/863810547584467004/1267406407364509737 
      usagescalc: "kiwarriorfeat = 0;"
        + "for (var i = 0; i < CurrentFeats.known.length; i++) { if (CurrentFeats.known[i] == 'ki warrior') kiwarriorfeat = 2 }"
        + "event.value = Number(classes.known['monk(laserllama)'].level) + Number(What('Wis Mod')) + Number(kiwarriorfeat);",
      recovery: "short rest",
      "flurry of blows": {
        name: "Flurry of Blows",
        extraname: "Mystic Technique",
        source: ["GMB:LL"],
        description: desc("After taking the Attack action and make a Martial Arts attack, I can make 2 unarmed attacks as a bonus action"),
        additional: "1 ki point",
        action: ["bonus action", " (after Martial Arts attack)"]
      },
      "arresting strike": {
        name: "Arresting Strike",
        extraname: "Mystic Technique",
        source: ["GMB:LL"],
        description: desc("Once per turn, on hit with melee Martial Arts attack, target makes Dex save or has speed reduced to 0 until the start of my next turn"),
        additional: "1 ki point",
        isOpenHand: true, // for open hand techniques
      },
      "crippling strike": {
        name: "Crippling Strike",
        extraname: "Mystic Technique",
        source: ["GMB:LL"],
        description: desc("Once per turn, on hit with melee Martial Arts attack, target makes Con save or it is Blinded, Deafened, or unable to speak (my choice) until the start of my next turn"),
        additional: "1 ki point",
        isOpenHand: true, // for open hand techniques
      },
      "dazing strike": {
        name: "Dazing Strike",
        extraname: "Mystic Technique",
        source: ["GMB:LL"],
        description: desc("Once per turn, on hit with melee Martial Arts attack, target makes Wis save or subtract 1d4 from the first check, attack, or save it makes before start of my next turn"),
        additional: "1 ki point",
        isOpenHand: true, // for open hand techniques
      },
      "deflect strike": {
        name: "Deflect Strike",
        extraname: "Mystic Technique",
        source: ["GMB:LL"],
        description: levels.map(function (n) {
          if (n < 11) {
            return desc([
              "As a reaction, I can reduce melee weapon attack damage done to me",
              "If the damage is negated, I can make one unarmed strike against the attacker as part of the same reaction"
            ])
          } else {
            return desc([
              "As a reaction, I can reduce melee weapon attack damage done to me",
              "If the damage is negated, I can make one unarmed strike against the attacker as part of the same reaction",
              "I can also deflect melee spell attack"
            ])
          }
        }),
        action: ["reaction", ""],
        additional: levels.map(function (n) {
          return "1d" + (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12) + " + " + n + " + Dex mod; 1 ki to deflect";
        }),
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 1; },
      },
      "empowered strike": {
        name: "Empowered Strike",
        extraname: "Mystic Technique",
        source: ["GMB:LL"],
        description: desc("On hit with melee Martial Arts attack, target makes Str save (adv. if larger than me) or is pushed in a straight line by 5 ft times my Wis mod (min 5ft) and falls prone. A creature at least larger than you has advantage on the saving throw."),
        additional: "1 ki point",
        isOpenHand: true, // for open hand techniques
      },
      "enhanced grip": {
        name: "Enhanced Grip",
        extraname: "Mystic Technique",
        source: ["GMB:LL"],
        description: desc(
          "Each time a creature starts its turn Grappled by me it takes bludgeoning damage equal to my Martial Arts Die. I can also drag Grappled creatures up to my full speed."),
      },
      "improvised strikes": {
        name: "Improvised Strikes",
        extraname: "Mystic Technique",
        source: ["GMB:LL"],
        weaponProfs: [false, false, ["improvised weapons"]],
        description: desc(
          "I gain proficiency with improvised weapons. My attacks with improvised weapons count as Martial Arts attacks."),
      },
      "mystic regeneration": {
        name: "Mystic Regeneration",
        extraname: "Mystic Technique",
        source: ["GMB:LL"],
        description: levels.map(function (n) {
          var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);

          return desc("As an action, I regain HP equal to 1d" + MartArtDie + " + my Wis mod")
        }),
        additional: "2 ki points",
        action: ["action", ""],
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 1 } // For the Ki Warrior feat
      },
      "patient defense": {
        name: "Patient Defense",
        extraname: "Mystic Technique",
        source: ["GMB:LL"],
        description: desc("As a bonus action, I can take the Dodge action"),
        action: ["bonus action", ""],
        additional: "1 ki point",
      },
      "slow fall": {
        name: "Slow Fall",
        extraname: "Mystic Technique",
        source: ["GMB:LL"],
        description: desc("As long as I am conscious, I can reduce any falling damage I would take by five times my level")
      },
      "step of the wind": {
        name: "Step of the Wind",
        extraname: "Mystic Technique",
        source: ["GMB:LL"],
        description: desc("As a bonus action, I can either Dash or Disengage; My jump distance doubles when I do so"),
        action: ["bonus action", ""]
      },
      "typhoon strike": {
        name: "Typhoon Strike",
        extraname: "Mystic Technique",
        source: ["GMB:LL"],
        description: desc("All creatures within reach of my unarmed strike or melee Martial Arts weapon I'm wielding must succeed a Dex save or take damage equal my Martial Art Die + my Dex mod"),
        additional: "1 ki point",
      },
      "probing strike": {
        name: "Probing Strike",
        extraname: "Mystic Technique",
        source: ["GMB:LL"],
        description: desc("Whenever I hit a creature with an unarmed strike, I can learn one characteristic from the following: Armor Class, Condition Immunities, Damage Resistances & Immunities, Highest Ability Score, Lowest Ability Score, or One Special Feature (Spellcasting, Exploits, etc.)."),
        isOpenHand: true, // for open hand techniques
      },
      "spiritual armor": {
        name: "Spiritual Armor",
        extraname: "Mystic Technique",
        source: ["GMB:LL"],
        description: desc(["As a bonus action, I gain temp HP equal to my Wis mod (min of 1)",
          "The first time a creature reduces those temp HP, I can use my reaction to deal it 1 Martial Arts Die force dmg"]),
        additional: "1 ki point",
        action: ["bonus action", ""],
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 1 } // For the Ki Warrior feat
      },
      "divine light": {
        name: "Divine Light",
        source: ["GMB:LL"],
        description: desc(["I learn two cantrips from the Cleric spell list and can cast them using Wisdom"]),
        spellcastingBonus: {
          name: "Divine Light Monk Technique",
          spellcastingAbility: 5,
          'class': 'cleric',
          level: [0, 0],
          firstCol: "atwill",
          times: 2
        },
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 1; },
      },
      // 5th Level Monk
      "deflect missile": {
        name: "Deflect Missile",
        source: ["GMB:LL"],
        description: levels.map(function (n) {
          if (n < 11) {
            return desc([
              "As a reaction, I can reduce ranged weapon attack damage done to me",
              "If the damage is negated, I catch and may throw it back (20/60 ft) as a monk weapon"
            ])
          } else {
            return desc([
              "As a reaction, I can reduce ranged weapon attack damage done to me",
              "If the damage is negated, I catch and may throw it back (20/60 ft) as a monk weapon",
              "I can also spend 1 Ki to use this reaction whenever I am hit by a spell attack"
            ])
          }
        }),
        action: ["reaction", ""],
        additional: levels.map(function (n) {
          return "1d" + (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12) + " + " + n + " + Dex mod; 1 ki to throw";
        }),
        submenu: "[monk level  5+]",
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 5; },
      },
      "gentling touch": {
        name: "Gentling Touch",
        source: ["GMB:LL"],
        description: desc(["In place of an attack, touch a creature and roll five times my martial arts die",
          "If the total is more or equal to their current HP, they fall asleep for 10 min or until woken",
          "I can spend more Ki to add one roll of my Martial Die for each additional Ki spent"]),
        additional: "1 to Wis mod ki points",
        submenu: "[monk level  5+]",
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 5; },
      },
      "seeking strike": {
        name: "Seeking Strike",
        source: ["GMB:LL"],
        description: desc("On miss with a Martial Arts attack, I can reroll the attack roll and must use the new result"),
        additional: "1 ki point",
        submenu: "[monk level  5+]",
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 5; },
        isOpenHand: true, // for open hand techniques
      },
      "slowing strike": {
        name: "Slowing Strike",
        source: ["GMB:LL"],
        description: desc(["On hit with melee Martial Arts attack, target makes Wis save or suffers from Slow spell", "This lasts until the beginning of my next turn and I don't need to concentrate on it"]),
        additional: "1 ki point",
        submenu: "[monk level  5+]",
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 5; },
        isOpenHand: true, // for open hand techniques
      },
      "stunning strike": {
        name: "Stunning Strike",
        source: ["GMB:LL"],
        description: desc(["On hit with melee Martial Arts attack, target makes Con save or is stunned", "This lasts until the beginning of my next turn"]),
        additional: "1 ki point",
        submenu: "[monk level  5+]",
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 5; },
        isOpenHand: true, // for open hand techniques
      },
      "burning blade": {
        name: "Burning Blade",
        source: ["GMB:LL"],
        description: desc("You infuse one melee Martial Arts weapon you holding with burning Ki. For the next minute, the weapon emits bright light in a 30-foot radius and attacks with it deal fire damage so long as you hold it."),
        additional: "1 ki point",
        submenu: "[monk level  5+]",
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 5; },
        isOpenHand: true, // for open hand techniques
      },
      "crushing strike": {
        name: "Crushing Strike",
        source: ["GMB:LL"],
        description: desc(["Once per turn when you hit a target with an unarmed strike, you can spend Ki (up to your Wisdom modifier) to empower it with deadly force. For each Ki you spend, the attack deals additional damage equal to your Martial Arts Die."]),
        additional: "up Wis mod ki points",
        submenu: "[monk level  5+]",
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 5; },
        isOpenHand: true, // for open hand techniques
      },
      "warrior adept (archery)": {
        name: "Warrior Adept (Archery)",
        extraname: "Mystic Technique",
        source: ["GMB:LL"],
        description: desc("+2 bonus to attack rolls I make with ranged weapons"),
        submenu: "[monk level  5+]",
        prereqeval: function (v) {
          techniques = GetFeatureChoice('classes', 'monk(laserllama)', 'mystic techniques', true);

          if (techniques.indexOf("warrior adept (blind warrior)") !== -1) return false;
          if (techniques.indexOf("warrior adept (defense)") !== -1) return false;
          if (techniques.indexOf("warrior adept (dueling)") !== -1) return false;
          if (techniques.indexOf("warrior adept (featherweight)") !== -1) return false;
          if (techniques.indexOf("warrior adept (thrown)") !== -1) return false;
          if (techniques.indexOf("warrior adept (wrestler)") !== -1) return false;

          return (classes.known["monk(laserllama)"].level >= 5)
        },
        calcChanges: {
          atkCalc: [
            function (fields, v, output) {
              if (v.isRangedWeapon && !v.isNaturalWeapon && !v.isDC) output.extraHit += 2;
            },
            "My ranged weapons get a +2 bonus on the To Hit."
          ]
        }
      },
      "warrior adept (blind warrior)": {
        name: "Warrior Adept (Blind Warrior)",
        extraname: "Mystic Technique",
        source: ["GMB:LL"],
        description: desc(["I gain blindsight for a range of 5 times my prof bonus",
          "In that range, I can see invisible creatures and anything that isn't behind total cover or hidden"]),
        submenu: "[monk level  5+]",
        prereqeval: function (v) {
          techniques = GetFeatureChoice('classes', 'monk(laserllama)', 'mystic techniques', true);

          if (techniques.indexOf("warrior adept (archery)") !== -1) return false;
          if (techniques.indexOf("warrior adept (defense)") !== -1) return false;
          if (techniques.indexOf("warrior adept (dueling)") !== -1) return false;
          if (techniques.indexOf("warrior adept (featherweight)") !== -1) return false;
          if (techniques.indexOf("warrior adept (thrown)") !== -1) return false;
          if (techniques.indexOf("warrior adept (wrestler)") !== -1) return false;

          return (classes.known["monk(laserllama)"].level >= 5)
        },
        changeeval: function (lvl, chc) {
          var srcNm = "Blind Warrior Fighting Style";
          var curRange = CurrentProfs.vision.blindsight && CurrentProfs.vision.blindsight.ranges[srcNm];
          var newRange = lvl[1] && Number(How('Proficiency Bonus')) * 5;

          // Only do something if the range changed
          if (curRange !== newRange) {
            // First remove the old range, if any
            if (curRange) SetProf('vision', false, "Blindsight", srcNm, curRange);
            // Then set the new range, unless the feature is removed (i.e. lvl[1] === 0)
            if (newRange) SetProf('vision', true, "Blindsight", srcNm, newRange);
          }
        }
      },
      "warrior adept (defense)": {
        name: "Warrior Adept (Defense)",
        extraname: "Mystic Technique",
        source: ["GMB:LL"],
        description: desc("+1 bonus to AC when I'm wearing armor or wielding a shield"),
        submenu: "[monk level  5+]",
        prereqeval: function (v) {
          techniques = GetFeatureChoice('classes', 'monk(laserllama)', 'mystic techniques', true);

          if (techniques.indexOf("warrior adept (archery)") !== -1) return false;
          if (techniques.indexOf("warrior adept (blind warrior)") !== -1) return false;
          if (techniques.indexOf("warrior adept (dueling)") !== -1) return false;
          if (techniques.indexOf("warrior adept (featherweight)") !== -1) return false;
          if (techniques.indexOf("warrior adept (thrown)") !== -1) return false;
          if (techniques.indexOf("warrior adept (wrestler)") !== -1) return false;

          return (classes.known["monk(laserllama)"].level >= 5)
        },
        extraAC: {
          name: "Defense Fighting Style", // necessary for features referring to fighting style properties directly
          mod: 1,
          text: "I gain a +1 bonus to AC while wearing armor or wielding a shield.",
          stopeval: function (v) { return !v.wearingArmor && !v.usingShield; }
        }
      },
      "warrior adept (dueling)": {
        name: "Warrior Adept (Dueling)",
        extraname: "Mystic Technique",
        source: ["GMB:LL"],
        description: desc("+2 to damage rolls when wielding a melee weapon in one hand and no other weapon"),
        submenu: "[monk level  5+]",
        prereqeval: function (v) {
          techniques = GetFeatureChoice('classes', 'monk(laserllama)', 'mystic techniques', true);

          if (techniques.indexOf("warrior adept (archery)") !== -1) return false;
          if (techniques.indexOf("warrior adept (blind warrior)") !== -1) return false;
          if (techniques.indexOf("warrior adept (defense)") !== -1) return false;
          if (techniques.indexOf("warrior adept (featherweight)") !== -1) return false;
          if (techniques.indexOf("warrior adept (thrown)") !== -1) return false;
          if (techniques.indexOf("warrior adept (wrestler)") !== -1) return false;

          return (classes.known["monk(laserllama)"].level >= 5)
        },
        calcChanges: {
          atkCalc: [
            function (fields, v, output) {
              for (var i = 1; i <= FieldNumbers.actions; i++) {
                if ((/off.hand.attack/i).test(What('Bonus Action ' + i))) return;
              };
              if (v.isMeleeWeapon && !v.isNaturalWeapon && !(/((^|[^+-]\b)2|\btwo).?hand(ed)?s?\b/i).test(fields.Description)) output.extraDmg += 2;
            },
            "When I'm wielding a melee weapon in one hand and no weapon in my other hand, I do +2 damage with that melee weapon. This condition will always be false if the bonus action 'Off-hand Attack' exists."
          ]
        }
      },
      "warrior adept (featherweight)": {
        name: "Warrior Adept (Featherweight)",
        extraname: "Mystic Technique",
        source: ["GMB:LL"],
        description: desc("+1 bonus to damage rolls with light melee weapons and unarmed strikes, and +10 ft to speed when wielding only light weapons and not wearing medium or heavy armor nor shield"),
        submenu: "[monk level  5+]",
        prereqeval: function (v) {
          techniques = GetFeatureChoice('classes', 'monk(laserllama)', 'mystic techniques', true);

          if (techniques.indexOf("warrior adept (archery)") !== -1) return false;
          if (techniques.indexOf("warrior adept (blind warrior)") !== -1) return false;
          if (techniques.indexOf("warrior adept (defense)") !== -1) return false;
          if (techniques.indexOf("warrior adept (dueling)") !== -1) return false;
          if (techniques.indexOf("warrior adept (thrown)") !== -1) return false;
          if (techniques.indexOf("warrior adept (wrestler)") !== -1) return false;

          return (classes.known["monk(laserllama)"].level >= 5)
        },
        calcChanges: {
          atkCalc: [
            function (fields, v, output) {
              if (v.baseWeaponName == "unarmed strike" || (/\blight\b/i).test(fields.Description)) output.extraDmg += 1;
            },
            "When I'm wielding light weapons and not wearing medium or heavy armor nor a shield, I do +1 damage with light weapons and unarmed strikes."
          ]
        },
        speed: {
          allModes: "+10"
        }
      },
      "warrior adept (thrown)": {
        name: "Warrior Adept (Thrown)",
        extraname: "Mystic Technique",
        source: ["GMB:LL"],
        description: desc("+2 bonus to damage rolls with thrown weapons as ranged attack"),
        submenu: "[monk level  5+]",
        prereqeval: function (v) {
          techniques = GetFeatureChoice('classes', 'monk(laserllama)', 'mystic techniques', true);

          if (techniques.indexOf("warrior adept (archery)") !== -1) return false;
          if (techniques.indexOf("warrior adept (blind warrior)") !== -1) return false;
          if (techniques.indexOf("warrior adept (defense)") !== -1) return false;
          if (techniques.indexOf("warrior adept (dueling)") !== -1) return false;
          if (techniques.indexOf("warrior adept (featherweight)") !== -1) return false;
          if (techniques.indexOf("warrior adept (wrestler)") !== -1) return false;

          return (classes.known["monk(laserllama)"].level >= 5)
        },
        calcChanges: {
          atkCalc: [
            function (fields, v, output) {
              if (v.isThrownWeapon) output.extraDmg += 2;
            },
            "My thrown weapons get a +2 bonus damage when thrown."
          ]
        }
      },
      "warrior adept (wrestler)": {
        name: "Warrior Adept (Wrestler)",
        extraname: "Mystic Technique",
        source: ["GMB:LL"],
        description: desc(["When hitting someone on my turn, I can attempt to grapple or shove them as a bonus action",
          "I can drag grappled creatures up to my full speed"]),
        action: ["bonus action", "Grapple or shove (after hitting with Attack action)"],
        submenu: "[monk level  5+]",
        prereqeval: function (v) {
          techniques = GetFeatureChoice('classes', 'monk(laserllama)', 'mystic techniques', true);

          if (techniques.indexOf("warrior adept (archery)") !== -1) return false;
          if (techniques.indexOf("warrior adept (blind warrior)") !== -1) return false;
          if (techniques.indexOf("warrior adept (defense)") !== -1) return false;
          if (techniques.indexOf("warrior adept (dueling)") !== -1) return false;
          if (techniques.indexOf("warrior adept (featherweight)") !== -1) return false;
          if (techniques.indexOf("warrior adept (thrown)") !== -1) return false;

          return (classes.known["monk(laserllama)"].level >= 5)
        }
      },
      "envenomed strike": {
        name: "Envenomed Strike",
        source: ["GMB:LL"],
        description: levels.map(function (n) {
          return desc(["Once per turn when you hit a creature with a melee Martial Arts attack, you can spend 1 Ki to deal bonus poison damage equal to your Martial Arts Die and force the target to make a Constitution saving throw. On a failure, it is Poisoned until the beginning of your next turn."])
        }),
        additional: "1 ki point",
        submenu: "[monk level  5+]",
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 5; },
        isOpenHand: true, // for open hand techniques
      },
      "gale rush": {
        name: "Gale Rush",
        source: ["GMB:LL"],
        description: desc(["As an action, you spend Ki (up to your Wisdom modifier) and focus it into your palm. For each Ki spent, you move up to 10 feet in a straight line and force one target at the end of this movement to make a Dexterity saving throw.",
          "On a failure, it takes thunder damage equal to one Martial Arts Die per Ki spent and is knocked Prone. On a successful save, it takes half as much damage and does not fall Prone."]),
        additional: "up to Wis mod ki points",
        submenu: "[monk level  5+]",
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 5; },
      },
      "impairing strike": {
        name: "Impairing Strike",
        source: ["GMB:LL"],
        description: levels.map(function (n) {
          return desc(["Once per turn when you hit a creature with a melee Martial Arts attack, you can spend 1 Ki to strategically cripple its Ki flow, forcing it to make a Charisma saving throw. On a failed save, choose one of the target's ability scores.",
            "Until the start of your next turn, it has disadvantage on allability checks, attack rolls, and saving throws with that ability score, and attacks or spells cast with it deal half damage."
          ])
        }),
        additional: "1 ki point",
        submenu: "[monk level  5+]",
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 5; },
      },
      //9th Level Monk
      "aura sight": {
        name: "Aura Sight",
        source: ["GMB:LL"],
        description: levels.map(function (n) {
          var newRange = n < 13 ? 20 : n < 18 ? 30 : 60;
          descr = ["I gain " + newRange + " ft blindsight and can see anything that isn't behind total cover within that range",
            "I can see invisible creatures within range unless the creature successfully hides from me"]
          return desc(descr);
        }),
        submenu: "[monk level  9+]",
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 9; },
        changeeval: function (lvl, chc) {
          var srcNm = "Aura Sight Monk Technique";
          var curRange = CurrentProfs.vision.blindsight && CurrentProfs.vision.blindsight.ranges[srcNm];
          var newRange = lvl[1] < 13 ? 20 : lvl[1] < 18 ? 30 : 60;

          // Only do something if the range changed
          if (curRange !== newRange) {
            // First remove the old range, if any
            if (curRange) SetProf('vision', false, "Blindsight", srcNm, curRange);
            // Then set the new range, unless the feature is removed (i.e. lvl[1] === 0)
            if (newRange) SetProf('vision', true, "Blindsight", srcNm, newRange);
          }
        }
      },
      "heavenly step": {
        name: "Heavenly Step",
        source: ["GMB:LL"],
        description: desc(["I can move along vertical surfaces, across liquids, and upside down on ceilings without falling during the move",
          "If I end my movement on a vertical surface, liquid, or upside down on a ceiling, I can spend 1 Ki Point to remain in place without falling until the start of my next turn"]),
        submenu: "[monk level  9+]",
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 9; },
      },
      "indomitable spirit": {
        name: "Indomitable Spirit",
        source: ["GMB:LL"],
        description: desc(["Add my Wis mod (min 1) to a Strength (Athletics) or Dexterity (Athletics) check",
          "I can use this Technique after I roll, but before I know if my roll succeeds or fails"]),
        additional: "1 ki point",
        submenu: "[monk level  9+]",
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 9; },
        isOpenHand: true, // for open hand techniques
      },
      "mantle of courtesy": {
        name: "Mantle of Courtesy",
        source: ["GMB:LL"],
        description: desc(["I gain proficiency in Persuasion and can add my Wis mod (min 1) to Cha (Persuasion) checks"]),
        submenu: "[monk level  9+]",
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 9; },
        skills: ["Persuasion"],
        addMod: { type: "skill", field: "Persuasion", mod: "max(Wis|1)", text: "I can add my Wis mod (min 1) to Cha (Persuasion) checks" }
      },
      "ascetic fortitude": {
        name: "Ascetic Fortitude",
        source: ["GMB:LL"],
        description: levels.map(function (n) {
          return desc(["As a reaction when taking damage, reduce the damage by 2d" + (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12) + " + my Wis mod"])
        }),
        additional: "2 ki points",
        submenu: "[monk level  9+]",
        action: ["reaction", ""],
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 9; },
      },
      "befuddling strike": {
        name: "Befuddling Strike",
        source: ["GMB:LL"],
        description: desc(["Once per turn when you hit a creature with a melee Martial Arts attack, you can spend 1 Ki to assault its nervous system, forcing it to make an Intelligence saving throw. On a failure, it is Incapacitated until the beginning of your next turn."]),
        submenu: "[monk level  9+]",
        additional: "1 ki point",
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 9; },
        isOpenHand: true, // for open hand techniques
      },
      "commune with self": {
        name: "Commune with Self",
        source: ["GMB:LL"],
        description: desc(["I can meditate for 10 min to gain the benefits of the commune spell"]),
        additional: "5 ki points",
        submenu: "[monk level  9+]",
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 9; },
        spellcastingBonus: {
          name: "Commune with Self",
          spells: ["commune"],
          selection: ["commune"],
          firstCol: 5
        },
        spellFirstColTitle: "Ki",
        spellChanges: {
          "commune": {
            time: "10 min",
            changes: "I can meditate for 10 min to gain the benefits of the commune spell"
          }
        }
      },
      "friend of beast and leaf": { // '&' is an invalid character here
        name: "Friend of Beast and Leaf",
        source: ["GMB:LL"],
        description: desc(["I can meditate for 10 min to gain the benefits of the commune with nature spell"]),
        additional: "5 ki points",
        submenu: "[monk level  9+]",
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 9; },
        spellcastingBonus: {
          name: "Friend of Beast and Leaf",
          spells: ["commune with nature"],
          selection: ["commune with nature"],
          firstCol: 5
        },
        spellFirstColTitle: "Ki",
        spellChanges: {
          "commune with nature": {
            time: "10 min",
            changes: "I can meditate for 10 min to gain the benefits of the commune with nature spell"
          }
        }
      },
      "tremor strike": {
        name: "Tremor Strike",
        source: ["GMB:LL"],
        description: desc(["As an action, you can spend Ki (up to your Wis mod) and strike the ground, destroying an adjacent 25-foot cone of earth along the ground, forcing creatures to make a Strength saving throw. On a failure, targets take bludgeoning damage equal to a Martial Arts Die per Ki spent and fall Prone. On a success, they take half damage and do not fall Prone.",
          "Structures in this area take the maximum damage, and the area of this Technique becomes difficult terrain until cleared."
        ]),
        submenu: "[monk level  9+]",
        additional: "up to Wis mod ki points",
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 9; },
      },
      //13th Level Monk
      "armor of the ascetic": {
        name: "Armor of the Ascetic",
        source: ["GMB:LL"],
        description: desc(["At the end of a short or long rest, I gain the effects of sanctuary spell",
          "This lasts until the start of my next short or long rest and can end early as normal"]),
        submenu: "[monk level 13+]",
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 13; },
        recovery: "short rest",
        usages: 1,
        spellcastingBonus: {
          name: "Armor of the Ascetic",
          spells: ["sanctuary"],
          selection: ["sanctuary"],
          firstCol: "oncesr"
        },
        spellChanges: {
          "sanctuary": {
            range: "Self",
            time: "-",
            components: "-",
            duration: "Until rest",
            changes: "At the end of a short or long rest, I gain the effects of sanctuary spell; This lasts until the start of my next short or long rest and can end early as normal"
          }
        }
      },
      "mystical integrity": {
        name: "Mystical Integrity",
        source: ["GMB:LL"],
        description: desc(["I am immune to any spell or effect that would alter my form or force me to teleport, unless I wish to be affected"]),
        submenu: "[monk level 13+]",
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 13; },
        savetxt: { immune: ["forced teleportation", "form alterations"] }
      },
      "tongue of sun and moon": { // '&' is an invalid character here
        name: "Tongue of Sun and Moon",
        source: ["GMB:LL"],
        description: desc(["I can touch the Ki of other minds and communicate with any creature that speaks a language",
          "Creatures that speak no languages can communicate and understand simple ideas"]),
        submenu: "[monk level 13+]",
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 13; }
      },
      "banishing strike": {
        name: "Banishing Strike",
        source: ["GMB:LL"],
        description: levels.map(function (n) {
          return desc(["On hit with melee Martial Arts attack, target makes Cha save or takes 3d" + (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12) + " additional force dmg (half on save). If this reduces the target to 50 HP or less, it is shunted to a harmless demiplane where it is incapacitated. The crea reappears in the unoccupied space nearest to the last space it occupied at the end of my next turn."])
        }),
        submenu: "[monk level 13+]",
        additional: "3 ki points",
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 13; },
        isOpenHand: true, // for open hand techniques
      },
      "conjure previous life": {
        name: "Conjure Previous Life",
        source: ["GMB:LL"],
        description: desc(["As an action, I cast a special version of summon celestial (defender) at 5th-level"]),
        submenu: "[monk level 13+]",
        additional: "3 ki points",
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 13; },
        spellcastingBonus: {
          name: "Conjure Previous Life",
          spells: ["summon celestial"],
          selection: ["summon celestial"],
          firstCol: 5
        },
        spellFirstColTitle: "Ki",
        spellChanges: {
          "summon celestial": {
            components: "-",
            description: "Summon Defender celestial; obeys commands; takes turn after mine; disappears at 0 hp (see book)",
            descriptionFull: "You call forth a celestial spirit. It manifests in an angelic form in an unoccupied space that you can see within range. This corporeal form uses the Defender Celestial Spirit stat block with the changes below:"
              + "\n\u2022 It is a Medium creature that resembles a humanoid Monk, though it may not be the same race as you are."
              + "\n\u2022 Its Radiant Mace attacks resemble unarmed strikes"
              + "\n\u2022 When summoned you can infuse it with a number of Ki Points of your choice, and your Ki Point maximum is reduced by the same amount while it is summoned. It can use the infused Ki to use any Techniques you know, though it cannot use conjure previous life again."
              + "\n\nThe creature disappears when it drops to 0 hit points or when the spell ends.\n   The creature is an ally to you and your companions. In combat, the creature shares your initiative count, but it takes its turn immediately after yours. It obeys your verbal commands (no action required by you). If you don't issue any, it takes the Dodge action and uses its move to avoid danger.",
            changes: "As an action, I can spend 5 Ki Points and cast summon celestial (defender) at 5th-level, with special changes"
          }
        }
      },
      "severing strike": {
        name: "Severing Strike",
        source: ["GMB:LL"],
        description: levels.map(function (n) {
          return desc(["Once per turn when you hit a creature with a melee Martial Arts attack, you can forcing it to make a saving throw with its Spellcasting ability. On a failure, it cannot cast or concentrate on spells for 1 minute. It can repeat this saving throw at the end of each of its turns, ending the effect on a success."])
        }),
        submenu: "[monk level 13+]",
        additional: "3 ki points",
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 13; },
        isOpenHand: true, // for open hand techniques
      },
      //18th Level Monk
      "empty body": {
        name: "Empty Body",
        source: ["GMB:LL"],
        description: desc("Be invisible and resist non-force damage for 1 min or cast Astral Projection on self"),
        additional: "Invisible: 4 ki points; Astral Projection: 8 ki points",
        submenu: "[monk level 18+]",
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 18; },
        action: ["bonus action", ""],
        spellcastingBonus: {
          name: "Empty Body",
          spells: ["astral projection"],
          selection: ["astral projection"],
          firstCol: 8
        },
        spellFirstColTitle: "Ki",
        spellChanges: {
          "astral projection": {
            components: "V,S",
            compMaterial: "",
            description: "I project myself to the Astral Plane with identical statistics, see book",
            changes: "I can spend 8 ki points to cast Astral Projection without requiring material components, although I can't bring other creatures with me."
          }
        }
      },
      "quivering palm": {
        name: "Quivering Palm",
        source: ["GMB:LL"],
        description: levels.map(function (n) {
          descr = [
            "On hit with a melee Martial Arts attack, infuse target's soul with vibrations that last up to " + n + " days",
            "While me and the target are on the same plane of existence, I can use an action to end the vibrations and force the target to make a Con save",
            "It is reduced to 0 HP on a fail and takes 10d10 necrotic damage on a success",
            "I can only have one target at a time, using it on a second target ends it harmlessly for the first"]
          return desc(descr);
        }),
        additional: "5 ki points",
        action: ["action", " (end vibrations)"],
        submenu: "[monk level 18+]",
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 18; },
        isOpenHand: true, // for open hand techniques
      },
      "awaken the third eye": {
        name: "Awaken the Third Eye",
        source: ["GMB:LL"],
        description: desc("Spend 1 min to cast Foresight on myself; This reduces my max Ki by 8 while active"),
        additional: "8 ki points",
        submenu: "[monk level 18+]",
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 18; },
        spellcastingBonus: {
          name: "Empty Body",
          spells: ["foresight"],
          selection: ["foresight"],
          firstCol: 8
        },
        spellFirstColTitle: "Ki",
        spellChanges: {
          "foresight": {
            range: "Self",
            components: "-",
            description: "I can end this effect as an action",
            changes: "I can cast Foresight on myself"
          }
        }
      },
      "word of creation": {
        name: "Word of Creation",
        source: ["GMB:LL"],
        description: desc("As an action, cast Divine Word; I can only do this once per short rest"),
        additional: "7 ki points",
        submenu: "[monk level 18+]",
        prereqeval: function (v) { return classes.known["monk(laserllama)"].level >= 18; },
        spellcastingBonus: {
          name: "Word of Creation",
          spells: ["divine word"],
          selection: ["divine word"],
          firstCol: 7
        },
        spellFirstColTitle: "Ki",
        spellChanges: {
          "divine word": {
            components: "-",
            time: "1 a",
            changes: "As an action, I can spend 7 Ki Points to cast divine word, using Wisdom as my spellcasting modifier"
          }
        },
        recovery: "short rest",
        usages: 1
      },
      autoSelectExtrachoices: [{ extrachoice: "flurry of blows" }]
    },
    "unarmored movement": {
      name: "Unarmored Movement",
      source: ["GMB:LL"],
      minlevel: 2,
      description: levels.map(function (n) {
        if (n < 2) return "";
        var spd = "My speed increases by " + (n < 6 ? 10 : n < 10 ? 15 : n < 14 ? 20 : n < 18 ? 25 : 30) + " ft";
        return desc(spd);
      }),
      changeeval: function (v) {
        var monkSpd = '+' + (v[1] < 2 ? 0 : v[1] < 6 ? 10 : v[1] < 10 ? 15 : v[1] < 14 ? 20 : v[1] < 18 ? 25 : 30);
        SetProf('speed', monkSpd !== '+0', { allModes: monkSpd }, "Monk: Unarmored Movement");
      }
    },
    "subclassfeature3": {
      name: "Monastic Tradition",
      source: ["GMB:LL"],
      minlevel: 3,
      description: desc('Choose a Monastic Tradition to commit to and put it in the "Class" field ')
    },
    "enlightened strikes": {
      name: "Enlightened Strikes",
      source: ["GMB:LL"],
      minlevel: 6,
      description: desc(
        "My unarmed strikes count as magical for overcoming resistances and immunities" +
        "\n   My other Martial Arts attacks is also magic so long as I have Ki remainig"),
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (v.baseWeaponName == "unarmed strike" && !v.thisWeapon[1] && !v.theWea.isMagicWeapon && !(/counts as( a)? magical/i).test(fields.Description)) {
              fields.Description += (fields.Description ? '; ' : '') + 'Counts as magical';
            };
          },
          "My unarmed strikes count as magical for overcoming resistances and immunities."
        ]
      }
    },
    "evasion": {
      name: "Evasion",
      source: ["GMB:LL"],
      minlevel: 7,
      description: desc("My Dexterity saves vs. areas of effect negate damage on success and halve it on failure"),
      savetxt: { text: ["Dex save vs. area effects: fail \u2015 half dmg, success \u2015 no dmg"] }
    },
    "spirit of tranquility": {
      name: "Spirit of Tranquility",
      source: ["GMB:LL"],
      minlevel: 9,
      description: desc("When forced to make a save, I can expend 1 Ki Poit to add my Wis mod to it (min of +1)")
    },
    "warrior's spirit": {
      name: "Warrior's Spirit",
      source: ["GMB:LL"],
      minlevel: 11,
      description: levels.map(function (n) {
        if (n < 11) return "";
        var ws = "I regain " + (n < 10 ? 1 : 2) + " expended Ki at the start of each of my turns in combat, so long as I am not Incapacitated";
        return desc(ws);
      }),
    },
    "purity of body": {
      name: "Purity of Body",
      source: ["GMB:LL"],
      minlevel: 13,
      description: desc("I gain proficiency in Con saving throws; I am immune to the poisoned condition and all disease"),
      savetxt: { immune: ["poisoned", "disease"] },
      saves: ["Con"]
    },
    "purity of mind": {
      name: "Purity of Mind",
      source: ["GMB:LL"],
      minlevel: 14,
      description: desc("At the beginning of my turn, I can spend 1 Ki to end either the charmed or frightened condition on myself"),
      additional: "1 ki point"
    },
    "timeless body": {
      name: "Timeless Body",
      source: ["GMB:LL"],
      minlevel: 15,
      description: desc(["I don't require food or water; I don't suffer age penalties", "For every 10 years that pass my physical body only ages 1 year"])
    },
    "purity of spirit": {
      name: "Purity of Spirit",
      source: ["GMB:LL"],
      minlevel: 20,
      description: desc("I only need 1 minute of light activity to complete a short rest and regain Ki, instead of 1 hour" +
        "\n     When I roll initiative, I regain Ki equal to my Wis mod (min of 1)")
    }
  }
}


// Warlord class
ClassList["warlord(laserllama)"] = {
  name: "Warlord(LaserLlama)",
  regExpSearch: /^(?=.*warlord)(?=.*laserllama).*$/i,
  source: ["GMB:LL", 0],
  primaryAbility: "Strength or Dexterity",
  prereqs:
    "Strength 13 or Dexterity 13 and Intelligence 13, Wisdom 13 or Charisma 13",
  die: 8,
  improvements: [0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 5, 5],
  saves: ["Wis", "Cha"],
  skillstxt: {
    primary:
      "Choose two from Athletics, Deception, History, Insight, Intimidation, Investigation and Persuasion.",
  },
  toolProfs: {
    primary: [["Gaming Set", 1]],
    secondary: [["Gaming Set", 1]],
  },
  armorProfs: {
    // the 4 entries are for: ["light", "medium", "heavy", "shields"]
    primary: [true, true, false, true], // the armor proficiencies if this is the first or only class
    secondary: [true, true, false, true], // the armor proficiencies if this class is multiclassed with (so not taken at level 1, but later)
  },
  weaponProfs: {
    primary: [
      true,
      false,
      [
        "hand crossbow",
        "longbow",
        "longsword",
        "rapier",
        "scimitar",
        "shortsword",
      ],
    ],
    secondary: [true, false],
  },
  equipment:
    "Warlord starting equipment:" +
    "\n \u2022 scale mail -or- leather armor;" +
    "\n \u2022 simple weapon -or- lonsword -or- rapier;" +
    "\n \u2022 light crossbow and 20 bolts -or- five javelins;" +
    "\n \u2022 a scholar’s pack -or- an explorer’s pack;" +
    "\n\nAlternatively, choose 5d4 x 10 gp worth of starting equipment instead of both the class' and the background's starting equipment.",
  subclasses: [
    "Academy of War",
    [
    ],
  ],
  attacks: [1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
  abilitySave: 1, // Warlord uses Strength or Dex for foes' saving throws
  abilitySaveAlt: 2,
  spellcastingFactor: "warlock99", // Required for the "create a complete spell sheet" option; using the warlock option ensures it doesn't clash with multiclassing
  features: {
    "leadership style": {
      name: "Leadership Style",
      source: [["GMB:LL", 0]],
      minlevel: 1,
      description: desc([
        "Choose a Leadership Style for the warlord using the 'Choose Feature' button above",
      ]),
      choices: ["Captain", "Mentor", "Strategist"],
      captain: {
        name: "Captain Leadership Style",
        description: desc([
          "Charisma is my Leadership Modifier",
          "I gain proficiency in heavy armor",
          "I also gain proficiency in Intimidation or Persuasion (my choice)",
        ]),
        skillstxt: "Choose one from Intimidation or Persuasion",
        abilitySave: 6,
        armorProfs: [true, true, true, true],
      },
      mentor: {
        name: "Mentor Leadership Style",
        description: desc([
          "Wisdom is my Leadership Modifier",
          "When a creature within 15 ft fails an attack or ability check, I can use my reaction to add 1d4",
        ]),
        action: [["reaction", ""]],
        abilitySave: 5,
      },
      strategist: {
        name: "Strategist Leadership Style",
        description: desc([
          "Intelligence is my Leadership Modifier",
          "After I roll initiative, I can swap initiative with a willing creature",
        ]),
        abilitySave: 4,
      },
      choiceDependencies: [
        {
          feature: "valiant leader"
        },
        {
          feature: "exalted leader"
        },
        {
          feature: "subclassfeature6.11"
        },
        {
          feature: "subclassfeature3.33"
        },
        {
          feature: "subclassfeature3.29"
        }
      ]
    },

    "inspiring word": {
      name: "Inspiring Word",
      source: [["GMB:LL", 0]],
      minlevel: 1,
      description: desc([
        "As a bonus action, I can heal a creature within 30 feet that can hear me of its Hit Die + Lead mod (It does not expend its Hit Die)",
      ]),
      action: [["bonus action", ""]],
      usages: levels.map(function (n) {
        return n < 4 ? 3 : n < 8 ? 4 : n < 13 ? 5 : n < 13 ? 6 : 7;
      }),
      recovery: "short rest",
    },

    "fighting style": {
      name: "Fighting Style",
      source: [["GMB:LL", 0]],
      minlevel: 2,
      description: levels.map(function (n) {
        const numStyles = n < 6 ? 1 : n < 12 ? 2 : n < 18 ? 3 : 4;
        return desc([
          "Choose " +
          numStyles +
          " Fighting Style" +
          (numStyles > 1 ? "s" : "") +
          ' for the fighter using the "Choose Feature" button above',
        ]);
      }),
      extraTimes: levels.map(function (n) {
        if (n < 6) return 1; // Livello 1: 1 stile
        if (n < 12) return 2; // Livello 6: 2 stili
        if (n < 18) return 3; // Livello 12: 3 stili
        return 4; // Livello 18: 4 stili
      }),
      extraname: "Warlord Fighting Styles",
      extrachoices: [
        "Archery",
        "Balanced",
        "Brawling",
        "Classical Swordplay",
        "Defensive",
        "Mounted Warrior",
        "Protection",
        "Strongbow",
        "Versatile Fighting",
        "Mariner",
        "Mountaineer",
        "Shield Warrior",
        "Standard Bearer",
        "Tactical Fighting"
      ],
      archery: FightingStylesLL.archery,
      balanced: FightingStylesLL.balanced,
      brawling: FightingStylesLL.brawling,
      "classical swordplay": FightingStylesLL.classical,
      defensive: FightingStylesLL.defensive,
      protection: FightingStylesLL.protection,
      "mounted warrior": FightingStylesLL.mounted,
      strongbow: FightingStylesLL.strongbow,
      "versatile fighting": FightingStylesLL.versatile,
      mariner: FightingStylesLL.mariner,
      mountaineer: FightingStylesLL.mountaineer,
      "shield warrior": FightingStylesLL.shieldwarrior,
      "standard bearer": FightingStylesLL.standardbearer,
      "tactical fighting": FightingStylesLL.tactical
    },
    "tactical exploits": (function () {
      // Fixed attributes
      TacticalExploits = {
        name: "Tactical Exploits",
        minlevel: 2,
        source: [["GMB:LL", 0]],
        description: desc([
          "I gain Exploit Dice, which are used to fuel my Tactical Exploits",
          'Use the "Choose Feature" button above to choose Tactical Exploits',
        ]),
        toNotesPage: [
          {
            name: "Tactical Exploits",
            note: desc([
              "Below are all Tactical Exploits I know. Each 3rd and 4th degree exploits can only be used once per short rest. Each 5th degree exploit can only be used once per long rest.",
            ]),
          },
        ],

        // Tactical Exploits
        extraname: "Tactical Exploits",
        extraTimes: [
          "",
          2,
          3,
          3,
          4,
          4,
          5,
          5,
          6,
          6,
          7,
          7,
          8,
          8,
          9,
          9,
          10,
          10,
          10,
          10,
        ],
        extrachoices: [],

        // Exploit dice
        // limfeaname: "Exploit Dice",
        // usages: ["", 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5],
        // additional: [
        //   "",
        //   "d4",
        //   "d4",
        //   "d4",
        //   "d6",
        //   "d6",
        //   "d6",
        //   "d6",
        //   "d6",
        //   "d6",
        //   "d8",
        //   "d8",
        //   "d8",
        //   "d8",
        //   "d8",
        //   "d8",
        //   "d10",
        //   "d10",
        //   "d10",
        //   "d10",
        // ],
        // recovery: "short rest",
      };

      // Make a filtered spell list that contains only Warlord(laserllama) "spells"
      const WarlordSpells = Object.keys(SpellsList)
        .filter((key) => SpellsList[key].isExploit)
        .filter((key) => {
          for (var i = 0; i < SpellsList[key].classes.length; i++) {
            if (SpellsList[key].classes[i] == "warlord(laserllama)")
              return true;
          }
          return false;
          // NOTE: this is literally a SpellsList[key].classes.includes("warlord(laserllama)") but for some cursed reason I can't use that function
        });

      // Iterate over all Warlord(laserllama) "spells"
      for (var i = 0; i < WarlordSpells.length; i++) {
        var NewSpell = SpellsList[WarlordSpells[i]];
        var tempSpell = WarlordSpells[i];

        TacticalExploits.extrachoices.push(NewSpell.name); // Add "spell" name to menu options

        TacticalExploits[WarlordSpells[i]] = {
          // Add "spell" to the main item (when it is picked through the menu)
          name: NewSpell.name,
          toNotesPage: [
            {
              // What is added to the notes page
              name:
                NewSpell.name +
                " Exploit [" +
                (NewSpell.level == 1
                  ? "1st"
                  : NewSpell.level == 2
                    ? "2nd"
                    : NewSpell.level == 3
                      ? "3rd"
                      : NewSpell.level + "th") +
                " degree]",
              note: desc(NewSpell.descriptionFull),
              amendTo: "Tactical Exploits",
            },
          ],
          source: NewSpell.source,
          addMod: NewSpell.addMod,
          submenu: NewSpell.submenu,
          prereqeval: ExploitPrereqFactory(
            WarlordSpells[i],
            "warlord(laserllama)"
          ),
          eval: CreateTacticalSpellsheet,
          spellcastingBonusElsewhere: {
            addTo: "tactical exploits",
            spellcastingBonus: {
              name: "Tactical Exploits",
              spellcastingAbility: 1,
              spells: [WarlordSpells[i]],
              selection: [WarlordSpells[i]],
            },
          },
        };
      }

      return TacticalExploits;
    })(),

    "exploit dice": {
      name: "Exploit Dice",
      description: "I have a pool of dice to fuels my Exploits. They may change in size and number with a multiclass",
      minlevel: 2,
      eval: function () {
        var warlordEDs = calcExploitDice();
        AddFeature("Exploit Dice", warlordEDs.usages, " (" + warlordEDs.additional + ")", "short rest", "Warlord(Laserllama)");
      },
      changeeval: function () {
        var warlordEDs = calcExploitDice();
        AddFeature("Exploit Dice", warlordEDs.usages, " (" + warlordEDs.additional + ")", "short rest", "Warlord(Laserllama)");
      },
      removeeval: function () {
        var warlordEDs = calcExploitDice();
        AddFeature("Exploit Dice", warlordEDs.usages, " (" + warlordEDs.additional + ")", "short rest", "Warlord(Laserllama)");
      },
    },

    subclassfeature3: {
      name: "Academy of War",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        'Choose a Academy of War you strive to embrace and put it in the "Class" field',
      ]),
    },

    "extra attack": {
      name: "Extra Attack",
      source: [["GMB:LL", 0]],
      minlevel: 5,
      description: desc([
        "In addition to more attacks per action, if I Dash or Disengage, I can attack once with bonus action",
      ]),
      action: ["bonus action", "Single attack (after Dash/Disengage action)"],
    },

    "valiant leader": {
      name: "Valiant Leader",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "I gain more benefits based on my Leadership Style choice",
      ]),
      choices: ["captain", "mentor", "strategist"],
      choicesNotInMenu: true,
      captain: {
        name: "Valiant Leader (Captain)",
        description: desc([
          "I can target Unconcious, but not died, creas with my Inspiring Word even though they cannot hear me",
        ]),
      },
      mentor: {
        name: "Valiant Leader (Mentor)",
        description: desc([
          "My mentor reaction range increases to 30 feet and the bonus die increases to match my Expl Die",
        ]),
      },
      strategist: {
        name: "Valiant Leader (Strategist)",
        description: desc([
          "Me and creatures within 15 feet of me gains a bonus to initiative rolls equal to my Int mod",
        ]),
        addMod: {
          type: "skill",
          field: "Init",
          mod: "max(Int|0)",
          text: "I add my Int to my Initiative",
        },
      },
    },

    "rallying cry": {
      name: "Rallying Cry",
      source: [["GMB:LL", 0]],
      minlevel: 9,
      description: desc([
        "When another crea that can hear me within 30 feet fails a save, I can use my reaction to rally it",
        "The rallied crea roll the save again with a bonus equal to my Lead mod"
      ]),
      action: [["reaction", ""]],
      usages: levels.map(function (n) {
        return n < 9 ? "" : n < 13 ? 1 : n < 17 ? 2 : n < 20 ? 3 : 999;
      }),
      recovery: "short rest",
    },

    "unwavering will": {
      name: "Unwavering Will",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "I have advan. on saves to resist being Charmed, Frightened, or Stunned"
      ]),
      savetxt: { adv_vs: ["charmed", "frightened", "stunned"] },
    },

    "tactical superiority": {
      name: "Tactical Superiority",
      source: [["GMB:LL", 0]],
      minlevel: 11,
      description: desc([
        "I regain one expended uses of Inspiring Word and Rallying Cry when I roll initiative",
        " Moreover, the range of my Tactical Exploits, Inspiring Word, and Rallying Cry is doubled"
      ]),
    },


    "exalted leader": {
      name: "Exalted Leader",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "I gain more benefits based on my Leadership Style choice",
      ]),
      choices: ["captain", "mentor", "strategist"],
      choicesNotInMenu: true,
      captain: {
        name: "Exalted Leader (Captain)",
        description: desc([
          "Creas I target with Inspiring Word, Rallying Cry or a Tactical Exploit gains temp HP equal to my Cha Mod",
          "These temp HP last 1 minute"
        ]),
      },
      mentor: {
        name: "Exalted Leader (Mentor)",
        description: desc([
          "My Inspiring Word can end one of the following conditions in place of heal HP: Blinded, Charmed, Deafened, Frightened, Poisoned, or Stunned",
        ]),
      },
      strategist: {
        name: "Exalted Leader (Strategist)",
        description: desc([
          "The target of my Inspiring Word can move up to its speed without provoking opportunity attacks",
        ]),
      },
    },

    "dauntless": {
      name: "Dauntless",
      source: [["GMB:LL", 0]],
      minlevel: 20,
      description: desc([
        "I have an unlimited number of uses for Rallying Cry",
        " My Inspiring Word now heal hit points as the maximum possible result"
      ]),
    },
  },
};


// Psion class
ClassList["psion(laserllama)"] = {
  name: "Psion(LaserLlama)",
  regExpSearch: /^(?=.*psion)(?=.*laserllama).*$/i,
  source: ["GMB:LL", 0],
  primaryAbility: "Intelligence",
  prereqs: "Intelligence 13",
  die: 6,
  saves: ["Int", "Wis"],
  subclasses: ["Awakening", []],
  improvements: [0, 0, 0, 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 5, 5],
  skillstxt: {
    primary:
      "Choose two from Arcana, History, Insight, Medicine, Nature, Perception, and Religion",
  },

  armorProfs: {
    //required; the 4 entries are for: ["light", "medium", "heavy", "shields"]
    primary: [true, false, false, false], //required; the armor proficiencies if this is the first or only class
    secondary: [true, false, false, false], //required; the armor proficiencies if this class is multiclassed with (so not taken at level 1, but later)
  },

  weaponProfs: {
    //required; the 3 entries are for: ["simple", "martial", "other"]
    primary: [true, false], //required; the weapon proficiencies if this is the first or only class
    secondary: [true, false], //required; the weapon proficiencies if this class is multiclassed with (so not taken at level 1, but later)
  },

  equipment:
    "Psion starting equipment:\n \u2022 leather armor and a quarterstaff;\n \u2022 a light crossbow and 20 bolts -or- a sling;\n \u2022  two daggers -or- any simple weapon;\n \u2022 A scholar's pack -or- an explorer's pack.", //required; the text to display when citing the starting equipment

  attacks: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1], //required; the amount of attacks at each level. Note that there are 20 entries, one for each level.

  abilitySave: 4, //optional, but required for a spellcaster; the ability score to use for the Ability Saving Throws. Remove this line if your class has no Ability that requires Saving Throws. (Str=1, Dex=2, Con=3, Int=4, Wis=5, Cha=6)

  //abilitySaveAlt : 2,//optional; if the class offers a choice between two ability scores to be used to determine the DC, you can put that secondary one here (Str=1, Dex=2, Con=3, Int=4, Wis=5, Cha=6)

  spellcastingFactor: "psion(laserllama)", //required for a spellcaster; the speed with which spell progression works type 1 for full spellcasting (Cleric), 2 for half spellcasting (Paladin), and 3 for one-third spellcasting (Arcane Trickster). This can be any positive number other than 0. Remove this line if your class has no spellcasting. If your character uses the Warlock way of spellcasting, write "warlock1" here. The 1 indicates the spell progression factor. You can change it to a 2 or 3 to have half or one-third spell progression (or to any other factor you like).
  // You can also have this refer to a Spell Slot progression you define yourself, as a separate variable (see "Homebrew Syntax - SpellTable.js"). In order to do this the name of that variable and the spellcastingFactor must match. Using the name "purplemancer" for example would mean that here you put [spellcastingFactor : "purplemancer1"] (the 1 is the factor, this can be any positive number other than 0) while for the variable containing the table you use "purplemancerSpellTable". Note that the name is all lower case!

  spellcastingList: {
    //Optional; Only needed if the class doesn't have its own spell list. This object denotes what spells the class has access to. All things in this object constrain the selection of spells that will be available. The contstraints are cumulative.

    class: "psion(laserllama)", //Required; The name of the class from whose spell list the spells come from. This can be "any" if the spells are not limited by a spell list of just one class. The entry has to match the name of the class in the SpellsList
    level: [0, 9],
    spells: [
      // Cantrips (0 Level)
      "blade ward",
      "friends",
      "guidance",
      "light",
      "mage hand",
      "magic stone",
      "message",
      "mind sliver",
      "mind thrust",
      "minor illusion",
      "mystic hammer",
      "psionic strike",
      "spare the dying",
      "sword burst",
      "thaumaturgy",
      "toll the dead",
      "true strike",

      // 1st Level
      "catapult",
      "cause fear",
      "charm person",
      "command",
      "comprehend languages",
      "detect magic",
      "disguise self",
      "dissonant whispers",
      "ethereal anchor",
      "faerie fire",
      "hideous laughter",
      "id insinuation",
      "identify",
      "jump",
      "magic missile",
      "shield",
      "sleep",

      // 2nd Level
      "blindness/deafness",
      "blur",
      "calm emotions",
      "crown of madness",
      "detect thoughts",
      "enlarge/reduce",
      "hold person",
      "invisibility",
      "levitate",
      "locate creature",
      "mind spike",
      "mind whip",
      "mirror image",
      "misty step",
      "mystic spear",
      "phantasmal force",
      "see invisibility",
      "suggestion",

      // 3rd Level
      "blink",
      "cerebral blast",
      "clairvoyance",
      "enemies abound",
      "fear",
      "feign death",
      "fly",
      "haste",
      "hypnotic pattern",
      "intellect fortress",
      "life transference",
      "major image",
      "nondetection",
      "sending",
      "slow",
      "spectral passage",
      "tongues",
      "water walk",

      // 4th Level
      "arcane eye",
      "charm monster",
      "compulsion",
      "confusion",
      "dimension door",
      "ego scourge LL",
      "freedom of movement",
      "greater invisibility",
      "phantasmal killer",
      "resilient sphere",

      // 5th Level
      "arcane hand",
      "dominate person",
      "dream",
      "far step",
      "geas",
      "hold monster",
      "modify memory",
      "psychic crush",
      "scrying",
      "skill empowerment",
      "synaptic static",
      "telekinesis",
      "telepathic bond",
      "wall of force",

      // 6th Level
      "arcane gate",
      "eyebite",
      "globe of invulnerability",
      "mass suggestion",
      "mental prison",
      "psionic oppression",
      "scatter",
      "true seeing",

      // 7th Level
      "etherealness",
      "forcecage",
      "plane shift",
      "project image",
      "reverse gravity",
      "sequester",
      "teleport",

      // 8th Level
      "antimagic field",
      "antipathy/sympathy",
      "dominate monster",
      "feeblemind",
      "maddening darkness",
      "mind blank",
      "telepathy",

      // 9th Level
      "astral projection",
      "foresight",
      "invulnerability",
      "psychic scream",
      "time stop",
      "weird",
    ],
  },
  spellcastingKnown: {
    //Optional; Denotes the amount and type of spells the class has access to

    cantrips: [2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4], //Optional; This can either be one number, an array of 20 numbers, or be omitted for a class that doesn't have access to cantrips. The numbers reflect the amount of cantrips known

    spells: [
      2, 3, 4, 5, 6, 7, 8, 9, 10, 10, 11, 11, 12, 12, 13, 13, 14, 14, 15, 15,
    ], //Optional; This can either be one number, an array of 20 numbers, or be omitted for a class that doesn't have access to spells. The numbers reflect the amount of spells known. For a class that doesn't know spells, but prepares them from a list, you should put "list" here. For a class that uses a spellbook, you should put "book" here.

    prepared: false, //Optional; This indicates that the class has to prepare spells like a cleric/druid/paladin/wizard
  },

  features: {
    //required;  the class features. Each works the same way, so only a couple of example are given. You can add as many as you want

    psionics: {
      name: "Psionics",
      source: [["GMB:LL", 0]],
      minlevel: 1,
      description:
        "\n   " +
        "I have psionic power I have awakened within my psyche allow me to manifest mystical spells. It counts as spellcasting fot the purpose of features and spells like detect magic, counterspell, and antimagic field.",

      spellFirstColTitle: "Psionics", //optional, only works if spellcastingBonus exists; if set to any value, this makes the first column of the captions on the spell sheet be set to the first two letters/numbers of that value
    },

    cantrips: {
      name: "Cantrips",
      source: [["GMB:LL", 0]],
      minlevel: 1,
      description: "\n   " + "I can cast cantrips by my Psionics",
      additional: [
        "2 cantrips known",
        "2 cantrips known",
        "2 cantrips known",
        "3 cantrips known",
        "3 cantrips known",
        "3 cantrips known",
        "3 cantrips known",
        "3 cantrips known",
        "4 cantrips known",
        "4 cantrips known",
        "4 cantrips known",
        "4 cantrips known",
        "4 cantrips known",
        "4 cantrips known",
        "4 cantrips known",
        "4 cantrips known",
        "4 cantrips known",
        "4 cantrips known",
        "4 cantrips known",
        "4 cantrips known",
      ], //optional; text to display in the header of the feature. This can be one value, but can also be an array of 20 values, one for each level.
    },

    "psi points": {
      name: "Psi Points",
      source: [["GMB:LL", 0]],
      minlevel: 1,
      description:
        "\n   " +
        "I have a pool of Psi Points which I can use to cast my Psion spells spending points equal to the spell level (0 for Cantrips). I regain all expended Psi Points on a long or short rest.",
      additional: [
        "2 Psi Points",
        "3 Psi Points",
        "4 Psi Points",
        "5 Psi Points",
        "6 Psi Points",
        "7 Psi Points",
        "8 Psi Points",
        "9 Psi Points",
        "10 Psi Points",
        "11 Psi Points",
        "11 Psi Points",
        "12 Psi Points",
        "12 Psi Points",
        "13 Psi Points",
        "13 Psi Points",
        "14 Psi Points",
        "14 Psi Points",
        "15 Psi Points",
        "16 Psi Points",
        "17 Psi Points",
      ], //optional; text to display in the header of the feature. This can be one value, but can also be an array of 20 values, one for each level.
      usages: [
        2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 11, 12, 12, 13, 13, 14, 14, 15, 16, 17,
      ], //example of usages varying per level
      recovery: "short rest",
    },

    "mental limit": {
      name: "Mental Limit",
      source: [["GMB:LL", 0]],
      minlevel: 1,
      description:
        "\n   " +
        "I have a limit of the potency of spell I can manifest with my Psioncs. When a Psion feature allows me to expend Psi Points, I can never expend more Psi Points than it costs to manifest a spell of my Mental Limit Level.",
      additional: [
        "1st Level",
        "1st Level",
        "2nd Level",
        "2nd Level",
        "3rd Level",
        "3rd Level",
        "4th Level",
        "4th Level",
        "5th Level",
        "5th Level",
        "5th Level",
        "5th Level",
        "5th Level",
        "5th Level",
        "5th Level",
        "5th Level",
        "5th Level",
        "5th Level",
        "5th Level",
        "5th Level",
      ], //optional; text to display in the header of the feature. This can be one value, but can also be an array of 20 values, one for each level.
    },

    spellcasting: {
      name: "Spellcasting",
      source: [["GMB:LL", 0]],
      minlevel: 1,
      description:
        "\n   " +
        "Intelligence is my spellcasting ability for my Psion spells." +
        "\n   " +
        "Each spell I learn from the Psion spell List must be of a level equal to my Mental Limit or lower and when I gain a Psion level I can replace a Psion spell I know with another Psion spell of my choice." +
        "\n   " +
        "My mind is my spellcasting focus for my Psion spells. I must have a free hand to cast spells that require somatic or material components, and I must still provide any material components that are consumed or have a required gold cost." +
        "\n   " +
        "Whenever you manifest a Psion spell you exhibit noticeable changes and creatures are aware that I using my psionic abilities." +
        "\n   " +
        "I cannot use my Psionics if I am wearing medium or heavy armor, or wielding a shield, unless a feature allows me to.",
      additional: [
        "2 Spells Knows",
        "3 Spells Knows",
        "4 Spells Knows",
        "5 Spells Knows",
        "6 Spells Knows",
        "7 Spells Knows",
        "8 Spells Knows",
        "9 Spells Knows",
        "10 Spells Knows",
        "10 Spells Knows",
        "11 Spells Knows",
        "11 Spells Knows",
        "12 Spells Knows",
        "12 Spells Knows",
        "13 Spells Knows",
        "13 Spells Knows",
        "14 Spells Knows",
        "14 Spells Knows",
        "15 Spells Knows",
        "15 Spells Knows",
      ],
    },

    "mystic talents": (function () {
      const MysticTalentsPsion = {
        name: "Mystic Talents",
        source: [["GMB:LL", 0]],
        minlevel: 2,
        description:
          "\n   " +
          "I can manifest unique powers called Mystic Talents. Whenever I gain a Psion Level i can replace a Mystic Talent I know with a new Mystic Talent as long I meet the prerequisites. I cannot replace a Talent if it is the prerequisite for another Talent.",
        additional: [
          "0 Talents",
          "2 Talents",
          "3 Talents",
          "3 Talents",
          "4 Talents",
          "4 Talents",
          "5 Talents",
          "5 Talents",
          "6 Talents",
          "6 Talents",
          "7 Talents",
          "7 Talents",
          "8 Talents",
          "8 Talents",
          "8 Talents",
          "9 Talents",
          "9 Talents",
          "9 Talents",
          "10 Talents",
          "10 Talents",
        ], //optional; text to display in the header of the feature. This can be one value, but can also be an array of 20 values, one for each level.
        extraname: "Mystic Talents",
        extrachoices: [
        ],
        extraTimes: levels.map(function (n) {
          return n < 2
            ? 0
            : n < 3
              ? 2
              : n < 5
                ? 3
                : n < 7
                  ? 4
                  : n < 9
                    ? 5
                    : n < 11
                      ? 6
                      : n < 13
                        ? 7
                        : n < 16
                          ? 8
                          : n < 19
                            ? 9
                            : 10;
        }),
      };
      var MysticKeys = Object.keys(MysticTalentsLL);
      for (var m = 0; m < MysticKeys.length; m++) {
        MysticTalentsPsion.extrachoices.push(MysticTalentsLL[MysticKeys[m]].name);
        var NewPsionTalent = MysticTalentsLL[MysticKeys[m]];
        const tlvl = NewPsionTalent.talentLevel ? NewPsionTalent.talentLevel : 3;
        var npt = {
          name: NewPsionTalent.name,
          description: NewPsionTalent.description,
          source: NewPsionTalent.source,
          addMod: NewPsionTalent.addMod,
          armorOptions: NewPsionTalent.armorOptions,
          armorAdd: NewPsionTalent.armorAdd,
          speed: NewPsionTalent.speed,
          toolProfs: NewPsionTalent.toolProfs,
          action: NewPsionTalent.action,
          extraLimitedFeatures: NewPsionTalent.extraLimitedFeatures,
          usages: NewPsionTalent.usages,
          recovery: NewPsionTalent.recovery,
          savetxt: NewPsionTalent.savetxt,
          dmgres: NewPsionTalent.dmgres,
          armorProfs: NewPsionTalent.armorProfs,
          submenu: NewPsionTalent.submenu,
          extraname: NewPsionTalent.extraname,
          extraTimes: NewPsionTalent.extraTimes,
          choices: NewPsionTalent.choices,
          vision: NewPsionTalent.vision,
          spellcastingBonus: NewPsionTalent.spellcastingBonus,
          spellChanges: NewPsionTalent.spellChanges,
          prereqeval: MysticTalentsPrereqFactory(MysticKeys[m], "psion(laserllama)", 1),
          submenu: "Psion lvl " + tlvl + "+"
        }

        MysticTalentsPsion[MysticKeys[m]] = npt;
      }

      return MysticTalentsPsion;
    })(),

    subclassfeature1: {
      //You need at least one entry named "subclassfeatureX". It signals the sheet to ask the user for which subclass he would like to have. The level of this feature should match the level the class needs to select a subclass. Once a subclass is selected, any feature with "subclassfeature" in the object name in the class entry will be ignored.
      name: "Awakening",
      source: [["GMB:LL", 0]],
      minlevel: 1,
      description:
        "\n   " +
        'Choose an Awakening you strive to emulate and put it in the "Class" field' +
        "\n   " +
        "Choose either Empath, Enlightened, Immortal, Outsider, Visionary, or Wilder",
    },

    "psionic recovery": {
      name: "Mystical Recovery",
      source: [["GMB:LL", 0]],
      minlevel: 2,
      description:
        "\n   " +
        "As a bonus action, I can clear my mind and regenerate a number of expended Psi Points equal to my Intelligence modifier (minimum of 1). I can do it once per long rest.",
      recovery: "long rest",
      usages: levels.map(function (n) {
        return n < 11 ? 1 : 2;
      }),
      action: ["bonus action", ""],
    },

    "consumptive power": {
      name: "Consumptive Power",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description:
        "\n   " +
        "I can use my HP to fuel a psionic discipline instead of psi points" +
        "\n   " +
        "I lose HP twice the Psi Point I want to spend (cannot be lessened); My HP max is reduced with the same amount until I finish my next long rest",
    },

    "interior gate1": {
      name: "First Interior Gate",
      source: [["GMB:LL", 0]],
      minlevel: 11,
      description:
        "\n   " +
        "I unlock the first Interior Gate and learn a 6th-level Psion spell. It does not count against my total number of Spells Known. Once between each long rest, I can manifest this Psion spell, at 6th-level, without expending Psi Points." +
        "\n   " +
        "Whenever I gain a level I can replace this Interior Gate spell with another Psion spell of the same level",
      usages: levels.map(function (n) {
        if (n < 11) return "";
        return 1;
      }),
      recovery: "long rest",
      spellcastingBonus: [
        {
          name: "First Gate Spell (6th-level)",
          firstCol: "1st-IG",
          spells: [
            "arcane gate",
            "eyebite",
            "globe of invulnerability",
            "mass suggestion",
            "mental prison",
            "psionic oppression (LL)",
            "scatter",
            "true seeing",
          ],
          selection: [
            "arcane gate",
            "eyebite",
            "globe of invulnerability",
            "mass suggestion",
            "mental prison",
            "psionic oppression (LL)",
            "scatter",
            "true seeing",
          ],
          times: 1,
        },
      ],
    },

    "interior gate2": {
      name: "Second Interior Gate",
      source: [["GMB:LL", 0]],
      minlevel: 13,
      description:
        "\n   " +
        "I unlock the second Interior Gate and learn a 7th-level Psion spell. It does not count against my total number of Spells Known. Once between each long rest, I can manifest this Psion spell, at 7th-level, without expending Psi Points." +
        "\n   " +
        "Whenever I gain a level I can replace this Interior Gate spell with another Psion spell of the same level",
      usages: levels.map(function (n) {
        if (n < 13) return "";
        return 1;
      }),
      recovery: "long rest",
      spellcastingBonus: [
        {
          name: "Second Interior Gate Spell (7th-level)",
          firstCol: "2nd-IG",
          spells: [
            "etherealness",
            "force cage (LL)",
            "planeshit",
            "project image",
            "reverse gravity",
            "sequester",
            "teleport",
          ],
          selection: [
            "etherealness",
            "force cage (LL)",
            "planeshit",
            "project image",
            "reverse gravity",
            "sequester",
            "teleport",
          ],
          times: 1,
        },
      ],
    },

    "interior gate3": {
      name: "Third Interior Gate",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description:
        "\n   " +
        "I unlock the third Interior Gate and learn a 8th-level Psion spell. It does not count against my total number of Spells Known. Once between each long rest, I can manifest this Psion spell, at 8th-level, without expending Psi Points." +
        "\n   " +
        "Whenever I gain a level I can replace this Interior Gate spell with another Psion spell of the same level",
      usages: levels.map(function (n) {
        if (n < 15) return "";
        return 1;
      }),
      recovery: "long rest",
      spellcastingBonus: [
        {
          name: "Third Interior Gate Spell (8th-level)",
          firstCol: "3rd-IG",
          spells: [
            "antimagic field",
            "antipathy/sympathy",
            "dominate monster",
            "feeblmind",
            "maddenind darkness",
            "mind blank",
            "telepathy",
          ],
          selection: [
            "antimagic field",
            "antipathy/sympathy",
            "dominate monster",
            "feeblmind",
            "maddenind darkness",
            "mind blank",
            "telepathy",
          ],
          times: 1,
        },
      ],
    },

    "interior gate4": {
      name: "Fourth Interior Gate",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description:
        "\n   " +
        "I unlock the third Interior Gate and learn a 9th-level Psion spell. It does not count against my total number of Spells Known. Once between each long rest, I can manifest this Psion spell, at 9th-level, without expending Psi Points." +
        "\n   " +
        "Whenever I gain a level I can replace this Interior Gate spell with another Psion spell of the same level",
      usages: levels.map(function (n) {
        if (n < 17) return "";
        return 1;
      }),
      recovery: "long rest",
      spellcastingBonus: [
        {
          name: "Third Interior Gate Spell (8th-level)",
          firstCol: "3rd-IG",
          spells: [
            "astral projection",
            "foresight",
            "invulnerability",
            "psychic scream",
            "time stop",
            "weird (LL)",
          ],
          selection: [
            "astral projection",
            "foresight",
            "invulnerability",
            "psychic scream",
            "time stop",
            "weird (LL)",
          ],
          times: 1,
        },
      ],
    },

    limitless: {
      name: "Limitless",
      source: [["GMB:LL", 0]],
      minlevel: 20,
      description:
        "\n   " +
        "I am restistance to all bludgeoning, piercing, psychic and slashing damage. I stop aging, am immune to all disease, poison damage, and the poisoned condition." +
        "\n   " +
        "Finally, if I spend 10 minutes meditating or performing only light activity, I regain all of my expended Psi Points.",
      savetxt: { immune: ["poison", "disease"] },
      dmgres: ["Bludgeoning", "Piercing", "Slashing", "Psychic"],
    },
  },
};


// Create arcane knight spell list
var ArcaneKnightList = [
  "blade ward", // cantrips
  "booming blade",
  "green-flame blade",
  "light",
  "lightning lure",
  "mage hand",
  "prestidigitation",
  "resistance",
  "shocking grasp",
  "sword burst",
  "tempestuous blade",
  "true strike", // 1st level
  "absorb elements",
  "armor of agathys",
  "chromatic orb",
  "compelled duel",
  "faerie fire",
  "feather fall",
  "fog cloud",
  "grease",
  "hellish rebuke",
  "jump",
  "mage armor",
  "magic missile",
  "protection from evil and good",
  "searing smite",
  "shield",
  "thunderous smite",
  "zephyr strike", // 2nd level
  "aura of frost",
  "blur",
  "branding smite",
  "darkness",
  "enlarge/reduce",
  "invisibility",
  "magic weapon",
  "misty step",
  "spider climb",
  "warding wind", // 3rd level
  "blinding smite",
  "counterspell",
  "dispel magic",
  "fireball",
  "flame arrows",
  "fly",
  "lightning arrow",
  "melf's minute meteors",
  "protection from energy",
  "thunder step", // 4th level
  "banishment",
  "death ward",
  "fire shield",
  "greater invisibility",
  "otiluke's resilient sphere",
  "staggering smite",
];

for (var i = 0; i < ArcaneKnightList.length; i++) {
  SpellsList[ArcaneKnightList[i]].classes.push("arcane knight");
}

// Create mystic spell list
var MysticList = [
  "catapult", // 1st level
  "cause fear",
  "charm person",
  "command",
  "dissonant whispers",
  "ethereal anchor",
  "tasha's hideous laughter",
  "id insinuation",
  "identify",
  "jump",
  "magic missile",
  "shield",
  "sleep",
  "blindness/deafness", // 2nd level
  "blur",
  "calm emotions",
  "crown of madness",
  "detect thoughts",
  "levitate",
  "mind spike",
  "tasha's mind whip",
  "mirror image",
  "mystic spear",
  "phantasmal force",
  "suggestion",
  "blink", // 3rd level
  "cerebral blast",
  "clairvoyance",
  "enemies abound",
  "fear",
  "feign death",
  "hypnotic pattern",
  "intellect fortress",
  "major image",
  "nondetection",
  "sending",
  "slow",
  "spectral passage",
  "tongues",
  "water walk",
  "arcane eye", // 4th level
  "charm monster",
  "compulsion",
  "confusion",
  "dimension door",
  "ego scourge",
  "freedom of movement",
  "phantasmal killer",
  "otiluke's resilient sphere",
];

for (var i = 0; i < MysticList.length; i++) {
  SpellsList[MysticList[i]].classes.push("mystic");
}

// Create warden spell list
var WardenList = [
  //cantrips
  "beckon air",
  "control flames",
  "create bonfire",
  "druidcraft",
  "frostbite",
  "guidance",
  "magic stone",
  "mold earth",
  "primal savagery",
  "shape water",
  "shillelagh",
  "thorn whip",
  "thunderclap",
  //1st level
  "absorb elements",
  "armor of agathys",
  "compelled duel",
  "cure wounds",
  "earth tremor",
  "ensnaring strike",
  "entangle",
  "fog cloud",
  "hellish rebuke",
  "inflict wounds",
  "searing smite",
  "thunderous smite",
  "thunderwave",
  //2nd level
  "dust devil",
  "earthbind",
  "elemental blade",
  "gust of wind",
  "magic weapon",
  "shatter",
  "spike growth",
  "warding wind",
  //3rd level
  "elemental weapon",
  "plant growth",
  "grasping vine",
  "sleet storm",
  "thunder step",
  "tidal wave",
  "wall of sand",
  "wall of water",
  "wind wall",
  //4th level
  "control water",
  "pillars of earth",
  "fire shield",
  "guardian of nature",
  "ice storm",
  "staggering smite",
  "storm sphere",
];

for (var i = 0; i < WardenList.length; i++) {
  try {
    SpellsList[WardenList[i]].classes.push("warden");
  } catch (error) {
    throw new Error(WardenList[i]);
  }
}

// Edit official sorcerer regex to avoid conflict with witchblade
if (ClassList["sorcerer"]) {
  ClassList["sorcerer"].regExpSearch = /sorcerer/i;
}

// Create Witchblade spell list
var WitchbladeList = [
  "blade ward",
  "booming blade",
  "green-flame blade",
  "infestation",
  "lightning lure",
  "mind sliver",
  "minor illusion",
  "poison spray",
  "prestidigitation",
  "sword burst",
  "tempestuous blade",
  "toll the dead",
  "true strike", // cantrips
  "absorb elements",
  "armor of agathys",
  "arms of hadar",
  "bane",
  "cause fear",
  "detect evil and good",
  "expeditious retreat",
  "false life",
  "hellish rebuke",
  "hex",
  "inflict wounds",
  "protection from evil and good",
  "searing smite",
  "shield",
  "thunderous smite",
  "unseen servant",
  "witch bolt", // 1st level
  "cloud of daggers",
  "crown of madness",
  "darkness",
  "hold person",
  "invisibility",
  "mind spike",
  "mirror image",
  "misty step",
  "ray of enfeeblement",
  "shadow blade",
  "shatter",
  "spider climb", // 2nd level
  "blinding smite",
  "counterspell",
  "dispel magic",
  "enemies abound",
  "fear",
  "hunger of hadar",
  "major image",
  "vampiric touch", // 3rd level
  "banishment",
  "blight",
  "dimension door",
  "hallucinatory terrain",
  "phantasmal killer",
  "staggering smite",
  "shadow of moil",
  "sickening radiance",
]; // 4th level

for (var i = 0; i < WitchbladeList.length; i++) {
  SpellsList[WitchbladeList[i]].classes.push("witchblade");
}

// Common attributes of Beast Master Conclave's Primal Beasts
var LL_Primal_Beast_Attributes = {
  hdLinked: ["ranger(laserllama)"],
  languages: "understands the languages of its master but can't speak",
  features: [{
    name: "Master",
    description: "The beast obeys the commands of its master and shares its proficiency bonus. It takes its turn during that of its master, on the same initiative count. It can move and take reactions on its own, but only takes the Dodge action on its turn unless its master takes a bonus action to command it to take another action. Its master can also forgo one attack during their Attack action to command the beast to take the Attack action. If its master is incapacitated, the beast can take any action, not just Dodge. The beast vanishes if its master dies."
  }],
  traits: [{
    name: "Primal Rebirth",
    description: "Its master can make a 1 hour ritual, that can be part of a short/long rest, to have it return to full HP after 1 minute."
  }, {
    name: "Hit Dice",
    description: "The Beast has a total number of d8 Hit Dice equal to your Ranger level. It also gains all the normal benefits of both short and long rests."
  }, {
    name: "Primal Bond",
    description: "The beast adds it proficiency bonus to all its ability check and saving throws."
  }, {
    name: "Bestial Focus (Beast Master 7)",
    minlevel: 7,
    description: "The beast gains all benefits of your Ranger's Querry including any Knacks that enhance it. Also, the beast's attacks count as magical for overcoming resistances and immunities.",
    eval: function (prefix, lvl) {
      AddString(prefix + "Comp.Use.Attack.1.Description", "Counts as magical", "; ");
    },
    removeeval: function (prefix, lvl) {
      RemoveString(prefix + "Comp.Use.Attack.1.Description", "Counts as magical");
    }
  }, {
    name: "Exceptional Training (Beast Master 11)",
    minlevel: 11,
    description: "When commanded to take the Attack action, the beast can make 2 attacks as part of its Attack action.",
    eval: function (prefix, lvl) {
      Value(prefix + "Comp.Use.Attack.perAction", 2);
    },
    removeeval: function (prefix, lvl) {
      Value(prefix + "Comp.Use.Attack.perAction", 1);
    }
  }],
  addMod: [
    { type: "skill", field: "all", mod: "Prof", text: "The primal beast adds it proficiency bonus to all its ability check and saving throws." },
    { type: "skill", field: "Init", mod: "Prof", text: "The primal beast adds it proficiency bonus to all its ability check and saving throws." },
    { type: "save", field: "all", mod: "Prof", text: "The primal beast adds it proficiency bonus to all its ability check and saving throws." }
  ],
  calcChanges: {
    hp: function (totalHD, HDobj, prefix) {
      if (!classes.known["ranger(laserllama)"]) return;
      var rngrLvl = classes.known["ranger(laserllama)"].level;
      var multiplier = What(prefix + "Comp.Use.HD.Die") == 6 ? [4, "four"] : [5, "five"];
      var rngrLvlM = multiplier[0] * rngrLvl;
      HDobj.alt.push(multiplier[0] + rngrLvlM);
      HDobj.altStr.push(" = " + multiplier[0] + " as a base\n + " + multiplier[0] + " \xD7 " + rngrLvl + " from " + multiplier[1] + " times its master's ranger level (" + rngrLvlM + ")");
    },
    setAltHp: true
  }
};

// Extrachoices for Nomad Conclave's Mistyc Knowledge
var NomadKnowledgeTools = [
  "Alchemist's supplies",
  "Brewer's supplies",
  "Calligrapher's supplies",
  "Carpenter's tools",
  "Cartographer's tools",
  "Cobbler's tools",
  "Cook's utensils",
  "Glassblower's tools",
  "Jeweler's tools",
  "Leatherworker's tools",
  "Mason's tools",
  "Painter's supplies",
  "Potter's tools",
  "Smith's tools",
  "Tinker's tools",
  "Weaver's tools",
  "Woodcarver's tools",
  "Gaming set",
  "Musical Instrument",
  "Disguise kit",
  "Forgery kit",
  "Herbalism kit",
  "Navigator's tools",
  "Poisoner's kit",
  "Thieves' tools"
];
var NomadKnowledgeLanguages = [
  "Abyssal",
  "Aquan",
  "Auran",
  "Bariaur",
  "Celestial",
  "Common",
  "Deep Speech",
  "Draconic",
  "Druidic",
  "Dwarvish",
  "Elvish",
  "Giant",
  "Gnomish",
  "Goblin",
  "Gnoll",
  "Halfling",
  "Ignan",
  "Infernal",
  "Orc",
  "Primordial",
  "Sylvan",
  "Terran",
  "Kreen",
  "Undercommon"
];
var NomadKnowledgeSkills = [
  "Acrobatics",
  "Animal Handling",
  "Arcana",
  "Athletics",
  "Deception",
  "History",
  "Insight",
  "Intimidation",
  "Investigation",
  "Medicine",
  "Nature",
  "Perception",
  "Performance",
  "Persuasion",
  "Religion",
  "Sleight of Hand",
  "Stealth",
  "Survival",
];

// Create arcane trickster spell list
var ArcaneTricksterList = [
  //cantrips
  "acid splash",
  "booming blade",
  "dancing lights",
  "fire bolt",
  "friends",
  "frostbite",
  "green-flame blade",
  "light",
  "mage hand",
  "magic stone",
  "message",
  "minor illusion",
  "poison spray",
  "prestidigitation",
  "ray of frost",
  "shocking grasp",
  //1st level
  "alarm",
  "bane",
  "catapult",
  "cause fear",
  "charm person",
  "color spray",
  "comprehend languages",
  "detect magic",
  "detect poison and disease",
  "disguise self",
  "dissonant whispers",
  "faerie fire",
  "feather fall",
  "conjure familiar",
  "tenser's floating disk",
  "fog cloud",
  "grease",
  "tasha's hideous laughter",
  "identify",
  "illusory script",
  "jump",
  "longstrider",
  "silent image",
  "sleep",
  "snare",
  "unseen servant",
  //2nd level
  "blindness/deafness",
  "blur",
  "calm emotions",
  "crown of madness",
  "darkness",
  "darkvision",
  "enlarge/reduce",
  "hold person",
  "invisibility",
  "levitate",
  "lock unlock",
  "nystul's magic aura",
  "magic mouth",
  "tasha's mind whip",
  "mirror image",
  "misty step",
  "phantasmal force",
  "rope trick",
  "see invisibility",
  "shadow blade",
  "silence",
  "spider climb",
  "suggestion",
  //3rd level
  "blink",
  "counterspell",
  "dispel magic",
  "enemies abound",
  "fear",
  "hypnotic pattern",
  "major image",
  "nondetection",
  "sending",
  "tiny servant",
  //4th level
  "charm monster",
  "confusion",
  "dimension door",
  "freedom of movement",
  "greater invisibility",
  "hallucinatory terrain",
  "phantasmal killer",
];

for (var i = 0; i < ArcaneTricksterList.length; i++) {
  try {
    SpellsList[ArcaneTricksterList[i]].classes.push("arcane trickster");
  } catch (error) {
    throw new Error(ArcaneTricksterList[i]);
  }
}

// Create avenger spell list
var AvengerList = [
  // 1st level
  "bane",
  "bless",
  "cause fear",
  "charm person",
  "command",
  "compelled duel",
  "comprehend languages",
  "divine favor",
  "ethereal anchor",
  "expeditious retreat",
  "guiding bolt",
  "heroism",
  "inflict wounds",
  "sanctuary",
  "searing smite",
  "shield of faith",
  "thunderous smite",
  "wrathful smite",
  // 2nd level
  "aid",
  "augury",
  "blindness/deafness",
  "branding smite",
  "darkness",
  "invisibility",
  "locate creature",
  "mind spike",
  "misty step",
  "pass without trace",
  "shadow blade",
  "silence",
  "suggestion",
  "zone of truth",
  // 3rd level
  "bestow curse",
  "blinding smite",
  "clairvoyance",
  "daylight",
  "dispel magic",
  "fear",
  "guardian of faith",
  "speak with dead",
  "spectral passage",
  "spirit shroud",
  "vampiric touch",
  // 4th level
  "accursed touch",
  "banishment",
  "blight",
  "death ward",
  "divination",
  "staggering smite",
];

for (var i = 0; i < AvengerList.length; i++) {
  SpellsList[AvengerList[i]].classes.push("avenger");
}

// Create Gallantry spell list
var GallantryList = [
  // 1st level
  "bless",
  "bane",
  "cause fear",
  "charm person",
  "command",
  "compelled duel",
  "disguise self",
  "dissonant whispers",
  "faerie fire",
  "heroism",
  "tasha's hideous laughter",
  "longstrider",
  "sleep",
  "thunderous smite",
  "thunderwave",
  // 2nd level
  "aid",
  "calm emotions",
  "enhance ability",
  "find steed",
  "magic mouth",
  "magic weapon",
  "mirror image",
  "pyrotechnics",
  "restoration",
  "shatter",
  "silence",
  "suggestion",
  "warding bond",
  // 3rd level
  "beacon of hope",
  "crusader's mantle",
  "dire wail",
  "dispel magic",
  "fear",
  "haste",
  "hypnotic pattern",
  "otto's irresistible dance",
  "nondetection",
  "sending",
  "slow",
  "sonic wave",
  // 4th level
  "aura of life",
  "aura of purity",
  "charm monster",
  "compulsion",
  "confusion",
  "death ward",
  "freedom of movement",
];

for (var i = 0; i < GallantryList.length; i++) {
  // app.alert(GallantryList[i]);
  SpellsList[GallantryList[i]].classes.push("gallantry");
}

// Create Zeal spell list
var ZealList = [
  // Cantrips
  "blade ward",
  "booming blade",
  "green-flame blade",
  "light",
  "message",
  "resistance",
  "sacred flame",
  "spare the dying",
  "sword burst",
  "thaumaturgy",
  "toll the dead",
  "true strike",
  // 1st level
  "bless",
  "command",
  "compelled duel",
  "cure wounds",
  "divine favor",
  "ethereal anchor",
  "guiding bolt",
  "heroism",
  "inflict wounds",
  "jump",
  "protection from evil and good",
  "sanctuary",
  "searing smite",
  "shield of faith",
  "thunderous smite",
  "wrathful smite",
  // 2nd level
  "aid",
  "blindness/deafness",
  "branding smite",
  "darkness",
  "find steed",
  "magic weapon",
  "restoration",
  "spiritual weapon",
  "warding bond",
  "zone of truth",
  // 3rd level
  "aura of vitality",
  "beacon of hope",
  "blinding smite",
  "conjure volley",
  "crusader's mantle",
  "flame arrows",
  "protection from energy",
  "remove curse",
  "revivify",
  "spirit guardians",
  // 4th level
  "aura of life",
  "aura of purity",
  "banishment",
  "death ward",
  "guardian of faith",
  "staggering smite",
];

for (var i = 0; i < ZealList.length; i++) {
  // app.alert(ZealList[i]);
  SpellsList[ZealList[i]].classes.push("zeal");
}

// Guardian of nature is on the Wu Jen's spell list, but restricted to only tree, so I'm adding a new spell to account for that restriction
// I could theorically instead use spellChanges, but it might affect a ranger or druid multiclass
SpellsList["guardian of nature (tree)"] = {
  name: "Guardian of Nature (tree)",
  classes: [],
  source: [["X", 157]],
  level: 4,
  school: "Trans",
  time: "1 bns",
  range: "Self",
  components: "V",
  duration: "Conc, 1 min",
  description: "I transform into a Great Tree (defensive bonuses); see book",
  descriptionFull: "A nature spirit answers your call and transforms you into a powerful guardian. The transformation lasts until the spell ends." + "\n\n" + toUni("Great Tree") + ": Your skin appears barky, leaves sprout from your hair, and you gain the following benefits:" + "\n \u2022 " + "You gain 10 temporary hit points." + "\n \u2022 " + "You make Constitution saving throws with advantage." + "\n \u2022 " + "You make Dexterity- and Wisdom-based attack rolls with advantage." + "\n \u2022 " + "While you are on the ground, the ground within 15 feet of you is difficult terrain for your enemies."
};

var WuJenList = [
  "beckon air", "blade ward", "control flame", "create bonfire", "druidcraft", "frostbite", "light", "magic stone", "mold earth", "ray of frost", "shape water", "thorn whip", "thunderclap", // cantrips
  "absorb elements", "armor of agathys", "burning hands", "create water", "earth tremor", "ensnaring strike", "entangle", "fog cloud", "hail of thorns", "hellish rebuke", "ice knife", "sanctuary", "thunderwave", "witch bolt", // 1st level
  "barkskin", "continual flame", "dust devil", "earthbind", "maximilian's earthen grasp", "flame blade", "flaming sphere", "gust of wind", "hold person", "levitate", "misty step", "scorching ray", "shatter", "snilloc's snowball swarm", "spike growth", "warding wind", // 2nd level
  "call lightning", "erupting earth", "fireball", "fly", "gaseous form", "grasping vine", "lightning bolt", "meld into stone", "melf's minute meteors", "plant growth", "sleet storm", "speak with plants", "thunder step", "tidal wave", "wall of sand", "wall of water", "wind wall", // 3rd level
  "control water", "elemental bane", "fire shield", "freedom of movement", "guardian of nature (tree)", "ice storm", "pillars of earth", "otiluke's resilient sphere", "stone shape", "stoneskin", "storm sphere", "wall of fire", "watery sphere" // 4th level
]

for (var i = 0; i < WuJenList.length; i++) {
  try { SpellsList[WuJenList[i]].classes.push("wu jen"); } catch (e) { throw new Error(WuJenList[i]); }
}

// Subclasses Alternate Barbarian
// Path of the Ancestors (ancestral guardian)
AddSubClass("barbarian(laserllama)", "ancestors", {
  regExpSearch: /ancestors/i,
  subname: "Path of the Ancestors",
  fullname: "Ancestors",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: GetBarbarianSubclassExploits("Ancestral", [
      "brace up",
      "rustic intuition",
      "arresting critical",
      "thunderous blow",
      "mythic resilience",
    ]),
    "subclassfeature3.1": {
      name: "Ancestral Knowledge",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "As a action, for the next 10 minutes, I add my Expl Die to all Intelligence, Charisma and Wisdom checks",
        "This ends early if I start to rage or become incapacitated",
        "I can do this once per long rest for free then I need to expend one of my rage uses to do it again",
      ]),
      action: ["action", ""],
    },
    "subclassfeature3.2": {
      name: "Spectral Warriors",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "While Raging, I gain the following benefits:",
        "  \u2022 Ancestral Strike. While the Spectral Warriors (SW) remain in my space, my rage and exploit damage becomes radiant damage.",
        "  \u2022 Ethereal Scourge. On melee hit, I can surround target with SW. It has disadv. on attacks against targets other than me. If hits a crea other than ne, that crea has res to dmg dealt.",
        "This effect lasts until the start of my next turn, but it ends early if I direct my SW to another target or use a bns to call them  back.",
      ]),
      action: [["bonus action", " (Recall)"], ["action", "Ethereal Scourge (on hit)"]],
    },
    subclassfeature6: {
      name: "Spiritual Shield",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: levels.map(function (n) {
        if (n < 14) {
          return desc([
            "As a reaction while Raging, when an ally I see within 30 ft is damaged, I can send my SW to my ally",
            "My SW reduce the damage dealt to my ally by 3 Expl Dice; after that my SW returns to me",
          ]);
        } else {
          return desc([
            "As a reaction while Raging, when an ally I see within 30 ft is damaged, I can send my SW to my ally",
            "My SW reduce the damage dealt to my ally by 3 Expl Dice; after that my SW returns to me",
            "The attacker takes an amount of force damage equal to the damage reduction",
          ]);
        }
      }),
      action: ["reaction", ""],
    },
    subclassfeature10: {
      name: "Ancestral Oracle",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "While using Ancestral Knowledge, I can cast either Clairvoyance or Commune, without a spell slot or material components",
        "Once the spell ends, the benefits of Ancestral Knowledge end.",
        "Commune consults ancestral spirits; Clairvoyance summons an invisible ancestral spirit",
        "Wisdom is my spellcasting ability for these spells", // not included in LL's document, but is included as such in the official version
      ]),
      spellcastingAbility: 5,
      spellcastingBonus: [
        {
          name: "Ancestral Oracle",
          spells: ["commune", "clairvoyance"],
          selection: ["commune", "clairvoyance"],
          firstCol: "R",
          times: 2,
        },
      ],
      spellChanges: {
        commune: {
          components: "V,S",
          compMaterial: "",
          description:
            "Ask up to three yes/no questions to my ancestral spirits", // removing component price from short description
          changes:
            "My casting of Augury is a practice of consulting my ancestral spirits, thus requiring no material components.",
        },
        clairvoyance: {
          components: "V,S",
          compMaterial: "",
          description:
            "See or hear a familiar place; 1 a to switch between seeing and hearing",
          changes:
            "My casting of Clairvoyance is a practice of consulting an ancestral spirit of mine, thus requiring no material components.",
        },
      },
    },
    // Level 14 feature is added by scaling the lvl 3 feature
    subclassfeature14: {
      name: "Vengeful Ancestors",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      description: "\n    Spiritual Shield improved (see Spiritual Shield)",
    },
  },
});

// Path of the Beast Heart (Totem Warrior)
AddSubClass("barbarian(laserllama)", "beast heart", {
  regExpSearch: /^(?=.*beast)(?=.*heart).*$/i,
  subname: "Path of the Beast Heart",
  fullname: "Beast Heart",
  source: [["GMB:LL", 0]],
  features: {
    subclassfeature3: GetBarbarianSubclassExploits("Beast Heart", [
      "mighty leap",
      "rustic intuition",
      "arresting critical",
      "immovable stance",
      "savage defiance",
    ]),
    "subclassfeature3.1": {
      name: "Wild Empathy",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I can verbally communicate with and understand Beasts. Though, they awareness and ability to recall knowledge are limited by their Int score",
      ]),
    },

    "subclassfeature3.2": {
      name: "Bestial Spirits",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        'Choose Bear, Eagle, Elk, Wolf, or Tiger Spirit using the "Choose Feature" button above',
      ]),
      choices: ["Bear", "Eagle", "Elk", "Tiger", "Wolf"],
      bear: {
        name: "Bear Spirit",
        description:
          "\n   " +
          "While raging, I have resistance to all damage types except psychic, force and radiant",
        dmgres: [["All -Psy/For/Rad", "All -Psy/For/Rad (rage)"]], // have to keep this as short as possible
        eval: function () {
          processResistance(
            false,
            "Barbarian(LaserLlama): Rage",
            ClassList["barbarian(laserllama)"].features.rage.dmgres
          );
        },
        removeeval: function () {
          processResistance(
            true,
            "Barbarian(LaserLlama): Rage",
            ClassList["barbarian(laserllama)"].features.rage.dmgres
          );
        },
      },
      eagle: {
        name: "Eagle Spirit",
        description: desc([
          "While Raging, I can use a bonus action to gain the benefits of the Dash and Disengage action, including the bonus action that I use to enter a Rage",
        ]),
        action: ["bonus action", " (Dash & Disengage)"],
      },
      elk: {
        name: "Elk Spirit",
        description: desc([
          "While Raging, my walking speed increases by 15 ft and ignore difficult terrain",
        ]),
        dmgres: [
          ["ignore difficult terrain", "ignore difficult terrain (rage)"],
        ], // have to keep this as short as possible
        eval: function () {
          processResistance(
            false,
            "Barbarian(LaserLlama): Rage",
            ClassList["barbarian(laserllama)"].features.rage.dmgres
          );
        },
        removeeval: function () {
          processResistance(
            true,
            "Barbarian(LaserLlama): Rage",
            ClassList["barbarian(laserllama)"].features.rage.dmgres
          );
        },
      },
      tiger: {
        name: "Tiger Spirit",
        description: desc([
          "Once per turn while Raging, I can use mighty leap at its lowest level without expending an Exploit Die",
        ]),
      },
      wolf: {
        name: "Wolf Spirit",
        description: desc([
          "While raging, friends have advantage on melee attacks vs. hostiles creatures within 10 ft of me",
        ]),
      },
    },
    subclassfeature6: {
      name: "Bestial Skill",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc(
        'Choose Elephant, Owl or Panther using the "Choose Feature" button above'
      ),
      choices: ["Elephant", "Owl", "Panther"],
      elephant: {
        name: "Aspect of the Elephant",
        description: desc(
          "I add my Con mod to Strength (Athletics) and Wisdom (Insight) checks"
        ),
        addMod: [
          {
            type: "skill",
            field: "Athletics",
            mod: "max(Con|0)",
            text: "I add my Con mod to Strength (Athletics) and Wisdom (Insight) checks",
          },
          {
            type: "skill",
            field: "Insight",
            mod: "max(Con|0)",
            text: "I add my Con mod to Strength (Athletics) and Wisdom (Insight) checks",
          },
        ],
      },
      owl: {
        name: "Aspect of the Owl",
        description: desc(
          "I add my Con mod to Intelligence (Investigation) and Wisdom (Perception) checks"
        ),
        addMod: [
          {
            type: "skill",
            field: "Investigation",
            mod: "max(Con|0)",
            text: "I add my Con mod to Intelligence (Investigation) and Wisdom (Perception) checks",
          },
          {
            type: "skill",
            field: "Perception",
            mod: "max(Con|0)",
            text: "I add my Con mod to Intelligence (Investigation) and Wisdom (Perception) checks",
          },
        ],
      },
      panther: {
        name: "Aspect of the Panther",
        description: desc(
          "I add my Con mod to Dexterity (Stealth) and Wisdom (Survival) checks"
        ),
        addMod: [
          {
            type: "skill",
            field: "Stealth",
            mod: "max(Con|0)",
            text: "I add my Con mod to Dexterity (Stealth) and Wisdom (Survival) checks",
          },
          {
            type: "skill",
            field: "Survival",
            mod: "max(Con|0)",
            text: "I add my Con mod to Dexterity (Stealth) and Wisdom (Survival) checks",
          },
        ],
      },
    },
    subclassfeature10: {
      name: "Wild Awareness",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "Whenever I finish a SR/LR I gain the benefits of the Commune with Nature spell.",
      ]),
      spellcastingBonus: {
        name: "Wild Awareness",
        spells: ["commune with nature"],
        selection: ["commune with nature"],
        firstCol: "(R)",
      },
      spellChanges: {
        "commune with nature": {
          time: "11 min",
          changes:
            "I cannot cast this spell but I have its benefits whenever I finish a long or short rest.",
        },
      },
    },

    "subclassfeature10.1": {
      name: "Council of Beasts",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "I can make 1H ritual (can be done as part of rests) to change one Bestial Spirit with one of the same list",
      ]),
      additional: "change totem",
      usages: 1,
      recovery: "long rest",
    },

    subclassfeature14: {
      name: "Bestial Champion",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      description: desc([
        'Choose Lion, Falcon or Rhino using the "Choose Feature" button',
      ]),
      choices: ["Lion", "Falcon", "Rhino"],
      lion: {
        name: "Lion Attunement",
        description: desc([
          "While raging, any hostile creatures within 5 feet of me has disadv. on attacks vs. others",
        ]),
      },
      falcon: {
        name: "Falcon Attunement",
        description: desc([
          "While raging, I gain a flying speed equal to my walk speed",
        ]),
      },
      rhino: {
        name: "Rhino Attunement",
        description: desc([
          "While Raging, if I hit a creature, that is equal or smaller than me in size, with a Strength melee weapon attack, it must succeed on a Strength save or be knocked prone",
        ]),
      },
    },
  },
});

// Path of the Berserker
AddSubClass("barbarian(laserllama)", "berserker", {
  regExpSearch: /berserker/i,
  subname: "Path of the Berserker",
  fullname: "Berserker",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: GetBarbarianSubclassExploits("Berserker", [
      "commanding presence",
      "savage rebuke",
      "bloodthirsty critical",
      "menacing shout",
      "roar of triumph",
    ]),
    "subclassfeature3.1": {
      name: "Frenzy",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "The first time I hit with a Strength-based weapon attack on my turn, I deal bonus damage equal to two rolls of my Exploit Die",
        "While Raging, my walking speed increases by 10 feet",
      ]),
    },
    subclassfeature6: {
      name: "Mindless Rage",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "While raging, I can't be charmed or frightened, and such effects are suspended",
        "Also, while raging I can ignore the effects of the first five levels of exhaustion",
      ]),
      savetxt: {
        text: ["Immune to being charmed/frightened and exhaustion in rage"],
      },
    },
    subclassfeature10: {
      name: "Intimidating Presence",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "I can use menacing shout without expending an Exploit Die per my Con mod (min 1)",
        "Also, when I hit a creature with a melee wea atk, it has disadv. on any save I force it to resist Frightened until the end of next turn",
      ]),

      limfeaname: "Menacing Shout",
      usages: "Con mod per ",
      usagescalc: "event.value = Math.max(1, What('Con Mod'));",
      recovery: "long rest",
    },
    subclassfeature14: {
      name: "Unrivaled Fury",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      description: desc([
        "I can use savage rebuke at will, without expending an Exploit Die while raging",
        "I can also add my Frenzy damage bonus once during each turn, not just on mu turn",
      ]),
      calcChanges: {
        spellAdd: [
          function (spellKey, spellObj, spName) {
            if (spellKey == "savage rebuke") {
              spellObj.firstCol = "atwill";
              return true;
            }
          },
          "I can use the Savage Rebuke exploit at will without expending an Exploit Die",
        ],
      },
    },
  },
});

// Path of Blood & Iron (battlerager)
AddSubClass("barbarian(laserllama)", "blood and iron", {
  regExpSearch: /blood and iron/i,
  subname: "Path of Blood and Iron",
  fullname: "Blood and Iron",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: GetBarbarianSubclassExploits("Blood & Iron", [
      "crushing grip",
      "mighty leap",
      "honor duel",
      "bloodthirsty critical",
      "savage defiance",
    ]),
    "subclassfeature3.1": {
      name: "Warrior Smith",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I gain proficiency with smith's tools and heavy armor; I can rage in heavy armor",
      ]),
      armorProfs: [false, false, true, false],
      toolProfs: ["Smith's tools"],
      armorOptions: {
        regExpSearch:
          /^(?!.*(dragon|draconic|beast))(?=.*spike(d|s))(?=.*armou?r).*$/i,
        name: "Spiked armor",
        source: [["S", 121]],
        type: "medium",
        ac: 14,
        stealthdis: true,
        weight: 45,
      },
    },
    "subclassfeature3.2": {
      name: "Spiked Armor",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map(function (n) {
        var ExplDie = n < 5 ? 4 : n < 11 ? 6 : n < 17 ? 8 : 10;
        var ArmorLimit =
          n < 6 ? "a set of non-magical armor" : "any set of armor";

        return desc([
          "I can spend 1 h (can be during a rest) to use smith's tools and affix spikes to " +
          ArmorLimit +
          ", turning it into Spiked Armor. It gains those properties when I wear it:",
          "\u2022 It is a martial melee weapon with 5 ft reach and deals 1d" +
          ExplDie +
          " + Str mod on hit",
          "\u2022 While Raging, I can use a bonus action on my turn to make a single Spiked Armor attack",
          "\u2022 If I successfully grapple a creature, it takes 1d" +
          ExplDie +
          " piercing damage",
        ]);
      }),
      action: ["bonus action", "Armor Spikes attack (in rage)"],
      weaponOptions: {
        regExpSearch: /^(?=.*armou?r)(?=.*spike).*$/i,
        name: "Armor spikes",
        source: [["S", 121]],
        ability: 1,
        type: "armor spikes",
        damage: [1, 4, "piercing"],
        range: "Melee",
        description:
          "Does an exploit die of piercing damage if I successfully grapple a creature",
        abilitytodamage: true,
      },
      weaponProfs: [false, false, ["armor spikes"]],
      weaponsAdd: ["Armor Spikes"],
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (
              /armor spikes/i.test(v.WeaponName + v.baseWeaponName) &&
              classes.known["barbarian(laserllama)"] &&
              classes.known["barbarian(laserllama)"].level
            ) {
              try {
                var curDie = eval_ish(fields.Damage_Die.replace("d", "*"));
              } catch (e) {
                var curDie = "x";
              }

              var aExplDie = (function (n) {
                return n < 5 ? 4 : n < 11 ? 6 : n < 17 ? 8 : 10;
              })(classes.known["barbarian(laserllama)"].level);

              if (isNaN(curDie) || curDie < aExplDie) {
                fields.Damage_Die = "1d" + aExplDie;
              }
            }
          },
          "My armor spikes deal piercing damage equal to one roll of my Exploit Die",
          6, // Evaluated after Monk's martial arts atkAdd
        ],
      },
    },
    subclassfeature6: {
      name: "Mythic Smith",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "Improved Spiked Armor (see Spiked Armor).",
        "Also if a magic armor give AC bonus I can change it to attack and damage bonus of my Spike Armor",
      ]),
    },
    "subclassfeature6.1": {
      name: "Battle Hysteria",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "While Raging, once per turn, the first time I attack Recklessly I gain temporary hit points equal to my Con mod.",
      ]),
    },
    subclassfeature10: {
      name: "Wild Charge",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "While Raging, I can use a bonus action to move my speed and make an unarmed strike with my Spiked Armor",
      ]),
      action: ["bonus action", " (while Raging)"],
    },
    subclassfeature14: {
      name: "Spiked Retribution",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      description: desc([
        "While Raging and wearing Spiked Armor:",
        "When I'm hit with a melee attack, the attacker takes piercing damage equal to my Str mod",
        "If conscious, I can use my reaction to add my Expl Die to the dmg dealt to the attacker",
      ]),
      action: ["reaction", ""],
    },
  },
});

// Path of the Brute
AddSubClass("barbarian(laserllama)", "brute", {
  regExpSearch: /brute/i,
  subname: "Path of the Brute",
  fullname: "Brute",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: GetBarbarianSubclassExploits("Brutish", [
      "commanding presence",
      "crushing grip",
      "concussive blow",
      "greater hurl",
      "confounding critical",
    ]),
    "subclassfeature3.1": {
      name: "The Wrong Crowd",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc(
        "I learn Thieves' Cant",
        "Carousing counts as resting for me as long I don't deal or take damage. In addirion, when I spend a night carousing in a settlement of any size, I have adv. on all checks to gather info on that settlement"
      ),
      languageProfs: ["Thieves' Cant"],
    },
    "subclassfeature3.2": {
      name: "Unarmed & Dangerous",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I gain the following:",
        " \u2022 My unarmed strikes and impovised weapon use my Exploit Die for damage unless higher",
        " \u2022 I gain proficiency with improvised weapons",
        " \u2022 I can use Con instead of Dex for my AC calculation in light and medium armor",
        " \u2022 When raging, if I use my action to only make unarmed attacks/shove/grapple, I can make another as bonus action",
      ]),
      weaponsAdd: ["Unarmed Strike"],
      action: ["bonus action", ""],
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (
              v.baseWeaponName == "unarmed strike" &&
              classes.known["barbarian(laserllama)"] &&
              classes.known["barbarian(laserllama)"].level
            ) {
              try {
                var curDie = eval_ish(fields.Damage_Die.replace("d", "*"));
              } catch (e) {
                var curDie = "x";
              }

              var aBruteDie = (function (n) {
                return n < 5 ? 4 : n < 11 ? 6 : n < 17 ? 8 : 10;
              })(classes.known["barbarian(laserllama)"].level);

              if (isNaN(curDie) || curDie < aBruteDie) {
                fields.Damage_Die = "1d" + aBruteDie;
              }
            }
          },
          "My unarmed strikes deal bludgeoning damage equal to one roll of my Exploit Die",
          6, // Evaluated after Monk's martial arts atkAdd
        ],
      },
      extraAC: [
        {
          name: "Unarmed & Dangerous",
          mod: "max(Con-Dex|0)",
          text: "I can use my Con to calculate my AC instead of Dex while wearing light/medium armor",
          stopeval: function (v) {
            return !v.wearingArmor || v.heavyArmor; // light/medium armor only
          },
        },
      ],
    },
    subclassfeature6: {
      name: "Brutal Strikes",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "While Raging, my unarmed strikes count as magical for overcoming resistances & immunities",
        "On hit with an unarmed strike, I can use concussive blow without expending an Exploit Die. I can do this per Con mod, and regain all expended uses finishing a long rest.",
      ]),
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (
              v.baseWeaponName == "unarmed strike" &&
              !v.thisWeapon[1] &&
              !v.theWea.isMagicWeapon &&
              !/counts as( a)? magical/i.test(fields.Description)
            ) {
              fields.Description +=
                (fields.Description ? "; " : "") + "Counts as magical in rage";
            }
          },
          "My unarmed strikes count as magical for overcoming resistances and immunities, but only during my rage.",
        ],
      },
      limfeaname: "Concussive blows",
      usages: "Con mod per ",
      usagescalc: "event.value = Math.max(1, What('Con Mod'));",
      recovery: "long rest",
    },
    subclassfeature10: {
      name: "Iron Grip",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "While Raging, I can grapple creatures up to two sizes larger than me and my walk speed is no longer halved when dragging a grappled creature.",
        "In addition when I make an Athletics check to grapple/shove I gain a bonus equal to my Expl Die",
      ]),
    },
    subclassfeature14: {
      name: "Brutish Determination",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      description: desc([
        "When I make a Strength, Dexterity, Constitution, or death save, I add a d4 to my roll",
        "If I roll a total of ≥20 on a death save, I instantly regain consciousness and stand up with 1 HP",
      ]),
    },
  },
});

// Path of the Champion
AddSubClass("barbarian(laserllama)", "champion", {
  regExpSearch: /champion/i,
  subname: "Path of the Champion",
  fullname: "Champion", // same name as fighter subclass; it will break the regex (only one of those two can work at the same time) // let me know if this is something you want to be fixed
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    // Override martial exploits because size of die increases
    // NOTE: This has been copy pasted from the main class. IT WON'T WORK IF YOU TRY TO USE newObj ! (it will cause a crash because of some variable's scope)
    // I do not know how to fix that scoping bug, so I went for the more brute force approach. If it works, it aint stupid ;)
    "savage exploits": (function () {
      // Fixed attributes
      SavageExploits = {
        name: "Savage Exploits",
        minlevel: 2,
        source: [["GMB:LL", 0]],
        description: desc([
          "I gain Exploit Dice, which are used to fuel my Savage Exploits",
          "My Expl Die is increased by 1 size because of my Champion archetype",
          'Use the "Choose Feature" button above to choose Savage Exploits',
        ]),
        toNotesPage: [
          {
            name: "Savage Exploits",
            note: desc([
              "Below are all Savage Exploits I know. Each 3rd and 4th degree exploits can only be used once per short rest. Each 5th degree exploit can only be used once per long rest.",
            ]),
          },
        ],

        // Savage Exploits
        extraname: "Savage Exploits",
        extrachoices: [],
        extraTimes: [
          "",
          2,
          2,
          2,
          3,
          3,
          4,
          4,
          5,
          5,
          6,
          6,
          7,
          7,
          7,
          7,
          8,
          8,
          8,
          8,
        ],

        // Exploit dice
        limfeaname: "Exploit Dice",
        usages: ["", 2, 3, 3, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6],
        additional: [
          "",
          "d4",
          "d4 (d6 in rage)",
          "d4 (d6 in rage)",
          "d6 (d8 in rage)",
          "d6 (d8 in rage)",
          "d6 (d8 in rage)",
          "d6 (d8 in rage)",
          "d6 (d8 in rage)",
          "d6 (d8 in rage)",
          "d8 (d10 in rage)",
          "d8 (d10 in rage)",
          "d8 (d10 in rage)",
          "d8 (d10 in rage)",
          "d8 (d10 in rage)",
          "d8 (d10 in rage)",
          "d10 (d12 in rage)",
          "d10 (d12 in rage)",
          "d10 (d12 in rage)",
          "d10 (d12 in rage)",
        ],
        recovery: "short rest",
      };

      // Make a filtered spell list that contains only barbarian(laserllama) "spells"
      const BarbarianSpells = Object.keys(SpellsList)
        .filter((key) => SpellsList[key].isExploit)
        .filter((key) => {
          for (var i = 0; i < SpellsList[key].classes.length; i++) {
            if (SpellsList[key].classes[i] == "barbarian(laserllama)")
              return true;
          }
          return false;
          // NOTE: this is literally a SpellsList[key].classes.includes("barbarian(laserllama)") but for some cursed reason I can't use that function
        });

      // Iterate over all barbarian(laserllama) "spells"
      for (var i = 0; i < BarbarianSpells.length; i++) {
        var NewSpell = SpellsList[BarbarianSpells[i]];
        var tempSpell = BarbarianSpells[i];

        SavageExploits.extrachoices.push(NewSpell.name); // Add "spell" name to menu options

        SavageExploits[BarbarianSpells[i]] = {
          // Add "spell" to the main item (when it is picked through the menu)
          name: NewSpell.name,
          toNotesPage: [
            {
              // What is added to the notes page
              name:
                NewSpell.name +
                " Exploit [" +
                (NewSpell.level == 1
                  ? "1st"
                  : NewSpell.level == 2
                    ? "2nd"
                    : NewSpell.level == 3
                      ? "3rd"
                      : NewSpell.level + "th") +
                " degree]",
              note: desc(NewSpell.descriptionFull),
              amendTo: "Savage Exploits",
            },
          ],
          source: NewSpell.source,
          addMod: NewSpell.addMod,
          submenu: NewSpell.submenu,
          prereqeval: ExploitPrereqFactory(
            BarbarianSpells[i],
            "barbarian(laserllama)"
          ),
          eval: CreateSavageSpellsheet, // in case the user removes all exploits
          spellcastingBonusElsewhere: {
            addTo: "savage exploits",
            spellcastingBonus: {
              name: "Savage Exploits",
              spellcastingAbility: 1,
              spells: [BarbarianSpells[i]],
              selection: [BarbarianSpells[i]],
            },
          },
        };
      }

      return SavageExploits;
    })(),

    subclassfeature3: GetBarbarianSubclassExploits("Champion", [
      "feat of strength",
      "mighty leap",
      "honor duel",
      "thunderous blow",
      "mythic resilience",
    ]),
    "subclassfeature3.1": {
      name: "Fighting Style",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc(
        'Choose a Fighting Style for your character using the "Choose Feature" button above'
      ),
      choices: [
        "Archery",
        "Balanced",
        "Brawling",
        "Classical Swordplay",
        "Defensive",
        "Dual Wielding",
        "Polearm Fighting",
        "Featherweight Fighting",
        "Great Weapon Fighting",
        "Improvised Fighting",
        "Melee Marksman",
        "Mounted Warrior",
        "Protection",
        "Strongbow",
        "Hurler",
        "Versatile Fighting",
        "Blind Warrior",
        "Exotic Warrior",
        "Heavyweight Fighting",
        "Mariner",
        "Mountaineer",
        "Shield Warrior",
        "Standard Bearer",
        "Superior Technique",
      ],
      archery: FightingStylesLL.archery,
      balanced: FightingStylesLL.balanced,
      brawling: FightingStylesLL.brawling,
      "classical swordplay": FightingStylesLL.classical,
      defensive: FightingStylesLL.defensive,
      "dual wielding": FightingStylesLL.dual_wielding,
      "polearm fighting": FightingStylesLL.polearm,
      protection: FightingStylesLL.protection,
      "featherweight fighting": FightingStylesLL.featherweight,
      "great weapon fighting": FightingStylesLL.great_weapon,
      "improvised fighting": FightingStylesLL.improvised,
      "exotic warrior": FightingStylesLL.exotic,
      "melee marksman": FightingStylesLL.marksman,
      "mounted warrior": FightingStylesLL.mounted,
      strongbow: FightingStylesLL.strongbow,
      hurler: FightingStylesLL.hurler,
      "versatile fighting": FightingStylesLL.versatile,
      "blind warrior": FightingStylesLL.blind,
      "heavyweight fighting": FightingStylesLL.heavyweight,
      mariner: FightingStylesLL.mariner,
      mountaineer: FightingStylesLL.mountaineer,
      "shield warrior": FightingStylesLL.shieldwarrior,
      "superior technique": FightingStylesLL.superior_technique,
      "standard bearer": FightingStylesLL.standardbearer,
    },
    subclassfeature6: {
      name: "Mighty Blow",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "While raging, once per short/long rest, I can choose to end my rage after hitting with a Strength-based weapon attack to turn the hit into a crit",
      ]),
      usages: 1,
      recovery: "short rest",
    },
    "subclassfeature6.1": {
      name: "Warrior's Discipline",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "I gain a climbing and swimming speed equal to my walking speed",
        "Also, I can spend 1 hour of practice to change my fighting style",
      ]),
      speed: {
        swim: { spd: "walk", enc: 0 },
        climb: { spd: "walk", enc: 0 },
      },
    },
    subclassfeature10: {
      name: "Invigorating Critical",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: "\n     When I crit, I regain HP equal to my Expl Die + my Con mod",
    },
    subclassfeature14: {
      name: "Paragon of Battle",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      description: desc([
        "At the start of my turn, if I'm not at 0 HP I gain temp HP equal to my Con mod",
      ]),
    },
  },
});

// Path of the Elemental Chaos (storm herald)
AddSubClass("barbarian(laserllama)", "elemental chaos", {
  regExpSearch: /^(?=.*elemental)(?=.*chaos).*$/i,
  subname: "Path of the Elemental Chaos",
  fullname: "Elemental Chaos",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: GetBarbarianSubclassExploits("Elemental", [
      "hurl",
      "destructive strike",
      "shattering slam",
      "thunderous blow",
      "destructive slam",
    ]),
    "subclassfeature3.1": {
      name: "Heart of Chaos",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc(
        'Use the "Choose Feature" button above to select the effect'
      ),
      choices: ["Air", "Fire", "Water"],
      air: {
        name: "Heart of Chaos: Air",
        description: levels.map(function (n) {
          if (n < 6)
            return desc([
              "While raging, I gain the following:",
              " \u2022 I have resistance to lightning damage",
              " \u2022 My Rage and Exploit bonus damage, changes to lightning",
              " \u2022 When a creatures hits me with a melee I can use a reaction to deal 2 Expl Dice lightning damage",
            ]);
          if (n < 10)
            return desc([
              "I gain the following:",
              " \u2022 I have resistance to lightning damage",
              " \u2022 My Rage and Exploit bonus damage, changes to lightning",
              " \u2022 When a creatures hits me with a melee I can use a reaction to deal 2 Expl Dice lightning damage",
              " \u2022 While raging, I emanate a 10-foot aura that is difficult terrain for other creatures and if they start their turn in my aura, they lose their reaction for that turn",
            ]);
          return desc([
            "I gain the following:",
            " \u2022 I have resistance to lightning damage",
            " \u2022 My Rage and Exploit bonus damage, changes to lightning",
            " \u2022 When a creatures hits me with a melee I can use a reaction to deal 2 Expl Dice lightning damage",
            " \u2022 While raging, I emanate a 15-foot Aura that is difficult terrain for other creatures and if they start their turn in my aura, they lose their reaction for that turn",
            " \u2022 While raging, creatures of my choice that start their turn in my Aura takes one Expl Die + my Con mod lightning damage",
          ]);
        }),
        dmgres: ["Lightning"],
        action: ["reaction", ""],
      },
      fire: {
        name: "Heart of Chaos: Fire",
        description: levels.map(function (n) {
          if (n < 6)
            return desc([
              "While raging, I gain the following:",
              " \u2022 I have resistance to fire damage",
              " \u2022 My Rage and Exploit bonus damage, changes to fire",
              " \u2022 When a creatures hits me with a melee I can use a reaction to deal 2 Expl Dice fire damage",
            ]);
          if (n < 10)
            return desc([
              "I gain the following:",
              " \u2022 I have resistance to fire damage",
              " \u2022 My Rage and Exploit bonus damage, changes to fire",
              " \u2022 When a creatures hits me with a melee I can use a reaction to deal 2 Expl Dice fire damage",
              " \u2022 While raging, I emanate a 10-foot aura, creatures that start their turn in my aura, have disadv. on attack rolls against targets other than me",
            ]);
          return desc([
            "I gain the following:",
            " \u2022 I have resistance to fire damage",
            " \u2022 My Rage and Exploit bonus damage, changes to fire",
            " \u2022 When a creatures hits me with a melee I can use a reaction to deal 2 Expl Dice fire damage",
            " \u2022 While raging, I emanate a 15-foot aura, creatures that start their turn in my aura, have disadv. on attack rolls against targets other than me",
            " \u2022 While raging, creatures of my choice that start their turn in my Aura takes one Expl Die + my Con mod fire damage",
          ]);
        }),
        dmgres: ["Fire"],
        action: ["reaction", ""],
      },
      water: {
        name: "Heart of Chaos: Water",
        description: levels.map(function (n) {
          if (n < 6)
            return desc([
              "While raging, I gain the following:",
              " \u2022 I have resistance to cold damage",
              " \u2022 My Rage and Exploit bonus damage, changes to cold",
              " \u2022 When a creatures hits me with a melee I can use a reaction to deal 2 Expl Dice cold damage",
            ]);
          if (n < 10)
            return desc([
              "I gain the following:",
              " \u2022 I have resistance to cold damage",
              " \u2022 My Rage and Exploit bonus damage, changes to cold",
              " \u2022 When a creatures hits me with a melee I can use a reaction to deal 2 Expl Dice cold damage",
              " \u2022 While raging, I emanate a 10-foot aura, creatures that start their turn in my aura, have their speed halved until the start of their next turn",
            ]);
          return desc([
            "I gain the following:",
            " \u2022 I have resistance to cold damage",
            " \u2022 My Rage and Exploit bonus damage, changes to cold",
            " \u2022 When a creatures hits me with a melee I can use a reaction to deal 2 Expl Dice cold damage",
            " \u2022 While raging, I emanate a 10-foot aura, creatures that start their turn in my aura, have their speed halved until the start of their next turn",
            " \u2022 While raging, creatures of my choice that start their turn in my Aura takes one Expl Die + my Con mod cold damage",
          ]);
        }),
        dmgres: ["Cold"],
        action: ["reaction", ""],
      },
    },
    subclassfeature6: {
      name: "Controlled Chaos",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "I gain the benefits of my Heart of Chaos even while not raging",
      ]),
    },
    "subclassfeature6.1": {
      name: "Elemental Whirlwind",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "While raging, my Heart of Chaos emits a 10-foot radius Aura with with new effects (see Heart of Chaos element)",
      ]),
    },
    subclassfeature10: {
      name: "Greater Whirlwind",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "My Heart of Chaos aura is improved (see Heart of Chaos element)",
      ]),
      // not limited to resistance but I don't see the use in copying the content of elemental body here again
    },
    subclassfeature14: {
      name: "Primal Destruction",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      description: desc(
        "As an action, I can expend a use of Rage to emit an elemental blast",
        "Creatures of my choice within 30 feet must do a Dex save against my Expl DC or fall prone an take 6 Expl Die damage of my element (half on success)"
      ),
    },
  },
});

// Path of the Lycan (beast)
AddSubClass("barbarian(laserllama)", "lycan", {
  regExpSearch: /lycan/i,
  subname: "Path of the Lycan",
  fullname: "Lycan",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: GetBarbarianSubclassExploits("Lycan", [
      "cunning instinct",
      "mighty leap",
      "menacing shout",
      "bloodthirsty critical",
      "roar of triumph",
    ]),
    "subclassfeature3.1": {
      name: "Bestial Rage",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map(function (n) {
        var ExplDie = n < 5 ? 4 : n < 11 ? 6 : n < 17 ? 8 : 10;

        return desc([
          "When I enter my rage, I gain a bite, tail, and claws attack for that rage",
          "On a hit with the bite attack once on each of my turns, I can gain Con mod of temp HP",
          "With the claws I can make one extra attack when I attack with it in my Attack action with only my claws",
          "As a reaction with the tail when I'm hit, I can add a Expl Die to my AC for that attack",
          "This only works if the hit is from an attack roll made a creature I can see within 10 ft",
        ]);
      }),
      weaponOptions: [
        {
          regExpSearch: /^(?=.*(bestial|beast))(?=.*bite).*$/i,
          name: "Bestial Bite",
          source: [["T", 24]],
          ability: 1,
          type: "Natural",
          damage: [1, 8, "piercing"],
          range: "Melee",
          description:
            "Only in rage; On a hit once on my turn, gain Con mod temp HP",
          abilitytodamage: true,
          bestialNaturalWeapon: true,
        },
        {
          regExpSearch: /^(?=.*(bestial|beast))(?=.*claws?).*$/i,
          name: "Bestial Claws",
          source: [["T", 24]],
          ability: 1,
          type: "Natural",
          damage: [1, 6, "slashing"],
          range: "Melee",
          description:
            "Only in rage; Extra attack if used as part of Attack action",
          abilitytodamage: true,
          bestialNaturalWeapon: true,
        },
        {
          regExpSearch: /^(?=.*(bestial|beast))(?=.*tail).*$/i,
          name: "Bestial Tail",
          source: [["T", 25]],
          ability: 1,
          type: "Natural",
          damage: [1, 8, "piercing"],
          range: "Melee",
          description: "Reach; Only in rage",
          abilitytodamage: true,
          bestialNaturalWeapon: true,
        },
      ],
      weaponsAdd: ["Bestial Bite", "Bestial Claws", "Bestial Tail"],
      additional: levels.map(function (n) {
        return n < 6 ? "" : "chosen weapon counts as magical";
      }),
      action: [["reaction", "Bestial Tail"]],
    },
    "subclassfeature3.2": {
      name: "Beast Transformation",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: "\n    I can stransform in a Beast Form(see third page)",
      // Putting Beast Transformation on the third page because it's a wall of text; the subclass is already overflowing
      "beast form.wild shape": {
        name: "Beast Form",
        source: [["GMB:LL", 0]],
        minlevel: 3,
        description: desc([
          "I must make the permanent choice of a beast of CR 1 or lower to represent the animal that my curse is based on. I can use a bonus action to enter into this Beast Form using these rules:",
          " \u2022 My stats are replaced by its game statistics except HP, alignment, personalilty and Intelligence, Wisdom, and Charisma scores",
          " \u2022 I can remain in my Beast Form for 1 hour. I can revert to my normal form early as a bonus action, but I revert instantly when I'm Incapacitated.",
          " \u2022 When I Shift, I choose if my equipment merges with my Beast Form or if it falls to the ground. I can only merge with equipment that I can wear or carry.",
          " \u2022 my Beast Form retains the benefits and features from my class, race, and other sources, including Exploits, and can still use themas long as the Beast would be physically capable of doing so. However, I don't retain any special Senses, like Darkvision, unless my Beast Form also has that Sense.",
          " \u2022 I cannot cast spells while I am in a Beast Form. However, I can maintain my concentrationon spells and other abilities I used before I Shifted.",
        ]),
        action: [["bonus action", " (start/end)"]],
        additional: levels.map(function (n) {
          if (n < 3) return "";
          var cr = 1;
          var hr = 1;
          var restr = "";
          return (
            "CR " + cr + restr + "; " + hr + (restr.length ? " h" : " hour")
          );
        }),
      },
      autoSelectExtrachoices: [{ extrachoice: "beast form.wild shape" }],
    },
    subclassfeature6: {
      name: "Savage Strikes",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "My natural weapons count as magical for overcoming resistances and immunities",
        "My Beast Form now use my Prof Bonus instead of the beast's PB",
      ]),
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (
              v.theWea.bestialNaturalWeapon &&
              !v.thisWeapon[1] &&
              !v.theWea.isMagicWeapon &&
              !/counts as( a)? magical/i.test(fields.Description)
            ) {
              fields.Description +=
                (fields.Description ? "; " : "") + "Counts as magical";
            }
          },
          "The natural melee weapon that I gain from Form of the Beast count as magical for the purpose of overcoming resistance and immunity to nonmagical attacks and damage.",
        ],
      },
    },
    "subclassfeature6.1": {
      name: "Feral Might",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "I gain a climbing speed equal to my walking speed",
        "I can use cunning instinct and mighty leap at will without expending an Exploit Die (as if I spent 1 Die)",
      ]),
      spellAdd: [
        function (spellKey, spellObj, spName) {
          if (spellKey == "cunning instinct" || spellKey == "mighty leap") {
            spellObj.firstCol = "atwill";
            return true;
          }
        },
        "I can use cunning instinct and mighty leap at will without expending an Exploit Die (as if I spent 1 Die)",
      ],
      speed: {
        climb: { spd: "walk", enc: 0 },
      },
    },
    subclassfeature10: {
      name: "Infectious Fury",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "In rage, when I hit a creature with my natural weapon, I can have it make a Wis save.",
        "If it fails it suffers one effect of my choice:",
        "\u2022 It uses its reaction to make a melee attack against one creature I can see of my choice -or-",
        "\u2022 It takes 3 Expl Dice psychic damage.",
        "If I'm out of uses of this feature, I can expend an Exploit Die to use it.",
      ]),
      usages: "Con mod per ",
      usagescalc: "event.value = Math.max(1, What('Con Mod'));",
      recovery: "long rest",
      altResource: "ED",
    },
    subclassfeature14: {
      name: "Primal Roar",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      description: desc([
        "The limit of once per short rest does not apply to roar of triumph for me",
        "While a creature has the temp HP from this exploit, it also has adv. on the first attack on each of its turns",
      ]),
    },
  },
});

// Path of Sorcery (wild magic)
AddSubClass("barbarian(laserllama)", "sorcery", {
  regExpSearch: /sorcery/i,
  subname: "Path of Sorcery",
  source: [["GMB:LL", 0]],
  fullname: "Sorcery",
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: GetBarbarianSubclassExploits("Sorcerous", [
      "heroic fortitude",
      "mighty leap",
      "immovable stance",
      "thunderous blow",
      "savage defiance",
    ]),
    "subclassfeature3.1": {
      name: "Spellsense",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "As an action, until my next turn I can detect magic items or spells within 60 feet that aren't behind total cover. When I sense a spell, I learn its school of magic.",
        "I can use this feature per Con mod and regain all uses finishing a long rest",
      ]),
      action: [["action", ""]],
      usages: "Con mod per ",
      usagescalc: "event.value = Math.max(1, What('Con Mod'));",
      recovery: "long rest",
    },
    "subclassfeature3.2": {
      name: "Wild Sorcery",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "When I rage, I roll on this class' Wild Sorcery Table (d12, see notes)",
        "If the rolled effect requires a saving throw, it uses my Exploit Die DC, and last for the duration of my Rage even if they require Conc.",
      ]),
      toNotesPage: [
        {
          name: "Wild Sorcery Table",
          source: [["GMB:LL", 0]],
          note: [
            "If an effect calls for a saving throw, the DC is my Exploit DC and last for the duration of the Rage even if requires Conc.",
            "d12\tEFFECT",
            "1\tYour Rage damage bonus deals necrotic damage. Once per turn when you deal this necrotic damage to a creature, you gain temporary hit points equal to the necrotic damage. This has no effect on Undead.",
            "2\tAs a bonus action, you can teleport to an unoccupied space of your choice that you can see within 30 feet.",
            "3\tAs a bonus action, you can cause raw magic to explode at a point you can see within 30 feet. Creatures within 5 feet of that point must make a Dexterity saving throw or take force damage equal to twice your Exploit Die.",
            "4\tOne weapon you are holding is infused with magic. It gains the Thrown (20/60) and Light properties. When you make a ranged attack with it, it immediately returns to your hand after the attack.",
            "5\tWhen a creature you can see within 30 feet damages you, you can use your reaction to force it to make a Dexterity saving throw. On a failure, it takes force damage equal to twice your Exploit Die.",
            "6\tYou know the mighty leap Exploit, and can use it without expending an Exploit Die.",
            "7\tYou gain resistance to the last type of damage you took. You can only be resistant to one type of damage from this effect at a time. For example, if you are hit by a firebolt, you gain resistance to fire until you take another type of damage.",
            "8\tYou are targeted by the enlarge part of an enlarge/reduce spell. If there isn't room for you to grow, roll again on this table.",
            "9\tYou emit bright light in a 15-foot radius. As a bonus action, you can force a creature in this bright light to make a Constitution saving throw. On a failure, it is Blinded until the beginning of your next turn.",
            "10\tYou can pass through solid creatures and objects as if they were difficult terrain. If you stop moving inside a solid object or creature, you are shunted to the last unoccupied space that you occupied.",
            "11\tMystical flowers and vines sprout from you in a 15-foot radius and move along with you. This radius counts as difficult terrain for creatures of your choice.",
            "12\tYou regain one expended use of your Rage. Roll again on the Wild Sorcery table.",
          ],
        },
      ],
    },
    subclassfeature6: {
      name: "Arcane Disruption",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "I have resistance to all damage from spells",
        "While I am Raging, creatures of my choice within 15 feet from me also gain this resistance",
      ]),
      dmgres: [["All from spells"]],
    },
    subclassfeature10: {
      name: "Unstable Sorcery",
      source: [["T", 26]],
      minlevel: 10,
      description: desc([
        "As a reaction in rage when taking damage or failing a save, I can lash out with magic",
        "I roll on the Wild Sorcery table and immediately apply the roll, replacing my current effect", // unsure if it does replace the old effect
      ]),
      action: [["reaction", " (in rage on damage/save fail)"]],
    },
    subclassfeature14: {
      name: "Chaos Incarnate",
      source: [["T", 26]],
      minlevel: 14,
      description: desc([
        "Whenever I roll on the Wild Sorcery table, I can roll two dice and choose which to use",
        "I learn the Sundering Strike Exploit and it cannot be replaced. I can use it more than once per long/shor rest and I can expend a use of my Rage instead of an Expl Die for it",
      ]),
      spellcastingBonusElsewhere: {
        addTo: "savage exploits",
        spellcastingBonus: {
          name: "Sundering Strike",
          spellcastingAbility: 1,
          spells: ["sundering strike"],
          selection: ["sundering strike"],
          prepared: true,
        },
      },
      toNotesPage: [
        {
          // What is added to the notes page
          name: "Sundering Strike [4th degree]",
          note: desc(SpellsList["sundering strike"].descriptionFull),
          amendTo: "Savage Exploits",
        },
      ],
      spellChanges: {
        "sundering strike": {
          description:
            "Destroy magical force field; if above SL 3, DC 10+SL strength check",
          changes:
            "I can use it more than once per short/long rest and I can expend Rage uses instead of Exploit Dice to use it",
        },
      },
    },
  },
});

// Path of the Zealot
AddSubClass("barbarian(laserllama)", "zealot", {
  regExpSearch: /zealot/i,
  subname: "Path of the Zealot",
  fullname: "Zealot",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: GetBarbarianSubclassExploits("Zealous", [
      "feat of strength",
      "savage rebuke",
      "honor duel",
      "menacing shout",
      "mythic resilience",
    ]),
    "subclassfeature3.1": {
      name: "Divine Mandate",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc(
        "Spells restoring me to life (not undeath or anything else) don't require material comp."
      ),
    },
    "subclassfeature3.2": {
      name: "Champion of the Gods",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        'Choose using the "Choose Feature" button above following your divine alignment',
      ]),
      choices: ["Evil", "Neutral", "Good"],
      evil: {
        name: "Champion of the Evil Gods",
        description: desc([
          "While raging, the first creature I hit with a weapon attack in my turn takes extra damage",
          "This is necrotic damage equal to twice my Expl Die",
        ]),
      },
      neutral: {
        name: "Champion of the Neutral Gods",
        description: desc([
          "While raging, the first creature I hit with a weapon attack in my turn takes extra damage",
          "This is thunder damage equal to twice my Expl Die",
        ]),
      },
      good: {
        name: "Champion of the Good Gods",
        description: desc([
          "While raging, the first creature I hit with a weapon attack in my turn takes extra damage",
          "This is radiant damage equal to twice my Expl Die",
        ]),
      },
    },
    subclassfeature6: {
      name: "Unwaivering Faith",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "When I fail a saving throw while raging, I can expend an Exploit Die to add it to the roll",
      ]),
    },
    subclassfeature10: {
      name: "Fanatical Fervor",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "As a bonus action, I choose up to my Barbarian level creatures within 30 ft that can hear my battle cry",
        "These creatures gain adv. on attacks and saves until the start of my next turn",
        "I can do this once per long rest unless I expend one use of Rage to do it again",
      ]),
      usages: 1,
      recovery: "long rest",
      action: ["bonus action", ""],
    },
    subclassfeature14: {
      name: "Undying Zealot",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      description: desc([
        "While raging, having 0 hit points doesn't knock me unconscious",
        "I still must make death saves, and I suffer the normal effects of taking damage",
        "If I start my turn with 3 failed death saves, I must make a DC 10 Con save to maintain my rage",
        "I only die due to failed death saves if my rage ends while I'm at 0 HP",
      ]),
    },
  },
});

// Path of the Deep
AddSubClass("barbarian(laserllama)", "deep", {
  regExpSearch: /deep/i,
  subname: "Path of the Deep",
  fullname: "Deep",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: GetBarbarianSubclassExploits("Deep", [
      "crushing grip",
      "cunning instinct",
      "immovable stance",
      "rending strike",
      "primal terror",
    ]),
    "subclassfeature3.1": {
      name: "Gift of the Depths",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc(
        "I gain a swim speed equal to my walk speed and can breathe both air and water"
      ),
      speed: {
        swim: { spd: "walk", enc: 0 },
      },
    },
    "subclassfeature3.2": {
      name: "Eldritch Tendrils",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map(function (n) {
        if (n < 10) {
          return desc([
            "While raging, I manifest eldritch tendrils (can be attacked as part of me)",
            "As a bonus action (even when I enter rage), I can force one crea my size or smaller within 15 ft to make a Str save (adv. if larger than me) or be pulled 15 ft towards me",
            "If it ends within 5 feet of me, it is grappled by my eldritch tendrils. I can only have one creature grappled at time by my tendrils",
          ]);
        }
        return desc([
          "While raging, I manifest eldritch tendrils (can be attacked as part of me)",
          "As a bonus action (even when I enter rage), I can force two crea my size or smaller, or one crea one size larger than me, within 15 ft to make a Str save (adv. if larger than me) or be pulled 15 ft towards me",
          "If it ends within 5 feet of me, it is grappled by my eldritch tendrils. I can only have up to two creatures (only one if size is one larger than mine) grappled at time by my tendrils",
        ]);
      }),
      action: ["bonus action", ""],
    },
    subclassfeature6: {
      name: "Reality Warp",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "As an action, or when I enter my Rage, I can teleport (with any equipment I are wearing/carrying), to an unoccupied space within 30 ft",
        "I have Con mod uses per long rest and regain one use per short rest",
        "If I have no uses left, I can expend an Exploit Die to use it again",
      ]),
      usages: "Con mod per ",
      usagescalc: "event.value = Math.max(1, What('Con Mod'));",
      altResource: "ED",
      recovery: "long rest",
      action: ["action", ""],
    },
    subclassfeature10: {
      name: "Empowered Tendrils",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      description: desc([
        "My tendrils grants me climb speed equal to my walk speed and I can climb with my hands free",
        "My Eldritch Tendrils are improved (see Eldritch Tendrils)"
      ]),
      speed: {
        climb: { spd: "walk", enc: 0 },
      },
    },
    subclassfeature14: {
      name: "The Horrors Below",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      description: desc([
        "When I use Reality Warp, I can force crea within 10 ft of the destination to make a Wis save or take  2 Expl Die psychic damage (half on save) and be frightened of me until the start of my next turn",
        "Creatures immune to fear automatically succeed and take no damage",
      ]),
    },
  },
});

// Path of the Favored
AddSubClass("barbarian(laserllama)", "favored", {
  regExpSearch: /favored/i,
  subname: "Path of the Favored",
  fullname: "Favored",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: GetBarbarianSubclassExploits("Favored", [
      "feat of strength",
      "heroic fortitude",
      "ringing critical",
      "thunderous blow",
      "mythic athleticism",
    ]),
    "subclassfeature3.1": {
      name: "Favored Presence",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "As a bonus action, I gain a bonus equal to my Con mod (min +1) to all Charisma checks",
        "This bonus last for 10 minutes or unitl I go Rage, do damage or force a save to a creature",
      ]),
      action: ["bonus action", ""],
    },
    "subclassfeature3.2": {
      name: "Fate-Touched",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "When I roll a 1 on an Expl Die I can reroll and take the new result (even if it is another 1)",
        "When I Rage, I gain the following benefits:",
        "\u2022 When hit by an attack, I can use a reaction and expend an Exploit Die to add it to my AC against that attack",
        "\u2022 When I miss a Str-based attack, I can expend an Exploit Die to add it to the roll",
      ]),
      action: ["reaction", " (when hit by attack)"],
    },
    subclassfeature6: {
      name: "Glorious Cause",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "When I Rage, me and a number of creatures of my choice up to my Con mod (min of 1) within 30 ft gain temp HP equal to one Expl Die + 1",
      ]),
    },
    "subclassfeature6.1": {
      name: "Tireless Hero",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: levels.map(function (n) {
        var TirelessDie = n < 14 ? 4 : 6;

        return desc([
          "When I make a skill check where I have Prof, I gain a d" +
          TirelessDie +
          " bonus to the roll",
        ]);
      }),
      calcChanges: {
        spellAdd: [
          function (spellKey, spellObj, spName) {
            if (spellKey == "feat of strength") {
              spellObj.firstCol = "atwill";
              return true;
            }
          },
          "I can use the Feat of Strength exploit using a d4 (or d6 if level >14) instead of expending an Exploit Die",
        ],
      },
    },
    subclassfeature10: {
      name: "Wondrous Success",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: levels.map(function (n) {
        var WondrousDie = n < 14 ? 4 : 6;

        return desc([
          "Once per short/long rest, I can use my barbarian level instead of rolling the d20",
          "Also once per round, when I use Fate-Touched, I can use a d" +
          WondrousDie +
          " instead of expend one of my Expl Dice",
        ]);
      }),
      recovery: "short rest",
      usages: 1,
    },
    subclassfeature14: {
      name: "Legendary Strength",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      description: desc([
        "I learn Colossal Strength, but it doesn't count against my total and cannot replace it",
        "If I alreaddy knew this Exploit I can learn another Savage Exploit",
        "When I use Colossal Strength, I calculate the base amount of weight I can push, drag, pull, or lift as if I had spent one additional Exploit Die (maximum of 6)",
        "Finally my Tireless Hero and Wondrous Success are improved (see both)",
      ]),
      spellcastingBonusElsewhere: {
        addTo: "savage exploits",
        spellcastingBonus: {
          name: "Strength Overwhelming",
          spellcastingAbility: 1,
          spells: ["colossal strength"],
          selection: ["colossal strength"],
          prepared: true,
        },
      },
      toNotesPage: [
        {
          // What is added to the notes page
          name: "Colossal Strength [4th degree]",
          note: desc(SpellsList["colossal strength"].descriptionFull),
          amendTo: "Favored",
        },
      ],
      spellChanges: {
        "colossal strength": {
          description:
            "My push/drag/lift capacity increases greatly; when it ends, DC17 Con save or exhaustion (see book)",
          changes:
            "When I use Strength of the Colossus, I calculate the base amount of weight I can push, drag, pull, or lift as if I had spent one additional Exploit Die (maximum of 6)",
        },
      },
    },
  },
});

// Path of the Inferno
AddSubClass("barbarian(laserllama)", "inferno", {
  regExpSearch: /inferno/i,
  subname: "Path of the Inferno",
  fullname: "Inferno",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: GetBarbarianSubclassExploits("Infernal", [
      "commanding presence",
      "mighty leap",
      "bloodthirsty critical",
      "menacing shout",
      "primal terror",
    ]),
    "subclassfeature3.1": {
      name: "Abyssal Hide",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map((n) => {
        if (n < 10)
          return desc([
            "When I am Raging I gain the following benefits:",
            " \u2022 I use STR instead of DEX for my unarmored defense (added Blighted Hide to armor for this benefit)",
            " \u2022 I can use the Mighty Leap exploit as a bonus action (rage one included), without expending an Expl Die",
            " \u2022 My Rage and Exploit bonus damage is fire damage and ignores the fire damage resistance",
          ]);
        return desc([
          "I gain the following benefits:",
          " \u2022 I use STR instead of DEX for my unarmored defense (added Blighted Hide to armor for this benefit)",
          " \u2022 I can use the Mighty Leap exploit as a bonus action (rage one included), without expending an Expl Die",
          " \u2022 My Rage and Exploit bonus damage is fire damage and ignores the fire damage resistance",
        ]);
      }),
      armorOptions: [
        {
          name: "Blighted Hide",
          source: ["HB", 0],
          regExpSearch: /^(?=.*blighted)(?=.*hide).*$/i,
          ac: "10+Con+Str",
          dex: -10,
          type: "",
          list: "magic",
          stealthdis: false,
          isMagicArmor: true,
          weight: 0,
          invName: "Blighted Hide Armor",
          affectsWildShape: true,
        },
      ],
      armorAdd: "Blighted Hide",
      action: ["bonus action", " (move in rage)"],
    },
    "subclassfeature3.2": {
      name: "Hellish Presence",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc(
        "I learn Abyssal and when I make an Intimidation check I add a bonus of one Exploit Die to the roll"
      ),
      languageProfs: ["Abyssal"],
    },
    subclassfeature6: {
      name: "Demonic Bloodlust",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc(
        "The first time I make a Reckless attack on my turn while Raging, I gain temp HP equal to my Con mod."
      ),
    },
    subclassfeature10: {
      name: "Corrupt Resilience",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "My Abyssal Warrior is improved (see Abyssal Warrior)",
        "When I use mighty leap while I am raging, I gain a flying speed equal to the bonus jump distance until the end of my turn",
      ]),
      spellChanges: {
        "mighty leap": {
          description:
            "After run 10 ft, expend a Exploit Die to Jump up to 30 feet in a line as bonus action, even exceeding you remaining speed",
          changes: "I gain 30 feet of flying speed until the end of the turn.",
        },
      },
    },
    subclassfeature14: {
      name: "Chaos Overwhelming",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      description: desc([
        "When I Rage, I gain one of the abilities below for the duration of that Rage:",
        "\u2022 I gain flying speed equal to my walking speed",
        "\u2022 My weapon attacks deals fire damage that ignores res and treat immunity as res. Creatures that takes this fire damage cannot regain hit point until they finish a long rest",
        "\u2022 I grow by one size category. While enlarged in this way, I add my Con mod to Str checks (min 1), my reach increas of 5 feet, and once per turn I deal extra damage equal to my Expl Die with Str-based attacks",
        "\u2022 I am immune to all non-magical bludg. pierc. and slash. damage. Silver weapons bypass this immunity",
      ]),
    },
  },
});

// Path of the Mutant
AddSubClass("barbarian(laserllama)", "mutant", {
  regExpSearch: /mutant/i,
  subname: "Path of the Mutant",
  fullname: "Mutant",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  spellcastingAbility: 3, // for the Acidic Bile mutation
  features: {
    subclassfeature3: GetBarbarianSubclassExploits("Mutagenic", [
      "crushing grip",
      "feat of strength",
      "rending strike",
      "whirlwind strike",
      "confounding critical",
    ]),
    "subclassfeature3.1": {
      name: "Aberrant Alchemy",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        'I learn mutations; Use the "Choose Feature" button above to select the options',
        "With a long rest, I can use my alchemist's supplies to replace a mutation I know",
        "During my rage, I manifest a number of Mutations equal to my Con mod gaining their benefits",
      ]),
      extraname: "Mutations Known",
      extraTimes: [
        "",
        "",
        3,
        3,
        3,
        5,
        5,
        5,
        5,
        7,
        7,
        7,
        7,
        9,
        9,
        9,
        9,
        9,
        9,
        9,
      ],
      extrachoices: [
        "Aberrant Sight",
        "Alchemical Resistance",
        "Aquatic Adaptation",
        "Monstrous Glide",
        "Enhanced Movement",
        "Oozing Form",
        "Synthetic Carapace",
        "Unnatural Physicality",
        "Corrosive Blood",
        "Dislocated Reach",
        "Engorged Physique",
        "Inoculated Vigor",
        "Toxic Symbiosis",
        "Viscous Grip",
        "Acidic Bile",
        "Alchemical Intellect",
        "Hideous Regeneration",
        "Grappling Appendages",
        "Monstrous Flight",
      ],
      "aberrant sight": {
        name: "Aberrant Sight",
        description: desc([
          "I gain 60 ft darkvision. If I already have darkvision, its range increases by 60 ft.",
          "Within this radius I can also see through magical darkness",
        ]),
      },
      "alchemical resistance": {
        name: "Alchemical Resistance",
        description: desc([
          "When you manifest this Mutation choose acid, cold, fire, poison, or lightning, and you gain resistance to that damage type.",
        ]),
      },
      "aquatic adaptation": {
        name: "Aquatic Adaptation",
        description: desc([
          "I gain a swim speed equal to my walk speed, and can breathe both air and water",
        ]),
      },
      "enhanced movement": {
        name: "Enhanced Movement",
        description: desc(["I can Dash as a bonus action"]),
      },
      "grappling appendages": {
        name: "Grappling Appendages",
        description: levels.map(function (n) {
          var ExplDie = n < 5 ? 4 : n < 11 ? 6 : n < 17 ? 8 : 10;

          return desc([
            "I grow two appendages alongside my arms that resemble tentacles",
            "They are natural weapons, which deal 1d" +
            ExplDie +
            " bludgeoning damage on hit.",
            "If I hit a creature with a melee attack, I can attempt to grapple it with these appendages as a bonus action.",
            "These appendages are not dexterous enough to use weapons or specialized tools.",
          ]);
        }),
        weaponOptions: [
          {
            regExpSearch: /^(?=.*(grappling))(?=.*appendages?).*$/i,
            name: "Grappling Appendages",
            source: [["GMB:LL", 0]],
            ability: 1,
            type: "Natural",
            damage: [1, 8, "bludgeoning"],
            range: "Melee",
            description: "Only when manifested",
            abilitytodamage: true,
            grapplingAppendage: true,
          },
        ],
        weaponsAdd: ["Grappling Appendages"],
        calcChanges: {
          atkAdd: [
            function (fields, v) {
              if (v.theWea.grapplingAppendage) {
                var aExplDie = (function (n) {
                  return n < 5 ? 4 : n < 11 ? 6 : n < 17 ? 8 : 10;
                })(classes.known["barbarian(laserllama)"].level);
                fields.Damage_Die = "1d" + aExplDie;
              }
            },
            "My Grappling Appendages are natural weapons which deal bludgeoning damage equal to my Exploit Die on hit",
          ],
        },
        prereqeval: function (v) {
          return classes.known["barbarian(laserllama)"].level >= 10;
        },
      },
      "monstrous glide": {
        name: "Monstrous Glide",
        description: desc([
          "When I fall 10 feet or more and am not incapacitated, I can subtract up to 100 ft from the fall when calculating fall damage, and I can move horizontally 2 ft for every 1 ft I fall",
        ]),
      },
      "oozing form": {
        name: "Oozing Form",
        description: desc([
          "As a bonus action, I can transform (or revert from) in a ooze like state",
          "In this state, I can squeeze through spaces as narrow as 1 inch",
        ]),
      },
      "unnatural physicality": {
        name: "Unnatural Physicality",
        description: desc([
          "I gain a bonus to any Strength (Athletics) and Dexterity (Acrobatics) checks equal to one roll of my Exploit Die",
        ]),
      },
      "acidic bile": {
        name: "Acidic Bile",
        description: desc([
          "I learn the acid splash cantrip, using Constitution as my spellcasting modifier. I can cast this cantrip while Raging, and when so, it deals additional damage equal to my Con mod (min of +1).",
        ]),
        spellcastingBonus: {
          name: "Acidic Bile",
          spells: ["acid splash"],
          selection: ["acid splash"],
          firstCol: "R",
          times: 1,
        },
        spellChanges: {
          "acid splash": {
            description:
              "1 crea or 2 crea within 5 ft of each other save or 1d6 Acid dmg; +1d6 at CL 5, 11, and 17",
            descriptionCantripDie:
              "1 crea or 2 crea within 5 ft of each other save or `CD`d6 Acid dmg; Can cast in rage, add Con mod to dmg",
            changes:
              "If the Acidic Bile mutation is manifested: I can cast this cantrip while Raging, and when so, it deals additional damage equal to my Con mod (min of +1).",
          },
        },
        prereqeval: function (v) {
          return classes.known["barbarian(laserllama)"].level >= 6;
        },
      },
      "corrosive blood": {
        name: "Corrosive Blood",
        description: desc([
          "When hit by an attack and the attacker is within 30 ft, I can use my reaction to deal acid damage to the attacker equal to my Expl Die + my Con mod",
        ]),
        prereqeval: function (v) {
          return classes.known["barbarian(laserllama)"].level >= 6;
        },
      },
      "dislocated reach": {
        name: "Dislocated Reach",
        description: desc(["My melee attacks reach incereases by 5-feet"]),
      },
      "engorged physique": {
        name: "Engorged Physique",
        description: desc([
          "I grow by one size, my reach increases by 5 feet, my weight multiplies by eight, my melee weapon attacks deals one Expl Die bonus damage",
          "If there is not room to grow, you grow to the maximum size allowed by your current surroundings",
        ]),
        prereqeval: function (v) {
          return classes.known["barbarian(laserllama)"].level >= 6;
        },
      },
      "inoculated vigor": {
        name: "Inoculated Vigor",
        description: desc([
          "I gain immunity to acid and poison damage, and I have immunity to poisoned condition and all disease",
        ]),
        prereqeval: function (v) {
          return classes.known["barbarian(laserllama)"].level >= 6;
        },
      },
      "toxic symbiosis": {
        name: "Toxic Symbiosis",
        description: desc([
          "When I hit a creature with a melee attack, I gain temporary hit points equal to my Con mod",
          "Cannot be used against Construct or Undead",
        ]),
        prereqeval: function (v) {
          return classes.known["barbarian(laserllama)"].level >= 6;
        },
      },
      "viscous grip": {
        name: "Viscous Grip",
        description: desc([
          "I gain a climb speed equal to my walk speed, and can climb difficult surfaces without making a check",
          "Also creatures I grapple have disadv. to escape",
        ]),
        prereqeval: function (v) {
          return classes.known["barbarian(laserllama)"].level >= 6;
        },
      },
      "alchemical intellect": {
        name: "Alchemical Intellect",
        description: desc([
          "I have advan. to all INT, WIS and CHA saves but disadv. to all STR, DEX and CON",
        ]),
        prereqeval: function (v) {
          return classes.known["barbarian(laserllama)"].level >= 14;
        },
      },
      "hideous regeneration": {
        name: "Hideous Regeneration",
        description: desc([
          "At the start of my turn if I have less then half HP, but at least 1 hit point, I regain HP equal to my Con mod (min 1)",
        ]),
        prereqeval: function (v) {
          return classes.known["barbarian(laserllama)"].level >= 14;
        },
      },
      "monstrous flight": {
        name: "Monstrous Flight",
        description: desc(["I gain a fly speed equal to my walk speed"]),
        prereqeval: function (v) {
          return classes.known["barbarian(laserllama)"].level >= 14;
        },
      },
      "synthetic carapace": {
        name: "Synthetic Carapace",
        description: desc([
          "I gain a bonus to my AC equal +2 and have resistance to all bludg., pierc. and slash dmg from non-magical, non-silvered attacks",
        ]),
        prereqeval: function (v) {
          return classes.known["barbarian(laserllama)"].level >= 14;
        },
      },
    },
    "subclassfeature3.2": {
      name: "Savage Alchemist",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I gain proficiency in Nature and with alchemist's supplies",
        "Whenever I make a check with either of these proficiency, I gain a bonus equal to my Expl Die",
      ]),
      toolProfs: ["Alchemist's supplies"],
      skills: ["Nature"],
    },
    subclassfeature6: {
      name: "Enduring Mutation",
      minlevel: 6,
      source: [["GMB:LL", 0]],
      description: desc([
        "At the end of a long rest, I can choose one of my mutations to benefit from outside of my Rage, though it still counts against my total of manifested mutations",
        'Choose which one should be applied using the "Choose Feature" button above',
      ]),
      choices: [
        "Enduring Mutation: Aberrant Sight",
        "Enduring Mutation: Alchemical Resistance",
        "Enduring Mutation: Aquatic Adaptation",
        "Enduring Mutation: Monstrous Glide",
        "Enduring Mutation: Enhanced Movement",
        "Enduring Mutation: Oozing Form",
        "Enduring Mutation: Synthetic Carapace",
        "Enduring Mutation: Unnatural Physicality",
        "Enduring Mutation: Corrosive Blood",
        "Enduring Mutation: Dislocated Reach",
        "Enduring Mutation: Engorged Physique",
        "Enduring Mutation: Inoculated Vigor",
        "Enduring Mutation: Toxic Symbiosis",
        "Enduring Mutation: Viscous Grip",
        "Enduring Mutation: Acidic Bile",
        "Enduring Mutation: Alchemical Intellect",
        "Enduring Mutation: Hideous Regeneration",
        "Enduring Mutation: Grappling Appendages",
        "Enduring Mutation: Monstrous Flight",
      ],
      "enduring mutation: aberrant sight": {
        name: "Enduring Mutation: Aberrant Sight",
        description: desc([
          "I gain the benefits of Abberant Sight even outside of my Rage, though it still counts against my total of manifested mutations. I can change this choice at the end of a short/long rest.",
        ]),
        prereqeval: function (v) {
          // Must first select it as a known mutation before selecting it as an endured mutation
          techniques = GetFeatureChoice(
            "classes",
            "barbarian(laserllama)",
            "subclassfeature3.1",
            true
          );

          if (techniques.indexOf("aberrant sight") == -1) return false;

          return true;
        },
        vision: [
          ["Darkvision", "fixed 60"],
          ["Darkvision", "+60"],
          ["See through magical darkness", 0],
        ],
      },
      // acid, cold, fire, poison, or lightning
      "enduring mutation: alchemical resistance": {
        name: "Enduring Mutation: Alchemical Resistance",
        description: desc([
          "I gain the benefits of Alchemical Resistance even outside of my Rage, though it still counts against my total of manifested mutations. I can change this choice at the end of a long rest.",
        ]),
        submenu: "Enduring Mutation: Alchemical Resistance",
        choices: ["Acid", "Cold", "Fire", "Poison", "Lightning"],
        prereqeval: function (v) {
          techniques = GetFeatureChoice(
            "classes",
            "barbarian(laserllama)",
            "subclassfeature3.1",
            true
          );

          if (techniques.indexOf("alchemical resistance (acid)") == -1) return false;

          return true;
        },
        acid: {
          dmgres: ["Acid"],
        },
        cold: {
          dmgres: ["Cold"],
        },
        fire: {
          dmgres: ["Fire"],
        },
        poison: {
          dmgres: ["Poison"],
        },
        lightning: {
          dmgres: ["Lightning"],
        },
      },
      "enduring mutation: aquatic adaptation": {
        name: "Enduring Mutation: Aquatic Adaptation",
        description: desc([
          "I gain the benefits of Aquatic Adaptation even outside of my Rage, though it still counts against my total of manifested mutations. I can change this choice at the end of a long rest.",
        ]),
        prereqeval: function (v) {
          techniques = GetFeatureChoice(
            "classes",
            "barbarian(laserllama)",
            "subclassfeature3.1",
            true
          );

          if (techniques.indexOf("aquatic adaptation") == -1) return false;

          return true;
        },
        speed: {
          swim: { spd: "walk", enc: 0 },
        },
      },
      "enduring mutation: monstrous glide": {
        name: "Enduring Mutation: Monstrous Glide",
        description: desc([
          "I gain the benefits of Monstrous Glide even outside of my Rage, though it still counts against my total of manifested mutations. I can change this choice at the end of a long rest.",
        ]),
        prereqeval: function (v) {
          techniques = GetFeatureChoice(
            "classes",
            "barbarian(laserllama)",
            "subclassfeature3.1",
            true
          );

          if (techniques.indexOf("monstrous glide") == -1) return false;

          return true;
        },
      },
      "enduring mutation: enhanced movement": {
        name: "Enduring Mutation: Enhanced Movement",
        description: desc([
          "I gain the benefits of Enhanced Movement even outside of my Rage, though it still counts against my total of manifested mutations. I can change this choice at the end of a long rest.",
        ]),
        prereqeval: function (v) {
          techniques = GetFeatureChoice(
            "classes",
            "barbarian(laserllama)",
            "subclassfeature3.1",
            true
          );

          if (techniques.indexOf("enhanced movement") == -1) return false;

          return true;
        },
        action: [["bonus action", "Dash"]],
      },
      "enduring mutation: grappling appendages": {
        name: "Enduring Mutation: Grappling Appendages",
        description: desc([
          "I gain the benefits of Grappling Appendages even outside of my Rage, though it still counts against my total of manifested mutations. I can change this choice at the end of a long rest.",
        ]),
        calcChanges: {
          atkAdd: [
            function (fields, v) {
              if (v.theWea.grapplingAppendage) {
                fields.Description = "";
              }
            },
            "The grappling appendage is last until this mutation is deactivated",
            8,
          ],
        },
        prereqeval: function (v) {
          techniques = GetFeatureChoice(
            "classes",
            "barbarian(laserllama)",
            "subclassfeature3.1",
            true
          );

          if (techniques.indexOf("grappling appendages") == -1) return false;

          return true;
        },
      },
      "enduring mutation: oozing form": {
        name: "Enduring Mutation: Oozing Form",
        description: desc([
          "I gain the benefits of Oozing Form even outside of my Rage, though it still counts against my total of manifested mutations. I can change this choice at the end of a long rest.",
        ]),
        action: [["bonus action", " (start/end)"]],
        prereqeval: function (v) {
          techniques = GetFeatureChoice(
            "classes",
            "barbarian(laserllama)",
            "subclassfeature3.1",
            true
          );

          if (techniques.indexOf("oozing form") == -1) return false;

          return true;
        },
      },
      "enduring mutation: unnatural physicality": {
        name: "Enduring Mutation: Unnatural Physicality",
        description: desc([
          "I gain the benefits of Unnatural Physicality even outside of my Rage, though it still counts against my total of manifested mutations. I can change this choice at the end of a long rest.",
        ]),
        prereqeval: function (v) {
          techniques = GetFeatureChoice(
            "classes",
            "barbarian(laserllama)",
            "subclassfeature3.1",
            true
          );

          if (techniques.indexOf("unnatural physicality") == -1) return false;

          return true;
        },
      },
      "enduring mutation: acidic bile": {
        name: "Enduring Mutation: Acidic Bile",
        description: desc([
          "I gain the benefits of Acidic Bile even outside of my Rage, though it still counts against my total of manifested mutations. I can change this choice at the end of a long rest.",
        ]),
        spellChanges: {
          "acid splash": {
            description:
              "1 crea or 2 crea within 5 ft of each other save or 1d6 Acid dmg; +1d6 at CL 5, 11, and 17",
            descriptionCantripDie:
              "1 crea or 2 crea within 5 ft of each other save or `CD`d6 Acid dmg; Can cast in rage, add Con mod to dmg",
            changes:
              "If the Acidic Bile mutation is manifested: I can cast this cantrip even out of Rage, and when so, it deals additional damage equal to my Con mod (min of +1).",
          },
        },
        prereqeval: function (v) {
          techniques = GetFeatureChoice(
            "classes",
            "barbarian(laserllama)",
            "subclassfeature3.1",
            true
          );

          if (techniques.indexOf("acidic bile") == -1) return false;

          return true;
        },
      },
      "enduring mutation: corrosive blood": {
        name: "Enduring Mutation: Corrosive Blood",
        description: desc([
          "I gain the benefits of Corrosive Blood even outside of my Rage, though it still counts against my total of manifested mutations. I can change this choice at the end of a long rest.",
        ]),
        action: [["reaction", " (when hit)"]],
        prereqeval: function (v) {
          techniques = GetFeatureChoice(
            "classes",
            "barbarian(laserllama)",
            "subclassfeature3.1",
            true
          );

          if (techniques.indexOf("corrosive blood") == -1) return false;

          return true;
        },
      },
      "enduring mutation: dislocated reach": {
        name: "Enduring Mutation: Dislocated Reach",
        description: desc([
          "I gain the benefits of Dislocated Reach even outside of my Rage, though it still counts against my total of manifested mutations. I can change this choice at the end of a long rest.",
        ]),
        calcChanges: {
          atkAdd: [
            function (fields, v) {
              if (v.isMeleeWeapon)
                fields.Description +=
                  (fields.Description ? "; " : "") + "+5 ft reach";
            },
            "My reach with melee attacks in increased of 5 feet.",
            8,
          ],
        },
        prereqeval: function (v) {
          techniques = GetFeatureChoice(
            "classes",
            "barbarian(laserllama)",
            "subclassfeature3.1",
            true
          );

          if (techniques.indexOf("dislocated reach") == -1) return false;

          return true;
        },
      },
      "enduring mutation: engorged physique": {
        name: "Enduring Mutation: Engorged Physique",
        description: desc([
          "I gain the benefits of Engorged Physique even outside of my Rage, though it still counts against my total of manifested mutations. I can change this choice at the end of a long rest.",
        ]),
        calcChanges: {
          atkAdd: [
            function (fields, v, output) {
              const explDie = levels.map((n) => {
                return n < 5 ? 4 : n < 11 ? 6 : n < 17 ? 8 : 10;
              });
              if (v.isMeleeWeapon) {
                fields.Description +=
                  (fields.Description ? "; " : "") + "+5 ft reach";
                output.extraDmg += "+1d" + explDie;
              }
            },
            "My reach with melee attacks in increased of 5 feet and melee dmg deal a Expl Die bonus on hit",
            8,
          ],
        },
        prereqeval: function (v) {
          techniques = GetFeatureChoice(
            "classes",
            "barbarian(laserllama)",
            "subclassfeature3.1",
            true
          );

          if (techniques.indexOf("engorged physique") == -1) return false;

          return true;
        },
      },
      "enduring mutation: inoculated vigor": {
        name: "Enduring Mutation: Inoculated Vigor",
        description: desc([
          "I gain the benefits of Inoculated Vigor even outside of my Rage, though it still counts against my total of manifested mutations. I can change this choice at the end of a long rest.",
        ]),
        prereqeval: function (v) {
          techniques = GetFeatureChoice(
            "classes",
            "barbarian(laserllama)",
            "subclassfeature3.1",
            true
          );

          if (techniques.indexOf("inoculated vigor") == -1) return false;

          return true;
        },
        dmgres: ["Acid", "Poison"],
        savetxt: { adv_vs: ["poisoned"], immune: "All desease" },
      },
      "enduring mutation: toxic symbiosis": {
        name: "Enduring Mutation: Toxic Symbiosis",
        description: desc([
          "I gain the benefits of Toxic Symbiosis even outside of my Rage, though it still counts against my total of manifested mutations. I can change this choice at the end of a long rest.",
        ]),
        action: [["bonus action", " (on hit my melee atk)"]],
        prereqeval: function (v) {
          techniques = GetFeatureChoice(
            "classes",
            "barbarian(laserllama)",
            "subclassfeature3.1",
            true
          );

          if (techniques.indexOf("toxic symbiosis") == -1) return false;

          return true;
        },
      },
      "enduring mutation: viscous grip": {
        name: "Enduring Mutation: Viscous Grip",
        description: desc([
          "I gain the benefits of Viscous Grip even outside of my Rage, though it still counts against my total of manifested mutations. I can change this choice at the end of a long rest.",
        ]),
        prereqeval: function (v) {
          techniques = GetFeatureChoice(
            "classes",
            "barbarian(laserllama)",
            "subclassfeature3.1",
            true
          );

          if (techniques.indexOf("viscous grip") == -1) return false;

          return true;
        },
        speed: {
          climb: { spd: "walk", enc: 0 },
        },
      },
      "enduring mutation: alchemical intellect": {
        name: "Enduring Mutation: Alchemical Intellect",
        description: desc([
          "I gain the benefits of Alchemical Intellect even outside of my Rage, though it still counts against my total of manifested mutations. I can change this choice at the end of a long rest.",
        ]),
        prereqeval: function (v) {
          techniques = GetFeatureChoice(
            "classes",
            "barbarian(laserllama)",
            "subclassfeature3.1",
            true
          );

          if (techniques.indexOf("alchemical intellect") == -1) return false;

          return true;
        },
        savetxt: {
          text: [
            "Adv. in all Int, Wis and Cha",
            "Disadv. in all Str, Dex and Con",
          ],
        },
      },
      "enduring mutation: hideous regeneration": {
        name: "Enduring Mutation: Hideous Regeneration",
        description: desc([
          "I gain the benefits of Hideous Regeneration even outside of my Rage, though it still counts against my total of manifested mutations. I can change this choice at the end of a long rest.",
        ]),
        prereqeval: function (v) {
          techniques = GetFeatureChoice(
            "classes",
            "barbarian(laserllama)",
            "subclassfeature3.1",
            true
          );

          if (techniques.indexOf("hideous regeneration") == -1) return false;

          return true;
        },
      },
      "enduring mutation: monstrous flight": {
        name: "Enduring Mutation: Monstrous Flight",
        description: desc([
          "I gain the benefits of Monstrous Flight even outside of my Rage, though it still counts against my total of manifested mutations. I can change this choice at the end of a long rest.",
        ]),
        prereqeval: function (v) {
          techniques = GetFeatureChoice(
            "classes",
            "barbarian(laserllama)",
            "subclassfeature3.1",
            true
          );

          if (techniques.indexOf("monstrous flight") == -1) return false;

          return true;
        },
        speed: {
          fly: { spd: "walk", enc: 0 },
        },
      },
      "enduring mutation: synthetic carapace": {
        name: "Enduring Mutation: Synthetic Carapace",
        description: desc([
          "I gain the benefits of Synthetic Carapace even outside of my Rage, though it still counts against my total of manifested mutations. I can change this choice at the end of a long rest.",
        ]),
        extraAC: [
          {
            name: "E.M. Synthetic Carapace",
            mod: 2,
            text: "I gain a +2 bonus to my AC",
          },
        ],
        dmgres: [
          "Bludg. (non-mag, non-silv)",
          "Pierc. (non-mag, non-silv)",
          "Slash. (non-mag, non-silv)",
        ],
        prereqeval: function (v) {
          techniques = GetFeatureChoice(
            "classes",
            "barbarian(laserllama)",
            "subclassfeature3.1",
            true
          );

          if (techniques.indexOf("synthetic carapace") == -1) return false;

          return true;
        },
      },
    },
    subclassfeature10: {
      name: "Noxious Strike",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "Once per turn, when I hit a creature with a melee attack, I can force it to make a Con save against my Exploit save DC",
        "On a failed save, is Blinded or Stunned (my choice) and takes 4 Expl Dice acid damage (half on success)",
        "This effect lasts for 1 minute. The creature can repeat the save each time it takes damage, ending the effect on a success.",
        "When I have no uses left, I can expend a use of Rage to use it again",
      ]),
      usages: "Con mod per ",
      usagescalc: "event.value = Math.max(1, What('Con Mod'));",
      recovery: "long rest",
    },
    subclassfeature14: {
      name: "Rapid Mutation",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      description: desc([
        "While Raging, I can use a bonus action to end one Mutation and replace it with another Mutation that I know",
      ]),
      action: ["bonus action", ""],
    },
  },
});

// Path of the Packleader
AddSubClass("barbarian(laserllama)", "packleader", {
  regExpSearch: /packleader/i,
  subname: "Path of the Packleader",
  fullname: "Packleader",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: GetBarbarianSubclassExploits("Packleader", [
      "cunning instinct",
      "trampling rush",
      "bloodthirsty critical",
      "primal senses",
      "pack tactics",
    ]),

    "subclassfeature3.1": {
      name: "Beast Whisperer",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I gain proficiency with Animal Handling",
        "When I make Wisdom (Animal Handling) checks related to wild animals, I add my Expl Die to the roll",
      ]),
      skills: ["Animal Handling"],
    },
    "subclassfeature3.2": {
      name: "Savage Companion",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I have forged a primal bond with a wild beast",
        'Select a "Savage Companion" on the companion page for its stats and rules',
        "If it dies, I can spend time during a long rest to find another worthy beast",
      ]),
      action: [
        ["action", " (forgo one attack)"],
        ["bonus action", " (command)"],
      ],
      creaturesAdd: [["Savage Companion", true]],
      creatureOptions: [
        {
          name: "Savage Companion",
          source: [["GMB:LL", 0]],
          size: 3,
          type: "Beast",
          alignment: "Unaligned",
          ac: "13+Prof",
          hp: 20,
          hd: [3, 8],
          hdLinked: ["barbarian(laserllama)", "barbarian"],
          minlevelLinked: ["barbarian(laserllama)", "barbarian"],
          speed: "40 ft, swim 20 ft",
          scores: [14, 14, 15, 8, 14, 8],
          saves: ["", "", "", "", "", ""],
          skills: {
            intimidation: "",
            survival: "",
          },
          passivePerception: 12,
          languages: "Understands one language you speak",
          challengeRating: "0",
          proficiencyBonus: 2,
          proficiencyBonusLinked: true,
          attacksAction: 1,
          attacks: [
            {
              name: "Maul",
              ability: 1,
              damage: [1, 8, "slashing"],
              modifiers: ["", "Prof"],
              range: "Melee (5 ft)",
              description: "",
              abilitytodamage: true,
            },
          ],
          features: [
            {
              name: "Primal Bond",
              description:
                "I add my PB to any ability check where it is proficient or saving throw my Companion makes (already included).",
            },
          ],
          traits: [
            {
              name: "Wild Fury (Packleader 6)",
              minlevel: 6,
              description:
                "When I Rage, my Companion also gains resistance to bludgeoning, piercing, and slashing damage for the duration while it is within 30 of me.",
              eval: function (prefix, lvl) {
                AddString(prefix + "Comp.Use.Attack.1.Description", "Counts as magical", "; ");
              },
              removeeval: function (prefix, lvl) {
                RemoveString(prefix + "Comp.Use.Attack.1.Description", "Counts as magical");
              }
            },
            {
              name: "Coordinated Assault (Packleader 10)",
              minlevel: 10,
              description:
                "Both me and my Savage Companion have advantage on attack rolls against a creature if the other is within 5 feet of the target.",
            },
          ],
          notes: [
            {
              name: "The companion obeys the commands of its leader",
              description: "and shares its proficiency bonus.",
              joinString: " ",
            },
            {
              name: "It takes its turn during that of its leader,",
              description: "on the same initiative count.",
              joinString: " ",
            },
            {
              name: "It can move and take reactions on its own,",
              description:
                "but only takes the Dodge action on its turn unless its leader takes a bonus action to command it to take another action.",
              joinString: " ",
            },
            {
              name: "Its leader can also forgo one attack during their Attack action",
              description:
                "to command the companion to take the Attack action.",
              joinString: " ",
            },
            {
              name: "If its leader is incapacitated,",
              description: "the companion can take any action, not just Dodge.",
              joinString: " ",
            },
            {
              name: "If the companion is reduced to 0 hit points,",
              description:
                "it makes death saving throws like a player character would.",
              joinString: " ",
            },
          ],
          addMod: [
            {
              type: "skill",
              field: "Intimidation",
              mod: "2+Prof",
              text: "The savage companion adds my proficiency bonus to all its Intimidation checks.",
            },
            {
              type: "skill",
              field: "Survival",
              mod: "2+Prof",
              text: "The savage companion adds my proficiency bonus to all its Survival checks.",
            },
            {
              type: "save",
              field: "All",
              mod: "Prof",
              text: "The savage companion adds my proficiency bonus to all its saving throws.",
            },
          ],
          calcChanges: {
            hp: function (totalHD, HDobj, prefix) {
              //if (!classes.known.ranger && !classes.known.rangerua) return;
              var rngrLvl = classes.known["barbarian(laserllama)"]
                ? classes.known["barbarian(laserllama)"].level
                : classes.known.barbarian.level;
              var rngrLvlM = 5 * rngrLvl;
              HDobj.alt.push(5 + rngrLvlM);
              HDobj.altStr.push(
                " = 5 as a base\n + 5 \xD7 " +
                rngrLvl +
                " from five times its leader's barbarian level (" +
                rngrLvlM +
                ")"
              );
            },
            setAltHp: true,
          },
        },
      ],
    },

    subclassfeature6: {
      name: "Wild Fury",
      description: desc([
        "When I Rage, my Companion also gains resistance to bludg, piercing, and slashing damage",
      ]),
      minlevel: 6,
      source: [["GMB:LL", 0]],
    },
    subclassfeature10: {
      name: "Leader of the Pack",
      description: desc([
        "Both me and my Savage Companion have advantage on attack rolls against a creature if the other is within 5 feet of the target creature and not incapacitated",
      ]),
      minlevel: 10,
      source: [["GMB:LL", 0]],
    },
    subclassfeature14: {
      name: "Primeval Companion",
      description: desc([
        "As an action, I can transform my companion into a Primeval Companion for 1 hour or until it is incapacitated",
        "For the duration, use the Primeval Companion stats  (you can select it in the Companion Page)",
        "When I Rage, I can expend two uses to go rage and trasform my companion at the same time",
      ]),
      minlevel: 14,
      source: [["GMB:LL", 0]],
      action: [["action", ""]],
      creaturesAdd: [["Primeval Companion", false]],
      creatureOptions: [
        {
          name: "Primeval Companion",
          source: [["GMB:LL", 0]],
          size: 4,
          type: "Beast",
          alignment: "Unaligned",
          ac: "13+Prof",
          hp: 20,
          hd: [3, 8],
          hdLinked: ["barbarian(laserllama)", "barbarian"],
          minlevelLinked: ["barbarian(laserllama)", "barbarian"],
          speed: "60 ft, swim 40 ft",
          scores: [18, 14, 20, 8, 18, 10],
          saves: ["", "", "", "", "", ""],
          skills: {
            intimidation: "",
            survival: "",
          },
          passivePerception: 14,
          languages: "Understands one language you speak",
          challengeRating: "0",
          proficiencyBonus: 2,
          proficiencyBonusLinked: true,
          attacksAction: 1,
          attacks: [
            {
              name: "Maul",
              ability: 1,
              damage: [2, 8, "slashing"],
              modifiers: ["", "Prof"],
              range: "Melee (5 ft)",
              description: "",
              abilitytodamage: true,
            },
          ],
          features: [
            {
              name: "Primal Bond",
              description:
                "I add my PB to any ability check where it is proficient or saving throw my Companion makes (already included).",
            },
            {
              name: "Relentless",
              description:
                "Once per long rest, when your Companion isreduced to 0 hit points, it can choose to instantly gain hitpoints equal to your Barbarian level instead of falling to 0.",
            },
            {
              name: "Savage Charge",
              description:
                "If your Companion moves at least 20 ft.in a straight line then hits a target with its Maul attack itdeals bonus damage equal to your Exploit Die on hit.",
            },
          ],
          traits: [
            {
              name: "Wild Fury (Packleader 6)",
              minlevel: 6,
              description:
                "When I Rage, my Companion also gains resistance to bludgeoning, piercing, and slashing damage for the duration while it is within 30 of me.",
              eval: function (prefix, lvl) {
                AddString(prefix + "Comp.Use.Attack.1.Description", "Counts as magical", "; ");
              },
              removeeval: function (prefix, lvl) {
                RemoveString(prefix + "Comp.Use.Attack.1.Description", "Counts as magical");
              }
            },
            {
              name: "Coordinated Assault (Packleader 10)",
              minlevel: 10,
              description:
                "Both me and my Savage Companion have advantage on attack rolls against a creature if the other is within 5 feet of the target.",
            },
          ],
          notes: [
            {
              name: "The companion obeys the commands of its leader",
              description: "and shares its proficiency bonus.",
              joinString: " ",
            },
            {
              name: "It takes its turn during that of its leader,",
              description: "on the same initiative count.",
              joinString: " ",
            },
            {
              name: "It can move and take reactions on its own,",
              description:
                "but only takes the Dodge action on its turn unless its leader takes a bonus action to command it to take another action.",
              joinString: " ",
            },
            {
              name: "Its leader can also forgo one attack during their Attack action",
              description:
                "to command the companion to take the Attack action.",
              joinString: " ",
            },
            {
              name: "If its leader is incapacitated,",
              description: "the companion can take any action, not just Dodge.",
              joinString: " ",
            },
            {
              name: "If the companion is reduced to 0 hit points,",
              description:
                "it makes death saving throws like a player character would.",
              joinString: " ",
            },
          ],
          addMod: [
            {
              type: "skill",
              field: "Intimidation",
              mod: "4+Prof",
              text: "The savage companion adds my proficiency bonus to all its Intimidation checks.",
            },
            {
              type: "skill",
              field: "Survival",
              mod: "4+Prof",
              text: "The savage companion adds my proficiency bonus to all its Survival checks.",
            },
            {
              type: "save",
              field: "All",
              mod: "Prof",
              text: "The savage companion adds my proficiency bonus to all its saving throws.",
            },
          ],
          calcChanges: {
            hp: function (totalHD, HDobj, prefix) {
              //if (!classes.known.ranger && !classes.known.rangerua) return;
              var rngrLvl = classes.known["barbarian(laserllama)"]
                ? classes.known["barbarian(laserllama)"].level
                : classes.known.barbarian.level;
              var rngrLvlM = 5 * rngrLvl;
              HDobj.alt.push(5 + rngrLvlM);
              HDobj.altStr.push(
                " = 5 as a base\n + 5 \xD7 " +
                rngrLvl +
                " from five times its leader's barbarian level (" +
                rngrLvlM +
                ")"
              );
            },
            setAltHp: true,
          },
        },
      ],
    },
  },
});

// Path of the Reaver
AddSubClass("barbarian(laserllama)", "reaver", {
  regExpSearch: /reaver/i,
  subname: "Path of the Reaver",
  fullname: "Reaver",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    // Override martial exploits because size of die increases
    // NOTE: This has been copy pasted from the main class. IT WON'T WORK IF YOU TRY TO USE newObj ! (it will cause a crash because of some variable's scope)
    // I do not know how to fix that scoping bug, so I went for the more brute force approach. If it works, it aint stupid ;)
    "savage exploits": (function () {
      // Fixed attributes
      SavageExploits = {
        name: "Savage Exploits",
        minlevel: 2,
        source: [["GMB:LL", 0]],
        description: desc([
          "I gain Exploit Dice, which are used to fuel my Savage Exploits",
          'Use the "Choose Feature" button above to choose Savage Exploits',
        ]),
        toNotesPage: [
          {
            name: "Savage Exploits",
            note: desc([
              "Below are all Savage Exploits I know. Each 3rd and 4th degree exploits can only be used once per short rest. Each 5th degree exploit can only be used once per long rest.",
            ]),
          },
        ],

        // Savage Exploits
        extraname: "Savage Exploits",
        extrachoices: [],
        extraTimes: [
          "",
          2,
          2,
          2,
          3,
          3,
          4,
          4,
          5,
          5,
          6,
          6,
          7,
          7,
          7,
          7,
          8,
          8,
          8,
          8,
        ],

        // Exploit dice
        limfeaname: "Exploit Dice",
        usages: ["", 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5],
        additional: [
          "",
          "d4",
          "d4",
          "d4",
          "d6",
          "d6",
          "d6",
          "d6",
          "d6",
          "d6",
          "d8",
          "d8",
          "d8",
          "d8",
          "d8",
          "d8",
          "d10",
          "d10",
          "d10",
          "d10",
        ],
        recovery: "short rest",
      };

      // Make a filtered spell list that contains only barbarian(laserllama) "spells"
      const BarbarianSpells = Object.keys(SpellsList)
        .filter((key) => SpellsList[key].isExploit)
        .filter((key) => {
          for (var i = 0; i < SpellsList[key].classes.length; i++) {
            if (
              SpellsList[key].classes[i] == "barbarian(laserllama)" ||
              SpellsList[key].classes[i] == "fighter(laserllama)"
            )
              return true;
          }
          return false;
        });

      // Iterate over all barbarian(laserllama) "spells"
      for (var i = 0; i < BarbarianSpells.length; i++) {
        var NewSpell = SpellsList[BarbarianSpells[i]];
        var tempSpell = BarbarianSpells[i];

        SavageExploits.extrachoices.push(NewSpell.name); // Add "spell" name to menu options

        SavageExploits[BarbarianSpells[i]] = {
          // Add "spell" to the main item (when it is picked through the menu)
          name: NewSpell.name,
          toNotesPage: [
            {
              // What is added to the notes page
              name:
                NewSpell.name +
                " Exploit [" +
                (NewSpell.level == 1
                  ? "1st"
                  : NewSpell.level == 2
                    ? "2nd"
                    : NewSpell.level == 3
                      ? "3rd"
                      : NewSpell.level + "th") +
                " degree]",
              note: desc(NewSpell.descriptionFull),
              amendTo: "Savage Exploits",
            },
          ],
          source: NewSpell.source,
          addMod: NewSpell.addMod,
          submenu: NewSpell.submenu,
          prereqeval: ExploitPrereqFactory(
            BarbarianSpells[i],
            "barbarian(laserllama)"
          ),
          eval: CreateSavageSpellsheet, // in case the user removes all exploits
          spellcastingBonusElsewhere: {
            addTo: "savage exploits",
            spellcastingBonus: {
              name: "Savage Exploits",
              spellcastingAbility: 1,
              spells: [BarbarianSpells[i]],
              selection: [BarbarianSpells[i]],
            },
          },
        };
      }

      // Make a filtered spell list that contains only fighter(laserllama) "spells" BUT that aren't also barbarian(laserllama) "spells" (since we already included them above)
      const ReaverSpells = Object.keys(SpellsList)
        .filter((key) => SpellsList[key].isExploit)
        .filter((key) => {
          for (var i = 0; i < SpellsList[key].classes.length; i++) {
            if (SpellsList[key].classes[i] == "barbarian(laserllama)")
              return false;
          }
          for (var i = 0; i < SpellsList[key].classes.length; i++) {
            if (SpellsList[key].classes[i] == "fighter(laserllama)")
              return true;
          }
          return false;
        });

      // Iterate over all fighter(laserllama) "spells"
      for (var i = 0; i < ReaverSpells.length; i++) {
        var NewSpell = SpellsList[ReaverSpells[i]];
        var tempSpell = ReaverSpells[i];

        SavageExploits.extrachoices.push(NewSpell.name); // Add "spell" name to menu options

        SavageExploits[ReaverSpells[i]] = {
          // Add "spell" to the main item (when it is picked through the menu)
          name: NewSpell.name,
          toNotesPage: [
            {
              // What is added to the notes page
              name:
                NewSpell.name +
                " Exploit [" +
                (NewSpell.level == 1
                  ? "1st"
                  : NewSpell.level == 2
                    ? "2nd"
                    : NewSpell.level == 3
                      ? "3rd"
                      : NewSpell.level + "th") +
                " degree]",
              note: desc(NewSpell.descriptionFull),
              amendTo: "Savage Exploits",
            },
          ],
          source: NewSpell.source,
          addMod: NewSpell.addMod,
          submenu: NewSpell.submenu,
          prereqeval: ExploitPrereqFactoryReaver(
            ReaverSpells[i],
            "barbarian(laserllama)"
          ),
          eval: CreateSavageSpellsheet, // in case the user removes all exploits
          spellcastingBonusElsewhere: {
            addTo: "savage exploits",
            spellcastingBonus: {
              name: "Savage Exploits",
              spellcastingAbility: 1,
              spells: [ReaverSpells[i]],
              selection: [ReaverSpells[i]],
            },
          },
        };
      }

      return SavageExploits;
    })(),

    subclassfeature3: GetBarbarianSubclassExploits("Reaver", [
      "lightstep",
      "savage rebuke",
      "rending strike",
      "glancing blow",
      "adrenaline rush",
    ]),
    "subclassfeature3.1": {
      name: "Reaver Superiority",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map(function (n) {
        var ExtraExploits =
          n < 10 ? "one Exploit known." : "two Exploits known.";

        return desc([
          "When I learn an Exploit, I can learn it from the Fighter list, using my Barbarian level for the prerequisite. Also, I get one extra Exploit Die and " +
          ExtraExploits,
        ]);
      }),
      bonusClassExtrachoices: [
        {
          class: "barbarian(laserllama)",
          feature: "savage exploits",
          bonus: 1,
        },
      ],
      extraLimitedFeatures: [
        {
          name: "Exploit Dice",
          usages: 1,
          recovery: "short rest",
          addToExisting: true,
        },
      ],
    },
    "subclassfeature3.2": {
      name: "Swift Strides",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc(
        "When Raging, opportunity attacks against me are made at disadvantage"
      ),
    },
    subclassfeature6: {
      name: "Restorative Rage",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "When I Rage, I gain one of the following benefits:",
        "\u2022 I regain one of my expended Exploit Dice",
        "\u2022 I gain one Expl Die temporary hit points",
        "\u2022 My walking speed is doubled for my current turn",
      ]),
    },
    subclassfeature10: {
      name: "Unstoppable Warrior",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "While Raging, I am under the effects of freedom of movement (in spell list for reference)",
        "I gain an additional Exploit known for Reaver Superiority",
      ]),
      spellcastingBonus: {
        name: "Unstoppable Warrior",
        spells: ["freedom of movement"],
        selection: ["freedom of movement"],
        firstCol: "R",
        times: 1,
      },
      spellChanges: {
        "freedom of movement": {
          range: "Self",
          time: "-",
          components: "-",
          duration: "Rage",
          changes:
            "While Raging, I am under the effects of freedom of movement (in spell list for reference)",
        },
      },
      bonusClassExtrachoices: [
        {
          class: "barbarian(laserllama)",
          feature: "savage exploits",
          bonus: 1,
        },
      ],
    },
    subclassfeature14: {
      name: "Storm of Flesh & Steel",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      description: desc([
        "Once per turn when I hit with a weapon attack while Raging, I can forgo the Rage damage bonus",
        "If I do, I can use an Exploit (that can be used as a part of an attack) without expending an Exploit Die",
      ]),
    },
  },
});

// Path of the Titan
AddSubClass("barbarian(laserllama)", "titan", {
  regExpSearch: /titan/i,
  subname: "Path of the Titan",
  fullname: "Titan",
  source: [["GMB:LL", 0]],
  features: {
    subclassfeature3: GetBarbarianSubclassExploits("Titanic", [
      "feat of strength",
      "hurl",
      "greater hurl",
      "shattering slam",
      "destructive slam",
    ]),
    "subclassfeature3.1": {
      name: "Giant Bloodline",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        'Choose the option that best fits the type of giant whose power resides in you using the "Choose Feature" button above',
        "This choice is permanent and can't be changed short of a wish spell or the magic of elder giants",
      ]),
      choices: [
        "Hill Giant",
        "Stone Giant",
        "Frost Giant",
        "Fire Giant",
        "Cloud Giant",
        "Storm Giant",
      ],
      "hill giant": {
        name: "Hill Giant Bloodline",
        description: desc([
          "The power of Hill Giants reside in me, I gain resistance to Poison damage",
        ]),
        dmgres: ["Poison"],
      },
      "stone giant": {
        name: "Stone Giant Bloodline",
        description: desc([
          "The power of Stone Giants reside in me, I gain resistance to Psychic damage",
        ]),
        dmgres: ["Psychic"],
      },
      "frost giant": {
        name: "Frost Giant Bloodline",
        description: desc([
          "The power of Frost Giants reside in me, I gain resistance to Cold damage",
        ]),
        dmgres: ["Cold"],
      },
      "fire giant": {
        name: "Fire Giant Bloodline",
        description: desc([
          "The power of Fire Giants reside in me, I gain resistance to Fire damage",
        ]),
        dmgres: ["Fire"],
      },
      "cloud giant": {
        name: "Cloud Giant Bloodline",
        description: desc([
          "The power of Cloud Giants reside in me, I gain resistance to Thunder damage",
        ]),
        dmgres: ["Thunder"],
      },
      "storm giant": {
        name: "Storm Giant Bloodline",
        description: desc([
          "The power of Storm Giants reside in me, I gain resistance to Lightning damage",
        ]),
        dmgres: ["Lightning"],
      },
      // Create the dependency for the level 10 feature
      choiceDependencies: [
        {
          feature: "subclassfeature10",
          choiceAttribute: false,
        },
      ],
    },
    "subclassfeature3.2": {
      name: "Titani Rage",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map(function (n) {
        if (n < 10) {
          return desc([
            "When I Rage, I gain the following benefits:",
            "\u2022 I can choose to grow up to Large.",
            "\u2022 If there is room, I can choose to grow by one size category. My physical size doubles in all dimensions, and my weight is multiplied by eight.",
            "\u2022 My Rage bonus damage increse depending on my current size:  Large(1d8).",
            "\u2022 I can use hurl without expending an Exploit Die and I add my Rage damage bonus to the damage.",
          ]);
        }
        if (n < 18) {
          return desc([
            "When I Rage, I gain the following benefits:",
            "\u2022 I can choose to grow up to Large or Huge.",
            "\u2022 If there is room, I can choose to grow by one size category. My physical size doubles in all dimensions, and my weight is multiplied by eight.",
            "\u2022 My Rage bonus damage increse depending on my current size:  Large(1d8) or Huge (1d12).",
            "\u2022 I can use hurl or greater hurl without expending an Exploit Die and I add my Rage damage bonus to the damage.",
          ]);
        }

        return desc([
          "When I Rage, I gain the following benefits:",
          "\u2022 I can choose to grow up to Huge, Large or Gargantuan.",
          "\u2022 If there is room, I can choose to grow by one size category. My physical size doubles in all dimensions, and my weight is multiplied by eight.",
          "\u2022 My Rage bonus damage increse depending on my current size: Large(1d6), Huge (1d12), and Gargantuan (2d12).",
          "\u2022 I can use hurl or greater hurl without expending an Exploit Die and I add my Rage damage bonus to the damage.",
        ]);
      }),
    },
    subclassfeature6: {
      name: "Elder Vitality",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "When I Rage, if I grow up in size, I gain temp HP based on the size. Large (10), Huge (20), Gargantuan (30)",
      ]),
    },
    subclassfeature10: {
      name: "Awakened Bloodline",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "I manifest more specific traits dependent upon my Giant Bloodline",
      ]),
      choices: [
        "Hill Giant",
        "Stone Giant",
        "Frost Giant",
        "Fire Giant",
        "Cloud Giant",
        "Storm Giant",
      ],
      choicesNotInMenu: true,
      "hill giant": {
        name: "Awakened Hill Giant Bloodline",
        description: desc([
          "When I take damage while Raging, I can use a reaction to reduce the damage I take by my Con mod (min 1)",
        ]),
        action: [["reaction", " (when damaged in rage)"]],
      },
      "stone giant": {
        name: "Awakened Stone Giant Bloodline",
        description: "I gain proficiency in Wisdom saving throws",
        saves: ["Wis"],
      },
      "frost giant": {
        name: "Awakened Frost Giant Bloodline",
        description: desc([
          "My Rage Damage is now cold damage",
          "Whenever I deal cold damage to a creature, its speed is reduced by 10 ft until the start of my next turn",
        ]),
      },
      "fire giant": {
        name: "Awakened Fire Giant Bloodline",
        description: desc([
          "While wearing armor, I can use my Con mod, in place of Dex, to calculate my AC", // here we go again... this is impossible to add
          "When a creature within 30 feet deals me damage, I can use my reaction to deal one Expl Die fire damage to it",
        ]),
        action: [["reaction", "Awakened Fire Bloodline"]],
        extraAC: [
          {
            name: "Awakened Fire Bloodline",
            mod: "max(Con-Dex|0)",
            text: "I can use my Con to calculate my AC instead of Dex while wearing armor",
            stopeval: function (v) {
              return !v.wearingArmor; // light armor only
            },
          },
        ],
        // NOTE: It is impossible to put a nested min/max expression (the sheet can't handle it)
        // It is mathematically impossible to formulate this expression without it, so there's nothing I can do
      },
      "cloud giant": {
        name: "Awakened Cloud Giant Bloodline",
        description: desc([
          "I gain resistance to falling damage, and I can take the Dash or Disengage action as a bonus action",
        ]),
        action: [["bonus action", "Dash/Disengage"]],
        dmgres: ["Falling damage"],
      },
      "storm giant": {
        name: "Awakened Storm Giant Bloodline",
        description: desc([
          "When I use the exploits Hurl or Greater Hurl, they now deals Lightning damage instead of Bludgeoning",
          "Also, creatures have disadv. to resist these exploits",
        ]),
        spellChanges: {
          hurl: {
            description:
              "1 crea makes Dex save (with disadv.) or both crea and thrown object take Exploit Die + Str lightning dmg",
            changes:
              "It deals Lightning damage instead of Bludgeoning and creature have disadvantage on the Dexterity saving throw against this Exploit",
          },
          "greater hurl": {
            description:
              "Throw a crea at least one size smaller than me to a space within 30 ft (see book)",
            changes:
              "It deals Lightning damage instead of Bludgeoning and creature have disadvantage on the Strength and Dexterity saving throws against this Exploit",
          },
        },
      },
    },
    subclassfeature14: {
      name: "Titanic Wrath",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      description: desc([
        "As an action while Raging, I can focus all my power into one melee weapon attack",
        "I make one attack for this action, even if I have a feature that lets me do more than one attack",
        "On hit, it becomes a critical hit, regardless of my attack roll",
      ]),
      action: [["action", ""]],
      usages: "Str mod per ",
      usagescalc: "event.value = Math.max(1, What('Str Mod'));",
      recovery: "long rest",
    },
  },
});

// Path of the Warden
AddSubClass("barbarian(laserllama)", "warden", {
  regExpSearch: /warden/i,
  subname: "Path of the Warden",
  fullname: "Warden",
  source: [["GMB:LL", 0]],
  abilitySave: 3,
  spellcastingFactor: "warlock3",
  spellcastingTable: [
    [0, 0, 0, 0, 0, 0, 0, 0, 0], //lvl 0
    [0, 0, 0, 0, 0, 0, 0, 0, 0], //lvl 1
    [0, 0, 0, 0, 0, 0, 0, 0, 0], //lvl 2
    [1, 0, 0, 0, 0, 0, 0, 0, 0], //lvl 3
    [2, 0, 0, 0, 0, 0, 0, 0, 0], //lvl 4
    [2, 0, 0, 0, 0, 0, 0, 0, 0], //lvl 5
    [2, 0, 0, 0, 0, 0, 0, 0, 0], //lvl 6
    [0, 2, 0, 0, 0, 0, 0, 0, 0], //lvl 7
    [0, 2, 0, 0, 0, 0, 0, 0, 0], //lvl 8
    [0, 2, 0, 0, 0, 0, 0, 0, 0], //lvl 9
    [0, 2, 0, 0, 0, 0, 0, 0, 0], //lvl10
    [0, 2, 0, 0, 0, 0, 0, 0, 0], //lvl11
    [0, 2, 0, 0, 0, 0, 0, 0, 0], //lvl12
    [0, 0, 2, 0, 0, 0, 0, 0, 0], //lvl13
    [0, 0, 2, 0, 0, 0, 0, 0, 0], //lvl14
    [0, 0, 2, 0, 0, 0, 0, 0, 0], //lvl15
    [0, 0, 2, 0, 0, 0, 0, 0, 0], //lvl16
    [0, 0, 2, 0, 0, 0, 0, 0, 0], //lvl17
    [0, 0, 2, 0, 0, 0, 0, 0, 0], //lvl18
    [0, 0, 0, 2, 0, 0, 0, 0, 0], //lvl19
    [0, 0, 0, 2, 0, 0, 0, 0, 0], //lvl20
  ],
  spellcastingList: {
    spells: WardenList,
  },
  spellcastingKnown: {
    cantrips: [0, 0, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
    spells: [0, 0, 2, 2, 3, 3, 4, 4, 5, 5, 5, 5, 6, 6, 6, 6, 7, 7, 7, 7],
  },
  features: {
    subclassfeature3: {
      name: "Spellcasting",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I can cast known Warden spells, using Constitution as my spellcasting ability",
        "I can replace a spell I know with another I have spell slots for when I gain a level",
        "I regain these spell slots on a short rest",
      ]),
      additional: [
        "",
        "",
        "1 cantrip \u0026 2 spells known",
        "1 cantrip \u0026 2 spells known",
        "1 cantrip \u0026 3 spells known",
        "1 cantrip \u0026 3 spells known",
        "1 cantrip \u0026 4 spells known",
        "1 cantrip \u0026 4 spells known",
        "1 cantrip \u0026 5 spells known",
        "2 cantrips \u0026 5 spells known",
        "2 cantrips \u0026 5 spells known",
        "2 cantrips \u0026 5 spells known",
        "2 cantrips \u0026 6 spells known",
        "2 cantrips \u0026 6 spells known",
        "2 cantrips \u0026 6 spells known",
        "2 cantrips \u0026 6 spells known",
        "2 cantrips \u0026 7 spells known",
        "2 cantrips \u0026 7 spells known",
        "2 cantrips \u0026 7 spells known",
        "2 cantrips \u0026 7 spells known",
      ],
    },
    "subclassfeature3.1": {
      name: "Primal Rage",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map(function (n) {
        if (n < 14) {
          return desc([
            "I can cast Warden spells while Raging, but I have disadvantage on any Con save to maintain concentration on my Warden spells while Raging",
            "Casting a Warden spell of 1st-level or higher allows my Rage to continue until the end of my next turn, even if I don't meet the other requirements to extend my Rage",
          ]);
        }
        return desc([
          "I can cast Warden spells while Raging",
          "Casting a Warden spell of 1st-level or higher allows my Rage to continue until the end of my next turn, even if I don't meet the other requirements to extend my Rage",
        ]);
      }),
    },
    subclassfeature6: {
      name: "War Magic",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "When I use my action to cast a Warden spell, I can make a weapon attack as a bonus action",
      ]),
      action: ["bonus action", " (one attack)"],
    },
    "subclassfeature6.1": {
      name: "Reckless Spellcasting",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "I can use Reckless Attack when I cast a Warden spell that requires spell attack rolls",
      ]),
      action: ["bonus action", " (spell attack)"],
    },
    subclassfeature10: {
      name: "Ward of the Ancients",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "As a reaction when I take damage from a spell, I can expend a Primal Magic spell slot to reduce the damage 2 ED * Spell Slot Level",
      ]),
      action: ["reaction", ""],
    },
    subclassfeature14: {
      name: "Improved Guardian's Fury",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      description: desc([
        "When I take the Attack action while Raging, I can cast a Warden spell with casting time of one action in place of one of my attacks",
        "Also my Primal Rage is improved (see Primal Rage)",
      ]),
    },
  },
});

// Path of the Wyrmblood
AddSubClass("barbarian(laserllama)", "wyrmblood", {
  regExpSearch: /wyrmblood/i,
  subname: "Path of the Wyrmblood",
  fullname: "Wyrmblood",
  source: [["GMB:LL", 0]],
  features: {
    subclassfeature3: GetBarbarianSubclassExploits("Wyrmblood", [
      "commanding presence",
      "ruthless strike",
      "primal senses",
      "intimidating command",
      "roar of triumph",
    ]),
    "subclassfeature3.1": {
      name: "Draconic Ancestry",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        'Choose the option that best fits the type of dragon whose power resides in you using the "Choose Feature" button above',
        "I gain resistance to my Dragon's associated Element. I also learn Draconic.",
      ]),
      languageProfs: ["Draconic"],
      choices: [
        "Amethyst Dragon",
        "Black Dragon",
        "Blue Dragon",
        "Brass Dragon",
        "Bronze Dragon",
        "Copper Dragon",
        "Crystal Dragon",
        "Emerald Dragon",
        "Gold Dragon",
        "Green Dragon",
        "Red Dragon",
        "Sapphire Dragon",
        "Silver Dragon",
        "Steel Dragon",
        "Topaz Dragon",
        "White Dragon",
      ],
      "amethyst dragon": {
        name: "Amethyst Draconic Ancestry",
        description: desc([
          "The power of Amethyst dragons reside in me, which are affiliated with Force damage",
          "I gain resistance to Force damage and learn Draconic",
        ]),
        dmgres: ["Force"],
        dependentChoices: "force",
      },
      "black dragon": {
        name: "Black Draconic Ancestry",
        description: desc([
          "The power of Black dragons reside in me, which are affiliated with Acid damage",
          "I gain resistance to Acid damage and learn Draconic",
        ]),
        dmgres: ["Acid"],
        dependentChoices: "acid",
      },
      "blue dragon": {
        name: "Blue Draconic Ancestry",
        description: desc([
          "The power of Blue dragons reside in me, which are affiliated with Lightning damage",
          "I gain resistance to Lightning damage and learn Draconic",
        ]),
        dmgres: ["Lightning"],
        dependentChoices: "lightning",
      },
      "brass dragon": {
        name: "Brass Draconic Ancestry",
        description: desc([
          "The power of Brass dragons reside in me, which are affiliated with Fire damage",
          "I gain resistance to Fire damage and learn Draconic",
        ]),
        dmgres: ["Fire"],
        dependentChoices: "fire",
      },
      "bronze dragon": {
        name: "Bronze Draconic Ancestry",
        description: desc([
          "The power of Bronze dragons reside in me, which are affiliated with Lightning damage",
          "I gain resistance to Lightning damage and learn Draconic",
        ]),
        dmgres: ["Lightning"],
        dependentChoices: "lightning",
      },
      "copper dragon": {
        name: "Copper Draconic Ancestry",
        description: desc([
          "The power of Copper dragons reside in me, which are affiliated with Acid damage",
          "I gain resistance to Acid damage and learn Draconic",
        ]),
        dmgres: ["Acid"],
        dependentChoices: "acid",
      },
      "crystal dragon": {
        name: "Crystal Draconic Ancestry",
        description: desc([
          "The power of Crystal dragons reside in me, which are affiliated with Radiant damage",
          "I gain resistance to Radiant damage and learn Draconic",
        ]),
        dmgres: ["Radiant"],
        dependentChoices: "radiant",
      },
      "emerald dragon": {
        name: "Emerald Draconic Ancestry",
        description: desc([
          "The power of Emerald dragons reside in me, which are affiliated with Psychic damage",
          "I gain resistance to Psychic damage and learn Draconic",
        ]),
        dmgres: ["Psychic"],
        dependentChoices: "psychic",
      },
      "gold dragon": {
        name: "Gold Draconic Ancestry",
        description: desc([
          "The power of Gold dragons reside in me, which are affiliated with Fire damage",
          "I gain resistance to Fire damage and learn Draconic",
        ]),
        dmgres: ["Fire"],
        dependentChoices: "fire",
      },
      "green dragon": {
        name: "Green Draconic Ancestry",
        description: desc([
          "The power of Green dragons reside in me, which are affiliated with Poison damage",
          "I gain resistance to Poison damage and learn Draconic",
        ]),
        dmgres: ["Poison"],
        dependentChoices: "poison",
      },
      "red dragon": {
        name: "Red Draconic Ancestry",
        description: desc([
          "The power of Red dragons reside in me, which are affiliated with Fire damage",
          "I gain resistance to Fire damage and learn Draconic",
        ]),
        dmgres: ["Fire"],
        dependentChoices: "fire",
      },
      "sapphire dragon": {
        name: "Sapphire Draconic Ancestry",
        description: desc([
          "The power of Sapphire dragons reside in me, which are affiliated with Thunder damage",
          "I gain resistance to Thunder damage and learn Draconic",
        ]),
        dmgres: ["Thunder"],
        dependentChoices: "thunder",
      },
      "silver dragon": {
        name: "Silver Draconic Ancestry",
        description: desc([
          "The power of Silver dragons reside in me, which are affiliated with Cold damage",
          "I gain resistance to Cold damage and learn Draconic",
        ]),
        dmgres: ["Cold"],
        dependentChoices: "cold",
      },
      "steel dragon": {
        name: "Steel Draconic Ancestry",
        description: desc([
          "The power of Steel dragons reside in me, which are affiliated with Acid damage",
          "I gain resistance to Acid damage and learn Draconic",
        ]),
        dmgres: ["Acid"],
        dependentChoices: "acid",
      },
      "topaz dragon": {
        name: "Topaz Draconic Ancestry",
        description: desc([
          "The power of Topaz dragons reside in me, which are affiliated with Necrotic damage",
          "I gain resistance to Necrotic damage and learn Draconic",
        ]),
        dmgres: ["Necrotic"],
        dependentChoices: "necrotic",
      },
      "white dragon": {
        name: "White Draconic Ancestry",
        description: desc([
          "The power of White dragons reside in me, which are affiliated with Cold damage",
          "I gain resistance to Cold damage and learn Draconic",
        ]),
        dmgres: ["Cold"],
        dependentChoices: "cold",
      },

      // Create the dependency for the other features
      choiceDependencies: [
        {
          feature: "subclassfeature3.2",
          choiceAttribute: true,
        },
        {
          feature: "subclassfeature10",
          choiceAttribute: true,
        },
      ],
    },
    "subclassfeature3.2": {
      name: "Draconic Fury",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "When I Rage, I gain the following benefits:",
        "\u2022 Draconic scales give me a +2 bonus to my AC while using Unarmored Defense",
        "\u2022 My Rage damage bonus and Savage Exploits deal my Element damage in place of their normal damage",
        "\u2022 Once per turn when I hit with a Strength-based weapon attack, I can roll two dice for my Rage damage bonus",
      ]),
      extraAC: [
        {
          mod: 2,
          magic: true,
          text: "I gain a +2 bonus to AC while using Unarmored Defense",
          stopeval: function (v) {
            return v.wearingArmor || v.theArmor.name == "Mage Armor";
          },
        },
      ],

      choices: [
        "fire",
        "cold",
        "poison",
        "acid",
        "thunder",
        "lightning",
        "radiant",
        "necrotic",
        "psychic",
        "force",
      ],
      choicesNotInMenu: true, // inherit attribute from subclassfeature3.1
      fire: {
        name: "Draconic Fury",
        description: desc([
          "When I Rage, I gain the following benefits:",
          "\u2022 Draconic scales give me a +2 bonus to my AC while using Unarmored Defense",
          "\u2022 My Rage damage bonus and Savage Exploits deal Fire damage in place of their normal damage",
          "\u2022 Once per turn when I hit with a Strength-based weapon attack, I can roll two dice for my Rage damage bonus",
        ]),
      },
      cold: {
        name: "Draconic Fury",
        description: desc([
          "When I Rage, I gain the following benefits:",
          "\u2022 Draconic scales give me a +2 bonus to my AC while using Unarmored Defense",
          "\u2022 My Rage damage bonus and Savage Exploits deal Cold damage in place of their normal damage",
          "\u2022 Once per turn when I hit with a Strength-based weapon attack, I can roll two dice for my Rage damage bonus",
        ]),
      },
      poison: {
        name: "Draconic Fury",
        description: desc([
          "When I Rage, I gain the following benefits:",
          "\u2022 Draconic scales give me a +2 bonus to my AC while using Unarmored Defense",
          "\u2022 My Rage damage bonus and Savage Exploits deal Poison damage in place of their normal damage",
          "\u2022 Once per turn when I hit with a Strength-based weapon attack, I can roll two dice for my Rage damage bonus",
        ]),
      },
      acid: {
        name: "Draconic Fury",
        description: desc([
          "When I Rage, I gain the following benefits:",
          "\u2022 Draconic scales give me a +2 bonus to my AC while using Unarmored Defense",
          "\u2022 My Rage damage bonus and Savage Exploits deal Acid damage in place of their normal damage",
          "\u2022 Once per turn when I hit with a Strength-based weapon attack, I can roll two dice for my Rage damage bonus",
        ]),
      },
      thunder: {
        name: "Draconic Fury",
        description: desc([
          "When I Rage, I gain the following benefits:",
          "\u2022 Draconic scales give me a +2 bonus to my AC while using Unarmored Defense",
          "\u2022 My Rage damage bonus and Savage Exploits deal Thunder damage in place of their normal damage",
          "\u2022 Once per turn when I hit with a Strength-based weapon attack, I can roll two dice for my Rage damage bonus",
        ]),
      },
      lightning: {
        name: "Draconic Fury",
        description: desc([
          "When I Rage, I gain the following benefits:",
          "\u2022 Draconic scales give me a +2 bonus to my AC while using Unarmored Defense",
          "\u2022 My Rage damage bonus and Savage Exploits deal Lightning damage in place of their normal damage",
          "\u2022 Once per turn when I hit with a Strength-based weapon attack, I can roll two dice for my Rage damage bonus",
        ]),
      },
      radiant: {
        name: "Draconic Fury",
        description: desc([
          "When I Rage, I gain the following benefits:",
          "\u2022 Draconic scales give me a +2 bonus to my AC while using Unarmored Defense",
          "\u2022 My Rage damage bonus and Savage Exploits deal Radiant damage in place of their normal damage",
          "\u2022 Once per turn when I hit with a Strength-based weapon attack, I can roll two dice for my Rage damage bonus",
        ]),
      },
      necrotic: {
        name: "Draconic Fury",
        description: desc([
          "When I Rage, I gain the following benefits:",
          "\u2022 Draconic scales give me a +2 bonus to my AC while using Unarmored Defense",
          "\u2022 My Rage damage bonus and Savage Exploits deal Necrotic damage in place of their normal damage",
          "\u2022 Once per turn when I hit with a Strength-based weapon attack, I can roll two dice for my Rage damage bonus",
        ]),
      },
      psychic: {
        name: "Draconic Fury",
        description: desc([
          "When I Rage, I gain the following benefits:",
          "\u2022 Draconic scales give me a +2 bonus to my AC while using Unarmored Defense",
          "\u2022 My Rage damage bonus and Savage Exploits deal Psychic damage in place of their normal damage",
          "\u2022 Once per turn when I hit with a Strength-based weapon attack, I can roll two dice for my Rage damage bonus",
        ]),
      },
      force: {
        name: "Draconic Fury",
        description: desc([
          "When I Rage, I gain the following benefits:",
          "\u2022 Draconic scales give me a +2 bonus to my AC while using Unarmored Defense",
          "\u2022 My Rage damage bonus and Savage Exploits deal Force damage in place of their normal damage",
          "\u2022 Once per turn when I hit with a Strength-based weapon attack, I can roll two dice for my Rage damage bonus",
        ]),
      },
    },
    subclassfeature6: {
      name: "Tyrannical Resilience",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "While Raging, I add my Expl Die to all Int, Wis, and Cha saves against magic",
      ]),
      savetxt: {
        text: ["Add Expl Die to Int/Wis/Cha vs. magic in rage"],
      },
      // In theory, I could merge this feature with the lvl 3 rage improvements, but it would mean that there is no text added to the saves field
    },
    subclassfeature10: {
      name: "Breath of the Dragon",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "As an action, I can force creatures in an adjacent 30-foot cone to make a Dex save against my Exploit DC. On a fail, creatures take 8d6 damage of my Element damage type (half on save).",
        "When I have no uses left, I can expend a use of Rage to use this feature again",
      ]),
      action: [["action", ""]],
      usages: "Con mod per ",
      usagescalc: "event.value = Math.max(1, What('Con Mod'));",
      recovery: "long rest",
      altResource: "Rage",

      choices: [
        "fire",
        "cold",
        "poison",
        "acid",
        "thunder",
        "lightning",
        "radiant",
        "necrotic",
        "psychic",
        "force",
      ],
      choicesNotInMenu: true, // inherit attribute from subclassfeature3.1
      fire: {
        name: "Breath of the Dragon",
        description: desc([
          "As an action, I can force creatures in an adjacent 30-foot cone to make a Dex save against my Exploit DC. On a fail, creatures take 8d6 fire damage (half on save).",
          "When I have no uses left, I can expend a use of Rage to use this feature again",
        ]),
      },
      cold: {
        name: "Breath of the Dragon",
        description: desc([
          "As an action, I can force creatures in an adjacent 30-foot cone to make a Dex save against my Exploit DC. On a fail, creatures take 8d6 cold damage (half on save).",
          "When I have no uses left, I can expend a use of Rage to use this feature again",
        ]),
      },
      poison: {
        name: "Breath of the Dragon",
        description: desc([
          "As an action, I can force creatures in an adjacent 30-foot cone to make a Dex save against my Exploit DC. On a fail, creatures take 8d6 poison damage (half on save).",
          "When I have no uses left, I can expend a use of Rage to use this feature again",
        ]),
      },
      acid: {
        name: "Breath of the Dragon",
        description: desc([
          "As an action, I can force creatures in an adjacent 30-foot cone to make a Dex save against my Exploit DC. On a fail, creatures take 8d6 acid damage (half on save).",
          "When I have no uses left, I can expend a use of Rage to use this feature again",
        ]),
      },
      thunder: {
        name: "Breath of the Dragon",
        description: desc([
          "As an action, I can force creatures in an adjacent 30-foot cone to make a Dex save against my Exploit DC. On a fail, creatures take 8d6 thunder damage (half on save).",
          "When I have no uses left, I can expend a use of Rage to use this feature again",
        ]),
      },
      lightning: {
        name: "Breath of the Dragon",
        description: desc([
          "As an action, I can force creatures in an adjacent 30-foot cone to make a Dex save against my Exploit DC. On a fail, creatures take 8d6 lightning damage (half on save).",
          "When I have no uses left, I can expend a use of Rage to use this feature again",
        ]),
      },
      radiant: {
        name: "Breath of the Dragon",
        description: desc([
          "As an action, I can force creatures in an adjacent 30-foot cone to make a Dex save against my Exploit DC. On a fail, creatures take 8d6 radiant damage (half on save).",
          "When I have no uses left, I can expend a use of Rage to use this feature again",
        ]),
      },
      necrotic: {
        name: "Breath of the Dragon",
        description: desc([
          "As an action, I can force creatures in an adjacent 30-foot cone to make a Dex save against my Exploit DC. On a fail, creatures take 8d6 necrotic damage (half on save).",
          "When I have no uses left, I can expend a use of Rage to use this feature again",
        ]),
      },
      psychic: {
        name: "Breath of the Dragon",
        description: desc([
          "As an action, I can force creatures in an adjacent 30-foot cone to make a Dex save against my Exploit DC. On a fail, creatures take 8d6 psychic damage (half on save).",
          "When I have no uses left, I can expend a use of Rage to use this feature again",
        ]),
      },
      force: {
        name: "Breath of the Dragon",
        description: desc([
          "As an action, I can force creatures in an adjacent 30-foot cone to make a Dex save against my Exploit DC. On a fail, creatures take 8d6 force damage (half on save).",
          "When I have no uses left, I can expend a use of Rage to use this feature again",
        ]),
      },
    },
    subclassfeature14: {
      name: "Draconic Wings",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      description: desc([
        "As a bonus action, I can manifest or dismiss a pair of draconic wings",
        "These wings grant me a fly speed equal to my walk speed",
        "Clothing that is not made to accommodate my wings is destroyed when I manifest them",
      ]),
      action: [["bonus action", " (manifest/dismiss)"]],
      speed: {
        fly: { spd: "walk", enc: 0 },
      },
    },
  },
});

// Subclasses Alternate Fighter
// Arcane Knight (eldritch knight)
AddSubClass("fighter(laserllama)", "arcane knight", {
  regExpSearch: /arcane knight/i,
  subname: "Arcane Knight",
  fullname: "Arcane Knight",
  source: [["GMB:LL", 0]],
  abilitySave: 4,
  spellcastingFactor: 3,
  spellcastingList: {
    spells: ArcaneKnightList,
  },
  spellcastingKnown: {
    cantrips: [0, 0, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3],
    spells: [0, 0, 3, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9, 10, 10, 11, 11, 12, 12],
  },
  features: {
    // Override action surge because of the lvl 15 subclass feature
    "action surge": (function () {
      var actsurge = newObj(
        ClassList["fighter(laserllama)"].features["action surge"]
      );
      actsurge.additional = [
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "30 ft teleport",
        "30 ft teleport",
        "30 ft teleport",
        "30 ft teleport",
        "30 ft teleport",
        "30 ft teleport",
      ];
      return actsurge;
    })(),
    subclassfeature3: {
      name: "Spellcasting",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I can cast known Arcane Knight spells, using Intelligence as my spellcasting ability",
        "I can replace a spell I know with another I have spell slots for when I gain a level",
      ]),
      additional: [
        "",
        "",
        "2 cantrips \u0026 3 spells known",
        "2 cantrips \u0026 4 spells known",
        "2 cantrips \u0026 5 spells known",
        "2 cantrips \u0026 5 spells known",
        "2 cantrips \u0026 6 spells known",
        "2 cantrips \u0026 6 spells known",
        "2 cantrips \u0026 7 spells known",
        "3 cantrips \u0026 7 spells known",
        "3 cantrips \u0026 8 spells known",
        "3 cantrips \u0026 8 spells known",
        "3 cantrips \u0026 9 spells known",
        "3 cantrips \u0026 9 spells known",
        "3 cantrips \u0026 10 spells known",
        "3 cantrips \u0026 10 spells known",
        "3 cantrips \u0026 11 spells known",
        "3 cantrips \u0026 11 spells known",
        "3 cantrips \u0026 12 spells known",
        "3 cantrips \u0026 12 spells known",
      ],
    },
    "subclassfeature3.1": {
      name: "Enchanted Armaments",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "Over 1-hour, which can be during a short or long rest, I can touch a weapon or shield, forging a magical bond",
        "I cannot be disarmed of a bonded weapon unless I am incapacitated",
        "If it is on the same plane of existence, I can use a bonus action to instantly donning them",
        "It can be used as a spellcasting focus for my Arcane Knight spells",
        "I can have up to two bonded weapons/shields, and I can only summon them both or only one",
      ]),
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (
              classes.known["fighter(laserllama)"] &&
              classes.known["fighter(laserllama)"].level >= 3 &&
              v.isWeapon &&
              /bond/i.test(v.WeaponTextName)
            ) {
              fields.Description +=
                (fields.Description ? "; " : "") +
                "Cannot be disarmed unless incapacitated";
            }
          },
          "I cannot be disarmed of a bonded weapon unless I am incapacitated",
          19,
        ],
      },
      action: [["bonus action", " (summon)"]],
    },
    subclassfeature7: {
      name: "War Magic",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description:
        "\n   " +
        "When I use my action to cast an Arcane Knight spell, I can make a weapon attack as a bonus action",
      action: ["bonus action", ""],
    },
    subclassfeature10: {
      name: "Enchanted Strikes",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description:
        "\n   " +
        "A creature hit by my weapon attack has disadv. on the save vs. the next spell I cast" +
        "\n   " +
        "This lasts until the end of my next turn" +
        "\n   " +
        "When I hit a target with my bonded weapon, I can change the damage type with the type of a spell I know",
    },
    subclassfeature15: {
      name: "Arcane Surge",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description:
        "\n   " +
        "When I use Action Surge, I can also teleport up to 30 ft to an empty space I can see" +
        "\n   " +
        "I can do so before or after the extra action",
    },
    subclassfeature18: {
      name: "Legendary Arcane Knight",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc(
        "When I take the Attack action on my turn, I can cast an Arcane Knight spell with a casting time of one action in place of one attack"
      ),
    },
  },
});

// Champion
AddSubClass("fighter(laserllama)", "champion", {
  regExpSearch: /champion/i,
  subname: "Champion",
  fullname: "Champion",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: GetFighterSubclassExploits("Champion", [
      "feat of strength",
      "heroic fortitude",
      "concussive blow",
      "martial focus",
      "mythic athleticism",
    ]),
    "subclassfeature3.1": {
      name: "Mighty Warrior",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map(function (n) {
        return n < 15
          ? desc(
            "I score a critical hit with my weapon attacks on a roll of 19 and 20"
          )
          : desc(
            "I score a critical hit with my weapon attacks on a roll of 18, 19 and 20"
          );
      }),
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (
              !v.isSpell &&
              !v.CritChance &&
              classes.known["fighter(laserllama)"] &&
              classes.known["fighter(laserllama)"].level < 15
            ) {
              fields.Description +=
                (fields.Description ? "; " : "") + "Crit on 19-20";
              v.CritChance = 19;
            }
            if (
              !v.isSpell &&
              (!v.CritChance || v.CritChance >= 19) &&
              classes.known["fighter(laserllama)"] &&
              classes.known["fighter(laserllama)"].level >= 15
            ) {
              fields.Description +=
                (fields.Description ? "; " : "") + "Crit on 18-20";
              v.CritChance = 18;
            }
          },
          "My weapon attacks score a critical hit on 19-20 (if fighter lvl < 15) or 18-20 (if fighter lvl >=15)",
          19,
        ],
      },
    },
    "subclassfeature3.2": {
      name: "Peak Athlete",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc(
        "I gain swim and climb speed equal to my walking speed.",
        "I gain proficiency in Athletics, if already proficient I choose a Fighter class skill of my choice"
      ),
      extraname: "Peak Athlete proficiencies",
      extrachoices: [
        "Athletics",
        "Acrobatics",
        "Animal Handling",
        "History",
        "Intimidation",
        "Perception",
        "Stealth",
        "Survival",
      ],
      extraTimes: 1,
      athletics: {
        name: "Athletics",
        skills: ["Athletics"],
        prereqeval: function (v) {
          return v.skillProfs.indexOf("Athletics") === -1; // must NOT be proficient already
        },
      },
      acrobatics: {
        name: "Acrobatics",
        skills: ["Acrobatics"],
        prereqeval: function (v) {
          return (
            v.skillProfs.indexOf("Acrobatics") === -1 &&
            v.skillProfs.indexOf("Athletics") !== -1
          );
        },
      },
      "animal handling": {
        name: "Animal Handling",
        skills: ["Animal Handling"],
        prereqeval: function (v) {
          return (
            v.skillProfs.indexOf("Animal Handling") === -1 &&
            v.skillProfs.indexOf("Athletics") !== -1
          );
        },
      },
      history: {
        name: "History",
        skills: ["History"],
        prereqeval: function (v) {
          return (
            v.skillProfs.indexOf("History") === -1 &&
            v.skillProfs.indexOf("Athletics") !== -1
          );
        },
      },
      intimidation: {
        name: "Intimidation",
        skills: ["Intimidation"],
        prereqeval: function (v) {
          return (
            v.skillProfs.indexOf("Intimidation") === -1 &&
            v.skillProfs.indexOf("Athletics") !== -1
          );
        },
      },
      perception: {
        name: "Perception",
        skills: ["Perception"],
        prereqeval: function (v) {
          return (
            v.skillProfs.indexOf("Perception") === -1 &&
            v.skillProfs.indexOf("Athletics") !== -1
          );
        },
      },
      stealth: {
        name: "Stealth",
        skills: ["Stealth"],
        prereqeval: function (v) {
          return (
            v.skillProfs.indexOf("Stealth") === -1 &&
            v.skillProfs.indexOf("Athletics") !== -1
          );
        },
      },
      survival: {
        name: "Survival",
        skills: ["Survival"],
        prereqeval: function (v) {
          return (
            v.skillProfs.indexOf("Survival") === -1 &&
            v.skillProfs.indexOf("Athletics") !== -1
          );
        },
      },
      speed: {
        swim: { spd: "walk", enc: 0 },
        climb: { spd: "walk", enc: 0 },
      },
    },
    subclassfeature7: {
      name: "Remarkable Strength",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "When I make Strength or Constitution saves or checks, I can use Feat of Strength or Heroic Fortitud Exploits without expending an Exploit Die",
        "Used this way the Exploits are counted as I spent only one Epxloit Die",
      ]),
      savetxt: { text: ["Add my Exploit Die on Str and Con saves"] },
    },
    subclassfeature10: {
      name: "Devastating Critical",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "Whenever I score a critical hit with a weapon attack, I can deal additional damage equal to my Fighter level",
      ]),
    },
    subclassfeature15: {
      name: "Devastating Critical Improvement",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "When I score a critical hit with a weapon attack, I can maximize the damage instead of rolling",
      ]),
      usages: 1,
      recovery: "long rest",
    },
    subclassfeature18: {
      name: "Legendary Champion",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc(
        "At the start of my turn, if I'm not above half or at 0 HP, I regain 5 + Con mod HP"
      ),
    },
  },
});

// Captain (banneret)
AddSubClass("fighter(laserllama)", "captain", {
  regExpSearch: /captain/i,
  subname: "Captain",
  fullname: "Captain",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: (function () {
      // Fixed attributes
      MartialExploits = {
        name: "Captain Exploits",
        minlevel: 3,
        source: [["GMB:LL", 0]],
        description: desc([
          "I learn additional Exploits who don't count against my total and they are Captain Exploit",
          "Each time I gain a level in this class I can replace one Captain Exploit I know with one from the list",
          'Use "Choose Feature" to replace the Captain Exploits you know',
        ]),
        toNotesPage: [
          {
            name: "Captain Exploits",
            note: desc([
              "Below are my Captain exploits. The 3rd level exploit can only be used per short rest.",
              "Each time I gain a level in this class I can replace one Captain Exploit I know with one from the list",
              'Use "Choose Feature" present in your Class Features to replace the Captain Exploits you know',
            ]),
          },
        ],

        // Martial Exploits
        extraname: "Captain Exploits",
        extraTimes: levels.map(function (n) {
          return n < 3 ? 0 : n < 5 ? 2 : n < 9 ? 4 : 5;
        }),
        extrachoices: [],
        autoSelectExtrachoices: [
          {
            extrachoice: "attack order",
            minlevel: 3,
          },
          {
            extrachoice: "defensive order",
            minlevel: 3,
          },
          {
            extrachoice: "enlivening order",
            minlevel: 5,
          },
          {
            extrachoice: "surprise attack",
            minlevel: 5,
          },
          {
            extrachoice: "tactical reposition",
            minlevel: 9,
          },
        ],

        // Eval
        eval: CreateMartialSpellsheet,
      };

      // Make a filtered spell list that contains only Fighter(laserllama) "spells" of degree <= 3
      const FighterSpells = Object.keys(SpellsList)
        .filter((key) => SpellsList[key].isExploit)
        .filter((key) => {
          for (var i = 0; i < SpellsList[key].classes.length; i++) {
            if (
              SpellsList[key].classes[i] == "warlord(laserllama)" &&
              SpellsList[key].level <= 3
            )
              return true;
          }
          return false;
          // NOTE: this is literally a SpellsList[key].classes.includes("fighter(laserllama)") but for some cursed reason I can't use that function
        });

      //const DegreeToMinLevel = [0,0,5,9,13,17]
      // Iterate over all Fighter(laserllama) "spells"
      for (var i = 0; i < FighterSpells.length; i++) {
        var NewSpell = SpellsList[FighterSpells[i]];

        MartialExploits.extrachoices.push(NewSpell.name); // Add "spell" name to menu options

        MartialExploits[FighterSpells[i]] = {
          // Add "spell" to the main item (when it is picked through the menu)
          name: NewSpell.name,
          toNotesPage: [
            {
              // What is added to the notes page
              name:
                NewSpell.name +
                " Exploit [" +
                (NewSpell.level == 1
                  ? "1st"
                  : NewSpell.level == 2
                    ? "2nd"
                    : NewSpell.level == 3
                      ? "3rd"
                      : NewSpell.level + "th") +
                " degree]",
              note: desc(NewSpell.descriptionFull),
              amendTo: "Captain Exploits",
            },
          ],
          source: NewSpell.source,
          addMod: NewSpell.addMod,
          submenu: NewSpell.submenu,
          prereqeval: ExploitPrereqFactory(
            FighterSpells[i],
            "fighter(laserllama)"
          ),
          eval: MartialExploits.eval, // in case the user removes all exploits
          spellcastingBonusElsewhere: {
            addTo: "martial exploits",
            spellcastingBonus: {
              name: "Captain Exploits",
              spellcastingAbility: 1,
              spells: [FighterSpells[i]],
              selection: [FighterSpells[i]],
            },
          },
        };
      }

      return MartialExploits;
    })(),
    "subclassfeature3.1": {
      name: "Student of War",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I gain proficiency in either Deception History, Insight, or Persuasion, and whenever I make an ability check with that skill I gain a bonus to my roll equal to one roll of my Exploit Die",
      ]),
      skillstxt: "Choose one from: Deception, History, Insight, or Persuasion",
    },
    subclassfeature7: {
      name: "Strategic Command",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "When I use Second Wind, I can choose up to three creatures within 30 ft that can see or hear me to regain hit points equal to one roll of my Exploit Die + my Leadership modifier",
      ]),
    },
    subclassfeature10: {
      name: "Heroic Surge",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: levels.map(function (n) {
        if (n < 18)
          return desc([
            "When I use Action Surge, I can choose another creature within 30 ft that can see or hear me",
            "It can use its reaction to move up to its full speed without provoking opportunity attacks and then make a single weapon attack",
          ]);
        return desc([
          "When I use Action Surge, I can choose two creatures within 30 feet that can see or hear me",
          "They can use their reaction to move up to their full speed without provoking opportunity attacks and then make a single weapon attack",
        ]);
      }),
    },
    subclassfeature15: {
      name: "Inspiring Commands",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "Once per turn when I use a Tactical Exploit that targets at least one friendly creature, one target of my choice gains temp HP equal to my Leadership modifier",
      ]),
    },
    subclassfeature18: {
      name: "Legendary Captain",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc([
        "At the end of a long rest I can replace any number of my Captain Exploits with Tactical Explotis of the same degree.",
      ]),
    },
  },
});

// Marksman
AddSubClass("fighter(laserllama)", "marksman", {
  regExpSearch: /marksman/i,
  subname: "Marksman",
  fullname: "Marksman",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  weaponProfs: {
    primary: [true, true, ["Firearms"]],
  },
  features: {
    subclassfeature3: GetFighterSubclassExploits("Marksman", [
      "precision strike",
      "inquisitive eye",
      "martial focus",
      "volley",
      "thunderous shot",
    ]),
    "subclassfeature3.1": {
      name: "Deadly Focus",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map(function (n) {
        if (n < 18) {
          return desc([
            "When I begin my turn and am not surprised or incapacitated, I can choose to enter a state of Focus, which imposes the following until the end of my turn:",
            "\u2022 My speed is reduced to 0 ft",
            "\u2022 Until I hit a creature with a ranged attack, I have adv. on all ranged weapon attack rolls",
            "\u2022 I can reroll 1 and 2 on my damage rolls with a ranged weapon (but must take the new rolls)",
          ]);
        }

        return desc([
          "When I begin my turn and am not surprised or incapacitated, I can choose to enter a state of Focus, which imposes the following for 1 minute or until I end it (no action required):",
          "\u2022 My speed is reduced to 10 ft",
          "\u2022 I have adv. on all ranged weapon attack rolls",
          "\u2022 I can reroll 1 and 2 on my damage rolls with a ranged weapon (but must take the new rolls)",
        ]);
      }),
    },
    "subclassfeature3.2": {
      name: "Elite Reflexes",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "When I make a Dex check or saving throw, I can expend an Exploit Die and add it to my roll",
        "I can do so after I roll, but before I know the result",
      ]),
    },
    subclassfeature7: {
      name: "Quick Shot",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "I add my proficiency bonus to my Initiative rolls as long as I am not incapacitated",
        "When I roll initiative and not surprised, I can make one ranged weapon attack as a reaction before any creature act",
      ]),
      action: ["reaction", ""],
    },
    subclassfeature10: {
      name: "Reposition",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "When I use Second Wind, my walking speed increases by 10 feet, and any opportunity attacks against me are made at disadvantage until the end of my current turn",
      ]),
    },
    subclassfeature15: {
      name: "Reliable Shot",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "My normal and long range for ranged weapon attacks increases by 10 ft times my Fighter lvl",
        "Also, once per turn, when I have advantage on a ranged weapon attack, I can forgo advantage and make one additional ranged weapon attack",
      ]),
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (
              v.isRangedWeapon &&
              !v.isNaturalWeapon &&
              !v.isDC &&
              /\d+\/\d+\s?(ft|m)/.test(fields.Range)
            ) {
              var rangeNmbr = fields.Range.match(/\b(\d+)\/(\d+)\b/);
              var shortRange = parseInt(rangeNmbr[1]);
              var longRange = parseInt(rangeNmbr[2]);
              shortRange += classes.known["fighter(laserllama)"].level * 10;
              longRange += classes.known["fighter(laserllama)"].level * 10;

              fields.Range = fields.Range.replace(
                /\b(\d+)\/(\d+)\b/,
                shortRange + "/" + longRange
              );
            }
          },
          "My normal and long range for ranged weapon attacks increases by 10 ft times my Fighter lvl",
        ],
      },
    },
    subclassfeature18: {
      name: "Legendary Marksman",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc(["The Deadly Focus is improved (see Deadly Focus)"]),
    },
  },
});

// Master at arms (battle master)
AddSubClass("fighter(laserllama)", "master at arms", {
  regExpSearch: /^(?=.*master)(?=.*arms).*$/i,
  subname: "Master at Arms",
  fullname: "Master at Arms",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    // Override martial exploits because size of die increases
    // NOTE: This has been copy pasted from the main class. IT WON'T WORK IF YOU TRY TO USE newObj ! (it will cause a crash because of some variable's scope)
    // I do not know how to fix that scoping bug, so I went for the more brute force approach. If it works, it aint stupid ;)
    "martial exploits": (function () {
      // Fixed attributes
      MartialExploits = {
        name: "Martial Exploits",
        minlevel: 2,
        source: [["GMB:LL", 0]],
        description: desc([
          "I gain Exploit Dice, which are used to fuel my Martial Exploits",
          'Use the "Choose Feature" button above to choose Martial Exploits',
        ]),
        toNotesPage: [
          {
            name: "Martial Exploits",
            note: desc([
              "Below are all Martial Exploits I know. Each 3rd and 4th degree exploits can only be used once per short rest. Each 5th degree exploit can only be used once per long rest.",
            ]),
          },
        ],

        // Martial Exploits
        extraname: "Martial Exploits",
        extraTimes: [
          "",
          2,
          3,
          3,
          4,
          4,
          5,
          5,
          6,
          6,
          7,
          7,
          8,
          8,
          9,
          9,
          10,
          10,
          11,
          11,
        ],
        extrachoices: [],
        limfeaname: "Exploit Dice",

        // Exploit dice
        usages: ["", 2, 2, 3, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 5, 6, 6, 6, 6, 6],
        additional: [
          "",
          "d6",
          "d8",
          "d8",
          "d10",
          "d10",
          "d10",
          "d10",
          "d10",
          "d10",
          "d12",
          "d12",
          "d12",
          "d12",
          "d12",
          "d12",
          "d12",
          "d12",
          "d12",
          "d12",
        ],
        recovery: "short rest",

        // Eval
        eval: CreateMartialSpellsheet,
      };

      // Make a filtered spell list that contains only Fighter(laserllama) "spells"
      const FighterSpells = Object.keys(SpellsList)
        .filter((key) => SpellsList[key].isExploit)
        .filter((key) => {
          for (var i = 0; i < SpellsList[key].classes.length; i++) {
            if (SpellsList[key].classes[i] == "fighter(laserllama)")
              return true;
          }
          return false;
          // NOTE: this is literally a SpellsList[key].classes.includes("fighter(laserllama)") but for some cursed reason I can't use that function
        });

      // Iterate over all Fighter(laserllama) "spells"
      for (var i = 0; i < FighterSpells.length; i++) {
        var NewSpell = SpellsList[FighterSpells[i]];
        var tempSpell = FighterSpells[i];

        MartialExploits.extrachoices.push(NewSpell.name); // Add "spell" name to menu options

        MartialExploits[FighterSpells[i]] = {
          // Add "spell" to the main item (when it is picked through the menu)
          name: NewSpell.name,
          toNotesPage: [
            {
              // What is added to the notes page
              name:
                NewSpell.name +
                " Exploit [" +
                (NewSpell.level == 1
                  ? "1st"
                  : NewSpell.level == 2
                    ? "2nd"
                    : NewSpell.level == 3
                      ? "3rd"
                      : NewSpell.level + "th") +
                " degree]",
              note: desc(NewSpell.descriptionFull),
              amendTo: "Martial Exploits",
            },
          ],
          source: NewSpell.source,
          addMod: NewSpell.addMod,
          submenu: NewSpell.submenu,
          prereqeval: ExploitPrereqFactory(
            FighterSpells[i],
            "fighter(laserllama)"
          ),
          eval: MartialExploits.eval, // in case the user removes all exploits
          spellcastingBonusElsewhere: {
            addTo: "martial exploits",
            spellcastingBonus: {
              name: "Martial Exploits",
              spellcastingAbility: 1,
              spells: [FighterSpells[i]],
              selection: [FighterSpells[i]],
            },
          },
        };
      }

      return MartialExploits;
    })(),

    subclassfeature3: (function () {
      // Fixed attributes
      MartialExploits = {
        name: "Student of Battle",
        minlevel: 3,
        source: [["GMB:LL", 0]],
        description: levels.map(function (n) {
          if (n < 3) return "";

          if (n >= 3 && n < 5) {
            var result = [
              "My total number of Exploit Dice increases by 1 and my Exploit Dice increase to become 1d8",
              "I also learn two 1st degree Martial Exploits of my choice who don't count against my total",
            ];
          }

          if (n >= 5 && n < 9) {
            var result = [
              "My total number of Exploit Dice increases by 1 and my Exploit Dice increase to become 1d10",
              "I also learn two 1st degree and two 2nd degree Martial Exploits of my choice who don't count against my total",
            ];
          }

          if (n >= 9 && n < 11) {
            var result = [
              "My total number of Exploit Dice increases by 1 and my Exploit Dice increase to become 1d10",
              "I also learn two 1st degree, two 2nd degree and a 3rd degree Martial Exploits of my choice who don't count against my total",
            ];
          }

          if (n >= 11) {
            var result = [
              "My total number of Exploit Dice increases by 1 and my Exploit Dice increase to become 1d12",
              "I also learn two 1st degree, two 2nd degree and a 3rd degree Martial Exploits of my choice who don't count against my total",
            ];
          }

          return desc(result);
        }),
        toNotesPage: [
          {
            name: "Master at Arms Exploits",
            note: desc([
              "Below are my Master at Arms exploits. The 3rd level exploit can only be used per short rest.",
            ]),
          },
        ],

        extraLimitedFeatures: [
          {
            name: "Exploit Dice",
            usages: 1,
            recovery: "short rest",
            addToExisting: true,
          },
        ],

        // Martial Exploits
        extraname: "Master at Arms Exploits",
        extraTimes: levels.map(function (n) {
          return n < 3 ? 0 : n < 5 ? 2 : n < 9 ? 4 : 5;
        }),
        extrachoices: [],

        // Eval
        eval: CreateMartialSpellsheet,
      };

      // Make a filtered spell list that contains only Fighter(laserllama) "spells" of degree <= 3
      const FighterSpells = Object.keys(SpellsList)
        .filter(
          (key) => SpellsList[key].isExploit && SpellsList[key].level <= 3
        )
        .filter((key) => {
          for (var i = 0; i < SpellsList[key].classes.length; i++) {
            if (SpellsList[key].classes[i] == "fighter(laserllama)")
              return true;
          }
          return false;
          // NOTE: this is literally a SpellsList[key].classes.includes("fighter(laserllama)") but for some cursed reason I can't use that function
        });

      //const DegreeToMinLevel = [0,0,5,9,13,17]
      // Iterate over all Fighter(laserllama) "spells"
      for (var i = 0; i < FighterSpells.length; i++) {
        var NewSpell = SpellsList[FighterSpells[i]];

        MartialExploits.extrachoices.push(NewSpell.name); // Add "spell" name to menu options

        MartialExploits[FighterSpells[i]] = {
          // Add "spell" to the main item (when it is picked through the menu)
          name: NewSpell.name,
          toNotesPage: [
            {
              // What is added to the notes page
              name:
                NewSpell.name +
                " Exploit [" +
                (NewSpell.level == 1
                  ? "1st"
                  : NewSpell.level == 2
                    ? "2nd"
                    : NewSpell.level == 3
                      ? "3rd"
                      : NewSpell.level + "th") +
                " degree]",
              note: desc(NewSpell.descriptionFull),
              amendTo: "Master at Arms Exploits",
            },
          ],
          source: NewSpell.source,
          addMod: NewSpell.addMod,
          submenu: NewSpell.submenu,
          prereqeval: ExploitPrereqFactory(
            FighterSpells[i],
            "fighter(laserllama)"
          ),
          eval: MartialExploits.eval, // in case the user removes all exploits
          spellcastingBonusElsewhere: {
            addTo: "martial exploits",
            spellcastingBonus: {
              name: "Master at Arms Exploits",
              spellcastingAbility: 1,
              spells: [FighterSpells[i]],
              selection: [FighterSpells[i]],
            },
          },
        };
      }

      return MartialExploits;
    })(),

    "subclassfeature3.1": (function () {
      // copies the main class feature, avoids having to copy all fighting styles
      var FSfea = newObj(
        ClassList["fighter(laserllama)"].features["fighting style"]
      );
      FSfea.name = "Advanced Techinque";
      FSfea.source = [["GMB:LL", 0]];
      FSfea.minlevel = 3;
      FSfea.description = desc([
        "I learn an additional Fighting Style, it doesn't count against my number of Fighting Styles Known",
      ]);

      FSfea.extraname = "Advanced Techinque Fighting Style";
      FSfea.extrachoices = FSfea.choices;
      FSfea.extraTimes = 1;
      FSfea.choices = undefined; // work-around to prevent having the choice menu display twice

      return FSfea;
    })(),
    "subclassfeature3.2": {
      name: "Combat Theroist",
      minlevel: 3,
      source: [["GMB:LL", 0]],
      description: desc([
        "I gain proficiency in History",
        "Whenever I make a Intelligence(History) check related to history of combat, warfare or armamantes of war, I have a bonus to the roll equal to my Exploit Die",
      ]),
      skills: ["History"],
    },

    subclassfeature7: (function () {
      // Fixed attributes
      MartialExploits = {
        name: "Master of Forms",
        minlevel: 7,
        source: [["GMB:LL", 0]],
        description: levels.map(function (n) {
          if (n < 7) return "";

          if (n >= 7 && n < 15) {
            var result = [
              "I learn two additional Exploits of my choice from any class",
              "If it has a level prerequisite, I use my Fighter level",
            ];
          }

          if (n >= 15 && n < 18) {
            var result = [
              "I learn three additional Exploits of my choice from any class",
              "If it has a level prerequisite, I use my Fighter level",
            ];
          }

          if (n >= 18) {
            var result = [
              "I learn four additional Exploits of my choice from any class",
              "If it has a level prerequisite, I use my Fighter level",
            ];
          }

          return desc(result);
        }),

        // Exploit choice menu
        extraname: "Master of Forms Exploits",
        extrachoices: [],
        extraTimes: levels.map(function (n) {
          return n < 7 ? 0 : n < 15 ? 2 : n < 18 ? 3 : 4;
        }),
        toNotesPage: [
          {
            name: "Master of Forms Exploits",
            note: desc([
              "Below are my Master of Forms exploits. Each 3rd and 4th degree exploits can only be used once per short rest. Each 5th degree exploit can only be used once per long rest.",
            ]),
          },
        ],

        // Eval
        eval: CreateMartialSpellsheet,
      };

      // Make a filtered spell list that contains only exploits
      const FighterSpells = Object.keys(SpellsList).filter(
        (key) => SpellsList[key].isExploit
      );

      //const DegreeToMinLevel = [0,0,5,9,13,17]
      // Iterate over all Fighter(laserllama) "spells"
      for (var i = 0; i < FighterSpells.length; i++) {
        var NewSpell = SpellsList[FighterSpells[i]];

        MartialExploits.extrachoices.push(NewSpell.name); // Add "spell" name to menu options

        MartialExploits[FighterSpells[i]] = {
          // Add "spell" to the main item (when it is picked through the menu)
          name: NewSpell.name,
          toNotesPage: [
            {
              // What is added to the notes page
              name:
                NewSpell.name +
                " Exploit [" +
                (NewSpell.level == 1
                  ? "1st"
                  : NewSpell.level == 2
                    ? "2nd"
                    : NewSpell.level == 3
                      ? "3rd"
                      : NewSpell.level + "th") +
                " degree]",
              note: desc(NewSpell.descriptionFull),
              amendTo: "Master of Forms Exploits",
            },
          ],
          source: NewSpell.source,
          addMod: NewSpell.addMod,
          submenu: NewSpell.submenu,
          prereqeval: ExploitPrereqFactory(
            FighterSpells[i],
            "fighter(laserllama)"
          ),
          eval: MartialExploits.eval, // in case the user removes all exploits
          spellcastingBonusElsewhere: {
            addTo: "martial exploits",
            spellcastingBonus: {
              name: "Master of Forms Exploits",
              spellcastingAbility: 1,
              spells: [FighterSpells[i]],
              selection: [FighterSpells[i]],
            },
          },
        };
      }

      return MartialExploits;
    })(),

    subclassfeature10: {
      name: "Masterful Focus",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "Whenever I use action surge or second wind, I regain an expended exploit die",
      ]),
    },

    subclassfeature15: {
      name: "Warrior Savant",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "During each long or short rest I can practice to replace one combat exploit with a combat exploit I meet the prequisites for.",
      ]),
    },

    subclassfeature18: {
      name: "Legendary Superiority",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc([
        "As long I am not incapacitated, I regain an expended exploit die at the start of each of my turns in combat",
      ]),
    },
  },
});

// Mystic (psi warrior)
AddSubClass("fighter(laserllama)", "mystic", {
  regExpSearch: /^(?=.*mystic).*$/i,
  subname: "Mystic Fighter",
  fullname: "Mystic",
  source: [["GMB:LL", 0]],
  abilitySave: 4,
  spellcastingFactor: 3, // Mystic is a 3rd caster but uses psi points instead of spell slots
  // Unfortunately there's no way around this, because if (spellcastingfactor > level || spell slots == 0), it won't let the player pick spells
  spellcastingList: {
    spells: MysticList,
  },
  spellcastingKnown: {
    spells: [0, 0, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9, 10, 10],
  },
  features: {
    subclassfeature3: {
      name: "Psionics",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc(
        "I can cast known Psion spells, using Intelligence as my spellcasting ability (see 3rd page)"
      ),
      limfeaname: "Psi points",
      usages: [0, 0, 2, 3, 3, 4, 4, 4, 5, 5, 5, 6, 6, 6, 7, 7, 7, 7, 8, 8],
      recovery: "short rest",
      eval: function () {
        AddString("Extra.Notes", "Psi point features:");
        show3rdPageNotes();
      },
      removeeval: function () {
        AddString("Extra.Notes", "Psi point features:");
      },
      spellcasting: {
        name: "Spellcasting",
        extraname: "Mystic 3",
        source: [["GMB:LL", 0]],
        description: levels.map(function (n) {
          var mentalLimit =
            n < 7 ? "1st" : n < 13 ? "2nd" : n < 19 ? "3rd" : "4th";

          return desc([
            "I can cast known Psion spells, using Intelligence as my spellcasting ability",
            "To manifest a spell, I expend Psi Points equal to the spell's level (0 for cantrips)",
            "My mind is my spell focus but I must have a hand free if the spell has a S or M component",
            "I cannot cast or learn spells of a level above my mental limit (" +
            mentalLimit +
            " level)",
            "I can replace any spell I know with another when I gain a Fighter level",
          ]);
        }),
      },
      "inscrutable mind": {
        name: "Inscrutable Mind",
        extraname: "Mystic 10",
        source: [["GMB:LL", 0]],
        description: levels.map(function (n) {
          return desc([
            "Whenever I succeed on an Int, Wis, or Cha save, I can spend 1 Psi Point to force the attacker to succeed an Int save or take " +
            n +
            " psychic dmg",
          ]);
        }),
        additional: "1 Psi Point",
      },
      "mental ward": {
        name: "Mental Ward",
        extraname: "Mystic 15",
        source: [["GMB:LL", 0]],
        description: desc([
          "As a bonus action, project a Mental Ward around me for a 30-foot radius for 1 minute",
          "Me, and creatures of my choice within range gain resistance to psychic damage and can add my Int mod (min of +1) to any Int, Wis, and Cha saving throws that we make",
        ]),
        additional: "5 Psi Points",
        action: ["bonus action", ""],
      },
      autoSelectExtrachoices: [
        {
          extrachoice: "spellcasting",
          minlevel: 3,
        },
        {
          extrachoice: "inscrutable mind",
          minlevel: 10,
        },
        {
          extrachoice: "psionic ward",
          minlevel: 15,
        },
      ],
    },

    "subclassfeature3.1": (function () {
      const MysticTalentsPsiWarrior = {
        name: "Mystic Talents",
        source: [["GMB:LL", 0]],
        minlevel: 2,
        description:
          "\n   " +
          "I can manifest unique powers called Mystic Talents. Whenever I gain a Psion Level i can replace a Mystic Talent I know with a new Mystic Talent as long I meet the prerequisites. I cannot replace a Talent if it is the prerequisite for another Talent.",
        additional: [
          "0 Talents",
          "2 Talents",
          "3 Talents",
          "3 Talents",
          "4 Talents",
          "4 Talents",
          "5 Talents",
          "5 Talents",
          "6 Talents",
          "6 Talents",
          "7 Talents",
          "7 Talents",
          "8 Talents",
          "8 Talents",
          "8 Talents",
          "9 Talents",
          "9 Talents",
          "9 Talents",
          "10 Talents",
          "10 Talents",
        ], //optional; text to display in the header of the feature. This can be one value, but can also be an array of 20 values, one for each level.
        extraname: "Mystic Talents",
        extrachoices: [
        ],
        extraTimes: levels.map(function (n) {
          return n < 3
            ? 0
            : n < 7
              ? 2
              : n < 15
                ? 3
                : n < 18
                  ? 4
                  : 5;
        }),
      };
      var MysticKeys = Object.keys(MysticTalentsLL);
      for (var m = 0; m < MysticKeys.length; m++) {
        MysticTalentsPsiWarrior.extrachoices.push(MysticTalentsLL[MysticKeys[m]].name);
        var NewPsiwarTalent = MysticTalentsLL[MysticKeys[m]];
        const tlvl = NewPsiwarTalent.talentLevel ? NewPsiwarTalent.talentLevel : 3;
        var npt = {
          name: NewPsiwarTalent.name,
          description: NewPsiwarTalent.description,
          source: NewPsiwarTalent.source,
          addMod: NewPsiwarTalent.addMod,
          armorOptions: NewPsiwarTalent.armorOptions,
          armorAdd: NewPsiwarTalent.armorAdd,
          speed: NewPsiwarTalent.speed,
          toolProfs: NewPsiwarTalent.toolProfs,
          action: NewPsiwarTalent.action,
          extraLimitedFeatures: NewPsiwarTalent.extraLimitedFeatures,
          usages: NewPsiwarTalent.usages,
          recovery: NewPsiwarTalent.recovery,
          savetxt: NewPsiwarTalent.savetxt,
          dmgres: NewPsiwarTalent.dmgres,
          armorProfs: NewPsiwarTalent.armorProfs,
          submenu: NewPsiwarTalent.submenu,
          extraname: NewPsiwarTalent.extraname,
          extraTimes: NewPsiwarTalent.extraTimes,
          choices: NewPsiwarTalent.choices,
          vision: NewPsiwarTalent.vision,
          spellcastingBonus: NewPsiwarTalent.spellcastingBonus,
          spellChanges: NewPsiwarTalent.spellChanges,
          prereqeval: MysticTalentsPrereqFactory(MysticKeys[m], "fighter(laserllama)", 3),
          submenu: "Mystic lvl " + tlvl + "+"
        }
        if (MysticKeys[m] == 'restoration i') {
          npt.extraLimitedFeatures[0].usages = "Mystic level × 5";
          npt.extraLimitedFeatures[0].usagescalc = "event.value = (classes.known['fighter(laserllama)'] ? classes.known['fighter(laserllama)'].level : 0) * 5;";
        }

        MysticTalentsPsiWarrior[MysticKeys[m]] = npt;
      }

      return MysticTalentsPsiWarrior;
    })(),
    subclassfeature7: {
      name: "Phase Step",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: levels.map(function (n) {
        var result = [
          "When I use Second Wind, until the end of my current turn, I also gain the benefits of Dash action an I can move through solid nonmag objects and crea as if they were difficult terrain",
          "If I end my movement inside an object or creature, I am instantly shunted to the nearest unoccupied space, taking 1d10 force damage for every 5 feet I am forced to move",
        ];
        if (n >= 18)
          result[0] =
            "When I use Second Wind, until the end of my current turn, I gain a fly speed equal to my walk speed and can move through solid nonmag objects and crea as if they were difficult terrain";
        return desc(result);
      }),
    },
    subclassfeature10: {
      name: "Inscrutable Mind",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "I have resistance to psychic damage and whenever I make an Int, Wis or Cha saving throw I add my Exploit Die to the save",
      ]),
      savetxt: {
        text: ["I add my Exploit Die to Int, Wis and Cha saving throws"],
      },
      dmgres: ["Psychic"],
    },
    subclassfeature15: {
      name: "Mental Ward",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc(["Added to my Psi Points features (see 3rd page)"]),
    },
    subclassfeature18: {
      name: "Legendary Mystic",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc([
        "I learn the telekinesis spell, but it does not count against my total",
        "I can manifest this spell once per long rest or spend 5 Psi points to use it again",
      ]),
      spellcastingBonus: {
        name: "Legendary Mystic",
        spells: ["telekinesis"],
        selection: ["telekinesis"],
        firstCol: "oncelr",
      },
      spellChanges: {
        telekinesis: {
          components: "",
          changes:
            "Using Legendary Mystic, I can cast Telekinesis without requiring components and without spell slots",
        },
      },
      usages: 1,
      recovery: "long rest",
    },
  },
});

// Ronin (samurai)
AddSubClass("fighter(laserllama)", "ronin", {
  regExpSearch: /ronin/i,
  subname: "Ronin",
  fullname: "Ronin",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: GetFighterSubclassExploits("Ronin", [
      "commanding presence",
      "ruthless strike",
      "heroic will",
      "honor duel",
      "heroic focus",
    ]),
    "subclassfeature3.1": {
      name: "Exiled Courtier",
      languageProfs: [1],
      source: [["GMB:LL", 0]],
      minlevel: 3,
      skillstxt:
        "Choose one from: History, Insight, Performance, or Persuasion",
      description: levels.map(function (n) {
        if (n < 7)
          return desc([
            "I learn to speak, read, and write one additional language of my choice and gain proficiency in either History, Insight, Performance, or Persuasion.",
          ]);
        return desc([
          "I learn to speak, read, and write one additional language of my choice and gain proficiency in either History, Insight, Performance, or Persuasion.",
          "I also gain a bonus of my Exploit Die to any roll made with that skill.",
        ]);
      }),
    },
    "subclassfeature3.2": {
      name: "Unyielding Spirit",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "As a bonus action, I gain adv. on my attacks and ignore any exhaustion level for this turn",
        "I also gain temporary HP equal to my fighter level",
        "I can use this once per short rest or gain an exhaustion level to use it again",
      ]),
      recovery: levels.map(function (n) {
        return n < 10 ? "short rest" : "Init";
      }),
      additional: levels.map(function (n) {
        return n < 3 ? "" : n + " temp HP";
      }),
      usages: 1,
      action: ["bonus action", ""],
    },
    subclassfeature7: {
      name: "Lordly Bearing",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "Exiled Courtier Improved",
        "I gain proficiency with Wis saves, or if I'm already proficient, either Int or Cha saves",
      ]),
      saves: ["Wis"],
    },
    subclassfeature10: {
      name: "Unrelenting",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "I regain one use of Unyielding Spirit if I have no more remaining when I roll initiative",
        "Any short rest, my current level of exhaustion, if any, is reduced by 1",
      ]),
    },
    subclassfeature15: {
      name: "Swift Strikes",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "With the Attack action, I can forgo advantage on one attack to make one extra attack",
        "This extra attack is part of the same action; I can do this only once per turn",
      ]),
    },
    subclassfeature18: {
      name: "Legendary Ronin",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc([
        "If I'm reduced to 0 HP, I can delay falling unconscious, immediately taking a bonus turn",
        "While I'm at 0 HP, I suffer damage normally and die if I have 3 failed death saves",
        "If I'm still at 0 HP at the end of this bonus turn, I fall unconscious",
        "If I have no uses remaining, I can expend a use of Action Surge instead",
      ]),
      recovery: "long rest",
      usages: 1,
    },
  },
});

// Knight Errant (cavalier)
AddSubClass("fighter(laserllama)", "knight errant", {
  regExpSearch: /^(?=.*knight)(?=.*errant)(?!.*arcane).*$/i,
  subname: "Knight Errant",
  fullname: "Knight Errant",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: GetFighterSubclassExploits("Knight Errant", [
      "shield impact",
      "skilled rider",
      "defensive stance",
      "honor duel",
      "mythic resilience",
    ]),
    "subclassfeature3.1": {
      name: "Courtly Pedigree",
      languageProfs: [1],
      source: [["GMB:LL", 0]],
      minlevel: 3,
      skillstxt:
        "Choose one from: Animal Handling, History, Insight, Performance, or Persuasion",
      description: desc([
        "I learn to speak, read, and write one additional language of my choice and gain proficiency in either Animal Handling, History, Insight, Performance, or Persuasion.",
      ]),
    },
    "subclassfeature3.2": {
      name: "Chivalric Mark",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map(function (n) {
        if (n < 10)
          return desc([
            "Once per turn, on hit with a melee weapon attack, I can mark the creature until the end of my next turn",
            "While it is within 10 ft of me, a marked target has disadv. on attacks not directed at me",
            "If it damages anybody but me, I can make a special melee attack vs. it with my reaction",
          ]);
        return desc([
          "On hit with a melee weapon attack, I can mark the creature until the end of my next turn",
          "While it is within 30 ft of me, a marked target has disadv. on attacks not directed at me",
          "If it damages anybody but me, I can make a special melee attack vs. it with my reaction if it is in my reach",
        ]);
      }),
      action: ["reaction", ""],
    },
    "subclassfreature3.3": {
      name: "Trained Knight",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I cannot be knocked from a mount against my will and mounting/dismounting only takes me 5 ft of movement",
      ]),
    },
    subclassfeature7: {
      name: "Noble Guardian",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "As a reaction, I can add my Exploit Die to AC against an attack made vs. me or someone within 5 ft of me. I need to be wielding a shield or a melee weapon to do this.",
        "If the attack still hits, I can expend an Exploit Die to grant the target resistance to the attack",
      ]),
      action: ["reaction", ""],
    },
    subclassfeature10: {
      name: "Unyielding Knight",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "The Chivalric Mark is improved (see Chivalric Mark)",
      ]),
    },
    subclassfeature15: {
      name: "Perilous Charge",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "If I hit a creature after moving 10 ft in a line, it must make a Str save, disadv if I am mounted",
        "If failed, the target is knocked prone and take bonus damage equal to my Exploit Die; I can do this only once per turn",
      ]),
    },
    subclassfeature18: {
      name: "Legendary Knight Errant",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc([
        "I can gain a special reaction but only for opportunity attacks against creatures under Chivalric Mark or to use Noble Guardian",
      ]),
    },
  },
});

// Runecarver (rune knight) <-- controllare le rune
AddSubClass("fighter(laserllama)", "runecarver", {
  regExpSearch: /^(?=.*rune)(?=.*carver).*$/i,
  subname: "Runecarver",
  fullname: "Runecarver",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: {
      name: "Rune Carver",
      languageProfs: [1],
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc(
        "I gain proficiency with calligrapher's supplies and I learn to speak, read, and write Giant"
      ),
      toolProfs: ["Calligrapher's Supplies"],
      languageProfs: ["Giant"],
    },
    "subclassfeature3.1": {
      name: "Rune Carving",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I learn how to use magic runes to enhance my gear that I can wear or hold in my hand",
        "When I finish a short/long rest, I can inscribe each rune I know upon a different item I touch",
        "Each rune can only be on one item at a time, and recharge after a short/long rest",
        "Whenever I gain a fighter level, I can swap a rune I know for another",
        "Only me can trigger runes; The DC for a rune's abilities is my Exploit Die DC",
      ]),
      toNotesPage: [
        {
          name: "Runecarver Exploits",
          note: desc([
            "Below are my Runecarver exploits. They can all be used at will.",
          ]),
        },
      ],
      additional: levels.map(function (n) {
        return n < 3
          ? ""
          : (n < 7 ? 2 : n < 10 ? 3 : n < 15 ? 4 : n < 18 ? 5 : 6) +
          " runes known";
      }),
      extraTimes: levels.map(function (n) {
        return n < 3 ? 0 : n < 7 ? 2 : n < 10 ? 3 : n < 15 ? 4 : n < 18 ? 5 : 6;
      }),
      extraname: "Known runes",
      extrachoices: [
        "Cloud Rune",
        "Fire Rune",
        "Frost Rune",
        "Stone Rune",
        "Hill Rune (prereq: level 7 fighter)",
        "Storm Rune (prereq: level 7 fighter)",
      ],
      "cloud rune": {
        name: "Cloud Rune",
        source: [["GMB:LL", 0]],
        description: desc([
          "I learn the Subtle Con exploit and can use it at will",
          "As a reaction when I or another I can see within 30 ft is hit by an attack, I can invoke this",
          "I select another target for the attack within 30 ft of me, using the same roll (within range)",
        ]),
        eval: CreateMartialSpellsheet,
        spellcastingBonusElsewhere: {
          addTo: "martial exploits",
          spellcastingBonus: [
            {
              // What is added to the spellcasting sheet
              name: "Cloud Rune Exploit",
              spellcastingAbility: 1,
              spells: ["subtle con"],
              selection: ["subtle con"],
              firstCol: "atwill",
            },
          ],
        },
        toNotesPage: [
          {
            // What is added to the notes page
            name: SpellsList["subtle con"].name,
            note: desc(SpellsList["subtle con"].descriptionFull),
            amendTo: "Runecarver Exploits",
          },
        ],
        action: [["reaction", " (invoke)"]],
        additional: "invoke",
        usages: 1,
        recovery: "short rest",
      },
      "fire rune": {
        name: "Fire Rune",
        source: [["GMB:LL", 0]],
        description: desc([
          "I learn the Commanding Presence exploit and can use it at will",
          "When I hit a creature with a melee weapon attack, I can invoke it to summon molten restraints",
          "The target takes 2 Exploit Die of fire dmg and must make a Str save or be restrained for 1 min",
          "While restrained, It takes 2 Exploit Die of fire dmg at the start of each of its turns",
          "The restrained creature can use an action to repeat the Str save ending the effect on a success",
        ]),
        eval: CreateMartialSpellsheet,
        spellcastingBonusElsewhere: {
          addTo: "martial exploits",
          spellcastingBonus: [
            {
              // What is added to the spellcasting sheet
              name: "Fire Rune Exploit",
              spellcastingAbility: 1,
              spells: ["commanding presence"],
              selection: ["commanding presence"],
              firstCol: "atwill",
            },
          ],
        },
        toNotesPage: [
          {
            // What is added to the notes page
            name: SpellsList["commanding presence"].name,
            note: desc(SpellsList["commanding presence"].descriptionFull),
            amendTo: "Runecarver Exploits",
          },
        ],
        additional: "invoke",
        usages: 1,
        recovery: "short rest",
      },
      "frost rune": {
        name: "Frost Rune",
        source: [["GMB:LL", 0]],
        description: desc([
          "I learn the Cunning Instinct exploit and can use it at will",
          "As a bonus action, I can invoke this to increas my speed by 10 feet and add my Exploit Die on Str and Con checks and saves for 10 min",
        ]),
        eval: CreateMartialSpellsheet,
        spellcastingBonusElsewhere: {
          addTo: "martial exploits",
          spellcastingBonus: [
            {
              // What is added to the spellcasting sheet
              name: "Frost Rune Exploit",
              spellcastingAbility: 1,
              spells: ["cunning instinct"],
              selection: ["cunning instinct"],
              firstCol: "atwill",
            },
          ],
        },
        toNotesPage: [
          {
            // What is added to the notes page
            name: SpellsList["cunning instinct"].name,
            note: desc(SpellsList["cunning instinct"].descriptionFull),
            amendTo: "Runecarver Exploits",
          },
        ],
        addMod: SpellsList["cunning instinct"].addMod,
        action: [["bonus action", " (invoke)"]],
        additional: "invoke",
        usages: 1,
        recovery: "short rest",
      },
      "stone rune": {
        name: "Stone Rune",
        source: [["GMB:LL", 0]],
        description: desc([
          "I learn the Inquisitive Eye exploit and can use it at will",
          "As a reaction when a creature I can see ends it turn within 30 ft, I can invoke this rune",
          "This causes the creature to make a Wisdom save or be affected by the rune for 1 minute",
          "While affected, it descends into a dreamy stupor, becoming incapacitated and has speed 0",
          "It can repeat the save at the end of each of its turns, ending the effect on a success",
        ]),
        eval: CreateMartialSpellsheet,
        spellcastingBonusElsewhere: {
          addTo: "martial exploits",
          spellcastingBonus: [
            {
              // What is added to the spellcasting sheet
              name: "Stone Rune Exploit",
              spellcastingAbility: 1,
              spells: ["inquisitive eye"],
              selection: ["inquisitive eye"],
              firstCol: "atwill",
            },
          ],
        },
        toNotesPage: [
          {
            // What is added to the notes page
            name: SpellsList["inquisitive eye"].name,
            note: desc(SpellsList["inquisitive eye"].descriptionFull),
            amendTo: "Runecarver Exploits",
          },
        ],
        action: [["reaction", " (invoke)"]],
        additional: "invoke",
        usages: 1,
        recovery: "short rest",
      },
      "hill rune (prereq: level 7 fighter)": {
        name: "Hill Rune",
        source: [["GMB:LL", 0]],
        description: desc([
          "I learn the Hurl and Mighty Thrust exploits and can use them at will",
          "As a bonus action, I can invoke it to gain resistance to bludg/slash/pierc damage for 1 min",
          "When I use Runic Might, I can invoke this Rune as part of that same bonus action",
        ]),
        eval: CreateMartialSpellsheet,
        spellcastingBonusElsewhere: {
          addTo: "martial exploits",
          spellcastingBonus: [
            {
              // What is added to the spellcasting sheet
              name: "Hill Rune Exploit",
              spellcastingAbility: 1,
              spells: ["hurl", "mighty thrust"],
              selection: ["hurl", "mighty thrust"],
              firstCol: "atwill",
            },
          ],
        },
        toNotesPage: [
          {
            // What is added to the notes page
            name: SpellsList["hurl"].name,
            note: desc(SpellsList["hurl"].descriptionFull),
            amendTo: "Runecarver Exploits",
          },
          {
            // What is added to the notes page
            name: SpellsList["mighty thrust"].name,
            note: desc(SpellsList["mighty thrust"].descriptionFull),
            amendTo: "Runecarver Exploits",
          },
        ],
        prereqeval: function (v) {
          return classes.known["fighter(laserllama)"].level >= 7;
        },
        action: [["bonus action", " (invoke)"]],
        additional: "invoke",
        usages: 1,
        recovery: "short rest",
      },
      "storm rune (prereq: level 7 fighter)": {
        name: "Storm Rune",
        source: [["T", 45]],
        description: desc([
          "I learn the Mighty Leap and Scholarly Recall exploit and can use it at will",
          "As a bonus action, I can invoke it to enter a prophetic state for 1 min",
          "While in this state, I can use a reaction to add or substract a roll of my Exploit Die from a roll",
          "I can do this for attacks, saves, and checks of myself or others I can see within 60 ft of me",
          "This state requires my conc. as on a spell",
        ]),
        eval: CreateMartialSpellsheet,
        spellcastingBonusElsewhere: {
          addTo: "martial exploits",
          spellcastingBonus: [
            {
              // What is added to the spellcasting sheet
              name: "Storm Rune Exploit",
              spellcastingAbility: 1,
              spells: ["mighty leap", "scholarly recall"],
              selection: ["mighty leap", "scholarly recall"],
              firstCol: "atwill",
            },
          ],
        },
        toNotesPage: [
          {
            // What is added to the notes page
            name: SpellsList["mighty leap"].name,
            note: desc(SpellsList["mighty leap"].descriptionFull),
            amendTo: "Runecarver Exploits",
          },
          {
            // What is added to the notes page
            name: SpellsList["scholarly recall"].name,
            note: desc(SpellsList["scholarly recall"].descriptionFull),
            amendTo: "Runecarver Exploits",
          },
        ],
        prereqeval: function (v) {
          return classes.known["fighter(laserllama)"].level >= 7;
        },
        action: [["bonus action", " (invoke)"]],
        additional: "invoke",
        usages: 1,
        recovery: "short rest",
      },
    },
    "subclassfeature3.2": {
      name: "Runic Might",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "As a bonus action, I can imbue myself with runic magic for 1 minute and gain benefits:",
        " \u2022 Space permitted, I grow to a larger size category along with everything I'm wearing",
        " \u2022 Once per turn, I can add an Exploit Die for a Str check, save or dmg of Str-based attack",
        " \u2022 I have adv on Str check and saves",
      ]),
      additional: levels.map(function (n) {
        return n < 3
          ? ""
          : (n < 18 ? "Large" : "Huge") +
          ", +1d" +
          (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12) +
          " bonus";
      }),
      action: [["bonus action", ""]],
      usages: "Con mod per ",
      usagescalc: "event.value = Math.max(1, What('Con Mod'));",
      recovery: "long rest",
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (
              classes.known["fighter(laserllama)"] &&
              classes.known["fighter(laserllama)"].level >= 3 &&
              v.isWeapon &&
              /giant('s)? might/i.test(v.WeaponTextName)
            ) {
              n = classes.known["fighter(laserllama)"].level;
              var GMdmgDie =
                n < 5 ? "d6" : n < 11 ? "d8" : n < 17 ? "d10" : "d12";

              var dmgDieRx = RegExp("(\\d+)" + GMdmgDie, "i");
              if (dmgDieRx.test(fields.Damage_Die)) {
                var dmgDieMatch = fields.Damage_Die.match(dmgDieRx);
                fields.Damage_Die = fields.Damage_Die.replace(
                  dmgDieRx,
                  Number(dmgDieMatch[1]) + 1 + GMdmgDie
                );
                fields.Description = fields.Description.replace(
                  /Versatile \((\d+d\d+)\)/i,
                  "Versatile ($1+1" + GMdmgDie + ")"
                );
              } else if (!isNaN(fields.Damage_Die)) {
                fields.Damage_Die = 1 + GMdmgDie + "+" + fields.Damage_Die;
              } else {
                fields.Description +=
                  (fields.Description ? "; " : "") +
                  "+1" +
                  GMdmgDie +
                  " damage";
              }
              if (
                classes.known["fighter(laserllama)"].level >= 18 &&
                v.isMeleeWeapon
              )
                fields.Description +=
                  (fields.Description ? "; " : "") + "+5 ft reach";
            }
          },
          'If I include the words "Giant Might" in the name of a weapon or unarmed strike, it gets treated as a weapon that I use while imbued by my Giant\'s Might feature. It adds my Exploit Die to damage and if I am above lvl 18, my reach increases by 5 ft (for melee weapons).',
          8,
        ],
      },
    },
    subclassfeature7: {
      name: "Runic Ward",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "As a reaction when I see a creature within 30 ft get hit by an attack, I can protect it",
        "I add my Constitution modifier (min of +1) to the target's AC against that attack",
        "I can use it equal to my Con mod (min 1) per long rest, no use left I can invoke a rune to use it again",
      ]),
      action: [["reaction", ""]],
      usages: "Con mod per ",
      usagescalc: "event.value = Math.max(1, What('Con Mod'));",
      recovery: "long rest",
    },
    subclassfeature10: {
      name: "Unyielding",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "Adv. on saves vs moved against my will, knocked prone, poisoned, or stunned",
      ]),
      savetxt: {
        text: [
          "Adv. on saves vs moved against my will, knocked prone, poisoned, or stunned",
        ],
      },
    },
    subclassfeature15: {
      name: "Elder Insight",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "When I have no uses of a Rune remaining, I can expend one Exploit Die to invoke that Rune",
        "I can invoke a rune this way only once per short or long rest for each rune",
      ]),
    },
    subclassfeature18: {
      name: "Legendary Rune Carver",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc([
        "When I use Runic Might, I can become Huge, so long as there is room for me to grow",
        "While Huge, my reach increases by 5 feet",
      ]),
    },
  },
});

// Shadow dancer (echo knight)
AddSubClass("fighter(laserllama)", "shadowdancer", {
  regExpSearch: /^(?=.*shadow)(?=.*dancer).*$/i,
  subname: "Shadowdancer",
  fullname: "Shadowdancer",
  source: [["GMB:LL", 0]],
  features: {
    subclassfeature3: GetFighterSubclassExploits("Shadowdancer", [
      "feint",
      "lightstep",
      "crippling strike",
      "whirlwind strike",
      "disorienting blow",
    ]),
    "subclassfeature3.1": {
      name: "Conjure Shade",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "As a bonus action, I can magically manifest a translucent image of myself within 15 ft",
        "My shade lasts until I dismiss it as a bonus action, I manifest another, or I'm incapacitated",
        "It is also destroyed if it is more than 30 ft away from me at the end of my turn",
        "It has 1 HP, immunity to all conditions, uses my save bonuses, it is my size and AC 14 + Cha modifier",
        "On my turn as a free action, I can command it to move up to 30 ft in any direction",
        "When I use the Attack action on my turn, I can have any attack originate from my shade",
        "I can also make opportunity attacks from the shade's location as if I were in its space",
      ]),
      action: [["bonus action", " (summon/dismiss)"]],
      creaturesAdd: [["Shade"]],
      creatureOptions: [
        {
          name: "Shade",
          source: [["W", 183]],
          size: 3,
          type: "Undead",
          alignment: "",
          ac: "14+oCha",
          hp: 1,
          hd: [],
          speed: "30 ft",
          scores: ["", "", "", "", "", ""],
          savesLinked: true,
          condition_immunities: "all conditions",
          passivePerception: 0,
          senses: "",
          languages:
            "Understands all the languages you know, but it cannot speak",
          challengeRating: "0",
          proficiencyBonus: 0,
          attacksAction: 0,
          attacks: [],
          features: [
            {
              name: "Dark Bond",
              description:
                "If the Shade is forced to make a saving throw, it uses my saving throw bonus for the roll",
            },
            {
              name: "Incorporeal Echo",
              description:
                "The Shade has no physical presence and counts as difficult terrain for creatures that move through its space. It cannot hold or interact with any objects, nor can it attune to or use any magic items.",
            },
            {
              name: "Umbral Sentinel",
              description:
                "If a creature provokes an opportunity attack from the Shade, you can use your reaction to make an opportunity attack from the Shade's space.",
            },
          ],
          traits: [
            {
              name: "Swap Place",
              description:
                "The shade's creator can, as a bonus action, teleport, magically swapping places with the shade, if it is within 30 feet.",
            },
            {
              name: "Umbral Guardian",
              description:
                "When the shade's creator takes the Attack action on their turn, any attack they make with that action can originate from the echo's space. This choice is made for each attack separately.\n   In addition, when a creature would provoke an opportunity attack from the shade, its creator can use their reaction to make an opportunity attack against that creature as if its creator was in the shade's space.",
            },
          ],
          notes: [
            {
              name: "The shade is a magical, translucent, gray image of its creator that shares its creator's turn in",
              description: "combat, but it cannot act on its own.",
              joinString: " ",
            },
            {
              name: "It lasts until it is destroyed, dismissed or another is",
              description: "manifested.",
              joinString: " ",
            },
            {
              name: "The shade is also destroyed if it is ever more than 30 ft away from its creator at the end of its creator's",
              description: "turn.",
              joinString: " ",
            },
          ],
          header: "Shade",
          eval: function (prefix, lvl) {
            // Same size as character
            PickDropdown(
              prefix + "Comp.Desc.Size",
              tDoc.getField("Size Category").currentValueIndices
            );
            Value(prefix + "Comp.Desc.Age", What("Age"));
            Value(prefix + "Comp.Desc.Sex", What("Sex"));
            Value(prefix + "Comp.Desc.Height", What("Height"));
            Value(prefix + "Comp.Desc.Alignment", What("Alignment"));
          },
        },
      ],
    },
    "subclassfeature3.2": {
      name: "Dance of Shadows",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "As an action, if my Shade is within 30 ft of me, I can teleport to swap places with it without provoking opportunity attacks",
      ]),
      action: ["action", "Swap Location with Shade"],
    },
    subclassfeature7: {
      name: "Shade Strike",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "When using Dance of Shadows, I can make a melee attack from my or my shade's position",
      ]),
    },
    "subclassfeature7.1": {
      name: "Transfer Consciousness",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "As an action, I can expend my Second Wind to temporarily transfer my consciousness to my shade for up to 10 min",
        "During this time, I see and hear through its eyes and ears, but my body is unconscious",
        "While I use my shade this way, it can be up to 1 mile away from me without issue",
        "It ends early if my Shade is destroyed. or I use my Action to end it, I then return to my body as normal",
      ]),
      action: [
        ["action", " (start)"],
        ["action", " (end)"],
      ],
    },
    subclassfeature10: {
      name: "Dark Sacrifice",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: levels.map(function (n) {
        return desc([
          "As a reaction when a creature within 10 ft of my shade is hit, I can make my shade the target",
          "The damage that the target would take is reduced by " +
          n +
          ", destroing my shade in the process",
        ]);
      }),
      action: [["reaction", ""]],
    },
    subclassfeature15: {
      name: "Restorative Shadows",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "When my shade is destroyed by taking damage, I can gain temporary hit points equal to twice my Exploit Die",
      ]),
    },
    "subclassfeature15.1": {
      name: "Improved Swap",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "Now I can use Dance of Shadows to swap location with my Shade either with action or bonus action",
      ]),
      action: ["bonus action", "Swap Location with Shade"],
    },
    subclassfeature18: {
      name: "Legendary Shadowdancer",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc([
        "I can now manifest two shades instead of one with the same bonus action",
        "These two can coexist, but if I manifest a third, the previous two are destroyed",
        "Anything I can do from one shade's position can be done from the other's instead",
      ]),
    },
  },
});

// Sylvan archer (arcane archer)
AddSubClass("fighter(laserllama)", "sylvan archer", {
  regExpSearch: /^(?=.*sylvan)(?=.*archer).*$/i,
  subname: "Sylvan Archer",
  fullname: "Sylvan Archer",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: GetFighterSubclassExploits("Sylvan Archer", [
      "precision strike",
      "rustic intuition",
      "martial focus",
      "volley",
      "thunderous shot",
    ]),
    "subclassfeature3.1": {
      name: "Sylvan Lore",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I gain proficiency in Nature and can make Wis (Nature) checks instead of Int (Nature)",
        "I learn Sylvan and druidcraft, I can cast druidcraft with Wis and an ammunition as focus",
      ]),
      languageProfs: ["Sylvan"],
      skills: ["Nature"],
      addMod: {
        type: "skill",
        field: "Nature",
        mod: "max(Wis-Int|0)",
        text: "I can replace Intelligence (Nature) checks with Wisdom (Nature)",
      },
      spellcastingBonus: {
        name: "Sylvan Lore",
        spells: ["druidcraft"],
        selection: ["druidcraft"],
        firstCol: "atwill",
        spellcastingAbility: 5,
      },
      spellChanges: {
        druidcraft: {
          components: "V,S,M",
          compMaterial: "A piece of ammunition",
          changes:
            "With Sylvan Lore, I can cast druidcraft with my Wisdom and an ammunition as focus",
        },
      },
    },
    "subclassfeature3.2": {
      name: "Enchanted Shots",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I can unleash magical effects when I hit a creature from a ranged weapon",
        "I know a number of Enchanted Shot Options and learn additional at certain levels",
        "If I have no uses left, I can expend an Exploit Die to use it again",
        "The DC for my Enchanted Shots is my Exploit Die DC",
      ]),
      usages: "Wis mod per ",
      usagescalc: "event.value = Math.max(1, What('Wis Mod'));",
      altResource: "ED",
      recovery: "long rest",
      additional: levels.map(function (n) {
        return n < 3
          ? ""
          : (n < 7 ? 2 : n < 10 ? 3 : n < 15 ? 4 : n < 18 ? 5 : 6) +
          " options known";
      }),
      extraname: "Enchanted Shots Options",
      extrachoices: [
        "Beguiling Shot",
        "Bursting Shot",
        "Enfeebling Shot",
        "Grasping Shot",
        "Piercing Shot",
        "Seeking Shot",
        "Umbral Shot",
        "Banishing Shot",
        "Severing Shot",
        "Technical Shot",
        "Transposing Shot",
      ],
      extraTimes: levels.map(function (n) {
        return n < 3 ? 0 : n < 7 ? 2 : n < 10 ? 3 : n < 15 ? 4 : n < 18 ? 5 : 6;
      }),
      "beguiling shot": {
        name: "Beguiling Shot",
        source: [["GMB:LL", 0]],
        description: levels.map(function (n) {
          if (n < 3) return "";
          if (n < 7)
            return desc([
              "The target must succeed on a Wisdom save or takes psychic damage",
              "If failed, it is charmed by a creature of my choice",
              "This lasts until my next turn starts or anyone attacks or damages the target in any way",
            ]);
          return desc([
            "The target must succeed on a Wisdom save or takes psychic damage (half on success)",
            "If failed, it is charmed by a creature of my choice",
            "This lasts until my next turn starts or anyone attacks or damages the target in any way",
          ]);
        }),
        additional: levels.map(function (n) {
          const expldie = [
            "",
            "d6",
            "d6",
            "d6",
            "d8",
            "d8",
            "d8",
            "d8",
            "d8",
            "d8",
            "d10",
            "d10",
            "d10",
            "d10",
            "d10",
            "d10",
            "d12",
            "d12",
            "d12",
            "d12",
          ];
          if (n < 3) return "";
          if (n < 18) return "+2" + expldie[n] + " psychic damage";
          return "+2d12 psychic & +1d12 force dmg";
        }),
      },
      "bursting shot": {
        name: "Bursting Shot",
        source: [["GMB:LL", 0]],
        description: levels.map(function (n) {
          if (n < 3) return "";
          if (n < 7)
            return desc([
              "The creature and any other creature within 10 ft of it must succeed on a Dex saving throw",
              "If failed, they take (my choice) acid, cold, fire, lightning, poison, or thunder damage",
            ]);
          return desc([
            "The creature and any other creature within 10 ft of it must succeed on a Dex saving throw",
            "If failed, they take (my choice) acid, cold, fire, lightning, poison, or thunder damage (half on success)",
          ]);
        }),
        additional: levels.map(function (n) {
          const expldie = [
            "",
            "d6",
            "d6",
            "d6",
            "d8",
            "d8",
            "d8",
            "d8",
            "d8",
            "d8",
            "d10",
            "d10",
            "d10",
            "d10",
            "d10",
            "d10",
            "d12",
            "d12",
            "d12",
            "d12",
          ];
          if (n < 3) return "";
          if (n < 18) return "+2" + expldie[n] + " (my choice) damage";
          return "+2d12 (my choice) & +1d12 force dmg";
        }),
      },
      "enfeebling shot": {
        name: "Enfeebling Shot",
        source: [["GMB:LL", 0]],
        description: levels.map(function (n) {
          if (n < 3) return "";
          if (n < 7)
            return desc([
              "The target must succeed on a Constitution save or takes necrotic damage",
              "If failed, the damage of its weapon attacks is halved for 1 minute",
              "The creature can repeat this saving throw at the end of each of its turns, ending this effect on a success",
            ]);
          return desc([
            "The target must succeed on a Constitution save or takes necrotic damage (half on success)",
            "If failed, the damage of its weapon attacks is halved for 1 minute",
            "The creature can repeat this saving throw at the end of each of its turns, ending this effect on a success",
          ]);
        }),
        additional: levels.map(function (n) {
          const expldie = [
            "",
            "d6",
            "d6",
            "d6",
            "d8",
            "d8",
            "d8",
            "d8",
            "d8",
            "d8",
            "d10",
            "d10",
            "d10",
            "d10",
            "d10",
            "d10",
            "d12",
            "d12",
            "d12",
            "d12",
          ];
          if (n < 3) return "";
          if (n < 18) return "+2" + expldie[n] + " necrotic damage";
          return "+2d12 necrotic & +1d12 force dmg";
        }),
      },
      "grasping shot": {
        name: "Grasping Shot",
        source: [["GMB:LL", 0]],
        description: levels.map(function (n) {
          if (n < 3) return "";
          if (n < 7)
            return desc([
              "The target must succeed on a Dexterity save or takes piercing damage",
              "If failed, its speed is halved for 1 minute and it takes piercing dmg the first time it moves on each turn",
              "A creature can use its action to make a Strength check, removing the thorns on a success",
            ]);
          return desc([
            "The target must succeed on a Dexterity save or takes piercing damage (half on success)",
            "If failed, its speed is halved for 1 minute and it takes piercing dmg the first time it moves on each turn",
            "A creature can use its action to make a Strength check, removing the thorns on a success",
          ]);
        }),
        additional: levels.map(function (n) {
          const expldie = [
            "",
            "d6",
            "d6",
            "d6",
            "d8",
            "d8",
            "d8",
            "d8",
            "d8",
            "d8",
            "d10",
            "d10",
            "d10",
            "d10",
            "d10",
            "d10",
            "d12",
            "d12",
            "d12",
            "d12",
          ];
          if (n < 3) return "";
          if (n < 18) return "+2" + expldie[n] + " pierc damage";
          return "+2d12 pierc & +1d12 force dmg";
        }),
      },
      "piercing shot": {
        name: "Piercing Shot",
        source: [["GMB:LL", 0]],
        description: levels.map(function (n) {
          if (n < 3) return "";
          if (n < 7)
            return desc([
              "The creature and any creature directly behind it in a straight line out to 30 ft must Dex save",
              "If failed, they take force damage",
            ]);
          return desc([
            "The creature and any creature directly behind it in a straight line out to 30 ft must Dex save",
            "If failed, they take force damage (half on success)",
          ]);
        }),
        additional: levels.map(function (n) {
          const expldie = [
            "",
            "d6",
            "d6",
            "d6",
            "d8",
            "d8",
            "d8",
            "d8",
            "d8",
            "d8",
            "d10",
            "d10",
            "d10",
            "d10",
            "d10",
            "d10",
            "d12",
            "d12",
            "d12",
            "d12",
          ];
          if (n < 3) return "";
          if (n < 18) return "+2" + expldie[n] + " force damage";
          return "+3d12 force dmg";
        }),
      },
      "seeking shot": {
        name: "Seeking Shot",
        source: [["GMB:LL", 0]],
        description: levels.map(function (n) {
          if (n < 3) return "";
          if (n < 7)
            return desc([
              "I don't roll for the attack, but I choose a target I have seen in the last minute",
              "The seeking arrow moves around corners, obstacles, and ignores cover to hit the target if within 120 feet",
              "The target must succeed on a Dex saving throw or be hit if there is a path within range",
              "If failed, I learn its location and it takes force damage",
            ]);
          return desc([
            "I don't roll for the attack, but I choose a target I have seen in the last minute",
            "The seeking arrow moves around corners, obstacles, and ignores cover to hit the target if within 120 feet",
            "The target must succeed on a Dex saving throw or be hit if there is a path within range",
            "If failed, I learn its location and it takes force damage (half on success)",
          ]);
        }),
        additional: levels.map(function (n) {
          const expldie = [
            "",
            "d6",
            "d6",
            "d6",
            "d8",
            "d8",
            "d8",
            "d8",
            "d8",
            "d8",
            "d10",
            "d10",
            "d10",
            "d10",
            "d10",
            "d10",
            "d12",
            "d12",
            "d12",
            "d12",
          ];
          if (n < 3) return "";
          if (n < 18) return "+2" + expldie[n] + " force damage";
          return "+3d12 force dmg";
        }),
      },
      "umbral shot": {
        name: "Umbral Shot",
        source: [["GMB:LL", 0]],
        description: levels.map(function (n) {
          if (n < 3) return "";
          if (n < 7)
            return desc([
              "The target must succeed on an Intelligence save or takes psychic damage",
              "If failed, it is blinded for 1 minute",
              "The creature can repeat this save at the end of each of its turns, ending the effect on success",
            ]);
          return desc([
            "The target must succeed on an Intelligence save or takes psychic damage (half on success)",
            "If failed, it is blinded for 1 minute",
            "The creature can repeat this save at the end of each of its turns, ending the effect on success",
          ]);
        }),
        additional: levels.map(function (n) {
          const expldie = [
            "",
            "d6",
            "d6",
            "d6",
            "d8",
            "d8",
            "d8",
            "d8",
            "d8",
            "d8",
            "d10",
            "d10",
            "d10",
            "d10",
            "d10",
            "d10",
            "d12",
            "d12",
            "d12",
            "d12",
          ];
          if (n < 3) return "";
          if (n < 18) return "+2" + expldie[n] + " psychic damage";
          return "+2d12 psychic & +1d12 force dmg";
        }),
      },
      // 10th level prereq
      "banishing shot": {
        name: "Banishing Shot",
        source: [["GMB:LL", 0]],
        description: desc([
          "The target makes a Charisma save or is banished to a harmless demiplane for 1 minute",
          "On each of its turns while it is banished, the creature can use its action to repeat the saving throw, ending the effect on a success",
          "When it ends, it reappears in the space it was banished from, or the closest unoccupied space",
        ]),
        submenu: "[fighter level 10+]",
        prereqeval: function (v) {
          return classes.known["fighter(laserllama)"].level >= 10;
        },
        additional: levels.map(function (n) {
          return n < 18 ? "" : "+1d12 force damage";
        }),
      },
      "severing shot": {
        name: "Severing Shot",
        source: [["GMB:LL", 0]],
        description: desc([
          "The target makes a Constitution save or take force dmg (half on success) and be unable to cast spells",
          "The creature can repeat this save at the end of each turn, ending the effect on a success",
        ]),
        submenu: "[fighter level 10+]",
        prereqeval: function (v) {
          return classes.known["fighter(laserllama)"].level >= 10;
        },
        additional: levels.map(function (n) {
          const expldie = [
            "",
            "d6",
            "d6",
            "d6",
            "d8",
            "d8",
            "d8",
            "d8",
            "d8",
            "d8",
            "d10",
            "d10",
            "d10",
            "d10",
            "d10",
            "d10",
            "d12",
            "d12",
            "d12",
            "d12",
          ];
          if (n < 3) return "";
          if (n < 18) return "+2" + expldie[n] + " force damage";
          return "+3d12 force dmg";
        }),
      },
      "technical shot": {
        name: "Technical Shot",
        source: [["GMB:LL", 0]],
        description: desc([
          "The target makes a Dexterity save or suffer the effects of one Martial Exploit I know",
          "I can use this Enchanted Shot to deliver the effects of Exploits that normally require me to hit with a melee weapon attack",
        ]),
        submenu: "[fighter level 10+]",
        prereqeval: function (v) {
          return classes.known["fighter(laserllama)"].level >= 10;
        },
        additional: levels.map(function (n) {
          return n < 18 ? "" : "+1d12 force damage";
        }),
      },
      "transposing shot": {
        name: "Transposing Shot",
        source: [["GMB:LL", 0]],
        description: desc([
          "The target makes a Charisma save or takes force damage (half on success)",
          "If failed, it instantly switches places with me (no opportunity attacks with this movement)",
        ]),
        submenu: "[fighter level 10+]",
        prereqeval: function (v) {
          return classes.known["fighter(laserllama)"].level >= 10;
        },
        additional: levels.map(function (n) {
          const expldie = [
            "",
            "d6",
            "d6",
            "d6",
            "d8",
            "d8",
            "d8",
            "d8",
            "d8",
            "d8",
            "d10",
            "d10",
            "d10",
            "d10",
            "d10",
            "d10",
            "d12",
            "d12",
            "d12",
            "d12",
          ];
          if (n < 3) return "";
          if (n < 18) return "+2" + expldie[n] + " force damage";
          return "+3d12 force dmg";
        }),
      },
    },
    subclassfeature7: {
      name: "Sylvan Shot",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "My ranged weapon attacks count as magical",
        "Once per turn when I miss with a ranged weapon attack, I can use my bonus action to redirect it",
        "I reroll the attack against a different target within range of my weapon",
        "Creatures that succeeds save against my Enhanced Shots still takes half as damage",
      ]),
      action: ["bonus action", " (reroll attack)"],
    },
    subclassfeature15: {
      name: "Enchanted Quiver",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "Whenever I make a ranged attack I can conjure a magical ammunition as part of the attack",
        "After the attack, hit or miss, this ammunition vanishes",
        "Also, when I roll initiative, I regain one expended use of my Enchanted Shots",
      ]),
    },
    subclassfeature18: {
      name: "Legendary Sylvan Archer",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc([
        "Whenever I use an Enchanted Shot it deals additional force damage equal to my Exploit Die",
        "Also, when I use an Enchanted Shot I can empower it, causing creatures of my choice within 20 ft to suffer the effects of the Shot along with the target",
      ]),
      additional: "Empowered shot",
      recovery: "long rest",
      usages: 1,
    },
  },
});

// Subclasses from extended fighter
// Crusader
AddSubClass("fighter(laserllama)", "crusader", {
  regExpSearch: /crusader/i,
  subname: "Crusader",
  fullname: "Crusader",
  source: [["GMB:LL", 0]],
  features: {
    subclassfeature3: GetFighterSubclassExploits("Crusader", [
      "commanding presence",
      "ruthless strike",
      "honor duel",
      "intimidating command",
      "inspirational speech",
    ]),
    "subclassfeature3.1": {
      name: "Fanatical Disciple",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I gain proficiency in Religion if don't already have it.",
        "When I do an Int(Religion) check related to my god or cause, I gain a bonus equal to my Exploit Die",
      ]),
      skillstxt: "Proficient in Religion if not already.",
    },
    "subclassfeature3.2": {
      name: "Crusader's Ire",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "As a bonus action, I can Mark a creature within 60 ft for 1 min or until slain, which lets me:",
        "\u2022 Make another attack with the same weapon once on my turn if I miss it",
        "\u2022 Can make an opportunity attack if the creature attacks or casts a spell against another creature",
        "\u2022 Add an Exploit Die to any saving throw the creature forces me to do",
        "If I have no uses left, I can expend an Exploit Die to use it again",
      ]),
      action: [["bonus action", ""]],
      recovery: "short rest",
      usages: 1,
      altResource: "ED",
    },
    subclassfeature7: {
      name: "Renewed Fervor",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "When you use Second Wind, I regain the use of my Crusader's Ire",
        "Also, when I mark a creature with Crusader's Ire I can move up to 30 ft toward it",
        "as part of the same bonus action without expending my movement",
      ]),
    },
    subclassfeature10: {
      name: "Zealous Fury",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "When I fall to 0 hit points and don’t die outright, I can drop to 1 hit point instead.",
        "I can use this feature once per short or long rest.",
        "If I have no use left I can use it again but I gain a level of Exhaustion",
      ]),
    },
    subclassfeature15: {
      name: "Righteous Judgment",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "When I hit a creature marke with my Crusader's Ire with a weapon attack, I can end the mark to maximize the damage instead of rolling",
        "If the attack reduces the creature to 0 HP, I regain the use of my Crusader's Ire",
        "I can use this feature once per short or long rest",
      ]),
      recovery: "short rest",
      usages: 1,
      altResource: "ED",
    },
    subclassfeature18: {
      name: "Legendary Crusader",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc([
        "When a creature marked with my Crusader's Ire attacks me, I can use a reaction to make a single weapon attack against it",
        "If I use the reaction after the attack hits me, I can make my attack with advantage",
      ]),
      action: [["reaction", ""]],
    },
  },
});

// Guardian
AddSubClass("fighter(laserllama)", "guardian", {
  regExpSearch: /guardian/i,
  subname: "Guardian",
  fullname: "Guardian",
  source: [["GMB:LL", 0]],
  features: {
    subclassfeature3: GetFighterSubclassExploits("Guardian", [
      "reposition",
      "shield impact",
      "defensive stance",
      "hold the line",
      "daring rescue",
    ]),
    "subclassfeature3.1": (function () {
      // copies the main class feature, avoids having to copy all fighting styles
      var FSfea = newObj(
        ClassList["fighter(laserllama)"].features["fighting style"]
      );
      FSfea.name = "Iron Guardian";
      FSfea.source = [["GMB:LL", 0]];
      FSfea.minlevel = 3;
      FSfea.description = desc([
        "I gain one Fighting Style of my choice from: Defensive Fighting, Protection, or Shield Warrior. It doesn't count against my number of Fighting Styles and can only be replaced by a style from that list.",
        "If I'm wielding a shield and a creature within 5 ft of me is hit by an attack, I can use Reposition as a reaction without expending an Exploit Die, but no temporary hit points are gained.",
        "If I use this reaction, I take the damage only if the attack would have also hit me.",
      ]);
      FSfea.action = [["reaction", ""]];
      FSfea.extraname = "Iron Guardian Fighting Style";
      FSfea.extraTimes = [];
      FSfea.extrachoices = ["Defensive", "Protection", "Shield Warrior"];
      FSfea.choices = undefined; // work-around to prevent having the choice menu display twice

      return FSfea;
    })(),
    "subclassfeature3.2": {
      name: "Warrior Smith",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I gain proficiency in smith's tools. I add my Exploit Die to any ability check I make with smith's tools.",
        "During a long rest, I can spend 1 hour using my smith's tools to enhance one set of armor or a shield I touch, granting a +1 bonus to AC until the start of my next long rest.",
      ]),
      toolProfs: ["smith's tools"],
    },
    subclassfeature7: {
      name: "Inspiring Sentinel",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "When I use Second Wind, creatures of my choice within 5 ft gain temporary hit points equal to 1d6 + my Con modifier (minimum of 1).",
        "Also, when I use my Iron Guardian reaction, Reposition grants temporary hit points even if I didn’t expend an Exploit Die.",
      ]),
    },
    subclassfeature10: {
      name: "Stalwart Defender",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "The range of my Iron Guardian reaction increases to 10 ft if there is a clear path to the target.",
        "This reaction does not end Defensive Stance or Hold the Line for me.",
      ]),
    },
    subclassfeature15: {
      name: "Adamant Guardian",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "The range of my Iron Guardian reaction increases to include creatures I can see within 15 feet, as long as there is a clear path to them.",
        "I am no longer limited to using Daring Rescue only once between rests.",
      ]),
    },
    subclassfeature18: {
      name: "Legendary Guardian",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc([
        "I gain a special reaction I can take once per turn, which can only be used for Iron Guardian, Guardian Exploits, or opportunity attacks.",
      ]),
    },
  },
});

// Guerrilla
AddSubClass("fighter(laserllama)", "guerrilla", {
  regExpSearch: /guerrilla/i,
  subname: "Guerrilla",
  fullname: "Guerrilla",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: GetFighterSubclassExploits("Guerrilla", [
      "lightstep",
      "mighty leap",
      "crippling strike",
      "pinning shot",
      "survey wilderness",
    ]),
    "subclassfeature3.1": {
      name: "Adaptable Combatant",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map(function (n) {
        amount = n < 3 ? 0 : n < 7 ? 2 : 4;
        return desc([
          "I can replace an Exploit I know with another by spending 1 h training (can be part of a short/long rest)",
          "I gain proficiency in some of the skills below: Athletics, Perception, Stealth, or Survival",
          "If already proficient, I instead add an Exploit Die to all checks with the skill I choose",
        ]);
      }),
      extraname: "Adaptable Combatant proficiencies",
      extrachoices: [
        "Athletics (proficiency)",
        "Athletics (exploit die)",
        "Perception (proficiency)",
        "Perception (exploit die)",
        "Stealth (proficiency)",
        "Stealth (exploit die)",
        "Survival (proficiency)",
        "Survival (exploit die)",
      ],
      extraTimes: 1,
      "athletics (proficiency)": {
        name: "Athletics (proficiency)",
        skills: ["Athletics"],
        prereqeval: function (v) {
          return v.skillProfs.indexOf("Athletics") === -1; // must NOT be proficient already
        },
      },
      "athletics (exploit die)": {
        name: "Athletics (exploit die)",
        prereqeval: function (v) {
          return v.skillProfs.indexOf("Athletics") !== -1; // must be proficient already
        },
      },
      "perception (proficiency)": {
        name: "Perception (proficiency)",
        skills: ["Perception"],
        prereqeval: function (v) {
          return v.skillProfs.indexOf("Perception") === -1;
        },
      },
      "perception (exploit die)": {
        name: "Perception (exploit die)",
        prereqeval: function (v) {
          return v.skillProfs.indexOf("Perception") !== -1;
        },
      },
      "stealth (proficiency)": {
        name: "Stealth (proficiency)",
        skills: ["Stealth"],
        prereqeval: function (v) {
          return v.skillProfs.indexOf("Stealth") === -1;
        },
      },
      "stealth (exploit die)": {
        name: "Stealth (exploit die)",
        prereqeval: function (v) {
          return v.skillProfs.indexOf("Stealth") !== -1;
        },
      },
      "survival (proficiency)": {
        name: "Survival (proficiency)",
        skills: ["Survival"],
        prereqeval: function (v) {
          return v.skillProfs.indexOf("Survival") === -1;
        },
      },
      "survival (exploit die)": {
        name: "Survival (exploit die)",
        prereqeval: function (v) {
          return v.skillProfs.indexOf("Survival") !== -1;
        },
      },
    },
    "subclassfeature3.2": (function () {
      // copies the main class feature, avoids having to copy all fighting styles
      var FSfea = newObj(
        ClassList["fighter(laserllama)"].features["fighting style"]
      );
      FSfea.name = "Survivalist Fighting Style";
      FSfea.source = [["GMB:LL", 0]];
      FSfea.minlevel = 3;
      (FSfea.description = desc([
        "I learn the Mariner or Mountaneer Fighting Style and it doesn't count to the max of Fighting Styles I know",
      ])),
        (FSfea.extraname = "Survivalist Fighting Style");
      FSfea.extraTimes = [];
      FSfea.extrachoices = ["Mariner", "Mountaineer"];
      FSfea.choices = undefined; // work-around to prevent having the choice menu display twice

      return FSfea;
    })(),
    subclassfeature7: {
      name: "By Land or Sea",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "I can switch my Survivalist Fighting Style each long rest",
        "I ignore the effects of nonmagical difficult terrain",
        "I can hold my breath for up to 1 hour underwater",
        "Whenever you use your Second Wind you also gain the benefits of the Dash action or the mighty leap Exploit",
      ]),
      savetxt: { immune: ["nonmagical difficult terrain"] },
    },
    subclassfeature10: {
      name: "Identify Weakness",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "When I succeed on an Eye for Talent check I can forgo the infos and instead, the next time I force the target to make a saving throw against one of my Exploits it does so with disadvantage.",
      ]),
    },
    subclassfeature15: {
      name: "Unwavering",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "When I use Second Wind, I regain one of my expended Exploit Dice and the maximum of hit points",
        "I can expend my Action Surge, to replace a Martial Exploits with another one I could learn",
      ]),
    },
    subclassfeature18: {
      name: "Legendary Guerrilla",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: levels.map(function (n) {
        return desc([
          "When I roll initiative and I am not surprised, I gain one of the following benefits:",
          "\u2022 I gain " + n + " temp HP",
          "\u2022 I can take the Search action to use my Eye for Talent feature",
          "\u2022 I can move up to my full move speed without provoking opportunity attacks",
        ]);
      }),
    },
  },
});

// Hound Master
AddSubClass("fighter(laserllama)", "hound master", {
  regExpSearch: /hound master/i,
  subname: "Hound Master",
  fullname: "Hound Master",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: GetFighterSubclassExploits("Hound Master", [
      "cunning instinct",
      "reposition",
      "exposing strike",
      "intimidating command",
      "survey wilderness",
    ]),
    "subclassfeature3.1": {
      name: "Loyal Hound",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I have a Hound companion which is friendly to me & my allies and obeys me",
        'Select a "Loyal Hound" on the companion page for its stats and rules',
        "It only takes the Dodge action unless I use a bonus action to command it or forgo one attack to let it Bite.",
        "If reduced to 0 HP, it makes death saves. I can use an action and expend an Exploit Die to stabilize it.",
        "If it dies, I can spend 8 hours training a new one.",
      ]),
      action: [["bonus action", " (command)"]],
      creaturesAdd: [["Loyal Hound", true]],
      creatureOptions: [
        {
          name: "Loyal Hound",
          source: ["GMB:LL", 0],
          size: 3,
          type: "Beast",
          alignment: "Lawful Neutral",
          ac: "13+Prof",
          hp: 20,
          hd: [levels.map((n) => n), 8],
          hdLinked: ["fighter(laserllama)"],
          minlevelLinked: ["fighter(laserllama)"],
          speed: "40 ft, swim 20 ft",
          scores: [14, 14, 15, 8, 14, 11],
          saves: ["", "", "", "", "", ""],
          senses: "Adv. on Wis (Perception) checks using hearing/smell",
          passivePerception: 12,
          languages: "Understands the languages you speak",
          challengeRating: "0",
          proficiencyBonus: 2,
          proficiencyBonusLinked: true,
          attacksAction: 1,
          skills: {
            Perception: 2,
          },
          attacks: [
            {
              name: "Bite",
              ability: 1,
              damage: [1, 6, "piercing"],
              modifiers: ["", "Prof"],
              range: "Melee (5 ft)",
              abilitytodamage: true,
            },
          ],
          features: [
            {
              name: "Loyal",
              description:
                "I add my PB to any ability check or saving throw my Companion makes and it cannot be charmed while you are within 30 feet of it.",
            },
            {
              name: "Keen Hearing & Smell",
              description:
                "The companion has advantage on Wisdom (Perception) checks that rely on hearing or smell.",
            },
            {
              name: "Steadfast Companion",
              minlevel: 10,
              description:
                "While it is within 30 of you, the Hound can use a special reaction to give youn advan. to a saving throw",
            },
            {
              name: "Condition Immunities",
              minlevel: 18,
              description: "Frightened",
            },
          ],
          traits: [
            {
              name: "Strong Jaws",
              minlevel: 3,
              description:
                "If the Hound hits a creature equal to its size or smaller with its Bite, it can grapple the target in its jaws. While grappling it can't Bite other targets.",
            },
            {
              name: "Iron Jaws",
              minlevel: 7,
              description:
                "The damage of the Bite is considered magical for overcoming resistances and immunities",
              eval: function (prefix, lvl) {
                AddString(
                  prefix + "Comp.Use.Attack.1.Description",
                  "Counts as magical",
                  "; "
                );
              },
              removeeval: function (prefix, lvl) {
                RemoveString(
                  prefix + "Comp.Use.Attack.1.Description",
                  "Counts as magical"
                );
              },
            },
            {
              name: "Canine Fury",
              minlevel: 15,
              description:
                "Once per turn, when you use a bonus action to command your Hound to make an attack, it can make two Bite attacks instead.",
            },
            {
              name: "Hound of Legend",
              minlevel: 18,
              description:
                "My Loyal Hound became a Hound of Legend, changing Its stats block.",
              addMod: [
                {
                  type: "",
                  field: "Comp.Use.Ability.Str.Score",
                  mod: 6,
                  text: "At level 18, the Hound's Strength increases by 6.",
                },
                {
                  type: "",
                  field: "Comp.Use.Ability.Dex.Score",
                  mod: -2,
                  text: "At level 18, the Hound's Dexterity decreases by 2.",
                },
                {
                  type: "",
                  field: "Comp.Use.Ability.Con.Score",
                  mod: 4,
                  text: "At level 18, the Hound's Constitution increases by 4.",
                },
                {
                  type: "",
                  field: "Comp.Use.Ability.Int.Score",
                  mod: 2,
                  text: "At level 18, the Hound's Intelligence increases by 2.",
                },
                {
                  type: "",
                  field: "Comp.Use.Ability.Wis.Score",
                  mod: 4,
                  text: "At level 18, the Hound's Wisdom increases by 4.",
                },
                {
                  type: "",
                  field: "Comp.Use.Ability.Cha.Score",
                  mod: 3,
                  text: "At level 18, the Hound's Charisma increases by 3.",
                },
                {
                  type: "skill",
                  field: "Perception",
                  mod: "+6", // Aggiungi 8 al bonus di Perception (da +2 a +10)
                  text: "At level 18, the Hound's Perception skill bonus increases by 6.",
                },
                {
                  type: "skill",
                  field: "Intimidation",
                  mod: "+6", // Aggiungi +8 a Intimidation (assumendo che non avesse nulla o avesse un bonus base)
                  text: "At level 18, the Hound's Intimidation skill bonus increases by 6.",
                },
                {
                  type: "skill",
                  field: "Survival",
                  mod: "+6", // Aggiungi +10 a Survival (assumendo che non avesse nulla o avesse un bonus base)
                  text: "At level 18, the Hound's Survival skill bonus increases by 6.",
                },
                {
                  type: "",
                  field: "BlueText.Comp.Use.Attack.1.Damage Die",
                  mod: "1d6",
                  text: "At level 18 the Hound's Bite Damage increases of 1d6",
                },
                {
                  type: "skill",
                  field: "pass",
                  mod: -2,
                  text: "At level 18, the Hound's passive perception is 18.",
                },
              ],
              eval: function (prefix, lvl) {
                var sMoveStr = "60 ft, swim 40 ft";
                if (What("Unit System") === "metric")
                  sMoveStr = ConvertToMetric(sMoveStr, 0.5);

                tDoc.getField(prefix + "Comp.Use.Speed").value = sMoveStr;
              },
              removeeval: function (prefix, lvl) {
                var sMoveStr = "40 ft, swim 20 ft";
                if (What("Unit System") === "metric")
                  sMoveStr = ConvertToMetric(sMoveStr, 0.5);

                tDoc.getField(prefix + "Comp.Use.Speed").value = sMoveStr;
              },
            },
          ],
          notes: [
            {
              name: "The companion obeys the commands of its leader",
              description: "and shares its proficiency bonus.",
              joinString: " ",
            },
            {
              name: "It takes its turn during that of its leader,",
              description: "on the same initiative count.",
              joinString: " ",
            },
            {
              name: "It can move and take reactions on its own,",
              description:
                "but only takes the Dodge action on its turn unless its leader takes a bonus action to command it to take another action.",
              joinString: " ",
            },
            {
              name: "Its leader can also forgo one attack during their Attack action",
              description:
                "to command the companion to take the Attack action.",
              joinString: " ",
            },
            {
              name: "If its leader is incapacitated,",
              description: "the companion can take any action, not just Dodge.",
              joinString: " ",
            },
            {
              name: "If the companion is reduced to 0 hit points,",
              description:
                "it makes death saving throws like a player character would.",
              joinString: " ",
            },
          ],
          calcChanges: {
            hp: function (totalHD, HDobj, prefix) {
              //if (!classes.known.ranger && !classes.known.rangerua) return;
              var rngrLvl = classes.known["fighter(laserllama)"]
                ? classes.known["fighter(laserllama)"].level
                : classes.known.fighter.level;
              var rngrLvlM = 5 * rngrLvl;
              HDobj.alt.push(5 + rngrLvlM);
              HDobj.altStr.push(
                " = 5 as a base\n + 5 \xD7 " +
                rngrLvl +
                " from five times its leader's fighter level (" +
                rngrLvlM +
                ")"
              );
            },
            setAltHp: true,
          },
        },
      ],
    },
    subclassfeature7: {
      name: "Iron Jaws",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "My companion's attacks count as magical for overcoming resistances and immunities",
      ]),
    },
    "subclassfeature7.1": (function () {
      // Fixed attributes
      WarHoundExploit = {
        name: "War Hound",
        minlevel: 7,
        source: [["GMB:LL", 0]],
        description: desc([
          "Over 1 hour (can be short/long rest) I can teach a 1st-degree I know to my Hound that can reasonably use",
          "I can teach up to two exploit to my Hound this way",
          "My Hound gains a Exploit Die to use its Exploits and it regain all uses after a short/long rest",
        ]),
        limfeaname: "Hound Exploit Dice",
        usages: [
          "",
          "",
          "",
          "",
          "",
          "",
          1,
          1,
          1,
          1,
          1,
          1,
          1,
          1,
          2,
          2,
          2,
          2,
          2,
          2,
        ],
        additional: [
          "",
          "d6",
          "d6",
          "d6",
          "d8",
          "d8",
          "d8",
          "d8",
          "d8",
          "d8",
          "d10",
          "d10",
          "d10",
          "d10",
          "d10",
          "d10",
          "d12",
          "d12",
          "d12",
          "d12",
        ],
        // Exploit choice menu
        extraname: "War Hound Exploits",
        extrachoices: [],
        extraTimes: levels.map(function (n) {
          return n < 7 ? 0 : n < 15 ? 2 : 3;
        }),
        toNotesPage: [
          {
            name: "War Hound Exploits",
            note: desc(["Below are the Exploits I teached to my Hound"]),
          },
        ],

        // Eval
        eval: CreateMartialSpellsheet,
      };

      // Make a filtered spell list that contains only exploits
      const WarHoundSpells = Object.keys(SpellsList)
        .filter(
          (key) => SpellsList[key].isExploit && SpellsList[key].level <= 2
        )
        .filter((key) => {
          for (var i = 0; i < SpellsList[key].classes.length; i++) {
            if (SpellsList[key].classes[i] == "fighter(laserllama)")
              return true;
          }
          return false;
          // NOTE: this is literally a SpellsList[key].classes.includes("fighter(laserllama)") but for some cursed reason I can't use that function
        });

      //const DegreeToMinLevel = [0,0,5,9,13,17]
      // Iterate over all Fighter(laserllama) "spells"
      for (var i = 0; i < WarHoundSpells.length; i++) {
        var NewSpell = SpellsList[WarHoundSpells[i]];

        WarHoundExploit.extrachoices.push(NewSpell.name); // Add "spell" name to menu options

        WarHoundExploit[WarHoundSpells[i]] = {
          // Add "spell" to the main item (when it is picked through the menu)
          name: NewSpell.name,
          toNotesPage: [
            {
              // What is added to the notes page
              name:
                NewSpell.name +
                " Exploit [" +
                (NewSpell.level == 1
                  ? "1st"
                  : NewSpell.level == 2
                    ? "2nd"
                    : NewSpell.level == 3
                      ? "3rd"
                      : NewSpell.level + "th") +
                " degree]",
              note: desc(NewSpell.descriptionFull),
              amendTo: "War Hound Exploits",
            },
          ],
          source: NewSpell.source,
          addMod: NewSpell.addMod,
          submenu: NewSpell.submenu,
          prereqeval: ExploitPrereqFactory(
            WarHoundSpells[i],
            "fighter(laserllama)"
          ),
          eval: WarHoundExploit.eval, // in case the user removes all exploits
          spellcastingBonusElsewhere: {
            addTo: "martial exploits",
            spellcastingBonus: {
              name: "War Hound Exploits",
              spellcastingAbility: 1,
              spells: [WarHoundSpells[i]],
              selection: [WarHoundSpells[i]],
            },
          },
        };
      }

      return WarHoundExploit;
    })(),
    subclassfeature10: {
      name: "Steadfast Companion",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "Me and my Hound gains a special reaction that gives the other advan. on any save as long we are 30 feet within each other",
      ]),

      action: [["reaction", ""]],
    },
    subclassfeature15: {
      name: "Canine Fury",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "Once per turn, when I order my Hound to make a Bite attack it can make two Bite attacks instead of one.",
        "Now I can teach with War Hound 2-degree Exploits, teach up to three exploits and my Hound get a second Exploit Die",
      ]),
    },
    subclassfeature18: {
      name: "Hound of Legend",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc([
        "My Loyal Hound now use the stats of the Hound of Legend",
        "If it dies, it magically reforms after 1 hour, appearing in an unoccupied space within 15 feet of me",
      ]),
    },
  },
});

// Pugilist
AddSubClass("fighter(laserllama)", "pugilist", {
  regExpSearch: /pugilist/i,
  subname: "Pugilist",
  fullname: "Pugilist",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: GetFighterSubclassExploits("Pugilist", [
      "streetwise",
      "brace up",
      "concussive blow",
      "dirty hit",
      "disorienting blow",
    ]),
    "subclassfeature3.1": {
      name: "Contender",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I learn the Brawling Fighting Style, or Improvised Fighting if I already know it.",
        "Unarmed strike damage increases to match the size of my Exploit Die.",
      ]),
      extraname: "Additional Fighting Styles",
      extrachoices: ["Brawling", "Improvised Fighting"],
      extraTimes: levels.map(function (n) {
        return n < 3 ? 0 : n < 7 ? 1 : n < 10 ? 2 : 3;
      }),
      brawling: FightingStylesLL.brawling,
      "improvised fighting": FightingStylesLL.improvised,
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (v.baseWeaponName == "unarmed strike") {
              var dd = fields.Damage_Die == 1;
              var aExploitDie = (function (n) {
                return n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12;
              })(classes.known["fighter(laserllama)"].level);
              if (dd !== aExploitDie) fields.Damage_Die = "1d" + aExploitDie;
            }
          },
          "My unarmed strikes deals my Exploit Die damage.",
          1,
        ],
      },
    },
    "subclassfeature3.2": {
      name: "Iron Physique",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "Without armor and no shield, my AC is 10 + Dexterity modifier + Constitution modifier",
        "I can use my Con to calculate my AC instead of Dex while wearing light/medium armor",
      ]),
      armorOptions: [
        {
          regExpSearch: /justToAddToDropDown/,
          name: "Unarmored Defense",
          source: [
            ["SRD", 8],
            ["P", 48],
          ],
          ac: "10+Con",
          affectsWildShape: true,
        },
      ],
      armorAdd: "Unarmored Defense (Con)",
      extraAC: [
        {
          name: "Iron Physique (light armor)",
          mod: "max(Con-Dex|0)",
          text: "I can use my Con to calculate my AC instead of Dex while wearing light/medium armor",
          stopeval: function (v) {
            return !v.wearingArmor || v.heavyArmor; // light/medium armor only
          },
        } /*, {
				name : "Iron Physique (medium armor)",
				mod : "min(max(Con-Dex|0)|2)",
				text : "I can use my Con to calculate my AC instead of Dex while wearing medium armor",
				stopeval : function (v) { 
					return !v.mediumArmor // medium armor only
				}
			}*/,
      ],
      // NOTE: It is impossible to put a nested min/max expression (the sheet can't handle it)
      // It is mathematically impossible to formulate this expression without it, so there's nothing I can do
    },
    subclassfeature7: {
      name: "Counter Punch",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "When a creature I can see misses me with a melee attack, I can use my reaction to make a single unarmed strike, improvised weapon, shove, or grapple attack against it",
        "If I force a creature to make a save as part of this reaction, it has disadv.",
      ]),
      action: [["reaction", " (when enemy misses)"]],
    },
    "subclassfeature7.1": {
      name: "Resolute Strikes",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "My unarmed strikes and improvised weapons are magical for overcoming resistance/immunity.",
      ]),
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (
              (v.baseWeaponName == "unarmed strike" ||
                v.baseWeaponName == "improvised weapon") &&
              !v.thisWeapon[1] &&
              !v.theWea.isMagicWeapon &&
              !/counts as( a)? magical/i.test(fields.Description)
            ) {
              fields.Description +=
                (fields.Description ? "; " : "") + "Counts as magical";
            }
          },
          "My unarmed strikes count as magical for overcoming resistances and immunities.",
        ],
      },
    },
    subclassfeature10: {
      name: "Evasive Footwork",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "When I use the Attack action and make at least one unarmed strike, grapple, or shove, I gain the benefits of the Disengage action for the turn",
      ]),
    },
    subclassfeature15: {
      name: "Diamond Physique",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "When I use Brace Up, I also gain resistance to that instance of damage.",
        "I learn the 'unbreakable' Exploit. It doesn't count against my total Exploits Known and can't be swapped.",
      ]),
      spellcastingBonusElsewhere: {
        addTo: "martial exploits",
        spellcastingBonus: {
          name: "Pugilist Exploits",
          spellcastingAbility: 1,
          spells: ["unbreakable"],
          selection: ["unbreakable"],
          prepared: true,
        },
      },
      toNotesPage: [
        {
          // What is added to the notes page
          name: "Unbreakable Exploit [4th degree]",
          note: desc(SpellsList["unbreakable"].descriptionFull),
          amendTo: "Pugilist",
        },
      ],
    },
    subclassfeature18: {
      name: "Legendary Pugilist",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc([
        "I have advantage on saves to resist/end Incapacitated, Paralyzed, or Stunned.",
        "When I crit with an unarmed strike or improvised weapon, the target falls prone and is Stunned until start of my next turn.",
      ]),
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (
              (v.baseWeaponName == "unarmed strike" ||
                v.baseWeaponName == "improvised weapon") &&
              !v.thisWeapon[1] &&
              !v.theWea.isMagicWeapon &&
              !/counts as( a)? magical/i.test(fields.Description)
            ) {
              fields.Description +=
                (fields.Description ? "; " : "") +
                "On crit: target falls prone and Stunned until start my next turn";
            }
          },
          "On a critical hit the target falls prone and is Stunned until start of my next turn",
        ],
      },
      savetxt: {
        text: ["Adv. to resist/end paralyzed, incapacitated or stunned"],
      },
    },
  },
});

// Quartermaster
AddSubClass("fighter(laserllama)", "quartermaster", {
  regExpSearch: /quartermaster/i,
  subname: "Quartermaster",
  fullname: "Quartermaster",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: GetFighterSubclassExploits("Quartermaster", [
      "first aid",
      "rustic intuition",
      "exposing strike",
      "immovable stance",
      "daring rescue",
    ]),
    "subclassfeature3.1": {
      name: "Down to Earth",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I am proficient with cook's utensils, land vehicles, and Animal Handling",
        "When I make a check with any of those proficiencies, I add my Exploit Die",
      ]),
      skills: ["Animal Handling"],
      toolProfs: ["Cook's utensils", "Land vehicles"],
    },
    "subclassfeature3.2": {
      name: "Rations",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "At the end of a long rest, I can use cook utensils to prepare rations (see notes)",
        "As a bonus action, a creature can eat a prepared Ration or feed it to a creature within 5 ft",
        "Consuming a Ration ends any current Ration effects on that creature",
        "As an action, I can expend an Exploit Die to prepare an additional Ration of my choice, though I don't regain that Exploit Die until that Ration is eaten",
        "I can eat a Ration or feed it to a creature as part of the action used to create it",
      ]),
      action: [
        ["action", "Create ration (and eat/feed)"],
        ["bonus action", "Eat or feed a ration"],
      ],
      usages: "Constitution modifier per ",
      usagescalc: "event.value = What('Con Mod');",
      recovery: "long rest",
      altResource: "ED",
      toNotesPage: [
        {
          name: "Rations",
          note: desc([
            "Below are all rations I can prepare (If my Fighter level meet the Ration level). A creature can only be under the effect of one Ration at a time, eating another ration ends any previous Ration effects.",
          ]),
        },
      ],
      "3rd level rations": {
        name: "3rd level rations",
        toNotesPage: {
          name: "3rd level rations",
          note:
            "\n\u2022 Fortifying Ration (1 minute)" +
            "\nUpon consumption, the creature chooses either Strength, Dexterity, or Constitution. For the duration, the creature can add your Constitution modifier (minimum of +1) to any ability check or saving throws it makes with the chosen ability score." +
            "\n\n" +
            "\u2022 Invigorating Ration (instantaneous)" +
            "\nUpon consumption, the creature regains hit points equal to twice your Exploit Die + your Constitution modifier (minimum of +1)." +
            "\nAt 10th level, Any hit points it regains that exceed its hit point maximum become temporary hit points." +
            "\n\n" +
            "\u2022 Limbering Ration (1 minute)" +
            "\nUpon consumption, the creature speed increases by 10 feet." +
            "\nAt 10th level,  the creature speed increases by 20 feet instead." +
            "\n\n" +
            "\u2022 Revitalizing Ration (instantaneous)" +
            "\nUpon consumption, the creature ends one of the following conditions currently affecting it: blindned, deafned, poisoned, or it can reduce its current exhaustion level by 1." +
            "\nAt 10th level, this Ration can also cure the charmed, frightened, paralyzed, and stunned conditions." +
            "\n\n" +
            "\u2022 Stimulating Ration (instantaneous)" +
            "\nThis Ration must be consumed as part of a short rest. Upon consumption, the creature gains advantage on its rolls for all Hit Dice it chooses to expend during that short rest." +
            "\nAt 10th level, consuming this Ration allows the creature to treat any Hit Dice it expends during that short rest as the maximum possible result instead of rolling. ",
          amendTo: "Rations",
        },
      },
      "7th level rations": {
        name: "7th level rations",
        toNotesPage: {
          name: "7th level rations",
          note:
            "\n\u2022 Engorging Ration (1 minute)" +
            "\nUpon consumption, the creature grows by one size category, for example, from Medium to Large. While the creature's size is increased in this way, its reach increases by 5 feet, it has advantage on Strength checks and saving throws, and any melee weapon attacks it makes deal a bonus 1d4 damage." +
            "\nAt 10th level, the duration of the effect becomes 1 hour." +
            "\n\n" +
            "\u2022 Thickening Ration (1 minute)" +
            "\nUpon consumption, the creature gains resistance to either bludgeoning, piercing, or slashing damage (its choice)." +
            "\nAt 10th level, consuming this Ration grants it resistance to all bludgeoning, piercing, and slashing damage." +
            "\n\n" +
            "\u2022 Heightening Ration (1 minute)" +
            "\nUpon consumption, the creature chooses either Intelligence, Wisdom, or Charisma. For the duration, the creature can add your Constitution modifier (minimum of +1) to any ability check or saving throw it makes with the chosen ability score." +
            "\n\n" +
            "\u2022 Warding Ration (1 minute)" +
            "\nUpon consumption, the creature gains resistance to acid, cold, fire, poison, lightning, or thunder damage (its choice)." +
            "\nAt 10th level, the duration of the effect increases to 1 hour, and the creature can choose from force, necrotic, psychic, or radiant damage in addition to the other damage types.",
        },
      },
      "15th level rations": {
        name: "15th level rations",
        toNotesPage: {
          name: "15th level rations",
          note:
            "\n\u2022 Berserker Ration (1 minute)" +
            "\nUpon consumption, the creature does not fall unconscious when it is reduced to 0 hit points. However, it still makes death saving throws as normal, dying upon failing three." +
            "\n\n" +
            "\u2022 Rejuvenating Ration (1 minute)" +
            "\nUpon consumption, the creature gains all the benefits of a short rest, including the ability to expend its Hit Dice as part of consuming the Ration. At the end of its current turn, the creature gains 1 level of exhaustion tha can only be reduced by magic or completing a long rest.",
          amendTo: "7th level rations",
        },
      },
      autoSelectExtrachoices: [
        {
          extrachoice: "3rd level rations",
          minlevel: 3,
        },
        {
          extrachoice: "7th level rations",
          minlevel: 7,
        },
        {
          extrachoice: "15th level rations",
          minlevel: 15,
        },
      ],
    },
    subclassfeature7: {
      name: "Dependable Ally",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "I can forgo any number of attacks to do one of the following for each attacks:",
        "\u2022 Take the Help action targeting a creature within 10 feet",
        "\u2022 Take the Use an Object action to feed a Ration, potion or another consumable to a creature I can touch",
        "\u2022 Give one weapon, item or shield to a creature I can touch. It is instantly equiped with it and stows another item.",
      ]),
      action: [
        ["action", "Help w/in 10ft (attack)"],
        ["action", "Use Object (attack)"],
        ["action", "DtE check (attack)"],
        ["action", "Give wea/item/shield (attack)"],
      ],
    },
    subclassfeature10: {
      name: "Quick Ration",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "I can use a bonus action on my turn to create a Ration of my choice, eating it or feeding it to a creature within 5 ft as part of that same bonus action. Any Rations created in this way expire after 1 minute.",
      ]),
      action: [["bonus action", ""]],
      usages: "Constitution modifier per ",
      usagescalc: "event.value = Math.max(1, What('Con Mod'));",
      recovery: "long rest",
    },
    subclassfeature15: {
      name: "Ever Ready",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "When I roll initiative, so long as I am not surprised, I prepare one Ration of my choice without expending an Exploit Die",
      ]),
    },
    subclassfeature18: {
      name: "Legendary Quartermaster",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc([
        "I am immune to poisoned, add +2 to my Constitution, and its maximum increases to 22",
        "I can be under the effects of two Rations at once, If I eat a third I chose which effect ends",
      ]),
      scores: [0, 0, 2, 0, 0, 0],
      scoresMaximum: [0, 0, 22, 0, 0, 0],
      savetxt: { immune: ["poisoned"] },
    },
  },
});

// Swordsage
AddSubClass("fighter(laserllama)", "swordsage", {
  regExpSearch: /swordsage/i,
  subname: "Swordsage",
  fullname: "Swordsage",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: GetFighterSubclassExploits("Swordsage", [
      "parry",
      "mighty leap",
      "glancing blow",
      "zephyr slash",
      "gale slash",
    ]),
    "subclassfeature3.1": {
      name: "Student of the Blade",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        'I gain proficiency in Acrobatics or Performance choosing with the "Choose Feature" button.',
        "I can make Dexterity (Performance) checks",
        "When I make Dex (Acrobatics) or Dex (Performance) checks with a sword, I add my Exploit Die",
      ]),
      extraname: "Student of the Blade",
      choices: ['Acrobatics', 'Performance'],
      "performance": {
        name: "Student of the Blade",
        additional: "Performance",
        description: desc([
          'I am proficient in Acrobatics',
          "I can make Dexterity (Performance) checks",
          "When I make Dex (Acrobatics) or Dex (Performance) checks with a sword, I add my Exploit Die",
        ]),
        skills: ["Performance"],
      },
      "acrobatics": {
        name: "Student of the Blade",
        additional: "Acrobatics",
        description: desc([
          'I am proficient in Acrobatics',
          "I can make Dexterity (Performance) checks",
          "When I make Dex (Acrobatics) or Dex (Performance) checks with a sword, I add my Exploit Die",
        ]),
        skills: ["Acrobatics"],
      },
      addMod: {
        type: "skill",
        field: "Performance",
        mod: "max(Dex-Cha|0)",
        text: "I can replace Charisma (Performance) checks with Dexterity (Performance)",
      },
    },
    "subclassfeature3.2": {
      name: "Battle Trance",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map(function (n) {
        ac_bonus = n < 7 ? "+1" : "+2";

        return desc([
          "As a bonus action, I can enter a battle trance for 1 minute which lets me:",
          "\u2022 Take the Dash action as a bonus action",
          "\u2022 Add " + ac_bonus + " to my AC",
          "\u2022 Have advantage on Dexterity (Acrobatics) checks",
          "\u2022 Once per turn, use a d4 for swordsage exploits without expending Exploit Die",
          "It ends early if I am incapacitated, don a shield or heavy armor",
          "If I have no uses left, I can expend an Exploit Die to use it again",
        ]);
      }),
      action: [
        ["bonus action", " (start)"],
        ["bonus action", "Dash (in Battle Trance)"],
      ],
      recovery: "short rest",
      usages: 1,
      altResource: "ED",
    },
    subclassfeature7: {
      name: "Mythic Reflexes",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "I gain proficiency in Dexterity saves.",
        "Add Proficiency Bonus to initiative rolls.",
        "Battle Trance AC bonus becomes +2.",
      ]),
      saves: ["Dex"],
      addMod: {
        type: "skill",
        field: "Init",
        mod: "Prof",
        text: "I add my proficiency bonus to initiative rolls",
      },
    },
    subclassfeature10: {
      name: "Reactive Trance",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "When I roll initiative, if I am not surprised nor incapacitated, I can enter a Battle Trance without expending any resources",
      ]),
    },
    subclassfeature15: {
      name: "Storm of Steel",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "While in Battle Trance, taking Dash action also grants Disengage action benefits for that turn.",
        "I roll Exploit Dice twice for abilities/exploits and choose which total to use.",
      ]),
    },
    subclassfeature18: {
      name: "Legendary Swordsage",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc([
        "Enter/dismiss Battle Trance at will without cost.",
        "While in Battle Trance, I can expend an Exploit Die to reduce damage taken by twice the die roll.",
      ]),
    },
  },
});

// Tinker Knight
AddSubClass("fighter(laserllama)", "tinker knight", {
  regExpSearch: /tinker knight/i,
  subname: "Tinker Knight",
  fullname: "Tinker Knight",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 4,
  features: {
    subclassfeature3: {
      name: "Analytical Mind",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I gain proficiency with tinker's tools and smith's tools (or any other tool if already proficient)",
        "I add my Exploit Die to any ability check using these tools",
      ]),
      toolProfs: ["Tinker's tools", "Smith's tools"],
    },
    "subclassfeature3.1": {
      name: "Inventive Arsenal",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "During a long rest, I can modify weapons or armor using my tools to apply schematics",
        "Each schematic can only be applied once, and each item can only have one schematic",
        "Only me benefits of the Schematic effects",
        "If any schematic requires a saving throw, the DC is 8 + prof bonus + Int mod",
        'To calculate the effect, add it to the name of the weapon, e.g. "Rebounding Longsword"',
      ]),
      additional: levels.map(function (n) {
        return (
          (n < 3 ? 0 : n < 7 ? 2 : n < 10 ? 3 : n < 15 ? 4 : n < 18 ? 5 : 6) +
          " schematics known"
        );
      }),
      extraname: "Schematics known",
      extrachoices: [
        "Featherweight Schematic (Heavy Armor)",
        "Featherweight Schematic (Light Armor)",
        "Featherweight Schematic (Weapon)",
        "Featherweight Schematic (Boots)",
        "Intuitive Schematic (Light/Medium Armor)",
        "Intuitive Schematic (Melee Weapon)",
        "Intuitive Schematic (Helm)",
        "Radiant Schematic (Object)",
        "Radiant Schematic (Armor/Shield)",
        "Radiant Schematic (Melee Weapon)",
        "Rebounding Schematic (Heavy Armor)",
        "Rebounding Schematic (Non-Heavy Weapon)",
        "Rebounding Schematic (Boots)",
        "Empowered Schematic (Heavy Armor)",
        "Empowered Schematic (Light Armor)",
        "Empowered Schematic (Weapon)",
        "Resilient Schematic (Magic Armor)",
        "Resilient Schematic (Non-Magic Armor)",
        "Resilient Schematic (Weapon)",
        "Resilient Schematic (Helm)",
      ],
      extraTimes: levels.map(function (n) {
        return n < 3 ? 0 : n < 7 ? 2 : n < 10 ? 3 : n < 15 ? 4 : n < 18 ? 5 : 6;
      }),
      "featherweight schematic (heavy armor)": {
        name: "Featherweight Schematic (Heavy Armor)",
        submenu: "Featherweight Schematic",
        description: desc(["No Stealth disadvantage nor Strength requirement"]),
        prereqeval: function (v) {
          schematics = GetFeatureChoice(
            "classes",
            "fighter(laserllama)",
            "subclassfeature3.1",
            true
          );

          if (
            schematics.indexOf("featherweight schematic (light armor)") !== -1
          )
            return false;

          return true;
        },
      },
      "featherweight schematic (light armor)": {
        name: "Featherweight Schematic (Light Armor)",
        submenu: "Featherweight Schematic",
        description: desc([
          "It can remove 100 ft when calculating fall dmg, can move horizontally while falling (2 ft per 1 ft fall)",
        ]),
        prereqeval: function (v) {
          schematics = GetFeatureChoice(
            "classes",
            "fighter(laserllama)",
            "subclassfeature3.1",
            true
          );

          if (
            schematics.indexOf("featherweight schematic (heavy armor)") !== -1
          )
            return false;

          return true;
        },
      },
      "featherweight schematic (weapon)": {
        name: "Featherweight Schematic (Weapon)",
        submenu: "Featherweight Schematic",
        description: desc([
          "It loses two-handed/heavy properties, any non-two-handed weapon becomes light and finesse",
        ]),
        calcChanges: {
          atkAdd: [
            function (fields, v) {
              if (
                !v.isSpell &&
                !v.isDC &&
                /\bfeatherweight\b/i.test(v.WeaponTextName)
              ) {
                if (/\btwo-handed\b/i.test(fields.Description)) {
                  fields.Description = fields.Description.replace(
                    /two-handed/gi,
                    ""
                  )
                    .replace(/\s+/g, " ")
                    .trim();
                }

                if (/\bheavy\b/i.test(fields.Description)) {
                  fields.Description = fields.Description.replace(/heavy/gi, "")
                    .replace(/\s+/g, " ")
                    .trim();
                } else {
                  if (!/\blight\b/i.test(fields.Description)) {
                    fields.Description =
                      "Light, " +
                      fields.Description.substr(0, 1).toLowerCase() +
                      fields.Description.substr(1);
                  }
                  if (!/finesse/i.test(fields.Description)) {
                    fields.Description =
                      "Finesse, " +
                      fields.Description.substr(0, 1).toLowerCase() +
                      fields.Description.substr(1);
                  }
                }

                if (fields.Description.length <= 2) {
                  // remove leftovers
                  fields.Description = "";
                }

                v.SchematicsApplied
                  ? (v.SchematicsApplied += 1)
                  : (v.SchematicsApplied = 1);
              }
            },
            "Featherweight weapon loses two-handed/heavy properties, any non-two-handed weapon becomes light and finesse",
            650,
          ],
        },
      },
      "featherweight schematic (boots)": {
        name: "Featherweight Schematic (Boots)",
        submenu: "Featherweight Schematic",
        description: desc([
          "The wearer ignores the effects of nonmagical difficult terrain and its walking speed increases by 10 feet",
        ]),
        speed: { walk: { spd: "+10", enc: "+10" } },
        savetxt: { immune: ["nonmagical difficult terrain"] },
      },
      "intuitive schematic (helm)": {
        name: "Intuitive Schematic (Helm)",
        submenu: "Intuitive Schematic",
        description: desc([
          "The wearer gains a bonus to any Investigation or Perception checks it makes equal to your Exploit Die.",
        ]),
      },
      "intuitive schematic (melee weapon)": {
        name: "Intuitive Schematic (Weapon)",
        submenu: "Intuitive Schematic",
        description: desc(["Roll attack and damage with Intelligence"]),
        prereqeval: function (v) {
          schematics = GetFeatureChoice(
            "classes",
            "fighter(laserllama)",
            "subclassfeature3.1",
            true
          );

          if (schematics.indexOf("intuitive schematic (armor)") !== -1)
            return false;

          return true;
        },
        calcChanges: {
          atkAdd: [
            function (fields, v) {
              if (
                !v.isSpell &&
                v.isMeleeWeapon &&
                !v.isDC &&
                /\bintuitive\b/i.test(v.WeaponTextName)
              ) {
                fields.Mod = 4;
                v.SchematicsApplied
                  ? (v.SchematicsApplied += 1)
                  : (v.SchematicsApplied = 1);
              }
            },
            "Intuitive weapon uses Intelligence for attack and damage rolls",
            651,
          ],
        },
      },
      "intuitive schematic (light/medium armor)": {
        name: "Intuitive Schematic (Light/Medium Armor)",
        submenu: "Intuitive Schematic",
        description: desc([
          "The wearer uses its Int, in place of its Dex for initiative rolls, and for calculatingits Armor Class while wearing this armor",
        ]),
        extraAC: [
          {
            name: "Intuitive Schematic (Light/Medium Armor)",
            mod: "max(Int-Dex|0)",
            text: "This armor use Int instead of Dex to AC calculation",
            stopeval: function (v) {
              return !v.wearingArmor || v.heavyArmor; // light/medium armor only
            },
          },
        ],
        addMod: {
          type: "skill",
          field: "Init",
          mod: "max(Int-Dex|0)",
          text: "I use my Int while wearing this armor for initiative",
        },
      },
      "radiant schematic (melee weapon)": {
        name: "Radiant Schematic (Melee Weapon)",
        submenu: "Radiant Schematic",
        description: desc([
          "As a bonus action, emit (or extinguish) 15 ft bright light and 15 dim light from this object, the light is sunlight if exposed to it the past day",
          "3 charges, regained each long rest, on hit, I can spend a charge to force the target to Con save or blinded for 1 min (extra save/turn)",
        ]),
        usages: 3,
        recovery: "long rest",
        calcChanges: {
          atkAdd: [
            function (fields, v) {
              if (
                !v.isSpell &&
                !v.isDC &&
                /\bradiant\b/i.test(v.WeaponTextName)
              ) {
                fields.Description +=
                  (fields.Description ? "; " : "") +
                  "Can expend charge to blind on hit";
                v.SchematicsApplied
                  ? (v.SchematicsApplied += 1)
                  : (v.SchematicsApplied = 1);
              }
            },
            "Can expend charge to blind on hit",
            652,
          ],
        },
      },
      "radiant schematic (armor/shield)": {
        name: "Radiant Schematic (Armor/Shield)",
        submenu: "Radiant Schematic",
        description: desc([
          "As a bonus action, emit (or extinguish) 15 ft bright light and 15 dim light from this object, the light is sunlight if exposed to it the past day",
          "3 charges, regained each long rest, as a reaction when hit, I can spend a charge to force attacker Con save or blinded for 1 min (extra save/turn)",
        ]),
        usages: 3,
        recovery: "long rest",
      },
      "radiant schematic (object)": {
        name: "Radiant Schematic (object)",
        submenu: "Radiant Schematic",
        description: desc([
          "As a bonus action, emit (or extinguish) 15 ft bright light and 15 dim light from this object, the light is sunlight if exposed to it the past day",
        ]),
      },
      "rebounding schematic (non-heavy weapon)": {
        name: "Rebounding Schematic (Non-Heavy Weapon)",
        submenu: "Rebounding Schematic",
        description: desc([
          "The weapon gains Thrown (20/40 ft) and returns to the wielder's hand after an attack",
        ]),
        calcChanges: {
          atkAdd: [
            function (fields, v) {
              if (
                !v.isSpell &&
                !v.isDC &&
                /\brebounding\b/i.test(v.WeaponTextName) &&
                !/\btwo-handed\b/i.test(fields.Description)
              ) {
                if (!/\bthrown\b/i.test(fields.Description)) {
                  fields.Description =
                    "Thrown, " +
                    fields.Description.substr(0, 1).toLowerCase() +
                    fields.Description.substr(1);
                  fields.Range = "Melee, 20/40 ft";
                  v.isThrownWeapon = true;
                }
                v.SchematicsApplied
                  ? (v.SchematicsApplied += 1)
                  : (v.SchematicsApplied = 1);
              }
            },
            "Rebounding weapon gains Thrown (20/40 ft) property",
            653,
          ],
        },
      },
      "rebounding schematic (heavy armor)": {
        name: "Rebounding Schematic (Heavy Armor)",
        submenu: "Rebounding Schematic",
        description: desc([
          "As a reaction when hit by a melee attack, reduce dmg by Exploit Die + Int mod",
          "If the damage is reduced to 0, the attacker takes the full damage of the attack",
        ]),
        action: ["reaction", ""],
      },
      "rebounding schematic (boots)": {
        name: "Rebounding Schematic (Boots)",
        submenu: "Rebounding Schematic",
        description: desc([
          "If I ran 10 feet straight I can long jump up to 30 ft in a line even it would exceed my remaining speed",
          "I add my Int mod to high jump distance",
        ]),
        action: ["bonus action", ""],
      },
      "empowered schematic (heavy armor)": {
        name: "Empowered Schematic (Heavy Armor)",
        submenu: "Empowered Schematic [level 7+]",
        description: desc(["I can replace Str checks/saves with Int"]),
        prereqeval: function (v) {
          schematics = GetFeatureChoice(
            "classes",
            "fighter(laserllama)",
            "subclassfeature3.1",
            true
          );

          if (schematics.indexOf("empowered schematic (light armor)") !== -1)
            return false;

          return classes.known["fighter(laserllama)"].level >= 7;
        },
        addMod: [
          {
            type: "skill",
            field: "Athletics",
            mod: "max(Int-Str|0)",
            text: "I use my Int while wearing this armor for Str checks",
          },
          {
            type: "save",
            field: "Str",
            mod: "max(Int-Str|0)",
            text: "I use my Int while wearing this armor for Str saves",
          },
        ],
      },
      "empowered schematic (light armor)": {
        name: "Empowered Schematic (Light Armor)",
        submenu: "Empowered Schematic [level 7+]",
        description: desc([
          "Add my Int mod to initiative checks, replace Dex checks/saves with Int",
        ]),
        prereqeval: function (v) {
          schematics = GetFeatureChoice(
            "classes",
            "fighter(laserllama)",
            "subclassfeature3.1",
            true
          );

          if (schematics.indexOf("empowered schematic (heavy armor)") !== -1)
            return false;

          return classes.known["fighter(laserllama)"].level >= 7;
        },
        addMod: [
          {
            type: "skill",
            field: "Init",
            mod: "max(Int-Dex|0)",
            text: "I can use my Int while wearing this armor for initiative rolls",
          },
          {
            type: "skill",
            field: "Acrobatics",
            mod: "max(Int-Dex|0)",
            text: "I can use my Int while wearing this armor for Dex checks",
          },
          {
            type: "skill",
            field: "Stealth",
            mod: "max(Int-Dex|0)",
            text: "I can use my Int while wearing this armor for Dex checks",
          },
          {
            type: "skill",
            field: "Sleight of Hand",
            mod: "max(Int-Dex|0)",
            text: "I can use my Int while wearing this armor for Dex checks",
          },
          {
            type: "save",
            field: "Dex",
            mod: "max(Int-Dex|0)",
            text: "I can use my Int while wearing this armor for Dex saves",
          },
        ],
      },
      "empowered schematic (weapon)": {
        name: "Empowered Schematic (Weapon)",
        submenu: "Empowered Schematic [level 7+]",
        description: desc([
          "When the wielder hits a target with this weapon,it can treat any of the weapon's damage dice as their averageroll if they rolled lower: d4 (2), d6 (3), d8 (4), d10 (5), d12 (6)",
        ]),
        prereqeval: function (v) {
          return classes.known["fighter(laserllama)"].level >= 7;
        },
        calcChanges: {
          atkAdd: [
            function (fields, v) {
              if (
                !v.isSpell &&
                !v.isDC &&
                /\bempowered\b/i.test(v.WeaponTextName)
              ) {
                fields.Description +=
                  (fields.Description ? "; " : "") +
                  "Average roll if rolled lower: d4 (2), d6 (3), d8 (4), d10 (5), d12 (6)";
                v.SchematicsApplied
                  ? (v.SchematicsApplied += 1)
                  : (v.SchematicsApplied = 1);
              }
            },
            "On hit, treat any of the weapon's damage dice as their averageroll if they rolled lower: d4 (2), d6 (3), d8 (4), d10 (5), d12 (6)",
            654,
          ],
        },
      },
      "resilient schematic (weapon)": {
        name: "Resilient Schematic (Weapon)",
        submenu: "Resilient Schematic [level 7+]",
        description: desc([
          "On hit, if target is Large or smaller, it is knocked 5 ft back in straight line so long behind is unoccupied space",
        ]),
        prereqeval: function (v) {
          return classes.known["fighter(laserllama)"].level >= 7;
        },
        calcChanges: {
          atkAdd: [
            function (fields, v) {
              if (
                !v.isSpell &&
                !v.isDC &&
                /\bresilient\b/i.test(v.WeaponTextName)
              ) {
                var extraDmg =
                  Number(classes.known["fighter(laserllama)"].level) +
                  Number(What("Int Mod"));
                fields.Description +=
                  (fields.Description ? "; " : "") +
                  extraDmg +
                  " extra on a crit";
                v.SchematicsApplied
                  ? (v.SchematicsApplied += 1)
                  : (v.SchematicsApplied = 1);
              }
            },
            "Resilient weapon push 5 feet back each hit if there's space",
            655,
          ],
        },
      },
      "resilient schematic (magic armor)": {
        name: "Resilient Schematic (Magic Armor)",
        submenu: "Resilient Schematic [level 7+]",
        description: desc([
          "Adv. on save vs grappled or moved against its will",
          "Resistance to bludgeoning, piercing and slashing damage",
        ]),
        prereqeval: function (v) {
          schematics = GetFeatureChoice(
            "classes",
            "fighter(laserllama)",
            "subclassfeature3.1",
            true
          );

          if (
            schematics.indexOf("resilient schematic (non-magic armor)") !== -1
          )
            return false;

          return classes.known["fighter(laserllama)"].level >= 7;
        },
        dmgres: ["Bludgeoning", "Piercing", "Slashing"],
        savetxt: ["Adv. on save vs grappled or moved against my will"],
      },
      "resilient schematic (non-magic armor)": {
        name: "Resilient Schematic (Non-Magic Armor)",
        submenu: "Resilient Schematic [level 7+]",
        description: desc([
          "Adv. on save vs grappled or moved against its will",
          "Resistance to nonmagical bludgeoning, piercing and slashing damage",
        ]),
        prereqeval: function (v) {
          schematics = GetFeatureChoice(
            "classes",
            "fighter(laserllama)",
            "subclassfeature3.1",
            true
          );

          if (schematics.indexOf("resilient schematic (magic armor)") !== -1)
            return false;

          return classes.known["fighter(laserllama)"].level >= 7;
        },
        savetxt: ["Adv. on save vs grappled or moved against my will"],
        dmgres: ["Nonmag. Bludg.", "Nonmag. Piercing", "Nonmag. Slashing"],
      },
      "resilient schematic (helm)": {
        name: "Resilient Schematic (Helm)",
        submenu: "Resilient Schematic [level 7+]",
        description: desc([
          "Adv. on saves vs stunned, incapacitated",
          "Adv. on Con saves to maintain concentration",
        ]),
        prereqeval: function (v) {
          return classes.known["fighter(laserllama)"].level >= 7;
        },
        savetxt: [
          "Adv. on saves vs stunned, incapacitated",
          "Adv. on Con saves to maintain concentration",
        ],
      },
    },
    subclassfeature7: {
      name: "Increased Function",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "If I spent 10 teaching a creature, it can wield the special benefits of any item with my Schematics",
        "Objects modified by my Schematics count as magic for overcoming resistances and immunities",
        "I can modify magic weapons and armors with my Schematics",
      ]),
    },
    subclassfeature10: {
      name: "Inventive Synergy",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: levels.map(function (n) {
        if (n < 15)
          return desc([
            "I can apply two Schematics to one object, so long as it meets the prereq for both Schematics",
          ]);
        return desc(
          "I can apply up to three Schematics to one object, so long as it has the prereq for all of them"
        );
      }),
    },
    subclassfeature15: {
      name: "Flexible Innovation",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "At the end of a short rest, I can transfer a Schematic from one object to another, so long as the new object meets the prerequisites. If a Schematic has a limited amount of charges, the number of expended charges remains the same.",
        "Inventive Synergy Improved",
      ]),
    },
    subclassfeature18: {
      name: "Legendary Tinker",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc([
        "Weapons and armor modified by my Schematics get a +1 for each Schematics applied to it",
        "Regardless of its bonus before applying this bonus, the total cannot become more than +3",
      ]),
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (!v.isSpell && !v.isDC && v.SchematicsApplied) {
              if (
                CurrentFeats.known.indexOf("alternative weapon master") !== -1
              ) {
                fields.To_Hit_Bonus = Math.min(
                  fields.To_Hit_Bonus + v.SchematicsApplied,
                  3
                );
                fields.Damage_Bonus = Math.min(
                  fields.Damage_Bonus + v.SchematicsApplied,
                  3
                );
              } else {
                fields.To_Hit_Bonus = Math.min(
                  fields.To_Hit_Bonus + v.SchematicsApplied,
                  3
                );
                fields.Damage_Bonus = Math.min(
                  fields.Damage_Bonus + v.SchematicsApplied,
                  3
                );
              }
            }
          },
          "Weapons and armor modified by my Schematics get a +1 for each Schematics applied to it (but cannot be higher than +3)",
          800,
        ],
      },
    },
  },
});

// Witchblade
AddSubClass("fighter(laserllama)", "witchblade", {
  regExpSearch: /witchblade/i,
  subname: "Witchblade",
  fullname: "Witchblade",
  source: [["GMB:LL", 0]],
  abilitySave: 6,
  spellcastingFactor: "warlock3",
  spellcastingList: {
    spells: WitchbladeList,
  },
  spellcastingTable: [
    [0, 0, 0, 0, 0, 0, 0, 0, 0], //lvl 0
    [0, 0, 0, 0, 0, 0, 0, 0, 0], //lvl 1
    [0, 0, 0, 0, 0, 0, 0, 0, 0], //lvl 2
    [1, 0, 0, 0, 0, 0, 0, 0, 0], //lvl 3
    [2, 0, 0, 0, 0, 0, 0, 0, 0], //lvl 4
    [2, 0, 0, 0, 0, 0, 0, 0, 0], //lvl 5
    [2, 0, 0, 0, 0, 0, 0, 0, 0], //lvl 6
    [0, 2, 0, 0, 0, 0, 0, 0, 0], //lvl 7
    [0, 2, 0, 0, 0, 0, 0, 0, 0], //lvl 8
    [0, 2, 0, 0, 0, 0, 0, 0, 0], //lvl 9
    [0, 2, 0, 0, 0, 0, 0, 0, 0], //lvl10
    [0, 2, 0, 0, 0, 0, 0, 0, 0], //lvl11
    [0, 2, 0, 0, 0, 0, 0, 0, 0], //lvl12
    [0, 0, 2, 0, 0, 0, 0, 0, 0], //lvl13
    [0, 0, 2, 0, 0, 0, 0, 0, 0], //lvl14
    [0, 0, 2, 0, 0, 0, 0, 0, 0], //lvl15
    [0, 0, 2, 0, 0, 0, 0, 0, 0], //lvl16
    [0, 0, 2, 0, 0, 0, 0, 0, 0], //lvl17
    [0, 0, 2, 0, 0, 0, 0, 0, 0], //lvl18
    [0, 0, 0, 2, 0, 0, 0, 0, 0], //lvl19
    [0, 0, 0, 2, 0, 0, 0, 0, 0], //lvl20
  ],
  spellcastingKnown: {
    cantrips: [0, 0, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
    spells: [0, 0, 2, 2, 3, 3, 4, 4, 5, 5, 5, 5, 6, 6, 6, 6, 7, 7, 7, 7],
  },
  features: {
    subclassfeature3: {
      name: "Pact Magic",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I can cast warlock cantrips/spells that I know, using Charisma as my spellcasting ability",
        "I can replace a spell I know with another Witchblade spell when I gain a level",
        "I regain these spell slots on a short rest",
      ]),
      additional: [
        "",
        "",
        "1 cantrip \u0026 2 spells known",
        "1 cantrip \u0026 2 spells known",
        "1 cantrip \u0026 3 spells known",
        "1 cantrip \u0026 3 spells known",
        "1 cantrip \u0026 4 spells known",
        "1 cantrip \u0026 4 spells known",
        "1 cantrip \u0026 5 spells known",
        "2 cantrips \u0026 5 spells known",
        "2 cantrips \u0026 5 spells known",
        "2 cantrips \u0026 5 spells known",
        "2 cantrips \u0026 6 spells known",
        "2 cantrips \u0026 6 spells known",
        "2 cantrips \u0026 6 spells known",
        "2 cantrips \u0026 6 spells known",
        "2 cantrips \u0026 7 spells known",
        "2 cantrips \u0026 7 spells known",
        "2 cantrips \u0026 7 spells known",
        "2 cantrips \u0026 7 spells known",
      ],
    },
    "subclassfeature3.1": {
      name: "Sanguine Offering",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "Once per turn, I can expend one of my Fighter Hit Dice when I hit with a melee weapon attack to deal an additional 2 Exploit Die necrotic damage",
        "When I do, I take one Exploit Die necrotic damage that can't be reduced in any way",
      ]),
    },
    subclassfeature7: {
      name: "War Magic",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "When I cas a Witchblade spell with an action, I can make one weapon attack as a bonus action",
      ]),
      action: [["bonus action", "One Weapon Attack (War Magic)"]],
    },
    subclassfeature10: {
      name: "Otherworldly Step",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "When I use Second Wind, or I cast a Witchblade spell, I can teleport up to 60 ft to an unoccupied space I can see",
      ]),
    },
    subclassfeature15: {
      name: "Greater Offering",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "When I use Sanguine Offering, I gain temp HP equal to the necrotic dmg dealt to the creature",
        "Temp HP gained from this feature last for 1 min, or until I gain temp HP again",
      ]),
    },
    subclassfeature18: {
      name: "Legendary Witchblade",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc(
        "As a reaction when a creature dies within 30 ft of me, I can teleport 5 feet to it, plunge my weapon into it, and gain temp HP equal twice its CR"
      ),
      action: ["reaction", " (when a crea dies)"],
    },
  },
});

// Subclasses Alternate Ranger
// Beast Master
AddSubClass("ranger(laserllama)", "beast master", {
  regExpSearch:
    /^(?=.*beast)(?=.*master).*$/i,
  subname: "Beast Master",
  fullname: "Beast Master Conclave",
  source: [["GMB:LL", 0]],
  features: {
    subclassfeature3: {
      name: "Beast Master Spells",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description:
        "\n   " +
        "I learn certain spells. They are Ranger spells for me and don't count against my total of spells known and can't be replaced when I gain a level",
      spellcastingExtra: [
        "animal friendship", "beast bond",
        "beast sense", "warding bond",
        "haste", "protection from energy",
        "death ward", "freedom of movement",
        "awaken", "commune with nature",
      ],
    },
    "subclassfeature3.1": {
      name: "Primal Beast",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "When I finish a long rest, with a 1 hour ritual, I can summon a primal beast of the cave, land, sea, or sky in 5 ft",
        "I determine what animal it looks like, but it always has primal markings",
        "It is friendly to me and my allies, obeys my commands, and acts during my turn",
        "Unless I use a bonus action to command it, it only takes the Dodge action on its turn",
        "I can also forgo one attack of my Attack action to command it to take the Attack action",
        "It can take reactions and move on its turn even if I don't command it",
        "If I'm incapacitated, It acts on its own to defend both me and itself to the best of its abilities",
        " On 0 HP, it rolls the Death saves as a player",
        "If it is died, I can perform 1 hour ritual (can be part of short/long rest) to bring it back to life at 1 HP",
        "As a part of this ritual, it can expend Hit Dice to regain HP and I can change its form (choosing a different primal beast)",
      ]),
      action: [
        ["bonus action", " (command)"],
      ],
      creaturesAdd: [
        ["Beast of the Cave", false],
        ["Beast of the Land", true],
        ["Beast of the Sea", false],
        ["Beast of the Sky", false]
      ],
      creatureOptions: [
        {
          name: "Beast of the Cave",
          source: [["GMB:LL", 0]],
          size: 3,
          type: "Beast",
          alignment: "Neutral",
          ac: "11+Dex+Prof",
          hp: 20,
          hd: [3, 8],
          hdLinked: LL_Primal_Beast_Attributes.hdLinked,
          speed: "30 ft, burrow 10 ft",
          scores: [14, 14, 15, 8, 14, 11],
          senses: "Darkvision 60 ft",
          passivePerception: 12,
          languages: LL_Primal_Beast_Attributes.languages,
          challengeRating: "1/4",
          proficiencyBonus: 2,
          proficiencyBonusLinked: true,
          attacksAction: 1,
          attacks: [{
            name: "Claw",
            ability: 5,
            damage: [1, 6, "slashing"],
            modifiers: ["", "Prof"],
            range: "Melee (5 ft)",
          }],
          actions: [{
            name: "Tremorsense",
            description: "The Beast knows the location of anything in contact with the ground within 30 ft."
          }],
          features: LL_Primal_Beast_Attributes.features,
          traits: LL_Primal_Beast_Attributes.traits.map(function (n) {
            if (!typePF && /Bestial Focus/i.test(n.name)) {
              var a = newObj(n);
              a.description = "The beast's attacks count as magical.";
              return a;
            } else {
              return n;
            }
          }),
          addMod: LL_Primal_Beast_Attributes.addMod,
          calcChanges: LL_Primal_Beast_Attributes.calcChanges,
          minlevelLinked: LL_Primal_Beast_Attributes.hdLinked
        },
        {
          name: "Beast of the Land",
          source: [["GMB:LL", 0]],
          size: 3,
          type: "Beast",
          alignment: "Neutral",
          ac: "11+Dex+Prof",
          hp: 20,
          hd: [3, 8],
          hdLinked: LL_Primal_Beast_Attributes.hdLinked,
          speed: "40 ft, climb 40 ft",
          scores: [14, 14, 15, 8, 14, 11],
          senses: "Darkvision 60 ft",
          passivePerception: 12,
          languages: LL_Primal_Beast_Attributes.languages,
          challengeRating: "1/4",
          proficiencyBonus: 2,
          proficiencyBonusLinked: true,
          attacksAction: 1,
          attacks: [{
            name: "Maul",
            ability: 5,
            damage: [1, 8, "slashing"],
            modifiers: ["", "Prof"],
            range: "Melee (5 ft)",
            description: "+1 Quarry Die damage if hits after moving 20 ft straight in same round, see Charge",
            tooltip: "If the beast moves at least 20 feet straight toward a target and then hits it with a maul attack on the same turn, the target takes an extra Quarry Die slashing damage. If the target is a creature, it must succeed on a Strength saving throw against your spell save DC or be knocked prone.",
            useSpellMod: "ranger(laserllama)"
          }, {
            name: "Charge",
            ability: 5,
            damage: ["Str save", "", "Knocked prone"],
            range: "Melee (5 ft)",
            description: "Str save or knocked prone; Only if maul hits after moving 20 ft straight in same round",
            tooltip: "If the beast moves at least 20 feet straight toward a target and then hits it with a maul attack on the same turn, the target takes an extra Quarry Die slashing damage. If the target is a creature, it must succeed on a Strength saving throw against your spell save DC or be knocked prone.",
            abilitytodamage: false,
            dc: true,
            useSpellMod: "ranger(laserllama)"
          }],
          actions: [{
            name: "Charge",
            description: "If the beast moves at least 20 ft straight toward a target and then hits it with a maul attack on the same turn, the target takes an extra Quarry Die slashing damage. If the target is a creature, it must succeed on a Strength saving throw against my spell save DC or be knocked prone."
          }],
          features: LL_Primal_Beast_Attributes.features,
          traits: LL_Primal_Beast_Attributes.traits.map(function (n) {
            if (!typePF && /Bestial Focus/i.test(n.name)) {
              var a = newObj(n);
              a.description = "The beast's attacks count as magical.";
              return a;
            } else {
              return n;
            }
          }),
          addMod: LL_Primal_Beast_Attributes.addMod,
          calcChanges: LL_Primal_Beast_Attributes.calcChanges,
          minlevelLinked: LL_Primal_Beast_Attributes.hdLinked
        }, {
          name: "Beast of the Sea",
          source: [["GMB:LL", 0]],
          size: 3,
          type: "Beast",
          alignment: "Unaligned",
          ac: "11+Dex+Prof",
          hp: 20,
          hd: [3, 8],
          hdLinked: LL_Primal_Beast_Attributes.hdLinked,
          speed: "10 ft, swim 60 ft",
          scores: [14, 14, 15, 8, 14, 11],
          senses: "Darkvision 60 ft",
          passivePerception: 12,
          languages: LL_Primal_Beast_Attributes.languages,
          challengeRating: "1/4",
          proficiencyBonus: 2,
          proficiencyBonusLinked: true,
          attacksAction: 1,
          attacks: [{
            name: "Pseudopod",
            ability: 1,
            damage: [1, 6, "Bludgeoning"],
            modifiers: ["", "Prof"],
            range: "Melee (5 ft)",
            description: "On hit, target is grappled (escape DC is spell DC) and beast can't use attack on others",
            tooltip: "If the beast hits a target with its pesudopod, the target is grappled (escape DC equal to your spellcasting save DC). Until this grapple ends, the beast can't use this attack on another target.",
            useSpellMod: "ranger(laserllama)"
          }
          ],
          actions: [{
            name: "Amphibious",
            description: "The beast can breathe both air and water."
          }],
          features: LL_Primal_Beast_Attributes.features,
          traits: LL_Primal_Beast_Attributes.traits.map(function (n) {
            if (!typePF && /Bestial Focus/i.test(n.name)) {
              var a = newObj(n);
              a.description = "The beast's attacks count as magical.";
              return a;
            } else {
              return n;
            }
          }),
          addMod: LL_Primal_Beast_Attributes.addMod,
          calcChanges: LL_Primal_Beast_Attributes.calcChanges,
          minlevelLinked: LL_Primal_Beast_Attributes.hdLinked
        }, {
          name: "Beast of the Sky",
          source: [["GMB:LL", 0]],
          size: 4,
          type: "Beast",
          alignment: "Unaligned",
          ac: "10+Dex+Prof",
          hp: 16,
          hd: [3, 6],
          hdLinked: LL_Primal_Beast_Attributes.hdLinked,
          speed: "10 ft, fly 60 ft",
          scores: [6, 16, 13, 8, 14, 11],
          senses: "Darkvision 60 ft",
          passivePerception: 12,
          languages: LL_Primal_Beast_Attributes.languages,
          challengeRating: "1/4",
          proficiencyBonus: 2,
          proficiencyBonusLinked: true,
          attacksAction: 1,
          attacks: [{
            name: "Shred",
            ability: 2,
            damage: [1, 4, "slashing"],
            modifiers: ["", "Prof"],
            range: "Melee (5 ft)",
            useSpellMod: "ranger"
          }],
          actions: [{
            name: "Flyby",
            description: "The beast doesn't provoke opportunity attacks when it flies out of an enemy's reach."
          }],
          features: LL_Primal_Beast_Attributes.features,
          traits: LL_Primal_Beast_Attributes.traits.map(function (n) {
            if (!typePF && /Bestial Focus/i.test(n.name)) {
              var a = newObj(n);
              a.description = "The beast's attacks count as magical.";
              return a;
            } else {
              return n;
            }
          }),
          addMod: LL_Primal_Beast_Attributes.addMod,
          calcChanges: LL_Primal_Beast_Attributes.calcChanges,
          minlevelLinked: LL_Primal_Beast_Attributes.hdLinked
        }
      ],
      eval: function () {
        // Remove any ranger companion pages
        What("Template.extras.AScomp").split(",").forEach(function (prefix) {
          if (What(prefix + "Companion.Remember") === "companion") {
            DoTemplate("AScomp", "Remove", prefix, true)
          }
        });
      }
    },
    "subclassfeature3.2": {
      name: "Wild Empathy",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I learn the Wild Insight I knack, but it doesn't count against my Knacks Known",
        "If already known, I learn another Knack"
      ]),
      toNotesPage: [
        {
          // What is added to the notes page
          name:
            KnacksLL['wild insight i'].name,
          note: desc(KnacksLL['wild insight i'].description),
          amendTo: "Wild Empathy",
        },
      ],
    },
    subclassfeature7: {
      name: "Bestial Focus",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description:
        "My Primal Beast gains all benefits of my Ranger's Quarry, including any Knacks that enhance it, and its attack count as magical",
    },
    subclassfeature11: {
      name: "Exceptional Training",
      source: [["GMB:LL", 0]],
      minlevel: 11,
      description: desc([
        "Once per turn when I command my Primal Beast to use one of the attacks from its stat block, it can make two attacks"
      ]),
    },
    subclassfeature15: {
      name: "Primal Bond",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "When I cast a Ranger spell that targets myself, the Primmal Beast also gains the benefits as long as it is within 30 feet of me"
      ]),
    },
  },
});

// // Hunter 
AddSubClass("ranger(laserllama)", "hunter", {
  regExpSearch:
    /^(?=.*hunter).*$/i,
  subname: "Hunter",
  fullname: "Hunter Conclave",
  source: [["GMB:LL", 0]],
  features: {
    subclassfeature3: {
      name: "Hunter Spells",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description:
        "\n   " +
        "I learn certain spells. They are Ranger spells for me and don't count against my total of spells known and can't be replaced when I gain a level",
      spellcastingExtra: [
        "expeditious retreat", "snare",
        "locate creature", "pass without trace",
        "conjure volley", "nondetection",
        "faithful hound", "freedom of movement",
        "swift quiver", "tree stride"
      ],
    },
    "subclassfeature3.1": {
      name: "Ambuscade",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "When I roll initiative, I can use a reaction to take the Hide action or mark a crea as my Quarry",
        " If I'm suprised, I cannot take this reaction but I act as normal on my first turn of combat"
      ]),
      action: [["reaction", ""]],
    },
    "subclassfeature3.2": {
      name: "Silent Steps",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I learn the Stalker I knack, but it doesn't count against my Knacks Known",
        "If already known, I learn another Knack"
      ]),
      toNotesPage: [
        {
          // What is added to the notes page
          name:
            KnacksLL['stalker i'].name,
          note: desc(KnacksLL['stalker i'].description),
          amendTo: "Silent Steps",
        },
      ],
    },
    subclassfeature7: {
      name: "Cunning Parry",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description:
        "\n   When my Quarry attacks me, I can use a reaction to add my Wis mod (min of +1) to my AC against that attack" +
        "\n    If the attack miss, I can make a weapon attack against my Quarry as part of the same reaction",
      action: [["reaction", ""]]
    },
    "subclassfeature7.1": {
      name: "Relentless Hunter",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: "\n   " + "When my Quarry is slain, I can mark another crea I see as my Quarry (no actions) without expending a use of my Ranger's Quarry or spell slot",

    },
    subclassfeature11: {
      name: "Horde Breaker",
      source: [["GMB:LL", 0]],
      minlevel: 11,
      description: desc([
        "I gain the following features that I can use with an action, must have the required weapon equipped:",
        " \u2022 \x1bVolley.\x1b With a ranged weapon, I make a ranged attack in a point within weapon range. I make an attack action against each crea within 10 feet of that point. Must have ammunition for each target.",
        " \u2022 \x1bWhirlwind.\x1b With a melee weapon, I make one attack against each of any number of creas within my weapon reach"
      ]),
      action: [["action", "Volley (ranged weapon)"], ["action", "Whirlwind (melee weapon)"]]
    },
    subclassfeature15: {
      name: "Ruthless Focus",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "I add my Wis mod (min of +1) with all weapon attack rolls against my Quarry"
      ]),
      action: [["reaction", ""]],
    },
  },
});

// // Hunter 
AddSubClass("ranger(laserllama)", "monster slayer", {
  regExpSearch:
    /^(?=.*monster)(?=.*slayer).*$/i,
  subname: "Monster Slayer",
  fullname: "Monster Slayer Conclave",
  source: [["GMB:LL", 0]],
  features: {
    subclassfeature3: {
      name: "monster Slayer Spells",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description:
        "\n   " +
        "I learn certain spells. They are Ranger spells for me and don't count against my total of spells known and can't be replaced when I gain a level",
      spellcastingExtra: [
        "protection from evil and good", "bane",
        "moonbeam", "see invisibility",
        "magic circle", "protection from energy",
        "banishment", "faithful hound",
        "dispel evil and good", "hold monster"
      ],
    },
    "subclassfeature3.1": {
      name: "Knowledge of the Hunt",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I choose a type of knowledge in the Choose Feature button"
      ]),
      choices: ["Arcana", "History", "Nature", "Religion"],
      arcana: {
        description: desc([
          "I gain proficiency in Arcana",
          "As a bonus action, I can make an Arcana check against an Aberration, Dragon, or Monstrosity (DC 10 + CR) I can see within 30 feet",
          " On a success, I learn one of the its following characteristics (my choice):",
          " Highest Ability Score, Damage vulnerabilities, Damage Resistances or Immunities, Condition Immunities, or another weakness it may have",
          " If the characteristic you choose doesn't apply the DM reveals another characteristic to me",
          "If the analyzed crea is my Quarry, I add my Quarry Die to the check"
        ]),
        skills: ["Arcana"]
      },
      history: {
        name: "Knowledge of the Hunt (History)",
        description: desc([
          "I gain proficiency in History",
          "As a bonus action, I can make an History check against a Giant, or Humanoid (DC 10 + CR) I can see within 30 feet",
          " On a success, I learn one of the its following characteristics (my choice):",
          " Highest Ability Score, Damage vulnerabilities, Damage Resistances or Immunities, Condition Immunities, or another weakness it may have",
          " If the characteristic you choose doesn't apply the DM reveals another characteristic to me",
          "If the analyzed crea is my Quarry, I add my Quarry Die to the check"
        ]),
        skills: ["History"]
      },
      nature: {
        name: "Knowledge of the Hunt (Nature)",
        description: desc([
          "I gain proficiency in Nature",
          "As a bonus action, I can make an History check against a Beast, Elemental, Ooze, or Plant (DC 10 + CR) I can see within 30 feet",
          " On a success, I learn one of the its following characteristics (my choice):",
          " Highest Ability Score, Damage vulnerabilities, Damage Resistances or Immunities, Condition Immunities, or another weakness it may have",
          " If the characteristic you choose doesn't apply the DM reveals another characteristic to me",
          "If the analyzed crea is my Quarry, I add my Quarry Die to the check"
        ]),
        skills: ["Nature"]
      },
      religion: {
        name: "Knowledge of the Hunt (Religion)",
        description: desc([
          "I gain proficiency in Religion",
          "As a bonus action, I can make an History check against a Celestial, Fey, Fiend, or Undead (DC 10 + CR) I can see within 30 feet",
          " On a success, I learn one of the its following characteristics (my choice):",
          " Highest Ability Score, Damage vulnerabilities, Damage Resistances or Immunities, Condition Immunities, or another weakness it may have",
          " If the characteristic you choose doesn't apply the DM reveals another characteristic to me",
          "If the analyzed crea is my Quarry, I add my Quarry Die to the check"
        ]),
        skills: ["Religion"]
      },
      action: [["bonus action", ""]]
    },
    "subclassfeature3.2": {
      name: "Slayer's Cunning",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I learn the Slayer I knack, but it doesn't count against my Knacks Known",
        "If already known, I learn another Knack"
      ]),
      toNotesPage: [
        {
          // What is added to the notes page
          name:
            KnacksLL['slayer i'].name,
          note: desc(KnacksLL['slayer i'].description),
          amendTo: "Slayer's Cunning",
        },
      ],
    },
    subclassfeature7: {
      name: "Iron Focus",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description:
        "\n   When my Quarry force me to make a check or save, I add my Quarry Die to that roll"
    },
    subclassfeature11: {
      name: "Monster's Nemesis",
      source: [["GMB:LL", 0]],
      minlevel: 11,
      description: desc([
        "I treat damage immunities as resistances, and ignore damage resistances of my Quarry when I attack it with my weapon",
        " Moreover, when my Quarry misses me or I succeed on a save forced by it, I can use a reaction to make a single weapon attack against it"
      ]),
      action: [["reaction", ""]]
    },
    subclassfeature15: {
      name: "Ruthless Counter",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "When I see my Quarry attempt to cast a spell, telepor, or use anoter supernatural or magical ability, I can use a reaction to make a weapon attack against it",
        " On hit, the Quarry must succeed on a Wis save against my spell DC or that Quarry action fails to take effect",
        " On this hit with this reaction, I can choose to end the Ranger's Quarry on the target to make it automatically fail its save against this feature"
      ]),
      action: [["reaction", ""]],
    },
  },
});

// // Spellbreaker 
AddSubClass("ranger(laserllama)", "spellbreaker", {
  regExpSearch:
    /^(?=.*spellbreaker).*$/i,
  subname: "Spellbreaker",
  fullname: "Spellbreaker Conclave",
  source: [["GMB:LL", 0]],
  features: {
    subclassfeature3: {
      name: "Spellbreaker Spells",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description:
        "\n   " +
        "I learn certain spells. They are Ranger spells for me and don't count against my total of spells known and can't be replaced when I gain a level",
      spellcastingExtra: [
        "absorb elements", "detect magic",
        "blindness/deafness", "silence",
        "counterspell", "dispel magic",
        "arcane eye", "resilient sphere",
        "dispel evil and good", "wall of force"
      ],
    },
    "subclassfeature3.1": {
      name: "Spellsight",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "When I mark a crea as my Quarry, I learn its spellcasting ability (if any) and the level of the highest level spell it can cast",
        " If my Quarry is hidden from divination magic, such as by nondetection spell, it appears as if it can't cast spells"
      ]),
    },
    "subclassfeature3.2": {
      name: "Mage Breaker",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "Whenever I hit my Quarry with a weapon attack, it has disadvan. on Con save to maintain Conc. on spells",
        " Also, whenever I see or hear a crea attempt to cast a spell within my reach, I can opportunity attack it"
      ]),
      action: [["reaction", " (opportunity attack)"]]
    },
    subclassfeature7: {
      name: "Arcane Defense",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description:
        "\n   Whenever my Quarry forces me to make a save to resist a spell or another magical effect, I gain a bonus equal to my Wis mod (min of +1)" +
        "\n    Moreover, if that spell/magical deals damage, I take half damage on a fail and no damage on a success",
    },
    subclassfeature11: {
      name: "Spellbane",
      source: [["GMB:LL", 0]],
      minlevel: 11,
      description: desc([
        "Whenever I hit my Quarry with a weapon attack, I can expend a spell slot of 1-st level or higher. If I do, I deal one Quarry Die per spell slot expended extra Force damage",
        " Also whenever I cast counterspell or dispel magic, I add my Quarry Die to the ability check"
      ]),
      spellChanges: {
        "counterspell": {
          changes:
            "I add my Quarry Die to the ability check to counter the spell",
        },
        "dispel magic": {
          changes:
            "I add my Quarry Die to the ability check to dispel the magic",
        },
      },
    },
    subclassfeature15: {
      name: "Mantle of the Master",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "I am resistent to damage from spells and all other magical effects so long as I am not unconscious or incapacitated"
      ]),
      dmgres: [["Spells"]],
      savetxt: { text: "spell damage res as long as not incapacitated/unconscious" }
    },
    "subclassfeature15.1": {
      name: "Reflect Spell",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: "\n   " +
        "I can cast absorb elements at-will at 1st-level" +
        "\n   " + "After I cast absorb elements if my next melee weapon attack is against the crea whose spell I absorbed, I treat absorb elements damage as its max amount",
      spellChanges: {
        "absorb elements": {
          changes:
            "You can cast this spell at-will at 1st-level." +
            "\n After you cast this spell, if your next melee weaponattack is against the creature whose spell you absorbed, you treat this spell damage as its maximum amount",
        },
      },
    },
  },
});

// Deep Stalker (Gloom Stalker)
AddSubClass("ranger(laserllama)", "deep stalker", {
  regExpSearch:
    /^(?=.*deep)(?=.*stalker).*$/i,
  subname: "Deep Stalker",
  fullname: "Deep Stalker Conclave",
  source: [["GMB:LL", 0]],
  features: {
    subclassfeature3: {
      name: "Deep Stalker Spells",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description:
        "\n   " +
        "I learn certain spells. They are Ranger spells for me and don't count against my total of spells known and can't be replaced when I gain a level",
      spellcastingExtra: [
        "cause fear", "disguise self",
        "darkness", "invisibility",
        "fear", "nondetection",
        "greater invisibility", "phantasmal killer",
        "mislead", "seeming"
      ],
    },
    "subclassfeature3.1": {
      name: "Umbral Sight",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I gain Darkvision 60 feet. If I hae it already its range is increased by 30 feet",
      ]),
      vision: [["Darkvision", "fixed 60"], ["Darkvision", "+30"]],
    },
    "subclassfeature3.2": {
      name: "Dread Ambusher",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I gain a bonus to my initiative roll equal to my Wis mod (min of +1)",
        " Also, when I attack my first turn in combat, I can attack one additional time as part of that action",
        " On hit, it deals bonus damage equal to your level"
      ]),
      addMod: {
        type: "skill",
        field: "Init",
        mod: "max(Wis|1)",
        text: "I gain a bonus to my initiative roll equal to my Wis mod (min of +1)",
      },
    },
    subclassfeature7: {
      name: "Cloak of Shadows",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description:
        "While in darkness, I am invisible to creas that rely on darkvision to see me",
    },
    "subclassfeature7.1": {
      name: "Iron Mind",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: "\n   " + "I gain proficiency with Wis saves, or if I'm already proficient, either Int or Cha saves",
      saves: ["Wis"]
    },
    subclassfeature11: {
      name: "Precise Strike",
      source: [["GMB:LL", 0]],
      minlevel: 11,
      description: desc([
        "Once per turn, on a miss with a weapon attack, I can add my Quarry Die possibly turning the miss in a hit",
        " In addition, I can see through both magical and nonmagical darkness"
      ]),
      vision: [["Can see in magical and non magical darkness"]],
    },
    subclassfeature15: {
      name: "Deadly Counter",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "When a crea I can see targets me with an attack, I can use a reaction to impose disadv.",
        " If it miss me, I can make a weapon attack against the attacker as part of the same reaction",
        " In dim light or darkness, I have advan. on this special"
      ]),
      action: [["reaction", ""]],
    },
  },
});

// Drake Guard (Drakewarden)
AddSubClass("ranger(laserllama)", "drake guard", {
  regExpSearch: /^(?=.*drake)(?=.*guard).*$/i,
  subname: "Drake Guard",
  source: [["GMB:LL", 0]],
  fullname: "Drake Guard Conclave",
  features: {
    subclassfeature3: {
      name: "Drake Guard Spells",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description:
        "\n   " +
        "I learn certain spells. They are Ranger spells for me and don't count against my total of spells known and can't be replaced when I gain a level",
      spellcastingExtra: [
        "absorb elements", "command",
        "dragon's breath", "warding bond",
        "fear", "elemental weapon",
        "dominate beast", "elemental bane",
        "awaken", "conjure dragon"
      ],
    },
    "subclassfeature3.1": {
      name: "Wyrm Soul",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I learn the Draconic language",
        " Also, when I cast a Ranger spell that deals acid, cold, fire, lightning, or poison damage, I can choose to deal the damage of my Companion Essence instead"
      ]),
      languageProfs: ["Draconic"],
    },
    "subclassfeature3.2": {
      name: "Draconic Companion",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "My soul is bounded to a Draconic Companion",
        "I choose its Essence from: acid, cold, fire, lightning or poison",
        "It is friendly to me and my allies, obeys my commands, and acts during my turn",
        "Unless I use a bonus action to command it, it only takes the Dodge action on its turn",
        "I can also forgo one attack of my Attack action to command it to take the Attack action",
        "It can take reactions and move on its turn even if I don't command it",
        "If I'm incapacitated, It acts on its own to defend both me and itself to the best of its abilities",
        " On 0 HP, it rolls the Death saves as a player",
        "If it is died, I can perform 1 hour ritual (can be part of short/long rest) to bring it back to life at 1 HP",
        "As a part of this ritual, it can expend Hit Dice to regain HP",
      ]),
      action: [["bonus action", " (command)"]],
      creaturesAdd: [["Draconic Companion", true]],
      creatureOptions: [{
        name: "Draconic Companion",
        source: [["GMB:LL", 0]],
        size: 4,
        type: "Dragon",
        alignment: "Lawful Neutral",
        ac: "14+Prof",
        hp: 20,
        hd: [3, 8],
        hdLinked: ["ranger(laserllama)"],
        minlevelLinked: ["ranger(laserllama)"],
        speed: "30 ft; fly 30 ft",
        scores: [16, 12, 15, 8, 10, 14],
        saves: ["", 3, "", "", 4, ""],
        damage_immunities: "the chosen Draconic Essence damage type",
        senses: "Darkvision 60 ft",
        passivePerception: 10,
        languages: "Draconic, understands any languages spoken by the Drake Guard bound to it",
        challengeRating: "0",
        proficiencyBonus: 2,
        proficiencyBonusLinked: true,
        attacksAction: 1,
        attacks: [{
          name: "Claw",
          ability: 1,
          damage: [1, 4, "slashing"],
          modifiers: ["", "Prof"],
          range: "Melee (5 ft)",
          description: "+1d4 Essence damage",
          abilitytodamage: false
        }],
        features: [{
          name: "Guard",
          description: "The drake obeys the commands of its guard and shares its proficiency bonus. It takes its turn immediately after that of its guard, on the same initiative. It can move and take reactions on its own, but only takes the Dodge action on its turn unless its guard takes a bonus action to command it to take another action. If its guard is incapacitated, the drake can take any action, not just Dodge. The drake, when it is reduced to 0 hit points, it makes death saving thorws like a player character would." +
            "\n  If it dies, you can perform a 1-hour ritual, which can be during a short or long rest, that restores it to life with 1 HP. As part of this ritual, it can expend Hit Dice to regain HP."
        }],
        traits: [{
          name: "Draconic Essence",
          description: "Chosen when bounded: acid, cold, fire, lightning, or poison damage."
        }, {
          name: "Greater Companion (Drake Guard 7)",
          minlevel: 7,
          description: "The drake is now Medium and can be ridden as a mount. But its flying speed its halved while a rider is on its back. The drake's Claw attack deals now d6s instead of d4s",
          eval: function (prefix, lvl) {
            PickDropdown(prefix + "Comp.Desc.Size", 3); // Medium
            Value(prefix + "BlueText.Comp.Use.Attack.1.Damage Die", "1d6");
            Value(prefix + "Comp.Use.Attack.1.Description", "+1d6 Essence damage");
          },
          removeeval: function (prefix, lvl) {
            PickDropdown(prefix + "Comp.Desc.Size", 4); // Small
            Value(prefix + "BlueText.Comp.Use.Attack.1.Damage Die", "1d4");
            Value(prefix + "Comp.Use.Attack.1.Description", "+1d4 Essence damage");
          }
        }, {
          name: "Elemental Breath (Drake Guard 11)",
          minlevel: 11,
          description: "You or the drake can exhale the Elemental Breath (see in character weapons)",
        }, {
          name: "Mythic Companion (Drake Guard 15)",
          minlevel: 15,
          description: "Once per turn when you command it to attack, the drake can make two attacks instead of one. The drake can now as an action can change its size, choosing to be Small, Medium or Large. While Large its flying speed is no longer halved while it bears a rider",
          addMod: [{
            type: "",
            field: "Comp.Use.Attack.perAction",
            mod: 1,
            text: "At level 15, the companion can make 2 attacks as part of its Attack action."
          }],
          eval: function (prefix, lvl) {
            PickDropdown(prefix + "Comp.Desc.Size", 2); // Large

          },
          removeeval: function (prefix, lvl) {
            PickDropdown(prefix + "Comp.Desc.Size", 3); // Medium

          }
        }],
        calcChanges: {
          hp: function (totalHD, HDobj, prefix) {
            if (!classes.known["ranger(laserllama)"]) return;
            var rngrLvl = classes.known["ranger(laserllama)"].level;
            var rngrLvlM = 5 * rngrLvl;
            HDobj.alt.push(5 + rngrLvlM);
            HDobj.altStr.push(" = 5 as a base\n + 5 \xD7 " + rngrLvl + " from five times its guard's ranger level (" + rngrLvlM + ")");
          },
          setAltHp: true,
        },
      }]
    },
    "subclassfeature7": {
      name: "Greater Companion",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "My drake is now Medium, and can be ridden as long as I am Medium or smaller, but while ridden its flying speed is halved",
        "The drake's Claw attack deals now d6s instead of d4s",
      ]),
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (v.theWea.drakeWardenClaw && classes.known["ranger(laserllama)"]) {
              var rngrLvl = classes.known["ranger(laserllama)"].level;
              fields.Damage_Die = rngrLvl < 7 ? '1d4' : '1d6';
              fields.Description = rngrLvl < 7 ? '+1d4 Essence damage' : '+1d6 Essence damage';
            };
          },
          "",
          1
        ],
      }
    },
    "subclassfeature11": {
      name: "Elemental Breath",
      source: [["GMB:LL", 0]],
      minlevel: 11,
      description: desc([
        "As an action, I can cause my drake or myself to exhale a 30-ft cone breath weapon",
        "Its damage type is the same of its Essence; Dex save to halve the damage",
        "If I have no uses left, I can expand a 3rd-level or higher spell slot (SS 3+) to use it again"
      ]),
      additional: levels.map(function (n) {
        return n < 11 ? "" : (n < 15 ? 8 : 10) + "d6 damage";
      }),
      action: [["action", ""]],
      usages: "Wis mod per",
      usagescalc: "event.value = Math.max(1, What('Wis Mod'));",
      recovery: "long rest",
      altResource: "SS 3+",
      weaponOptions: [{
        regExpSearch: /^(?=.*elemental)(?=.*breath).*$/i,
        name: "Elemental Breath",
        source: [["GMB:LL", 0]],
        ability: 5,
        type: "Natural",
        damage: [8, 6, "Essence"],
        range: "30-ft cone",
        description: "Hits all in area; Dex save for half damage; Damage type: equal to its Essence",
        abilitytodamage: false,
        dc: true,
        useSpellMod: "ranger(laserllama)",
        DrakewardenDrakeBreath: true,
        selectNow: true
      }],
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (v.theWea.DrakewardenDrakeBreath && classes.known["ranger(laserllama)"]) {
              var rngrLvl = classes.known["ranger(laserllama)"].level;
              fields.Damage_Die = (rngrLvl < 15 ? 8 : 10) + 'd6';
            };
          },
          "",
          1
        ],
      }
    },
    "subclassfeature15": {
      name: "Perfected Bond",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "My Draconic Companion, once per turn when I command it to attack, it can make two attacks instead of one.",
        " As an action it can change its size between Small, Medium and Large",
        " While it is Large, its flying speed it is not halved while ridden",
      ]),
    }
  }
});

// // Fey Wanderer 
AddSubClass("ranger(laserllama)", "fey wanderer", {
  regExpSearch:
    /fey[\s\-]?wanderer(?:\s*\(?(ll|laserllama|hb)?\)?)?/i,
  subname: "Fey Wanderer (LL)",
  fullname: "Fey Wanderer Conclave",
  source: [["GMB:LL", 0]],
  features: {
    subclassfeature3: {
      name: "Fey Wanderer Spells",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description:
        "\n   " +
        "I learn certain spells. They are Ranger spells for me and don't count against my total of spells known and can't be replaced when I gain a level",
      spellcastingExtra: [
        "cause fear", "charm person",
        "enthrall", "misty step",
        "conjure fey", "dispel magic",
        "charm monster", "dimension door",
        "geas", "mislead"
      ],
    },
    "subclassfeature3.1": {
      name: "Beguiling Strikes",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I can choose to deal Psychic damage with my Ranger's Quarry",
        " If I deal this damage to my Quarry, it has disadv. on all attacks rolls against other targets than me until the start of my next turn"
      ]),
    },
    "subclassfeature3.2": {
      name: "Otherworldly Mystique",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I gain proficiency in one of the following: Deception, Performance, or Persuasion",
        " Also, I add my Wis mod (min of +1) to all my Charisma checks"
      ]),
      skillstxt: "Choose one: Deception, Performance, or Persuasion",
      addMod: [
        { type: "skill", field: "Persuasion", mod: "max(Wis|1)", text: "I add my Wis mod (min of +1) to all my Charisma checks" },
        { type: "skill", field: "Performance", mod: "max(Wis|1)", text: "I add my Wis mod (min of +1) to all my Charisma checks" },
        { type: "skill", field: "Deception", mod: "max(Wis|1)", text: "I add my Wis mod (min of +1) to all my Charisma checks" },
        { type: "skill", field: "Intimidation", mod: "max(Wis|1)", text: "I add my Wis mod (min of +1) to all my Charisma checks" },
      ],
    },
    subclassfeature7: {
      name: "Whimsical Ward",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description:
        "\n   I have advan. on saves to resist being charmed or frightened" +
        "\n    Also, when a crea I can see within 30 ft makes a saves against these conditions, I can use my reaction to force another crea I can see within 60 ft to make a Wis save" +
        "\n    On a fail, it is charmed or frightened (my choice) of me for 1 min. It can repeat the save at the end of its turns",
      savetxt: {
        adv_vs: ["charmed", "frightened"]
      },
      action: [["reaction", ""]]
    },
    subclassfeature11: {
      name: "Faerie Guardian",
      source: [["GMB:LL", 0]],
      minlevel: 11,
      description: desc([
        "Once per long rest, I can cast Conjure Fey without material components or concentration, but its duration is reduced to 1 min"
      ]),
      spellChanges: {
        "conjure fey": {
          changes:
            "Once per long rest, I can cast Conjure Fey without material components or concentration, but its duration is reduced to 1 minute",
        },
      },
      usages: 1,
      recovery: "long rest"
    },
    subclassfeature15: {
      name: "Mirthful Step",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "I can cast Wis mod (min of 1) times the Misty Step spell without using spell slots",
        " Also when I cast Misty Step I can touch a willing creature within 5 ft to teleport it along with me. It reappears in an unoccupied space within 5 ft of where I reappear"
      ]),
      spellChanges: {
        "Misty Step": {
          changes:
            "I can cast Wis mod (min of 1) times this spell without using spell slots.\n Also, I can touch a willing creature within 5 ft of me to teleport it along with me. It reappears in an unoccupied space within 5 ft of where I reappear",
        },
      },
      usages: "Wis mod per",
      usagescalc: "event.value = Math.max(1, What('Wis Mod'));",
      recovery: "long rest"
    },
  },
});

// // Planar Warden (Horizon Walker) 
AddSubClass("ranger(laserllama)", "planar warden", {
  regExpSearch:
    /^(?=.*planar)(?=.*warden).*$/i,
  subname: "Planar Warden",
  fullname: "Planar Warden Conclave",
  source: [["GMB:LL", 0]],
  features: {
    subclassfeature3: {
      name: "Planar Warden Spells",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description:
        "\n   " +
        "I learn certain spells. They are Ranger spells for me and don't count against my total of spells known and can't be replaced when I gain a level",
      spellcastingExtra: [
        "alarm", "protection from evil and good",
        "misty step", "rope trick",
        "haste", "magic circle",
        "banishment", "dimension door",
        "planar binding", "teleportation circle"
      ],
    },
    "subclassfeature3.1": {
      name: "Extraplanar Senses",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "As an action I can sense creature alien to my current plane or planar portal within 1 mile",
        "As part od thi action I can exclude targets of my choice",
        " If I have no uses left I can expend a spell slot of 1st-level or higher (SS 1+)"
      ]),
      usages: 1,
      recovery: "short rest",
      altResource: "SS 1+",
      action: [["action", ""]],
    },
    "subclassfeature3.2": {
      name: "Planar Warrior",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I can choose to deal Force damage with my Ranger's Quarry",
        "Moreover, marking a crea alien of my current plane cost me no uses of Ranger's Quarry"
      ]),
    },
    subclassfeature7: {
      name: "Ethereal Step",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description:
        "When I take the Attack Action, I can teleport up to 10 ft before each attack" +
        " I must teleport in an unoccupied space I can see and any distance I teleport with this feature counts against my total movement for my turn",
    },
    subclassfeature11: {
      name: "Empowered Strikes",
      source: [["GMB:LL", 0]],
      minlevel: 11,
      description: desc([
        "If I use my Ethereal Step and I attack two diff crea, I can make one additional attack vs. a third crea",
        " In addition, when I use Ethereal Step and then make an attack, I can choose to deal force damage"
      ]),
    },
    subclassfeature15: {
      name: "Ethereal Defense",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "When I take damage from an attack or spell I can see, I can use a reaction to gain resistance to the damage of that attack or spell for this turn"
      ]),
      action: [["reaction", ""]],
    },
  },
});

// // Swarm Keeper (Swarmkeeper) 
AddSubClass("ranger(laserllama)", "swarm keeper", {
  regExpSearch:
    /^(?=.*swarm)(?=.*keeper).*$/i,
  subname: "Swarm Keeper",
  fullname: "Swarm Keeper Conclave",
  source: [["GMB:LL", 0]],
  features: {
    subclassfeature3: {
      name: "Swarm Keeper Spells",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description:
        "\n   " +
        "I learn certain spells. They are Ranger spells for me and don't count against my total of spells known and can't be replaced when I gain a level",
      spellcastingExtra: [
        "entangle", "faerie fire",
        "spider climb", "web",
        "fly", "gaseous form",
        "arcane eye", "giant insect",
        "arcane hand", "insect plague"
      ],
    },
    "subclassfeature3.1": {
      name: "Symbiotic Swarm",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map((n) => {
        if (n < 11) {
          return desc([
            "I learn the mage hand cantrip but it manifests as part of my swarm",
            "Also, I can use a bonus action to command my swarm to do one the following:",
            " \x1bBiting Assualt.\x1b One crea of my choice within 30 ft, Dex save or 2 Quarry Dice of pierc./poison dmg",
            " \x1bHarrying Horde.\x1b One crea of my choice within 30 ft, Str save or moved 15 feet (Large+ creas have advan. on save)",
            " \x1bSwarm Step.\x1b I move 15 ft in a direction of my choice without provoking opportunity attacks",
          ]);
        }
        return desc([
          "I learn the mage hand cantrip but it manifests as part of my swarm",
          "Also, I can use a bonus action to command my swarm to do one the following:",
          " \x1bBiting Assualt.\x1b One crea of my choice within 30 ft, Dex save or 2 Quarry Dice of pierc./poison dmg and it is poisoned until the start of my next turn",
          " \x1bHarrying Horde.\x1b One crea of my choice within 30 ft, Str save or moved 15 feet and knocked prone (Large+ creas have advan. on save)",
          " \x1bSwarm Step.\x1b I move 15 ft in a direction of my choice without provoking opportunity attacks and I gain half cover benefit until the start of my next turn",
        ]);
      }),
      action: [
        ["bonus action", "Biting Assualt"],
        ["bonus action", "Harrying Horde"],
        ["bonus action", "Swarm Step"],
      ],
      spellChanges: {
        "mage hand": {
          changes:
            "Instead of a hand, the spell manifest as a part of your swam separating from you",
        },
      },
      spellcastingBonus: [
        {
          name: "Symbiotic Swarm",
          spells: ["mage hand"],
          selection: ["mage hand"],
        },
      ]
    },
    subclassfeature7: {
      name: "Writhing Horde",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description:
        "\n   I have climb speed equal to walk speed and I can clim on sheer surfaces and upside down on ceilings without making checks" +
        "\n     Also, whenever I make Str(Athletics) checks to shove or grapple, or to resist grapple, I add my Quarry Die",
      speed: { climb: { spd: "walk" } }
    },
    subclassfeature11: {
      name: "Greater Swarm",
      source: [["GMB:LL", 0]],
      minlevel: 11,
      description: desc([
        "My Quarry has disadv. against my Symbiotic Swarm features",
        " My Symbiotic Swarm is improved (see it)"
      ]),
    },
    subclassfeature15: {
      name: "One with the Swarm",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "When I take damage from a source I can see I can use a reaction to have resistance to that damage and then teleport to an unoccupied space within 30 ft",
        " If I have no uses left I can expend a spell slot or higher (SS 1+) to use it again"
      ]),
      action: [["reaction", ""]],
      usages: "Wis mod per",
      usagescalc: "event.value = Math.max(1, What('Wis Mod'));",
      recovery: "short rest",
      altResource: "SS 1+",
    },
    "subclassfeature15.1": {
      name: "Swarm Master",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "I can cast one of my Swarm Keeper Spells without using a spell slot or requiring the normal components"
      ]),
      usages: 1,
      recovery: "short rest",
    },
  },
});

// // Bounty Hunter 
AddSubClass("ranger(laserllama)", "bounty hunter", {
  regExpSearch:
    /^(?=.*bounty)(?=.*hunter).*$/i,
  subname: "Bounty Hunter",
  fullname: "Bounty Hunter Conclave",
  source: [["GMB:LL", 0]],
  features: {

    subclassfeature3: (function () {
      // Fixed attributes
      MartialExploits = {
        name: "Martial Exploits",
        minlevel: 2,
        abilitySave: 1,
        abilitySaveAlt: 2,
        source: [["GMB:LL", 0]],
        description: desc([
          "I gain Exploit Dice, which are used to fuel my Martial Exploits",
          'Use the "Choose Feature" button above to choose Martial Exploits',
        ]),
        toNotesPage: [
          {
            name: "Martial Exploits",
            note: desc([
              "Below are all Martial Exploits I know. Each 3rd and 4th degree exploits can only be used once per short rest. Each 5th degree exploit can only be used once per long rest.",
            ]),
          },
        ],

        // Martial Exploits
        extraname: "Martial Exploits",
        extraTimes: [
          "",
          "",
          2,
          2,
          3,
          3,
          4,
          4,
          4,
          4,
          5,
          5,
          5,
          5,
          6,
          6,
          6,
          6,
          7,
          7,
        ],
        extrachoices: [],

        // Exploit dice
        // limfeaname: "Exploit Dice",
        // usages: ["", "", 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4],
        // additional: [
        //   "",
        //   "",
        //   "d4",
        //   "d4",
        //   "d4",
        //   "d4",
        //   "d6",
        //   "d6",
        //   "d6",
        //   "d6",
        //   "d6",
        //   "d6",
        //   "d6",
        //   "d6",
        //   "d8",
        //   "d8",
        //   "d8",
        //   "d8",
        //   "d8",
        //   "d8",
        // ],
        // recovery: "short rest",
      };

      // Make a filtered spell list that contains only Fighter(laserllama) "spells"
      const FighterSpells = Object.keys(SpellsList)
        .filter((key) => SpellsList[key].isExploit && SpellsList[key].level < 4)
        .filter((key) => {
          for (var i = 0; i < SpellsList[key].classes.length; i++) {
            if (SpellsList[key].classes[i] == "fighter(laserllama)")
              return true;
          }
          return false;
          // NOTE: this is literally a SpellsList[key].classes.includes("fighter(laserllama)") but for some cursed reason I can't use that function
        });

      // Iterate over all Fighter(laserllama) "spells"
      for (var i = 0; i < FighterSpells.length; i++) {
        var NewSpell = SpellsList[FighterSpells[i]];
        var tempSpell = FighterSpells[i];

        MartialExploits.extrachoices.push(NewSpell.name); // Add "spell" name to menu options

        MartialExploits[FighterSpells[i]] = {
          // Add "spell" to the main item (when it is picked through the menu)
          name: NewSpell.name,
          toNotesPage: [
            {
              // What is added to the notes page
              name:
                NewSpell.name +
                " Exploit [" +
                (NewSpell.level == 1
                  ? "1st"
                  : NewSpell.level == 2
                    ? "2nd"
                    : NewSpell.level == 3
                      ? "3rd"
                      : NewSpell.level + "th") +
                " degree]",
              note: desc(NewSpell.descriptionFull),
              amendTo: "Martial Exploits",
            },
          ],
          source: NewSpell.source,
          addMod: NewSpell.addMod,
          submenu: NewSpell.submenu,
          prereqeval: ExploitPrereqFactoryBountyHunter(
            FighterSpells[i],
            "ranger(laserllama)"
          ),
          eval: CreateMartialSpellsheet,
          spellcastingBonusElsewhere: {
            addTo: "martial exploits",
            spellcastingBonus: {
              name: "Martial Exploits",
              spellcastingAbility: 1,
              spells: [FighterSpells[i]],
              selection: [FighterSpells[i]],
            },
          },
        };
      }

      return MartialExploits;
    })(),

    "exploit dice": {
      name: "Exploit Dice",
      description: "I have a pool of dice to fuels my Exploits. They may change in size and number with a multiclass",
      minlevel: 3,
      eval: function () {
        var bountyEDs = calcExploitDice();
        AddFeature("Exploit Dice", bountyEDs.usages, " (" + bountyEDs.additional + ")", "short rest", "Bounty Hunter");
      },
      changeeval: function () {
        var bountyEDs = calcExploitDice();
        AddFeature("Exploit Dice", bountyEDs.usages, " (" + bountyEDs.additional + ")", "short rest", "Bounty Hunter");
      },
      removeeval: function () {
        var bountyEDs = calcExploitDice();
        AddFeature("Exploit Dice", bountyEDs.usages, " (" + bountyEDs.additional + ")", "short rest", "Bounty Hunter");
      },
    },
    "subclassfeature3.1": {
      name: "Dead or Alive",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I add my Quarry Die to Str(Athletics) grapple or shove my Quarry",
        " Also, being within 5 ft of a crea doesn't give me disadv. attacking with nets"
      ]),
    },
    "subclassfeature3.2": {
      name: "Ear to the Ground",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "After a long rest in a settlement, I have advan. on all checks to gather information on its contacts, factions, or underworld"
      ]),
    },
    subclassfeature7: {
      name: "Cunning Technique",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description:
        "\n   One per turn, I can force my Quarry to do a save against my Exploits with disadv." +
        "\n    Also, I learn Thieves' Cant",
      languageProfs: ["Thieves' Cant"]
    },
    subclassfeature11: {
      name: "Unwavering",
      source: [["GMB:LL", 0]],
      minlevel: 11,
      description: desc([
        "When my Quarry miss me with a melee attack, I can force it to make a Dex save against my Expl DC as a reaction",
        " On a fail, it suffers one of the following (my choice):",
        " \u2022 I can knock it prone if it is Large or smaller",
        " \u2022 I can automatically grapple it if I have a free hand",
        " \u2022 I can make a single melee weapon attack against it"
      ]),
      action: [["reaction", ""]]
    },
    subclassfeature15: {
      name: "Most Dangerous Game",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "Once per turn, when I take damage from my Quarry, I can reduce the damage by one Quarry Die"
      ]),
    },
  },
});

// // Buccaneer 
AddSubClass("ranger(laserllama)", "buccaneer", {
  regExpSearch:
    /^(?=.*buccaneer).*$/i,
  subname: "Buccaneer",
  fullname: "Buccaneer Conclave",
  source: [["GMB:LL", 0]],
  features: {
    subclassfeature3: {
      name: "Buccaneer Spells",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description:
        "\n   " +
        "I learn certain spells. They are Ranger spells for me and don't count against my total of spells known and can't be replaced when I gain a level",
      spellcastingExtra: [
        "compelled duel", "fog cloud",
        "gust of wind", "misty step",
        "call lightning", "water breathing",
        "control water", "watery sphere",
        "control winds", "maelstrom"
      ],
    },
    "subclassfeature3.1": (function () {
      // copies the main class feature, avoids having to copy all fighting styles
      var FSfea = newObj(
        ClassList["ranger(laserllama)"].features["fighting style"]
      );

      FSfea.name = "Sea Legs";
      FSfea.source = [["GMB:LL", 0]];
      FSfea.minlevel = 3;
      FSfea.description = desc([
        "I learn the Mariner Fighting Style. Another one if already knew it",
        "I learn the Aquatic Adept Knack. Another one if already knew it",
        "I add my Quarry Die on Wis(Perception) checks that relies on sight"
      ]);

      FSfea.extraname = "Sea Legs Fighting Style";
      FSfea.extrachoices = FSfea.choices;
      FSfea.extraTimes = 1;
      FSfea.choices = undefined;
      FSfea.toNotesPage = [
        {
          name:
            KnacksLL['aquatic adept'].name,
          note: desc(KnacksLL['aquatic adept'].description),
          amendTo: "Sea Legs Knack",
        },
      ];

      return FSfea;
    })(),
    subclassfeature7: {
      name: "Windswept Hide",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description:
        "\n   I gain resistance to cold, lightning and thunder damage" +
        "\n    I add my Quarry Die to check or save to resit being knocked prone or moved against my will",
      dmgres: ["Cold", "Lightning", "Thunder"]
    },
    subclassfeature11: {
      name: "Wrath of the Sea",
      source: [["GMB:LL", 0]],
      minlevel: 11,
      description: desc([
        "Once per turn, when I hit a crea with a waepon attack, I can force it to make a Str save against my save DC",
        " On a failed save, it takes one Quarry Die cold and is knocked back 10 ft in a straight line"
      ]),
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (v.isWeapon) {
              fields.Description += (fields.Description ? '; ' : '') + 'Once per turn, Str save or 1Quarry Die Cold and knocked back 10 ft';
            };
          },
          ""
        ]
      }
    },
    subclassfeature15: {
      name: "Watery Resilience",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "As a reaction when I take damage by a weapon attack, I halve that damage",
        "I can then also move up to 10 ft without provoking opportunity attacks"
      ]),
      action: [["reaction", ""]],
    },
  },
});

// // Grim Warden 
AddSubClass("ranger(laserllama)", "grim warden", {
  regExpSearch:
    /^(?=.*grim)(?=.*warden).*$/i,
  subname: "Grim Warden",
  fullname: "Grim Warden Conclave",
  source: [["GMB:LL", 0]],
  features: {
    subclassfeature3: {
      name: "Grim Warden Spells",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description:
        "\n   " +
        "I learn certain spells. They are Ranger spells for me and don't count against my total of spells known and can't be replaced when I gain a level",
      spellcastingExtra: [
        "bane", "hex",
        "hold person", "shadow blade",
        "bestow curse", "vampiric touch",
        "blight", "shadow of moil",
        "enervation", "hold monster"
      ],
    },
    "subclassfeature3.1": {
      name: "Warden's Rite",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I gain proficiency in Religion and Alchemist's Supplies, and I add my Quarry Die on checks with these proficiency",
        " I gain 3 max HP and 1 more each time I gain a ranger level",
        " I count as a humanoid and monstrosity for magical purposes"
      ]),
      toolProfs: ["Alchemist's Supplies"],
      skills: ["Religion"],
      calcChanges: {
        hp: function (totalHD) {
          if (classes.known["ranger(laserllama)"]) {
            return [
              classes.known["ranger(laserllama)"].level,
              "Warden's Rite (ranger level)",
            ];
          }
        },
      },
    },
    "subclassfeature3.2": {
      name: "Crimson Mark",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map((n) => {
        if (n < 11) {
          return desc([
            "I can reduce my current and max HP by one roll of Quarry Die to mark a Quarry",
            "I don't expend my Ranger's Quarry when I do so and this reduction last until my next long rest",
            "For the duration, I can choose to deal Necrotic damage with the Quarry Die bonus damage to my Quarry",
            "This Necrotic damage ignores resistance and trats immunity as resistance",
            "When I deal Necrotic damage to my Quarry in this way, It cannot regain hit points for the next minute"
          ]);
        }
        return desc([
          "I can reduce my current and max HP, by rolling two Quarry Dice and use the lower result, to mark a Quarry",
          "I don't expend my Ranger's Quarry when I do so and this reduction last until my next long rest",
          "For the duration, I can choose to deal Necrotic damage with the Quarry Die bonus damage to my Quarry",
          "This Necrotic damage ignores resistance and trats immunity as resistance",
          "When I deal Necrotic damage to my Quarry in this way, It cannot regain hit points for the next minute"
        ]);
      }),
      action: [["bonus action", ""]]
    },
    subclassfeature7: {
      name: "Dark Augmentation",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description:
        "\n   My walk speed increases by 10 ft" +
        "\n    Whenever I make a Str, Dex, or Con check, I add my Quarry Die",
      speed: { walk: { spd: "+10", enc: "+10" } },
    },
    subclassfeature11: {
      name: "Greater Crimson Mark",
      source: [["GMB:LL", 0]],
      minlevel: 11,
      description: desc([
        "Once per turn, when you hit a crea with melee weapon attack I can deal extra 1d10 necrotic damage to it"
      ]),
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (v.isWeapon && v.isMeleeWeapon) {
              fields.Description += (fields.Description ? '; ' : '') + 'Once per turn, +1d10 Necrotic dmg';
            };
          },
          ""
        ]
      }
    },
    "subclassfeature11.1": {
      name: "Sinister Resilience",
      source: [["GMB:LL", 0]],
      minlevel: 11,
      description: desc([
        "I gain resistance in Necrotic damage and my Crimson Mark is improved (see it)"
      ]),
      dmgres: ["Necrotic"],
    },
    subclassfeature15: {
      name: "Sanguine Mastery",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "I have advan. on saves to resist the frightened condition",
        "I'm always under the effect of Protection from Evil and Good while conscious"
      ]),
      savetxt: { adv_vs: ["frightened"] },
    },
  },
});

// // Nomad 
AddSubClass("ranger(laserllama)", "nomad", {
  regExpSearch:
    /^(?=.*nomad).*$/i,
  subname: "Nomad",
  fullname: "Nomad Conclave",
  source: [["GMB:LL", 0]],
  features: {
    subclassfeature3: {
      name: "Nomad Spells",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description:
        "\n   " +
        "I learn certain spells. They are Ranger spells for me and don't count against my total of spells known and can't be replaced when I gain a level",
      spellcastingExtra: [
        "comprehend languages", "disguise self",
        "detect thoughts", "misty step",
        "clairvoyance", "tongues",
        "dimension door", "divination",
        "commune", "seeming"
      ],
    },
    "subclassfeature3.1": {
      name: "Expunging Strikes",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "Once per turn, when I hit my Quarry with a weapon attack I can force it to an Int save",
        "On a failure, my attack damage becomes Psychic damage and the Quarry can't see, hear, or sense me in any way until the satrt of my next turn"
      ]),
    },
    "subclassfeature3.2": (function () {
      var MysticKnowledge = {
        name: "Mystic Knowledge",
        source: [["GMB:LL", 0]],
        minlevel: 3,
        description: levels.map((n) => {
          if (n < 11) {
            return desc([
              "Each time I finish a long rest, I can choose to be proficient with a skill, or tool, or learn a language",
              'Use the "Choose Feature" button above to choose the Mystic Knowledge',
            ]);
          }
          return desc([
            "Each time I finish a long rest, I can choose to be proficient with up to two bewteen skills, or tools, or learn up to two languages",
            'Use the "Choose Feature" button above to choose the Mystic Knowledge',
          ])
        }),
        extrachoices: [],
        extraname: "Mystic Knowledge",
        extraTimes: levels.map((n) => {
          return n < 11 ? 1 : 2
        })
      };
      for (var t = 0; t < NomadKnowledgeTools.length; t++) {
        MysticKnowledge.extrachoices.push(NomadKnowledgeTools[t]);
        var choiceName = NomadKnowledgeTools[t].toLowerCase();
        MysticKnowledge[choiceName] = {
          submenu: "Tools",
          toolProfs: [NomadKnowledgeTools[t]]
        };
      }
      for (var l = 0; l < NomadKnowledgeLanguages.length; l++) {
        MysticKnowledge.extrachoices.push(NomadKnowledgeLanguages[l]);
        var choiceName = NomadKnowledgeLanguages[l].toLowerCase();
        MysticKnowledge[choiceName] = {
          submenu: "Languages",
          languageProfs: [NomadKnowledgeLanguages[l]]
        };
      }
      for (var s = 0; s < NomadKnowledgeSkills.length; s++) {
        MysticKnowledge.extrachoices.push(NomadKnowledgeSkills[s]);
        var choiceName = NomadKnowledgeSkills[s].toLowerCase();
        MysticKnowledge[choiceName] = {
          submenu: "Skills",
          skills: [NomadKnowledgeSkills[s]]
        };
      }
      return MysticKnowledge;
    })(),
    subclassfeature7: {
      name: "Nomad's Step",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description:
        "\n   I gain the following features that I can use a comined numebers of times:" +
        "\n    Phase Defense. When I am hit, as a reaction, I can teleport in an unoccupied space I had occupied at some point since the start of my previous turn, causing the triggering attack to miss" +
        "\n    Psionic Jaunt. As a bonus action, I expend any amount of remaining movement to teleport in an unoccupied space within that range",
      action: [["reaction", "Phase Defense"], ["bonus action", "Psionic Jaunt"]],
      limfeaname: "Phase Def. / Psionic Jaunt",
      usages: "Wis mod per",
      usagescalc: "event.value = Math.max(1, What('Wis Mod'));",
      recovery: levels.map((n) => {
        return n < 11 ? "long rest" : "short rest";
      })
    },
    subclassfeature11: {
      name: "Strange Movement",
      source: [["GMB:LL", 0]],
      minlevel: 11,
      description: desc([
        "I regain all expended uses of my Nomad's Step when I finish short/long rest",
        " Also, my Mystic Knowledge is improved (see it)"
      ]),
    },
    subclassfeature15: {
      name: "Mystical Burst",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "When I teleport with a Nomad Spell or Nomad feature, I can force all creas within 10 ft to a Int save",
        " On a fail, they take a Quarry Die Psychic damage (half on success)"
      ]),
    },
  },
});

// // Shifter 
AddSubClass("ranger(laserllama)", "shifter", {
  regExpSearch:
    /^(?=.*shifter).*$/i,
  subname: "Shifter",
  fullname: "Shifter Conclave",
  source: [["GMB:LL", 0]],
  features: {
    subclassfeature3: {
      name: "Shifter Spells",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description:
        "\n   " +
        "I learn certain spells. They are Ranger spells for me and don't count against my total of spells known and can't be replaced when I gain a level",
      spellcastingExtra: [
        "animal friendship", "beast bond",
        "alter self", "conjure beast",
        "fear", "nondetection",
        "dominate beast", "guardian of nature",
        "commune with nature", "tree stride"
      ],
    },
    "subclassfeature3.1": {
      name: "Limited Wild Shape",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: "I can wild shape with some limitations (see third page)",
      // Putting Beast Transformation on the third page because it's a wall of text; the subclass is already overflowing
      "limited.wild shape": {
        name: "Limited Wild Shape",
        source: [["GMB:LL", 0]],
        minlevel: 3,
        description: function () {
          var crWildShape = levels.map((n) => {
            return n < 7 ? "1/4" : n < 11 ? "1/2" : n < 17 ? 1 : 2;
          });
          var speedWildShape = levels.map((n) => {
            return n < 7 ? "with no Fly or Swim Speed" : n < 11 ? "with no Fly Speed" : "";
          });
          return desc([
            "As a bonus action I can wild shape using these rules:",
            " \u2022 I can take the wild shapes of Beasts of CR " +
            crWildShape +
            " or lower that I have seen before " + speedWildShape,
            " \u2022 Once I use my Wild Shape I must finish a short or long rest, unless I expend a spell slot of 1st-level or higher (SS 1+)",
            " \u2022 I follow the other rules of Wild Shape as they are detailed in Druid's Wild Shape",
            " \u2022 I can remain in my Wild Shape up to 1 hour. I can revert to my normal form early as a bonus action, but I revert instantly when I fall unconscious, I drop to 0 HP, or I die.",
          ]);
        },
        action: [["bonus action", " (start/end)"]],
        additional: levels.map(function (n) {
          if (n < 3) return "";
          var cr = levels.map((n) => {
            return n < 7 ? "1/4" : n < 11 ? "1/2" : n < 17 ? 1 : 2;
          });
          var restr = levels.map((n) => {
            return n < 7 ? " (No Fly/Swim)" : n < 11 ? " (No Fly)" : "";
          });
          return (
            "CR " + cr + restr + " or lower;"
          );
        }),
        altResource: "SS 1+",
        usages: 1,
        recovery: "short rest",
      },
      autoSelectExtrachoices: [{ extrachoice: "limited.wild shape" }],
    },
    "subclassfeature3.2": {
      name: "Wild Empathy",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I learn the Wild Insight I knack, but it doesn't count against my Knacks Known",
        "If already known, I learn another Knack"
      ]),
      toNotesPage: [
        {
          // What is added to the notes page
          name:
            KnacksLL['wild insight i'].name,
          note: desc(KnacksLL['wild insight i'].description),
          amendTo: "Wild Empathy",
        },
      ],
    },
    subclassfeature7: {
      name: "Nomad's Step",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description:
        "\n   I learn Druidic" +
        "\n   I count as a Druid for the purposes of attuninf to magic items" +
        "\n   My wild shape sttacks count as magical for overcoming resistances and immunities",
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (
              v.theWea.bestialNaturalWeapon &&
              !v.thisWeapon[1] &&
              !v.theWea.isMagicWeapon &&
              !/counts as( a)? magical/i.test(fields.Description)
            ) {
              fields.Description +=
                (fields.Description ? "; " : "") + "Counts as magical";
            }
          },
          "The natural weapon attacks of my Wild Shape count as magical for the purpose of overcoming resistance and immunity to nonmagical attacks and damage.",
        ],
      },
    },
    subclassfeature11: {
      name: "Empowered Shapes",
      source: [["GMB:LL", 0]],
      minlevel: 11,
      description: desc([
        "Once per short/long rest I can expend a spell slot when wild shape",
        " When I do so, I can transform into a Beast of CR equal or lower to the expended spell slot",
        " Moreover, I can roll my Quarry Die for the damage die of my Wild Shape attacks unless the form's is higher"
      ]),
      usages: 1,
      recovery: "short rest"
    },
    subclassfeature15: {
      name: "Thousand Forms",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "I can cast Alter Self at will, targeting only myself, without expending a spell slot"
      ]),
      spellChanges: {
        "alter self": {
          firstCol: "atwill",
          changes:
            "You can cast Alter Self at will, targeting only yourself, without expending a spell slot",
        },
      },
    },
  },
});

// // Stargazer 
AddSubClass("ranger(laserllama)", "stargazer", {
  regExpSearch:
    /^(?=.*stargazer).*$/i,
  subname: "Stargazer",
  fullname: "Stargazer Conclave",
  source: [["GMB:LL", 0]],
  features: {
    subclassfeature3: {
      name: "Stargazer Spells",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description:
        "\n   " +
        "I learn certain spells. They are Ranger spells for me and don't count against my total of spells known and can't be replaced when I gain a level",
      spellcastingExtra: [
        "mind spike", "moonbeam",
        "beacon of hope", "clairvoyance",
        "divination", "guardian of faith",
        "dawn", "wall of light"
      ],
    },
    "subclassfeature3.1": {
      name: "Celestial Guidance",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I gain proficiency in either cartographer's or navigator's tools (my choice)",
        " Whenever I make a check with the choosen tools, I add my Quarry Die to it",
        " Finally, I can't become lost, even by magical means so long I can see the stars of the night sky"
      ]),
      toolProfs: [["Navigator's/Cartographer's Tools", 1]]
    },
    "subclassfeature3.2": {
      name: "Constellation Magic",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "Each long rest, I can attune to a Constellation",
        'Use the "Choose Feature" button above to choose the Constellation',
      ]),
      choices: [
        "Adder",
        "Bear",
        "Elephant",
        "Snow Hare",
        "Stag",
        "Wolf",
      ],
      "adder": {
        description:
          "\n   " +
          "While attuned to the Adder constellation I have the Thorw Whip cantrip and Inflict Wounds spell prepared" +
          "\n    " +
          "These are treated as Stargazer spells" +
          "\n    " +
          "Once per short/long rest, I can cast Inflict Wounds without expending a spell slot, at the highest level I can cast" +
          "\n    " +
          "I can change this constellation when I finish a long rest",
        spellcastingExtra: [
          "thorn whip", "inflict wounds",
        ],
        limfeaname: "Constellation Magic",
        usages: 1,
        recovery: "short rest"
      },
      "bear": {
        description:
          "\n   " +
          "While attuned to the Bear constellation I have the Resistance cantrip and Wrathful Smite spell prepared" +
          "\n    " +
          "These are treated as Stargazer spells" +
          "\n    " +
          "Once per short/long rest, I can cast Wrathful Smite without expending a spell slot, at the highest level I can cast" +
          "\n    " +
          "I can change this constellation when I finish a long rest",
        spellcastingExtra: [
          "resistance", "wrathful smite",
        ],
        limfeaname: "Constellation Magic",
        usages: 1,
        recovery: "short rest"
      },
      "elephant": {
        description:
          "\n   " +
          "While attuned to the Elephant constellation I have the Guidance cantrip and Bless spell prepared" +
          "\n    " +
          "These are treated as Stargazer spells" +
          "\n    " +
          "Once per short/long rest, I can cast Bless without expending a spell slot, at the highest level I can cast" +
          "\n    " +
          "I can change this constellation when I finish a long rest",
        spellcastingExtra: [
          "guidance", "bless",
        ],
        limfeaname: "Constellation Magic",
        usages: 1,
        recovery: "short rest"
      },
      "snow hare": {
        description:
          "\n   " +
          "While attuned to the Snow Hare constellation I have the Minor Illusion cantrip and Armor of Agathys spell prepared" +
          "\n    " +
          "These are treated as Stargazer spells" +
          "\n    " +
          "Once per short/long rest, I can cast Armor of Agathys without expending a spell slot, at the highest level I can cast" +
          "\n    " +
          "I can change this constellation when I finish a long rest",
        spellcastingExtra: [
          "minor illusion", "armor of agathys",
        ],
        limfeaname: "Constellation Magic",
        usages: 1,
        recovery: "short rest"
      },
      "stag": {
        description:
          "\n   " +
          "While attuned to the Stag constellation I have the Shillelagh cantrip and Heroism spell prepared" +
          "\n    " +
          "These are treated as Stargazer spells" +
          "\n    " +
          "Once per short/long rest, I can cast Heroism without expending a spell slot, at the highest level I can cast" +
          "\n    " +
          "I can change this constellation when I finish a long rest",
        spellcastingExtra: [
          "shillelagh", "heroism",
        ],
        limfeaname: "Constellation Magic",
        usages: 1,
        recovery: "short rest"
      },
      "wolf": {
        description:
          "\n   " +
          "While attuned to the Wolf constellation I have the True Strike cantrip and Guiding Bolt spell prepared" +
          "\n    " +
          "These are treated as Stargazer spells" +
          "\n    " +
          "Once per short/long rest, I can cast Guiding Bolt without expending a spell slot, at the highest level I can cast" +
          "\n    " +
          "I can change this constellation when I finish a long rest",
        spellcastingExtra: [
          "true strike", "guiding bolt",
        ],
        limfeaname: "Constellation Magic",
        usages: 1,
        recovery: "short rest"
      },
    },
    subclassfeature7: {
      name: "Threads of Fate",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description:
        "\n   When a crea I can see within 30 ft make a check or save I can use my reaction to add my Wis mod (min of +1) to that save/check",
      action: [["reaction", ""]],
      usages: "Wis mod per",
      usagescalc: "event.value = Math.max(1, What('Wis Mod'));",
    },
    subclassfeature11: {
      name: "Starlight Strikes",
      source: [["GMB:LL", 0]],
      minlevel: 11,
      description: desc([
        "Once per turn, when I hit a crea with weapon attack or damage it with a Ranger spell, I deal an extra Quarry Die Radiant damage"
      ]),
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (v.isWeapon) {
              fields.Description += (fields.Description ? '; ' : '') + 'Once per turn, +1Quarry Die Radiant dmg';
            };
          },
          ""
        ]
      }
    },
    subclassfeature15: {
      name: "Resplendent Soul",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "When I crea I can see targets me with an attacl, I can use a reaction to force a Con save or its attack misses and it takes 3Quarry Dice Radiant damage",
        "If I have no uses left, I can expend a spell slot of 1st level or higher (SS 1+)"
      ]),
      usages: "Wis mod per",
      usagescalc: "event.value = Math.max(1, What('Wis Mod'));",
      recovery: "long rest",
      altResource: "SS 1+",
      action: [["reaction", ""]],
    },
  },
});

// // Trapper 
AddSubClass("ranger(laserllama)", "trapper", {
  regExpSearch:
    /^(?=.*trapper).*$/i,
  subname: "Trapper",
  fullname: "Trapper Conclave",
  source: [["GMB:LL", 0]],
  features: {
    subclassfeature3: {
      name: "Trapper Spells",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description:
        "\n   " +
        "I learn certain spells. They are Ranger spells for me and don't count against my total of spells known and can't be replaced when I gain a level",
      spellcastingExtra: [
        "alarm", "ensnaring strike",
        "cordon of arrows", "find traps",
        "glyph of warding", "slow",
        "resilient sphere", "stone shape",
        "planar binding", "transmute rock"
      ],
    },
    "subclassfeature3.1": {
      name: "Meticulous Fingers",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I gain proficiency in Thieves' Tools, Tinker's Tools, and Sleight of Hand",
        "Whenever I make a check with this proficiencies I add my Quarry Die to the roll",
        "I can use the Use an Object as a bonus action"
      ]),
      toolProfs: ["Thieves' Tools", "Tinker's Tools"],
      skills: ["Sleight of Hand"],
      action: [["bonus action", "Use an Object"]],
    },
    "subclassfeature3.2": {
      name: "Trap Adept",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I learn the Trapper knack, but it doesn't count against my Knacks Known",
        "If already known, I learn another Knack",
        "Also, I can rearm a disarmed trap using my Tinker's Tools, it use my Spell DC as new DC"
      ]),
      toNotesPage: [
        {
          // What is added to the notes page
          name:
            KnacksLL['trapper'].name,
          note: desc(KnacksLL['trapper'].description),
          amendTo: "Trap Adept",
        },
      ],
    },
    subclassfeature7: {
      name: "Combat Snares",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description:
        "\n   As an action, I can craft a trap (using the Trapper Knack) and throw it at a space I can see within 20 ft" +
        "\n   Creas in the space must make the save as they entered the trap space, suffering its effects on a fail as normal" +
        "\n   Traps crafted in this way last 1 minute" +
        "\n   As an Use an Object action I can throw an already crafted trap at a crea",
      action: [["action", "Craft and Throw Trap"], ["bonus action", "Throw already crafted Trap"]]
    },
    subclassfeature11: {
      name: "Deadly Snares",
      source: [["GMB:LL", 0]],
      minlevel: 11,
      description: desc([
        "My Quarry has disadv. on its initial save against traps I crafted or modified",
        "My Quarry automatically fails its initial save against my traps if it is unaware of the trap's location"
      ]),
    },
    "subclassfeature11.1": {
      name: "Greater Traps",
      source: [["GMB:LL", 0]],
      minlevel: 11,
      description: desc([
        "At the end of a long rest, I can craft a number of traps (with Trapper Knack) equal to 1 + my Wis mod (min of 2 traps)",
        "Additionally, any trp I craft with Trapper now works on Huge or smaller creas",
        "Whenever a crea fails a save against my trap, it takes 3 Quarry Dice (half on success) magical bludg., pierce., or slash. dmg (my choice)"
      ]),
    },
    subclassfeature15: {
      name: "Master of Traps",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "When I roll initiative I can use my reaction to craft a trap and throw it ot one unoccupied space I can see within 20 ft",
        "Also, whenever I craft a trap I can choose whether it taks up 10-ft square or 5-ft square"
      ]),
      action: [["reaction", " (on init)"]],
    },
  },
});

// // Wastelander 
AddSubClass("ranger(laserllama)", "wastelander", {
  regExpSearch:
    /^(?=.*wastelander).*$/i,
  subname: "Wastelander",
  fullname: "Wastelander Conclave",
  source: [["GMB:LL", 0]],
  features: {
    subclassfeature3: {
      name: "Wastelander Spells",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description:
        "\n   " +
        "I learn certain spells. They are Ranger spells for me and don't count against my total of spells known and can't be replaced when I gain a level",
      spellcastingExtra: [
        "absorb elements", "silent image",
        "invisibility", "mirror image",
        "major image", "wall of sand",
        "greater invisibility", "hallucinatory terrain",
        "commune with nature", "mislead"
      ],
    },
    "subclassfeature3.1": {
      name: "Wasteland Weaver",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map((n) => {
        if (n < 7) {
          return desc([
            "I gain proficiency with Weaver's Tools and I add double my proficiency bonus to any check with these tools",
            "At the end of each long rest, I can use weaver's tools to enhance one set of clothing or cloak.",
            "While a creature wears this enhanced garment it gains the following:",
            "  It add my Quarry Die on Dex(Stealth) checks to hide in wasteland and wilds",
            "  It require one-quarter as much water in order to survive",
            "  It has advan. on saves to resist the effects of harsh environments and subsequent exhaustion level",
            "During each long rest, I must expend 1 hour maintaining any garments I have enhanced or they lose these benefits",
            "I can maintain a number of garments equal to my Wis mod (min of 1)"
          ]);
        }
        return desc([
          "I gain proficiency with Weaver's Tools and I add double my proficiency bonus to any check with these tools",
          "At the end of each long rest, I can use weaver's tools to enhance one set of clothing or cloak.",
          "While a creature wears this enhanced garment it gains the following:",
          "  The garment has 3 charges (regain them when maintained)",
          "  It can use a bonus action to expend one charge and cast invisibility on itself. On the third charge expended, the garment loses its magical benefits until maintained",
          "  It add my Quarry Die on Dex(Stealth) checks to hide in wasteland and wilds",
          "  It require one-quarter as much water in order to survive",
          "  It has advan. on saves to resist the effects of harsh environments and subsequent exhaustion level",
          "During each long rest, I must expend 1 hour maintaining any garments I have enhanced or they lose these benefits",
          "I can maintain a number of garments equal to my Wis mod (min of 1)"
        ]);

      }),
      limfeaname: "Garments Set",
      usages: "Wis mod per",
      usagescalc: "event.value = Math.max(1, What('Wis Mod'));",
    },
    "subclassfeature3.2": (function () {
      // Fixed attributes
      WildernessKnackFeature = {
        name: "Wilderness Adept",
        minlevel: 3,
        source: [["GMB:LL", 0]],
        description: desc([
          "I learn extra Knacks that gives me additional features",
          'Use the "Choose Feature" button above to choose Knacks',
          "They are added to the note page"
        ]),
        toNotesPage: [
          {
            name: "Wilderness Knacks Known",
            note: desc([
              "Below are all Wilderness Knacks I know. These Knacks don't count against my number of Knacks Known",
            ]),
          },
        ],
        extraname: "Wilderness Knacks",
        extraTimes: [
          "",
          "",
          1,
          1,
          1,
          1,
          2,
          2,
          2,
          2,
          3,
          3,
          3,
          3,
          4,
          4,
          4,
          4,
          4,
          4,
        ],
        extrachoices: [
          "Alpine Adept",
          "Aquatic Adept",
          "Arctic Adept",
          "Desert Adept",
          "jungle Adept",
        ],
        additional: [
          "",
          "",
          "1 Knack",
          "1 Knack",
          "1 Knack",
          "1 Knack",
          "2 Knacks",
          "2 Knacks",
          "2 Knacks",
          "2 Knacks",
          "3 Knacks",
          "3 Knacks",
          "3 Knacks",
          "3 Knacks",
          "4 Knacks",
          "4 Knacks",
          "4 Knacks",
          "4 Knacks",
          "4 Knacks",
          "4 Knacks",
        ],
      };

      for (var i = 0; i < WildernessKnackFeature.extrachoices.length; i++) {
        var NewKnack = KnacksLL[WildernessKnackFeature.extrachoices[i].toLowerCase()];
        WildernessKnackFeature[WildernessKnackFeature.extrachoices[i].toLowerCase()] = {
          // Add "spell" to the main item (when it is picked through the menu)
          name: NewKnack.name,
          toNotesPage: [
            {
              // What is added to the notes page
              name:
                NewKnack.name,
              note: NewKnack.description,
              amendTo: "Wilderness Knacks Known",
            },
          ],
          source: NewKnack.source,
          addMod: NewKnack.addMod,
          speed: NewKnack.speed,
          toolProfs: NewKnack.toolProfs,
          action: NewKnack.action,
          prereqeval: NewKnack.prereqeval,
          usages: NewKnack.usages,
          recovery: NewKnack.recovery,
          savetxt: NewKnack.savetxt,
          dmgres: NewKnack.dmgres,
          armorProfs: NewKnack.armorProfs,
          submenu: NewKnack.submenu,
          extraname: NewKnack.extraname,
          extraTimes: NewKnack.extraTimes,
          choices: NewKnack.choices,
          vision: NewKnack.vision,
        };

      }

      var seventhLevelChoices = [
        "Planar Adept (Astral Sea)",
        "Planar Adept (Mechanus)",
        "Planar Adept (Shadowfell)",
        "Planar Adept (Feywild)",
        "Planar Adept (Air)",
        "Planar Adept (Earth)",
        "Planar Adept (Fire)",
        "Planar Adept (Water)",
      ];

      for (var s = 0; s < seventhLevelChoices.length; s++) {
        var NewKnack = KnacksLL[seventhLevelChoices[s].toLowerCase()];
        WildernessKnackFeature.extrachoices.push(seventhLevelChoices[s]);
        WildernessKnackFeature[seventhLevelChoices[s].toLowerCase()] = {
          // Add "spell" to the main item (when it is picked through the menu)
          name: NewKnack.name,
          toNotesPage: [
            {
              // What is added to the notes page
              name:
                NewKnack.name,
              note: NewKnack.description,
              amendTo: "Wilderness Knacks Known",
            },
          ],
          source: NewKnack.source,
          addMod: NewKnack.addMod,
          speed: NewKnack.speed,
          toolProfs: NewKnack.toolProfs,
          action: NewKnack.action,
          prereqeval: function () {
            return classes.known["ranger(laserllama)"].level >= 7;
          },
          usages: NewKnack.usages,
          recovery: NewKnack.recovery,
          savetxt: NewKnack.savetxt,
          dmgres: NewKnack.dmgres,
          armorProfs: NewKnack.armorProfs,
          submenu: NewKnack.submenu,
          extraname: NewKnack.extraname,
          extraTimes: NewKnack.extraTimes,
          choices: NewKnack.choices,
          vision: NewKnack.vision,
        };

      }

      return WildernessKnackFeature;
    })(),
    subclassfeature7: {
      name: "Rugged Resilience",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description:
        "Wasteland Weaver improved (see it)"
    },
    subclassfeature11: {
      name: "Illusory Strikes",
      source: [["GMB:LL", 0]],
      minlevel: 11,
      description: desc([
        "When I take the Attack Action on my turn, I can create an Illusory Duplicate of myself as a bonus action",
        "It appeares in an unoccupied space within 30 ft and It makes one attack with a duplicate of my weapon, which deals force damage instead of weapon damage",
        "After the attack, the Illusory Duplicate disappears"
      ]),
      action: [["bonus action", "Illusory Duplicate"]]
    },
    subclassfeature15: {
      name: "Mirage Transposition",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "I can create my Illusory Duplicate wven if I do not take the Attack action",
        "When I conjure an Illusory Duplicate, I can switch places with it"
      ]),
    },
  },
});

// // Wrangler 
AddSubClass("ranger(laserllama)", "wrangler", {
  regExpSearch:
    /^(?=.*wrangler).*$/i,
  subname: "Wrangler",
  fullname: "Wrangler Conclave",
  source: [["GMB:LL", 0]],
  features: {
    subclassfeature3: {
      name: "Wrangler Spells",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description:
        "\n   " +
        "I learn certain spells. They are Ranger spells for me and don't count against my total of spells known and can't be replaced when I gain a level",
      spellcastingExtra: [
        "charm person", "command",
        "calm emotions", "conjure beast",
        "hypnotic pattern", "slow",
        "charm mosnter", "dominate beast",
        "awaken", "hold monster"
      ],
    },
    "subclassfeature3.1": {
      name: "Beast Tamer",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I gain proficiency in Athletics or Animal Handling",
        "I can mark Beasts and Monstrosities as my Quarry without expending a use of Ranger's Quarry",
        "I add my Quarry Die on Str(Athletics) checks to grapple, climb, wrestle or subdue my Quarry",
        "Any Enchantment spell I cast that could normally only target Humanoids can also target Beast and Monstrosities"
      ]),
    },
    subclassfeature7: {
      name: "Cunning Parry",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description:
        "\n   Whenever a Beast or Monstrosity charmed by me makes a save to end the effect, I can use my reaction" +
        "\n    When I do so, that crea subtract my Quarry Die to the save" +
        "\n   Any beast or monstrosity charmed by me acts during my turn for the duration of that charm effect" +
        "\n    If I am within 30 ft of the charmed crea and it can hear me, I can use an action to command it to take one of the actions from its stat block",
      action: [["Command Charmed Beast/Monst"]]
    },
    subclassfeature11: {
      name: "Monster Tamer", // CONTINUARE DA QUI
      source: [["GMB:LL", 0]],
      minlevel: 11,
      description: desc([
        "Any Wrangler feature that normally affects Beasts and Monstrosities also affects " +
        "Celestials, Dragons, Fey, Fiends, Giants, Plants, and Oozes that have an Intelligence Score less than or equal to my Ranger level",
        "Also, as a bonus action, I can command any creature that is charmed by me to take an action from its stat block so long as is within 30 ft and can hear me"
      ]),
      action: [["bonus action", "Command Charmed Creature"]]
    },
    subclassfeature15: {
      name: "Wrangler of Legends",
      source: [["GMB:LL", 0]],
      minlevel: 15,
      description: desc([
        "When I cas an enchantment spell on a Beast, Monstrosity, or one crea of the types listed in Monste Tamer, my Conc. cannot be broken unless I wish it to be",
        "Moreover, creas that are charmed by me gain all benefits of my Ranger's Quarry (including Knacks that enhance it), and whenever one of them is forced to make a save while it is within 30 ft and it can hear me, I can use a reaction to add my Quarry Die to its roll",
      ]),
      action: [["reaction", ""]],
    },
  },
});

// Subclassess Alternate Rogue
// Arcane Trickster
AddSubClass("rogue(laserllama)", "arcane trickster", {
  regExpSearch: /arcane trickster/i,
  subname: "Arcane Trickster",
  fullname: "Arcane Trickster",
  source: [["GMB:LL", 0]],
  abilitySave: 4,
  spellcastingFactor: 3,
  spellcastingList: {
    spells: ArcaneTricksterList,
  },
  spellcastingKnown: {
    cantrips: [0, 0, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3],
    spells: [0, 0, 3, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9, 10, 10, 11, 11, 12, 12],
  },
  features: {
    subclassfeature3: {
      name: "Spellcasting",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description:
        "\n   " +
        "I can cast known arcane trickster cantrips/spells, using Intelligence as my spellcasting ability",
      additional: [
        "",
        "",
        "3 cantrips \u0026 3 spells known",
        "3 cantrips \u0026 4 spells known",
        "3 cantrips \u0026 4 spells known",
        "3 cantrips \u0026 4 spells known",
        "3 cantrips \u0026 5 spells known",
        "3 cantrips \u0026 6 spells known",
        "3 cantrips \u0026 6 spells known",
        "4 cantrips \u0026 7 spells known",
        "4 cantrips \u0026 8 spells known",
        "4 cantrips \u0026 8 spells known",
        "4 cantrips \u0026 9 spells known",
        "4 cantrips \u0026 10 spells known",
        "4 cantrips \u0026 10 spells known",
        "4 cantrips \u0026 11 spells known",
        "4 cantrips \u0026 11 spells known",
        "4 cantrips \u0026 11 spells known",
        "4 cantrips \u0026 12 spells known",
        "4 cantrips \u0026 13 spells known",
      ],
      spellcastingBonus: [
        {
          name: "Mage Hand cantrip", // the Mage Hand cantrip gained at level 1
          spells: ["mage hand"],
          selection: ["mage hand"],
        },
      ],
    },
    "subclassfeature3.1": {
      name: "Mage Hand Adept",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "As a bonus action, I can direct my Mage Hand",
        "I can make it invisible and perform, if I am proficient, Dexterity(Sleght of Hand) and Thieves' Tools checks with it",
      ]),
      action: [["bonus action", ""]],
      spellChanges: {
        "mage hand": {
          description:
            "Invisible hand, carries 10 lb; 1 bns to control, do thieves' tools and sleght of hand checks if I am Prof",
          changes:
            "I can make it invisible and perform, if I am proficient, Dexterity(Sleght of Hand) and Thieves' Tools checks with it",
        },
      },
    },
    "uncanny dodge": {
      name: "Uncanny Dodge",
      source: ["GMB:LL", 0],
      minlevel: 6,
      description: levels.map(function (n) {
        if (n < 7)
          return desc(
            "As a reaction, I can halve the damage of an attack from an attacker that I can see"
          );
        if (n < 14)
          return desc(
            "As a reaction, I can halve the damage of an attack from an attacker that I can see, then choose if teleport to an unoccupied space I can see within 15 feet"
          );
        return desc(
          "As a reaction, I can halve the damage of an attack from an attacker that I can see and move half my speed without provoking opportunity attacks, then choose if teleport to an unoccupied space I can see within 15 feet"
        );
      }),
      action: ["reaction", ""],
    },
    subclassfeature7: {
      name: "Arcane Misdirection",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description:
        "I can use a bonus action to distract a creature within 5 ft of my mage hand to grant me advan. on my next attack against it before end of my turn",
      action: [["bonus action", ""]],
    },
    "subclassfeature7.1": {
      name: "Magical Polymath",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "I can use any spell scroll without restriction ad if the spell was on the my spell list",
        "Also when I can learn a new spell from my spell list, I can copy it from a spell scroll or spellbook",
        "When I do so, it becomes an Arcane Trickster spell but the spell scroll or the spellbook page I copied it from is destroyed",
      ]),
    },
    subclassfeature13: {
      name: "Trickster's Ambush",
      source: [["GMB:LL", 0]],
      minlevel: 13,
      description:
        "Arcane Misderection improved (see Arcane Misderection) \n Uncanny Dodge improved",
    },
    subclassfeature17: {
      name: "Spell Thief",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description:
        "As a reaction, when targeted by or within the area of effect of a spell, I can try to negate and steal it" +
        "\n   " +
        "The caster makes and me do a spell attack roll. If I lose or tie, the spell takes effect as normal. " +
        "\n   " +
        "If I win, the spell fails and once before my next long rest I can cast it once, at its lowest level, as if it were an Arcane Trickster spell" +
        "\n   " +
        "If the spell was of a level for which I have slots, I can replace a spell I know with that spell" +
        "I can use this feature once per long rest unless I spend a 3rd level spell slot to use it again",
      action: [["reaction", ""]],
      recovery: "long rest",
      usages: 1,
    },
  },
});

// Assassin
AddSubClass("rogue(laserllama)", "assassin", {
  regExpSearch: /assassin/i,
  subname: "Assassin",
  fullname: "Assassin",
  source: [["GMB:LL", 0]],
  abilitySaveAlt: 4,
  features: {
    subclassfeature3: GetRogueSubclassExploits("Assassin", [
      "subtle con",
      "precision strike",
      "craft minor poison",
      "crippling strike",
      "craft greater poison",
    ]),
    "subclassfeature3.1": {
      name: "Infiltrator",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I gain proficiency with both disguise and poisoner's kits",
        " Over the course of 10 minutes, which can be during a short/long rest I can use my disguise kit to craft a disguise",
        " The disguise must resembles a dead or unconscious humanoid so long I have its body and is detected by a success on a Search action against my Exploit DC",
        " Finally I can unerringly mimic any humanoid's speech so long as I have spent at least 10 minutes listening to it",
      ]),
      toolProfs: ["Disguise kit", "Poisoner's kit"],
    },
    "subclassfeature3.2": {
      name: "Assassinate",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I gain the following benefits",
        "\n \u2022  After initiative is determined, I can expend an Expl Die and add it to my init. roll",
        "\n \u2022  I have advantage on weapon attack against any crea that has yet acted in combat",
        "\n \u2022  When I hit an incapacitated or surprised crea with my Sneak Attack, it is an automatic critical hit",
      ]),
    },
    subclassfeature7: {
      name: "Deadly Blades",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "When I score a critical hit I can reroll any 1 on the damage dice",
        " Also, when I Sneak Attack I can reduce the bonus by 1d6 to force the target to make a Con save against my Exploit DC or it is poisoned until the beginning of my next turn",
      ]),
    },
    subclassfeature13: {
      name: "Flawless Infiltrator",
      source: [["GMB:LL", 0]],
      minlevel: 13,
      description: desc([
        "I gain the following benefits",
        "\n \u2022  I learn three languages of my choice",
        "\n \u2022  If I must make a check to mantain my disguise credibility, I gain a bonus to the roll equal to my Expl Die",
        "\n \u2022  When I hit an incapacitated or surprised crea with my Sneak Attack, it is an automatic critical hit",
      ]),
      languageProfs: [3],
    },
    "subclassfeature13.1": {
      name: "Master Poisoner",
      source: [["GMB:LL", 0]],
      minlevel: 13,
      description: desc([
        "I can use any Exploit I know that allows me to craft a poison with a bonus action and apply that poison to a weapon with a bonus action",
        " I Also learn the Craft Advanced Weapon Exploit and it doesn't count against the number of my Exploit Known",
      ]),
      spellChanges: {
        "craft minor poison": {
          description:
            "Craft poison who forces one crea to make Con save or poisoned for 1 min; extra save each turn",
          changes:
            "I can use a bonus action instead of an action to craft the poison or apply it to a weapon",
        },
        "craft great poison": {
          description:
            "Craft great poison who forces one crea to make Con save or half speed, no reactions and disadv. on attacks for 1 min; extra save each turn",
          changes:
            "I can use a bonus action instead of an action to craft the poison or apply it to a weapon",
        },
        "craft advanced poison": {
          description: "Craft advanced poison (see book)",
          changes:
            "I can use a bonus action instead of an action to craft the poison or apply it to a weapon",
        },
        "craft masterwork poison": {
          description: "Craft advanced poison (see book)",
          changes:
            "I can use a bonus action instead of an action to craft the poison or apply it to a weapon",
        },
      },
      spellcastingBonus: [
        {
          name: "Craft Advanced Weapon",
          spells: ["craft advanced poison"],
          selection: ["craft advanced poison"],
        },
      ],
    },
    subclassfeature17: {
      name: "Death Strike",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc([
        "When I add my Sneak Attack damage bonus to a weapon attack, I can choose for that attack to be an automatic critical hit.",
      ]),
      usages: 1,
      recovery: "short rest",
    },
  },
});

// Burglar (thief archetype)
AddSubClass("rogue(laserllama)", "burglar", {
  regExpSearch: /burglar/i,
  subname: "Burglar",
  fullname: "Burglar",
  source: [["GMB:LL", 0]],
  abilitySaveAlt: 4,
  features: {
    subclassfeature3: GetRogueSubclassExploits("Burglar", [
      "lightstep",
      "modify device",
      "dirty hit",
      "survey dungeon",
      "forgotten knowledge",
    ]),
    "cunning action": {
      name: "Cunning Action",
      source: ["GMB:LL", 0],
      minlevel: 2,
      description: levels.map(function (n) {
        if (n < 3)
          return desc(
            "I can use a bonus action to take the Dash, Disengage, Hide or Use an Object action"
          );
        if (n < 11)
          return desc(
            "I can use a bonus action to take the Dash, Disengage, Hide, Use an Object action or make an Dex(Sleight of Hand) check"
          );
        return desc(
          "I can use a bonus action to take the Dash, Disengage, Hide, Use an Object action or make an Dex(Sleight of Hand) check",
          "Also I can take a second bonus action each turn but cannot use the same bonus action twice"
        );
      }),
      action: [["bonus action", ""]],
    },
    "subclassfeature3.1": {
      name: "Nimble",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I gain climbing speed equal to my walking speed and can use Dexterity, in place of Strength, to calculate jump distances",
      ]),
      speed: {
        climb: { spd: "walk" },
      },
    },
    "subclassfeature3.2": {
      name: "Quick Fingers",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "When I add Sneak Attack damage bonus, I can reduce the damage of 1d6 on the target",
        " If I do, I can make a Dex(Slegiht of Hand) vs its Wis(Perception) check and on a success, I can remove and object of my choice from the target's pockets, bag, pouch, belt or another that object it is not holding",
        " Finally my Cunning Action is improved (see Cunning Action)",
      ]),
    },
    subclassfeature7: {
      name: "Supreme Sneak",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "I gain the following benefits",
        "  \u2022  I have advan. on Dex(Stealth) checks while moving at half speed",
        "  \u2022  I can attempt to Hide when I am lightly obscured",
        "  \u2022  I can use my Cunning Action to reduce my Sneak Attack bonus by 1d6 to take the Hide action before the end of that turn (no action required)",
      ]),
    },
    "subclassfeature7.1": {
      name: "Treasure Lore",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "I have a bonus equal to my Expl Die whenever I make an ability check to research, investigate the workings of, or asses the value of magic item, treasure, or trap",
        " I also can use the Use an Object action to activate magic item, cast spell from a spell scroll, drink a potion, or utilize a magic object that would take an action",
      ]),
      action: [["bonus action", " (Use an Object)"]],
    },
    subclassfeature13: {
      name: "Use Magic Device",
      source: [["GMB:LL", 0]],
      minlevel: 13,
      description: desc([
        "I ignore all alignment, class, race and level requirements to use magic items, spell scrolls and potions",
        " If one of these items requires a spellcasting ability, I use my Intelligence for it",
      ]),
      languageProfs: [2],
    },
    subclassfeature17: {
      name: "Quick Reflexes",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc([
        "I can take an additional bonus action during my turns but it can be used only for the actions from my Cunning Action",
        "If I don't use this extra bonus action, I can take a second reaction instead before the start of my next turn. A single effect can only trigger one reaction",
      ]),
      extraLimitedFeatures: [
        {
          name: "Cunning Action",
          usages: 1,
          addToExisting: true,
        },
      ],
    },
  },
});

// Investigator (inquisitive archetype)
AddSubClass("rogue(laserllama)", "investigator", {
  regExpSearch: /investigator/i,
  subname: "Investigator",
  fullname: "Investigator",
  source: [["GMB:LL", 0]],
  abilitySaveAlt: 4,
  features: {
    subclassfeature3: GetRogueSubclassExploits("Investigator", [
      "inquisitive eye",
      "precision strike",
      "exposing strike",
      "survey dungeon",
      "survey settlement",
    ]),
    "cunning action": {
      name: "Cunning Action",
      source: ["GMB:LL", 0],
      minlevel: 2,
      description: levels.map(function (n) {
        if (n < 3)
          return desc(
            "I can use a bonus action to take the Dash, Disengage, Hide or Use an Object action"
          );
        if (n < 11)
          return desc(
            "I can use a bonus action to take the Dash, Disengage, Hide, Use an Object or Search action"
          );
        return desc(
          "I can use a bonus action to take the Dash, Disengage, Hide, Use an Object or Search action",
          "Also I can take a second bonus action each turn but cannot use the same bonus action twice"
        );
      }),
      action: [["bonus action", ""]],
    },
    "subclassfeature3.1": {
      name: "Eye for Detail",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I can make Insight and Perception checks using Intelligence instead of Wisdom",
        " When I take the Search action, I gain information as if I had spent 10 minutes searching",
        " My Cunning Action is improved (see Cunnin Action)",
      ]),
      addMod: [
        {
          type: "skill",
          field: "Insight",
          mod: "max(Int-Wis|0)",
          text: "I can replace Wisdom (Insight) checks with Intelligence (Insight)",
        },
        {
          type: "skill",
          field: "Perception",
          mod: "max(Int-Wis|0)",
          text: "I can replace Wisdom (Perception) checks with Intelligence (Perception)",
        },
      ],
    },
    "subclassfeature3.2": {
      name: "Predictive Fighting",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map(function (n) {
        if (n < 17) {
          return desc([
            "As a Search action, I can observe the tactics of another creature within 60 ft",
            " I have to make a Wisdom (Insight) check vs. the target's DC (8 + CR)",
            " If I succeed, I add my Int mod (min +1) to attacks rolls against it and I can use my sneak attack on it even if I don't have adv. (but not if disadv.)",
            " This benefit lasts for 1 minute or until I use Predictive Fighting again",
          ]);
        }

        return desc([
          "As a Search action, I can observe the tactics of another creature within 60 ft",
          " I add my Int mod (min +1) to attacks rolls against it and I can use my sneak attack on it even if I don't have adv. (but not if disadv.)",
          " Also my Sneak Attack use d8s instead of d6s against it",
          " This benefit lasts for 1 minute or until I use Predictive Fighting again",
        ]);
      }),
    },
    subclassfeature7: {
      name: "Insightful Strike",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "I can use Cunning Strike to reduce my Sneak attack damage by 1d6 on a hit",
        " When I do so, the DM tells me one of: its highest ability score, its lowest ability score, Armor Class, Condition Immunities, Damage Immunity and Resitances or One Special Feature (Spellcasting, Exploits, etc.)",
        " In addition I have advantage on Predictive Fighting if i hit the target with an attack since the end of your previous long rest",
      ]),
    },
    subclassfeature13: {
      name: "Adept Investigator",
      source: [["GMB:LL", 0]],
      minlevel: 13,
      description: desc([
        "Using Survey Dungeon or Survey Settlement Exploit takes me half as much time and gives me twice as much information",
        " Also, whenever I finish a long rest in a settlement, or a short rest in a dungeon, I gain the benefits of the respectively Exploit",
        "Though, this feature dose not interrupt my short/long rest",
      ]),
      spellChanges: {
        "survey dungeon": {
          description:
            "Learn three of: one trap, one active spell, one secret compartment, door or passageway (see book)",
          changes:
            "I spend half as much time and gain twice as much information",
        },
        "survey settlement": {
          description:
            "Learn three of: factions, buildings, leaders, beliefs or secret places (see book)",
          changes:
            "I spend half as much time and gain twice as much information",
        },
      },
    },
    "subclassfeature13.1": {
      name: "Unerring Sight",
      source: [["GMB:LL", 0]],
      minlevel: 13,
      description: levels.map(function (n) {
        var UnerringSightRange = n < 14 ? 10 : n < 20 ? 20 : 30;

        return desc([
          "I gain " +
          UnerringSightRange +
          " ft Truesight and have adv. on Insight and Investigation checks within that radius",
        ]);
      }),
      changeeval: function (lvl, chc) {
        var srcNm = "Unerring Sight";
        var curRange =
          CurrentProfs.vision.truesight &&
          CurrentProfs.vision.truesight.ranges[srcNm];
        var newRange =
          lvl[1] < 13 ? 0 : lvl[1] < 14 ? 10 : lvl[1] < 20 ? 20 : 30;

        // Only do something if the range changed
        if (curRange !== newRange) {
          // First remove the old range, if any
          if (curRange) SetProf("vision", false, "Truesight", srcNm, curRange);
          // Then set the new range, unless the feature is removed (i.e. lvl[1] === 0)
          if (newRange) SetProf("vision", true, "Truesight", srcNm, newRange);
        }
      },
    },
    subclassfeature17: {
      name: "Exploit Weakness",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc([
        "My Predictive Fighting is improved (see Predective Fighting)",
      ]),
    },
  },
});

// Mastermind
AddSubClass("rogue(laserllama)", "mastermind", {
  regExpSearch: /mastermind/i,
  subname: "Mastermind",
  fullname: "Mastermind",
  source: [["GMB:LL", 0]],
  abilitySaveAlt: 4,
  features: {
    subclassfeature3: GetRogueSubclassExploits("Mastermind", [
      "eloquent speech",
      "roguish charm",
      "exposing strike",
      "soothing speech",
      "recruit informant",
    ]),
    "cunning action": {
      name: "Cunning Action",
      source: ["GMB:LL", 0],
      minlevel: 2,
      description: levels.map(function (n) {
        if (n < 3)
          return desc(
            "I can use a bonus action to take the Dash, Disengage, Hide or Use an Object action"
          );
        if (n < 11)
          return desc(
            "I can use a bonus action to take the Dash, Disengage, Hide, Use an Object or Help action"
          );
        return desc(
          "I can use a bonus action to take the Dash, Disengage, Hide, Use an Object or Help action",
          "Also I can take a second bonus action each turn but cannot use the same bonus action twice"
        );
      }),
      action: [["bonus action", ""]],
    },
    "subclassfeature3.1": {
      name: "Tactical Acumen",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "My Cunning Action is improved (see Cunning Action)",
        " Also, whenever I use the Help action to aid anb ally to attack a creature, it can be within 30 feet of me, rather than 5 feet, so long as the attacker can see or hear me",
      ]),
    },
    "subclassfeature3.2": {
      name: "Master of Machinations",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I learn two additional languages of my choice and gain proficiency with both disguise and forgery kits",
        " Also, if I speak at least for 1 minute with a creature in its native tongue, I can use Roguish Charm Exploit without expending an Expl Die",
        " When I do so, I can expend one Expl Die to cause the effect to last until the target's next long rest but I don't regain this Expl Die until the effects of this Exploit lasts",
      ]),
      toolProfs: ["Disguise kit", "Forgery's kit"],
      languageProfs: [2],
    },
    subclassfeature7: {
      name: "Manipulative Intuition",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "I know one of the following facts if I spend at least 1 minute talking with or observing a creature outside of combat",
        "\n \u2022  One of its ideals, bonds, flaws, motivations, or alignment",
        "\n \u2022  It's true attitude toward me, or another creature that I observe it interacting with for the same duration.",
        "I can use this feature once per long rest for each creature, and creatures with Legendary Resistance are immunte to this ability",
      ]),
    },
    "subclassfeature7.1": {
      name: "Potent Insight",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "When I use my Help action to aid an ally attack and it hits the creature, I can use my reaction to add my Sneak Attack damage bonus to that attack",
        "If I do so, I cannot use my Sneak Attack on my next turn",
      ]),
      action: [["reaction", ""]],
    },
    subclassfeature13: {
      name: "Devious Tactics",
      source: [["GMB:LL", 0]],
      minlevel: 13,
      description: desc([
        "When a creature I see tasrgets me with an attack, I can use my reaction to force a crea within 5 feet of me to make a Dex save against my DC",
        "If it fails, or choose to fail, you switch places with it and it becomes the target of that attack in your place",
      ]),
      action: [["reaction", ""]],
    },
    subclassfeature17: {
      name: "Inscrutable Mind",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc([
        "I add my Int mod to any Int, Wis and Cha saves I make",
        " Also, My thoughts and dreams cannot be read by magic unless I allow it. If a creature attemps to read my mind, I can make a Deception checks to deceive it with false thoughts",
      ]),
      addMod: [
        {
          type: "save",
          field: "Int",
          mod: "Int",
          text: "I add again my Int mod to my Int saves",
        },
        {
          type: "save",
          field: "Wis",
          mod: "Int",
          text: "I add my Int mod to my Wis saves",
        },
        {
          type: "save",
          field: "Cha",
          mod: "Int",
          text: "I add my Int mod to my Cha saves",
        },
      ],
    },
  },
});

// Phantom
AddSubClass("rogue(laserllama)", "phantom", {
  regExpSearch: /phantom/i,
  subname: "Phantom",
  fullname: "Phantom",
  source: [["GMB:LL", 0]],
  abilitySaveAlt: 4,
  features: {
    subclassfeature3: GetRogueSubclassExploits("Phantom", [
      "feint",
      "reliable skill",
      "exposing strike",
      "grasp of night",
      "forgotten knowledge",
    ]),
    "subclassfeature3.1": {
      name: "Knowledge of The Grave",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        'Use the "Choose Feature" button above to choose your Knowledge of The Grave',
        " During my short/long rest, I can replace it",
      ]),
      extraname: "Knowledge of The Grave",
      choices: [
        "Grave Knowledge's skill",
        "Grave Knowledge's Tool",
        "Grave Knowledge's Language",
      ],
      "grave knowledge's skill": {
        skillstxt: "Choose one skill",
      },
      "grave knowledge's tool": {
        toolProfs: ["Any tool (choice)"],
      },
      "grave knowledge's language": {
        languageProfs: [1],
      },
    },
    "subclassfeature3.2": {
      name: "Grave Bolt",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map((n) => {
        if (n < 17)
          return desc([
            "When I deal Sneak Attack damage, I can force a different creature I can see within 30 to make a Wis save against my Expl DC",
            " On a failed save it takes necrotic damage equals to half my Sneak Attack Dice (rounded up)",
          ]);
        return desc([
          "When I deal Sneak Attack damage, I can force a different creature I can see within 30 to make a Wis save against my Expl DC",
          " On a failed save it takes necrotic damage equals to half my Sneak Attack Dice (rounded up)",
          " I can destroy a Soul Trinket (no action required) to force creatures of my choice within 30 feet of my Grave Bolt target to make a Wis save",
          " On a failed save, they suffer the effects of my Grave Bolt (half damage on success) and are Frightened of me unitl the start of my next turn",
        ]);
      }),
    },
    subclassfeature7: {
      name: "Soul Trinkets",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "When a creature of 5 or higher Int dies within 30 feet of me and I have a free hand, I can use my reaction to form a Soul Trinket",
        " The Soul Trinket use the following rules:",
        " \u2022 It is a Tiny Obj. that reflect the true nature and values of the died creature's soul",
        " \u2022 I can posses up to my half rouge level Trinkets (rounded down)",
        " \u2022 I cannot form a new Trinket while at my maximum",
        " \u2022 I have advan. on Con and Death saves while I have at least one Trinket on me",
      ]),
      savetxt: {
        text: ["Adv. on Con and Death saves while I have a Soul Trinket on me"],
      },
      action: [["reaction", ""]],
    },
    "subclassfeature7.1": {
      name: "Dark Offering",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "I gain the following benefits:",
        " \u2022 As an action, I can destroy a Soul Trinket to ask the soul within a question, as if Speak with death spell",
        " \u2022 When I deal Sneak Attack damage, I can destroy a Soul Trinket to change its damage to necrotic (no action required)",
        " \u2022 When a creature fails the save against my Grave Bolt, I can destroy a Soul Trinket to make the target Frightened of me until the start of my next turn (no action required)",
      ]),
      action: [["action", " (ask question)"]],
    },
    subclassfeature13: {
      name: "Spectral Step",
      source: [["GMB:LL", 0]],
      minlevel: 13,
      description: desc([
        "When I Dash I became incorporeal (like a ghost) and I have 15-foot flying speed",
        " If I end my movement in an Obj or crea while in this form, I am instantly shunted to the nearest unoccupied space and take 1d10 Force damage for every 5 feet forced to travel",
        " This Force damage cannot be reduced in any way",
      ]),
      action: [["reaction", ""]],
    },
    subclassfeature17: {
      name: "Death Knell",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc(["Grave Bolt improved (see Grave Bolt)"]),
    },
  },
});

// Psiknife (soulknife archetype)
AddSubClass("rogue(laserllama)", "psiknife", {
  regExpSearch: /psiknife/i,
  subname: "Psiknife",
  fullname: "Psiknife",
  source: [["GMB:LL", 0]],
  abilitySaveAlt: 4,
  features: {
    subclassfeature3: {
      name: "Psionic Awakening",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I have Psi Points I can use to do the following:",
        " \u2022 \x1bMystical Skill.\x1b Whenever I fail an ability check, I can expend 1 Psi Point to gain a bonus equal to my Expl Die (no action) and it is a visibly psionic effect",
        " \u2022 \x1bTelekinetic Leap.\x1b As a bonus action, I can 1 Psi Point and 10 feet of movement to jump up to 30 feet in a line, even if this distance would exceed my remaining speed",
        " \u2022 \x1bTelepathic Link.\x1b As an action, I can spend Psi Points x creature to create a telepathic network. The network last my Int mod hours (min of 1). Unitl on same plane, all creature can telepathically communicate with each other",
        " Once per short rest, I can regain Psi Points equal to my Int mod (min 1)",
      ]),
      action: [
        ["action", "Telepathic Link"],
        ["bonus action", "Telekinetic Leap"],
      ],
      limfeaname: "Psi points",
      usages: [
        0, 0, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
      ],
      recovery: "long rest",
      extraLimitedFeatures: [
        {
          name: "Psi Points Recovery",
          usages: 1,
          additional: "Int Mod",
          recovery: "short rest",
        },
      ],
    },
    "subclassfeature3.1": {
      name: "Psi Blade",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "As part of an attack, or bonus action, I can manifest a Psi Blade from a empty hand",
        "I can use my Int mod for its attack and damage rolls, and I can dispel it at-will (no action required)",
        "The Psi Blade emits bright ligth in a 5-foot radius, its attacks leave no visible marks on the target",
      ]),
      action: [["bonus action", "Psi Blade (manifest)"]],
      weaponOptions: [
        {
          regExpSearch: /^(?=.*psi)(?=.*blade).*$/i,
          name: "Psi Blade",
          source: [["GMB:LL", 0]],
          ability: 4,
          type: "Simple",
          damage: levels.map((n) => {
            var explDie = n < 5 ? 4 : n < 11 ? 6 : n < 17 ? 8 : 10;
            return [1, explDie, "psychic"];
          }),
          range: "Melee, 40/120 ft",
          description: "Finesse, thrown;",
          abilitytodamage: true,
          selectNow: true,
        },
      ],
    },
    subclassfeature7: {
      name: "Empowered Blades",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "I can expend 1 Psi Point to use the following features:",
        " \u2022 \x1bMind Rend.\x1b When I Sneak Attack hit a crea with a Psi Blade, I can use my Cunning Strike to reduce the damage of 2d6 and force the target to make a Int save against my Expl DC or it can't take reaction until the start of my next turn, and during its turn can do only one of the following: move, use one action or bonus action",
        " \u2022 \x1bSentient Strike.\x1b When I miss with my Psi Blade, I can gain a bonus to the attack equal to my Expl Die, possibly turni it into a hit",
      ]),
    },
    "subclassfeature7.1": {
      name: "Metaphysical Shift",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "I can use my Cunning Action to expend Psi Points (up to my Int Mod) and teleport in an unoccupied space up to 20 feet per Psi Point spend away that I can see",
      ]),
    },
    subclassfeature13: {
      name: "Shimmer",
      source: [["GMB:LL", 0]],
      minlevel: 13,
      description: desc([
        "With an action, I can expend 1 Psi Point to cast Invisibility on myself",
        "Casting the spell in this way does not require concentration, but it ends early if I make an attack, cast a spell or touch a creature",
      ]),
      action: [["action", ""]],
    },
    subclassfeature17: {
      name: "Mental Scourge",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc([
        "When I use my Mind Rend feature (form Empowered Blades), I can reduce the Sneak Attack by additional 2d6 (for a total of 4d6) to Stun the target on the fail of the saving throw until the start of my next turn",
        " Additionally, I regain 1 Psi Point at the start of each of my turns in combat",
      ]),
    },
  },
});

// Scout
AddSubClass("rogue(laserllama)", "scout", {
  regExpSearch: /scout/i,
  subname: "Scout",
  fullname: "Scout",
  source: [["GMB:LL", 0]],
  abilitySaveAlt: 4,
  features: {
    subclassfeature3: GetRogueSubclassExploits("Scout", [
      "arresting strike",
      "cunning instinct",
      "craft minor poison",
      "trick shot",
      "craft greater poison",
    ]),
    "subclassfeature3.1": {
      name: "Ambuscade",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map((n) => {
        if (n < 13)
          return desc([
            "When I roll initiative, so long as I'm not surprised, I can use a reaction to take the Hide or Search action or to make a single weapon attack",
            "If I'm suprised, I cannot take this special reaction but I can act onmy first turn of combat as normal",
          ]);
        return desc([
          "When I roll initiative, so long as I'm not surprised, I can use a reaction to take the Hide or Search action or to make a single weapon attack and move half my speed",
          " Also, If I hit a creature thanks to this special reaction, creatures of your choice have advan. on attacks against for the rest of the round",
          "If I'm suprised, I cannot take this special reaction but I can act onmy first turn of combat as normal",
        ]);
      }),
      action: [["reaction", ""]],
    },
    "subclassfeature3.2": {
      name: "Skillfull Hunter",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "When a creature I can see ends its turn within 5 feet of me, I can use my reaction to move up to my half spoeed without provoking opportunity attacks",
        " Also, I add my Expl Die to any Intelligence(Nature) and Wisdom(Survival) checks",
      ]),
      action: [["reaction", ""]],
    },
    subclassfeature7: {
      name: "Wilderness Adept",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "My speed increases by 10 feet and I gain climbing and swimming speed equal to my walk speed",
        " Also I can ignore any difficult terrain caused by natural phenomena",
      ]),
      speed: {
        walk: { spd: 10, enc: 10 },
        climb: { spd: "walk" },
        swim: { spd: "walk" },
      },
      savetxt: {
        immune: ["Diff. Terrain (natural phen.)"],
      },
    },
    "subclassfeature7.1": {
      name: "Deadly Hunter",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "I add my Prof Bonus to my initiative rolls and my Ambuscade is improved (see Ambuscade)",
      ]),
      addMod: {
        type: "skill",
        field: "Init",
        mod: "Prof",
        text: "I  add my Proficiency Bonus to initiative rolls.",
      },
    },
    subclassfeature13: {
      name: "Devious Tactics",
      source: [["GMB:LL", 0]],
      minlevel: 13,
      description: desc([
        "When a creature I see tasrgets me with an attack, I can use my reaction to force a crea within 5 feet of me to make a Dex save against my DC",
        "If it fails, or choose to fail, you switch places with it and it becomes the target of that attack in your place",
      ]),
      action: [["reaction", ""]],
    },
    subclassfeature17: {
      name: "Twin Strike",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc([
        "When I take the Attack action, I can make one weapon attack as a bonus action on the same turn",
        "I can apply my Sneak Attack on this attack, even if I'm already used this turn, so long as these attacke do not target the same creature",
      ]),
      action: [["bonus action", ""]],
    },
  },
});

// Swashbuckler
AddSubClass("rogue(laserllama)", "swashbuckler", {
  regExpSearch: /swashbuckler/i,
  subname: "Swashbuckler",
  fullname: "Swashbuckler",
  source: [["GMB:LL", 0]],
  abilitySaveAlt: 4,
  features: {
    subclassfeature3: GetRogueSubclassExploits("Swashbuckler", [
      "commanding presence",
      "parry",
      "glancing blow",
      "soothing speech",
      "recruit informant",
    ]),
    "subclassfeature3.1": {
      name: "Fancy Footwork",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "If I make a melee attack against a creature, it cannot target me with opportunity attacks for the rest of the turn",
      ]),
    },
    "subclassfeature3.2": {
      name: "Restless Swagger",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I don't need advantage to sneak attack if my target is the only one within 5 ft of me",
        "I still can't sneak attack if I have disadv.; I add my Charisma modifier to initiative rolls (min of 1)",
      ]),
      addMod: {
        type: "skill",
        field: "Init",
        mod: "max(Cha|1)",
        text: "I can add my Charisma modifier to initiative rolls.",
      },
    },
    subclassfeature7: {
      name: "Panache",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "I can use my Cunning strike to reduce by 1d6 my Sneak attack to cause one of the effects below until the start of my next turn:",
        "\u2022 One target that can see you within 30 feet must make a Wis save against my Expl DC or be Charmed by me",
        "\u2022 The target that taken my Sneak Attack damage make a Wis save against my Expl DC or has disadvan. on attacks against targets other than you and cannot make oppotunity attacks",
      ]),
    },
    subclassfeature13: {
      name: "Elegant Warrior",
      source: [["GMB:LL", 0]],
      minlevel: 13,
      description: desc([
        "When I take the Dash action, including when I use it as part of my Cunning Action, opportunity attacks against me are made with disadv.",
        " Also, I add my Expl Die to my Dex(Acrobatics), Str(Athletics) and Cha(Performance) checks",
      ]),
    },
    subclassfeature17: {
      name: "Twin Strike",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc([
        "When I miss an attack I can add my Cha mod (min +1) to my attack roll, possibily turning the miss in a hit",
      ]),
      usages: "Cha mod per ",
      usagescalc: "event.value = Math.max(1, What('Cha Mod'));",
      recovery: "short rest",
    },
  },
});

// Archetypes from Expanded Rogue
// Acrobat
AddSubClass("rogue(laserllama)", "acrobat", {
  regExpSearch: /acrobat/i,
  subname: "Acrobat",
  fullname: "Acrobat",
  source: [["GMB:LL", 0]],
  abilitySaveAlt: 4,
  features: {
    subclassfeature3: GetRogueSubclassExploits("Acrobat", [
      "aerial maneuver",
      "lightstep",
      "dirty hit",
      "trick shot",
      "survey settlement",
    ]),
    "subclassfeature3.1": {
      name: "Acrobatic Training",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I gain the following benefits:",
        " \u2022 I have climb speed equal to my walk speed",
        " \u2022 I do not make ability check, if I move half my speed, to climb difficult and sheer surfaces",
        " \u2022 I can use Dex to calculate jump distances",
        " \u2022 My unarmed strikes gain the finesse property and deals my Expl Die + Str/Dex (my choice) Bludg. damage on hit",
      ]),
      speed: {
        climb: { spd: "walk" },
      },
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (v.baseWeaponName == "unarmed strike") {
              var dd = fields.Damage_Die == 1;
              var aExploitDie = (function (n) {
                return n < 5 ? 4 : n < 11 ? 6 : n < 17 ? 8 : 10;
              })(classes.known["fighter(laserllama)"].level);
              if (dd !== aExploitDie) {
                fields.Damage_Die = "1d" + aExploitDie;
              }
              fields.Description +=
                (fields.Description ? "; " : "") + "Finesse";
            }
          },
          "My unarmed strikes deals my Exploit Die damage.",
          1,
        ],
      },
    },
    "subclassfeature3.2": {
      name: "Flying Strike",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "When I fall 5 feet then hit a creature with a melee weapon attack, that attack qualifies for my Sneak Attack so long as I do not have disadv.",
        "When I Sneak Attack this way, the target must succeed on a Str save against my Expl DC or fall prone. Targets larger than me have advan. on their save",
      ]),
    },
    subclassfeature7: {
      name: "Death From Above",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "If I make an weapon attack whil airborne and at least 10 feet off the ground I have advan. on that attack",
      ]),
    },
    "subclassfeature7.1": {
      name: "Slow Fall",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "I can use the Aerial Maneuver Exploit at-will, without expending an Expl Die",
        "If I land on something soft to break my fall, like a body of water or wagon of hay, I take no fall damage",
      ]),
      spellChanges: {
        "aerial maneuver": {
          description: "Reduce fall damage by five times my level",
          changes:
            "I can make use this Exploit at-will, without expending an Exploit Die for it",
        },
      },
    },
    subclassfeature13: {
      name: "Defy Death",
      source: [["GMB:LL", 0]],
      minlevel: 13,
      description: desc([
        "I add my Prof. Bonus to my Death saves and when I roll 20 or more on Death saves, it has the same effect as if I rolled a 20 on the d20",
      ]),
    },
    "subclassfeature13.1": {
      name: "Stunning Leap",
      source: [["GMB:LL", 0]],
      minlevel: 13,
      description: desc([
        "As a bonus action, I can spend 5 feet of movement to jumpup to 20 feet, even if this would exceed my remaining speed",
      ]),
      action: [["bonus action", ""]],
    },
    subclassfeature17: {
      name: "Masterfull Aerialist",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc([
        "When I make a Dexterity check or save and the total is lower than my Dexterity score, I can use my Dexterity score in place of my roll",
      ]),
    },
  },
});

// Avenger
AddSubClass("rogue(laserllama)", "avenger", {
  regExpSearch: /avenger/i,
  subname: "Avenger",
  fullname: "Avenger",
  source: [["GMB:LL", 0]],
  abilitySave: 6,
  spellcastingFactor: "avenger3",
  spellcastingList: {
    spells: AvengerList,
  },
  spellcastingKnown: {
    spells: [0, 0, 2, 2, 3, 3, 4, 4, 5, 5, 5, 5, 6, 6, 6, 6, 7, 7, 7, 7],
  },
  features: {
    subclassfeature3: {
      name: "Spellcasting",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map(function (n) {
        var divineLimit = n < 7 ? "1st" : n < 13 ? "2nd" : n < 19 ? "3rd" : "4th";
        return desc([
          "I can cast known Avenger spells, using Charisma as my spellcasting ability",
          "To manifest a spell, I expend Divine Favor equal to the spell's level",
          "I cannot cast or learn spells of a level above my divine limit (" + divineLimit + " level)",
          "I can replace any spell I know with another when I gain a Rogue level",
        ]);
      }),
      additional: [
        "", "",
        "2 Spells Known (DL: 1st)",
        "3 Spells Known (DL: 1st)", 
        "3 Spells Known (DL: 1st)",
        "3 Spells Known (DL: 1st)",
        "4 Spells Known (DL: 2nd)",
        "4 Spells Known (DL: 2nd)",
        "4 Spells Known (DL: 2nd)",
        "5 Spells Known (DL: 2nd)",
        "5 Spells Known (DL: 2nd)",
        "5 Spells Known (DL: 2nd)",
        "6 Spells Known (DL: 3rd)",
        "6 Spells Known (DL: 3rd)",
        "6 Spells Known (DL: 3rd)",
        "7 Spells Known (DL: 3rd)",
        "7 Spells Known (DL: 3rd)",
        "7 Spells Known (DL: 3rd)",
        "8 Spells Known (DL: 4th)",
        "8 Spells Known (DL: 4th)"
      ],
      // autoSelectExtrachoices: [
      //   {
      //     extrachoice: "spellcasting",
      //     minlevel: 3,
      //   },
      // ],
    },
    "subclassfeature3.1": {
      name: "Anointed Magic",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc("I gain Divine Favor uses to fuel my spells and class features"),
      limfeaname: "Divine Favor",
      usages: [0, 0, 2, 3, 3, 3, 4, 4, 4, 5, 5, 5, 6, 6, 6, 7, 7, 7, 8, 8],
      recovery: "short rest",
      eval: function () {
        AddString("Extra.Notes", "Anointed Magic:");
      },
      removeeval: function () {
        AddString("Extra.Notes", "Anointed Magic:");
      },
    },
    "subclassfeature3.2": {
      name: "Consecrated Blade",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "During a short/long rest I can perform a 1h ritual to consecrate a melee weapon (write 'consecrated' in its name)",
        "If I perform this ritual on another weapon, the holy benefits transfer to it",
        "My consecrated weapon counts as a Holy Symbol I can use to cast spells",
        "I can Sneak Attack with this weapon even if it does not have the finesse property",
        "However all other rules for Sneak Attack still apply",
      ]),
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (
              classes.known["rogue(laserllama)"] &&
              classes.known["rogue(laserllama)"].level >= 3 &&
              v.isMeleeWeapon &&
              /consecrated/i.test(v.WeaponTextName) &&
              !/\bfinesse\b/i.test(fields.Description)
            ) {
              v.sneakAtk = Math.ceil(
                classes.known["rogue(laserllama)"].level / 2
              );
              fields.Description +=
                (fields.Description ? "; " : "") +
                "Sneak attack " +
                v.sneakAtk +
                "d6";
            }
          },
          "My consecrated weapon can be used as Holy Symbol and I can Sneak Attack with it",
        ],
      },
    },
    subclassfeature7: {
      name: "Channel Divinity",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "I gain the miraculous effects below and I can use each of them once per short/long rest",
        "When I have no uses I can expend 1 Divine Favor to use it again:",
        " \u2022 \x1bDivine Awareness.\x1b As a bonus action, for the next 10 minutes, I know the location of any celestial, elemental, fey, fiend, or undead within 60 feet of me that isn't behind total cover or hidden from divination magic.",
        " \u2022 \x1bVow of Enmity.\x1b As a bonus action, I can choose a creature I can see within 30 feet. For 1 minute or until it dies, I can choose to deal radiant damage to it with my weapon attacks, and I have advan. on attack rolls against it.",
      ]),
      extraLimitedFeatures: [
        {
          name: "Divine Awareness",
          usages: 1,
          recovery: "short rest",
        },
        {
          name: "Vow of Enmity",
          usages: 1,
          recovery: "short rest",
        },
      ],
      action: [
        ["bonus action", "Divine Awareness"],
        ["bonus action", "Vow of Enmity"],
      ],
    },
    subclassfeature13: {
      name: "Divine Step",
      source: [["GMB:LL", 0]],
      minlevel: 13,
      description: desc([
        "As a bonus action, I can expend 2 Divine Favor to teleport to an unoccupied space I can see within 60 feet that is within 5 feet of a hostile creature",
        "When I appear I can make one weapon attack against it with advantage",
      ]),
      action: [["bonus action", ""]],
    },
    subclassfeature17: {
      name: "Hand of the Gods",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc([
        "I regain the use of both my Channel Divinity features when I roll initiative",
        "Also, when I reduce the target of Vow of Enmity to 0 hit points, I regain expended Divine Favor equal to my Cha mod (min of 1)",
      ]),
    },
  },
});

// Bloodknife
AddSubClass("rogue(laserllama)", "bloodknife", {
  regExpSearch: /bloodknife/i,
  subname: "Bloodknife",
  fullname: "Bloodknife",
  source: [["GMB:LL", 0]],
  abilitySaveAlt: 4,
  features: {
    subclassfeature3: GetRogueSubclassExploits("Bloodknife", [
      "commanding presence",
      "precision strike",
      "crippling strike",
      "martial focus",
      "bewildering blow",
    ]),
    "subclassfeature3.1": {
      name: "Dread Strike",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map((n) => {
        if (n < 7)
          return desc([
            "When I hit a creature with a melee attack I can reduce my max HP by one roll of my Expl Die to gain these benefits:",
            " \u2022 I do not need advan. to qualify for Sneak Attack",
            " \u2022 I use d8s instead of d6s for my Sneak Attack",
            " \u2022 I can choose for the attack's damage to be necrotic",
            " \u2022 If I reduce the target to 0 HP I gain temp HP equal to my Rogue level",
            "This reduction to my max HP last until the end of my next long rest",
          ]);
        if (n < 17)
          return desc([
            "When I hit a creature with a melee attack I can reduce my max HP by one roll of my Expl Die to gain these benefits:",
            " \u2022 I do not need advan. to qualify for Sneak Attack",
            " \u2022 I use d8s instead of d6s for my Sneak Attack",
            " \u2022 I can choose for the attack's damage to be necrotic",
            " \u2022 I gain temp HP equal to my Rogue level (Siphon Vitality)",
            " \u2022 If I reduce the target to 0 HP I do not reduce my max HP for this attack (Siphon Vitality)",
            " \u2022 The target cannot regain hit points until it finishes a long rest (Hellish Curse)",
            " \u2022 I can reduce the damage of my Sneak Attack by 1d8 to force the target to make a Cha save against my Exploit DC or be Frightened by me until the end of its next turn (Hellish Curse)",
            "This reduction to my max HP last until the end of my next long rest",
          ]);
        return desc([
          "When I hit a creature with a melee attack I can reduce my max HP by one roll of my Expl Die to gain these benefits:",
          " \u2022 I do not need advan. to qualify for Sneak Attack",
          " \u2022 I use d8s instead of d6s for my Sneak Attack",
          " \u2022 I can choose for the attack's damage to be necrotic",
          " \u2022 I gain temp HP equal to my Rogue level (Siphon Vitality)",
          " \u2022 If I reduce the target to 0 HP I do not reduce my max HP for this attack (Siphon Vitality)",
          " \u2022 The target cannot regain hit points until it finishes a long rest (Hellish Curse)",
          " \u2022 I can reduce the damage of my Sneak Attack by 1d8 to force the target to make a Cha save against my Exploit DC or be Frightened (Hellish Curse + Touch of Death)",
          "This reduction to my max HP last until the end of my next long rest",
        ]);
      }),
    },
    "subclassfeature3.2": {
      name: "Forked Tongue",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I can choose between Deception(Infernal) or Intimidation(Abyssal)",
        "I learn the language and gain proficiency on the skill based on my choice",
        "Whenever I make an ability with the chosen skill, I treat as an 8 every roll on the d20 lower than that",
      ]),
      choices: ["Deception(Infernal)", "Intimidation(Abyssal)"],
      "deception(infernal)": {
        languageProfs: ["Infernal"],
        skillstxt: ["Deception"],
      },
      "intimidation(abyssal)": {
        languageProfs: ["Abyssal"],
        skillstxt: ["Intimidation"],
      },
    },
    subclassfeature7: {
      name: "Hellish Curse",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc(["My Dread Strike is improved (see Dread Strike)"]),
    },
    "subclassfeature7.1": {
      name: "Siphon Vitality",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "My Dread Strike is improved again (see Dread Strike)",
      ]),
    },
    subclassfeature13: {
      name: "Umbral Veil",
      source: [["GMB:LL", 0]],
      minlevel: 13,
      description: desc([
        "I am always under the effect of the Nondetection Spell.",
        " Also, I can cast Greater Invisibility on myself once per long rest, without expending a spell slot",
      ]),
      spellcastingBonus: [
        {
          name: "Umbral Veil",
          spells: ["nondetection", "greater invisibility"],
          selection: ["nondetection", "greater invisibility"],
        },
      ],
      spellChanges: {
        nondetection: {
          description:
            "1 crea or object up to 10 cu ft hidden from all divination magic",
          changes: "I am always under the effects of this spell",
        },
        "greater invisibility": {
          description:
            "1 crea invisible until end of the spell; anything the target is wearing or carrying is also invisible",
          changes:
            "I can cast this spell without expending a spell slot once per long rest",
        },
      },
      extraLimitedFeatures: [
        {
          name: "Greater Invisibility (Umbral Veil)",
          usages: 1,
          recovery: "long rest",
        },
      ],
    },
    subclassfeature17: {
      name: "Touch of Death",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc([
        "Dread Strike improved again (see Dread Strike)",
        "The creature Frightened thanks my Dread Strike repeats the save every start of its turns, ending the condition on a success or gaining 1 level of Exhaustion",
      ]),
    },
  },
});

// Gambler
AddSubClass("rogue(laserllama)", "gambler", {
  regExpSearch: /gambler/i,
  subname: "Gambler",
  fullname: "Gambler",
  source: [["GMB:LL", 0]],
  abilitySaveAlt: 4,
  features: {
    subclassfeature3: GetRogueSubclassExploits("Gambler", [
      "quick quip",
      "subtle con",
      "soothing speech",
      "trick shot",
      "incite violence",
    ]),
    "subclassfeature3.1": {
      name: "Gambler's Knack",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I gain proficiency with improvised weapons, playing cards and a gaiming set of my choice",
        " Whenever I made an ability check with a gaming set I gain a bonus equal to my Expl Die",
        " My improvised weapons attacks uses my Expl Die for the damage if not already higher",
        " I add my Prof Bonus to checks of a game I don't have familiarity with, if I spend 1 minute observing or playing that game. I can gain this benefit only with one game a time",
      ]),
      weaponProfs: [false, false, ["Improvised weapons"]],
      toolProfs: ["playing cards", "Any gaming set"],
    },
    "subclassfeature3.2": {
      name: "Pick a Card",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "Deck of cards count as simple weapons for me",
        "Once per turn, when I hit with a creatur with a playing card attack the number rolled on the damage die, grants me a bonus effect as shown below:",
        " \u2022 (1): The target speed is reduced to 10 feet until the beginning of my next turn",
        " \u2022 (1): The target speed is reduced to 10 feet until the beginning of my next turn",
        " \u2022 (1): The target speed is reduced to 10 feet until the beginning of my next turn",
        " \u2022 (1): The target speed is reduced to 10 feet until the beginning of my next turn",
        "I can use a deck of standard playing cards to determine the bonus effect applied by drawing a random card on hit and checking its suit: clubs(1), diamonds(2), hearts (3), spades (4), or Joker (my choice)",
      ]),
      weaponOptions: [
        {
          regExpSearch: /^(?=.*playing)(?=.*cards).*$/i,
          name: "Playing Cards",
          source: [["GMB:LL", 0]],
          ability: 4,
          type: "Simple",
          damage: levels.map((n) => {
            var dice = n < 17 ? 1 : 2;
            return [1, dice, "slashing"];
          }),
          range: "Melee, 30/60 ft",
          description: "Finesse, thrown;",
          abilitytodamage: true,
          selectNow: true,
        },
      ],
    },
    subclassfeature7: {
      name: "Strange Luck",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "On weapon attacks I score a critical hit on a roll of 7 or 20 on the d20",
        "On weapon attacks I score a critical failure on a roll of 13 or 1 on the d20",
      ]),
    },
    subclassfeature13: {
      name: "Quickdraw",
      source: [["GMB:LL", 0]],
      minlevel: 13,
      description: desc([
        "I have advantage on initiative rolls and if I made a playing card attack during my first turn, I can choose the effect of 'Pick a Card'",
        " In addition, I learn the Quick Draw Exploit, it doesn't count against my total known, I can use it also with my thrown weapon attacks, but I cannot replace it",
      ]),
      advantages: [["Initiative", true]],
      spellcastingBonusElsewhere: {
        addTo: "devious exploits",
        spellcastingBonus: {
          name: "Quick Draw",
          spellcastingAbility: 1,
          spells: ["quick draw"],
          selection: ["quick draw"],
          prepared: true,
        },
      },
      toNotesPage: [
        {
          // What is added to the notes page
          name: "Quick Draw [4th degree]",
          note: desc(SpellsList["quick draw"].descriptionFull),
          amendTo: "Gambler",
        },
      ],
      spellChanges: {
        "quick draw": {
          description:
            "Use bns (including when activating this expl) to make 2 ranged weapon atks as long as I have ammo",
          changes: "I can use this Exploit also with thrown weapons",
        },
      },
    },
    subclassfeature17: {
      name: "Jackpot",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc([
        "Whenever I roll a 6 on a d6 of my Sneak Attack, I roll another d6 and add it to the total. I continue rollind additional dice until I don't roll a 6",
        " In addition my palying card deals now 2d4+Dex and I choose which of those d4 results is applied for my Pick a Card for that attack",
        " If I score a critical hit with a playing card attack, I can choose for two of my Pick a Card effects to happen",
      ]),
      action: [["bonus action", ""]],
    },
  },
});

// Ruffian
AddSubClass("rogue(laserllama)", "ruffian", {
  regExpSearch: /ruffian/i,
  subname: "Ruffian",
  fullname: "Ruffian",
  source: [["GMB:LL", 0]],
  abilitySaveAlt: 4,
  features: {
    subclassfeature3: GetRogueSubclassExploits("Ruffian", [
      "streetwise",
      "sweeping strike",
      "dirty hit",
      "grasp of night",
      "recruit informant",
    ]),
    "cunning action": {
      name: "Cunning Action",
      source: ["GMB:LL", 0],
      minlevel: 2,
      description: levels.map(function (n) {
        if (n < 3)
          return desc(
            "I can use a bonus action to take the Dash, Disengage, Hide or Use an Object action"
          );
        if (n < 11)
          return desc(
            "I can use a bonus action to make an unarmed strike attack or take one of the following actions: Dash, Disengage, Hide, Use an Object, Grapple or Shove"
          );
        return desc(
          "I can use a bonus action to make an unarmed strike attack or take one of the following actions: Dash, Disengage, Hide, Use an Object, Grapple or Shove",
          "Also I can take a second bonus action each turn but cannot use the same bonus action twice"
        );
      }),
      action: [["bonus action", ""]],
    },
    "subclassfeature3.1": {
      name: "School of Hard Knocks",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I gain the following benefits:",
        " \u2022 I gain proficiency with improvised weapons",
        " \u2022 My unarmed strikes use my Expl Die for the damage",
        " \u2022 I can apply my sneak attack with impovised weapons, unarmed strikes and simple melee weapons. All other rules still apply",
        " \u2022 My Cunning Action is improved (see Cunnig Action)",
        " \u2022 I can use my Con instead of my Dex to calc my AC in light and medium armor",
      ]),
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            var explDie = levels.map((n) => {
              return n < 5 ? 4 : n < 11 ? 6 : n < 17 ? 8 : 10;
            });
            if (v.baseWeaponName == "unarmed strike") {
              fields.Damage_Die = "1d" + explDie;
              v.sneakAtk = Math.ceil(
                classes.known["rogue(laserllama)"].level / 2
              );
              fields.Description +=
                (fields.Description ? "; " : "") +
                "Sneak attack " +
                v.sneakAtk +
                "d6";
            }
            if (
              /improvised/i.test(v.WeaponName + v.baseWeaponName) ||
              /improvised weapon/i.test(v.theWea.type) ||
              /simple/i.test(v.theWea.type)
            ) {
              fields.Description +=
                (fields.Description ? "; " : "") +
                "Sneak attack " +
                v.sneakAtk +
                "d6";
            }
          },
          "My unarmed strikes deal Expl Die damage.",
          1,
        ],
      },
      extraAC: [
        {
          name: "School of Hard Knocks",
          mod: "max(Con-Dex|0)",
          text: "I can use my Con to calculate my AC instead of Dex while wearing light/medium armor",
          stopeval: function (v) {
            return !v.wearingArmor || v.heavyArmor; // light/medium armor only
          },
        },
      ],
    },
    "subclassfeature3.2": {
      name: "Shake Down",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I gain proficiency in Intimidation",
        " Whenever I make a Str(Athletics) or Str(Intimidation) I treat as an 8 every roll on the d20 lower than that",
      ]),
    },
    subclassfeature7: {
      name: "Intimidating Blow",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "I can use my Cunning Strike to reduce the Sneak Attack damage bonus by 1d6",
        " When I do, the target of my Sneak Attack or a different creature I can see within 30 feet is forced to make a Wis save or be Frightened of me until the end of my next turn",
      ]),
    },
    "subclassfeature7.1": {
      name: "Nerves of Steel",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "I am immune to Frightened condition and hava advantage on attack rolls against frightened creature",
      ]),
      savetxt: {
        immune: ["Frightened"],
      },
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (v.baseWeaponName == "unarmed strike") {
              fields.Description +=
                (fields.Description ? "; " : "") + "count as magical";
            }
          },
          "My unarmed strikes count as magical for overcome resistances and immunities.",
          1,
        ],
      },
    },
    subclassfeature13: {
      name: "Criminal Connections",
      source: [["GMB:LL", 0]],
      minlevel: 13,
      description: desc([
        "I learn the Clandestine Source Exploit. It does not count against my Exploits Known, but I cannot replace it.",
      ]),
      spellcastingBonusElsewhere: {
        addTo: "devious exploits",
        spellcastingBonus: {
          name: "Criminal Connections",
          spellcastingAbility: 2,
          spells: ["clandestine source"],
          selection: ["clandestine source"],
          prepared: true,
        },
      },
      toNotesPage: [
        {
          // What is added to the notes page
          name: "Clandestine Source [4th degree]",
          note: desc(SpellsList["clandestine source"].descriptionFull),
          amendTo: "Ruffian",
        },
      ],
    },
    "subclassfeature13.1": {
      name: "Dodge & Counter",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "When a creature one size larger than you or smaller misses me with a melee attack, I can use my reaction to force it a Dex save against my Expl DC. On a failed save, it suffers one of the following:",
        " \u2022 It falls prone and its speed is 0 for the rest of that turn",
        " \u2022 It is automatically grapple it by me if I have a free hand",
        " \u2022 I can make one unarmed strike attack against it",
      ]),
      action: [["reaction", ""]],
    },
    subclassfeature17: {
      name: "Ruthless Strike",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc([
        "When I add the Sneak Attack damage bonus to a melee weapon attack against a creature frightened of me, I can choose for my attack to become an automatic critical hit",
      ]),
      usages: 1,
      recovery: "short rest",
    },
  },
});

// Saboteur
AddSubClass("rogue(laserllama)", "saboteur", {
  regExpSearch: /saboteur/i,
  subname: "Saboteur",
  fullname: "Saboteur",
  source: [["GMB:LL", 0]],
  abilitySaveAlt: 4,
  features: {
    subclassfeature3: GetRogueSubclassExploits("Saboteur", [
      "alchemical adept",
      "smoke bomb",
      "alchemical oil",
      "flash bomb",
      "bewildering blow",
    ]),
    "subclassfeature3.1": {
      name: "Alchemical Explosives",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc(
        "I learn how to craft explosives (see 3rd page)",
        'Use the "Choose Feature" button above to choose Explosives'
      ),
      action: [["action", "Craft Saboteur Explosive"]],
      extraname: "Alchemical Explosives",
      toolProfs: ["Alchemist's supplies"],
      extraTimes: [
        "",
        "",
        2,
        2,
        2,
        2,
        3,
        3,
        3,
        3,
        3,
        3,
        4,
        4,
        4,
        4,
        5,
        5,
        5,
        5,
      ],
      extrachoices: [
        "Glittering Dust",
        "Hand Bomb",
        "Seismic Charge",
        "Tangleroot",
        "Thunder Pulse",
        "Alchemical Webbing",
        "Caustic Bomb",
        "Incendiary Bomb",
        "Noxious Gas",
        "Greater Seismic Charge",
        "Vitriolic Charge",
        "Astral Vortex",
      ],
      eval: function () {
        AddString("Extra.Notes", "Alchemical Explosives:");
        show3rdPageNotes();
      },
      removeeval: function () {
        AddString("Extra.Notes", "Alchemical Explosives:");
      },
      "alchemical explosives": {
        name: "Alchemical Explosives",
        extraname: "Saboteur 3",
        source: [["GMB:LL", 0]],
        description: levels.map(function (n) {
          var numExplosives =
            n < 7 ? "two" : n < 13 ? "three" : n < 17 ? "four" : "five";

          return desc([
            "I know" + numExplosives + " Alchemical Explosives ",
            "Whenever I learn a Devious Exploit, I can forgo that Exploit to learn another Explosive",
            "During each long rest, I can spend 1 hour using alchemist's supplies to craft one of each Explosive I know, without expending Dice",
            "An Explosive is a Tiny object (my choice for the appearance but it not changes the explosive effects)",
            "As an action, I can use alchemist' supllies to craft one Explosive I know by spending the number of Exploit Dice listed in its description",
            "When I craft an Explosive this way, I do not regain the Exploit Dice until the explosive is detonated or destroyed",
            "A creature can take the Use an Object action to throw one of my Saboteur Explosives at a point it can see within 60 feet. It explodes on imipact, generating the effets in its description centered on the point of impact",
            "The Explosives uses my Exploit DC for the saving throws of their effects",
          ]);
        }),
      },
      autoSelectExtrachoices: [
        {
          extrachoice: "alchemical explosives",
          minlevel: 3,
        },
      ],
      toNotesPage: [
        {
          name: "Explosives Known",
          note: desc(["Below are all Saboteur Explosives I know."]),
        },
      ],
      "glittering dust": {
        name: "Glittering Dust",
        additional: "Cost: 1 Exploit Die",
        submenu: "3rd-level Rogue",
        note: desc(
          "On impact, reflective particles cover a 20-foot cube, forcing creatures in that area to make a Dexterity saving throw. On a failed save, creatures are covered in these particles, and any attack roll made against them is made with advantage.",
          "A creature can use its action to scrape all these reflective particles off of it, ending the effects of this Explosive."
        ),
        amendTo: "Explosives Known",
      },
      "hand bomb": {
        name: "Hand Bomb",
        submenu: "3rd-level Rogue",
        additional: "Cost: 1 Exploit Die",
        note: desc(
          "On impact, this simple, yet effective explosive detonates and forces targets within 5 feet to make a Dexterity saving throw.",
          "They take fire damage equal to your Sneak Attack bonus on a failed save, and half as much fire damage on a success."
        ),
        amendTo: "Explosives Known",
      },
      "seismic charge": {
        name: "Seismic Charge",
        submenu: "3rd-level Rogue",
        additional: "Cost: 1 Exploit Die",
        note: desc(
          "On impact, this bomb disrupts the earth, forcing creatures within 10 feet to make a Strength saving throw. On a failure, they take thunder damage equal to half your Sneak Attack bonus, and any Large or smaller creatures fall Prone. On asuccess, they take half as much damage and don't fall.",
          "Non-magical structures of wood, earth, or stone take the maximum damage from this Explosive, and the area of the explosion becomes difficult terrain until it is cleared."
        ),
        amendTo: "Explosives Known",
      },
      tangleroot: {
        name: "Tangleroot",
        submenu: "3rd-level Rogue",
        additional: "Cost: 1 Exploit Die",
        note: desc(
          "On impact, synthetic vines burst forth, and creatures within 5 feet must succeed on a Dexterity saving throw or they are Restrained for 1 minute. As an action, a creature can make a Strength or Dexterity check, escaping on a success."
        ),
        amendTo: "Explosives Known",
      },
      "thunder pulse": {
        name: "Thunder Pulse",
        submenu: "3rd-level Rogue",
        additional: "Cost: 1 Exploit Die",
        note: desc(
          "On impact, a wave of thunderous force bursts forth, audible out to a distance of 300 feet, forcing everything in a 15-foot cube to make a Constitution saving throw. On a failure, they take thunder damage equal to half your Sneak Attack bonus and are pushed 10 feet away from the point of impact. On asuccess, they take half as much damage and are not moved."
        ),
        amendTo: "Explosives Known",
      },
      "alchemical webbing": {
        name: "Alchemical Webbing",
        submenu: "7th-level Rogue",
        prereqeval: function (v) {
          if (classes.known["rogue(laserllama)"]) {
            return classes.known["rogue(laserllama)"].level >= 7;
          }
          return false;
        },
        additional: "Cost: 2 Exploit Die",
        note: desc(
          "On impact, sticky alchemical webbing covers a 20-foot cube creating difficult terrain and lightly obscuring in that area. If there aren't any vertical surfaces, walls, or ceilings to supportthe webbing, it collapses and instantly dissolves.",
          "Any creature that starts its turn in or enters the area during its turn must make a Dexterity saving throw or be Restrained by the webbing. As an action, a Restrained creature can makea Strength or Dexterity check, escaping on a success.",
          "The alchemical webbing remains for 1 minute. If it takes any fire damage all the webbing is instantly dissolved."
        ),
        amendTo: "Explosives Known",
      },
      "caustic bomb": {
        name: "Caustic Bomb",
        submenu: "7th-level Rogue",
        prereqeval: function (v) {
          if (classes.known["rogue(laserllama)"]) {
            return classes.known["rogue(laserllama)"].level >= 7;
          }
          return false;
        },
        additional: "Cost: 2 Exploit Die",
        note: desc(
          "On impact, caustic acid explodes outward, forcing creatures within 10 feet to make a Dexterity saving throw. On a failure, targets take acid damage equal to your Sneak Attack bonus and are coated in alchemical acid for 1 minute. On a success, they take half as much acid damage and are not coated.",
          "While coated in acid, a creature takes acid damage equal to twice your Exploit Die until it uses its action to remove it."
        ),
        amendTo: "Explosives Known",
      },
      "incendiary bomb": {
        name: "Incendiary Bomb",
        submenu: "7th-level Rogue",
        prereqeval: function (v) {
          if (classes.known["rogue(laserllama)"]) {
            return classes.known["rogue(laserllama)"].level >= 7;
          }
          return false;
        },
        additional: "Cost: 2 Exploit Die",
        note: desc(
          "On impact, a ball of fire rushes outward in a 30-foot radius,forcing creatures within the area to make a Dexterity savingthrow. Creatures take fire damage equal to your Sneak Attackbonus on a failed save, and half as much on a success.",
          "Moreover, any flammable objects in this area are ignited."
        ),
        amendTo: "Explosives Known",
      },
      "noxious gas": {
        name: "Noxious Gas",
        submenu: "7th-level Rogue",
        prereqeval: function (v) {
          if (classes.known["rogue(laserllama)"]) {
            return classes.known["rogue(laserllama)"].level >= 7;
          }
          return false;
        },
        additional: "Cost: 2 Exploit Die",
        note: desc(
          "On impact, a cloud of putrid yellow gas spreads outward in a 20-foot radius sphere. It spreads around corners and heavily obscures the area for 1 minute. Any creature that starts its turn within the cloud must succeed on a Constitution saving throw or spend its turn gagging a reeling from the gas. Any creature that is immune to poison or doesn't need to breathe automatically succeeds on its Constitution saving throw."
        ),
        amendTo: "Explosives Known",
      },
      "greater seismic charge": {
        name: "Greater Seismic Charge",
        submenu: "13th-level Rogue",
        prereqeval: function (v) {
          if (classes.known["rogue(laserllama)"]) {
            return classes.known["rogue(laserllama)"].level >= 13;
          }
          return false;
        },
        additional: "Cost: 3 Exploit Die",
        note: desc(
          "On impact, this bomb disrupts the earth, forcing creatures within 30 feet to make a Strength saving throw. On a failure, they take thunder damage equal to your Sneak Attack bonusand any Huge or smaller creatures fall Prone. On a success,they take half as much damage and do not fall Prone.",
          "Non-magical structures of wood, earth, or stone take the maximum damage from this Explosive, and the area of the explosion becomes difficult terrain until it is cleared."
        ),
        amendTo: "Explosives Known",
      },
      "vitriolic charge": {
        name: "Vitriolic Charge",
        submenu: "13th-level Rogue",
        prereqeval: function (v) {
          if (classes.known["rogue(laserllama)"]) {
            return classes.known["rogue(laserllama)"].level >= 13;
          }
          return false;
        },
        additional: "Cost: 3 Exploit Die",
        note: desc(
          "On impact, a wave of acidic chemicals explodes outward in a 30-foot radius forcing any creatures in that area to make a Dexterity saving throw. On a failure, they take acid damage equal to your Sneak Attack bonus, and acid damage equal to half your Sneak Attack bonus at the start of their next turn."
        ),
        amendTo: "Explosives Known",
      },
      "astral vortex": {
        name: "Astral Vortex",
        submenu: "17th-level Rogue",
        prereqeval: function (v) {
          if (classes.known["rogue(laserllama)"]) {
            return classes.known["rogue(laserllama)"].level >= 17;
          }
          return false;
        },
        additional: "Cost: 4 Exploit Die",
        note: desc(
          "On impact, a wave of acidic chemicals explodes outward in a 30-foot radius forcing any creatures in that area to make a Dexterity saving throw. On a failure, they take acid damage equal to your Sneak Attack bonus, and acid damage equal to half your Sneak Attack bonus at the start of their next turn."
        ),
        amendTo: "Explosives Known",
      },
    },
    "subclassfeature3.2": {
      name: "Destructive Strikes",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "My Sneak Attack always apply on Constructs, so long I don't have disadv.",
        " Whenever I damage a non-magical structure with a melee weapon attack, an Explosive or Exploit, it is an automatic critical hit",
      ]),
    },
    subclassfeature7: {
      name: "Quick Chemistry",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "I can use my bonus action to expend Expl Die to craft an Explosive I know",
        " Whenever I craft an Explosive, I can change its damage to magical bludgeoning, piercing, fire or thunder",
      ]),
      action: [["action", "Craft Saboteur Explosive"]],
    },
    subclassfeature13: {
      name: "Sabotage",
      source: [["GMB:LL", 0]],
      minlevel: 13,
      description: desc([
        "Any creature that is Suprised or hasn't yet acted during the first round of combat has disadv. on its initial save against my Saboteur Explosive thrown by me",
        " In addition, whenever I roll initiative, I can craft one Hand Bomb without expending an Expl Die, or craft one Explosive I know expending Expl Dice as normal",
      ]),
    },
    subclassfeature17: {
      name: "Hair Trigger",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc([
        "I can craft my Explosive with a remote trigger. As an action, I can explode one Explosion with the remote trigger as long as I am within 200 feet of it",
      ]),
    },
  },
});

// Seeker
AddSubClass("rogue(laserllama)", "seeker", {
  regExpSearch: /seeker/i,
  subname: "Seeker",
  fullname: "Seeker",
  source: [["GMB:LL", 0]],
  abilitySaveAlt: 4,
  features: {
    subclassfeature3: {
      name: "Relic Hunter",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I learn two languages and gain proficiency in History. If I spend at least 10 minutes touching and examining an object, I can ascertain its civilization of origin and its approximate age.",
      ]),
      skills: ["History"],
      languageProfs: [2],
    },
    "subclassfeature3.2": {
      name: "Relic Magic",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I gain an amount of relics (Tiny objects) who contain a cantrip or ritual of 2nd level or lower",
        "While I have a Relic on me, I can cast the cantrip or the ritual version of the spell within",
        "Those spells cannot be changed and I cast those spell with my Intelligence stat",
        "Whenever I gain a new Relic, I can replace one of my Relic spells with another spell of my choice",
        "Spell attacks of my Relic spells are qualified for my Sneak Attack even if they are not ranged or finesse weapons. I must meet all other Sneak Attack requirements",
      ]),
      additional: levels.map((n) => {
        var totRelics = 3 + (n < 7 ? 0 : n < 13 ? 2 : n < 17 ? 4 : 6);
        return totRelics + " Relics";
      }),
      eval: function () {
        var rSpells = CreateSpellList({
          class: "any",
          level: [1, 2],
          ritual: true,
        }); // an array of ritual spells 1-2 lvl
        var oCantrips = CreateSpellList({ class: "any", level: [0, 0] }); // an array of cantrips
        var cSpellsCantrips = rSpells.concat(oCantrips); // combines both arrays

        // name of your feature
        CurrentSpells["relic magic"] = {
          name: "Relic Magic",
          ability: 4,
          list: { spells: cSpellsCantrips },
          typeList: 4,
          refType: "class",
          allowUpCasting: false,
          firstCol: "", // allows to have a spell "prepared"
          bonus: {},
        };
        SetStringifieds("spells");
        CurrentUpdates.types.push("spells");
      },
      removeeval: function () {
        // Delete and remove the CurrentSpells object
        delete CurrentSpells["relic magic"];
        SetStringifieds("spells");
        CurrentUpdates.types.push("spells");
      },
    },
    subclassfeature7: (function () {
      // Fixed attributes
      ElderRelics = {
        name: "Elder Relics",
        source: [["GMB:LL", 0]],
        minlevel: 7,
        description: desc([
          "I gain two Elder Relics, who have stronger effects than a regular Relic",
        ]),
        extraname: "Elder Relics",
        extraTimes: levels.map(function (n) {
          if (n < 7) return 0;
          return 2;
        }),
        // NOTE: this levels.map function is just so the user sees how many Elder Relics they can pick
        // If extraTimes = 1, then it never shows the "selected x of y"
        // This is relevant because of the lvl 13 subclass feature
        extrachoices: [],
      };

      // Add channel divinities
      ClericSubclasses = ClassList.cleric.subclasses[1];

      for (var i = 0; i < ClericSubclasses.length; i++) {
        subclass = ClericSubclasses[i];
        NewChanDiv = ClassSubList[subclass].features["subclassfeature2"];

        if (ElderRelics[NewChanDiv.name.toLowerCase()]) {
          continue; // ChanDiv is already added, adding duplicates causes bugs
        }

        ElderRelics.extrachoices.push(NewChanDiv.name);
        ElderRelics[NewChanDiv.name.toLowerCase()] = {
          // notice the lowercase
          name: NewChanDiv.name,
          source: NewChanDiv.source,
          description: NewChanDiv.description.replace(
            "cleric level",
            "rogue level"
          ),
          action: NewChanDiv.action,
          additional: NewChanDiv.additional,
          usages: 1,
          recovery: "short rest",
          submenu: "Channel Divinity",
        };
      }

      // Add Eldritch Invocations
      ElderRelics.extrachoices.push("Eldritch Invocation");
      ElderRelics["eldritch invocation"] = {
        name: "Eldritch Invocation",
        source: [["GMB:LL", 0]],
        description: desc(
          "I learn one Eldritch Invocation of my choice, using my rogue level for prerequesites (TODO)"
        ),
        bonusClassExtrachoices: function () {
          if (ClassList["warlock(laserllama)"]) {
            return [
              {
                class: "warlock(laserllama)",
                feature: "eldritch invocations",
                bonus: 1,
              },
            ];
          }
          return [
            {
              class: "warlock",
              feature: "eldritch invocations",
              bonus: 1,
            },
          ];
        },
      };

      // Add 2 < x <= 5th level rituals
      var GreaterRituals = CreateSpellList({
        class: "any",
        level: [3, 5],
        ritual: true,
      }); // an array of ritual spells 3-5 lvl
      for (var i = 0; i < GreaterRituals.length; i++) {
        NewSpell = SpellsList[GreaterRituals[i]];

        ElderRelics.extrachoices.push(NewSpell.name);
        ElderRelics[NewSpell.name.toLowerCase()] = {
          // notice the lowercase
          name: NewSpell.name,
          source: NewSpell.source,
          description: desc(
            "I learn the " +
            NewSpell.name +
            " spell but can only cast it as ritual with the Elder Relic"
          ),
          spellcastingBonusElsewhere: {
            addTo: "relic magic",
            spellcastingBonus: {
              name: "Elder Relic",
              spellcastingAbility: 4,
              spells: [GreaterRituals[i]],
              selection: [GreaterRituals[i]],
              prepared: true,
            },
          },
          submenu: "Greater Ritual",
        };
      }

      return ElderRelics;
    })(),
    // "subclassfeature7.1": {
    //   name: "Expert Archaeologist",
    //   source: [["GMB:LL", 0]],
    //   minlevel: 7,
    //   description: desc([
    //     "I have adv. on any saving throw on traps; I can use modify device at will, if I have the tools",
    //     "I have adv. on thieves' tools or tinker's tools checks I make to investigate or disarm a trap",
    //   ]),
    //   savetxt: { adv_vs: ["traps"] },
    //   calcChanges: {
    //     spellAdd: [
    //       function (spellKey, spellObj, spName) {
    //         if (spellKey == "modify device") {
    //           spellObj.firstCol = "atwill";
    //           return true;
    //         }
    //       },
    //       "I can use the Modify Device exploit at will without expending an Exploit Die",
    //     ],
    //   },
    // },
    subclassfeature13: {
      name: "Greater Lore",
      source: [["GMB:LL", 0]],
      minlevel: 13,
      description: desc([
        "I gain two more Elder Relics",
        "I add my Intelligence modifier to any damaging cantrip I cast with a Relic",
        "During a long rest I can perform a 1-hour ritual to replace one Relic spell to another one",
      ]),
      calcChanges: {
        atkCalc: [
          function (fields, v, output) {
            if (v.isSpell && /\brelic\b/i.test(v.WeaponTextName))
              output.modToDmg = true;
          },
          "I add my Intelligence modifier to any damaging cantrip I cast with a Relic",
        ],
      },
      bonusClassExtrachoices: [
        {
          class: "rogue(laserllama)",
          subclass: "rogue(laserllama)-seeker",
          feature: "subclassfeature7",
          bonus: 2,
        },
      ],
    },
    subclassfeature17: {
      name: "Ancient Lore",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc([
        "I have adv. on saving throws I make to resist the effects of spells",
        "I can change one of my Relic and Elder Relic by performing a 1h ritual (can be part of a rest)",
      ]),
      savetxt: { adv_vs: ["spells"] },
      bonusClassExtrachoices: [
        {
          class: "rogue(laserllama)",
          subclass: "rogue(laserllama)-seeker",
          feature: "subclassfeature7",
          bonus: 1,
        },
      ],
    },
  },
});

// Skinchanger
AddSubClass("rogue(laserllama)", "skinchanger", {
  regExpSearch: /skinchanger/i,
  subname: "Skinchanger",
  fullname: "Skinchanger",
  source: [["GMB:LL", 0]],
  abilitySaveAlt: 4,
  features: {
    subclassfeature3: {
      name: "Druidic Secrets",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I know Druidic and I count as a Druid for the purpose of attuning to magic items and using spell scrolls",
      ]),
    },
    "subclassfeature3.1": {
      name: "Limited Wild Shape",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: "I can wild shape with some limitations (see third page)",
      // Putting Beast Transformation on the third page because it's a wall of text; the subclass is already overflowing
      "limited.wild shape": {
        name: "Limited Wild Shape",
        source: [["GMB:LL", 0]],
        minlevel: 3,
        description: function () {
          var totWildShape = levels.map((n) => {
            return n < 7 ? 3 : n < 13 ? 4 : n < 17 ? 5 : 6;
          });
          var crWildShape = levels.map((n) => {
            return n < 7 ? "1/4" : n < 13 ? "1/2" : n < 17 ? 1 : 2;
          });
          var duration = levels.map((n) => {
            n < 17 ? "for 1 hour" : "indefinitely";
          });
          return desc([
            "As a bonus action I can wild shape using these rules:",
            " \u2022 I know " +
            totWildShape +
            " wild shapes of Beast of CR " +
            crWildShape +
            " or lower that I have seen before ",
            " \u2022 I can Wild Shape Wis mod times (min of 1) and I regain one use each short rest and all uses each long rest",
            " \u2022 When I Wild Shape, my stats are replaced by its game statistics except HP, alignment, personalilty and Intelligence, Wisdom, and Charisma scores",
            " \u2022 I can remain in my Wild Shape " +
            duration +
            ". I can revert to my normal form early as a bonus action, but I revert instantly when I'm Incapacitated.",
            " \u2022 When I Shift, I choose if my equipment merges with my Wild Shape or if it falls to the ground. I can only merge with equipment that I can wear or carry.",
            " \u2022 my Wild Shape retains the benefits and features from my class, race, and other sources, including Exploits, and can still use them as long as the Beast would be physically capable of doing so. However, I don't retain any special Senses, like Darkvision, unless my Beast Form also has that Sense.",
            " \u2022 In Wild Shape I can apply my Sneak Attack to my natural weapon attacks, however, I must meet all other normal conditions for Sneak Attack. This will not apply if my Wild Shape size is Diminutive",
            " \u2022 I can replace a Wild Shape by touching a living, non-hostile CR 1/4 beast and expending an Expl Die",
            " \u2022 I cannot cast spells while I am in a Beast Form. However, I can maintain my concentrationon spells and other abilities I used before I Shifted.",
          ]);
        },
        action: [["bonus action", " (start/end)"]],
        additional: levels.map(function (n) {
          if (n < 3) return "";
          var totWildShape = levels.map((n) => {
            return n < 7 ? 3 : n < 13 ? 4 : n < 17 ? 5 : 6;
          });
          var cr = levels.map((n) => {
            return n < 7 ? "1/4" : n < 13 ? "1/2" : n < 17 ? 1 : 2;
          });
          var restr = "";
          return (
            totWildShape + " Shapes known; CR " + cr + restr + " or lower;"
          );
        }),
        usages: "Wis mod per ",
        usagescalc: "event.value = Math.max(1, What('Wis Mod'));",
        recovery: "long rest",
      },
      autoSelectExtrachoices: [{ extrachoice: "limited.wild shape" }],
    },
    subclassfeature7: {
      name: "Instinctual Strikes",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "My Limited Wild Shape is improved (see Limited Wild Shape)",
        " The natural weapon attacks of my Wild Shape count as magical for the purpose of overcoming resistance and immunity to nonmagical attacks and damage.",
      ]),
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (
              v.theWea.bestialNaturalWeapon &&
              !v.thisWeapon[1] &&
              !v.theWea.isMagicWeapon &&
              !/counts as( a)? magical/i.test(fields.Description)
            ) {
              fields.Description +=
                (fields.Description ? "; " : "") + "Counts as magical";
            }
          },
          "The natural weapon attacks of my Wild Shape count as magical for the purpose of overcoming resistance and immunity to nonmagical attacks and damage.",
        ],
      },
    },
    subclassfeature13: {
      name: "Bestial Physique",
      source: [["GMB:LL", 0]],
      minlevel: 13,
      description: desc([
        "I add my Expl Die to any ability check I made based on my sense of sight, hearing or smell",
        "My unarmed stikes gain the finesse property and deals my Expl Die slashing damage",
      ]),
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            var explDie = levels.map((n) => {
              return n < 5 ? 4 : n < 11 ? 6 : n < 17 ? 8 : 10;
            });
            if (v.baseWeaponName == "unarmed strike") {
              fields.Damage_Die = "1d" + explDie;
              fields.Damage_Type = "Slashing";
              fields.Description +=
                (fields.Description ? "; " : "") + "Finesse ";
            }
          },
          "My unarmed strikes gain the Finesse property and deal slashing damage.",
          1,
        ],
      },
    },
    subclassfeature17: {
      name: "Druidic Mastery",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc([
        "I can remain in my Wild Shape indefinitely",
        " Also, when I have no uses of my Wild Shape remaining, I can expend a Expl Die to Wild Shape again",
      ]),
    },
  },
});

// Surgeon
AddSubClass("rogue(laserllama)", "surgeon", {
  regExpSearch: /surgeon/i,
  subname: "Surgeon",
  fullname: "Surgeon",
  source: [["GMB:LL", 0]],
  abilitySaveAlt: 4,
  features: {
    subclassfeature3: GetRogueSubclassExploits("Surgeon", [
      "arresting strike",
      "first aid",
      "crippling strike",
      "exposing strike",
      "bewildering blow",
    ]),
    "subclassfeature3.1": {
      name: "Anatomical Studies",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I gain proficiency in Medicine and Nature and I can make Int(Medicine) checks",
        " During a long rest, I can spend 1 hour to restoking Healer's Kits and they regain my Rogue level uses",
        " When I use First Aid Exploit, I can expend a use of Healer's Kit to grant advan. on its Hit Die rolls",
      ]),
      skillstxt: "Nature and Medicine",
      spellChanges: {
        "first aid": {
          description:
            "Touch a willing creature, expend any Exploit Die up to Prof Bonus to heal it (see book)",
          changes:
            "I can expend a use of Healer's Kit to grant advantage on its Hit Die rolls. I can also use this Exploit with a bonus action",
        },
      },
    },
    "subclassfeature3.2": {
      name: "Surgical Skill",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I score a critical hit on a roll of 19-20 on the d20 when I hit a Beast, Giant, Humanoid, Monstrosity or Undead with a weapon",
        " Also, I can use the First Aid Exploit or make a Medicine check with a bonus action",
      ]),
    },
    subclassfeature7: {
      name: "Cultivated Immunity",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: desc([
        "I gain resistance against Poison and Necrotic damage",
        "I have advan. on saves to resist poison and disease",
      ]),
      dmgres: ["Poison", "Necrotic"],
      savetxt: { adv_vs: ["Poison", "Disease"] },
    },
    "subclassfeature7.1": {
      name: "Surgical Strike",
      source: [["GMB:LL", 0]],
      minlevel: 7,
      description: levels.map((n) => {
        if (n < 13) {
          return desc([
            "When I use my Surgeon Exploits with my Cunning Strike against a Beast, Giant, Humanoid, Monstrosity or Undead, its cost is reduced by 1d6 (min 0d6)",
            " I can expend two uses of a Healer's Kit to cure one creature I touch from one disease or poisoned condition",
          ]);
        }
        return desc([
          "When I use my Surgeon Exploits with my Cunning Strike against a Constructs, Oozes, Plants, Beast, Giant, Humanoid, Monstrosity or Undead, its cost is reduced by 1d6 (min 0d6)",
          " I can expend two uses of a Healer's Kit to cure one creature I touch from one disease or poisoned condition",
        ]);
      }),
    },
    subclassfeature13: {
      name: "Fantastical Anatomy",
      source: [["GMB:LL", 0]],
      minlevel: 13,
      description: desc([
        "I score a critical hit on a roll of 18-19-20 on the d20 when I hit a creature with a weapon that is not a Construct, Ooze or Plant",
        " Also, my Surgical Strike is improved (see Surgical Strike)",
      ]),
    },
    subclassfeature17: {
      name: "Expert Surgeon",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      additional: "1 x LR for each ability",
      description: desc([
        "I gain the following abilities:",
        " \u2022 \x1bDeadly Contagion.\x1b On hit of melee weapon attack, I can force the target creature on a Con save or suffer an effect of my choice from the Contagion Spell",
        " \u2022 \x1bMedicinal Miracle.\x1b As an action, I can revive a dead creature within the past minute whom not died of old age (this effect doesn't restore missing parts)",
        " \u2022 \x1bSurgical Stimulation.\x1b Over the course of 1 minute, I can perform a surgical procedure on a crature which imparts the benefits of the regenerate spell on it",
      ]),
      action: [["action", "Medicinal Miracle"]],
      extraLimitedFeatures: [
        {
          name: "Deadly Contagion",
          usages: 1,
          recovery: "long rest",
        },
        {
          name: "Medicinal Miracle",
          usages: 1,
          recovery: "long rest",
        },
        {
          name: "Surgical Stimulation",
          usages: 1,
          recovery: "long rest",
        },
      ],
      spellChanges: {
        contagion: {
          description:
            "Melee spell attack for poisoned; save each rnd, 3 success: spell ends, 3 fail: poison ends, disease; see Book",
          changes:
            "On hit of melee weapon attack, I can force the target creature on a Con save or suffer an effect of my choice from this spell",
        },
        regenerate: {
          description:
            "1 crea heals 4d8+15 HP now and 1 HP/rnd for rest of duration; restores lost body parts in 2 min",
          changes:
            "I can replicate the effects of this spell on a creature which was the patient of my Surgical Stimulation",
        },
      },
      spellcastingBonus: [
        {
          name: "Expert Surgeon",
          spells: ["contagion", "regenerate"],
          selection: ["contagion", "regenerate"],
        },
      ],
    },
  },
});

// Way of the Astral Warrior (astral self)
AddSubClass("monk(laserllama)", "way of the astral warrior", {
  regExpSearch: /astral warrior/i,
  subname: "Way of the Astral Warrior",
  fullname: "Astral Warrior",
  source: [["GMB:LL", 0]],
  features: {
    "subclassfeature3": GetSubclassTechniques("Astral", ["deflect strike", "deflect missile", "aura sight"]),
    "subclassfeature3.1": {
      name: "Astral Armor",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map(function (n) {
        return "[ " + (n < 19 ? 1 : 2) + ' ki; see 3rd page "Notes"]' + desc([
          "As a bonus action, I can use my ki to summon my astral armor for 10 minutes"
        ]);
      }),
      action: [["bonus action", " (summon/dismiss)"]],
      weaponsAdd: ["Astral Armor"],
      weaponOptions: {
        baseWeapon: "unarmed strike",
        regExpSearch: /^(?=.*\bastral\b)(?=.*\barmor?\b).*$/i,
        name: "Astral Armor",
        source: [["GMB:LL", 0]],
        ability: 5,
        range: "Melee (+5 ft)",
        damage: [1, "", "Force"],
        description: "+5 ft reach; Uses Str, Dex, or Wis",
        isAstralArmor: true
      },
      "astral armor": {
        name: "Astral Armor",
        extraname: "Way of the Astral Warrior 3",
        source: [["GMB:LL", 0]],
        description: levels.map(function (n) {
          if (n < 6) {
            return desc([
              "As a bonus action, I can summon my astral armor as a luminescent set of armor",
              "When I summon it, all creatures of my choice I can see in 10 ft must make a Dex save",
              "If failed, they take twice my martial arts die in force damage",
              "I can use use Wisdom instead of Strength for Strength checks, saves and unarmed strikes",
              "I have +5 ft reach on attacks made with my astral self and they deal force damage",
              "This lasts for 10 minutes or until I'm incapacitated, die, or dismiss it"])
          } else if (n < 10) {
            return desc([
              "As a bonus action, I can summon my astral armor as a luminescent set of armor",
              "When I summon it, all creatures of my choice I can see in 10 ft must make a Dex save",
              "If failed, they take twice my martial arts die in force damage",
              "I can use use Wisdom instead of Strength for Strength checks, saves and unarmed strikes",
              "I have +5 ft reach on attacks made with my astral self and they deal force damage",
              "I can see normally in both magical and mundane darkness in a 120-foot radius",
              "This lasts for 10 minutes or until I'm incapacitated, die, or dismiss it"])
          } else if (n < 17) {
            return desc([
              "As a bonus action, I can summon my astral armor as a luminescent set of armor",
              "When I summon it, all creatures of my choice I can see in 10 ft must make a Dex save",
              "If failed, they take twice my martial arts die in force damage",
              "I can use use Wisdom instead of Strength for Strength checks, saves and unarmed strikes",
              "I have +5 ft reach on attacks made with my astral self and they deal force damage",
              "I can see normally in both magical and mundane darkness in a 120-foot radius",
              "I can use Deflect Strike and Deflect Missile without spending Ki points",
              "This lasts for 10 minutes or until I'm incapacitated, die, or dismiss it"])
          }
          return desc([
            "As a bonus action, I can summon my astral armor as a luminescent set of armor",
            "When I summon it, all creatures of my choice I can see in 10 ft must make a Dex save",
            "If failed, they take twice my martial arts die in force damage",
            "I can use use Wisdom instead of Strength for Strength checks, saves and unarmed strikes",
            "I have +5 ft reach on attacks made with my astral self and they deal force damage",
            "I can see normally in both magical and mundane darkness in a 120-foot radius",
            "I can use Deflect Strike and Deflect Missile without spending Ki points",
            "I can reduce any damage I take by my Wis mod",
            "I can use an action to unleash a barrage of punches in an adjacent 20-foot cone, forcing creatures in that area to make a Dexterity saving throw against my Technique save DC. On a failure, creatures take force damage equal to four Martial Arts Dice,and half as much force damage on a success.",
            "This lasts for 10 minutes or until I'm incapacitated, die, or dismiss it"])

        }),
        additional: levels.map(function (n) {
          return n < 3 ? "" : (n < 19 ? 1 : 2) + " ki point; 2d" + (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12) + " force damage on summon";
        })
      },
      autoSelectExtrachoices: [{ extrachoice: "astral armor" }]
    },
    "subclassfeature6": {
      name: "Astral Visage",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: levels.map(function (n) {
        return desc(["I learn the thaumaturgy cantrip and Wisdom is my spellcasting modifier for it",
          "Whenever I make a Wis (Insight) or Cha (Intimidation) check, I add 1d" + (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12) + " to my roll",
          "My Astral Self is improved (see it)"
        ])
      }),
      spellcastingBonus: [{
        name: "Astral Visage",
        spells: ["thaumaturgy"],
        selection: ["thaumaturgy"],
        firstCol: "atwill"
      }],
      vision: [["Astral Armor sight (when summoned)", 120]]
    },
    "subclassfeature10": {
      name: "Mystical Defense",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: levels.map(function (n) {
        return desc(["I gain the 11th level benefit of Deflect Stike and Deflect Missile Techinques 1 level early ",
          "After I use one of these Techniques, my next unarmed strike deals 1d" + (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12) + " damage on hit",
          "My Astral Self is improved (see it)"
        ])
      }),
    },
    "subclassfeature17": {
      name: "Master Astral Warrior",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc(["My Astral Self is improved (see it)",
        "While summoned, I can unleash a barrage of punches in an adjacent 20 ft cone as an action",
        "Targets in that area must make a Dex save or take 4d12 force dmg (half on save)"]),
      action: ["action", "Barrage of punches"],
      weaponsAdd: ["Barrage of punches"],
      weaponOptions: {
        regExpSearch: /^(?=.*barrage)(?=.*punches).*$/i,
        name: "Barrage of punches",
        source: [["GMB:LL", 0]],
        ability: 5,
        type: "Natural",
        damage: [4, 12, "Force"],
        range: "20-ft cone",
        description: "Hits all in area; Dex save for half damage",
        abilitytodamage: false,
        dc: true,
        useSpellMod: "monk(laserllama)"
      },
    }
  }
});

// Way of the Drunken Fist (drunken master)
AddSubClass("monk(laserllama)", "way of the drunken fist", {
  regExpSearch: /drunken fist/i,
  subname: "Way of the Drunken Fist",
  fullname: "Drunken Fist",
  source: [["GMB:LL", 0]],
  features: {
    "subclassfeature3": GetSubclassTechniques("Drunken", ["step of the wind", "deflect missile", "heavenly step"]),
    "subclassfeature3.1": {
      name: "Dancing Fool",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc(["I gain proficiency in Performance, and either brewer's supplies or a musical instruments",
        "Also, I add my Martial Arts Die to checks done with these proficiencies"]),
      skills: ["Performance"],
      extraname: "Dancing Fool Proficiency",
      choices: ["Brewer's supplies", "Musical Instrument"],
      "brewer's supplies": {
        toolProfs: ["Brewer's supplies"],
      },
      "musical instrument": {
        toolProfs: ["Musical Instrument"],
      }
    },
    "subclassfeature3.2": {
      name: "Drunken Style",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc(["Whenever I hit a creature during my turn with a Martial Arts attack, my speed increases by 5 ft",
        "Creas I hit this way cannot target me with opportunity attacks until the start of my next turn"])
    },
    "subclassfeature6": {
      name: "Unpredictable Sway",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "Standing up from prone doesn't cost me any movement",
      ]),
      "unpredictable sway (tipsy strike)": {
        name: "Tipsy Strike",
        extraname: "Way of the Drunken Fist 6",
        source: ["GMB:LL"],
        description: desc("When a creature misses me with a melee attack, I can use my reaction and cause that same attack to target another target in range"),
        additional: "1 ki point",
        action: ["reaction", " (after missed in melee)"],
      },
      "chaotic luck": {
        name: "Chaotic luck",
        extraname: "Way of the Drunken Fist 10",
        source: ["GMB:LL"],
        description: desc("I can cancel the disadvantage on one d20 roll (attack, check or save)"),
        additional: "1 ki point"
      },
      autoSelectExtrachoices: [{
        extrachoice: "unpredictable sway (tipsy strike)"
      }, {
        extrachoice: "chaotic luck",
        minlevel: 10
      }]
    },
    "subclassfeature17": {
      name: "Master of the Drunken Fist",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc(["When I take the Attack action, I can make a single Martial Arts attack against each creature I move past that is within range of my unarmed strikes, beyond my normal amount of attacks"])
    }
  }
});

// Way of Harmony (mercy)
AddSubClass("monk(laserllama)", "way of harmony", {
  regExpSearch: /^(?=.*harmony).*$/i,
  subname: "Way of Harmony",
  fullname: "Harmony",
  source: [["GMB:LL", 0]],
  features: {
    "subclassfeature3": GetSubclassTechniques("Yin and Yang", ["mystic regeneration", "gentling touch", "mantle of courtesy"]),
    "subclassfeature3.1": {
      name: "Monastic Healer",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map(function (n) {
        var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);

        return desc("I gain proficiency with Insight, Medicine, and herbalism kit; I add 1d" + MartArtDie + " to those checks")
      }),
      skills: ["Insight", "Medicine"],
      toolProfs: ["Herbalism kit"],

      "touch of life": {
        name: "Touch of Life",
        extraname: "Way of Ying and Yang 3",
        source: [["GMB:LL", 0]],
        description: levels.map(function (n) {
          var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);

          if (n < 6) {
            return desc("Instead of an unarmed strike, I can heal another creature for 1d" + MartArtDie + " + my Wis mod")
          }

          if (n < 10) {
            return desc(["Instead of an unarmed strike, I can heal another creature for 1d" + MartArtDie + " + my Wis mod",
              "I can also end one of the following: blinded, deafened, paralyzed, poisoned, or stunned"]);
          }

          return desc(["Instead of an unarmed strike, I can heal another creature for 1d" + MartArtDie + " + my Wis mod",
            "I can also end one of the following: blinded, deafened, paralyzed, poisoned, or stunned",
            "I can heal extra HP by spending up to my Wis mod additional Ki points to add one Die per Ki Point spent"])
        }),
        additional: "1 ki point"
      },
      "touch of death": {
        name: "Touch of Death",
        extraname: "Way of Ying and Yang 3",
        source: [["GMB:LL", 0]],
        description: levels.map(function (n) {
          var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);

          if (n < 6) {
            return desc("When hitting a creature with an unarmed strike, deal 1d" + MartArtDie + " additional necrotic damage. The damage is radiant to Undead");
          }
          if (n < 10) {
            return desc(["When hitting a creature with an unarmed strike, deal 1d" + MartArtDie + " additional necrotic damage. The damage is radiant to Undead",
              "I can also choose to poison the target until the beginning of my next turn"]);
          }
          return desc(["When hitting a creature with an unarmed strike, deal 1d" + MartArtDie + " additional necrotic damage. The damage is radiant to Undead",
            "I can also choose to poison the target until the beginning of my next turn",
            "I can deal extra damage by spending up to my Wis mod additional Ki points to add one Die per Ki Point spent"]);
        }),
        additional: "1 ki point"
      },
      autoSelectExtrachoices: [{
        extrachoice: "touch of life",
        minlevel: 3
      }, {
        extrachoice: "touch of death",
        minlevel: 3
      }]
    },
    "subclassfeature6": {
      name: "Mystic Manipulation",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: "\n  My Touch of Life and Touch of Death are improved (see them)"
    },
    "subclassfeature10": {
      name: "Harmonious Touch",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: "\n  My Touch of Life and Touch of Death are improved (see them)"
    },
    "subclassfeature17": {
      name: "Master of Harmony",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc(["As an action, I can spend 6 Ki Points and touch a creature that has died within 24h",
        "I instantly restore it to life with a number of HP equal to my Monk level + my Wis mod",
        "Any conditions afflicting the creature at the time of its death are also ended",
        "Once used, a creature must finish a long rest before it can benefit from this feature again"]),
      action: ["action", ""]
    }
  }
});

// Subclassess Alternate Monk
// Way of the Open Hand
AddSubClass("monk(laserllama)", "way of the open hand", {
  regExpSearch: /open hand/i,
  subname: "Way of the Open Hand",
  fullname: "Open Hand",
  source: [["GMB:LL", 0]],
  features: {
    // Override Ki because of the lvl 17 subclass feature
    "mystic techniques": function () {
      var kifeature = newObj(ClassList["monk(laserllama)"].features["mystic techniques"]);

      kifeature["flurry of blows"].description = levels.map(function (n) {
        if (n < 17) return desc("After taking the Attack action, I can make 2 unarmed attacks as a bonus action");
        return desc("After taking the Attack action, I can make 3 unarmed attacks as a bonus action")
      });

      return kifeature;
    }(),

    "subclassfeature3": function () {
      // Fixed attributes
      OpenHandTechniques = {
        name: "Open Hand Techniques",
        source: [["GMB:LL", 0]],
        minlevel: 3,
        description: desc(["I learn additional Techniques who don't count against my total",
          'When I level up, I can change a strike technique from this feature for another strike technique using the "Choose Feature" button',
        ]),
        extraname: "Strike Techniques",
        extrachoices: [],
        extraTimes: levels.map(function (n) {
          if (n < 3) return 0;
          if (n < 5) return 1;
          if (n < 9) return 2;
          return 3;
        }),
        autoSelectExtrachoices: [{
          extrachoice: "empowered strike",
          minlevel: 3
        }, {
          extrachoice: "stunning strike",
          minlevel: 5
        }, {
          extrachoice: "indomitable spirit",
          minlevel: 9
        }]
      }

      // Getting Open Hand techniques
      var mysticTechs = ClassList["monk(laserllama)"].features["mystic techniques"];

      for (var techName in mysticTechs) {
        // Skip the main feature object and non-technique properties
        if (techName === "name" || techName === "source" || techName === "minlevel" ||
          techName === "description" || techName === "extraname" || techName === "extraTimes" ||
          techName === "extrachoices" || techName === "limfeaname" || techName === "usages" ||
          techName === "usagescalc" || techName === "recovery" || techName === "autoSelectExtrachoices") {
          continue;
        }
        // Check if this technique has isOpenHand: true
        if (mysticTechs[techName] && mysticTechs[techName].isOpenHand === true) {
          OpenHandTechniques.extrachoices.push(techName);
        }
      }

      for (var i = 0; i < OpenHandTechniques.extrachoices.length; i++) {
        OpenHandTechniques[OpenHandTechniques.extrachoices[i]] = newObj(ClassList["monk(laserllama)"].features["mystic techniques"][OpenHandTechniques.extrachoices[i]]);
      }
      return OpenHandTechniques;
    }(),
    "subclassfeature3.1": {
      name: "Practiced Strikes",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc(["Once per turn when I hit with an unarmed strike, I can use a Strike Technique I know without spending a Ki Point"]),
      usages: "Wis mod per ",
      usagescalc: "event.value = Math.max(1, What('Wis Mod'));",
      recovery: "long rest",
    },
    "subclassfeature6": {
      name: "Ebb and Flow",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: levels.map(function (n) {
        if (n < 17) return desc(["When a creature I can see misses me with a melee attack, I can use one of the following:",
          "\u2022 The crea has to make a Dex save (adv if larger) or be knocked prone and have a speed of 0",
          "\u2022 I can make one unarmed strike against the creature"])

        return desc(["When a creature I can see misses me with a melee attack, I can use one of the following:",
          "\u2022 The crea has to make a Dex save (adv if larger) or be knocked prone and have a speed of 0",
          "\u2022 I can make two unarmed strikes against the creature"])
      }),
      action: ["reaction", " (after missed in melee)"]
    },
    "subclassfeature10": {
      name: "Open Hand Strike",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc(["When I crit with an unarmed strike, the creature has disadvantage on any save that I force it to make as part of that attack"]),
    },
    "subclassfeature10": {
      name: "Master of Many Forms",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc(["During a long rest I can spend 10 min practicing to switch one of my Monk Techniques"]),
    },
    "subclassfeature17": {
      name: "Master of the Open Hand",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc(["When I make an opportunity attack, I can make two unarmed strikes instead"])
    }
  }
});

// Way of Radiance (sun soul)
AddSubClass("monk(laserllama)", "way of radiance", {
  regExpSearch: /radiance/i,
  subname: "Way of Radiance",
  fullname: "Radiance",
  source: [["GMB:LL", 0]],
  features: {
    "subclassfeature3": GetSubclassTechniques("Radiant", ["step of the wind", "deflect missile", "indomitable spirit"]),
    "subclassfeature3.1": {
      name: "Radiant Bolt",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc(["I can replace any unarmed strike by a Radiant Bolt, which is a ranged martial arts attack and they count as melee Martial Arts attacks for my Techniques",
        "I learn the light cantrip and use Wisdom as my spellcasting ability"]),
      weaponsAdd: ["Radiant Bolt"],
      weaponOptions: {
        regExpSearch: /^(?=.*radiant)(?=.*bolt).*$/i,
        name: "Radiant Bolt",
        source: [["GMB:LL", 0]],
        ability: 2,
        type: "Natural",
        damage: [1, 6, "radiant"],
        range: "30/60 ft",
        description: "Can be used instead of any unarmed strike",
        monkweapon: true,
        abilitytodamage: true,
        isRadiantBolt: true
      },
      spellcastingBonus: {
        name: "Radiant Bolt",
        spells: ["light"],
        selection: ["light"]
      },
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (v.theWea.isRadiantBolt && classes.known["monk(laserllama)"] && classes.known["monk(laserllama)"].level) {
              var aMonkDie = function (n) { return (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12) }(classes.known["monk(laserllama)"].level);
              fields.Damage_Die = "1d" + aMonkDie;
            }
          },
          "My Radiant Bolt count as melee Martial Arts attacks for the purposes of my Techniques",
          1
        ]
      },
      "searing blast": {
        name: "Searing Blast",
        extraname: "Way of Radiance 6",
        source: [["GMB:LL", 0]],
        description: levels.map(function (n) {
          var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);
          return desc(["As a bonus action, I can force all creatures within an adjacent 15 ft cone to make a Dex save or take 3d" + MartArtDie + " radiant damage (half on save)"])
        }),
        additional: "1 ki point",
        action: ["bonus action", ""],
        weaponsAdd: ["Searing Blast"],
        weaponOptions: {
          regExpSearch: /^(?=.*searing)(?=.*blast).*$/i,
          name: "Searing Blast",
          source: [["GMB:LL", 0]],
          ability: 5,
          type: "Natural",
          damage: [3, 8, "Radiant"],
          range: "15-ft cone",
          description: "Hits all in area; Dex save for half damage",
          abilitytodamage: false,
          dc: true,
          useSpellMod: "monk(laserllama)",
          isSearingBlast: true
        },
        calcChanges: {
          atkAdd: [
            function (fields, v) {
              if (v.theWea.isSearingBlast && classes.known["monk(laserllama)"] && classes.known["monk(laserllama)"].level) {
                var aMonkDie = function (n) { return (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12) }(classes.known["monk(laserllama)"].level);
                fields.Damage_Die = "3d" + aMonkDie;
              }
            },
            "My Searing Blast feature uses my Martial Arts die to calculate the damage dealt",
            1
          ]
        }
      },
      autoSelectExtrachoices: [{
        extrachoice: "searing blast",
        minlevel: 6
      }]
    },
    "subclassfeature6": {
      name: "Luminous Spirit",
      source: [["GMB:LL", 0]],
      minleve: 6,
      description: desc([
        "When I deal radiant damage to a creature, I can expend 1 Ki and force it to make a Con save against my Techniques DC or be Blinded until the start of my next turn"
      ]),
    },
    "subclassfeature10": {
      name: "Luminous Burst",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: levels.map(function (n) {
        var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);
        return desc(["As an action, I can unleash a blast in a 5 ft wide, 100 ft long line",
          "All creatures in range must make a Dex save or take 6d" + MartArtDie + " radiant damage (half on save)",
          "I can empower it by spending ki, up to my Wis mod: each ki spent adds 1d" + MartArtDie + " to the damage",
          "If I have no uses left, I can spend 3 ki to use it again"])
      }),
      usages: "Wisdom modifier per ",
      usagescalc: "event.value = Math.max(1, What('Wis Mod'));",
      recovery: "long rest",
      action: ["action", ""]
    },
    "subclassfeature17": {
      name: "Master of Radiance",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc(["I gain a flying speed equal to my movement speed as long I use my Unarmored Movement",
        "I shed bright sunlight in a 30 ft radius and dim sunlight 30 ft beyond that (can enable/disable as bonus action)",
        "My Radiant Bolt, Searing Blast, and Luminous Burst features all count as true sunlight",
        "I gain resistance to necrotic damage, immunity to all radiant damage and being blinded"]),
      dmgres: ["Necrotic"],
      savetxt: {
        immune: ["Radiant damage", "blinded"]
      },
      speed: { fly: { spd: "walk", enc: "walk" } },
      action: ["bonus action", "Shed sunlight (enable/disable)"],
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if ((v.theWea.isSearingBlast || ((/radiant bolt/i).test(v.WeaponName + v.baseWeaponName) || (/radiant bolt/i).test(v.theWea.type)))) {
              fields.Description += (fields.Description ? '; ' : '') + "Counts as true sunlight"
            }
          },
          "My Radiant Bolt, Searing Blast, and Luminous Burst features all count as true sunlight",
          1
        ]
      }
    }
  }
});

// Way of the Reaper (long death)
AddSubClass("monk(laserllama)", "way of the reaper", {
  regExpSearch: /reaper/i,
  subname: "Way of the Reaper",
  fullname: "Reaper",
  source: [["GMB:LL", 0]],
  features: {

    "subclassfeature3": GetSubclassTechniques("Reaper", ["crippling strike", "slowing strike", "aura sight"]),
    "subclassfeature3.1": {
      name: "Frightful Touch",
      minlevel: 3,
      source: [["GMB:LL", 0]],
      description: desc("When I hit a creature with a Martial Arts attack, I can force it to make a Wisdom save or be frightened of me until the start of my next turn"),
      additional: "1 ki point"
    },
    "subclassfeature3.2": {
      name: "Warrior of Death",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc(["I can cause my unarmed strikes to deal necrotic damage in place of bludgeoning",
        "I am resistant to necrotic damage and have advantage on saves vs being frightened"]),
      dmgres: ["Necrotic"],
      "necrotic mind": {
        name: "Necrotic Mind",
        extraname: "Way of the Reaper 3",
        source: [["GMB:LL", 0]],
        description: desc("I have advan. on save to resist or end the Frightened condition"),
        savetxt: {
          adv_vs: ["frightened"]
        },
      },
      "necrotic spirit": {
        name: "Necrotic Spirit",
        extraname: "Way of the Reaper 3",
        source: [["GMB:LL", 0]],
        description: desc("Should I die, my corpse falls under the effects of the gentle repose spell for a number of days equal to the Ki I had remaining when I died"),
        spellChanges: {
          "gentle repose": {
            changes:
              "Should I die, I go under the effect of this spell for a total of days equal my ki remaining when died",
          },
        },
        spellcastingBonus: [
          {
            name: "Way of the Reaper",
            spells: ["gentle repose"],
            selection: ["gentle repose"],
          },
        ],
      },
      autoSelectExtrachoices: [{
        extrachoice: "necrotic mind",
        minlevel: 3
      },
      {
        extrachoice: "necrotic spirit",
        minlevel: 3
      }]
    },
    "subclassfeature6.1": {
      name: "Sinister Vitality",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc(["Once per turn, When I deal necrotic damage, I can grant myself temp HP equal to my Wis mod (min 1)",
        "While those last, I am resistant to non-magical bludgeoning, piercing, and slashing damage from non-silvered attacks"]),
    },
    "subclassfeature6.2": {
      name: "Pierce the Veil",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc(["Once per corpse, I can touch it and expend Ki to my Wis mod (min 0)",
        "For each Ki spent, I can ask a single question, as per rules of the speak with dead spell"]),
      action: ["bonus action", ""],
      additional: "up Wis mod ki points",
      spellChanges: {
        "speak with dead": {
          changes:
            "I can touch a corpse once and make go under this spell to ask one question per each ki point spent (up to my Wis mod)",
        },
      },
      spellcastingBonus: [
        {
          name: "Way of the Reaper",
          spells: ["speak with dead"],
          selection: ["speak with dead"],
        },
      ],
    },
    "subclassfeature10": {
      name: "Armor of the Grave",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc(["If I am reduced to 0 HP but not killed outright, I can spend 1 Ki Point to fall to 1 HP instead",
        "When I do so, I can also choose to fall under a feign death spell",
        "Each subsequent time I use this before finishing a long rest, I must spend 1 additional Ki"]),
      usages: "-",
      recovery: "long rest",
      spellChanges: {
        "feign death": {
          changes:
            "When I am reduced to 0 hit poits, by my Armor of the Grave I can fall under this spell",
        },
      },
      spellcastingBonus: [
        {
          name: "Way of the Reaper",
          spells: ["feign death"],
          selection: ["feign death"],
        },
      ],
    },
    "subclassfeature17": {
      name: "Master of Reaping",
      source: [["GMB:LL", 0]],
      additional: "up to 10 ki points",
      minlevel: 17,
      description: desc(["Once per turn, when taking the Attack action, I can replace one of my attacks by a special effect",
        "I touch a crea and expend up to 10 ki; It must make a Con save (disadv if frightened of me)",
        "It takes 2d10 necrotic damage for each ki spent (half on save)"]),
    }
  }
});

// Way of the Rising Dragon (ascendant dragon)
AddSubClass("monk(laserllama)", "way of the rising dragon", {
  regExpSearch: /rising dragon/i,
  subname: "Way of the Rising Dragon",
  fullname: "Rising Dragon",
  source: [["GMB:LL", 0]],
  features: {

    "subclassfeature3": GetSubclassTechniques("Rising Dragon", ["step of the wind", "deflect missile", "indomitable spirit"]),
    "subclassfeature3.1": {
      name: "Draconic Element",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        'Choose a Draconic Element using the "Choose Feature" button above',
      ]),
      choices: [
        "Acid Draconic Element", "Cold Draconic Element", "Fire Draconic Element",
        "Lightning Draconic Element", "Poison Draconic Element",
        "Force Draconic Element", "Necrotic Draconic Element",
        "Psychic Draconic Element", "Radiant Draconic Element",
      ],
      "acid draconic element": {
        name: "Acid Draconic Element",
        description: desc([
          "I have an affinity with acid element",
          "Whenever I hit with an unarmed strike, I can deal acid damage instead of bludg damage"
        ]),
        dependentChoices: "acid"
      },
      "cold draconic element": {
        name: "Cold Draconic Element",
        description: desc([
          "I have an affinity with cold element",
          "Whenever I hit with an unarmed strike, I can deal cold damage instead of bludg damage"
        ]),
        dependentChoices: "cold"
      },
      "fire draconic element": {
        name: "Fire Draconic Element",
        description: desc([
          "I have an affinity with fire element",
          "Whenever I hit with an unarmed strike, I can deal fire damage instead of bludg damage"
        ]),
        dependentChoices: "fire"
      },
      "lightning draconic element": {
        name: "Lightning Draconic Element",
        description: desc([
          "I have an affinity with lightning element",
          "Whenever I hit with an unarmed strike, I can deal lightning damage instead of bludg damage"
        ]),
        dependentChoices: "lightning"
      },
      "poison draconic element": {
        name: "Poison Draconic Element",
        description: desc([
          "I have an affinity with poison element",
          "Whenever I hit with an unarmed strike, I can deal poison damage instead of bludg damage"
        ]),
        dependentChoices: "poison"
      },
      "force draconic element": {
        name: "Force Draconic Element",
        submenu: "Gem Dragons (ask DM)",
        description: desc([
          "I have an affinity with force element",
          "Whenever I hit with an unarmed strike, I can deal force damage instead of bludg damage"
        ]),
        dependentChoices: "force"
      },
      "necrotic draconic element": {
        name: "Necrotic Draconic Element",
        submenu: "Gem Dragons (ask DM)",
        description: desc([
          "I have an affinity with necrotic element",
          "Whenever I hit with an unarmed strike, I can deal necrotic damage instead of bludg damage"
        ]),
        dependentChoices: "necrotic"
      },
      "thunder draconic element": {
        name: "Thunder Draconic Element",
        submenu: "Gem Dragons (ask DM)",
        description: desc([
          "I have an affinity with thunder element",
          "Whenever I hit with an unarmed strike, I can deal thunder damage instead of bludg damage"
        ]),
        dependentChoices: "thunder"
      },
      "psychic draconic element": {
        name: "Psychic Draconic Element",
        submenu: "Gem Dragons (ask DM)",
        description: desc([
          "I have an affinity with psychic element",
          "Whenever I hit with an unarmed strike, I can deal psychic damage instead of bludg damage"
        ]),
        dependentChoices: "psychic"
      },
      "radiant draconic element": {
        name: "Radiant Draconic Element",
        submenu: "Gem Dragons (ask DM)",
        description: desc([
          "I have an affinity with radiant element",
          "Whenever I hit with an unarmed strike, I can deal radiant damage instead of bludg damage"
        ]),
        dependentChoices: "radiant"
      },
      choiceDependencies: [{
        feature: "subclassfeature3.2", // share the choice with the one for those features
        choiceAttribute: true // means it uses the dependentChoices attribute instead of the same choice (eg "acid" instead of "black dragon affinity")
      }, {
        feature: "subclassfeature10",
        choiceAttribute: true
      }]
    },
    "subclassfeature3.2": {
      name: "Elemental Breath",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map(function (n) {
        var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);
        var BreathRange = (n < 17 ? "20-foot cone or a 30-foot long, 5-foot wide line" : "30-foot cone or a 60-foot long, 5-foot wide line")

        return desc(["When I take the Attack action, I can spend 1 Ki to replace one attack with a breath weapon",
          "I do so either in an adjacent " + BreathRange,
          "Creatures in the area must make a Dex save or take 2d" + MartArtDie + (n < 10 ? "" : " + my Wis mod") + " Elemental damage (half on save)",
          "I can spend additional ki (up to my Wis mod) to add 1d" + MartArtDie + " to the damage per ki spent"])
      }),

      choices: ["acid", "cold", "fire", "lightning", "poison",
        "force", "radiant", "psychic", "thunder", "necrotic"],
      choicesNotInMenu: true,
      "acid": {
        name: "Acid Elemental Breath",
        description: levels.map(function (n) {
          var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);
          var BreathRange = (n < 17 ? "20-foot cone or a 30-foot long, 5-foot wide line" : "30-foot cone or a 60-foot long, 5-foot wide line")

          return desc(["When I take the Attack action, I can spend 1 Ki to replace one attack with a breath weapon",
            "I do so either in an adjacent " + BreathRange,
            "Creatures in the area must make a Dex save or take 2d" + MartArtDie + (n < 10 ? "" : " + my Wis mod") + " acid damage (half on save)",
            "I can spend additional ki (up to my Wis mod) to add 1d" + MartArtDie + " to the damage per ki spent"])
        })
      },
      "cold": {
        name: "Cold Elemental Breath",
        description: levels.map(function (n) {
          var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);
          var BreathRange = (n < 17 ? "20-foot cone or a 30-foot long, 5-foot wide line" : "30-foot cone or a 60-foot long, 5-foot wide line")

          return desc(["When I take the Attack action, I can spend 1 Ki to replace one attack with a breath weapon",
            "I do so either in an adjacent " + BreathRange,
            "Creatures in the area must make a Dex save or take 2d" + MartArtDie + (n < 10 ? "" : " + my Wis mod") + " cold damage (half on save)",
            "I can spend additional ki (up to my Wis mod) to add 1d" + MartArtDie + " to the damage per ki spent"])
        })
      },
      "fire": {
        name: "Fire Elemental Breath",
        description: levels.map(function (n) {
          var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);
          var BreathRange = (n < 17 ? "20-foot cone or a 30-foot long, 5-foot wide line" : "30-foot cone or a 60-foot long, 5-foot wide line")

          return desc(["When I take the Attack action, I can spend 1 Ki to replace one attack with a breath weapon",
            "I do so either in an adjacent " + BreathRange,
            "Creatures in the area must make a Dex save or take 2d" + MartArtDie + (n < 10 ? "" : " + my Wis mod") + " fire damage (half on save)",
            "I can spend additional ki (up to my Wis mod) to add 1d" + MartArtDie + " to the damage per ki spent"])
        })
      },
      "lightning": {
        name: "Lightning Elemental Breath",
        description: levels.map(function (n) {
          var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);
          var BreathRange = (n < 17 ? "20-foot cone or a 30-foot long, 5-foot wide line" : "30-foot cone or a 60-foot long, 5-foot wide line")

          return desc(["When I take the Attack action, I can spend 1 Ki to replace one attack with a breath weapon",
            "I do so either in an adjacent " + BreathRange,
            "Creatures in the area must make a Dex save or take 2d" + MartArtDie + (n < 10 ? "" : " + my Wis mod") + " lightning damage (half on save)",
            "I can spend additional ki (up to my Wis mod) to add 1d" + MartArtDie + " to the damage per ki spent"])
        })
      },
      "poison": {
        name: "Poison Elemental Breath",
        description: levels.map(function (n) {
          var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);
          var BreathRange = (n < 17 ? "20-foot cone or a 30-foot long, 5-foot wide line" : "30-foot cone or a 60-foot long, 5-foot wide line")

          return desc(["When I take the Attack action, I can spend 1 Ki to replace one attack with a breath weapon",
            "I do so either in an adjacent " + BreathRange,
            "Creatures in the area must make a Dex save or take 2d" + MartArtDie + (n < 10 ? "" : " + my Wis mod") + " poison damage (half on save)",
            "I can spend additional ki (up to my Wis mod) to add 1d" + MartArtDie + " to the damage per ki spent"])
        })
      },
      "force": {
        name: "Force Elemental Breath",
        description: levels.map(function (n) {
          var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);
          var BreathRange = (n < 17 ? "20-foot cone or a 30-foot long, 5-foot wide line" : "30-foot cone or a 60-foot long, 5-foot wide line")

          return desc(["When I take the Attack action, I can spend 1 Ki to replace one attack with a breath weapon",
            "I do so either in an adjacent " + BreathRange,
            "Creatures in the area must make a Dex save or take 2d" + MartArtDie + (n < 10 ? "" : " + my Wis mod") + " force damage (half on save)",
            "I can spend additional ki (up to my Wis mod) to add 1d" + MartArtDie + " to the damage per ki spent"])
        })
      },
      "radiant": {
        name: "Radiant Elemental Breath",
        description: levels.map(function (n) {
          var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);
          var BreathRange = (n < 17 ? "20-foot cone or a 30-foot long, 5-foot wide line" : "30-foot cone or a 60-foot long, 5-foot wide line")

          return desc(["When I take the Attack action, I can spend 1 Ki to replace one attack with a breath weapon",
            "I do so either in an adjacent " + BreathRange,
            "Creatures in the area must make a Dex save or take 2d" + MartArtDie + (n < 10 ? "" : " + my Wis mod") + " radiant damage (half on save)",
            "I can spend additional ki (up to my Wis mod) to add 1d" + MartArtDie + " to the damage per ki spent"])
        })
      },
      "psychic": {
        name: "Psychic Elemental Breath",
        description: levels.map(function (n) {
          var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);
          var BreathRange = (n < 17 ? "20-foot cone or a 30-foot long, 5-foot wide line" : "30-foot cone or a 60-foot long, 5-foot wide line")

          return desc(["When I take the Attack action, I can spend 1 Ki to replace one attack with a breath weapon",
            "I do so either in an adjacent " + BreathRange,
            "Creatures in the area must make a Dex save or take 2d" + MartArtDie + (n < 10 ? "" : " + my Wis mod") + " psychic damage (half on save)",
            "I can spend additional ki (up to my Wis mod) to add 1d" + MartArtDie + " to the damage per ki spent"])
        })
      },
      "thunder": {
        name: "Thunder Elemental Breath",
        description: levels.map(function (n) {
          var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);
          var BreathRange = (n < 17 ? "20-foot cone or a 30-foot long, 5-foot wide line" : "30-foot cone or a 60-foot long, 5-foot wide line")

          return desc(["When I take the Attack action, I can spend 1 Ki to replace one attack with a breath weapon",
            "I do so either in an adjacent " + BreathRange,
            "Creatures in the area must make a Dex save or take 2d" + MartArtDie + (n < 10 ? "" : " + my Wis mod") + " thunder damage (half on save)",
            "I can spend additional ki (up to my Wis mod) to add 1d" + MartArtDie + " to the damage per ki spent"])
        })
      },
      "necrotic": {
        name: "Necrotic Elemental Breath",
        description: levels.map(function (n) {
          var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);
          var BreathRange = (n < 17 ? "20-foot cone or a 30-foot long, 5-foot wide line" : "30-foot cone or a 60-foot long, 5-foot wide line")

          return desc(["When I take the Attack action, I can spend 1 Ki to replace one attack with a breath weapon",
            "I do so either in an adjacent " + BreathRange,
            "Creatures in the area must make a Dex save or take 2d" + MartArtDie + (n < 10 ? "" : " + my Wis mod") + " necrotic damage (half on save)",
            "I can spend additional ki (up to my Wis mod) to add 1d" + MartArtDie + " to the damage per ki spent"])
        })
      }
    },
    "subclassfeature3.3": {
      name: "Ancient Tongue",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc(
        'Choose a Ancient Tongue proficiency using the "Choose Feature" button above'
      ),
      languageProfs: ["Draconic"],
      choices: ["Deception", "Intimidation", "Persuasion"],
      "deception": {
        name: "Deception",
        description: desc(
          "I learn Draconic and I am proficient in Deception",
          "Whenever I make a Deception check I add my Martial Art Die to it"
        ),
        skills: ["Deception"],
      },
      "intimidation": {
        name: "Intimidation",
        description: desc(
          "I learn Draconic and I am proficient in Intimidation",
          "Whenever I make an Intimidation check I add my Martial Art Die to it"
        ),
        skills: ["Intimidation"],
      },
      "persuasion": {
        name: "Persuasion",
        description: desc(
          "I learn Draconic and I am proficient in Persuasion",
          "Whenever I make an Persuasion check I add my Martial Art Die to it"
        ),
        skills: ["Persuasion"],
      },
    },
    "subclassfeature6": {
      name: "Ascendant Step",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "When I use step of the wind, I gain a fly speed equal to my walk spd until the end of my turn"
      ])
    },
    "subclassfeature10": {
      name: "Draconic Mantle",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: levels.map(function (n) {
        var MantleRange = (n < 17 ? 10 : 30);

        return desc(["Me and creatures of my choice within " + MantleRange + " ft of me have resistance to my Element and adv. on save vs charmed or frightened"])
      }),
      savetxt: { adv_vs: ["charmed", "frightened"] },

      choices: ["acid", "cold", "fire", "lightning", "poison",
        "force", "radiant", "psychic", "thunder", "necrotic"],
      choicesNotInMenu: true,
      "acid": {
        name: "Acid Draconic Mantle",
        description: levels.map(function (n) {
          var MantleRange = (n < 17 ? 10 : 30);

          return desc([
            "Me and creatures of my choice within " + MantleRange + " ft of me have resistance to Acid damage and adv. on save vs charmed or frightened",
            "My Elemental Breath is improved (see it)"
          ])
        }),
        dmgres: ["Acid"]
      },
      "cold": {
        name: "Cold Draconic Mantle",
        description: levels.map(function (n) {
          var MantleRange = (n < 17 ? 10 : 30);

          return desc([
            "Me and creatures of my choice within " + MantleRange + " ft of me have resistance to Cold damage and adv. on save vs charmed or frightened",
            "My Elemental Breath is improved (see it)"])
        }),
        dmgres: ["Cold"]
      },
      "fire": {
        name: "Fire Draconic Mantle",
        description: levels.map(function (n) {
          var MantleRange = (n < 17 ? 10 : 30);

          return desc([
            "Me and creatures of my choice within " + MantleRange + " ft of me have resistance to Fire damage and adv. on save vs charmed or frightened",
            "My Elemental Breath is improved (see it)"])
        }),
        dmgres: ["Fire"]
      },
      "lightning": {
        name: "Lightning Draconic Mantle",
        description: levels.map(function (n) {
          var MantleRange = (n < 17 ? 10 : 30);

          return desc([
            "Me and creatures of my choice within " + MantleRange + " ft of me have resistance to Lightning damage and adv. on save vs charmed or frightened",
            "My Elemental Breath is improved (see it)"
          ])
        }),
        dmgres: ["Lightning"]
      },
      "poison": {
        name: "Poison Draconic Mantle",
        description: levels.map(function (n) {
          var MantleRange = (n < 17 ? 10 : 30);

          return desc([
            "Me and creatures of my choice within " + MantleRange + " ft of me have resistance to Poison damage and adv. on save vs charmed or frightened",
            "My Elemental Breath is improved (see it)"])
        }),
        dmgres: ["Poison"]
      },
      "force": {
        name: "Force Draconic Mantle",
        description: levels.map(function (n) {
          var MantleRange = (n < 17 ? 10 : 30);

          return desc([
            "Me and creatures of my choice within " + MantleRange + " ft of me have resistance to Force damage and adv. on save vs charmed or frightened",
            "My Elemental Breath is improved (see it)"
          ])
        }),
        dmgres: ["Force"]
      },
      "radiant": {
        name: "Radiant Draconic Mantle",
        description: levels.map(function (n) {
          var MantleRange = (n < 17 ? 10 : 30);

          return desc([
            "Me and creatures of my choice within " + MantleRange + " ft of me have resistance to Radiant damage and adv. on save vs charmed or frightened",
            "My Elemental Breath is improved (see it)"])
        }),
        dmgres: ["Radiant"]
      },
      "psychic": {
        name: "Psychic Draconic Mantle",
        description: levels.map(function (n) {
          var MantleRange = (n < 17 ? 10 : 30);

          return desc([
            "Me and creatures of my choice within " + MantleRange + " ft of me have resistance to Psychic damage and adv. on save vs charmed or frightened",
            "My Elemental Breath is improved (see it)"
          ])
        }),
        dmgres: ["Psychic"]
      },
      "thunder": {
        name: "Thunder Draconic Mantle",
        description: levels.map(function (n) {
          var MantleRange = (n < 17 ? 10 : 30);

          return desc([
            "Me and creatures of my choice within " + MantleRange + " ft of me have resistance to Thunder damage and adv. on save vs charmed or frightened",
            "My Elemental Breath is improved (see it)"
          ])
        }),
        dmgres: ["Thunder"]
      },
      "necrotic": {
        name: "Necrotic Draconic Mantle",
        description: levels.map(function (n) {
          var MantleRange = (n < 17 ? 10 : 30);

          return desc([
            "Me and creatures of my choice within " + MantleRange + " ft of me have resistance to Necrotic damage and adv. on save vs charmed or frightened",
            "My Elemental Breath is improved (see it)"
          ])
        }),
        dmgres: ["Necrotic"]
      },
    },
    "subclassfeature17": {
      name: "Master of Draconic Might",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc([
        "I manifest leathery draconic wings which grant me a fly speed equal to my walking speed",
        "My Elemental Breath is improved (see it)"]),
      speed: { fly: { spd: "walk", enc: "walk" } }
    }
  }
});

// Way of the Shadow Arts
AddSubClass("monk(laserllama)", "way of the shadow arts", {
  regExpSearch: /shadow arts/i,
  subname: "Way of the Shadow Arts",
  fullname: "Shadow Arts",
  source: [["GMB:LL", 0]],
  features: {
    "subclassfeature3": GetSubclassTechniques("Shadow", ["slow fall", "gentling touch", "heavenly step"]),
    "subclassfeature3.1": {
      name: "Eyes of Night",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc(["I gain 60 ft darkvision, or add 30 ft to darkvision if I already had it",
        "I have advantage on any Dexterity (Stealth) checks I make while in darkness"]),
      vision: [["Darkvision", "fixed 60"], ["Darkvision", "+30"]]
    },
    "subclassfeature3.2": {
      name: "Shadow Arts",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map(function (n) {
        if (n < 17) return desc(["I can cast Darkness, Darkvision, Pass Without Trace and Silence once per long rest each",
          "If I have no uses left, I can instead spend 2 ki; I see through magical darkness I create as if it were daylight"])

        return desc(["I can cast Darkness, Darkvision, Pass Without Trace and Silence at will",
          "I see through magical darkness I create"])
      }),
      spellFirstColTitle: "Ki",
      spellcastingBonus: {
        name: "Shadow Arts",
        spells: ["darkness", "darkvision", "pass without trace", "silence"],
        selection: ["darkness", "darkvision", "pass without trace", "silence"],
        firstCol: "oncelr",
        times: 4
      }
    },
    "subclassfeature6": {
      name: "Shadow Step",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: levels.map(function (n) {
        shadowstep_range = n < 17 ? "60 ft" : "120 ft";

        return desc(["As a bonus action, I can teleport from and into dim light or darkness within " + shadowstep_range,
          "After I do this, I have adv. on the next Martial Arts attack I make before the end of my turn"])
      }),
      action: ["bonus action", ""]
    },
    "subclassfeature10": {
      name: "Cloak of Shadows",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: levels.map(function (n) {
        cloak_actioncost = n < 17 ? "action" : "action or bonus action";

        return desc(["As an " + cloak_actioncost + ", I can become invisible in dim light or darkness until I attack/cast/leave darkness",
          "If a crea enters my reach while I am invisible, I can make an opportunity attack against it",
          "Opportunity attacks only end my invisibility if I hit"])
      }),
      action: ["action", ""]
    },
    "subclassfeature17": {
      name: "Master of Shadows",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc(["I can cast Greater Invisibility and Shadow of Moil once per long rest each",
        "If I have no uses left, I can instead spend 4 ki; I don't need material components for those",
        " Also my Shadow Arts, Shadow Step and Cloack of Shadows are improved (see them)"]),
      action: [["bonus action", "Cloak of Shadows"]],
      spellFirstColTitle: "Ki",
      spellcastingBonus: {
        name: "Master of Shadows",
        spells: ["greater invisibility", "shadow of moil"],
        selection: ["greater invisibility", "shadow of moil"],
        firstCol: "oncelr",
        times: 2
      },
      spellChanges: {
        "greater invisibility": {
          components: "V",
          compMaterial: "",
          changes: "Spell cast with Master of Shadows don't require material components."
        },
        "shadow of moil": {
          components: "V,S",
          compMaterial: "",
          changes: "Spell cast with Master of Shadows don't require material components."
        },
        "darkness": {
          firstCol: "atwill",
          changes: "Spell cast with Shadow Arts can be used at will"
        },
        "darkvision": {
          firstCol: "atwill",
          changes: "Spell cast with Shadow Arts can be used at will"
        },
        "pass without trace": {
          firstCol: "atwill",
          changes: "Spell cast with Shadow Arts can be used at will"
        },
        "silence": {
          firstCol: "atwill",
          changes: "Spell cast with Shadow Arts can be used at will"
        }
      }
    }
  }
});

// Way of the Wu Jen (four elements)
AddSubClass("monk(laserllama)", "way of the wu jen", {
  regExpSearch: /wu jen/i,
  subname: "Way of the Wu Jen",
  fullname: "Wu Jen",
  source: [["GMB:LL", 0]],
  abilitySave: 5,
  spellcastingList: {
    spells: WuJenList
  },
  spellcastingFactor: "warlock3", // There's no RAW indication on the alt monk document, but it's the same table as Witchblade so it's what makes the most sense
  spellcastingTable: [
    [0, 0, 0, 0, 0, 0, 0, 0, 0], //lvl 0
    [0, 0, 0, 0, 0, 0, 0, 0, 0], //lvl 1
    [0, 0, 0, 0, 0, 0, 0, 0, 0], //lvl 2
    [1, 0, 0, 0, 0, 0, 0, 0, 0], //lvl 3
    [2, 0, 0, 0, 0, 0, 0, 0, 0], //lvl 4
    [2, 0, 0, 0, 0, 0, 0, 0, 0], //lvl 5
    [2, 0, 0, 0, 0, 0, 0, 0, 0], //lvl 6
    [0, 2, 0, 0, 0, 0, 0, 0, 0], //lvl 7
    [0, 2, 0, 0, 0, 0, 0, 0, 0], //lvl 8
    [0, 2, 0, 0, 0, 0, 0, 0, 0], //lvl 9
    [0, 2, 0, 0, 0, 0, 0, 0, 0], //lvl10
    [0, 2, 0, 0, 0, 0, 0, 0, 0], //lvl11
    [0, 2, 0, 0, 0, 0, 0, 0, 0], //lvl12
    [0, 0, 2, 0, 0, 0, 0, 0, 0], //lvl13
    [0, 0, 2, 0, 0, 0, 0, 0, 0], //lvl14
    [0, 0, 2, 0, 0, 0, 0, 0, 0], //lvl15
    [0, 0, 2, 0, 0, 0, 0, 0, 0], //lvl16
    [0, 0, 2, 0, 0, 0, 0, 0, 0], //lvl17
    [0, 0, 2, 0, 0, 0, 0, 0, 0], //lvl18
    [0, 0, 0, 2, 0, 0, 0, 0, 0], //lvl19
    [0, 0, 0, 2, 0, 0, 0, 0, 0] //lvl20
  ],
  spellcastingKnown: {
    cantrips: [0, 0, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3],
    spells: [0, 0, 2, 2, 3, 3, 4, 4, 5, 5, 5, 5, 6, 6, 6, 6, 7, 7, 7, 7]
  },
  features: {
    "subclassfeature3": {
      name: "Disciple of the Elements",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc(["I can cast Wu Jen cantrips/spells that I know, using Wisdom as my spellcasting ability",
        "I can replace a spell I know with another Wu Jen spell when I gain a level",
        "I regain these spell slots on a short rest; I don't need material components"]),
      calcChanges: {
        spellAdd: [
          function (spellKey, spellObj, spName) {
            if (spName == "monk(laserllama)") {
              if (spellObj.compMaterial && !(/M[\u0192\u2020]/i).test(spellObj.components)) spellObj.compMaterial = "";
              spellObj.components = spellObj.components.replace(/,?M/ig, '');
              return true;
            };
          },
          "My Wu Jen spells don't require material components."
        ]
      },
      additional: ["", "", "1 cantrip \u0026 2 spells known", "1 cantrip \u0026 2 spells known", "1 cantrip \u0026 3 spells known", "1 cantrip \u0026 3 spells known", "1 cantrip \u0026 4 spells known", "1 cantrip \u0026 4 spells known", "1 cantrip \u0026 5 spells known", "2 cantrips \u0026 5 spells known", "2 cantrips \u0026 5 spells known", "2 cantrips \u0026 5 spells known", "2 cantrips \u0026 6 spells known", "2 cantrips \u0026 6 spells known", "2 cantrips \u0026 6 spells known", "2 cantrips \u0026 6 spells known", "3 cantrips \u0026 7 spells known", "3 cantrips \u0026 7 spells known", "3 cantrips \u0026 7 spells known", "3 cantrips \u0026 7 spells known"],

    },
    "subclassfeature3.1": {
      name: "Fist of the Five Ways",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "When I make an unarmed strike, I can choose for it to deal damage type of a Wu Jen spell I know and increase my reach by 5 ft"
      ]),
      "elemental spirit": {
        name: "Elemental Spirit",
        extraname: "Way of the Wu Jen 6",
        source: [["GMB:LL", 0]],
        minlevel: 6,
        description: desc([
          "As a bonus action on my turn, I regain one expended Wu Jen spell slot (WJSS) by spending 1+WJSS Ki points",
          "Also, if I use my action to cast a Wu Jen spell, I can make an unarmed strike as a bonus action"]),
        action: [
          ["bonus action", " Regain WJSS"]
          ["bonus action", "Unarmed Strike (with Wu Jen casting action)"]
        ],
      },
      "spiritual flow": {
        name: "Spiritual Flow",
        extraname: "Way of the Wu Jen 10",
        source: [["GMB:LL", 0]],
        minlevel: 10,
        description: desc("I can cast a Wu Jen spell with a casting time of 1 action as a bonus action instead"),
        additional: "2 ki points"
      },
      autoSelectExtrachoices: [{
        extrachoice: "spiritual flow",
        minlevel: 10
      }]
    },
    "subclassfeature17": {
      name: "Master of the Elements",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc(["As an action, I can take on an Elemental Form for up to 1 min, gaining the following benefits:",
        "\u2022 I gain a flying speed equal to my walking speed",
        "\u2022 I resist bludgeoning, piercing, and slashing damage",
        "\u2022 Critical hits against me become normal hits",
        "\u2022 Opportunity attacks against me have disadvantage",
        "\u2022 I can gain temp HP equal to my Wis mod (min 1) at the start of each of my turns",
        "It ends early if I end it as a bonus action or if I am incapacitated",
        "I can use this once per long rest, I can spend 6 Ki if I have no uses left"]),
      action: [["action", "Elemental Form (start)"], ["bonus action", "Elemental Form (end)"]],
      usages: 1,
      recovery: "long rest",
      dmgres: [["Bludgeoning", "Bludgeon. (in elem. form)"], ["Piercing", "Piercing (in elem. form)"], ["Slashing", "Slashing (in elem. form)"]],
    }
  }
});

// Way of the Shining Steel (Kensei)
AddSubClass("monk(laserllama)", "way of the shining steel", {
  regExpSearch: /shining steel/i,
  subname: "Way of the Shining Steel",
  source: ["GMB:LL"],
  fullname: "Shining Steel",
  features: {
    "subclassfeature3": GetSubclassTechniques("Shining Steel", ["patient defense", "seeking strike", "heavenly step"]),
    "subclassfeature3.1": {
      name: "Student of Steel",
      source: ["GMB:LL"],
      minlevel: 3,
      extrachoices: [],
      description: levels.map(function (n) {
        signWeas = n < 17 ? n < 10 ? n < 6 ? 1 : 2 : 3 : 4;
        return desc([
          'I can choose weapons to be my Signature Weapons (write "signature" in their name)',
          "At least " + signWeas + " ranged and " + signWeas + " melee weapons without the Heavy or Special properties",
          "With these: I am proficient, and they are eligible for my Martial Art attacks"
        ])
      }),
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (((/signature/i).test(v.WeaponTextName) && !v.theWea.special && (!(/heavy|special/i).test(fields.Description)))) {
              v.theWea.monkweapon = true;
              fields.Proficiency = true;
            };
          },
          "For the weapons that I include the word 'signature' in the name of a weapon that doesn't have the Heavy or Special attribute, that weapon gains the same benefits as any other 'Monk Weapon'",
          1
        ]
      }
    },
    "subclassfeature3.2": {
      name: "Deadly Perfection",
      source: ["GMB:LL"],
      minlevel: 3,
      description: desc(["I gain the following feature while wiealding a Signature Weapon:",
        "\u2022 Masterful Aim: As a bonus action on my turn, I can focus and for the next attack roll I make before the end of my current turn, I can treat a d20 roll of 7 or lower as an 8",
        "\u2022 Masterful Parry: When hit in melee by a creature I can see, I can use a reaction to add my Wis mod (min of +1) to my AC against that attack"
      ]),
      action: [["bonus action", "Masterful Aim"], ["reaction", "Masterful Parry"]],
    },
    "subclassfeature6": {
      name: "Shining Steel",
      source: ["GMB:LL"],
      minlevel: 6,
      description: desc([
        "My Signature Weapons gain the following:",
        "I can choose to deal radiant dmg instead of its normal damage",
        "Once per turn, I can expend 1 Ki to to deal extra dmg equal to my Martial Art Die on hit",
        "When I do Flurry of Blows I can replace one unarmed strike with a Signature Weapon attack"]),
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (((/signature/i).test(v.WeaponTextName) && !v.theWea.special && (!(/heavy|special/i).test(fields.Description)))) {
              var aMonkDie = function (n) { return (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12) }(classes.known["monk(laserllama)"].level);
              fields.Description += (fields.Description ? '; ' : '') + 'I can choose to deal Radiant damage instead; 1 Ki: 1d' + aMonkDie + ' extra damage';
            };
          },
          "My unarmed strikes and any Signature Weapons count as magical for overcoming resistances and immunities."
        ]
      },
      "spirit blade": {
        name: "Spirit Blade",
        minlevel: 10,
        source: ["GMB:LL"],
        description: desc([
          "Over a course of a long rest, with 1H ritual, I can increase the crit range of up to my Wis mod Signature weapons",
          "This bonus is equal to the number of ki points I spend and doesn't stack with magic",
          "I cannot regain the Ki spent this way unless I perform the ritual again to remove the Ki from one or more Signature Weapons"
        ]),
        additional: "1 to 3 ki points",
      },
      autoSelectExtrachoices: [
        {
          extrachoice: "spirit blade",
          minlevel: 10
        }
      ]
    },
    "subclassfeature17": {
      name: "Master of Shining Steel",
      source: ["GMB:LL"],
      minlevel: 17,
      description: desc([
        "Once per short rest, I can use my monk level instead of rolling the d20 for an attack",
        "If using my monk level would result in a critical hit, that attack becomes an automatic critical hit"
      ]),
      recovery: "short rest",
      usages: 1
    }
  }
});

// RunFunctionAtEnd(function () { // The RunFunctionAtEnd is there to make sure we take into account all weapon types for the lvl 3 feature
//   var theKenseiSubclassName = AddSubClass("monk(laserllama)", "way of the shining steel", {
//     regExpSearch: /shining steel/i,
//     subname: "Way of the Shining Steel",
//     source: ["GMB:LL"],
//     fullname: "Shining Steel",
//     features: {
//       "subclassfeature3": GetSubclassTechniques("Wuxia", ["patient defense", "seeking strike", "heavenly step"]),
//       "subclassfeature3.1": {
//         name: "Student of Steel",
//         source: ["GMB:LL"],
//         minlevel: 3,
//         extrachoices:[],
//         description: levels.map(function (n) {
//           signWeas = n < 17 ? n < 10 ? n < 6 ? 1 : 2 : 3 : 4;
//           return desc([
//             'I can choose weapons to be my Signature Weapons (write "signature" in their name)',
//             "At least " + signWeas + " ranged and " + signWeas + " melee weapons without the Heavy or Special properties",
//             "With these: I am proficient, and they are eligible for my Martial Art attacks"
//           ])
//         }),
//         calcChanges: {
//           atkAdd: [
//             function (fields, v) {
//               if (((/signature/i).test(v.WeaponTextName) && !v.theWea.special && (!(/heavy|special/i).test(fields.Description)))) {
//                 v.theWea.monkweapon = true;
//                 fields.Proficiency = true;
//               };
//             },
//             "For the weapons that I include the word 'signature' in the name of a weapon that doesn't have the Heavy or Special attribute, that weapon gains the same benefits as any other 'Monk Weapon'",
//             1
//           ]
//         }
//       },
//       "subclassfeature3.2": {
//         name: "Deadly Perfection",
//         source: ["GMB:LL"],
//         minlevel: 3,
//         description: desc(["I gain the following feature while wiealding a Signature Weapon:",
//           "\u2022 Masterful Aim: As a bonus action on my turn, I can focus and for the next attack roll I make before the end of my current turn, I can treat a d20 roll of 7 or lower as an 8",
//           "\u2022 Masterful Parry: When hit in melee by a creature I can see, I can use a reaction to add my Wis mod (min of +1) to my AC against that attack"
//         ]),
//         action: [["bonus action", "Masterful Aim"], ["reaction", "Masterful Parry"]],
//       },
//       "subclassfeature6": {
//         name: "Shining Steel",
//         source: ["GMB:LL"],
//         minlevel: 6,
//         description: desc([
//           "My Signature Weapons gain the following:",
//           "I can choose to deal radiant dmg instead of its normal damage",
//           "Once per turn, I can expend 1 Ki to to deal extra dmg equal to my Martial Art Die on hit",
//           "When I do Flurry of Blows I can replace one unarmed strike with a Signature Weapon attack"]),
//         calcChanges: {
//           atkAdd: [
//             function (fields, v) {
//               if (((/signature/i).test(v.WeaponTextName) && !v.theWea.special && (!(/heavy|special/i).test(fields.Description)))) {
//                 var aMonkDie = function (n) { return (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12) }(classes.known["monk(laserllama)"].level);
//                 fields.Description += (fields.Description ? '; ' : '') + 'I can choose to deal Radiant damage instead; 1 Ki: 1d' + aMonkDie + ' extra damage';
//               };
//             },
//             "My unarmed strikes and any Wuxia Weapons count as magical for overcoming resistances and immunities."
//           ]
//         },
//         "spirit blade": {
//           name: "Spirit Blade",
//           extraname: "Way of the Wuxia 10",
//           source: ["GMB:LL"],
//           description: desc([
//             "Over a course of a long rest, with 1H ritual, I can increase the crit range of up to my Wis mod Signature weapons",
//             "This bonus is equal to the number of ki points I spend and doesn't stack with magic",
//             "I cannot regain the Ki spent this way unless I perform the ritual again to remove the Ki from one or more Signature Weapons"
//           ]),
//           additional: "1 to 3 ki points",
//         },
//         autoSelectExtrachoices: [
//           {
//             extrachoice: "spirit blade",
//             minlevel: 10
//           }
//         ]
//       },
//       "subclassfeature17": {
//         name: "Master of Shining Steel",
//         source: ["GMB:LL"],
//         minlevel: 17,
//         description: desc([
//           "Once per short rest, I can use my monk level instead of rolling the d20 for an attack",
//           "If using my monk level would result in a critical hit, that attack becomes an automatic critical hit"
//         ]),
//         recovery: "short rest",
//         usages: 1
//       }
//     }
//   });

//   var itsFea = ClassSubList[theKenseiSubclassName].features["subclassfeature3.1"];
//   for (var weapon in WeaponsList) {
//     var aWea = WeaponsList[weapon];
//     // skip attacks that are not simple or martial weapons, that have the heavy or special property, are magic weapons, or those that are spells or cantrips
//     if ((aWea.isMagicWeapon || !(/simple|martial/i).test(aWea.type) || (/heavy|special/i).test(aWea.description) || aWea.special || (/spell|cantrip/i).test(aWea.list))) continue;
//     itsFea.extrachoices.push(aWea.name);
//     itsFea[aWea.name.toLowerCase()] = {
//       name: aWea.name,
//       description: "",
//       source: aWea.source,
//       weaponProfs: [false, false, [weapon]],
//       weaponsAdd: [aWea.name],
//       submenu: ((/simple/i).test(aWea.type) ? "\x1BSimple weapon, " : "Martial weapon, ") + ((/^(?!.*melee).*\d+.*$/i).test(aWea.range) ? "ranged" : "melee"),
//       prereqeval: 'testSource("' + weapon + '", WeaponsList["' + weapon + '"], "weapExcl") ? "skip" : true;'
//     }
//   }
// });

// Way of the Boulder
AddSubClass("monk(laserllama)", "way of the boulder", {
  regExpSearch: /boulder/i,
  subname: "Way of the Boulder",
  fullname: "Boulder",
  source: [["GMB:LL", 0]],
  features: {
    // Override unarmoured defense because of Solid Body
    "unarmored defense": {
      name: "Unarmored Defense",
      source: ["GMB:LL"],
      minlevel: 1,
      description: levels.map(function (n) {
        if (n < 3) return desc("Without armor and no shield, my AC is 10 + Dexterity modifier + Wisdom modifier");

        return desc("Without armor and no shield, my AC is 10 + Constitution modifier + Wisdom modifier");
      }),
      armorOptions: [{
        regExpSearch: /justToAddToDropDown/,
        name: "Unarmored Defense (Wis)",
        source: ["GMB:LL"],
        ac: "10+Wis",
        affectsWildShape: true
      }],
      armorAdd: "Unarmored Defense (Wis)"
    },

    "subclassfeature3": GetSubclassTechniques("Boulder", ["deflect strike", "crushing strike", "tremor strike"]),
    "subclassfeature3.1": {
      name: "Solid Body",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc(["I can use CON, in place of STR or DEV for Martial Arts features and Unarmored Defense",
        "Moreover, when I make a STR save or check I can spend 1 Ki to add my CON mod to the roll. While I touch the ground, this feature does not require Ki to use."
      ]),
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (v.theWea.monkweapon) {

              if (fields.Mod === 1 || fields.Mod === 2 || What(AbilityScores.abbreviations[v.StrDex - 1] + " Mod") <= What("Con Mod")) {
                fields.Mod = 3;
              }
            };
          },
          "I can use either Constitution, Strength or Dexterity for Martial Arts attack and damage rolls",
          10
        ]
      },
      extraAC: [{
        name: "Solid Body",
        mod: "max(Con-Dex|0)",
        text: "I can use my Con to calculate my AC instead of Dex while not wearing armor or a shield",
        stopeval: function (v) {
          return (v.wearingArmor || v.usingShield)
        }
      }],
    },
    "subclassfeature6": {
      name: "Rebounding Defense",
      minlevel: 6,
      source: [["GMB:LL", 0]],
      description: desc(["I can use deflect strike without spendind Ki. When I do so, I can use CON in palce of DEX to calculate how much damage is reduced by"]),
      action: ["reaction", ""]
    },
    "subclassfeature10": {
      name: "Density of Spirit",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc(["I gain resistance to one of the following damage types: bludgeoning, piercing, slashing, acid, cold, fire, lighting, or thunder",
        "I can replace the chosen resistance through a short/long rest or by spending 2 ki as a bonus action"]),
      action: ["bonus action", " (change resistance)"]
    },
    "subclassfeature17": {
      name: "Mighty Form",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc(["Both my Constitution score, and maximum Constitution score, increase by 2 to a max of 22"]),
      scores: [0, 0, 2, 0, 0, 0],
      scoresMaximum: [0, 0, 22, 0, 0, 0],
    },
    "subclassfeature17.1": {
      name: "Earthshaker",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc(["Whenever I use the tremor strike technique, I can choose to affect the area within a 25-foot radius in place of the normal 25-foot cone of earth" +
        "\n   I can ignore any difficult terrain created by this Techinque" +
        "\n   Finally I can use it without spending Ki up to my CON mod (min of once) per long rest, as I had spent 1 Ki, though I can spend more Ki to empower your Technique futher, as normal"
      ]),
      usages: "Con mod per ",
      usagescalc: "event.value = Math.max(1, What('Con Mod'));",
      recovery: "long rest",
      action: ["action", ""]
    }
  }
});

// Way of the Brawler
AddSubClass("monk(laserllama)", "way of the brawler", {
  regExpSearch: /brawler/i,
  subname: "Way of the Brawler",
  fullname: "Brawler",
  source: [["GMB:LL", 0]],
  features: {
    // Override Ki adept because of the lvl 3 subclass feature
    "ki adept": {
      name: "Ki Adept",
      source: ["GMB:LL"],
      minlevel: 11,
      description: desc("Once on my turn, I can use a Technique I know that costs 1 Ki Point, Flurry of Blows, or Infamous Reputation without spending Ki")
    },

    "savage exploits": function () {
      // Fixed attributes
      SavageExploits = {
        name: "Savage Exploits",
        source: [["GMB:LL", 0]],
        minlevel: 3,
        description: desc(["I gain Exploit Dice, which are used to fuel my Savage Exploits",
          "Use the \"Choose Feature\" button above to choose Savage Exploits"]),
        toNotesPage: [{
          name: "Brawler Exploits",
          note: desc(["Below are all Brawler Exploits I know. Each 3rd level exploit can only be used per short rest."])
        }],

        // Savage Exploits
        extraname: "Savage Exploits",
        extraTimes: ['', '', 2, 2, 3, 3, 4, 4, 4, 4, 5, 5, 5, 5, 6, 6, 6, 6, 7, 7],
        extrachoices: [],

        // Exploit dice
        // limfeaname: "Exploit Dice",
        // usages: ['', '', 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4],
        // additional: ['', '', "d4", "d4", "d4", "d4", "d6", "d6", "d6", "d6", "d6", "d6", "d6", "d6", "d8", "d8", "d8", "d8", "d8", "d8"],
        // recovery: "short rest",
      }

      // Make a filtered spell list that contains only barbarian(laserllama) "spells" of 1st, 2nd and 3rd degree (exclude 4th and 5th degree)
      const BarbarianSpells = Object.keys(SpellsList).filter((key) => SpellsList[key].isExploit && SpellsList[key].level <= 3).filter((key) => {
        for (var i = 0; i < SpellsList[key].classes.length; i++) {
          if (SpellsList[key].classes[i] == "barbarian(laserllama)") return true;
        }
        return false;
        // NOTE: this is literally a SpellsList[key].classes.includes("barbarian(laserllama)") but for some cursed reason I can't use that function
      });

      // Iterate over all barbarian(laserllama) "spells"
      for (var i = 0; i < BarbarianSpells.length; i++) {
        var NewSpell = SpellsList[BarbarianSpells[i]];
        var tempSpell = BarbarianSpells[i];

        SavageExploits.extrachoices.push(NewSpell.name); // Add "spell" name to menu options

        SavageExploits[BarbarianSpells[i]] = { // Add "spell" to the main item (when it is picked through the menu)
          name: NewSpell.name,
          toNotesPage: [{ // What is added to the notes page
            name: NewSpell.name + " Exploit [" + (NewSpell.level == 1 ? '1st' : NewSpell.level == 2 ? '2nd' : NewSpell.level == 3 ? '3rd' : NewSpell.level + 'th') + " degree]",
            note: desc(NewSpell.descriptionFull),
            amendTo: "Brawler Exploits"
          }],
          source: NewSpell.source,
          addMod: NewSpell.addMod,
          submenu: NewSpell.submenu,
          prereqeval: ExploitPrereqFactoryBrawler(BarbarianSpells[i], "monk(laserllama)"), // IMPORTANT NOTE: ExploitPrereqFactory**HALF** because progression differs
          eval: CreateSavageSpellsheet,
          spellcastingBonusElsewhere: {
            addTo: "savage exploits",
            spellcastingBonus: {
              name: "Brawler Exploits",
              spellcastingAbility: 1,
              spells: [BarbarianSpells[i]],
              selection: [BarbarianSpells[i]]
            }
          }
        }
      }

      return SavageExploits
    }(),

    "exploit dice": {
      name: "Exploit Dice",
      description: "I have a pool of dice to fuels my Exploits. They may change in size and number with a multiclass",
      minlevel: 3,
      eval: function () {
        var brawlerEDs = calcExploitDice();
        AddFeature("Exploit Dice", brawlerEDs.usages, " (" + brawlerEDs.additional + ")", "short rest", "Way of the Brawler");
      },
      changeeval: function () {
        var brawlerEDs = calcExploitDice();
        AddFeature("Exploit Dice", brawlerEDs.usages, " (" + brawlerEDs.additional + ")", "short rest", "Way of the Brawler");
      },
      removeeval: function () {
        var brawlerEDs = calcExploitDice();
        AddFeature("Exploit Dice", brawlerEDs.usages, " (" + brawlerEDs.additional + ")", "short rest", "Way of the Brawler");
      },
    },

    "subclassfeature3.1": {
      name: "Streetwise",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc("I gain proficiency in Intimidation and learn Thieves' Cant"),
      skills: ["Intimidation"],
      languageProfs: ["Thieves' Cant"]
    },
    "subclassfeature6": {
      name: "Violent Enlinghtenment",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "My melee Martial Arts attacks score a critical hit on a roll of 19 or 20 on the d20" +
        "\n    When I crit on a melee Martial Arts attack, I instantly regain 1 expend Ki"]),
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (v.theWea.monkweapon && v.isMeleeWeapon && !v.CritChance) {
              fields.Description += (fields.Description ? '; ' : '') + 'Crit on 19-20';
              v.CritChance = 19;
            };
          },
          "My martial arts attacks score a critical hit on 19-20",
          19
        ]
      }
    },
    "subclassfeature10": {
      name: "Infamous Reputation",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc(["Creatures frightened of me have disadv. on their saves vs my Savage Exploits"]),

      "infamous reputation (ki)": {
        name: "Infamous Reputation",
        source: [["GMB:LL", 0]],
        extraname: "Way of the Brawler 10",
        description: desc(["As a bonus action, I can force a creature within 30 ft that can see/hear me to make a Wis save",
          "On a failed save, it is frightened of me until the start of my next turn"]),
        action: ["bonus action", ""],
        additional: "1 ki point"
      },
      autoSelectExtrachoices: [{
        extrachoice: "infamous reputation (ki)",
        minlevel: 10
      }]
    },
    "subclassfeature17": {
      name: "Master of Brutality",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc(["I have advan. on Martial Arts attack against creas Frightened of me",
        "When I crit with a Martial Arts attack, the target fails any save caused by an exploit or technique I would use as part of the attack"]),
    }
  }
});

// Way of Ferocity
AddSubClass("monk(laserllama)", "way of ferocity", {
  regExpSearch: /ferocity/i,
  subname: "Way of Ferocity",
  fullname: "Ferocity",
  source: [["GMB:LL", 0]],
  features: {
    "subclassfeature3": GetSubclassTechniques("Ferocity", ["crippling strike", "stunning strike", "friend of beast and leaf"]),
    "subclassfeature3.1": {
      name: "Natural Predator",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc("Select a discipline using \"Choose feature\". Once chosen, this cannot be changed."),
      choices: ["Bestial Rend", "Natural Defenses", "Savage Charge"],

      "bestial rend": {
        name: "Bestial Rend",
        source: [["GMB:LL", 0]],
        description: desc(["My unarmed strikes deal slashing damage and reduce the speed of my foes",
          "Each time you I hit a target with an unarmed strike, its movement speed is reduced by a cumulative 5 feet until the beginning of my next turn",
          "If this reduces a target's speed to 0, it has disadv. on Dex saves until the start of my next turn"]),
        calcChanges: {
          atkAdd: [
            function (fields, v) {
              if (v.baseWeaponName == "unarmed strike") {
                fields.Damage_Type = "Slashing";
                fields.Description += (fields.Description ? '; ' : '') + "Reduce foe's move speed by 5 ft on hit"
              };
            },
            "My unarmed strikes deal slashing damage and reduce the speed of my foes",
            20
          ]
        }
      },
      "natural defenses": {
        name: "Natural Defenses",
        source: [["GMB:LL", 0]],
        description: levels.map(function (n) {
          var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);

          return desc(["When a creature that I can see hits me with an attack, I can use my reaction to add 1d" + MartArtDie + " to my AC against the attack, possibly turning a hit into a miss"]);
        }),
        action: ["reaction", " (when hit)"]
      },
      "savage charge": {
        name: "Savage Charge",
        source: [["GMB:LL", 0]],
        description: desc(["If I move at least 15 ft in a straight line toward a creature, I have adv. on the first Martial Arts attack against that creature before the end of my current turn"])
      }

    },
    "subclassfeature6": {
      name: "Primal Intuition",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: levels.map(function (n) {
        var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);

        return desc(["I gain proficiency in two skills and add 1d" + MartArtDie + " to any skill check with those skills"]);
      }),
      extraname: "Primal Intuition proficiencies",
      extrachoices: ["Athletics", "Insight", "Intimidation", "Perception", "Stealth", "Survival"],
      extraTimes: levels.map(function (n) {
        if (n < 6) return 0;
        return 2;
      }),
      // NOTE: this levels.map function is just so the user sees how many Profs they can pick
      // If extraTimes = constant, then it never shows the "selected x of y"

      "athletics": {
        name: "Athletics",
        description: levels.map(function (n) {
          var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);

          return desc(["I gain proficiency in Athletics and add 1d" + MartArtDie + " to any skill check with this skill"]);
        }),
        skills: ["Athletics"]
      },
      "insight": {
        name: "Insight",
        description: levels.map(function (n) {
          var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);

          return desc(["I gain proficiency in Insight and add 1d" + MartArtDie + " to any skill check with this skill"]);
        }),
        skills: ["Insight"]
      },
      "intimidation": {
        name: "Intimidation",
        description: levels.map(function (n) {
          var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);

          return desc(["I gain proficiency in Intimidation and add 1d" + MartArtDie + " to any skill check with this skill"]);
        }),
        skills: ["Intimidation"]
      },
      "perception": {
        name: "Perception",
        description: levels.map(function (n) {
          var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);

          return desc(["I gain proficiency in Perception and add 1d" + MartArtDie + " to any skill check with this skill"]);
        }),
        skills: ["Perception"]
      },
      "stealth": {
        name: "Stealth",
        description: levels.map(function (n) {
          var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);

          return desc(["I gain proficiency in Stealth and add 1d" + MartArtDie + " to any skill check with this skill"]);
        }),
        skills: ["Stealth"]
      },
      "survival": {
        name: "Survival",
        description: levels.map(function (n) {
          var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);

          return desc(["I gain proficiency in Survival and add 1d" + MartArtDie + " to any skill check with this skill"]);
        }),
        skills: ["Survival"]
      },

    },
    "subclassfeature10": {
      name: "Ruthless Savagery",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "I can use the crippling strike Technique without expending Ki a number of times equal to my Wis mod (a min of once), and regain all uses when I finish a long rest" +
        "\n    If I have already hit the target of my crippling strike with an unarmed strike since the end of your last turn, it has disadvantage on its Constitution saving throw"
      ]),
      usages: "Wis mod per ",
      usagescalc: "event.value = Math.max(1, What('Wis Mod'));",
      recovery: "long rest",
      action: ["action", ""]
    },
    "subclassfeature17": {
      name: "Master of Ferocity",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc("Select a discipline using \"Choose feature\". Once chosen, this cannot be changed."),
      choices: ["Bestial Fury", "Mystical Resilience", "Deadly Stampede"],

      "bestial fury": {
        name: "Bestial Fury",
        source: [["GMB:LL", 0]],
        description: desc(["When I score a crit against a creature with an unarmed strike, its move speed is reduced to zero, and I have adv. on any unarmed strikes that I make against that creature until the beginning of my next turn"])
      },
      "mystical resilience": {
        name: "Mystical Resilience",
        source: [["GMB:LL", 0]],
        description: desc("When a creature that I can see hits me with an attack, I reduce the damage by my Wis mod (min of 1), so long as I am not Incapacitated"),
      },
      "deadly stampede": {
        name: "Deadly Stampede",
        source: [["GMB:LL", 0]],
        description: desc(["As an action, I can move up to my speed in a line, forcing any creatures I pass through to make a Dexterity saving throw against my Technique save DC. On a failure, targets take bludgeoning damage equal to four Martial Arts Dice and fall Prone. On a success, targets take half damage and do not fall Prone."]),
        action: ["action", ""]
      },
    }
  }
});

// Way of the Flowing River
AddSubClass("monk(laserllama)", "way of the flowing river", {
  regExpSearch: /flowing river/i,
  subname: "Way of the Flowing River",
  fullname: "Flowing River",
  source: [["GMB:LL", 0]],
  features: {
    "subclassfeature3": GetSubclassTechniques("Flowing", ["deflect strike", "deflect missile", "heavenly step"]),
    "subclassfeature3.1": {
      name: "Monastic Acrobat",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map(function (n) {
        var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);
        return desc(["I am proficient in Acrobatics and Performance, I add 1d" + MartArtDie + " to any skill checks with those skills",
          "I can make Dexterity (Performance) checks instead of Charisma (Performance) whenever I make a Performance check that includes movement"]);
      }),
      skills: ["Acrobatics", "Performance"],
      addMod: { type: "skill", field: "Performance", mod: "max(Dex-Cha|0)", text: "I can replace Charisma (Performance) checks with Dexterity (Performance)" }
    },
    "subclassfeature3.2": {
      name: "Flowing River Stance",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map(function (n) {
        var aura = (n < 6 ? 10 : n < 10 ? 15 : n < 14 ? 20 : n < 18 ? 25 : 30) + " ft";
        var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);

        if (n < 6) {
          return desc([
            "As a bonus action, I can enter a Flowing River Stance, which lasts until the start of my next turn",
            "While in this stance, creatures of my choice within " + aura + " of me have disadv. against targets other than me"
          ]);
        }

        if (n < 10) {
          return desc([
            "As a bonus action, I can enter a Flowing River Stance, which lasts until the start of my next turn",
            "While in this stance, creatures of my choice within " + aura + " of me have disadv. against targets other than me",
            "I can use deflect strike and deflect missile without spending Ki"
          ]);
        }

        if (n < 17) {
          return desc([
            "As a bonus action, I can enter a Flowing River Stance, which lasts until the start of my next turn",
            "While in this stance, creatures of my choice within " + aura + " of me have disadv. against targets other than me",
            "I can use deflect strike and deflect missile without spending Ki",
            "I have a special reaction on each creature's turn, but I can only use for River's Reprisal, deflect strike, or deflect missile"
          ]);
        }

        return desc([
          "As a bonus action, I can enter a Flowing River Stance, which lasts until the start of my next turn",
          "While in this stance, creatures of my choice within " + aura + " of me have disadv. against targets other than me",
          "I can use deflect strike and deflect missile without spending Ki",
          "I have a special reaction on each creature's turn, but I can only use for River's Reprisal, deflect strike, or deflect missile",
          "I can spend additional Ki (up to my WIs mod) on deflect strike and deflect missile to reduce the damage by an additional 1d" + MartArtDie + " per Ki point spent"
        ]);
      }),
      action: [["bonus action", ""]],
    },
    "subclassfeature6": {
      name: "River's Reprisal",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "My Flowing River Stance is improved (see it)",
        "When a creature that I can see misses me with a melee attack while in my Flowing River Stance, I can use a reaction to force it to make a Dex save",
        "On a fail, the target is prone and its move speed is reduced to 0 until the start of my next turn",
      ]),
      action: [["reaction", " (when missed in melee)"]]
    },
    "subclassfeature10": {
      name: "Grace of the Great Waters",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "My Flowing River Stance is improved (see it)",
        "If a creature casts a spell that deals damage or forces a saving throw while it is under the effect of my Flowing River Stance, I must be one of the targets of that spell.",
      ]),
    },
    "subclassfeature17": {
      name: "Master of the Flowing River",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "My Flowing River Stance is improved (see it)",
        "When a creature fails its saving throw against my River's Reprisal, I can also knock it back in a straight line a number of feet, then it falls Prone.",
        "The distance is dependent on size: Tiny (60 feet), Small (40 feet), Medium (30 feet), Large (20 feet), Huge (15 feet), Gargantuan (10 feet),"
      ]),
    }
  }
});

// Way of the Hurricane
AddSubClass("monk(laserllama)", "way of the hurricane", {
  regExpSearch: /hurricane/i,
  subname: "Way of the Hurricane",
  fullname: "Hurricane",
  source: [["GMB:LL", 0]],
  features: {
    // Override martial arts because of the lvl 3 subclass feature
    "martial arts": function () {
      var martart = newObj(ClassList["monk(laserllama)"].features["martial arts"]);

      martart.description = levels.map(function (n) {
        if (n < 3) {
          return desc([
            "Monk weapons: any melee weapon (not special/heavy) or unarmed strike",
            "With monk weapons, I can use Dex instead of Str and use the Martial Arts damage die",
            "When taking an Attack action with these, I get one unarmed strike as a bonus action",
            "I can replace Strength (Athletics) checks to grapple/shove with Dexterity (Athletics) checks"
          ]);
        }

        return desc([
          "Monk weapons: any melee weapon (not special) or unarmed strike",
          "With monk weapons, I can use Dex instead of Str and use the Martial Arts damage die",
          "When taking an Attack action with these, I get one unarmed strike as a bonus action",
          "I can replace Strength (Athletics) checks to grapple/shove with Dexterity (Athletics) checks"
        ]);
      });

      return martart;
    }(),

    "subclassfeature3": GetSubclassTechniques("Hurricane", ["typhoon strike", "crushing strike", "tremor strike"]),
    "subclassfeature3.1": {
      name: "Heavy Warrior",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc(["I gain proficiency with all melee heavy weapons and they count as Martial Arts attacks",
        "When wielding a melee heavy weapon, I have adv. on saves to resist being grappled or moved against my will"]),
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (classes.known["monk(laserllama)"] && classes.known["monk(laserllama)"].level && v.isMeleeWeapon && (/simple|martial/i).test(v.theWea.type) && (/heavy/i).test(fields.Description)) {
              v.theWea.monkweapon = true;
              fields.Proficiency = true;
            };
          },
          "I am proficient with melee heavy weapons, and those count as monk weapons for me",
          1
        ]
      },
      savetxt: {
        text: ["With melee heavy weapon, adv. on saves vs moved against my will or grappled"]
      },
    },
    "subclassfeature3.2": {
      name: "Tempestuous Strike",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description:
        levels.map(function (n) {
          var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);
          return desc(["When wielding a melee heavy weapon I can use Typhoon Strike without expending Ki",
            "When I do so, I can make a single attack with the end of my Heavy weapon as a bonus action. On hit it, deals 1d" + MartArtDie + " damage"]);
        })
    },
    "subclassfeature6": {
      name: "Crushing Counter",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "When wielding a melee heavy weapon and a crea I see hits me with a melee weapon attack, I can use my reaction to make a Martial Arts attack against it",
        "On hit, I can also reduce the creature's speed to 0 until the start of my next turn"
      ]),
      action: ["reaction", " (when hit)"],
    },
    "subclassfeature10": {
      name: "Buffeting Winds",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: levels.map(function (n) {
        var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);
        return desc([
          "When I hit a crea with a Heavy melee weapon or damage it with Typhoon Strike, I can spend 1 Ki (per target) to force it to make a STR save or be knocked back in a line a number of feet equal to 5 times my Wis mod (min of 5 ft)",
          "When I use typhoon strike, I can spend Ki up to my Wis mod to deal 1d" + MartArtDie + " of bonus thunder dmg to on failed save to each Ki point spent",
          "If I do so, they take half damage on a success against the typhoon strike instead of no damage"])
      }),
    },
    "subclassfeature17": {
      name: "Master of the Hurricane",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc([
        "As an action, I can disappear and instantly make a single melee weapon attack against up to five creatures I can see within 60 feet",
        "I then appear next to one of my targets; I must be wielding a melee heavy weapon to use this",
        "I can do this once per short rest or spend 5 ki to do it again"]),
      action: ["action", ""],
      recovery: "short rest",
      usages: 1,
    }
  }
});

// Way of the Mystic
AddSubClass("monk(laserllama)", "way of the mystic", {
  regExpSearch: /way of the mystic/i,
  subname: "Way of the Mystic",
  fullname: "Way of the Mystic",
  source: [["GMB:LL", 0]],
  spellcastingAbility: 5,
  features: {
    // Override unarmoured defense because of Ascended Warrior
    "unarmored defense": {
      name: "Unarmored Defense",
      source: ["GMB:LL"],
      minlevel: 1,
      description: levels.map(function (n) {
        if (n < 3) return desc("Without armor and no shield, my AC is 10 + Dexterity modifier + Wisdom modifier");

        return desc("Without armor and no shield, my AC is 13 + Wisdom modifier");
      }),
      armorOptions: [{
        regExpSearch: /justToAddToDropDown/,
        name: "Unarmored Defense (Wis)",
        source: ["GMB:LL"],
        ac: "10+Wis",
        affectsWildShape: true
      }],
      armorAdd: "Unarmored Defense (Wis)"
    },
    "subclassfeature3": GetSubclassTechniques("Hurricane", ["spiritual armor", "impairing strike", "commune with self"]),
    "subclassfeature3.1": (function () {
      const MysticTalentsWoM = {
        name: "Mystic Talents",
        source: [["GMB:LL", 0]],
        minlevel: 3,
        description: desc(["I learn talents from the Psion class, using my monk level for prerequesites and can replace them when I gain a monk level (use \"Choose Feature\")",]),
        extrachoices: [],
        extraTimes: levels.map((n) => {
          return n < 3 ? "" : n < 6 ? 2 : n < 10 ? 3 : n < 17 ? 4 : 5;
        }),
        additional: [
          "",
          "",
          "2 Talents Known",
          "2 Talents Known",
          "2 Talents Known",
          "3 Talents Known",
          "3 Talents Known",
          "3 Talents Known",
          "3 Talents Known",
          "4 Talents Known",
          "4 Talents Known",
          "4 Talents Known",
          "4 Talents Known",
          "4 Talents Known",
          "4 Talents Known",
          "4 Talents Known",
          "5 Talents Known",
          "5 Talents Known",
          "5 Talents Known",
          "5 Talents Known",
        ],
        extraname: "Mystic Talents"
      };
      var MysticKeys = Object.keys(MysticTalentsLL);
      for (var m = 0; m < MysticKeys.length; m++) {
        MysticTalentsWoM.extrachoices.push(MysticTalentsLL[MysticKeys[m]].name);
        var NewTalentWoM = MysticTalentsLL[MysticKeys[m]];
        const tlvl = NewTalentWoM.talentLevel ? NewTalentWoM.talentLevel : 3;
        var ntwom = {
          name: NewTalentWoM.name,
          description: NewTalentWoM.description,
          source: NewTalentWoM.source,
          addMod: NewTalentWoM.addMod,
          speed: NewTalentWoM.speed,
          toolProfs: NewTalentWoM.toolProfs,
          action: NewTalentWoM.action,
          usages: NewTalentWoM.usages,
          recovery: NewTalentWoM.recovery,
          savetxt: NewTalentWoM.savetxt,
          dmgres: NewTalentWoM.dmgres,
          armorProfs: NewTalentWoM.armorProfs,
          submenu: NewTalentWoM.submenu,
          extraname: NewTalentWoM.extraname,
          extraTimes: NewTalentWoM.extraTimes,
          choices: NewTalentWoM.choices,
          vision: NewTalentWoM.vision,
          prereqeval: MysticTalentsPrereqFactory(MysticKeys[m], "monk(laserllama)", 3),
          submenu: "Way of the Mystic lvl " + tlvl + "+"
        }

        MysticTalentsWoM[MysticKeys[m]] = ntwom;
      }

      return MysticTalentsWoM;
    })(),
    "subclassfeature3.2": {
      name: "Ascended Warrior",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc(["I can use my Wisdom instead of Dexterity for Martial Arts attack rolls (but not damage)"]),
      calcChanges: {
        atkAdd: [
          function (fields, v) {
            if (classes.known["monk(laserllama)"] && classes.known["monk(laserllama)"].level && v.theWea.monkweapon && What(AbilityScores.abbreviations[fields.Mod - 1] + " Mod") < What("Wis Mod")) {
              fields.To_Hit_Bonus = What("Wis Mod") - What(AbilityScores.abbreviations[fields.Mod - 1] + " Mod");
            };
          },
          "I can use my Wisdom instead of Dexterity for Martial Arts attack rolls (but not damage)",
          6
        ]
      },
      extraAC: [{
        name: "Ascended Warrior",
        mod: "max(3-Dex|0)",
        text: "Without armor and no shield, my AC is 13 + Wisdom modifier",
        stopeval: function (v) {
          return (v.wearingArmor || v.usingShield) // unarmoured only
        }
      }],
    },
    "subclassfeature6": {
      name: "Spiritual Assault",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: levels.map(function (n) {
        var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);
        return desc([
          "One creature I can see within 15 ft makes a Cha save or takes 1d" + MartArtDie + " psychic dmg and has disadv. on its first Int, Wis or Cha save before my next turn",
          "If no usages left, I can use it by spending 1 Ki point"])
      }),
      usages: "Wis mod per",
      usagescalc: "event.value = Math.max(1, What('Wis Mod'));",
      recovery: "long rest",
      action: ["bonus action", ""]
    },
    "subclassfeature10": {
      name: "Warded Soul",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc("When I take necrotic, psychic, or radiant damage I can spend 1 Ki to gain resistance to that instance of damage")
    },
    "subclassfeature17": {
      name: "Master Mystic",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc([
        "When I deal psychic damage to a creature I can add my Wis mod (min 1) to the damage roll if I do not do so already",
        "At the end of each long rest, with 1H of meditation, I can replace on Mystic Talent I know with another Talent"])
    }
  }
});

// Way of the Sacred Inks
AddSubClass("monk(laserllama)", "way of the sacred inks", {
  regExpSearch: /sacred inks/i,
  subname: "Way of the Sacred Inks",
  fullname: "Sacred Inks",
  source: [["GMB:LL", 0]],
  features: {
    "subclassfeature3": GetSubclassTechniques("Sacred Ink", ["divine light", "impairing strike", "commune with self"]),
    "subclassfeature3.1": {
      name: "Celestial Artist",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc(["I gain expertise in Calligrapher's supplies and learn Celestial"]),
      languageProfs: ["Celestial"],
      toolProfs: ["Calligrapher's Supplies"]
    },
    "subclassfeature3.2": {
      name: "Divine Conduit",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map(function (n) {
        var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);

        return desc([
          "When I spend Hit Die, I can expend 1 Ki to regain the max roll",
          "I can deal radiant damage with my unarmed strike, and I can expend 1 ki to deal 1d" + MartArtDie + " additional radiant damage",
          "As an action I can touch a creature and expend 1 Ki to heal them for 1d" + MartArtDie + " + my Wis mod"])
      }),
      action: ["action", " (heal)"],
    },
    "subclassfeature6": {
      name: "Heavenly Protection",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "When reduced to 0 HP, I can choose to fall to 1 HP instead",
        "I can expend 5 Ki as an action to regain the use early"]),
      usages: 1,
      additional: "5 Ki to regain the use",
      recovery: "long rest",
      action: [["action", " (regain use)"]]
    },
    "subclassfeature10": {
      name: "Searing Light",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "As a bonus action, I can reveal my tatoos, which emit bright sunlight in a 10 ft radius for 1 min",
        "While revealed, when I expend Ki to deal damage with Divine Conduit, the target mus also make a CON save or be Blinded until the start of my next turn",
        "This ends early if I am incapacitated or if I use a bonus action to end it"]),
      action: ["bonus action", " (start/end)"],
      recovery: "short rest",
      usages: 1,
    },
    "subclassfeature17": {
      name: "Master of the Sacred Inks",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc([
        "As a bonus action, I take on an angelic form for 1 minute granting me:",
        "\u2022 a flying speed equal to my walking speed and I can hover",
        "\u2022 my unarmed strike can deal radiant damage instead of bludgeoning",
        "\u2022 I gain the benefits of Searing Light and its sunlight radius grows to match my Unarmored Movement bonus",
        "If I have no uses left, I can spend 5 ki to use this feature again"]),
      action: ["action", ""],
      recovery: "long rest",
      usages: 1,
    }
  }
});

// Way of the Vigilante
AddSubClass("monk(laserllama)", "way of the vigilante", {
  regExpSearch: /vigilante/i,
  subname: "Way of the Vigilante",
  fullname: "Vigilante",
  source: [["GMB:LL", 0]],
  features: {
    "subclassfeature3": GetSubclassTechniques("Vigilante", ["slow fall", "crushing strike", "indomitable spirit"]),
    "subclassfeature3.1": {
      name: "Combat Ready",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I gain proficiency in light armor, medium armor and shields",
        "When wearing armor/shield I still gain the benefits of Martial Arts and Unarmored Movement"]),
      armorProfs: [true, true, false, true], // light, medium and shield

      removeeval: function () {
        AddString('Extra.Notes', 'Monk features:\n\u25C6 If I wear armor/shield, I lose Unarmored Defense, Martial Arts, and Unarmored Movement');
        show3rdPageNotes();
      },
      eval: function () {
        RemoveString('Extra.Notes', 'Monk features:\n\u25C6 If I wear armor/shield, I lose Unarmored Defense, Martial Arts, and Unarmored Movement');
      },
    },
    "subclassfeature3.2": {
      name: "Heroic Persona",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map(function (n) {
        var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);
        return desc([
          "As a bonus action, so long as I can't be seen, I can don my Heroic Persona:",
          "\u2022 This also makes me don/doff an armor and a shield if my persona has it",
          "\u2022 I get " + n + " temp HP when and with a bonus action, expending 1 Ki, I gain temp HP equal to my Wis mod (min of 1)",
          "\u2022 On hit with Martial Arts attack, I can spend 1 Ki to add 1d" + MartArtDie + " to the damage",
          "\u2022 I can use Wisdom, instead of Dexterity, when calculating my AC in light/medium armor",
          "\u2022 Ability checks and divination spells that would discern my true identity automatically fail",
          "The Heroic Persona last until I doff it as a bonus action or I become Unconscious",
          "I gain the HP from transforming only once per long rest or by spending 3 ki to gain them again when transforming"])
      }),
      // NOTE: AC calculation not included as it depends on whether heroic persona is enabled or not
      action: ["bonus action", " (don/doff)"],
      recovery: "short rest",
      usages: 1
    },
    "subclassfeature3.3": {
      name: "Additional proficiency",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map(function (n) {
        var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);

        return desc("I gain an additional proficiency (Intimidation or Performance) and add 1d" + MartArtDie + " to any checks using that proficiency")
      }),
      choices: ["Intimidation", "Performance"],
      "intimidation": {
        name: "Additional proficiency",
        description: levels.map(function (n) {
          var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);

          return desc("I am proficient in Intimidation and add 1d" + MartArtDie + " to any checks using that proficiency")
        }),
        skills: ["Intimidation"]
      },
      "performance": {
        name: "Additional proficiency",
        description: levels.map(function (n) {
          var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);

          return desc("I am proficient in Performance and add 1d" + MartArtDie + " to any checks using that proficiency")
        }),
        skills: ["Performance"]
      },
    },
    "subclassfeature6": {
      name: "Valiant Action",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "I gain proficiency in either Acrobatics or Athletics (Choose Feature)",
        "While my Persona is active, I can use indomitable spirit once per turn without spending Ki"]),
      choices: ["Acrobatics", "Athletics"],
      "acrobatics": {
        name: "Valiant Action",
        description: desc([
          "I gain proficiency in Acrobatics",
          "While my Persona is active, I can use indomitable spirit once per turn without spending Ki"]),
        skills: ["Acrobatics"]
      },
      "athletics": {
        name: "Valiant Action",
        description: desc([
          "I gain proficiency in Athletics",
          "While my Persona is active, I can use indomitable spirit once per turn without spending Ki"]),
        skills: ["Athletics"]
      },
    },
    "subclassfeature10": {
      name: "Inspiring Presence",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: levels.map(function (n) {
        var AuraSize = (n < 14 ? 20 : n < 18 ? 25 : 30) + " ft";

        return desc(["While my Heroic Persona is active, me and creatures of my choice within " + AuraSize + " ft have adv. on saves vs charmed or frightened"])
      }),
    },
    "subclassfeature17": {
      name: "Master Vigilante",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc([
        "I am immune to be charmed or frightened",
        "When I hit a creature equal to my size or smaller with an unarmed strike, it is knocked back 10 feet in a line"
      ]),
      savetxt: { immune: ["charmed", "frightened"] }
    }
  }
});

// Variant Rule: Heroic Personality
// A Vigilante Monk is meant to evoke the archetypal superhero. 
// For the mechanics to match the heroic fantasy, talk to your DM about using your Charisma, in place of Wisdom, for your Monk class features.
// Want this feature? Shoot me a dm!

// Way of the Void
AddSubClass("monk(laserllama)", "way of the void", {
  regExpSearch: /void/i,
  subname: "Way of the Void",
  fullname: "Void",
  source: [["GMB:LL", 0]],
  features: {

    "subclassfeature3": GetSubclassTechniques("Void", ["step of the wind", "impairing strike", "aura sight"]),
    "subclassfeature3.1": {
      name: "Entropic Touch",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: levels.map(function (n) {
        if (n < 6) {
          return desc(["As an action, I can spend 2 ki points and touch a Small or smaller non-magical object to instantly reduce it to a pile of dust"])
        }
        if (n < 10) {
          return desc([
            "As an action, I can spend ki points and touch a non-magical object of a size or smaller to instantly reduce it to a pile of dust, depending on the Ki expend",
            "Small (2 ki), Medium (4 ki)"
          ])
        }
        if (n < 17) {
          return desc([
            "As an action, I can spend ki points and touch a non-magical object of a size or smaller to instantly reduce it to a pile of dust, depending on the Ki expend",
            "Small (2 ki), Medium (4 ki), Large (6 ki)"
          ])
        }
        if (n < 20) {
          return desc([
            "As an action, I can spend ki points and touch a non-magical object of a size or smaller to instantly reduce it to a pile of dust, depending on the Ki expend",
            "Small (2 ki), Medium (4 ki), Large (6 ki), Huge (8 ki)"
          ])
        }
        return desc([
          "As an action, I can spend ki points and touch a non-magical object of a size or smaller to instantly reduce it to a pile of dust, depending on the Ki expend",
          "Small (2 ki), Medium (4 ki), Large (6 ki), Huge (8 ki), Gargantuan (12 ki)"
        ])
      }),
      action: ["action", ""],

      "void strike": {
        name: "Void Strike",
        extraname: "Way of the Void 3",
        source: [["GMB:LL", 0]],
        description: levels.map(function (n) {
          var MartArtDie = (n < 5 ? 6 : n < 11 ? 8 : n < 17 ? 10 : 12);
          return desc([
            "When hitting a creature with an unarmed strike, deal 1d" + MartArtDie + " additional force damage and cannot regain HP or gain temp HP until the start of my next turn",
            "If the creature is concentrating, it has disadv. on the saving throw to mantain concentration"
          ]);
        }),
        additional: "1 ki point"
      },
      autoSelectExtrachoices: [{
        extrachoice: "void strike",
        minlevel: 3
      }]
    },
    "subclassfeature6": {
      name: "Vorpal Step",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "When I use Step of the Wind, until the end of my current turn, I can move through solid nonmag objects and crea as if they were difficult terrain",
        "If I end my movement inside an object or creature, I am instantly shunted to the nearest unoccupied space, taking 1d10 force damage for every 5 feet I am forced to move"])
    },
    "subclassfeature10": {
      name: "Unmake Magic",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc("I can spend 3 ki to cast counterspell or dispel magic using Wisdom as my spellcasting ability"),
      spellFirstColTitle: "Ki",
      spellcastingBonus: {
        name: "Unmake Magic",
        spells: ["counterspell", "dispel magic"],
        selection: ["counterspell", "dispel magic"],
        firstCol: "3",
        times: 2
      }
    },
    "subclassfeature17": {
      name: "Master of Entropy",
      source: [["GMB:LL", 0]],
      minlevel: 17,
      description: desc([
        "Once per turn, I can forgo one unarmed strike to touch a creature who must make a Con save",
        "On a failed save, it suffers the effects of the disintegrate spell cast at 6th-level",
        "If I have no uses left, I can spend 6 Ki to use it again"]),
      recovery: "long rest",
      usages: 1,
      spellFirstColTitle: "Ki",
      spellcastingBonus: {
        name: "Master of Entropy",
        spells: ["disintegrate"],
        selection: ["disintegrate"],
        firstCol: "oncelr",
        times: 1
      }
    }
  }
});

// Subclassess Warlord
// Academy of Chivalry
ClassSubList["warlord(laserllama)-chivalry"] = {
  regExpSearch: /^(?=.*academy)(?=.*chivalry).*$/i,
  subname: "Chivalry",
  fullname: "Academy of Chivalry",
  source: [["GMB:LL", 0]],
  abilitySave: 4,
  features: {
    subclassfeature3: GetWarlordSubclassExploits("Chivalry", [
      "attack order",
      "commanding presence",
      "hold the line",
      "rejuvenating order",
      "daring rescue",
    ]),
    "subclassfeature3.1": {
      name: "Inspiring Shout",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "When I roll initiative I can expend one use my Inspiring Word",
        " I choose up to my Lead mod creatures within 30 feet that can hear me and give them temp HP equal to my Expl Die + my Lead mod"
      ]),
    },
    "subclassfeature3.2": {
      name: "Knighthood",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "When I roll initiative I can expend one use my Inspiring Word",
        " I choose up to my Lead mod creatures within 30 feet that can hear me and give them temp HP equal to my Expl Die + my Lead mod"
      ]),
    },
    subclassfeature6: {
      name: "Lead the Charge",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description:
        "\n   " +
        "When I use my action on my turn and make at least one melee attack, I can issue an Attack Order as a bonus action on that turn",
      spellChanges: {
        "attack order": {
          changes:
            "When I use my action on my turn and make at least one melee attack, I can issue this Exploit as a bonus action on that turn",
        },
      },
    },
    subclassfeature14: {
      name: "Flames of Hope",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      description:
        "\n   " +
        "With an action, Creature within 30 feet that can hear me gain the corresponding effect:" +
        "\n   " +
        "Frendly creatures gain temp HP equal to my Expl Die + Lead mod and cannot be Charmed or Frightened while these temp HP lasts " +
        "\n   " +
        "Hostile creatures make a Wis save against my Expl DC or be Firghtened by me. They repeat the save each their end turn and when they takes damage",
    },
    subclassfeature18: {
      name: "Paragon of Chivalry",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc(
        "I am immune to Charmed and Frightened conditions and creatures of my choice within 30 feet that can see me have advan. on saves against these conditions"
      ),
      savetxt: { immune: ["charmed", "frightened"] }
    },
  }
};

// Claws
AddSubClass("warlord(laserllama)", "claws", {
  regExpSearch: /^(?=.*academy)(?=.*claws).*$/i,
  subname: "Claws",
  fullname: "Academy of Claws",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: GetWarlordSubclassExploits("Claw", [
      "attack order",
      "commanding presence",
      "intimidating command",
      "wild charge",
      "survey wilderness",
    ]),
    "subclassfeature3.1": {
      name: "Monstrous Minion",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: "I can make a creature my Monstrous Minion(see note page)",
      // Putting Beast Transformation on the third page because it's a wall of text; the subclass is already overflowing
      "monstrous.minion": {
        name: "Beast Form",
        source: [["GMB:LL", 0]],
        minlevel: 3,
        description: levels.map((n) => {
          var minionTypes = n < 14 ? "Beast or Monstrosity" : "Beast, Aberrations, Dragons, Giants, Oozes, Plants, or Undead";
          var crMinion = n == 1 ? "1/3" : n == 2 ? "1/2" : Math.floor((n / 3));
          var duration = n < 14 ?
            "It returns to its wild state sooner if it can't see or hear me for 1 hour, or if I attempt to dominate another creature and turn it into my Minion."
            :
            "It returns to its wild state sooner if I give it a reason to become hostile toward me or if I attempt to dominate another creature and turn it into my Minion";
          return desc([
            "As an action, I force a creature within 10 feet that can hear me to make a Charisma Saving Throw against my Exploit DC. If it is fiendly to me, it automatically fails. On a failure, it is my Monstrous Minion.",
            "For have a Monstrous Minions I must use these rules:",
            " \u2022 I can use this feature on a " + minionTypes + " of CR " + crMinion,
            " \u2022 My minion obeys me with total loyalty. It uses its normal stat block and it gains the benefits of short and long rests",
            " \u2022 In combat, it acts during my turn. It can move and use its reaction on its own, and it takes only the Dodge action",
            " \u2022 As a bonus action I can order it to take one action from its stat block or another action",
            " \u2022 If I'm incapacitated, my Minion reverts to its wild state, normally fleeing to return home",
            " \u2022 I can target it with Exploits and it can understand me even if it can't speak",
            " \u2022 A creature remains my Minion until it is slain. " + duration,
          ]);
        }),
        action: [["action", ""]],
      },
      autoSelectExtrachoices: [{ extrachoice: "monstrous.minion" }],
    },
    subclassfeature6: {
      name: "Iron Command",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: levels.map((n) => {
        var range = n < 18 ? "15" : "30";
        return desc([
          "Whenever my Minion makes an attack roll, check or save within " + range + " feet of me, I can use my reaction to add my Lead mod to the result of its roll"
        ]);
      }),
      action: [["reaction", ""]],
    },
    subclassfeature14: {
      name: "Monstrous Menagerie",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      description: desc([
        "Monstrous Minion is improved (see note page)",
      ]),
    },
    subclassfeature18: {
      name: "Total Domination",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc([
        "Iron Command is improved (see Iron Command)",
        "While within 30 feet, my Minion is resistant to bludg., pierc., and slash. damage"
      ]),
    },
  },
});

// Counsel
AddSubClass("warlord(laserllama)", "counsel", {
  regExpSearch: /^(?=.*academy)(?=.*counsel).*$/i,
  subname: "Counsel",
  fullname: "Academy of Counsel",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: GetWarlordSubclassExploits("Counselor", [
      "scholarly recall",
      "support order",
      "insightful order",
      "soothing speech",
      "forgotten knowledge",
    ]),
    "subclassfeature3.1": {
      name: "Conselor's Protege",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I have adopted a Protege as my studet and they follows my commands and teachings",
        'Select a "Protege" on the companion page for its stats and rules',
        "It is of Small or Medium in size (your choice)",
        "It only takes the Dodge action unless I use a bonus action to command it.",
        "If reduced to 0 HP, it makes death saves. I can use an action and expend an Exploit Die to stabilize it.",
        "If it dies, I can spend 8 hours recruiting a new one.",
      ]),
      action: [["bonus action", " (command)"]],
      creaturesAdd: [["Protege", true]],
      creatureOptions: [
        {
          name: "Protege",
          source: ["GMB:LL", 0],
          size: [2, 3],
          type: "Humanoid",
          alignment: "Your Alignment",
          ac: "16",
          hp: 20,
          hd: [levels.map((n) => n), 8],
          hdLinked: ["warlord(laserllama)"],
          minlevelLinked: ["warlord(laserllama)"],
          speed: "30 ft",
          scores: [12, 16, 14, 13, 8, 10],
          saves: ["", "", "", "", "", ""],
          senses: "Based on race",
          passivePerception: 12,
          languages: "Common and one additional",
          challengeRating: "0",
          proficiencyBonus: 2,
          proficiencyBonusLinked: true,
          attacksAction: () => {
            var warLevel = classes.known["warlord(laserllama)"].level;
            return warLevel < 14 ? 1 : 2;
          },
          skills: {
            Athletics: "Prof",
            History: "Prof",
          },
          attacks: [
            {
              name: "Dagger",
              ability: 2,
              damage: [1, 4, "piercing"],
              modifiers: ["", "Prof"],
              range: "Melee (5 ft)",
              abilitytodamage: true,
            },
            {
              name: "Shortbow",
              ability: 2,
              damage: [1, 6, "piercing"],
              modifiers: ["", "Prof"],
              range: "80/320",
              abilitytodamage: true,
            },
          ],
          features: [
            {
              name: "Weapons & Armor",
              description:
                "The Protege is proficient in light and medium armor, shields, and simple weapons. They are equipped with leather armor, a shield, a shortbow and a dagger, but you can give them other equipment",
            },
            {
              name: "Other Features",
              description:
                "You can talk with your DM about give your Protege race, background or other similar features",
            },
            {
              name: "Invigorating Orders",
              minlevel: 6,
              description:
                "When you target your Protege with an Exploit, they have advantage on their next ability check, attack roll, or saving throw.\n It also gain proficiency in Wis saves, heavy armor and martial weapons",
            },
            {
              name: "Legendary Tadem",
              minlevel: 18,
              description:
                "While you and your Protege are within 30 feet of each other, you both have advantage on your saving throws, and neither of you can have disadvantage on attack rolls.",
            },
          ],
          traits: [
            {
              name: "Hit Dice",
              minlevel: 3,
              description:
                "The Protege has a number of d8 Hit Dice equal to your Warlord level. They also gain the normal benefits of both short and long rests.",
            },
            {
              name: "Heroic Determination",
              minlevel: 14,
              description: () => {
                var warLevel = classes.known["warlord(laserllama)"].level;
                warLevel < 18 ?
                  "Once per long rest, when your Protege misses an attack roll, or fails an ability check orsaving throw, they can choose to replace their d20 roll with your Warlord level, possibly making it a success."
                  : warLevel < 20 ?
                    "Once per short/long rest, when your Protege misses an attack roll, or fails an ability check orsaving throw, they can choose to replace their d20 roll with your Warlord level, possibly making it a success." :
                    "Once per short/long rest, when your Protege misses an attack roll, or fails an ability check orsaving throw, they can choose to replace their d20 roll with your Warlord level, possibly making it a success." +
                    "\n Replacing an attack roll with this trait, makes it an automatic critical hit";
              },
            },
            {
              name: "Extra Attack",
              minlevel: 14,
              description:
                "When you command your Protege to make a weapon attack, they make two attacks instead of one.",
            },
            {
              name: "Exalted Protege",
              minlevel: 14,
              description:
                "My Protege became an Exalted Protege, changing Its stats block.\n Also, once per long rest, you can use the Heroir Order Exploit targeting your Protege without counting against the once per rest use of the Exploit.",
              addMod: [
                {
                  type: "",
                  field: "Comp.Use.Ability.Str.Score",
                  mod: 6,
                  text: "At level 14, the Protege's Strength increases by 6.",
                },
                {
                  type: "",
                  field: "Comp.Use.Ability.Con.Score",
                  mod: 2,
                  text: "At level 14, the Protege's Constitution increases by 2.",
                },
                {
                  type: "",
                  field: "Comp.Use.Ability.Int.Score",
                  mod: 2,
                  text: "At level 14, the Protege's Intelligence increases by 2.",
                },
                {
                  type: "",
                  field: "Comp.Use.Ability.Wis.Score",
                  mod: 3,
                  text: "At level 14, the Protege's Wisdom increases by 3.",
                },
                {
                  type: "",
                  field: "Comp.Use.Ability.Cha.Score",
                  mod: 2,
                  text: "At level 14, the Protege's Charisma increases by 2.",
                },
              ],
              eval: function (prefix, lvl) {
                var sMoveStr = "60 ft, swim 40 ft";
                if (What("Unit System") === "metric")
                  sMoveStr = ConvertToMetric(sMoveStr, 0.5);

                tDoc.getField(prefix + "Comp.Use.Speed").value = sMoveStr;
              },
              removeeval: function (prefix, lvl) {
                var sMoveStr = "40 ft, swim 20 ft";
                if (What("Unit System") === "metric")
                  sMoveStr = ConvertToMetric(sMoveStr, 0.5);

                tDoc.getField(prefix + "Comp.Use.Speed").value = sMoveStr;
              },
            },
          ],
          notes: [
            {
              name: "The companion obeys the commands of its leader",
              description: "and shares its proficiency bonus.",
              joinString: " ",
            },
            {
              name: "It takes its turn during that of its leader,",
              description: "on the same initiative count.",
              joinString: " ",
            },
            {
              name: "It can move and take reactions on its own,",
              description:
                "but only takes the Dodge action on its turn unless its leader takes a bonus action to command it to take another action.",
              joinString: " ",
            },
            {
              name: "If its leader is incapacitated,",
              description: "the companion can take any action, not just Dodge.",
              joinString: " ",
            },
            {
              name: "If the companion is reduced to 0 hit points,",
              description:
                "it makes death saving throws like a player character would.",
              joinString: " ",
            },
          ],
          calcChanges: {
            hp: function (totalHD, HDobj, prefix) {
              //if (!classes.known.ranger && !classes.known.rangerua) return;
              var rngrLvl = classes.known["warlord(laserllama)"].level;
              var rngrLvlM = 5 * rngrLvl;
              HDobj.alt.push(5 + rngrLvlM);
              HDobj.altStr.push(
                " = 5 as a base\n + 5 \xD7 " +
                rngrLvl +
                " from five times its leader's warlord level (" +
                rngrLvlM +
                ")"
              );
            },
            setAltHp: true,
          },
        },
      ],
    },
    subclassfeature6: {
      name: "Invigorating Orders",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "When I target my Protege with an Exploit, they have advan. on their next check, attack, or save",
        " Also, my Protege gains proficiency in Wis saves, heavy armor and martial weapons"
      ]),
    },
    subclassfeature14: {
      name: "Exalted Protege",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      description: desc([
        "The stats of my Protege changes (see Companion)",
        "I learn the Heroic Order Exploit. It does not count against my Exploit Known and cannot be replaced.",
        " Also, I can use Heroic Exploit an additional time but only targeting my Protege"
      ]),
      spellcastingBonusElsewhere: {
        addTo: "tactical exploits",
        spellcastingBonus: {
          name: "Exalted Protege",
          spellcastingAbility: 1,
          spells: ["heroic order"],
          selection: ["heroic order"],
          prepared: true,
        },
      },
      toNotesPage: [
        {
          // What is added to the notes page
          name: "Heroic Order [4th degree]",
          note: desc(SpellsList["heroic order"].descriptionFull),
          amendTo: "Counselor",
        },
      ],
      spellChanges: {
        "heroic order": {
          changes:
            "Once per long rest, I can use this Exploit targeting my Protege without counting against the once per rest use of the Exploit.",
        },
      },
    },
    subclassfeature18: {
      name: "Legendary Tandem",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: levels.map((n) => {
        if (n < 20) return desc([
          "While me and my Protege are within 30 feet each other, we have advan. on saves and cannot have disadv. on attacks",
          " Also my Protege can use their Heroic Determination twice"
        ]);
        return desc([
          "While me and my Protege are within 30 feet each other, we have advan. on saves and cannot have disadv. on attacks",
          " Also my Protege can use their Heroic Determination twice and when they use it, replacing an attack roll makes it an automatic critical hit"
        ]);
      }),
    },
  },
});

// Dread
AddSubClass("warlord(laserllama)", "dread", {
  regExpSearch: /^(?=.*academy)(?=.*dread).*$/i,
  subname: "Dread",
  fullname: "Academy of Dread",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: GetWarlordSubclassExploits("Dread", [
      "attack order",
      "commanding presence",
      "intimidating command",
      "menacing shout",
      "war cry",
    ]),
    "subclassfeature3.1": {
      name: "Dark Captain",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      weaponProfs: [true, true],
      skills: ["Intimidation"],
      description: desc(
        "I gain proficiency in all martial weapons and Intimidation",
        " Whenever I make an Intimidation check, I can use my Lead mod instead of Cha",
        " When I do, I treat a roll of 7 or lower on the d20 as an 8"
      ),
    },
    "subclassfeature3.2": {
      name: "Dread Presence",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc(
        "I can use my Inspiring Word to fright the target instead of heal",
        " The target makes a Wis save or be Frightened of me for 1 minute or until it sees me take damage",
        " If the target flees an is no longer in my line of sight, It can use an action to end this effect"
      ),
    },
    "subclassfeature6.11": {
      name: "Merciless",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "I can use Intimidating Command and Menacing Shout Exploits without expending an Expl Die Lead mod times each, and I regain all uses on short/long rests",
        " Also, once per turn, when I cause a creature to be frightened of me, I can instantly issue an Attack Order"
      ]),
      spellChanges: {
        "attack order": {
          changes:
            "When I cause a creature to be frightened of me, I can issue this Exploit (no action required)",
        },
        "intimidating command": {
          changes:
            "I can use this Exploit without expend an Exploti Die a number of times equal to my Leadership modifier per short/long rest",
        },
        "menacing shout": {
          changes:
            "I can use this Exploit without expend an Exploti Die a number of times equal to my Leadership modifier per short/long rest",
        },
      },
      choices: ["captain", "mentor", "strategist"],
      choicesNotInMenu: true,
      captain: {
        extraLimitedFeatures: [
          {
            name: "Intimidating Command (Merciless)",
            usages: "Lead mod per ",
            usagescalc: "event.value = Math.max(1, What('Cha Mod'));",
            recovery: "short rest",
            addToExisting: false
          },
          {
            name: "Menacing Shout (Merciless)",
            usages: "Lead mod per ",
            usagescalc: "event.value = Math.max(1, What('Cha Mod'));",
            recovery: "short rest",
            addToExisting: false
          },
        ]
      },
      mentor: {
        extraLimitedFeatures: [
          {
            name: "Intimidating Command (Merciless)",
            usages: "Lead mod per ",
            usagescalc: "event.value = Math.max(1, What('Wis Mod'));",
            recovery: "short rest",
            addToExisting: false
          },
          {
            name: "Menacing Shout (Merciless)",
            usages: "Lead mod per ",
            usagescalc: "event.value = Math.max(1, What('Wis Mod'));",
            recovery: "short rest",
            addToExisting: false
          },
        ]
      },
      strategist: {
        extraLimitedFeatures: [
          {
            name: "Intimidating Command (Merciless)",
            usages: "Lead mod per ",
            usagescalc: "event.value = Math.max(1, What('Int Mod'));",
            recovery: "short rest",
            addToExisting: false
          },
          {
            name: "Menacing Shout (Merciless)",
            usages: "Lead mod per ",
            usagescalc: "event.value = Math.max(1, What('Int Mod'));",
            recovery: "short rest",
            addToExisting: false
          },
        ]
      },
    },
    subclassfeature14: {
      name: "Ruthless Command",
      source: [["GMB:LL", 0]],
      minlevel: 10,
      description: desc([
        "Creatures I target with Inspiring Word or a Tactical Exploit have advan. on all attack rolls against frightened creatures until the end of their next turn",
        " Moreover, when I use Dread Presence, the crea has disadv. on its starting Wis save if I or a crea under one of my Expls has hit it with an attack since the end of my last turn"
      ]),
    },
    subclassfeature18: {
      name: "Baleful Presence",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc([
        "When I force a crea within 30 feet to resist being frightened, it makes the save with disadv.",
        " Moreover, creatures frightened by me within 30 feet have their speed reduced to 0 while they can see me",
      ]),
    },
    "subclassfeature18.1": {
      name: "Dreadlord",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc(
        "I am immune to the Fightened condition and I add my Lead mod (min +1) to any attack rolls I make against creatures fightened by me"
      ),
      savetxt: { immune: ["frightened"] }
    },
  },
});

// Ferocity
AddSubClass("warlord(laserllama)", "ferocity", {
  regExpSearch: /^(?=.*academy)(?=.*ferocity).*$/i,
  subname: "Ferocity",
  fullname: "Academy of Ferocity",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: GetWarlordSubclassExploits("Ferocious", [
      "cunning instinct",
      "maneuvering order",
      "crescendo of violence",
      "wild charge",
      "pack tactics",
    ]),
    "subclassfeature3.33": {
      name: "Pack Leader",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      weaponProfs: [true, true],
      skills: ["Intimidation"],
      description: desc(
        "As a bns action, I mark a crea I can see as my Prey. It remains my Prey for 1 minute, is reduced to 0 HP, I am incapacitated. or I mark another crea",
        " Any crea targeted by my Inspiring Word or a Tactical Expl add my Expl Die to the first attack against my Prey befor my next start turn",
        " I can use this feature Lead Mod times, I regain 1 use after a short rest and all uses after a long rest"
      ),
      additional: "Lead Mod uses",
      choices: ["captain", "mentor", "strategist"],
      choicesNotInMenu: true,
      captain: {
        extraLimitedFeatures: [
          {
            name: "Pack Leader",
            usages: "Lead mod per ",
            usagescalc: "event.value = Math.max(1, What('Cha Mod'));",
            recovery: "short rest",
            addToExisting: false
          },
        ]
      },
      mentor: {
        extraLimitedFeatures: [
          {
            name: "Pack Leader",
            usages: "Lead mod per ",
            usagescalc: "event.value = Math.max(1, What('Wis Mod'));",
            recovery: "short rest",
            addToExisting: false
          },
        ]
      },
      strategist: {
        extraLimitedFeatures: [
          {
            name: "Pack Leader",
            usages: "Lead mod per ",
            usagescalc: "event.value = Math.max(1, What('Int Mod'));",
            recovery: "short rest",
            addToExisting: false
          },
        ]
      },
    },
    "subclassfeature3.2": {
      name: "Predatory Instinct",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      weaponProfs: [true, true],
      skillstxt: "Choose one between Perception or Survival",
      description: desc(
        "I gain proficiency in marial weapons and one between Perception or Survival",
        " Also, I can treat a roll of 7 or lower on the d20 as an 8 with all Perception and Survival checks based on my sense of smell or hearing"
      ),
    },
    subclassfeature6: {
      name: "Silent Stalker",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "Me and creas of my choice within 30 feet have advan. on Stealth checks and can travel stealthily moving at a normal pace",
        " Also. while I have a marked crea as Prey, I can issue a Maneuvering Order as a bns action"
      ]),
      spellChanges: {
        "maneuvering order": {
          changes:
            "I can use this Exploit with a bonus action, while I have a creature marked as Prey",
        },
      },
    },
    subclassfeature14: {
      name: "Ruthless Command",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      description: desc([
        "When my Prey is killed, I can use a reaction to move the maker to another crea in range, then I gain one of the following benefits:",
        " \u2022 I gain temp HP equal to my Warlord level",
        " \u2022 I regain one expended use of Inspiring Word",
        " \u2022 I regain one expended Exploit Die",
      ]),
    },
    subclassfeature18: {
      name: "Apex Predator",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc([
        "My speed increases by 10 feet, and my weapon attacks against my Prey deal bonus damage equal to my Expl Die",
        " This benefits extends to any crea I target with my Inspiring Word, Rallying Cry or Tactical Eploit until the start of my next turn",
      ]),
    },
  },
});

// Gallantry
AddSubClass("warlord(laserllama)", "gallantry", {
  regExpSearch: /^(?=.*academy)(?=.*gallantry).*$/i,
  subname: "Gallantry",
  fullname: "Academy of Gallantry",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  spellcastingFactor: 3,
  spellcastingKnown: {
    spells: [0, 0, 3, 4, 4, 4, 5, 6, 6, 7, 8, 8, 9, 10, 10, 11, 11, 11, 12, 13],
  },
  features: {
    subclassfeature3: GetWarlordSubclassExploits("Gallant", [
      "commanding presence",
      "attack order",
      "enlivening order",
      "heroic will",
      "stand the fallen",
    ]),
    "subclassfeature3.33": {
      name: "Gallant Spellcasting",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "I can cast known Gallantry spells, using my Leadership modifier as my spellcasting ability",
        "I can replace a spell I know with another I have spell slots for when I gain a level",
        "I can use any musical instrument I am proficient as spellcasting focus"
      ]),
      additional: [
        "",
        "",
        "3 spells known",
        "4 spells known",
        "4 spells known",
        "4 spells known",
        "5 spells known",
        "6 spells known",
        "6 spells known",
        "7 spells known",
        "8 spells known",
        "8 spells known",
        "9 spells known",
        "10 spells known",
        "10 spells known",
        "11 spells known",
        "11 spells known",
        "11 spells known",
        "12 spells known",
        "13 spells known",
      ],
    },
    "subclassfeature3.2": {
      name: "Warrior Poet",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      skills: ["Performance"],
      toolProfs: [["Musical Instrument", 2]],
      description: desc(
        "I gain proficiency in two musical instrument and Performance",
        " Also, whenever I mak a Performance check that includes both a weapon and a musical instrument, I gain a bonus to the roll equal my Warlord level"
      ),
    },
    subclassfeature6: {
      name: "Heroic Charge",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      additional: [
        "",
        "",
        "range 15 feet",
        "range 15 feet",
        "range 15 feet",
        "range 15 feet",
        "range 15 feet",
        "range 15 feet",
        "range 15 feet",
        "range 15 feet",
        "range 30 feet",
        "range 30 feet",
        "range 30 feet",
        "range 30 feet",
        "range 30 feet",
        "range 30 feet",
        "range 30 feet",
        "range 30 feet",
        "range 30 feet",
        "range 30 feet",
      ],
      description: levels.map((n) => {
        if (n < 11) return desc([
          "When I roll initiative I can expend a use of Inspiring Word to give the benefits of the Dash action during its first turn in combat to me and creas of my choice within 15 feet that can hear me",
          " I cannot use this feature if I am suprised or Incapacitated"
        ]);
        return desc([
          "When I roll initiative I can expend a use of Inspiring Word to give the benefits of the Dash action during its first turn in combat to me and creas of my choice within 30 feet that can hear me",
          " I cannot use this feature if I am suprised or Incapacitated"
        ]);
      }),
    },
    subclassfeature14: {
      name: "Warsong",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      description: desc([
        "Whenever I target a creature with Inspiring Word or a Tactical Expl, it gains the following benefits until the start of my next turn:",
        " \u2022 It has advantage on the first ability check, attack roll, or saving throw it makes",
        " \u2022 It can't be Charmed or Frightened",
      ]),
    },
    subclassfeature18: {
      name: "Mythic Voice",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc([
        "Whenever I cast a 1st-level Gallantry spell, I can choose to expend one use of Inspiring Word instead of a spell slot",
        " I must use a musical instrument as the spellcasting focus for the spell"
      ]),
    },
  },
});

// Liberty
AddSubClass("warlord(laserllama)", "liberty", {
  regExpSearch: /^(?=.*academy)(?=.*liberty).*$/i,
  subname: "Liberty",
  fullname: "Academy of Liberty",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: GetWarlordSubclassExploits("Liberty", [
      "first aid",
      "support order",
      "rejuvenating order",
      "surprise attack",
      "inspirational speech",
    ]),
    "inspiring word": {
      name: "Inspiring Word",
      source: [["GMB:LL", 0]],
      minlevel: 1,
      description: levels.map((n) => {
        if (n < 18) return desc([
          "As a bonus action, I can heal a creature within 30 feet that can hear me of its Hit Die + Lead mod (It does not expend its Hit Die)",
        ]);
        return desc([
          "As a bonus action, I can heal up to three creaturs within 30 feet that can hear me of their Hit Die + Lead mod (It does not expend its Hit Die)",
        ]);
      }),
      action: [["bonus action", ""]],
      usages: levels.map(function (n) {
        return n < 4 ? 3 : n < 8 ? 4 : n < 13 ? 5 : n < 13 ? 6 : 7;
      }),
      recovery: "short rest",
    },
    "subclassfeature3.1": {
      name: "Coordinated Assault",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc(
        "I can issue a Support Order Exploit as a bonus action"
      ),
      spellChanges: {
        "support order": {
          action: "1 bns",
        },
      },
    },
    "subclassfeature3.2": {
      name: "Salt of the Earth",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      weaponProfs: [true, true],
      toolProfs: ["Disguise Kit", "Poisoner's Kit"],
      skills: ["Deception"],
      description: desc([
        "My max HP increases by my Warlord level",
        " Also, whenever I make a check to interact common people, I gain my Expl Die as bonus to the check"
      ]),
      calcChanges: {
        hp: 'if (classes.known["warlord(laserllama)"]) {extrahp += classes.known["warlord(laserllama)"].level; extrastring += \"\\n + \" + classes.known["warlord(laserllama)"].level + \" from Salt of the Earth (Warlord)\";};',
      }
    },
    subclassfeature6: {
      name: "Band Togheter",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: levels.map((n) => {
        if (n < 18) return desc([
          "When a crea within 15 feet of me takes damage, I can rea to devide the damage evenly among willing creas within 15 feet of the first crea",
          " All creas must be able to hear me to partecipate"
        ]);
        return desc([
          "When a crea within 30 feet of me takes damage, I can rea to devide the damage evenly among willing creas within 15 feet of the first crea",
          " All creas must be able to hear me to partecipate"
        ]);
      }),
      action: [["reaction", ""]],
    },
    "rallying cry": {
      name: "Rallying Cry",
      source: [["GMB:LL", 0]],
      minlevel: 9,
      description: levels.map((n) => {
        if (n < 18) return desc([
          "When another crea that can hear me within 30 feet fails a save, I can use my reaction to rally it",
          "The rallied crea roll the save again with a bonus equal to my Lead mod"
        ]);
        return desc([
          "When up to three other creas that can hear me within 30 feet fails the same save, I can use my reaction to rally them",
          "The rallied crea roll the save again with a bonus equal to my Lead mod"
        ]);
      }),
      action: [["reaction", ""]],
      usages: levels.map(function (n) {
        return n < 9 ? "" : n < 13 ? 1 : n < 17 ? 2 : n < 20 ? 3 : 999;
      }),
      recovery: "short rest",
    },
    subclassfeature14: {
      name: "Strength in Numbers",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      description: levels.map((n) => {
        if (n < 18) return desc([
          "When I roll initiative, I regain Expl Dice equal to the number of allied creas within 15 feet of me",
          " Also, I learn Equip Militia Expl, it does not count against my Exploit Known and cannot be replaced",
          " I can use this Expl during a short or long rest, and once per long rest without expending an Expl Die",
        ]);
        return desc([
          "When I roll initiative, I regain Expl Dice equal to the number of allied creas within 30 feet of me",
          " Also, I learn Equip Militia Expl, it does not count against my Exploit Known and cannot be replaced",
          " I can use this Expl during a short or long rest, and once per long rest without expending an Expl Die",
        ]);
      }),
      spellcastingBonusElsewhere: {
        addTo: "tactical exploits",
        spellcastingBonus: {
          name: "Strength in Numbers",
          spellcastingAbility: 1,
          spells: ["equip militia"],
          selection: ["equip militia"],
          prepared: true,
        },
      },
      toNotesPage: [
        {
          name: "Equip Militia [4th degree]",
          note: desc(SpellsList["equip militia"].descriptionFull),
          amendTo: "Liberty",
        },
      ],
      spellChanges: {
        "equip militia": {
          changes:
            "I can use this Exploit during a short or long rest, and once perlong rest, you can use it without expending an Exploit Die."
        },
      },

    },
    subclassfeature18: {
      name: "Grand Revolutionary",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc([
        "Band Togheter and Strength in Numbers features are improved (see them)",
        "Inspiring Word and Rallying Cry features are improved (see them)",
      ]),
    },
  },
});

// Navigators
AddSubClass("warlord(laserllama)", "navigators", {
  regExpSearch: /^(?=.*academy)(?=.*navigators).*$/i,
  subname: "Navigators",
  fullname: "Academy of Navigators",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: GetWarlordSubclassExploits("Navigator", [
      "roguish charm",
      "maneuvering order",
      "intimidating command",
      "resilient order",
      "recruit mercenary",
    ]),
    "subclassfeature3.1": {
      name: "Parley",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc(
        "As an action I can expend one use of Inspiring Word to speak to a crea within 15 feet that can see, hear and understane me",
        " That creature improves its attitude toward me by one (Hostile -> Indifferent -> Friendly)",
        " Once I use this feature on a crea, it is immune to its effects for 24h ",
        " I cannot use this feature on a crea that me or my allies have attacked within the last 24h"
      ),
      action: [["action", ""]]
    },
    "subclassfeature3.2": {
      name: "Seafarer",
      source: [["GMB:LL", 0]],
      minlevel: 3,
    },
    "subclassfeature3.2": (function () {
      // copies the main class feature, avoids having to copy all fighting styles
      var FSfea = newObj(
        ClassList["warlord(laserllama)"].features["fighting style"]
      );
      FSfea.name = "Seafarer";
      FSfea.source = [["GMB:LL", 0]];
      FSfea.minlevel = 3;
      FSfea.description = desc(
        "I gain proficiency in Perception, Navigator's Tools, and Vehicles(Water) and I use my Lead mod for check with these skills",
        " Also, I gain the Mariner Fighting Style. If I already have it, I learn a different Warlod Fighting Style"
      );
      FSfea.toolProfs = ["Navigator's Tools", "Vehicles(Water)"];
      FSfea.skills = ["Perception"];
      FSfea.extraname = "Seafarer Fighting Style";
      FSfea.extrachoices = FSfea.choices;
      FSfea.extraTimes = 1;
      FSfea.choices = undefined; // work-around to prevent having the choice menu display twice

      return FSfea;
    })(),
    subclassfeature6: {
      name: "Navigator's Crew",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "During a long rest I can choose up to my Lead mod creas to form a pact and make them my Crew",
        " The creas must be willing and able to understand me to enter the pact",
        " Forming a new pact end the previous one",
        " The creas under my pact add my Lead mod to any check while aboard the same seafaring vessel"
      ]),
    },
    "subclassfeature6.1": {
      name: "Rally the Crew",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: levels.map((n) => {
        if (n < 18) return desc([
          "Whenever a Crew's member is forced to a save while within 15 feet of me, they add their Prof Bonus to that save if not already proficient",
          " Also I can issue an Order with a bonus action, to a Crew's member within 15 feet of me"
        ]);
        return desc([
          "Whenever a Crew's member is forced to a save while within 30 feet of me, they add their Prof Bonus to that save if not already proficient",
          " Also I can issue an Order with a bonus action, to a Crew's member within 30 feet of me"
        ]);
      }),
      action: [["bonus action", ""]]
    },
    subclassfeature14: {
      name: "First Mate",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      description: desc([
        "When I use Recruit Mercenary, I can designate them as my First Mate, and when I do, I can regain my Expl Die as normal",
        " Alternatively, I can designate a different member of my Crew",
        " The First Mate is a member of my Crew, It doesn't count against my total Crew number and it has the benefits of my Seafarer feature",
        " I can only have a First Mate at a time"
      ]),
    },
    subclassfeature18: {
      name: "Illustrious Admiral",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc([
        "Rally the Crew is improved (see it)",
        " Also, when I speak with a crea that can hear and understand me, I can place it under the effects of my Pearly without expending my Inspiring Word to do so"
      ]),
    },
  },
});

// Order
AddSubClass("warlord(laserllama)", "order", {
  regExpSearch: /^(?=.*academy)(?=.*order).*$/i,
  subname: "Order",
  fullname: "Academy of Order",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: GetWarlordSubclassExploits("Order", [
      "inquisitive eye",
      "defensive order",
      "hold the line",
      "soothing speech",
      "survey settlement",
    ]),
    "subclassfeature3.1": {
      name: "Keeper of Order",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      skillstxt: "Choose one between Insight or Investigation",
      description: desc(
        "I gain proficiency in either Insight or Investigation",
        " Also, when I reduce a creature to 0 HP with a non-lethal melee attack, I can use a bsn action on that turn to restrain them with a net, rope, manacles, or another similar object",
        " The escape DC of this restrain is equal to my Expl DC unless its innate DC is higher"
      ),
      action: [["bonus action", ""]]
    },
    "subclassfeature3.29": {
      name: "Law's Shield",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc(
        "When a crea I can see within 45 feet is hit by an attack, I can use my reaction to issue it a Defensive Order and give disadv. to that attack, possibly turning it into a miss",
        " When I have no uses left I can expend an Inspiring Word to use it again"
      ),
      action: [["reaction", ""]],
      spellChanges: {
        "defensive order": {
          changes:
            "I can use this Exploit also with Law's Shield feature's reaction (see it)",
        },
      },
      choices: ["captain", "mentor", "strategist"],
      choicesNotInMenu: true,
      captain: {
        extraLimitedFeatures: [
          {
            name: "Law's Shield",
            usages: "Lead mod per ",
            usagescalc: "event.value = Math.max(1, What('Cha Mod'));",
            recovery: "long rest",
            addToExisting: false
          },
        ]
      },
      mentor: {
        extraLimitedFeatures: [
          {
            name: "Law's Shield",
            usages: "Lead mod per ",
            usagescalc: "event.value = Math.max(1, What('Wis Mod'));",
            recovery: "long rest",
            addToExisting: false
          },
        ]
      },
      strategist: {
        extraLimitedFeatures: [
          {
            name: "Law's Shield",
            usages: "Lead mod per ",
            usagescalc: "event.value = Math.max(1, What('Int Mod'));",
            recovery: "long rest",
            addToExisting: false
          },
        ]
      },
    },
    subclassfeature6: {
      name: "Halt",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: levels.map((n) => {
        if (n < 18) return desc([
          "When a crea you can see within 30 feet moves, I can use my reaction to expend an Inspiring Word use and force it on a Wis save",
          " On a fail, its speed is reduced to 0 until the start of its next turn",
          " If a crea succeeds on this save, it is immune to this feature for 24h",
          " The target must be able to hear and understand me"
        ]);
        return desc([
          "When a crea you can see within 30 feet moves, I can use my reaction to expend an Inspiring Word use and force it on a Wis save",
          " On a fail, its speed is reduced to 0 and it is Restrained until the start of its next turn",
          " If a crea succeeds on this save, it is immune to this feature for 24h",
          " The target must be able to hear and understand me"
        ]);
      }),
      action: [["reaction", ""]],
    },
    "subclassfeature6.1": {
      name: "Stalwart Defender",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "Once per short/long rest I can use the Hold the Line Exploit without expending an Expl Die",
      ]),
      spellChanges: {
        "hold the line": {
          changes:
            "I can use this Exploit once per short/long without expending an Exploit Die",
        },
        "defensive order": {
          changes:
            "I can use this Exploit also with Law's Shield feature's reaction (see it) and while using Hold the Line Exploit, its range it is 15 feet, and I can issue it as a bonus action",
        },
      },
    },
    subclassfeature14: {
      name: "Bastion of Order",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      description: desc([
        "While in Hold the Line Exploit, I can use my Law's Shield and Halt reactions without expendind resources",
        " Moreover, I can move 10 on my turn without ending the effects of Hold the Line"
      ]),
      spellChanges: {
        "hold the line": {
          changes:
            "I can use this Exploit once per short/long without expending an Exploit Die. I can move 10 feet without ending the effects of this Exploit",
        },
      },
    },
    subclassfeature18: {
      name: "High Authority",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc([
        "I always exude the effects of Hold the Line Exploit to creatures of my choice within 15 feet of me, but I can move and act as normal",
        " Also, Halt is improved (see it)"
      ]),
    },
  }
});

// Schemes
AddSubClass("warlord(laserllama)", "schemes", {
  regExpSearch: /^(?=.*academy)(?=.*schemes).*$/i,
  subname: "Schemes",
  fullname: "Academy of Schemes",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    subclassfeature3: GetWarlordSubclassExploits("Scheming", [
      "cunning instinct",
      "maneuvering order",
      "crescendo of violence",
      "wild charge",
      "pack tactics",
    ]),
    "subclassfeature3.1": {
      name: "Cheap Shot",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description: desc([
        "Once per turn, when I hit a cra with a weapon attack, I can force it to make a Dex Save against my Expl CD along with the damage",
        "On a fail, it cannot take reactions and its speed is halved until the start of my next turn. On its next turn, It can take only one action or bns action, not both",
      ]),
    },
    "subclassfeature3.2": {
      name: "Dastardly Talents",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      weaponProfs: [true, true],
      toolProfs: ["Disguise Kit", "Poisoner's Kit"],
      skills: ["Deception"],
      description: desc(
        "I gain proficiency in Deception, Disguise Kits, and Poisoner's Kit",
        " Also, I can use my Lead mod instead of Charisma for Deception checks"
      ),
    },
    subclassfeature6: {
      name: "Ruthless Focus",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "When a crea fails against my Cheap Shot, I can instantly issue an Insightful Order, but the target of the order gains its benefits only attacking the crea that failed against my Cheap Shot",
        " Also, If I use a Tactical Expl as part of my action, I can Disengage or Hide as a bns action"
      ]),
      action: [["bonus action", ""]],
      spellChanges: {
        "insightful order": {
          changes:
            "I can use this Exploit, no action required, when a creature fails against my Cheap Shot",
        },
      },
    },
    subclassfeature14: {
      name: "Devious Tactics",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      description: desc([
        "When I am the target of an attack or a save from a creature I can see, I can use my reaction to force a crea within 5 feet of me (not the attacker) to make a save DC against my Expl DC",
        " On fail, I switch place with the crea and it becomes the target of that attack or save. The crea can choose to fail",
      ]),
    },
    subclassfeature18: {
      name: "Inscrutable Mind",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc([
        "My thoughts and dreams cannot be read by magic unless I allow it. If a creature attemps to read my mind, I can make a Deception checks to deceive it with false thoughts",
      ]),
    },
    "subclassfeature18.1": {
      name: "Marked for Death",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc([
        "When a crea fails against my Cheap Shot, I can mark it for death",
        "The first attack that hit the marked crea before my next turn becomes an automatic critical hit"
      ]),
      usages: 1,
      reacovery: "short rest"
    },
  },
});

// Tactics
AddSubClass("warlord(laserllama)", "tactics", {
  regExpSearch: /^(?=.*academy)(?=.*tactics).*$/i,
  subname: "Tactics",
  fullname: "Academy of Tactics",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  features: {
    // Override tactical exploits because size of die increases
    "tactical exploits": (function () {
      // Fixed attributes
      TacticalExploits = {
        name: "Tactical Exploits",
        minlevel: 2,
        source: [["GMB:LL", 0]],
        description: desc([
          "I gain Exploit Dice, which are used to fuel my Tactical Exploits",
          'Use the "Choose Feature" button above to choose Tactical Exploits',
        ]),
        toNotesPage: [
          {
            name: "Tactical Exploits",
            note: desc([
              "Below are all Tactical Exploits I know. Each 3rd and 4th degree exploits can only be used once per short rest. Each 5th degree exploit can only be used once per long rest.",
            ]),
          },
        ],

        // Tactical Exploits
        extraname: "Tactical Exploits",
        extraTimes: [
          "",
          2,
          3,
          3,
          4,
          4,
          5,
          5,
          6,
          6,
          7,
          7,
          8,
          8,
          9,
          9,
          10,
          10,
          11,
          11,
        ],
        extrachoices: [],
        limfeaname: "Exploit Dice",

        // Exploit dice
        usages: ["", 2, 3, 3, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6],
        additional: [
          "",
          "d4",
          "6d",
          "6d",
          "d8",
          "d8",
          "d8",
          "d8",
          "d8",
          "d8",
          "d10",
          "d10",
          "d10",
          "d10",
          "d10",
          "d10",
          "d12",
          "d12",
          "d12",
          "d12",
        ],
        recovery: "short rest",

        // Eval
        eval: CreateTacticalSpellsheet,
      };

      // Make a filtered spell list that contains only Fighter(laserllama) "spells"
      const WarlordSpells = Object.keys(SpellsList)
        .filter((key) => SpellsList[key].isExploit)
        .filter((key) => {
          for (var i = 0; i < SpellsList[key].classes.length; i++) {
            if (SpellsList[key].classes[i] == "warlord(laserllama)")
              return true;
          }
          return false;
          // NOTE: this is literally a SpellsList[key].classes.includes("fighter(laserllama)") but for some cursed reason I can't use that function
        });

      // Iterate over all Fighter(laserllama) "spells"
      for (var i = 0; i < WarlordSpells.length; i++) {
        var NewSpell = SpellsList[WarlordSpells[i]];
        var tempSpell = WarlordSpells[i];

        TacticalExploits.extrachoices.push(NewSpell.name); // Add "spell" name to menu options

        TacticalExploits[WarlordSpells[i]] = {
          // Add "spell" to the main item (when it is picked through the menu)
          name: NewSpell.name,
          toNotesPage: [
            {
              // What is added to the notes page
              name:
                NewSpell.name +
                " Exploit [" +
                (NewSpell.level == 1
                  ? "1st"
                  : NewSpell.level == 2
                    ? "2nd"
                    : NewSpell.level == 3
                      ? "3rd"
                      : NewSpell.level + "th") +
                " degree]",
              note: desc(NewSpell.descriptionFull),
              amendTo: "Tactical Exploits",
            },
          ],
          source: NewSpell.source,
          addMod: NewSpell.addMod,
          submenu: NewSpell.submenu,
          prereqeval: ExploitPrereqFactory(
            WarlordSpells[i],
            "warlord(laserllama)"
          ),
          eval: TacticalExploits.eval, // in case the user removes all exploits
          spellcastingBonusElsewhere: {
            addTo: "tactical exploits",
            spellcastingBonus: {
              name: "Tactical Exploits",
              spellcastingAbility: 1,
              spells: [WarlordSpells[i]],
              selection: [WarlordSpells[i]],
            },
          },
        };
      }

      return TacticalExploits;
    })(),

    subclassfeature3: (function () {
      // Fixed attributes
      TacticalExploits = {
        name: "Advanced Tactics",
        minlevel: 3,
        source: [["GMB:LL", 0]],
        description: levels.map(function (n) {
          if (n < 3) return "";

          if (n >= 3 && n < 5) {
            var result = [
              "My total number of Exploit Dice increases by 1 and my Exploit Dice increase to become 1d6",
              "I also learn two 1st degree Tactical Exploits of my choice who don't count against my total",
            ];
          }

          if (n >= 5 && n < 9) {
            var result = [
              "My total number of Exploit Dice increases by 1 and my Exploit Dice increase to become 1d8",
              "I also learn two 1st degree and two 2nd degree Tactical Exploits of my choice who don't count against my total",
            ];
          }

          if (n >= 9 && n < 11) {
            var result = [
              "My total number of Exploit Dice increases by 1 and my Exploit Dice increase to become 1d8",
              "I also learn two 1st degree, two 2nd degree and a 3rd degree Tactical Exploits of my choice who don't count against my total",
            ];
          }

          if (n >= 11 && n < 17) {
            var result = [
              "My total number of Exploit Dice increases by 1 and my Exploit Dice increase to become 1d10",
              "I also learn two 1st degree, two 2nd degree and a 3rd degree Tactical Exploits of my choice who don't count against my total",
            ];
          }

          if (n >= 11) {
            var result = [
              "My total number of Exploit Dice increases by 1 and my Exploit Dice increase to become 1d12",
              "I also learn two 1st degree, two 2nd degree and a 3rd degree Tactical Exploits of my choice who don't count against my total",
            ];
          }

          return desc(result);
        }),
        toNotesPage: [
          {
            name: "Academy of Tactics Exploits",
            note: desc([
              "Below are my Academy of Tactics exploits. The 3rd level exploit can only be used per short rest.",
            ]),
          },
        ],

        extraLimitedFeatures: [
          {
            name: "Exploit Dice",
            usages: 1,
            recovery: "short rest",
            addToExisting: true,
          },
        ],

        // Tactical Exploits
        extraname: "Academy of Tactics xploits",
        extraTimes: levels.map(function (n) {
          return n < 3 ? 0 : n < 5 ? 2 : n < 9 ? 4 : 5;
        }),
        extrachoices: [],

        // Eval
        eval: CreateTacticalSpellsheet,
      };

      // Make a filtered spell list that contains only Fighter(laserllama) "spells" of degree <= 3
      const WarlordSpells = Object.keys(SpellsList)
        .filter(
          (key) => SpellsList[key].isExploit && SpellsList[key].level <= 3
        )
        .filter((key) => {
          for (var i = 0; i < SpellsList[key].classes.length; i++) {
            if (SpellsList[key].classes[i] == "warlord(laserllama)")
              return true;
          }
          return false;
          // NOTE: this is literally a SpellsList[key].classes.includes("fighter(laserllama)") but for some cursed reason I can't use that function
        });

      //const DegreeToMinLevel = [0,0,5,9,13,17]
      // Iterate over all Fighter(laserllama) "spells"
      for (var i = 0; i < WarlordSpells.length; i++) {
        var NewSpell = SpellsList[WarlordSpells[i]];

        TacticalExploits.extrachoices.push(NewSpell.name); // Add "spell" name to menu options

        TacticalExploits[WarlordSpells[i]] = {
          // Add "spell" to the main item (when it is picked through the menu)
          name: NewSpell.name,
          toNotesPage: [
            {
              // What is added to the notes page
              name:
                NewSpell.name +
                " Exploit [" +
                (NewSpell.level == 1
                  ? "1st"
                  : NewSpell.level == 2
                    ? "2nd"
                    : NewSpell.level == 3
                      ? "3rd"
                      : NewSpell.level + "th") +
                " degree]",
              note: desc(NewSpell.descriptionFull),
              amendTo: "Academy of Tactics Exploits",
            },
          ],
          source: NewSpell.source,
          addMod: NewSpell.addMod,
          submenu: NewSpell.submenu,
          prereqeval: ExploitPrereqFactory(
            WarlordSpells[i],
            "warlord(laserllama)"
          ),
          eval: TacticalExploits.eval, // in case the user removes all exploits
          spellcastingBonusElsewhere: {
            addTo: "tactical exploits",
            spellcastingBonus: {
              name: "Academy of Tactics Exploits",
              spellcastingAbility: 1,
              spells: [WarlordSpells[i]],
              selection: [WarlordSpells[i]],
            },
          },
        };
      }

      return TacticalExploits;
    })(),
    "subclassfeature3.1": {
      name: "The Art of War",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      skills: ["History", "full"],
      toolProfs: [["Disguise Kit", 2]],
      description: desc(
        ["I gain proficiency in History and two gaming set of my choice",
          " Also, I add double my proficiency bonus to any check that use this proficiencies",]
      ),
    },
    "subclassfeature3.2": {
      name: "Strategic Adjustments",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      weaponProfs: [true, true],
      skills: ["Deception"],
      description: levels.map((n) => {
        var rest = n < 6 ? "long" : "short"
        return desc(
          "During a " + rest + " rest I can spen 1 hour of study to replace a Tactical Exploit I know with another of the same Degree"
        );
      }),
    },
    subclassfeature6: {
      name: "Brains over Brawn",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "When I use a Tactical Exploit that takes a full action, I can use my bonus action to take the Disengage or Search action, or use one Order Exploit, such as Attack Order"
      ]),
      action: [["bonus action", ""]],
    },
    subclassfeature6: {
      name: "Know your Enemy",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "If I spend a Search action studying someone (up to 30 ft, DC = 8 + CR), the DM will tell me info about them (my choice)",
        "If I see it take a hit by an attack before studying it, I have a bonus equal to my warlord level to the check",
        "I cannot use this twice on the same creature before I see it was hit by another attack",
      ]),
      action: [["action", ""]],
    },
    subclassfeature14: {
      name: "Gifted Strategist",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      description: desc([
        "I cannot be surprised while conscious",
        " Also, when I roll initiative I can use one Tactical Exploit or take the Ready action",
      ]),
    },
    subclassfeature18: {
      name: "Master Tactician",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc([
        "I learn the Contingency Plan Exploit and it doesn't count against my Exploit Known",
        "At the end of a long rest I can use Contingency Plan without expend an Expl Die"
      ]),
      spellcastingBonusElsewhere: {
        addTo: "tactical exploits",
        spellcastingBonus: {
          name: "Master Tactician",
          spellcastingAbility: 1,
          spells: ["contingency plan"],
          selection: ["contingency plan"],
          prepared: true,
        },
      },
      toNotesPage: [
        {
          name: "Contingency Plan [5th degree]",
          note: desc(SpellsList["contingency plan"].descriptionFull),
          amendTo: "Academy of Tactics Exploits",
        },
      ],
      spellChanges: {
        "contingency plan": {
          changes:
            "I can use this Exploit without expending an Exploit Die after a long rest",
        },
      },
    },
  },
});

// Zeal
AddSubClass("warlord(laserllama)", "zeal", {
  regExpSearch: /^(?=.*academy)(?=.*zeal).*$/i,
  subname: "Zeal",
  fullname: "Academy of Zeal",
  source: [["GMB:LL", 0]],
  abilitySave: 1,
  abilitySaveAlt: 2,
  spellcastingFactor: "warlock3",
  spellcastingList: {
    spells: ZealList,
  },
  spellcastingTable: [
    [0, 0, 0, 0, 0, 0, 0, 0, 0], //lvl 0
    [0, 0, 0, 0, 0, 0, 0, 0, 0], //lvl 1
    [0, 0, 0, 0, 0, 0, 0, 0, 0], //lvl 2
    [1, 0, 0, 0, 0, 0, 0, 0, 0], //lvl 3
    [2, 0, 0, 0, 0, 0, 0, 0, 0], //lvl 4
    [2, 0, 0, 0, 0, 0, 0, 0, 0], //lvl 5
    [2, 0, 0, 0, 0, 0, 0, 0, 0], //lvl 6
    [0, 2, 0, 0, 0, 0, 0, 0, 0], //lvl 7
    [0, 2, 0, 0, 0, 0, 0, 0, 0], //lvl 8
    [0, 2, 0, 0, 0, 0, 0, 0, 0], //lvl 9
    [0, 2, 0, 0, 0, 0, 0, 0, 0], //lvl10
    [0, 2, 0, 0, 0, 0, 0, 0, 0], //lvl11
    [0, 2, 0, 0, 0, 0, 0, 0, 0], //lvl12
    [0, 0, 2, 0, 0, 0, 0, 0, 0], //lvl13
    [0, 0, 2, 0, 0, 0, 0, 0, 0], //lvl14
    [0, 0, 2, 0, 0, 0, 0, 0, 0], //lvl15
    [0, 0, 2, 0, 0, 0, 0, 0, 0], //lvl16
    [0, 0, 2, 0, 0, 0, 0, 0, 0], //lvl17
    [0, 0, 2, 0, 0, 0, 0, 0, 0], //lvl18
    [0, 0, 0, 2, 0, 0, 0, 0, 0], //lvl19
    [0, 0, 0, 2, 0, 0, 0, 0, 0], //lvl20
  ],
  spellcastingKnown: {
    cantrips: [0, 0, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3],
    spells: [0, 0, 2, 2, 3, 3, 4, 4, 5, 5, 5, 5, 6, 6, 6, 6, 7, 7, 7, 7],
  },
  features: {
    subclassfeature3: {
      name: "Divine Mandate",
      source: [["GMB:LL", 0]],
      skills: ["Religion"],
      minlevel: 3,
      description: desc([
        "I gain proficiency in Religion and I add my Lead mod to every Religion check",
        " I know the Attack Order Exploit, It doesn't count against my Exploit Known and cannot be replaced",
      ]),
      spellcastingBonusElsewhere: {
        addTo: "tactical exploits",
        spellcastingBonus: {
          name: "Divine Mandate",
          spellcastingAbility: 1,
          spells: ["attack order"],
          selection: ["attack order"],
          prepared: true,
        },
      },
      toNotesPage: [
        {
          // What is added to the notes page
          name: "Attack Order [1st degree]",
          note: desc(SpellsList["attack order"].descriptionFull),
          amendTo: "Zeal",
        },
      ],
    },
    "subclassfeature3.1": {
      name: "Anointed Magic",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      additional: [
        "",
        "",
        "2 cantrip \u0026 2 spells known",
        "2 cantrip \u0026 2 spells known",
        "2 cantrip \u0026 3 spells known",
        "2 cantrip \u0026 3 spells known",
        "2 cantrip \u0026 4 spells known",
        "2 cantrip \u0026 4 spells known",
        "2 cantrip \u0026 5 spells known",
        "3 cantrips \u0026 5 spells known",
        "3 cantrips \u0026 5 spells known",
        "3 cantrips \u0026 5 spells known",
        "3 cantrips \u0026 6 spells known",
        "3 cantrips \u0026 6 spells known",
        "3 cantrips \u0026 6 spells known",
        "3 cantrips \u0026 6 spells known",
        "3 cantrips \u0026 7 spells known",
        "3 cantrips \u0026 7 spells known",
        "3 cantrips \u0026 7 spells known",
        "3 cantrips \u0026 7 spells known",
      ],
      description: desc(
        "I can cast known Zeal spells, using my Lead mod as my spellcasting ability (see 3rd page)"
      ),
      eval: function () {
        AddString("Extra.Notes", "Anointed Magic:");
        show3rdPageNotes();
      },
      removeeval: function () {
        AddString("Extra.Notes", "Anointed Magic:");
      },
      spellcasting: {
        name: "Spellcasting",
        extraname: "Zeal 3",
        source: [["GMB:LL", 0]],
        description: levels.map(function (n) {
          var divineLimit =
            n < 7 ? "1st" : n < 13 ? "2nd" : n < 19 ? "3rd" : "4th";

          return desc([
            "I can cast known Zeal spells, using my Lead mod as my spellcasting ability",
            "I cannot cast or learn spells of a level above the spell slots level I have",
            "I must us a Holy Symbol as my Spellcasting Focus. If I emblazon my Holy Symbol upon a shiled, I can use it as a Spellcasting focus for my Zeal spells whil wielding it",
            "I can replace any spell I know with another when I gain a Warlord level",
          ]);
        }),
      },
      autoSelectExtrachoices: [
        {
          extrachoice: "spellcasting",
          minlevel: 3,
        },
      ],
    },
    subclassfeature6: {
      name: "Channel Divinity",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description: desc([
        "I gain the miraculous effects below and 2 uses of Channel Divinity per long/short rest",
        " I can expend a Channel Divinity to use one of the two effects",
        " When I have no uses I can expend an Anointed Magic spell slot to use it again:",
        "  \u2022 \x1bAnointed Disciple.\x1b As an action,  for 10 minutes, I add my Exploit Die to all ability checks i make that use my Leadership ability score.",
        "  \u2022 \x1bMantle of Command.\x1b As a action, For 1 minute, I can use a bonus action on each turn to make a weapon attack or issue one Order.",
      ]),
      usages: 2,
      recovery: "short rest",
      action: [
        ["action", "Anointed Disciple"],
        ["action", "Mantle of Command."],
      ],
    },
    subclassfeature14: {
      name: "Words of Zeal",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      description: desc([
        "When I use Inspirinf Word, the target regains the max number of HP instead of rolling",
        " Moreover, the crea I target with Attack Order, can choose to deal radiant damage in place of the normal damage type",
      ]),
    },
    subclassfeature18: {
      name: "Favored Servant",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description: desc([
        "When I take the Attack action on my turn, I can cast a Zeal spell with a casting time of one action in place of one attack",
        " Finally, whenever I expend an Anointed Magic spell slot, I regain one of the following:",
        "  \u2022 HP equal to my level",
        "  \u2022 one Expl Die",
        "  \u2022 one use of Inspiring Word"
      ]),
    },
  },
});

// Subclasses Psion
// Empath
AddSubClass("psion(laserllama)", "empath", {
  regExpSearch: /empath/i,
  source: ["GMB:LL", 0],
  subname: "Empath",
  features: {
    subclassfeature1: {
      name: "Empath Spells",
      source: [["GMB:LL", 0]],
      minlevel: 1,
      description:
        "\n   " +
        "I learn certain spells. They are Psion spells for me and don't count against my total of spells known and can't be replaced when I gain a level",
      spellcastingBonus: [
        {
          name: "Empath Spells (1st-level)",
          firstCol: "EmS",
          spells: ["charm person"],
          selection: ["charm person"],
          times: 1,
        },
        {
          name: "Empath Spells (3rd-level)",
          firstCol: "EmS",
          spells: ["calm emotions"],
          selection: ["calm emotions"],
          times: levels.map(function (n) {
            return n < 3 ? 0 : 1;
          }),
        },
        {
          name: "Empath Spells (5th-level)",
          firstCol: "EmS",
          spells: ["fear"],
          selection: ["fear"],
          times: levels.map(function (n) {
            return n < 5 ? 0 : 1;
          }),
        },
        {
          name: "Empath Spells (7th-level)",
          firstCol: "EmS",
          spells: ["charm monster"],
          selection: ["charm monster"],
          times: levels.map(function (n) {
            return n < 7 ? 0 : 1;
          }),
        },
        {
          name: "Empath Spells (9th-level)",
          firstCol: "EmS",
          spells: ["dominate person"],
          selection: ["dominate person"],
          times: levels.map(function (n) {
            return n < 9 ? 0 : 1;
          }),
        },
      ],
    },
    "subclassfeature1.1": {
      name: "Aura Sight",
      source: [["GMB:LL", 0]],
      skill: ["Insight"],
      minlevel: 1,
      action: ["action", ""],
      description:
        "\n   " +
        "I gain proficiency in Insight. I can use my Intelligence instead of Wisdom for any Insight check." +
        "\n   " +
        "As an action, I learn the most powerful emotion (for example: anger, anxiety, contentment, fear or joy) of a creature I can see within 60 feet. A creature immune to psionic, divination magic or having its thoughts read telepathically is immune to this feature." +
        "\n   " +
        "I can use this feature a number of times equal to my Intelligence modifier (minimun of 1). I regain all expended uses on a long rest. If I have no uses left, I can expend 1 Psi Point to use this ability again.",
    },
    subclassfeature3: {
      name: "Emotional Flood",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      action: [
        levels.map(function (n) {
          return n < 18 ? "action" : "bonus action";
        }),
        "",
      ],
      description:
        "\n   " +
        "As an action, I force a creature within 30 feet to make a Charisma saving throw or inflicting one of the following:" +
        "\n   " +
        "- Despair: It takes 1d6 psychic damage, its speed is halved and it cannot take reactions until the start of my next turn." +
        "\n   " +
        "- Disgust: It takes 1d8 psychic damage, it cannot move closer to a creature you choose until the start of my next turn." +
        "\n   " +
        "- Fury: It must use its reaction to make a melee attack against one target of its choice within range. If there is no target, it takse 1d10 psychic damage.",
    },
    subclassfeature6: {
      name: "Mantel of Calm",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description:
        "\n   " +
        "I exude a Mantle of calming emotions in a determinated radius. Creatures of my choices within this Mantle are considered to be proficient in all Intelligence, Wisdom and Charisma saving throws." +
        "\n   " +
        "I can also use my Aura Sight on creatures within my Mantle without expending Psi Points.",
      saves: ["Int", "Wis", "Cha"],
      additional: [
        "",
        "",
        "",
        "",
        "",
        "10-foot radius",
        "10-foot radius",
        "10-foot radius",
        "10-foot radius",
        "10-foot radius",
        "10-foot radius",
        "10-foot radius",
        "10-foot radius",
        "20-foot radius",
        "20-foot radius",
        "20-foot radius",
        "20-foot radius",
        "30-foot radius",
        "30-foot radius",
        "30-foot radius",
      ],
    },
    subclassfeature14: {
      name: "Empathic Control",
      source: [["GMB:LL", 0]],
      minlevel: 14,
      savetxt: { immune: ["charmed", "frightened"] },
      description:
        "\n   " +
        "I have immunity to being charmed and firghtened." +
        "\n   " +
        "WAdditionally, whenever I cause a creature to be charmed or frightened, I can expend 1 (addional) Psi Point to enhance the effect for one creature. As long its charmed or frightened by that effect, the creature's speed is 0 and it is incapacitated.",
    },
    subclassfeature18: {
      name: "Ascended Empath",
      source: [["GMB:LL", 0]],
      minlevel: 18,
      description:
        "\n   " +
        "I can use Emotional Flood as a bonus action." +
        "\n   " +
        "Creatures charmed by me will do anything within their power to defend me for the duration, regardless of any previous loyalties they may have had." +
        "\n   " +
        "Creatures frightened by me are stunned for the duration, so long as I am within 30 feet of it and the creature can see me.",
    },
  },
});

// Immortal
AddSubClass("psion(laserllama)", "immortal", {
  regExpSearch: /immortal/i,
  source: ["GMB:LL", 0],
  subname: "Immortal",
  features: {
    subclassfeature1: {
      name: "Immortal Spells",
      source: [["GMB:LL", 0]],
      minlevel: 1,
      description:
        "\n   " +
        "I learn certain spells. They are Psion spells for me and don't count against my total of spells known and can't be replaced when I gain a level",
      spellcastingBonus: [
        {
          name: "Immortal Spells (1st-level)",
          firstCol: "IS",
          spells: ["jump"],
          selection: ["jump"],
          times: 1,
        },
        {
          name: "Immortal Spells (3rd-level)",
          firstCol: "IS",
          spells: ["blur"],
          selection: ["blur"],
          times: levels.map(function (n) {
            return n < 3 ? 0 : 1;
          }),
        },
        {
          name: "Immortal Spells (5th-level)",
          firstCol: "IS",
          spells: ["haste"],
          selection: ["haste"],
          times: levels.map(function (n) {
            return n < 5 ? 0 : 1;
          }),
        },
        {
          name: "Immortal Spells (7th-level)",
          firstCol: "IS",
          spells: ["death ward"],
          selection: ["death ward"],
          times: levels.map(function (n) {
            return n < 7 ? 0 : 1;
          }),
        },
        {
          name: "Immortal Spells (9th-level)",
          firstCol: "IS",
          spells: ["mislead"],
          selection: ["mislead"],
          times: levels.map(function (n) {
            return n < 9 ? 0 : 1;
          }),
        },
      ],
    },
    "subclassfeature1.1": {
      name: "Esoteric Skill",
      source: [["GMB:LL", 0]],
      minlevel: 1,
      skillstxt:
        "Choose one from Acrobatics, Atheltics, Perception, Sleight of Hand or Stealth. Over 1 hour in meditation (which can be during rests), I can switch that chosen skill with another one skill of this list.",
      description:
        "\n   " +
        "I gain Prof in Acrobatics, Atheltics, Perception, Sleight of Hand or Stealth. Over 1 hour in meditation (which can be during rests), I can switch that chosen skill with another one skill of this list." +
        "\n   " +
        "When I make a check with any skill of this list, I can spend 1 Psi Point to add my Int Mod (min of +1) to the result of that check.",
    },
    "subclassfeature1.2": {
      name: "Immortal Training",
      source: [["GMB:LL", 0]],
      minlevel: 1,
      description:
        "\n   " +
        "I gain Prof with medium armor, shields and martial weapons. I can use my Psionics while wearing medium armor and/or wielding a shield." +
        "\n Additionally, my hit point maximum increases by 1, and increase by 1 again each time I gain a Psion level.",
      armorProfs: {
        //required; the 4 entries are for: ["light", "medium", "heavy", "shields"]
        primary: [true, true, false, false], //required; the armor proficiencies if this is the first or only class
        secondary: [true, true, false, false], //required; the armor proficiencies if this class is multiclassed with (so not taken at level 1, but later)
      },
      weaponProfs: {
        //required; the 3 entries are for: ["simple", "martial", "other"]
        primary: [true, true], //required; the weapon proficiencies if this is the first or only class
        secondary: [true, true], //required; the weapon proficiencies if this class is multiclassed with (so not taken at level 1, but later)
      },
      calcChanges: {
        hp: function (totalHD) {
          if (classes.known["psion(laserllama)"]) {
            return [
              classes.known["psion(laserllama)"].level,
              "Immortal Training (psion level)",
            ];
          }
        },
      },
    },
    "sublcassfeature1.3": {
      name: "Immortal Will",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description:
        "\n   " +
        "When I am reduced to 0 hit points but not killed outright, I can expend 1 Psi Point and fall to 1 hit point instead." +
        "  Each subsequent time that I use this feature before a long rest, I must expend 1 additional Psi Point, but I cannot exceed my Mental Limit.",
    },
    "sublcassfeature1.4": {
      name: "Extra Attack",
      minlevel: 6,
      source: [["GMB:LL", 0]],
      description:
        "I can attack twice, whenever you take the Attack action on my turn. \nMoreover, if I use my action to manifest a Psion spell or Mystic Talent, I can make a single weapon attack as a bonus action on that turn.",
    },
    "sublcassfeature1.5": {
      name: "Phase Walk",
      minlevel: 14,
      source: [["GMB:LL", 0]],
      description:
        "As a bonus action, expending 1 Psi Points I can enter in an Etheral State until the end of my current turn." +
        "\n While in this state I can move through solid objects and creatures as if they were difficult terrain. If I end my movement inside an object or creature, I am shunted to the nearest unoccupied space and take 1d10 force damage for every 5 feet I was forced to travel.",
      action: [["bonus action", "Entheral State"]],
    },
    "sublcassfeature1.6": {
      name: "Eternal Will",
      minlevel: 18,
      source: [["GMB:LL", 0]],
      description:
        "If I begin one of my turns with less than half of my hit points remaining, but at least 1 hit point, I regaing hit points equal to my Int Mod.",
    },
  },
});

// Enlightened
AddSubClass("psion(laserllama)", "enlightened", {
  regExpSearch: /enlightened/i,
  source: ["GMB:LL", 0],
  subname: "Enlightened",
  features: {
    subclassfeature1: {
      name: "Enlightened Spells",
      source: [["GMB:LL", 0]],
      minlevel: 1,
      description:
        "\n   " +
        "I learn certain spells. They are Psion spells for me and don't count against my total of spells known and can't be replaced when I gain a level",
      spellcastingBonus: [
        {
          name: "Enlightened Spells (1st-level)",
          firstCol: "EnS",
          spells: ["catapult"],
          selection: ["catapult"],
          times: 1,
        },
        {
          name: "Enlightened Spells (3rd-level)",
          firstCol: "EnS",
          spells: ["levitate"],
          selection: ["levitate"],
          times: levels.map(function (n) {
            return n < 3 ? 0 : 1;
          }),
        },
        {
          name: "Enlightened Spells (5th-level)",
          firstCol: "EnS",
          spells: ["spectral passage"],
          selection: ["spectral passage"],
          times: levels.map(function (n) {
            return n < 5 ? 0 : 1;
          }),
        },
        {
          name: "Enlightened Spells (7th-level)",
          firstCol: "EnS",
          spells: ["otiluke's resilient sphere"],
          selection: ["otiluke's resilient sphere"],
          times: levels.map(function (n) {
            return n < 7 ? 0 : 1;
          }),
        },
        {
          name: "Enlightened Spells (9th-level)",
          firstCol: "EnS",
          spells: ["wall of force"],
          selection: ["wall of force"],
          times: levels.map(function (n) {
            return n < 9 ? 0 : 1;
          }),
        },
      ],
    },
    "subclassfeature1.1": {
      name: "Enlightened Potential",
      source: [["GMB:LL", 0]],
      minlevel: 1,
      description:
        "\n   I unlock an additional Mystic Talent of my choice from the Psion Mystic Talents. This Talent doesn't count against my total of Talents Known and it can be replaced each time I gain a Psion level.",
      extraname: "Enlightened Talent",
      extrachoices: [
        //Talents Level 1
        "Celerity I",
        "Iron Durability I",
        "Metamorphosis I",
        "Precognition I",
        "Restoration I",
        "Telekinesis I",
        "Telepathy I",

        //Talents Level 2
        "Celerity II",
        "Iron Durability II",
        "Metamorphosis II",
        "Precognition II",
        "Restoration II",
        "Telekinesis II",
        "Telepathy II",

        // //Talents Level 3
        "Celerity III",
        "Iron Durability III",
        "Metamorphosis III",
        "Precognition III",
        "Restoration III",
        "Telekinesis III",
        "Telepathy III",

        // //Talents Level 4
        "Celerity IV",
        "Iron Durability IV",
        "Metamorphosis IV",
        "Precognition IV",
        "Restoration IV",
        "Telekinesis IV",
        "Telepathy IV",
      ],
      extraTimes: 1,
      "celerity i": {
        name: "Celerity I",
        description: desc([
          "My speed +10 feet, and I can take the Dash or Disengage action as a bonus action.",
        ]),
        submenu: "[psion level 1+]",
        speed: { walk: { spd: "+10", enc: "+10" } },
        source: [["GMB:LL", 0]],
      },
      "celerity ii": {
        name: "Celerity II",
        submenu: "[psion level 5+]",
        description: desc([
          "prereq: 5th-Level Psion, Celerity I",
          "My speed additional +5 feet, I ignore difficult terrain on dash or disingage and I can move across liquids and vertical surfaces without falling until the end of my turn.",
        ]),
        speed: { walk: { spd: "+5", enc: "+5" } },

        prereqeval: function () {
          return classes.known["psion(laserllama)"].level >= 5;
        },
      },
      "celerity iii": {
        name: "Celerity III",
        submenu: "[psion level 11+]",
        description: desc([
          "prereq: 11th-Level Psion, Celerity I, II",
          "My speed additional +5 feet, I became invisible on dash or disingage until I stop moving or until the end of my turn.",
        ]),
        speed: { walk: { spd: "+5", enc: "+5" } },

        prereqeval: function () {
          return classes.known["psion(laserllama)"].level >= 11;
        },
      },
      "celerity iv": {
        name: "Celerity IV",
        submenu: "[psion level 16+]",
        description: desc([
          "prereq: 16th-Level Psion, Celerity I, II, III",
          "I can take a second action but only for dash, disingage or dodge.",
        ]),
        prereqeval: function () {
          return classes.known["psion(laserllama)"].level >= 16;
        },
      },
      "iron durability i": {
        name: "Iron Durability I",
        description: desc([
          "Without armor, my AC is 10 + Constitution modifier + Intelligence modifier + shield",
        ]),
        submenu: "[psion level 1+]",
        source: [["GMB:LL", 0]],
        armorOptions: [
          {
            regExpSearch: /^(?=.*(iron))(?=.*durability)(?=.*i).*$/i,
            name: "Iron Durability I",
            source: [["GMB:LL", 0]],
            ac: "10+Con+Int",
            dex: -10,
            affectsWildShape: true,
            selectNow: true,
            type: "light",
          },
        ],
        armorAdd: "Iron Durability I",
      },
      "iron durability ii": {
        name: "Iron Durability II",
        description: desc([
          "prereq: 5th-Level Psion, Iron Durability I",
          "As a bonus action I gain temp hp to equal my Int Mod (min of 1).",
        ]),
        submenu: "[psion level 5+]",
        source: [["GMB:LL", 0]],
        action: ["bonus action", ""],
        prereqeval: function () {
          return classes.known["psion(laserllama)"].level >= 5;
        },
      },
      "iron durability iii": {
        name: "Iron Durability III",
        description: desc([
          "prereq: 11th-Level Psion, Iron Durability I, II",
          "As a reaction I can spend 3 Psi Points ot gain resistance of to the incoming damage's type.",
          "The resistance last until I use this ability again.",
        ]),
        submenu: "[psion level 11+]",
        source: [["GMB:LL", 0]],
        action: ["reaction", ""],
        prereqeval: function () {
          return classes.known["psion(laserllama)"].level >= 11;
        },
      },
      "iron durability iv": {
        name: "Iron Durability IV",
        description: desc([
          "prereq: 16th-Level Psion, Iron Durability I, II, III",
          "I have resistance to all bludgeoning, piercing, slashing damage.",
          "Whenever I take damage, it is reduced by an amount equal to my Int Mod (min of 1).",
        ]),
        submenu: "[psion level 16+]",
        source: [["GMB:LL", 0]],
        prereqeval: function () {
          return classes.known["psion(laserllama)"].level >= 16;
        },
        dmgres: ["Bludgeoning", "Piercing", "Slashing"],
      },
      "metamorphosis i": {
        name: "Metamorphosis I",
        description: desc([
          "I learn the psionic strike Cantrip. I can use my Intelligence for that Cantrip, Strength checks and unarmed strikes.",
        ]),
        submenu: "[psion level 1+]",
        source: [["GMB:LL", 0]],
        spellcastingBonus: [
          {
            name: "Metamorphosis I",
            firstCol: "M1C",
            spells: ["psionic strike"],
            selection: ["psionic strike"],
            times: 1,
          },
        ],
        spellChanges: {
          "psionic strike": {
            changes:
              "You can use Intelligence instead of Strength to calculate the damage of this spell.",
          },
        },
      },
      "metamorphosis ii": {
        name: "Metamorphosis II",
        description: desc([
          "prereq: 5th-Level Psion, Metamorphosis I",
          "As a bonus action I can spend 2 Psi Points to change my size (Large or Tiny) unitl 1 min or incapacitated or bonus action to end it.",
          "Large (temp hp equal to my Int Mod, +1d4 damage melee atks, adv on Str checks and saves).",
          "Tiny (I can move through 6-inches space w/out squeeze, bonus on Stealth checks equal to my Int Mod -min of 1-).",
        ]),
        submenu: "[psion level 5+]",
        source: [["GMB:LL", 0]],
        action: [
          ["bonus action", "Meta. Large (start)"],
          ["bonus action", "Meta. Large (end)"],
          ["bonus action", "Meta. Tiny (start)"],
          ["bonus action", "Meta. Tiny (end)"],
        ],
        prereqeval: function () {
          return classes.known["psion(laserllama)"].level >= 5;
        },
      },
      "metamorphosis iii": {
        name: "Metamorphosis III",
        description: desc([
          "prereq: 11th-Level Psion, Metamorphosis I, II",
          "As a bonus action I can spend 4 Psi Points to cast Polymorph (LL) targeting myself.",
        ]),
        submenu: "[psion level 11+]",
        source: [["GMB:LL", 0]],
        action: [["bonus action", "Meta. III Polymorph"]],
        spellcastingBonus: [
          {
            name: "Metamorphosis III",
            firstCol: "M-3",
            spells: ["polymorph"],
            selection: ["polymorph"],
            times: 1,
          },
        ],
        spellChanges: {
          "polymorph": {
            changes:
              "You can cast it only targeting yourself" +
              "\n   " +
              "You retain your mental ability scores, the ability to use Psionics, and any Awakening features or Mystic Talents that your new form is physically capable of using with its anatomy.",
          },
        },
        prereqeval: function () {
          return classes.known["psion(laserllama)"].level >= 11;
        },
      },
      "metamorphosis iv": {
        name: "Metamorphosis IV",
        description: desc([
          "prereq: 16th-Level Psion, Metamorphosis I, II, III",
          "As a bonus action I can spend 5 Psi Points to change my size (Huge or Diminutive) unitl 1 min or incapacitated or bonus action to end it.",
          "Huge (temp hp equal to twice my Int Mod, +2d6 damage melee atks, adv on Str checks and saves).",
          "Diminutive (1-inch height, I cannot makes weapon atks, bonus on Stealth checks equal to my Psion Level).",
        ]),
        submenu: "[psion level 16+]",
        source: [["GMB:LL", 0]],
        action: [
          ["bonus action", "Meta. Huge (start)"],
          ["bonus action", "Meta. Huge (end)"],
          ["bonus action", "Meta. Diminutive (start)"],
          ["bonus action", "Meta. Diminutive (end)"],
        ],
        prereqeval: function () {
          return classes.known["psion(laserllama)"].level >= 16;
        },
      },
      "precognition i": {
        name: "Precognition I",
        description: desc([
          "I cannot be surprised unless unconscious, asleep or incapacitated. I have a bonus to my initiative rolls equal to my Intelligence modifier (minimun of +1)",
        ]),
        submenu: "[psion level 1+]",
        source: [["GMB:LL", 0]],
      },
      "precognition ii": {
        name: "Precognition II",
        description: desc([
          "prereq: 5th-Level Psion, Precognition I",
          "When I am hit by an attack I can see, I can use my reaction to have 1d4 bonus on my AC against that attack.",
        ]),
        submenu: "[psion level 5+]",
        source: [["GMB:LL", 0]],
        action: [["reaction", "Precognition II"]],
        prereqeval: function () {
          return classes.known["psion(laserllama)"].level >= 5;
        },
      },
      "precognition iii": {
        name: "Precognition III",
        description: desc([
          "prereq: 11th-Level Psion, Precognition I, II",
          "As a bonus action, I can enter a state (con. on it like a spell). For duration, I add 1d4 to checks, attacks amd saves.",
        ]),
        submenu: "[psion level 11+]",
        source: [["GMB:LL", 0]],
        action: [["bonus action", "Precognition III"]],
        prereqeval: function () {
          return classes.known["psion(laserllama)"].level >= 11;
        },
      },
      "precognition iv": {
        name: "Precognition IV",
        description: desc([
          "prereq: 16th-Level Psion, Precognition I, II, III",
          "As a reaction, when rolling initiative, I can take a turn before any other creatures." +
          "Additionally, when in precognitive state I gain an additional reaction each round, but only one reaction per trigger.",
        ]),
        submenu: "[psion level 16+]",
        source: [["GMB:LL", 0]],
        action: [["reaction", "Precognition IV"]],
        prereqeval: function () {
          return classes.known["psion(laserllama)"].level >= 16;
        },
      },
      "restoration i": {
        name: "Restoration I",
        description: desc([
          "I have a Restoration Pool hit points equal my Psion Level x5. As an action, I can touch a creature to restore its HP up to what left in my pool",
        ]),
        submenu: "[psion level 1+]",
        source: [["GMB:LL", 0]],
        action: [["action", "Restoration Talent"]],
        extraLimitedFeatures: [
          {
            name: "Rest. Pool Points",
            usages: levels.map(function (n) {
              return n * 5;
            }),
            recovery: "long rest",
          },
        ],
      },
      "restoration ii": {
        name: "Restoration II",
        description: desc([
          "prereq: 5th-Level Psion, Restoration I",
          "As an action, I can touch a creature to end blinded, charmed, defened, frightened,paralyzed, poisoned and/or stunned condition per 5 Restoration Pool points each." +
          "I can use my other Restoration Talent powers as part of one touch, expending points for each effect.",
        ]),
        submenu: "[psion level 5+]",
        source: [["GMB:LL", 0]],
        prereqeval: function () {
          return classes.known["psion(laserllama)"].level >= 5;
        },
      },
      "restoration iii": {
        name: "Restoration III",
        description: desc([
          "prereq: 11th-Level Psion, Restoration I, II",
          "As an action, I can touch a dead creature died no longer than 10 minutes, spending 10 Restoration Pool Points, to bring it back to life with 1 Hit Point, that is not died of old age or natural causes." +
          "I can use my other Restoration Talent powers as part of one touch, expending points for each effect.",
        ]),
        submenu: "[psion level 11+]",
        source: [["GMB:LL", 0]],
        prereqeval: function () {
          return classes.known["psion(laserllama)"].level >= 11;
        },
      },
      "restoration iv": {
        name: "Restoration IV",
        description: desc([
          "prereq: 16th-Level Psion, Restoration I, II, III",
          "I can use my Restoration Talent powers on any once creature that I can see within 120 feet." +
          "As an action, with 10 Restoration Pool Points, I can end the following effects: petrified, on level one level of exhaustation, reduction to an ability score or reduction to hit point maximum.",
        ]),
        submenu: "[psion level 16+]",
        source: [["GMB:LL", 0]],
        prereqeval: function () {
          return classes.known["psion(laserllama)"].level >= 16;
        },
      },
      "telekinesis i": {
        name: "Telekinesis I",
        description: desc([
          "I learn the mage hand Cantrip. It can use my Intelligence instead of Strength and some extras.",
        ]),
        submenu: "[psion level 1+]",
        source: [["GMB:LL", 0]],
        spellcastingBonus: [
          {
            name: "Telekinesis I",
            firstCol: "TkI",
            spells: ["mage hand"],
            selection: ["mage hand"],
            times: 1,
          },
        ],
        spellChanges: {
          "mage hand": {
            changes:
              "You can cast it without V,S components." +
              "\n   " +
              "The hand is invisible and is capable of anything you can would be capable of doing with one of your hands, including shoving, grappling, and using tools. However, it uses my Intelligence, in place of my Strength, for ability checks." +
              "\n   " +
              "The hand can push, pull, drag, or lift a number of pounds equals ot 10 times your Intelligence score (minimum of 10).",
          },
        },
      },
      "telekinesis ii": {
        name: "Telekinesis II",
        description: desc([
          "prereq: 5th-Level Psion, Telekinesis I",
          "When I manifest mage hand, I manifest two hands that use the rules of Telekinesis I.",
        ]),
        submenu: "[psion level 5+]",
        source: [["GMB:LL", 0]],
        spellChanges: {
          "mage hand": {
            changes:
              "You manifest two hands instead of one." +
              "\n   " +
              "You can move one of the hands as an action or bonus action (but not both). If the mage hands are in the same space you can use both of them together, andthey are capable of anything you would be capable of doingwith both of your hands at one time." +
              "\n   " +
              "If they are in the same space and used together, the mage hands can push, pull, drag, or lift a number of pounds equal to 30 times your Intelligence score (minimum of 30).",
          },
        },
        prereqeval: function () {
          return classes.known["psion(laserllama)"].level >= 5;
        },
      },
      "telekinesis iii": {
        name: "Telekinesis III",
        description: desc([
          "prereq: 11th-Level Psion, Telekinesis I, II",
          "I learn the Telekinesis spell. I can cast it w/out V,S conponents (but I always need to spend Psi Points to cast it), and it last as long as I can mantain concentration.",
        ]),
        submenu: "[psion level 11+]",
        source: [["GMB:LL", 0]],
        spellcastingBonus: [
          {
            name: "Telekinesis III",
            firstCol: "TkIII",
            spells: ["telekinesis"],
            selection: ["telekinesis"],
            times: 1,
          },
        ],
        spellChanges: {
          telekinesis: {
            changes:
              "You  cast it without V,S components." +
              "\n   " +
              "It last as long as You can mantain concentration.",
          },
        },
        prereqeval: function () {
          return classes.known["psion(laserllama)"].level >= 11;
        },
      },
      "telekinesis iv": {
        name: "Telekinesis IV",
        description: desc([
          "prereq: 16th-Level Psion, Telekinesis I, II, III",
          "I can cast Telekinesis at will without spending Psi Points (regardless of Telekinesis III).",
          "Whenever I make a check by Mage Hand or Telekinesis, I can spend 1 Psi Points to gain advantage on the roll.",
        ]),
        submenu: "[psion level 16+]",
        source: [["GMB:LL", 0]],
        prereqeval: function () {
          return classes.known["psion(laserllama)"].level >= 16;
        },
      },
      "telepathy i": {
        name: "Telepathy I",
        description: desc([
          "I can communicate with any crea I can see w/in 60 feet that can speak at least a language. I can telepathic fullfill V component for one of the spells' targets so long It fullfill the Telepathy I requirements.",
        ]),
        submenu: "[psion level 1+]",
        source: [["GMB:LL", 0]],
      },
      "telepathy ii": {
        name: "Telepathy II",
        description: desc([
          "prereq: 5th-Level Psion, Telepathy I",
          "The range of my telepathy becomes 1000 feet." +
          "As an action I can telepatically link creatures eligible for Telepathy I up to my Int Mod to a Telepathic Network. Linked creature can communicate telepathically while within 1000 feet of me.",
        ]),
        submenu: "[psion level 5+]",
        source: [["GMB:LL", 0]],
        action: [["action", "Telepathic Network"]],
        prereqeval: function () {
          return classes.known["psion(laserllama)"].level >= 5;
        },
      },
      "telepathy iii": {
        name: "Telepathy III",
        description: desc([
          "prereq: 11th-Level Psion, Telepathy I, II",
          "The range of my telepathy becomes 1 mile." +
          "I can link a creature I cannot see only if it was linked previously to my Telepathic Network.",
        ]),
        submenu: "[psion level 11+]",
        source: [["GMB:LL", 0]],
        prereqeval: function () {
          return classes.known["psion(laserllama)"].level >= 11;
        },
      },
      "telepathy iv": {
        name: "Telepathy IV",
        description: desc([
          "prereq: 16th-Level Psion, Telepathy I, II, III",
          "My telepathy has no range limit." +
          "Whenever a creature linked to my Telepathic Network is forced to make a save I can use my reaction, and expending 1 Psi Point, to add my Int Mod to the result of the roll.",
        ]),
        submenu: "[psion level 16+]",
        source: [["GMB:LL", 0]],
        action: [["reaction", "TN Save Bonus"]],
        prereqeval: function () {
          return classes.known["psion(laserllama)"].level >= 16;
        },
      },
    },
    "subclassfeature1.2": {
      name: "Mystical Precision",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description:
        "\n   " +
        "Whenever I manifest a Psion spell, I can expend 1 additional Psi Point to manifest it without providingthe spell's V and/or S components, or manifesting any of the normal outward signs of your Psionics.",
    },
    "sublcassfeature1.3": {
      name: "Focused Psioncs",
      source: [["GMB:LL", 0]],
      minlevel: 6,
      description:
        "\n   " +
        "Whenever I deal damage with a Psion spell or Mystic Talent, I can add my Int Mod(minimum of +1) to one damage roll, if I do not already.",
    },
    "sublcassfeature1.4": {
      name: "Telekinetic Flight",
      minlevel: 14,
      source: [["GMB:LL", 0]],
      description:
        "I gain flying speed equal to my walking speed. While flying this way, the air around me shimmers with ambient psionic power, and rocks, dirt, and other small loose objects rise from the ground to float around you. ",
      speed: { fly: { spd: "walk", enc: 0 } },
    },
    "sublcassfeature1.5": {
      name: "Ascended Form",
      minlevel: 14,
      source: [["GMB:LL", 0]],
      description:
        "As a bonus action, I can take on an Ascended Form up to 1 minute, I am incapacitated, or if I end it with a bonus action. While in this form I gain the following:" +
        "\n   - I become translucent and emit otherworldly brightlight, in a 5-foot radius, and dim light 5 feet beyond that." +
        "\n   - I gain resistance to all damage." +
        "\n   - My flying speed becomes 60 feet, unless it was higher." +
        "\n   - I gain the benefits of the Spectral Passage spell, but it does not require my concentration while in this form." +
        "\n Once I use this feature I must finish a long rest or expend 5 Psi Points to use it again.",
      action: [
        ["bonus action", "Ascended Form (start)"],
        ["bonus action", "Ascended Form (end)"],
      ],
      usages: 1,
      recovery: "long rest",
    },
  },
});

// Outsider
AddSubClass("psion(laserllama)", "outsider", {
  regExpSearch: /outsider/i,
  source: ["GMB:LL", 0],
  subname: "Outsider",
  features: {
    subclassfeature1: {
      name: "Outsider Spells",
      source: [["GMB:LL", 0]],
      minlevel: 1,
      description:
        "\n   " +
        "I learn certain spells. They are Psion spells for me and don't count against my total of spells known and can't be replaced when I gain a level",
      spellcastingBonus: [
        {
          name: "Outsider Spells (1st-level)",
          firstCol: "OS",
          spells: ["arms of hadar"],
          selection: ["arms of hadar"],
          times: 1,
        },
        {
          name: "Outsider Spells (3rd-level)",
          firstCol: "OS",
          spells: ["spider climb"],
          selection: ["spider climb"],
          times: levels.map(function (n) {
            return n < 3 ? 0 : 1;
          }),
        },
        {
          name: "Outsider Spells (5th-level)",
          firstCol: "OS",
          spells: ["hunger of hadar"],
          selection: ["hunger of hadar"],
          times: levels.map(function (n) {
            return n < 5 ? 0 : 1;
          }),
        },
        {
          name: "Outsider Spells (7th-level)",
          firstCol: "OS",
          spells: ["summon aberration"],
          selection: ["summon aberration"],
          times: levels.map(function (n) {
            return n < 7 ? 0 : 1;
          }),
        },
        {
          name: "Outsider Spells (9th-level)",
          firstCol: "OS",
          spells: ["contact other plane"],
          selection: ["contact other plane"],
          times: levels.map(function (n) {
            return n < 9 ? 0 : 1;
          }),
        },
      ],
    },
    "subclassfeature1.1": {
      name: "Aberrant Form",
      source: [["GMB:LL", 0]],
      minlevel: 1,
      description:
        "\n   " +
        "When I have 0 Psi Poits I instantly transform into my Aberrant Form (Small or Medium, my choice) and remain in it until I regain at least 1 Psi Points." +
        "\n I can also expend all my remaining Psi Points as an action to mutate.",
      action: [
        levels.map(function (n) {
          return n < 3 ? "action" : "bonus action";
        }),
        "",
      ],
      creaturesAdd: [["Aberrant Form", true]],
      creatureOptions: [
        {
          name: "Aberrant Form",
          source: [["MHB:LL", 0]],
          size: [4, 3],
          type: "Aberration",
          subtype: "Shapechanger",
          alignment: "",
          ac: "10+Int+Prof",
          scores: [],
          hd: [],
          speed: "30 ft, climb 30 ft, swim 30 ft",
          languages:
            "Deep Speech. I can understand leanguage I know but cannot speak them",
          proficiencyBonusLinked: true,
          savesLinked: true,
          scoresLinked: true,
          sense: "My normal senses",
          attacksAction: 1,
          attacks: [
            {
              name: "Tentacle",
              ability: 4,
              damage: [1, 8, "psychic"],
              range: "5 ft",
              description: "Melee weapon attack. ",
              modifiers: ["Int", "Prof"],
              abilitytodamage: false,
              useSpellMod: "psion(laserllama)",
            },
          ],
          features: [
            {
              name: "Aberrant Vigor",
              description:
                "The first time I transform into this Aberrant Form between each short or long rest, i gain temporary hit points equal to twice my Psion level, which only last while I am in Aberrant Form.",
            },
            {
              name: "Alien Influence",
              description:
                "I cannot concentrate on spells or other abilities while I am in my Aberrant Form.",
            },
            {
              name: "Improved Alien Influence",
              description:
                "If I have at least 1 Psi Point, I can concentrate on spells, features, and Talent while I am in my Aberrant Form, and I can revert to my normal form as a bonus action.",
              minlevel: 3,
            },
          ],
          actions: [
            {
              name: "Tentacle Grasp",
              description:
                "When I hit a creature with my tentacle, I can automatically grapple a creature equal to me in size, or smaller. As an action, the grappled creature can make a Strength save, escaping on a success.",
            },
            {
              name: "Improved Tentacle Grasp",
              description:
                "If a creature starts its turn grappled by my Aberrant Form. it takes 1d4 Psychic damage.",
              minlevel: 6,
            },
          ],
          traits: [
            {
              name: "My Aberrant Self",
              description:
                "This form uses my proficiency bonus (PB), Intelligence modifier (INT), and Psion Spell save DC. I retain my ability scores, alignment, personality, skill and saving throw proficiencies, and all other features from my race, class, and other sources (such as Feats and curses).",
            },
          ],
          header: "Aberrant Form",
        },
      ],
    },
    "sublcassfeature1.2": {
      name: "Psionic Control",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description:
        "\n   " +
        "While I have more than 0 Psi Points, I can mutate in or revert back from my Aberrant Form w/out expending Psi Points as a bonus action and I can concentrate on Psion spells, features and Talents while in that form.",
    },
    "sublcassfeature1.3": {
      name: "Extra Attack",
      minlevel: 6,
      source: [["GMB:LL", 0]],
      description:
        "I can attack twice, whenever you take the Attack action on my turn. \nMoreover, if I use my action to manifest a Psion spell or Mystic Talent, I can make a single weapon attack or the Tentacle attack as a bonus action on that turn." +
        "\n Also, whenever a creature starts its turn grappled by my Aberrant Form. it takes 1d4 Psychic damage.",
    },
    "sublcassfeature1.4": {
      name: "Eldritch Rift",
      minlevel: 14,
      source: [["GMB:LL", 0]],
      description:
        "Immediately after I expend 1 or more Psi Points, I can teleport to an occupied space of my choice I can see within 30 feet of me.",
    },
    "sublcassfeature1.5": {
      name: "Glimpse Beyond the Veil",
      minlevel: 18,
      source: [["GMB:LL", 0]],
      description:
        "As an action, I can force a creature I can see w/in 60 feet to make a Charisma save agains my Spell DC or disappear into an abberrant void. At the end of my next turn it returns to the space it previously occupied or the nearest unoccupied space. If the creature is not an aberration it takes 10d12 Psychic damage when it returns. On a successful save, the creature is immune to this effect for 24 hours." +
        "\n   Once I ust this feature I cannot use it again unti I finish a rest or I expend 5 Psi Points to use it again.",
      action: ["bonus action", "Glimpse Beyond the Veil"],
    },
  },
});

// Visionary
AddSubClass("psion(laserllama)", "visionary", {
  regExpSearch: /visionary/i,
  source: ["GMB:LL", 0],
  subname: "Visionary",
  features: {
    subclassfeature1: {
      name: "Visionary Spells",
      source: [["GMB:LL", 0]],
      minlevel: 1,
      description:
        "\n   " +
        "I learn certain spells. They are Psion spells for me and don't count against my total of spells known and can't be replaced when I gain a level",
      spellcastingBonus: [
        {
          name: "Visionary Spells (1st-level)",
          firstCol: "VS",
          spells: ["silent image"],
          selection: ["silent image"],
          times: 1,
        },
        {
          name: "Visionary Spells (3rd-level)",
          firstCol: "VS",
          spells: ["blur"],
          selection: ["blur"],
          times: levels.map(function (n) {
            return n < 3 ? 0 : 1;
          }),
        },
        {
          name: "Immortal Spells (5th-level)",
          firstCol: "VS",
          spells: ["haste"],
          selection: ["haste"],
          times: levels.map(function (n) {
            return n < 5 ? 0 : 1;
          }),
        },
        {
          name: "Immortal Spells (7th-level)",
          firstCol: "VS",
          spells: ["death ward"],
          selection: ["death ward"],
          times: levels.map(function (n) {
            return n < 7 ? 0 : 1;
          }),
        },
        {
          name: "Immortal Spells (9th-level)",
          firstCol: "VS",
          spells: ["mislead"],
          selection: ["mislead"],
          times: levels.map(function (n) {
            return n < 9 ? 0 : 1;
          }),
        },
      ],
    },
    "subclassfeature1.1": {
      name: "Psionic Projection",
      source: [["GMB:LL", 0]],
      minlevel: 1,
      description:
        "\n   " +
        "As an action I can create an exact copy of a non magical, inanimate, object that I have seen before." +
        "\n When I make The object has an AC equal to my Int score, it persist until destroyed, I use an action to touch it and destroy it, or I create another Psionic Projection." +
        "\n The projection follow the depending on the Psi Points I expend when I create it:" +
        "\n  - 0 Psi Point: Tiny size, psion level HP; " +
        "\n  - 1 Psi Point: Small size, 10+psion level HP; " +
        "\n  - 2 Psi Point: Medium size, 20+psion level HP; " +
        "\n  - 3 Psi Point: Large size, 30+psion level HP; " +
        "\n  - 5 Psi Point: Huge size, 50+psion level HP;",
      action: [["action", ""]],
    },
    "sublcassfeature1.2": {
      name: "Deadly Projections",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description:
        "\n   " +
        "When I create a Projection I can launcht it at a target I can see w/in 60 feet. It takes 2d6 force damage plus 2d6 for every Psi Points I expended to create the Projection. On a succes it takes half damage. Success or failure, the projection is destroyed on impact.",
    },
    "sublcassfeature1.3": {
      name: "Projected Defense",
      minlevel: 6,
      source: [["GMB:LL", 0]],
      description:
        "When I am targeted by an attack I can see, I can use my reaction to create a defensive Psionic Projection of appropriate size between me and the attacker. The projection becomes the target of the attack in my place." +
        "\n If the triggering attack destroy the projection, I take any remaining damage.",
      action: [["reaction", ""]],
    },
    "sublcassfeature1.4": {
      name: "Greater Vision",
      minlevel: 14,
      source: [["GMB:LL", 0]],
      description:
        "I expend 1 Psi Point less to create a Psionic Projection (minimun of 0). Also, I can expend 1 additional Psi Point to grant my projection resistance to non-magical bludgeoning, piercing and slashing damage." +
        "\n Finally, I can have up to three projections but when I create a fourth one, I must choose to instantly destroy one of my projections.",
    },
    "sublcassfeature1.5": {
      name: "Visionary Journey",
      minlevel: 18,
      source: [["GMB:LL", 0]],
      description:
        "I learn the Astral Projections spell but it does not count against my total number of Spell Known." +
        "\n Once per long rest, I can cast this spell as an action w/out expendin Psi Points or material components. If I do so, the astral form appears w/in 5 feet of my body." +
        "\n Me and the astral form share one pool of Psi Points, and my body cannot take short or long rest while I use this spell." +
        "When I have no use left I can expend 5 Psi Points to cast Astral Projection in this way again.",
      action: [["action", ""]],
      spellcastingBonus: [
        {
          name: "Visionary Journey",
          firstCol: "VS",
          spells: ["astral projection"],
          selection: ["astral projection"],
          times: 1,
        },
      ],
      usages: 1,
      recovery: "long rest",
    },
  },
});

// Wilder
AddSubClass("psion(laserllama)", "wilder", {
  regExpSearch: /wilder/i,
  source: ["GMB:LL", 0],
  subname: "Wilder",
  features: {
    subclassfeature1: {
      name: "Wilder Spells",
      source: [["GMB:LL", 0]],
      minlevel: 1,
      description:
        "\n   " +
        "I learn certain spells. They are Psion spells for me and don't count against my total of spells known and can't be replaced when I gain a level",
      spellcastingBonus: [
        {
          name: "Wilder Spells (1st-level)",
          firstCol: "WS",
          spells: ["tasha's hideous laughter"],
          selection: ["tasha's hideous laughter"],
          times: 1,
        },
        {
          name: "Wilder Spells (3rd-level)",
          firstCol: "WS",
          spells: ["crown of madness"],
          selection: ["creown of madness"],
          times: levels.map(function (n) {
            return n < 3 ? 0 : 1;
          }),
        },
        {
          name: "Wilder Spells (5th-level)",
          firstCol: "WS",
          spells: ["cerebral blast"],
          selection: ["cerebral blast"],
          times: levels.map(function (n) {
            return n < 5 ? 0 : 1;
          }),
        },
        {
          name: "Wilder Spells (7th-level)",
          firstCol: "WS",
          spells: ["confusion"],
          selection: ["confusion"],
          times: levels.map(function (n) {
            return n < 7 ? 0 : 1;
          }),
        },
        {
          name: "Wilder Spells (9th-level)",
          firstCol: "WS",
          spells: ["synaptic static"],
          selection: ["synaptic static"],
          times: levels.map(function (n) {
            return n < 9 ? 0 : 1;
          }),
        },
      ],
    },
    "subclassfeature1.1": {
      name: "Inscrutable Psyche",
      source: [["GMB:LL", 0]],
      minlevel: 1,
      description:
        "\n   " +
        "Whenever I am forced to make a Intelligence, Wisdom, or Charisma saving throw, I can expend 1 Psi Point as a reaction to roll with advantage." +
        "\n If I succeed, the creature who forced me to make this saving throw takes psychic damage equal to my Psion level.",
      action: [["reaction", ""]],
    },
    "subclassfeature1.2": {
      name: "Wild Psionics",
      source: [["GMB:LL", 0]],
      minlevel: 1,
      description:
        "\n   " +
        "Immediately after I expend 1 or more Psi Points, I roll a d6. If the result is equal to the Psi Points I expended, I roll a d100 on my Psionic Surge table.",

      toNotesPage: [
        {
          name: "Psionic Surge Table",
          source: [["HMB:LL", 0]],
          popupName: "Wilder's Psionic Surge Table, part 1",
          additional: "results 01-50",
          note: [
            "My Psionics can unleash surges of untamed psionic. Immediately after I expend 1 or more Psi Point, I roll a d6. If I roll a number equal to the Psi Points I expended, a Psionic Surge happens. Roll on the table below to create a random magical effect.",
            "If a Psionic effect is a spell, I am the target of or center of that spell, it use my Psion Spell save DC, and the spell effect persist on its own even if it would normally require concentration.",
            "d100  Effect",
            "01-02 Roll on this table at the start of each of your turns for 1 minute, ignoring this result on subsequent rolls.",
            "03-04 For the next minute, you can see any invisible creature if you have line of sight to it.",
            "03-05 You manifest magic missile at 5th-level targeting random creatures in range.",
            "06-08 You are the target of a levitate spell.",
            "09-11 You teleport to a random unoccupied space you can see within 60 feet.",
            "12-14 You can speak only in Deep Speech for the next 10 minutes.",
            "15-17 You gain 1d20 temporary hit points.",
            "18-20 You leave footprints that glow with an otherworldly light for the next hour.",
            "21-23 You gain the benefits of the jump (LL) spell.",
            "24-26 You manifest disguise self, taking on the appearance of the nearest humanoid.",
            "27-29 You float 1d10 inches off the ground for the next hour.",
            "30-32 Your skin is translucent for 1 minute.",
            "33-35 You are the target of a confusion spell.",
            "36-38 You loose all distinctive features and appear as an average member of your race.",
            "39-41 You emit bright light in out to a 10-foot radius for 1 minute.",
            "42-44 You briefly see a fond childhood memory of a random creature within 60 feet.",
            "45-47 You know every spell on the Psion spell list for the next minute.",
            "48-50 You gain resistance to all damage for 1 minute.",
          ],
        },
        {
          name: "Psionic Surge Table",
          source: [["HMB:LL", 0]],
          popupName: "Wilder's Psionic Surge Table, part 2",
          additional: "results 51-100",
          note: [
            "d100  Effect",
            "51-53 Up to three creatures of your choice you can see within 30 feet take 4d10 psychic damage.",
            "54-56 You regain all expended Hit Dice.",
            "57-59 Your Strength score becomes 4 for 1 minute.",
            "60-62 You are the target of a sleep spell cast at a level equal to the number of Psi Points that triggered this Surge.",
            "63-65 For 1 minute, you can see into the Ethereal Plane out to a 30-foot radius.",
            "66-68 You are the target of a grease spell.",
            "69-71 You are frightened by the nearest creature until the end of your next turn.",
            "72-74 You are the target of a hypnotic pattern spell.",
            "75-77 You regain expended Psi Points equal to your Intelligence modifier.",
            "78-80 For 1 minute, you regain 1 Psi Point at the start of each of your turns.",
            "81-83 You can immediately take one extra action.",
            "84-86 You are the target of a blur spell.",
            "87-89 A fly spell manifests on a random creature within 60 feet of you.",
            "90-92 The first spell you manifest in the next miniute deals maximum possible damage.",
            "93-95 For 1 minute, you can teleport up to 20 feet to an unoccupied space you can see as a bonus action.",
            "96-98 You are the target of an invisibility spell.",
            "99-100 You regain all expended Psi Points.",
          ],
        },
      ],
    },
    "sublcassfeature1.3": {
      name: "Psionic Eruption",
      source: [["GMB:LL", 0]],
      minlevel: 3,
      description:
        "\n   " +
        "When I am hit by an attack or failing a save, I can use a reaction to expend Psi Points forcing creatures w/in the range of this feature to make an Intelligence saving throw. They take 1d12 psychic damage per Psi Point expended on a fail, and half on a success.",
      additional: [
        "",
        "",
        "10 feet radius",
        "10 feet radius",
        "10 feet radius",
        "10 feet radius",
        "10 feet radius",
        "10 feet radius",
        "10 feet radius",
        "10 feet radius",
        "10 feet radius",
        "10 feet radius",
        "10 feet radius",
        "20 feet radius",
        "20 feet radius",
        "20 feet radius",
        "20 feet radius",
        "30 feet radius",
        "30 feet radius",
        "30 feet radius",
      ],
      action: [["reaction", ""]],
    },
    "sublcassfeature1.4": {
      name: "Psychic Storm",
      minlevel: 6,
      source: [["GMB:LL", 0]],
      description:
        "Whenever I manifest a Psion spell that deals damage, I gain a 1d8 bonus to one damage roll of that spell.",
    },
    "sublcassfeature1.5": {
      name: "Mental Torrent",
      minlevel: 14,
      source: [["GMB:LL", 0]],
      description:
        "When I force a creature within the range of this feature to make an Intelligence, Wisdom, or Charisma savingthrow to resist the effects of a Psion spell, Psion feature, or a Mystic Talent, it has disadvantage on its initial roll.",
      additional: [
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "",
        "15 feet radius",
        "15 feet radius",
        "15 feet radius",
        "15 feet radius",
        "30 feet radius",
        "30 feet radius",
        "30 feet radius",
      ],
    },
    "sublcassfeature1.6": {
      name: "Controlled Surge",
      minlevel: 14,
      source: [["GMB:LL", 0]],
      description:
        "Whenever I trigger a Psionic Surge, I roll twice on the Psionic Surge table and choose which effect takes place." +
        "\n In addition, when I use Psionic Eruption, only creature sof my choice must make the Intelligence saving throw.",
    },
    "sublcassfeature1.7": {
      name: "Unleashed Wilder",
      minlevel: 18,
      source: [["GMB:LL", 0]],
      description:
        "When I roll damage for a Psion spell and roll the highest possible result on any of the damage dice, I roll that die again, and add its result to the total damage roll of the spell, continuing until I do not roll the highest possible result on that die.",
    },
  },
});

// Feats from Alternate Fighter Extended
FeatsList["alternate defensive duelist"] = {
  name: "Alternate Defensive Duelist",
  source: [["GMB:LL"]],
  descriptionFull:
    "When a creature you can see hits you with a melee attack while you are wielding a finesse weapon you are proficient with, you can use a reaction to add your Dexterity modifier (minimum of +1) to your Armor Class against that attack. If this bonus to your Armor Class would cause the attack to miss, you can make an attack with that finesse weapon against the attacker as part of the same reaction.",
  description:
    "When wielding a finesse weapon with which I am proficient and another creature hits me with a melee attack, I can use my reaction to add my Dexterity modifier to my AC for that attack. If this causes the attack to miss me, I can make an attack with it as part of the reaction.",
  prerequisite: "Dexterity 13 or higher",
  prereqeval: function (v) {
    return What("Dex") >= 13;
  },
  action: ["reaction", " (when hit in melee)"],
};

FeatsList["Weapon Adept"] = {
  name: "Weapon Adept",
  source: [["GMB:LL"]],
  descriptionFull:
    "You have spent many hours honing your skills with the deadly armaments of war. You gain the benefits listed below:\n \u2022 Increase your Strength, Dexterity or Constitution score by 1, to a maximum of 20.\n \u2022 You gain proficiency with all simple and martial weapons.",
  description:
    "I gain proficiency with all simple or martial weapons [+1 Strength, Dexterity or Constitution]",
  weaponProfs: [true, true],
  scorestxt: "+1 Strength, Dexterity or Constitution",
};

FeatsList["alternate weapon master"] = {
  name: "Alternate Weapon Master",
  source: [["GMB:LL"]],
  descriptionFull: desc([
    "You wield weapons with a deadly efficiency that is impressive even to most trained warriors. Choose a number of simple ormartial weapons equal to your Proficiency Bonus. Wheneveryou make an attack with those weapons you gain a +1 bonus to both the attack and damage roll.",
    "As your Proficiency Bonus increases, you choose additional weapons to gain this benefit.",
  ]),
  description:
    "I choose up to my proficieny Bonus simple/martial weapons(when go up I choose one more), I gain +1 to damage and attack roll with the choosen weapons (write 'Master' in the weapon name to add the calc)",
  calcChanges: {
    atkAdd: [
      function (fields, v) {
        if (
          !v.isSpell &&
          !v.isDC &&
          fields.Proficiency &&
          /\bmaster\b/i.test(v.WeaponTextName)
        ) {
          if (v.SchematicsApplied) {
            fields.To_Hit_Bonus = Math.min(
              fields.To_Hit_Bonus + v.SchematicsApplied,
              4
            );
            fields.Damage_Bonus = Math.min(
              fields.Damage_Bonus + v.SchematicsApplied,
              4
            );
          } else {
            fields.To_Hit_Bonus += 1;
            fields.Damage_Bonus += 1;
          }
        }
      },
      "My Master weapon give me a +1 bonus to damage and attack rolls",
      750,
    ],
  },
};

FeatsList["signature technique"] = {
  name: "Signature Technique",
  source: [["GMB:LL"]],
  descriptionFull:
    "You have practiced and mastered a single technique so you can use it at will. Choose one 1st-degree Exploit you know is on the Fighter's list of Martial Exploits that forces a creature to make a saving throw or deals damage. Once on each of your turns, you can use this Signature Exploit, rolling a d4 in place of expending an Exploit Die. You can choose this Feat more than once, however, you are always limited to one Signature Exploit per turn.",
  description:
    "I mastered a single 1st-degree Exploit and can use it every turn, using a d4 instead of expending an Exploit Die. It has to be an exploit I know which causes damage or a saving throw.",
  prerequisite: "At least one Martial Exploit Known",
  allowDuplicates: true,
  prereqeval: function (v) {
    return (
      GetFeatureChoice(
        "classes",
        "fighter(laserllama)",
        "martial exploits",
        true
      ).length >= 1
    );
  },
};

FeatsList["alternate great weapon master"] = {
  name: "Alternate Great Weapon Master",
  source: [["GMB:LL"]],
  descriptionFull: desc([
    "You have honed your skills with massive weapons to overwhelm your foes. You gain the following benefits:",
    " \u2022 If you reduce a creature to 0 hit points or score a critical hit with a heavy melee weapon you can use a bonus action on that turn to make one attack with that same weapon.",
    " \u2022 Whenever you hit a creature that is equal to your size or smaller with a heavy melee weapon attack you can knock it back 5 feet away from you in a line, so long as the space that is behind it is unoccupied.",
  ]),
  description: desc([
    "When I reduce to 0 or crit a creature with a heavy melee weapon attack, I can make one attack with a bonus action that turn",
    "When I hit a creature equal or smaller than me in size, I knock it back 5 feet away from me in a line if there is space",
  ]),
  calcChanges: {
    atkAdd: [
      function (fields, v) {
        if (
          !v.isSpell &&
          !v.isDC &&
          fields.Proficiency &&
          /\bheavy\b/i.test(fields.Description)
        ) {
          fields.Description +=
            (fields.Description ? "; " : "") +
            " Knock 5 feet away if size equal or smaller than me (if space available)";
        }
      },
      "When I hit a creature equal or smaller than me in size, I knock it back 5 feet away from me in a line if there is space",
      750,
    ],
  },
  prerequisite: "Strength 13 or higher",
  prereqeval: function (v) {
    return What("Str") >= 13;
  },
};

const returnMartialTrainingExploit = function () {
  // Fixed attributes
  MartialExploits = {
    name: "Martial Training Exploits",
    minlevel: 2,
    source: [["GMB:LL", 0]],
    description: desc([
      "I gain Exploit Dice, which are used to fuel my Martial Exploits",
      'Use the "Choose Feature" button above to choose Martial Exploits',
    ]),
    toNotesPage: [
      {
        name: "Martial Exploits",
        note: desc([
          "Below are all Martial Exploits I know. Each 3rd and 4th degree exploits can only be used once per short rest. Each 5th degree exploit can only be used once per long rest.",
        ]),
      },
    ],

    // Martial Exploits
    extraname: "Martial Training Exploits",
    extraTimes: 2,
    extrachoices: [],
  };
  // Make a filtered spell list that contains only Fighter(laserllama) "spells"
  const FighterSpells = Object.keys(SpellsList)
    .filter((key) => SpellsList[key].isExploit && SpellsList[key].level == 1)
    .filter((key) => {
      for (var i = 0; i < SpellsList[key].classes.length; i++) {
        if (SpellsList[key].classes[i] == "fighter(laserllama)") return true;
      }
      return false;
      // NOTE: this is literally a SpellsList[key].classes.includes("fighter(laserllama)") but for some cursed reason I can't use that function
    });

  // Iterate over all Fighter(laserllama) "spells"
  for (var i = 0; i < FighterSpells.length; i++) {
    var NewSpell = SpellsList[FighterSpells[i]];
    var tempSpell = FighterSpells[i];

    MartialExploits.extrachoices.push(NewSpell.name); // Add "spell" name to menu options

    MartialExploits[FighterSpells[i]] = {
      // Add "spell" to the main item (when it is picked through the menu)
      name: NewSpell.name,
      toNotesPage: [
        {
          // What is added to the notes page
          name:
            NewSpell.name +
            " Exploit [" +
            (NewSpell.level == 1
              ? "1st"
              : NewSpell.level == 2
                ? "2nd"
                : NewSpell.level == 3
                  ? "3rd"
                  : NewSpell.level + "th") +
            " degree]",
          note: desc(NewSpell.descriptionFull),
          amendTo: "Martial Training Exploits",
        },
      ],
      source: NewSpell.source,
      addMod: NewSpell.addMod,
      submenu: NewSpell.submenu,
      prereqeval: ExploitPrereqFactory(FighterSpells[i], "fighter(laserllama)"),
      eval: CreateMartialSpellsheet,
      spellcastingBonusElsewhere: {
        addTo: "martial training exploits",
        spellcastingBonus: {
          name: "Martial Training Exploits",
          spellcastingAbility: 1,
          spells: [FighterSpells[i]],
          selection: [FighterSpells[i]],
        },
      },
    };
  }

  return MartialExploits;
};

FeatsList["martial training"] = {
  name: "Martial Training",
  source: [["GMB:LL"]],
  descriptionFull:
    "You have studied combat techniques that allow you to perform Martial Exploits. You gain the following benefits: You learn two 1st-degree Martial Exploits of your choice from those available to the Alternate Fighter. If an Exploit you use requires the target to make a saving throw to resist the effects, the DC is equal to 8 + your proficiency bonus + your Strength or Dexterity modifier (your choice). You gain two d4 Exploit Dice to fuel your Exploits. An Exploit Die is expended when you use it. You regain all of your Exploit Dice when you finish a short or long rest. If you already have Exploit Dice from another source, you only gain one Exploit Die equal to your other Exploit Dice.",
  description: "",
  calculate:
    "event.value = 'I learn two maneuvers of my choice from those available to the Fighter (2nd page \"Choose Feature\" button). The saving throw DC for this is ' + (8 + Number(How('Proficiency Bonus')) + Math.max(Number(What('Str Mod')), Number(What('Dex Mod')))) + ' (8 + proficiency bonus + Str/Dex mod). I gain two (only one if already have Exploit Die) Exploit dice (d4), which I regain when I finish a short rest.';",
  bonusClassExtrachoices: [
    {
      class: "fighter(laserllama)",
      feature: "martial exploits",
      bonus: 2,
      filter: function (aExploit) {
        return aExploit.level == 1;
      },
    },
  ],
  choices: ["Fighter", "Not a fighter"],
  selfChoosing: function () {
    // This function does not take into account other sources of exploit die, since this sheet is only about alt Fighter
    if (
      classes.known["fighter(laserllama)"] &&
      classes.known["fighter(laserllama)"].level >= 2
    ) {
      return "fighter";
    } else {
      return "not a fighter";
    }
  },
  fighter: {
    name: "Martial\u200A Training", // The special character is there to differentiate the feat versions
    description: "",
    calculate:
      "event.value = 'I learn two maneuvers of my choice from those available to the Fighter (2nd page \"Choose Feature\" button). The saving throw DC for this is ' + (8 + Number(How('Proficiency Bonus')) + Math.max(Number(What('Str Mod')), Number(What('Dex Mod')))) + ' (8 + proficiency bonus + Str/Dex mod). I gain one more Exploit die, which I regain when I finish a short rest.';",
    extraLimitedFeatures: [
      {
        name: "Exploit Dice",
        usages: 1,
        recovery: "short rest",
        addToExisting: true,
      },
    ],
  },
  "not a fighter": {
    name: "Martial\u200A\u200A Training",
    description: "",
    calculate:
      "event.value = 'I learn two maneuvers of my choice from those available to the Fighter (2nd page \"Choose Feature\" button). The saving throw DC for this is ' + (8 + Number(How('Proficiency Bonus')) + Math.max(Number(What('Str Mod')), Number(What('Dex Mod')))) + ' (8 + proficiency bonus + Str/Dex mod). I gain two Exploit dice (d4), which I regain when I finish a short rest.';",
    extraLimitedFeatures: [
      {
        name: "Exploit Dice",
        usages: 2,
        additional: "d4",
        recovery: "short rest",
        addToExisting: true,
      },
    ],
  },
};

// Feats from Alternate Ranger Extended
FeatsList["alternate crossbow expert"] = {
  name: "Alternate Crossbow Expert",
  source: [["GMB:LL"]],
  descriptionFull: desc([
    "You have trained extensively with the crossbow and can use itmore efficiently than most. You gain the following benefits:",
    " \u2022 You can ignore the loading property of all crossbows.",
    " \u2022 You can load a crossbow with a hand that is holding a one-handed weapon, shield, or another Tiny object.",
    " \u2022 Being within 5 feet of a hostile creature does not impose disadvantage on your ranged attack rolls with crossbows.",
    " \u2022 When you take the Attack action and make an attack witha one-handed melee weapon, you can use a bonus action on that turn to make an attack with a hand crossbow.",
  ]),
  description: desc([
    "I ignore the loading property of all crossbows",
    "\n I can load a crossbow with hand holdin a one-hand weapon, shield, or Tiny object",
    "\n Being within 5 ft of a hostile crea, doesn't impose disadv. on my ranged attacks with crossbow",
    "\n When I take the attack action an attack with one-handed melee weapon, I can use a bonus action to make an attack with a hand crossbow",
  ]),
  action: [["bonus action", "Hand crossbow attack"]],
};

FeatsList["alternate dual wielder"] = {
  name: "Alternate Dual Wielder",
  source: [["GMB:LL"]],
  descriptionFull: desc([
    "You have trained extensively to effectively fight wielding twomelee weapons at once. You gain the following benefits:",
    " \u2022 You gain a +1 bonus to your Armor Class while you are wielding a separate melee weapon in each hand.",
    " \u2022 You can engage in two-weapon fighting even if the one-handed melee weapons you are wielding are not light.",
    " \u2022 You can draw or stow two one-handed weapons whenyou would normally be able to draw or stow only one.",
    " \u2022 When you make an opportunity attack while engaging in two-weapon fighting you can make an attack against the creature with both melee weapons you are wielding.",
  ]),
  description: desc([
    "I gain +1 to AC if I have one melee weapon in each hand",
    "I can engage in two-weapon fighting even if I use non-light melee weapons",
    "I can drow/stow two one-handed weapons when I would normally able to draw/stow only one",
    "While two-weapon fighting I can make two attacks when I do an opportunity attack",
  ]),
};

FeatsList["alternate sharpshooter"] = {
  name: "Alternate Sharpshooter",
  source: [["GMB:LL"]],
  descriptionFull: desc([
    "You have trained extensively with ranged weapons to become a master marksman. You gain the benefits listed below:",
    " \u2022 Attacking a target within a ranged weapon's long range does not impose disadvantage on your attack roll.",
    " \u2022 Your attacks with ranged weapons can ignore half-cover, and treat three-quarters cover as half-cover.",
    " \u2022 You can use a bonus action to give yourself advantage on your next ranged weapon attack roll on your current turn.",
  ]),
  description: desc([
    "Long range doesn't impose disadv. on my ranged attacks",
    "My ranged attacks ignore half-cover, and treat 3/4 cover as half-cover",
    "I can use a bonus action to give myself advan. on my next ranged attack on my current turn",
  ]),
  action: [["bonus action", ""]]
};

FeatsList["survivalist training"] = {
  name: "Survivalist Training",
  source: [["GMB:LL"]],
  descriptionFull: desc([
    "You have been trained to survive, track, and explore in thewild, much like a Ranger. You gain the benefits listed below:"

  ]),
  scorestxt: "+1 Strength, Dexterity or Constitution",
  description: "",
  calculate:
    "event.value = 'I learn one knack of my choice from those available to the Ranger (2nd page \"Choose Feature\" button). The saving throw DC for this is ' + (8 + Number(How('Proficiency Bonus')) + Number(What('Wis Mod'))) + ' (8 + proficiency bonus + Wis mod). If a Knack requires me to roll a QUarry Die I roll a d4 unless my Quarry Die is higher;\n [+1 to Str, Dex, or Con]",
  bonusClassExtrachoices: [
    {
      class: "ranger(laserllama)",
      feature: "knacks",
      bonus: 1,
    },
  ],
};

FeatsList["wild companion"] = {
  name: "Wild Companion",
  source: [["GMB:LL"]],
  prereqeval: function (v) {
    return What("Wis Mod") >= 13;
  },
  descriptionFull: desc([
    "You have forged a bond with an animal companion that will adventure by your side. Choose a beast of CR 1/8 or lower to be your Wild Companion. This Companion is friendly to you, and it obeys your commands to the best of its abilities.",
    "Your Companion uses its normal stat block, but it learns to understand one language of your choice that you speak. You and your Companion can communicate simple ideas toeach other using a series of clicks, whistles, and gestures. It gains all the normal benefits of both short and long rests.",
    "In combat, your Wild Companion acts during your turn. It can move and use its reaction on its own, but it will only take the Dodge action on its turn unless you use a bonus action to command it to take an action from its stat block or another action. If you are incapacitated, your Companion will defend itself to the best of its ability. If you die, your Companion will do everything in its power to flee and return to its home.",
    ""
  ]),
  description: desc([
    "I have a Wild companion that it is a CR 1/8 Beast (my choice)",
    "It use the stats block of the Beast but It can also undestand one language I speak (my choice)",
    "I can use a bonus action to command it",
    "When I die it flee and return to its home",
    "If it dies I can spen 8h to track and train a new one",
    '(More details going to "See full text of Wild Companion")'
  ]),
  action: [["bonus action", "Command Wild Companion"]]
};

// Feats from Alternate Barbarian Extended
FeatsList["alternate savage attacker"] = {
  name: "Alternate Savage Attacker",
  source: [["GMB:LL"]],
  descriptionFull:
    "Your savage battle instincts let you exploit even the smallest weakness. You gain the following benefits:\nOnce per turn when you roll damage for a melee weapon attack, you can reroll the weapon's damage dice and use either total.\nWhen you score a critical hit with a melee weapon attack you roll one additional weapon damage die.",
  description:
    "Once per turn, when I roll damage for a melee weapon attack, I can reroll the weapon's damage dice and use either total. When I score a critical hit with a melee weapon attack I roll one additional weapon damage die.",
  calcChanges: {
    atkAdd: [
      function (fields, v) {
        if (v.isMeleeWeapon) {
          var pExtraCritM = 1;
          var extraCritRegex =
            /\d+(d\d+ extra on a crit(ical)?( hit)? in melee)/i;
          v.extraCritM = (v.extraCritM ? v.extraCritM : 0) + pExtraCritM;

          if (extraCritRegex.test(fields.Description)) {
            fields.Description = fields.Description.replace(
              extraCritRegex,
              v.extraCritM + "$1"
            );
          } else if (/d\d/.test(fields.Damage_Die)) {
            fields.Description +=
              (fields.Description ? "; " : "") +
              v.extraCritM +
              fields.Damage_Die.replace(/.*(d\d+).*/, "$1") +
              " extra on a crit in melee";
          }
        }
      },
      "When I score a critical hit with a melee weapon attack I roll one additional weapon damage die.",
      900,
    ],
  },
};

FeatsList["intimidating leader"] = {
  name: "Intimidating Leader",
  source: [["GMB:LL"]],
  descriptionFull:
    "You use fear and intimidation to rally those who follow you into battle. You gain the following benefits:\nYou can increase your Strength, Constitution, or Charisma score by 1, up to a maximum of 20.\nWhen a creature other than yourself, that can see or hear you within 30 feet, fails a saving throw to resist being charmed or frightened, you can use a reaction to make a Charisma (Intimidation) check against the save DC of the effect that caused the creature to be charmed or frightened. On a successful check, the target is no longer charmed or frightened. \n You can use this feature a number of times equal to your Proficiency Bonus and regain all expended uses of this feature each time you finish a long rest",
  description:
    "When a creature other than me within 30 ft fails a save against charmed/frightened, I can use my reaction to make a Charisma (Intimidation) check against the DC of that save. On a success, the target is no longer charmed or frightened (Uses equal to PB per LR) " +
    "[+1 " +
    (typePF ? "Str, Con or Cha" : "Strength, Constitution or Charisma") +
    "]",
  prerequisite: "Proficiency in Intimidation",
  prereqeval: function (v) {
    return v.skillProfs.indexOf("Intimidation") !== -1;
  },
  action: [["reaction", ""]],
  scorestxt: "+1 Strength, Constitution or Charisma",
  usages: "Proficiency bonus per ",
  usagescalc: "event.value = How('Proficiency Bonus');",
  recovery: "long rest",
};

FeatsList["legendary might"] = {
  name: "Legendary Might",
  source: [["GMB:LL"]],
  descriptionFull: desc([
    "You gain the benefits on the table below that correspond to your Strength modifier and lower:",
    "Modifier\t Benefit",
    " +1\tYou count as one size larger for the purpose of carrying capacity, the size of creatures you can Grapple, and the weight you can push, pull, lift, or drag at one time.",
    " +2\tYou can make Strength (Intimidation) checks in place of Charisma (Intimidation) checks.",
    " +3\tYou gain a climbing speed or a swimming speed equal to your walking speed.",
    " +4\tWhenever you make an Athletics check, you treat a d20 roll of 7 or lower as an 8.",
    " +5\tWhen you are forced to make a Constitution saving throw, you can choose to make a Strength saving throw instead.",
    "\nThe benefits increases along with you Strength modifier, so you must remove and add again this feat every Strength value's changes.",
  ]),
  addMod: [
    {
      type: "skill",
      field: "Intimidation",
      mod: "0",
      text: "",
    },
    {
      type: "save",
      field: "Con",
      mod: "0",
      text: "",
    },
  ],
  description:
    "You gain the benefits on the table that correspond to your Strength modifier and lower (see full desc). The benefits increases along with you Strength modifier, so you must remove and add again this feat every Strength value's changes.",
  eval: function () {
    var strMod = What("Str Mod");

    if (strMod >= 1) {
      FeatsList["legendary might"].carryingCapacity = 2;
    } else {
      FeatsList["legendary might"].carryingCapacity = 1;
    }

    if (strMod >= 2) {
      if (FeatsList["legendary might"].addMod[0].mod == "0") {
        FeatsList["legendary might"].addMod[0].mod = "Max(Str-Cha|0)";
        FeatsList["legendary might"].addMod[0].text =
          "Legendary Might: I can make Str(Intimidation) instead of Cha(Intimidation)";
      }
    } else {
      FeatsList["legendary might"].addMod[0].mod = "0";
      FeatsList["legendary might"].addMod[0].text = "";
    }

    // Climbing / Swimming speed (>=3)
    if (strMod >= 3) {
      FeatsList["legendary might"].choices = ["swimming", "climbing"];
      FeatsList["legendary might"].climbing = {
        speed: {
          climb: { spd: "walk" },
        },
      };
      FeatsList["legendary might"].swimming = {
        speed: {
          swim: { spd: "walk" },
        },
      };
    } else {
      delete FeatsList["legendary might"].choices;
      delete FeatsList["legendary might"].climbing;
      delete FeatsList["legendary might"].swimming;
    }

    // Constitution save replacement (>=5)
    if (strMod >= 5) {
      if ((FeatsList["legendary might"].addMod[1].mod = "0")) {
        FeatsList["legendary might"].addMod[1].mod = "Max(Str-Con|0)";
        FeatsList["legendary might"].addMod[1].text =
          "Legendary Might: I can use Str for Con saves";
      }
    } else {
      FeatsList["legendary might"].addMod[1].mod = "0";
      FeatsList["legendary might"].addMod[1].text = "";
    }
  },
  removeeval: function () {
    FeatsList["legendary might"].carryingCapacity = 1;
    delete FeatsList["legendary might"].choices;
    delete FeatsList["legendary might"].climbing;
    delete FeatsList["legendary might"].swimming;
  },
};

FeatsList["hardy physique"] = {
  name: "Hardy Physique",
  source: [["GMB:LL"]],
  descriptionFull:
    "You have hardened your physical body to absorb hits ratherthan dodge them. You can use your Constitution, in place of Dexterity, when calculating your Armor Class in armor.\n You also have advantage on saving throws to avoid beingmoved against your will, Grappled, or knocked Prone.",
  description:
    "You can use Con instead of Dex to calc AC in armor.\n You also have advan. against moved, grappled and prone",
  prereqeval: function (v) {
    return What("Con") >= 13;
  },
  savetxt: {
    adv_vs: ["prone", "grappled", "moved"],
  },
  extraAC: [
    {
      name: "Hardy Physique",
      mod: "max(Con-Dex|0)",
      text: "I can use my Con to calculate my AC instead of Dex while wearing armor",
      stopeval: function (v) {
        return !v.wearingArmor;
      },
    },
  ],
};

FeatsList["savage training"] = {
  name: "Savage Training",
  source: [["GMB:LL"]],
  descriptionFull:
    "You have studied combat techniques that allow you to perform Savage Exploits. You gain the following benefits: You learn two 1st-degree Savage Exploits of your choice from those available to the Alternate Barbarian. If an Exploit you use requires the target to make a saving throw to resist the effects, the DC is equal to 8 + your proficiency bonus + your Strength or Dexterity modifier (your choice). You gain two d4 Exploit Dice to fuel your Exploits. An Exploit Die is expended when you use it. You regain all of your Exploit Dice when you finish a short or long rest. If you already have Exploit Dice from another source, you only gain one Exploit Die equal to your other Exploit Dice.",
  description: "",
  calculate:
    "event.value = 'I learn two maneuvers of my choice from those available to the Barbarian (2nd page \"Choose Feature\" button). The saving throw DC for this is ' + (8 + Number(How('Proficiency Bonus')) + Math.max(Number(What('Str Mod')), Number(What('Dex Mod')))) + ' (8 + proficiency bonus + Str/Dex mod). I gain two (only one if already have Exploit Die) Exploit dice (d4), which I regain when I finish a short rest.';",
  bonusClassExtrachoices: [
    {
      class: "barbarian(laserllama)",
      feature: "savage exploits",
      bonus: 2,
      filter: function (aExploit) {
        return aExploit.level == 1;
      },
    },
  ],
  choices: ["Barbarian", "Not a barbarian"],
  selfChoosing: function () {
    // This function does not take into account other sources of exploit die, since this sheet is only about alt Barbarian
    if (classes.known["barbarian(laserllama)"]) {
      return "barbarian";
    } else {
      return "not a barbarian";
    }
  },
  barbarian: {
    name: "Savage\u200A Training", // The special character is there to differentiate the feat versions
    description: "",
    calculate:
      "event.value = 'I learn two maneuvers of my choice from those available to the Barbarian (2nd page \"Choose Feature\" button). The saving throw DC for this is ' + (8 + Number(How('Proficiency Bonus')) + Math.max(Number(What('Str Mod')), Number(What('Dex Mod')))) + ' (8 + proficiency bonus + Str/Dex mod). I gain one more Exploit die, which I regain when I finish a short rest.';",
    extraLimitedFeatures: [
      {
        name: "Exploit Dice",
        usages: 1,
        recovery: "short rest",
        addToExisting: true,
      },
    ],
  },
  "not a barbarian": {
    name: "Savage\u200A\u200A Training",
    description: "",
    calculate:
      "event.value = 'I learn two maneuvers of my choice from those available to the Barbarian (2nd page \"Choose Feature\" button). The saving throw DC for this is ' + (8 + Number(How('Proficiency Bonus')) + Math.max(Number(What('Str Mod')), Number(What('Dex Mod')))) + ' (8 + proficiency bonus + Str/Dex mod). I gain two Exploit dice (d4), which I regain when I finish a short rest.';",
    extraLimitedFeatures: [
      {
        name: "Exploit Dice",
        usages: 2,
        additional: "d4",
        recovery: "short rest",
        addToExisting: true,
      },
    ],
  },
};

// Feats from Alternate Rogue Extended
FeatsList["alternate dungeon delver"] = {
  name: "Alternate Dungeon Delver",
  source: [["GMB:LL"]],
  descriptionFull: desc([
    "You are as skilled as one can be at exploring dungeons and disarming deadly traps. You gain the benefits listed below:",
    " \u2022 You gain proficiency in your choice of either Perception, Investigation, or thieves' tools. Moreover, when you makean ability check using any of these proficiencies, you can treat a roll of 7 or lower on the d20 as an 8.",
    " \u2022 You have advantage on saving throws to avoid or resist traps and are resistant to the damage dealt by traps.",
    " \u2022 Traveling at a fast pace in a dungeon doesn't impose apenalty on passive Investigation and Perception scores.",
  ]),
  description: desc([
    "+1 Proficiency [Perception, Investigation or Thieves' tools]",
    "Advan. on save against traps and resistance to damage dealt by traps",
    "Fast pace travel in a dungeon doesn't impose disadvan. on passive Perception/Investigation",
  ]),
  skillstxt: "One between Perception, Investigation or Thieves' Tools",
  dmgres: ["Dmg dealt by traps"],
  savetxt: { adv_vs: ["Traps"] },
};

FeatsList["alternate poisoner"] = {
  name: "Alternate Poisoner",
  source: [["GMB:LL"]],
  descriptionFull: desc([
    "You have honed your skills with massive weapons to overwhelm your foes. You gain the following benefits:",
    " \u2022 You gain proficiency in poisoner's kits. If you are already proficient, you now add double your Proficiency Bonus to any ability check that utilizes your poisoner's kit.",
    " \u2022 Whenever you make an ability check to detect or identify a poison, venom, or toxin, you have advantage on the roll.",
    " \u2022 Whenever you deal poison damage to a creature you can choose to deal acid or necrotic damage.",
    " \u2022 During a long rest, you can spend 1 hour using a poisoner's kit and craft vials of minor poison from craft minor poison Exploit equal to your Intelligence modifer.",
    " \u2022 You can apply your poisons to objects as a bonus action.",
  ]),
  description: desc([
    "Proficiency in Poisoner's Kits. If already, double Prof to any check",
    " Advan. on checks to detect or identify poison, venom or toxin",
    " When I deal poison to a crea, I can choose to deal acid or necrotic damage",
    " Poisoner Kit and 1 hour in long rest to craft Int mod vials of the Craft Minor Poison Exploit",
    " I can apply poisons to objects with a bns action",
  ]),
  toolProfs: ["Poisoner's kit"],
  action: [["bonus action", "Apply poison to object"]],
  prerequisite: "Intellinge 13 or higher",
  prereqeval: function (v) {
    return What("Int") >= 13;
  },
  spellChanges: {
    "craft minor poison": {
      description:
        "Craft poison who forces one crea to make Con save or poisoned for 1 min; extra save each turn",
      changes:
        "During a long rest, I can spend 1 hour using a poisoner's kit and craft vials of minor poison from this Exploit equal to my Intelligence modifer.",
    },
  },
  spellcastingBonus: [
    {
      name: "Alternate Poisoner",
      spells: ["craft minor poison"],
      selection: ["craft minor poison"],
    },
  ],
};

FeatsList["alternate skulker"] = {
  name: "Alternate Skulker",
  source: [["GMB:LL"]],
  descriptionFull: desc([
    "You are an expert at slinking through shadows and staying hidden when you need to. You gain the benefits listed below::",
    " \u2022 When you are lightly obscured, you can take the Hide action as a bonus action on your turn.",
    " \u2022 If you are hidden from a creature and miss with a rangedattack you don't reveal your position.",
    " \u2022 Dim light doesn't impose disadvantage on your abilitychecks that rely on your sense of sight.",
  ]),
  description: desc([
    "When I'am lighlty obscured, I can Hide as a bns action",
    " Advan. on checks to detect or identify poison, venom or toxin",
    " Missing with ranged attack while hidden don't reveal my position",
    " Dim light doesn't impose disadvan. on my checks that rely on sight",
  ]),
  action: [["bonus action", "Hide (while lightly obsc.)"]],
  prerequisite: "Dexterity 13 or higher",
  prereqeval: function (v) {
    return What("Dex") >= 13;
  },
};

FeatsList["devious training"] = {
  name: "Devious Training",
  source: [["GMB:LL"]],
  descriptionFull:
    "You have studied dastardly techniques to perform Devious Exploits. You gain the following benefits: You learn two 1st-degree Devious Exploits of your choice from those available to the Alternate Rogue. If an Exploit you use requires the target to make a saving throw to resist the effects, the DC is equal to 8 + your proficiency bonus + your Strength or Dexterity modifier (your choice). You gain two d4 Exploit Dice to fuel your Exploits. An Exploit Die is expended when you use it. You regain all of your Exploit Dice when you finish a short or long rest. If you already have Exploit Dice from another source, you only gain one Exploit Die equal to your other Exploit Dice.",
  description: "",
  calculate:
    "event.value = 'I learn two maneuvers of my choice from those available to the Fighter (2nd page \"Choose Feature\" button). The saving throw DC for this is ' + (8 + Number(How('Proficiency Bonus')) + Math.max(Number(What('Str Mod')), Number(What('Dex Mod')))) + ' (8 + proficiency bonus + Str/Dex mod). I gain two (only one if already have Exploit Die) Exploit dice (d4), which I regain when I finish a short rest.';",
  bonusClassExtrachoices: [
    {
      class: "rogue(laserllama)",
      feature: "devious exploits",
      bonus: 2,
      filter: function (aExploit) {
        return aExploit.level == 1;
      },
    },
  ],
  choices: ["Rogue", "Not a rogue"],
  selfChoosing: function () {
    // This function does not take into account other sources of exploit die, since this sheet is only about alt Fighter
    if (
      classes.known["rogue(laserllama)"] &&
      classes.known["rogue(laserllama)"].level >= 2
    ) {
      return "rogue";
    } else {
      return "not a rogue";
    }
  },
  rogue: {
    name: "Devious\u200A Training", // The special character is there to differentiate the feat versions
    description: "",
    calculate:
      "event.value = 'I learn two maneuvers of my choice from those available to the Rogue (2nd page \"Choose Feature\" button). The saving throw DC for this is ' + (8 + Number(How('Proficiency Bonus')) + Math.max(Number(What('Str Mod')), Number(What('Dex Mod')))) + ' (8 + proficiency bonus + Str/Dex mod). I gain one more Exploit die, which I regain when I finish a short rest.';",
    extraLimitedFeatures: [
      {
        name: "Exploit Dice",
        usages: 1,
        recovery: "short rest",
        addToExisting: true,
      },
    ],
  },
  "not a rogue": {
    name: "Devious\u200A\u200A Training",
    description: "",
    calculate:
      "event.value = 'I learn two maneuvers of my choice from those available to the Rogue (2nd page \"Choose Feature\" button). The saving throw DC for this is ' + (8 + Number(How('Proficiency Bonus')) + Math.max(Number(What('Str Mod')), Number(What('Dex Mod')))) + ' (8 + proficiency bonus + Str/Dex mod). I gain two Exploit dice (d4), which I regain when I finish a short rest.';",
    extraLimitedFeatures: [
      {
        name: "Exploit Dice",
        usages: 2,
        additional: "d4",
        recovery: "short rest",
        addToExisting: true,
      },
    ],
  },
};

FeatsList["roguish initiate"] = {
  name: "Roguish Initiate",
  source: [["GMB:LL"]],
  descriptionFull: desc([
    "You have spent time honing talents associated with the criminal underworld. You gain the following benefits:",
    " \u2022 Increase your Dexterity score by 1, to a maximum of 20.",
    " \u2022 You learn to speak, read, write, and decode Thieves' Cant.",
    " \u2022 Choose one of the following actions: Dash, Hide, or Use an Object, and you can use that Action as a bonus action.",
    "You can choose this Feat multiple times. Each time you do you must pick a different action from the list above, and you learn to speak, read, and write one language of your choice.",
  ]),
  allowDuplicates: true,
  choices: ["Dash", "Hide", "Use an Object"],
  dash: {
    scorestxt: "+1 Dexterity",
    languageProfs: ["Thieves' Cant"],
    description: desc([
      "+1 Dexterity to max of 20",
      " I learn Thieves' Cant",
      " I can Dash with a bonus action",
    ]),
    action: [["bonus action", "Dash"]],
  },
  hide: {
    scorestxt: "+1 Dexterity",
    languageProfs: ["Thieves' Cant"],
    description: desc([
      "+1 Dexterity to max of 20",
      " I learn Thieves' Cant",
      " I can Hide with a bonus action",
    ]),
    action: [["bonus action", "Hide"]],
  },
  "use an object": {
    scorestxt: "+1 Dexterity",
    languageProfs: ["Thieves' Cant"],
    description: desc([
      "+1 Dexterity to max of 20",
      " I learn Thieves' Cant",
      " I can Use an Object with a bonus action",
    ]),
    action: [["bonus action", "Use an Object"]],
  },
};

// Feats from Alternate Monk Extended
FeatsList["martial arts initiate"] = {
  name: "Martial Arts Initiate",
  source: [["GMB:LL"]],
  descriptionFull: "You have some basic martial arts training, giving you some skill in both unarmed combat and unarmed defense. So long as you aren't wearing armor or a shield, your Armor Class equals 13 + your Dexterity modifier. Your unarmed strikes deal bludgeoning damage equal to 1d4 + your Strength or Dexterity modifier on hit. When you take the Attack action on your turn and only make unarmed strikes, you can make a single unarmed strike as a bonus action on that same turn.",
  description: "My AC when unarmoured is 13 + Dex. My unarmoured strikes deal 1d4 + Str or Dex. When I take the Attack action and only make unarmed strikes, I can make a single unarmed strike as a bonus action on that same turn.",
  calcChanges: {
    atkAdd: [
      function (fields, v) {
        if (fields.Mod === 1 || fields.Mod === 2 || What(AbilityScores.abbreviations[fields.Mod - 1] + " Mod") < What(AbilityScores.abbreviations[v.StrDex - 1] + " Mod")) {
          fields.Mod = v.StrDex;
        }

        if (v.baseWeaponName == "unarmed strike") {
          if (fields.Damage_Die == 1) fields.Damage_Die = '1d4';
        };
      },
      "My unarmed strikes deal 1d4 damage + Str or Dex. If I used my action to make only unarmed strikes, I can make a single unarmed strike as bonus action.",
      1
    ]
  },
  action: ['bonus action', 'Unarmed Strike (with Attack action)'],
  armorOptions: [{
    regExpSearch: /justToAddToDropDown/,
    name: "Unarmored Defense (+3)",
    source: ["GMB:LL"],
    ac: "13",
    affectsWildShape: true
  }],
  armorAdd: "Unarmored Defense (+3)"
};

FeatsList["ki warrior"] = {
  name: "Ki Warrior",
  source: [["GMB:LL"]],
  descriptionFull: "You have studied and mastered monastic Techniques which allow you to perform supernatural feats of spiritual power. You learn two Techniques from the Alternate Monk class. If the Technique has a prerequisite or mentions a Martial Arts die, you can learn it only if you are a Monk and you meet its prerequisites. If a Technique requires the target to make a saving throw to resist its effects, the DC equals 8 + your proficiency bonus + your Wisdom modifier. You gain 2 Ki Points to spend on Techniques. You regain all of your expended Ki Points when you finish a short or long rest. If you have Ki from another feature, these Ki Points are added to your total pool of Ki Points.",
  description: "I learn two techniques from the Alternate Monk. I can only learn Techniques without prerequesites and that don't use Martial Arts Die unless I'm a monk. Those techniques use my Wis for the DC. I also gain 2 Ki, which are added to my pool if I have any.",
  bonusClassExtrachoices: [{
    "class": "monk(laserllama)",
    "feature": "mystic techniques",
    "bonus": 2
  }],
  extraLimitedFeatures: [{
    name: "Ki Points",
    usages: 2,
    recovery: "short rest",
    addToExisting: true
  }]
  // The addToExisting actually doesn't work for alt monk, but I'm keeping it for easier understanding of what the feat does and in case there's another ki pool
  // See for reference: https://canary.discord.com/channels/533350585706217494/863810547584467004/1267406407364509737 
};

// Feats from Warlord Class Extended
FeatsList["alternate inspiring leader"] = {
  name: "Alternate Inspiring Leader",
  source: [["GMB:LL"]],
  descriptionFull:
    "If you do not have a Leadership Ability, choose your Wisdomor Charisma to be your Leadership Ability and modifier.\n Over the course of 10 minutes, which can be during a shortor long rest, you can inspire allies and shore up their resolveto fight. When you do, creatures equal to 1 + your Leadershipmodifier that can hear you within 30 feet gain temporary hitpoints equal to your level + your Leadership modifier.\n A creature cannot gain temporary hit points from this Featagain until it finishes a short or long rest.",
  description:
    "Choose Wis or Char as your Lead mod (if not already have a Lead mod).\n During shor/long rest, over 10 min, I can talk to allies within 30 feet. \n Lead mod+1 creatures gain temp HP equal to my level+my Lead mod.\n A cre can gain this temp HP once per short/long rest.",
  prerequisite: "Wisdom or Charisma of 13",
  prereqeval: function (v) {
    return What("Wis") >= 13 || What("Cha") >= 13;
  },
};

FeatsList["natural magnetism"] = {
  name: "Natural Magnetism",
  source: [["GMB:LL"]],
  descriptionFull: desc([
    "You gain the benefits on the table below that correspond to your Charisma modifier and lower:",
    "Modifier\t Benefit",
    " +1\tYou gain proficiency with one gaming set of your choice.",
    " +2\tThe first time you meet a Humanoid, they treat you as Friendly instead of Indifferent.",
    " +3\tYou gain proficiency in your choice of Performance, Persuasion, or Intimidation.",
    " +4\tWhenever you make a Persuasion check,you treat a d20 roll of 7 or lower as an 8.",
    " +5\tWhen you make a Wisdom saving throw, you can make a Charisma saving throw instead.",
    "\nThe benefits increases along with you Charisma modifier, so you must remove and add again this feat every Charisma value's changes.",
  ]),
  addMod: [
    {
      type: "save",
      field: "Wis",
      mod: "0",
      text: "",
    },
  ],
  description:
    "You gain the benefits on the table that correspond to your Charisma modifier and lower (see full desc). The benefits increases along with you Strength modifier, so you must remove and add again this feat every Strength value's changes.",
  eval: function () {
    var chaMod = What("Cha Mod");

    if (chaMod >= 1) {
      FeatsList["natural magnetism"].toolProfs = [["Gaming Set", 1]];
    } else {
      delete FeatsList["natural magnetism"].toolProfs;
    }

    if (chaMod >= 3) {
      FeatsList["natural magnetism"].skillstxt = "Choose one between Performance, Persuasion, or Intimidation";
    } else {
      delete FeatsList["natural magnetism"].skillstxt;
    }
    if (chaMod >= 5) {
      if ((FeatsList["natural magnetism"].addMod[0].mod = "0")) {
        FeatsList["natural magnetism"].addMod[0].mod = "Max(Cha-Wis|0)";
        FeatsList["natural magnetism"].addMod[0].text =
          "Legendary Might: I can use Cha for Wis saves";
      }
    } else {
      FeatsList["natural magnetism"].addMod[0].mod = "0";
      FeatsList["natural magnetism"].addMod[0].text = "";
    }
  },
};

FeatsList["strategic insight"] = {
  name: "Strategic Insight",
  source: [["GMB:LL"]],
  descriptionFull: desc([
    "You have a gift for identifying weaknesses. When you take the Search action, you can target a creature you can see within 30 feet (DC = 8 + its Challenge Rating). If you can observe itfor at least 1 minute, add your level to the roll.",
    " On a success, you learn one characteristic of your choice from the ones below. Once you use this feature on a creatureyou cannot target it again until you finish a long rest.",
    "Characteristics: Armor Class; Highest Ability Score; Immunities; Lowest Ability Score; Resistances; One Feature or Trait;",
  ]),
  description:
    "Search action vs DC studying crea (8 + its CR), If I observe it for 1 min I add my level to the roll.\n On success, I learn one between: Armor Class; Highest Ability Score; Immunities; Lowest Ability Score; Resistances; or One Feature or Trait.\n Once used on a crea, I cannot target it until I finish a long rest",
};

FeatsList["tactical training"] = {
  name: "Tactical Training",
  source: [["GMB:LL"]],
  descriptionFull: desc([
    "You have studied greater combat strategies that allow you to perform Tactical Exploits. You gain the following benefits:",
    " \x1bAbility Score Increase.\x1b Increase your Wisdom, Charisma, or Intelligence score by 1, up to a maximum of 20. It becomes your Leadership ability if you do not already have one.",
    " \x1bTactical Exploit Known.\x1b You learn one of the following Exploit: Attack Order, Defensive Order, Maneuvering Order, Steadfast Order, or Support Order",
    " \x1bIssuing an Order.\x1b Once per turn, when you take the Attack action, you can use the Tactical Exploit in place of one attack. You can't use this Exploit more than once per turn unless you learn Tactical Exploits from a source other than this Feat.",
    " \x1bRepeatable.\x1b You can choose this Feat multiple times. Eachtime you do, raise one of the ability scores above by one, and learn one new Tactical Exploit from the table above.",
  ]),
  allowDuplicates: true,
  description:
    "I learn one Tactical Exploit from the list in the Full Description" +
    "\n [+1 " +
    (typePF ? "Wis, Cha or Int" : "Wisdom, Charisma or Intelligence") +
    "]",
  scorestxt: "+1 Wisdom, Charisma or Intelligence",
  choices: [
    "Attack Order",
    "Defensive Order",
    "Maneuvering Order",
    "Steadfast Order",
    "Support Order",
  ],
  "attack order": {
    description:
      "I learnt the Tactical Exploit : Attack Order" +
      "\n [+1 " +
      (typePF ? "Wis, Cha or Int" : "Wisdom, Charisma or Intelligence") +
      "]",
    toNotesPage: [
      {
        // What is added to the notes page
        name:
          SpellsList['attack order'].name +
          " Exploit [" +
          (SpellsList['attack order'].level == 1
            ? "1st"
            : SpellsList['attack order'].level == 2
              ? "2nd"
              : SpellsList['attack order'].level == 3
                ? "3rd"
                : SpellsList['attack order'].level + "th") +
          " degree]",
        note: desc(SpellsList['attack order'].descriptionFull),
        amendTo: "Tactical Exploits",
      },
    ],
    source: SpellsList['attack order'].source,
    addMod: SpellsList['attack order'].addMod,
    eval: CreateTacticalSpellsheet,
    spellcastingBonusElsewhere: {
      addTo: "tactical exploits",
      spellcastingBonus: {
        name: "Tactical Exploits",
        spellcastingAbility: 1,
        spells: ['attack order'],
        selection: ['attack order'],
      },
    },
  },
  "defensive order": {
    description:
      "I learnt the Tactical Exploit : Defensive Order" +
      "\n [+1 " +
      (typePF ? "Wis, Cha or Int" : "Wisdom, Charisma or Intelligence") +
      "]",
    toNotesPage: [
      {
        // What is added to the notes page
        name:
          SpellsList['defensive order'].name +
          " Exploit [" +
          (SpellsList['defensive order'].level == 1
            ? "1st"
            : SpellsList['defensive order'].level == 2
              ? "2nd"
              : SpellsList['defensive order'].level == 3
                ? "3rd"
                : SpellsList['defensive order'].level + "th") +
          " degree]",
        note: desc(SpellsList['defensive order'].descriptionFull),
        amendTo: "Tactical Exploits",
      },
    ],
    source: SpellsList['defensive order'].source,
    addMod: SpellsList['defensive order'].addMod,
    eval: CreateTacticalSpellsheet,
    spellcastingBonusElsewhere: {
      addTo: "tactical exploits",
      spellcastingBonus: {
        name: "Tactical Exploits",
        spellcastingAbility: 1,
        spells: ['defensive order'],
        selection: ['defensive order'],
      },
    },
  },
  "maneuvering order": {
    description:
      "I learnt the Tactical Exploit : Maneuvering Order" +
      "\n [+1 " +
      (typePF ? "Wis, Cha or Int" : "Wisdom, Charisma or Intelligence") +
      "]",
    toNotesPage: [
      {
        // What is added to the notes page
        name:
          SpellsList['maneuvering order'].name +
          " Exploit [" +
          (SpellsList['maneuvering order'].level == 1
            ? "1st"
            : SpellsList['maneuvering order'].level == 2
              ? "2nd"
              : SpellsList['maneuvering order'].level == 3
                ? "3rd"
                : SpellsList['maneuvering order'].level + "th") +
          " degree]",
        note: desc(SpellsList['maneuvering order'].descriptionFull),
        amendTo: "Tactical Exploits",
      },
    ],
    source: SpellsList['maneuvering order'].source,
    addMod: SpellsList['maneuvering order'].addMod,
    eval: CreateTacticalSpellsheet,
    spellcastingBonusElsewhere: {
      addTo: "tactical exploits",
      spellcastingBonus: {
        name: "Tactical Exploits",
        spellcastingAbility: 1,
        spells: ['maneuvering order'],
        selection: ['maneuvering order'],
      },
    },
  },
  "support order": {
    description:
      "I learnt the Tactical Exploit : Support Order" +
      "\n [+1 " +
      (typePF ? "Wis, Cha or Int" : "Wisdom, Charisma or Intelligence") +
      "]",
    toNotesPage: [
      {
        // What is added to the notes page
        name:
          SpellsList['support order'].name +
          " Exploit [" +
          (SpellsList['support order'].level == 1
            ? "1st"
            : SpellsList['support order'].level == 2
              ? "2nd"
              : SpellsList['support order'].level == 3
                ? "3rd"
                : SpellsList['support order'].level + "th") +
          " degree]",
        note: desc(SpellsList['support order'].descriptionFull),
        amendTo: "Tactical Exploits",
      },
    ],
    source: SpellsList['support order'].source,
    addMod: SpellsList['support order'].addMod,
    eval: CreateTacticalSpellsheet,
    spellcastingBonusElsewhere: {
      addTo: "tactical exploits",
      spellcastingBonus: {
        name: "Tactical Exploits",
        spellcastingAbility: 1,
        spells: ['support order'],
        selection: ['support order'],
      },
    },
  },
  "steadfast order": {
    description:
      "I learnt the Tactical Exploit : Steadfast Order" +
      "\n [+1 " +
      (typePF ? "Wis, Cha or Int" : "Wisdom, Charisma or Intelligence") +
      "]",
    toNotesPage: [
      {
        // What is added to the notes page
        name:
          SpellsList['steadfast order'].name +
          " Exploit [" +
          (SpellsList['steadfast order'].level == 1
            ? "1st"
            : SpellsList['steadfast order'].level == 2
              ? "2nd"
              : SpellsList['steadfast order'].level == 3
                ? "3rd"
                : SpellsList['steadfast order'].level + "th") +
          " degree]",
        note: desc(SpellsList['steadfast order'].descriptionFull),
        amendTo: "Tactical Exploits",
      },
    ],
    source: SpellsList['steadfast order'].source,
    addMod: SpellsList['steadfast order'].addMod,
    eval: CreateTacticalSpellsheet,
    spellcastingBonusElsewhere: {
      addTo: "tactical exploits",
      spellcastingBonus: {
        name: "Tactical Exploits",
        spellcastingAbility: 1,
        spells: ['steadfast order'],
        selection: ['steadfast order'],
      },
    },
  },
};

// Add the fighting initiate only when all other code has run, so that we get fighting styles added by the code
RunFunctionAtEnd(function () {
  if (
    !ClassList["fighter(laserllama)"] ||
    !ClassList["fighter(laserllama)"].features["fighting style"]
  )
    return;
  var FtngStyles = ClassList["fighter(laserllama)"].features["fighting style"];

  FeatsList["alternate fighting initiate"] = {
    name: "Alternate Fighting Initiate",
    source: [["GMB:LL"]],
    descriptionFull:
      "You have dedicated time to master a specific style of fighting. When you select this Feat you gain the following benefits:\n \u2022 You learn one Fighting Style option of your choice from the fighter class. If you already have a style, the one you choose must be different.\n \u2022 Increase either your Strength, Dexterity, or Constitutionscore by 1, up to a maximum of 20.",
    description:
      "I learn one Fighting Style from the alternate fighter class, which must be one that I don't yet know. I can replace this fighting style for another whenever I gain an Ability Score Improvement.",
    prerequisite: "Proficiency with a martial weapon",
    scorestxt: "+1 Strength, Dexterity or Constitution",
    prereqeval: function (v) {
      return (
        v.martialWeaponsProf ||
        v.otherWeaponsProf.some(function (n) {
          return WeaponsList[n] && /Martial/i.test(WeaponsList[n].type);
        })
      );
    },
    choices: [],
  };

  FtngStyles.extrachoices.forEach(function (sName) {
    var sNameLC = sName.toLowerCase();
    if (!FtngStyles[sNameLC]) return;
    FeatsList["alternate fighting initiate"].choices.push(sName);

    if (!FeatsList["alternate fighting initiate"][sNameLC]) {
      FeatsList["alternate fighting initiate"][sNameLC] = {
        description:
          FtngStyles[sNameLC].description
            .replace(/^\n   /i, "")
            .replace(/\n   /g, ". ") +
          ". I can replace this fighting style whenever I gain an ASI.",
        source: FtngStyles[sNameLC].source
          ? FtngStyles[sNameLC].source
          : FtngStyles.source,
      };
    }

    // Copy all attributes except name, source and description
    for (var attr in FtngStyles[sNameLC]) {
      if (/\b(name|description|source)\b/i.test(attr)) continue;
      FeatsList["alternate fighting initiate"][sNameLC][attr] =
        FtngStyles[sNameLC][attr];
    }
    if (!FeatsList["alternate fighting initiate"][sNameLC].prereqeval) {
      FeatsList["alternate fighting initiate"][sNameLC].prereqeval = function (
        v
      ) {
        var knownStyles = GetFightingStyleSelection();
        return knownStyles[v.choice] ? false : true;
      };
      if (!FeatsList["alternate fighting initiate"][sNameLC].prerequisite)
        FeatsList["alternate fighting initiate"][sNameLC].prerequisite =
          sName + " Fighting Style is not selected anywhere else.";
    }
  });


});
// Add the optional feature to choose a fighting style when the extra attack from a second class
RunFunctionAtEnd(function () {
  var classesWithExtraAttack = [
    "artificer", "barbarian", "barbarian(laserllama)", "bard", "blood hunter", "brawler(laserllama)",
    "cleric", "druid", "fighter", "fighter(laserllama)", "magus(laserllama)", "monk", "monk(laserllama)", "paladin",
    "psion(laserllama)", "ranger", "ranger(laserllama)", "rogue", "rogue(laserllama)", "shaman(laserllama)",
    "shifter(laserllama)", "sorcerer", "vessel(laserllama)", "wanderer(laserllama)",
    "warlord(laserllama)", "warlock", "wizard"
  ];

  var ExtraAttackLevelReq = {
    "artificer": 6,
    "barbarian": 5,
    "barbarian(laserllama)": 5,
    "bard": 6,
    "blood hunter": 5,
    "brawler(laserllama)": 5,
    "cleric": 5,
    "druid": 5,
    "fighter": 5,
    "fighter(laserllama)": 5,
    "magus(laserllama)": 5,
    "monk": 5,
    "monk(laserllama)": 5,
    "paladin": 5,
    "psion(laserllama)": 6,
    "ranger": 5,
    "ranger(laserllama)": 5,
    "rogue": 6,
    "rogue(laserllama)": 6,
    "shaman(laserllama)": 5,
    "shifter(laserllama)": 5,
    "sorcerer": 6,
    "vessel(laserllama)": 6,
    "wanderer(laserllama)": 5,
    "warlord(laserllama)": 5,
    "warlock": 5,
    "wizard": 6
  };

  var FSChoicesByClass = {
    "artificer": ["arcane warrior", "archery", "balanced", "defensive", "protection", "shield_warrior"],
    "barbarian": ["brawling", "dual_wielding", "dueling", "great_weapon", "heavyweight", "pit_fighting"],
    "barbarian(laserllama)": ["brawling", "dual_wielding", "dueling", "great_weapon", "heavyweight", "pit_fighting"],
    "bard": ["balanced", "bardic_warrior", "classical", "dual_wielding", "featherweight", "hurler", "versatile"],
    "blood hunter": ["archery", "balanced", "dual_wielding", "featherweight", "great_weapon", "hurler", "marksman", "polearm", "versatile"],
    "brawler(laserllama)": ["blind", "defensive", "hurler", "improvised", "protection"],
    "cleric": ["blessed_warrior", "blind", "defensive"],
    "druid": ["druidic_warrior", "mariner", "mountaineer"],
    "fighter": ["arcane warrior", "archery", "bardic_warrior", "blind", "brawling", "classical", "defensive", "dual_wielding", "dueling", "featherweight", "great_weapon", "heavyweight", "improvised", "mariner", "marksman", "mountaineer", "mounted", "pit_fighting", "protection", "shield_warrior", "standardbearer", "strongbow", "hurler", "versatile", "wrestler"],
    "fighter(laserllama)": ["arcane warrior", "archery", "bardic_warrior", "blind", "brawling", "classical", "defensive", "dual_wielding", "dueling", "featherweight", "great_weapon", "heavyweight", "improvised", "mariner", "marksman", "mountaineer", "mounted", "pit_fighting", "protection", "shield_warrior", "standardbearer", "strongbow", "hurler", "versatile", "wrestler"],
    "magus(laserllama)": ["arcane warrior", "archery", "balanced", "brawling", "classical", "defensive", "dual_wielding", "featherweight", "great_weapon", "hurler", "mounted", "polearm", "protection", "shield_warrior", "versatile"],
    "monk": ["archery", "blind", "defensive", "featherweight", "hurler", "improvised", "wrestler"],
    "monk(laserllama)": ["archery", "blind", "defensive", "featherweight", "hurler", "improvised", "wrestler"],
    "paladin": ["balanced", "blessed_warrior", "blind", "classical", "defensive", "exotic", "great_weapon", "heavyweight", "mounted", "polearm", "protection", "shield_warrior", "standardbearer", "strongbow", "versatile"],
    "psion(laserllama)": ["blind", "psionic_warrior"],
    "ranger": ["archery", "blind", "brawling", "defensive", "druidic_warrior", "dual_wielding", "dueling", "featherweight", "mariner", "marksman", "mountaineer", "mounted", "strongbow", "hurler", "versatile"],
    "ranger(laserllama)": ["archery", "blind", "brawling", "defensive", "druidic_warrior", "dual_wielding", "dueling", "featherweight", "mariner", "marksman", "mountaineer", "mounted", "strongbow", "hurler", "versatile"],
    "rogue": ["classical", "dual_wielding", "featherweight", "hurler", "tactical"],
    "rogue(laserllama)": ["classical", "dual_wielding", "featherweight", "hurler", "tactical"],
    "shaman(laserllama)": ["blind", "shamanistic_warrior"],
    "shifter(laserllama)": ["blind", "hurler", "mariner", "mountaineer"],
    "sorcerer": ["arcane warrior", "bardic_warrior", "blessed_warrior", "druidic_warrior", "eldritch_warrior", "psionic_warrior", "shamanistic_warrior", "sorcerous_warrior"],
    "vessel(laserllama)": ["balanced", "blind", "defensive", "eldritch_warrior", "exotic"],
    "wanderer(laserllama)": ["archery", "balanced", "blind", "brawling", "defensive", "dual_wielding", "featherweight", "hurler", "improvised", "mariner", "marksman", "mountaineer", "mounted", "polearm", "protection", "strongbow", "tactical", "versatile"],
    "warlord(laserllama)": ["archery", "bardic_warrior", "brawling", "classical", "defensive", "dueling", "mariner", "marksman", "mountaineer", "mounted", "protection", "shield_warrior", "standardbearer", "versatile"],
    "warlock": ["eldritch_warrior"],
    "wizard": ["arcane warrior"]
  };
  classesWithExtraAttack.forEach(function (cName) {
    var cls = ClassList[cName];
    if (!cls) return;

    // Feature a cui agganciare le scelte
    var attachFeature = cls.features['extra attack'] || cls.features[Object.keys(cls.features)[0]];
    if (!attachFeature) return;

    // Iteriamo sulle scelte e creiamo un oggetto nuovo per ciascuna
    (FSChoicesByClass[cName] || []).forEach(function (fs) {
      var fsObj = FightingStylesLL[fs];
      if (!fsObj) return;

      var choiceFeature = {
        name: fsObj.name,
        description: fsObj.description,
        source: [["GMB:LL", 0]],
        submenu: "Extra Attack Optional Fighting Style",
        max: 1,
        eval: typeof fsObj.eval === "function" ? fsObj.eval : undefined,
        removeeval: typeof fsObj.removeeval === "function" ? fsObj.removeeval : undefined,
        calcChanges: typeof fsObj.calcChanges === "object" ? fsObj.calcChanges : undefined,
        prereqeval: function (v) {
          return classes.known[cName].level >= ExtraAttackLevelReq[cName];
        },
      };

      AddFeatureChoice(attachFeature, true, fsObj.name, choiceFeature, "Optional Extra Attack Feature");
    });
  });
});


function calcExploitDice() {
  var clkn = classes.known;

  if (!clkn) return { usages: 0, additional: "" };

  // Tabelle per ogni classe
  var fighterUsages = ["", 2, 2, 3, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 5, 6, 6, 6, 6, 6];
  var fighterAdditional = ["", "d6", "d6", "d6", "d8", "d8", "d8", "d8", "d8", "d8", "d10", "d10", "d10", "d10", "d10", "d10", "d12", "d12", "d12", "d12"];
  var barbarianUsages = ["", 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5];
  var barbarianAdditional = ["", "d4", "d4", "d4", "d6", "d6", "d6", "d6", "d6", "d6", "d8", "d8", "d8", "d8", "d8", "d8", "d10", "d10", "d10", "d10"];
  var rogueUsages = ["", 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5];
  var rogueAdditional = ["", "d4", "d4", "d4", "d6", "d6", "d6", "d6", "d6", "d6", "d8", "d8", "d8", "d8", "d8", "d8", "d10", "d10", "d10", "d10"];
  var warlordUsages = ["", 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5];
  var warlordAdditional = ["", "d4", "d4", "d4", "d6", "d6", "d6", "d6", "d6", "d6", "d8", "d8", "d8", "d8", "d8", "d8", "d10", "d10", "d10", "d10"];
  var wayBrawlerUsages = ['', '', 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4];
  var wayBrawlerAdditional = ['', '', "d4", "d4", "d4", "d4", "d6", "d6", "d6", "d6", "d6", "d6", "d6", "d6", "d8", "d8", "d8", "d8", "d8", "d8"];
  var bountyHunterUsages = ["", "", 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4];
  var bountyHunterAdditional = ["", "", "d4", "d4", "d4", "d4", "d6", "d6", "d6", "d6", "d6", "d6", "d6", "d6", "d8", "d8", "d8", "d8", "d8", "d8"];

  var multiclassUsages = ["", "", 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5];
  var multiclassAdditional = ["", "", "d4", "d4", "d6", "d6", "d6", "d6", "d6", "d6", "d8", "d8", "d8", "d8", "d8", "d8", "d10", "d10", "d10", "d10"];

  // Livelli
  var fighterLevel = clkn["fighter(laserllama)"] ? clkn["fighter(laserllama)"].level : 0;
  var barbarianLevel = clkn["barbarian(laserllama)"] ? clkn["barbarian(laserllama)"].level : 0;
  var rogueLevel = clkn["rogue(laserllama)"] ? clkn["rogue(laserllama)"].level : 0;
  var warlordLevel = clkn["warlord(laserllama)"] ? clkn["warlord(laserllama)"].level : 0;
  var bountyHunterLevel = clkn["ranger(laserllama)"] ? clkn["ranger(laserllama)"].subclass === "ranger(laserllama)-bounty hunter" ? clkn["ranger(laserllama)"].level : 0 : 0;
  var wayBrawlerLevel = clkn["monk(laserllama)"] ? clkn["monk(laserllama)"].subclass === "monk(laserllama)-way of the brawler" ? clkn["monk(laserllama)"].level : 0 : 0;
  // Conta quante classi hanno exploit
  var activeClasses = 0;
  if (fighterLevel > 0) activeClasses++;
  if (barbarianLevel > 0) activeClasses++;
  if (rogueLevel > 0) activeClasses++;
  if (warlordLevel > 0) activeClasses++;
  if (bountyHunterLevel > 0) activeClasses++;
  if (wayBrawlerLevel > 0) activeClasses++;

  var resultAdditional = "";
  var resultUsages = 0;
  if (activeClasses === 0) {
    return { usages: "", additional: "" };
  }
  else if (activeClasses === 1) {
    if (fighterLevel > 0) { resultUsages = fighterUsages[fighterLevel - 1]; resultAdditional = fighterAdditional[fighterLevel - 1]; }
    if (barbarianLevel > 0) {
      resultUsages = barbarianUsages[barbarianLevel - 1]; resultAdditional = barbarianAdditional[barbarianLevel - 1];
    }
    if (rogueLevel > 0) { resultUsages = rogueUsages[rogueLevel - 1]; resultAdditional = rogueAdditional[rogueLevel - 1]; }
    if (warlordLevel > 0) { resultUsages = warlordUsages[warlordLevel - 1]; resultAdditional = warlordAdditional[warlordLevel - 1]; }
    if (bountyHunterLevel > 0) { resultUsages = bountyHunterUsages[bountyHunterLevel - 1]; resultAdditional = bountyHunterAdditional[bountyHunterLevel - 1]; }
    if (wayBrawlerLevel > 0) { resultUsages = wayBrawlerUsages[wayBrawlerLevel - 1]; resultAdditional = wayBrawlerAdditional[wayBrawlerLevel - 1]; }
  } else {
    var multiclassLevel = barbarianLevel + warlordLevel;
    multiclassLevel += fighterLevel;
    multiclassLevel += Math.floor(wayBrawlerLevel / 2);
    multiclassLevel += Math.floor(bountyHunterLevel / 2);
    multiclassLevel += rogueLevel;

    var baseUsages = multiclassUsages[multiclassLevel - 1] || 0;
    var baseDie = multiclassAdditional[multiclassLevel - 1] || "";

    var allUsages = [
      baseUsages,
      fighterUsages[fighterLevel - 1] || 0,
      barbarianUsages[barbarianLevel - 1] || 0,
      rogueUsages[rogueLevel - 1] || 0,
      warlordUsages[warlordLevel - 1] || 0,
      bountyHunterUsages[bountyHunterLevel - 1] || 0,
      wayBrawlerUsages[wayBrawlerLevel - 1] || 0
    ];

    var allDiceSizes = [
      baseDie,
      fighterAdditional[fighterLevel - 1] || "",
      barbarianAdditional[barbarianLevel - 1] || "",
      rogueAdditional[rogueLevel - 1] || "",
      warlordAdditional[warlordLevel - 1] || "",
      bountyHunterAdditional[bountyHunterLevel - 1] || "",
      wayBrawlerAdditional[wayBrawlerLevel - 1] || ""
    ];

    resultUsages = Math.max.apply(null, allUsages);

    var diceOrder = ["d4", "d6", "d8", "d10", "d12"];
    resultAdditional = allDiceSizes.reduce(function (max, current) {
      return (diceOrder.indexOf(current) > diceOrder.indexOf(max)) ? current : max;
    }, "d4");
  }

  return { usages: resultUsages, additional: resultAdditional };
}



// Source information
SourceList["GMB:LL"] = {
  name: "LaserLlama",
  abbreviation: "GMB:LL",
  abbreviationSpellsheet: "LL",
  group: "GM Binder",
  url: "https://www.gmbinder.com/profile/laserllama",
  date: "2018/04/22",
};